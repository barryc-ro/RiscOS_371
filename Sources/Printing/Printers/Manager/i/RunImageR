#line 1 "sources.RunImage"
   










































































  #line 1 "h.Values"
 
























  






  





  











  





  





























































































































































































































































































































 























































 




 





 




 

























 



 
















































































































#line 77 "sources.RunImage"
  #line 1 "h.Trace"






   
   
   
   

#line 78 "sources.RunImage"
  
  
  

   
  
  
  

 











 



  
  








  
  
  








  
  
  
  
  
  













    ON ERROR ERROR EXT ERR,REPORT$



  SYS "Hourglass_On"
    






  DIM A%  84 ,A%! 16  256,win_buff% 256,    evaluation_buff% 256,buff1% 512,task_buff%  1024 ,icon_buffer% 256,    msg_text% 256


    
   
    
  DIM prntctrl_icdf%(4)
  PROCmsg_initialise("Printers:Messages",A%! 12 )









    ON ERROR PROCmsg_end(A%! 12 ):         ERROR EXT ERR,REPORT$




  PROCinitialise_code

  



















  



  PROCtask_initialise(FNmsg_0(A%! 12 ,"ID"))
  PROCerror_initialise
  PROCicon_initialise
  PROCwin_initialise
  PROCmenu_initialise
   
  PROClocale_initialise

  PROCinitialise_support_libraries  
  CALL code_entry%+ 8 
    
  PROCsave_initialise
  PROCinitialise  

  
    PROCenumerate_queue_directory
  
  SYS "Hourglass_Off"

  ON ERROR PROCerror

  IF PDF_loading% THEN
    $(task_buff%+44)=PDF_to_load$
    ?(task_buff%+44+LEN(PDF_to_load$))=0:REM 0-terminate it
    PROCadd_to_prdata
  ENDIF

  REPEAT
    PROCdespatch_poll(A%! 20 )
  UNTIL  0 
END

DEF PROCdespatch_poll(mask%)
  LOCAL r%,t%,prnt%
    
  


  r%=FNtask_poll(mask%)
  CASE r% OF
    WHEN 0
      PROCprocess_queue
      PROCdespatch_null
    WHEN 1
      PROCredraw_window
    WHEN 2
      SYS "Wimp_OpenWindow",,task_buff%
    WHEN 3
      PROCclose_window
    WHEN 6
      PROCmouseclick
    WHEN 7
      IF save_dragging% THEN
        PROCsave_decodedrag
      ELSE
        PROCbroadcast_reason_code(selected_prnt%,7,task_buff%)
      ENDIF
    WHEN 8
      PROCkeypress
    WHEN 9
      PROCmenuaction

    WHEN 13  
      !(task_buff%!0) = 0  
      PROCpollword_changed  

    WHEN 17,18
        
      PROCreceive(r%)
    WHEN 19
        
      PROCack
    OTHERWISE
      PROCbroadcast_reason_code(selected_prnt%,r%,task_buff%)
  ENDCASE

   
  timeout%=-1
  prnt%=A%! 48 
  WHILE prnt%
    t%=prnt%! 56 
    IF NOT t% THEN
       
      IF timeout%=-1 timeout%=t% ELSE IF t%<timeout% timeout%=t%
    ENDIF
    prnt%=prnt%! 0 
  ENDWHILE
    

   



  CASE freeway_just_started% OF
    WHEN 1
      timeout% += 500
      freeway_just_started% = 2
    WHEN 2
      PROCfreeway_starting
      freeway_just_started% = 0
  ENDCASE

  


ENDPROC

DEF PROCinitialise

  LOCAL path$

    
  task_buff%!0=24
  task_buff%!12=0
  task_buff%!16=&80143  
  task_buff%!20=34  
  SYS "Wimp_SendMessage",18,task_buff%
    
  task_your_ref%=task_buff%!8
  PROCinitialise_constants
  PROCinitialise_globals
  PROCcheck_cmdline_args

  PROCinitialise_sparrow ( -1 )


   



  path$ =  "<Choices$Write>.Printers" 

  IF multiple_choices% THEN
    path$ += ".Remote"
    SYS "XOS_File", 8, path$
    path$ += ".ID"+unique_string$
    SYS "XOS_File", 8, path$
  ENDIF

  path$ += "."
  SYS "OS_SetVarVal", "PrinterChoices$Path", path$, LENpath$, 0, 0  

  PROCread_paper_file("Printers:PaperRO", 2 )
  PROCread_paper_file("PrinterChoices:PaperRW", 1 )

  IF psize_head%=0 ERROR  253 , FNmsg_0(A%! 12 ,"FAK")

  PROCinitialise_windows
   
  timeout%=-1: SYS "OS_ReadMonotonicTime" TO time_before%
  PROCinitialise_settings
    
ENDPROC

DEF PROCinitialise_constants
   
    



   



   

  A%! 20 =%110000000001100000110001
   

  message_mask%=%110000000001100101110011
  click_mask%=  %110000000001100100110001










ENDPROC

DEF PROCinitialise_code
  LOCAL h%,l%,a%,w%
    
  SYS "XOS_File", 8,  "<Choices$Write>.Printers" 
  h%=OPENIN "Printers:Code"
  l%=EXT#h%
  SYS "OS_FSControl",21,h% TO,a%,w%
  CLOSE#h%
  IF(w% AND &FF)=46 THEN
    code_entry%=a%
  ELSE
      
    DIM code_entry% l%+1
    SYS "OS_File",16,"Printers:Code",code_entry%  
  ENDIF
  Z%=code_entry%+ 64 
  Y%=code_entry%+ 68 
ENDPROC

DEF PROCcheck_cmdline_args
  LOCAL args%,args1%
  SYS"OS_GetEnv" TO args%
  REM syntax is BASIC -quit progname -pdf filename
  SYS"OS_ReadArgs","/g,quit/s,/g,pdf/s,/g",args%,buff1%,256
  IF buff1%!12=0 THEN
    PDF_loading%= 0 
  ELSE
    PDF_loading%= -1 
  ENDIF
  PDF_to_load$=""
  args%=buff1%!16
  IF args%<>0 THEN
    args1%=!args% AND &FFFF
    args%+=2
    WHILE args1%
      PDF_to_load$+=CHR$(?args%)
      args%+=1
      args1%-=1
    ENDWHILE
  ENDIF    
ENDPROC

DEF PROCinitialise_globals
    
  mm_to_72000=1814.4*72000/(180<<8)
  in_to_72000=72000
  line_space%=44  
  claim_state%=0
  claim_ref%=0
  query_state%=0
  type_state%=0
  psup_head%=0
  printer_count%=0  
  A%! 48 =0
       
  A%! 44 =0  
  selected_prnt%=0
  select_all%= 0 
  menu_chsn$=""
  menu_prnt%=0
  menued_y%=0
  menued_prnt%=0
  menued_queu%=0
  A%! 24 =0
  A%! 28 =0
  printer_output$="null:"
  prnt_edit%=0
  psup_edit%=0
  A%! 32 =0
  queue_leafname$=""
  A%! 36 = 0 
  queue_temphand%=0
  queue_tempref%=0
  psize_head%=0
  psize_edit%=0
  temp_count%=0
  SYS "OS_Byte",&CC,,255 TO,old_ignore_state%
  file_to_delete$=""
  last_scrap$ = ""
  A%! 76 =0
  A%! 80 =0

  sparrow_present%   =  0 
  remote_printers%  = 0       
  pollword_location% = 0
  remote_printer_count% = 0
  unique_string$ = ""
  remote_jobno% = 0
  printer_prefix$ = ""
  last_application$ = ""
  last_leafname$ = ""
  dealing_with_a_protocol% =  0 
  directories_shared% =  0 
  freeway_just_started% = 0
  multiple_choices% =  0 

ENDPROC

DEF PROCinitialise_support_libraries




























LOCAL c%,d%,load%,size%,basic_size%,utility_size%,needed%
LOCAL basname$():DIM basname$(255)

 

basic_size%=0      
utility_size%=0    

baslim%=0
mclim%=0

basic_count%=0     
utility_count%=0   

c%=-1
REPEAT
  PROCget_next_directory(path$,currdir$,name$,c%)
   
  IF name$<>"" THEN
    SYS"OS_File",17,"Printers:"+name$+".Resources.Support" TO d%,,load%,,size%
    IF d%=1 AND (load% AND &FFF00000) = &FFF00000 THEN
      size%=size%+3 AND NOT 3
      CASE (load% AND &FFF00)>>8 OF
        WHEN &FFB
          IF size% > basic_size% basic_size% = size%
          IFbaslim%<255 basname$(baslim%)=name$
          baslim% += 1
        WHEN &FFC
          utility_size% += size%
          mclim% += 1
      ENDCASE
    ENDIF
  ENDIF
UNTIL name$=""

IF mclim% > 0 DIM utility%(mclim%-1), utility$(mclim%-1)
needed%=HIMEM+utility_size%+basic_size%+16*1024
END=needed%
IF (HIMEM+utility_size%+basic_size%+16*1024) < needed% THEN
  needed%=needed%/1024
  needed%=needed%-needed% MOD 8+8
  ERROR  253 ,FNmsg_1(A%! 12 ,"FA4",STR$ needed%)
ENDIF
IF baslim% > 0 THEN
 DIM overlay$(baslim%-1)
 FORd%=0 TO baslim%-1
  overlay$(d%)="Printers:"+basname$(d%)+".Resources.Support"
 NEXT
 OVERLAY overlay$()
ENDIF
ENDPROC

DEF PROCget_next_directory(RETURN path$,RETURN currdir$,RETURN name$,RETURN offset%)
  LOCAL i%,num_read%,flags%
    
  IF offset%=-1 path$=FNtask_read_env("Printers$Path",msg_text%)
  REPEAT
    
   IF offset%=-1 THEN
    IF path$="" THEN
      
     name$=""
     ENDPROC
    ENDIF
    i%=INSTR(path$,",")
    IF i%=0 i%=LEN path$+1
    currdir$=LEFT$(path$,i%-1)
    IF RIGHT$(currdir$)="." currdir$=LEFT$(currdir$)
    currdir$+=CHR$ 0
    path$=MID$(path$,i%+1)
    offset%=0
   ENDIF
   SYS "XOS_GBPB",10,currdir$,msg_text%,1,offset%,256,"*" TO,,,num_read%,offset%;flags%
   IF (flags% AND 1) num_read% = 0  
   IF num_read%=1 THEN
    IF msg_text%!16=2 THEN
      i%=msg_text%+20:CALL Z%,i%,name$
      ENDPROC
    ENDIF
     
   ELSE
     
    offset%=-1
   ENDIF
  UNTIL  0 
ENDPROC

DEF PROCinitialise_one_support_library(name$)
   
  LOCAL load%,size%,f$

    

  f$="Printers:"+name$+".Resources.Support"
  SYS "OS_File",17,f$ TO d%,,load%,,size%  
  size%=size%+3 AND NOT 3
  IF d%<>1 SYS "OS_File",19,f$,d%  

   
  IF(load% AND &FFF00000)<>&FFF00000     ERROR  254 ,FNmsg_1("FA3",name$)


   
  CASE(load% AND &FFF00)>>8 OF
    WHEN &FFB









    WHEN &FFC
       
      IF utility_count%<mclim% THEN
         
          
        DIM u% size%
        utility%(utility_count%)=u%
        utility$(utility_count%)=name$
        SYS "OS_File",16,f$,u%  
        utility_count%+=1
      ENDIF
    OTHERWISE
      ERROR  254 ,FNmsg_1("FA3",name$)
  ENDCASE
ENDPROC

DEF PROCinitialise_one_psup(name$,RETURN this_psup%)
   



    
   
  LOCAL d%,load%,f$,h%,this_wind%,last_wind%,psup%

  LOCAL tmpt%


    
   
  SYS "XOS_File", 8, "PrinterChoices:"+name$
  f$="Printers:"+name$+".Resources.Support"
  SYS "OS_File",17,f$ TO d%,,load%  
  IF d%<>1 SYS "OS_File",19,f$,d%  

   
  IF(load% AND &FFF00000)<>&FFF00000     ERROR  254 ,FNmsg_1("FA3",name$)


  B%= &50555350 
  C%= 60 
  this_psup%=USR(code_entry%+ 12 )
  IF this_psup%=0 ERROR  253 , FNmsg_1(A%! 12 ,"FA5","PSUP")

   
  CASE(load% AND &FFF00)>>8 OF
    WHEN &FFB
       
      this_psup%! 24 = 1 
    WHEN &FFC
       
      this_psup%! 24 =0
    OTHERWISE
      B%= &50555350 
      C%=this_psup%
      CALL code_entry%+ 16 
      ERROR  254 ,FNmsg_1(A%! 12 ,          "FA3",name$)

  ENDCASE

  this_psup%! 0 =0
  $task_buff%=name$
  B%=task_buff%
  C%=2
  this_psup%! 4 =USR(code_entry%+ 28 )
  this_psup%! 8 =0
  this_psup%! 12 =0
  SYS "OS_File",17,FNpsup_res(this_psup%,"Resources.!Sprites")TO d%
       
  IF d%=1 THEN
    SYS "XOS_CLI","IconSprites "+FNpsup_res(this_psup%,"Resources.!Sprites") TO C%;d%
    IF(d%AND1) !C%= 253 :SYS"OS_GenerateError",C%
  ENDIF
  SYS "OS_File",17,FNpsup_res(this_psup%,"Resources.Messages")TO d%
       
  IF d%=1 THEN
    PROCmsg_initialise(FNpsup_res(this_psup%,"Resources.Messages"),d%)
    this_psup%! 16 =d%
  ELSE
    this_psup%! 16 =0
  ENDIF
  SYS "OS_File",17,FNpsup_res(this_psup%,"Resources.Templates")TO d%
       
  IF d%<>1 ERROR  254 ,FNmsg_1(A%! 12 ,"FA2",name$)
  PROCwin_template_open(FNpsup_res(this_psup%,"Resources.Templates"),FNpsup_res(this_psup%,"Resources.Template3D"))
  d%=0
  last_wind%=this_psup%+ 20 
  REPEAT
    PROCwin_get_next_name("",d%,name$)
    IF d% THEN
        
      PROCwin_load_create("",name$,1,h%)
      B%= &444E4957 
      C%= 16 +1+LEN name$
      this_wind%=USR(code_entry%+ 12 )
      IF this_wind%=0 ERROR  253 , FNmsg_1(A%! 12 ,"FA5","WIND")
      this_wind%! 0 =0
      this_wind%! 4 =h%
      this_wind%! 8 =0
      this_wind%! 12 =0
      $(this_wind%+ 16 )=name$
      !last_wind%=this_wind%
      last_wind%=this_wind%+ 0 
    ENDIF
  UNTIL d%=0
  PROCwin_template_close

   
  PROCprinter_reason_code(this_psup%,0,-1,0)

   
  IF NOT FNload_file(FNpsup_res(this_psup%,"Template"))     ERROR  254 ,FNmsg_1(A%! 12 ,"OK1a",        $this_psup%! 4 )


  PROCprocess_template(this_psup%)
  PROCrelease_file


  IF multiple_choices% THEN
  
    IF NOT FNload_file(FNpsup_multiple_res(this_psup%,unique_string$,"PrData")) THEN
      f$ =  "<Choices$Write>.Printers" +".Remote.ID"+unique_string$+"."+$this_psup%! 4 
      SYS "XOS_File", 8, f$
      f$ =  "<Choices$Write>.Printers" +".Remote.ID"+unique_string$+"."+$this_psup%! 4 +".PrData"
  
      d% = OPENOUT(f$)
  
      IF d% = 0 THEN
        ERROR  254 ,FNmsg_1(A%! 12 ,"OK1",            $this_psup%! 4 )

      ELSE
         
        tmpt% = this_psup%! 8 
        WHILE tmpt%
          BPUT#d%, $(tmpt%+ 12 )+":"
  
          BPUT#d%,"#"
          tmpt% = tmpt%! 0 
        ENDWHILE

        CLOSE#d%

        SYS "OS_File", 18, f$, &FC6  

        IF NOT FNload_file(FNpsup_multiple_res(this_psup%,unique_string$,"PrData"))           ERROR  254 ,FNmsg_1(A%! 12 ,"OK1",             $this_psup%! 4 )


      ENDIF
    ENDIF
  ELSE


  IF NOT FNload_file(FNpsup_res(this_psup%,"PrData"))     ERROR  254 ,FNmsg_1(A%! 12 ,"OK1",        $this_psup%! 4 )




  ENDIF


  PROCprocess_file(this_psup%)
  PROCrelease_file

   
  PROCread_paper_file(FNpsup_res(this_psup%,"Resources.PaperRO"), 0 )

   
  IF psup_head% THEN
    psup%=psup_head%
    WHILE psup%! 0 
      psup%=psup%! 0 
    ENDWHILE

    psup%! 0 =this_psup%
  ELSE
    psup_head%=this_psup%
  ENDIF
ENDPROC

DEF PROCtimeout_reinitialise
   




  LOCAL prnt%,psup%,t%
    
  timeout%=-1
  prnt%=A%! 48 
  WHILE prnt%
    psup%=prnt%! 4 
    IF psup%! 24  AND  8  THEN
      t%=10*psup%?( 24 +1)
        
      IF timeout%=-1 timeout%=t% ELSE IF t%<timeout% timeout%=t%
      prnt%! 56 =t%
    ELSE
       
      prnt%! 56 =-1
    ENDIF
    prnt%=prnt%! 0 
  ENDWHILE
  SYS "OS_ReadMonotonicTime" TO time_before%
ENDPROC

DEF FNinitialise_scrap
  LOCAL new_scrap$,f%,r0%,s$

  LOCAL prnt%, psup%, name$


  new_scrap$=FNtask_read_env("Wimp$ScrapDir", msg_text%)
  IF new_scrap$="" :=  0 
  IF new_scrap$<>last_scrap$ THEN
    SYS "XOS_File", 8,"<Wimp$ScrapDir>.Printers" TO r0%;f%  
    IF(f%AND1) THEN
      r0%+=4:CALL Z%,r0%,s$
      PROCerror_warning(FNmsg_2(A%! 12 ,"WA13","<Wimp$ScrapDir>.Printers",s$))
    
    ELSE
      last_scrap$ = new_scrap$

      IF sparrow_present% THEN
        SYS "XOS_File", 8, "<Wimp$ScrapDir>.Printers.RemQueue" TO r0%;f%
        IF(f%AND1)=0 SYS "XOS_File", 8, "<Wimp$ScrapDir>.Printers.RemSpool" TO r0%;f%
        IF(f%AND1) THEN
          r0%+=4:CALL Z%,r0%,s$
          PROCerror_warning(FNmsg_2(A%! 12 ,"WA13","<Wimp$ScrapDir>.Printers",s$))
        ENDIF
      ENDIF

      prnt% = A%! 48 
      WHILE prnt%
        IF prnt%! 24  AND  (1<<16)  THEN
          IF (prnt%! 40  = 0) THEN
            psup% = prnt%! 4 
            name$ = $(psup%! 4 )
          ELSE
            name$ = $(prnt%! 40 )
          ENDIF

          PROCshare_one_printer (prnt%)
        ENDIF
        prnt% = prnt%! 0 
      ENDWHILE

    ENDIF
  ENDIF

=  -1 



DEF PROCinitialise_settings
  LOCAL c%,d%,s$,ts%,name$,psup%,cnfg%,t%,name%,found_psup%, dosel%, err%
  LOCAL flags%, thing%, rmtp%, found%, odp%, idx%, str$, prnt%, side%, icon%, spr$, p%, sel%, s$, tmp%

  LOCAL odp%, odl%

    
  



    main_icon%=FNiconbar_tands(FNmsg_0(A%! 12 ,"NNE"),        "s"+FNmsg_0(A%! 12 ,"IC"),-5,&0F000000)

  
  got_icon%= -1 






  IF multiple_choices% THEN
    s$ =  "<Choices$Write>.Printers" +".Remote.ID"+unique_string$+".Settings"
      
    SYS "OS_File",17,s$ TO c%  
      
  ELSE
    SYS "OS_File",17, "<Choices$Write>.Printers" +".Settings" TO c%  
  ENDIF

  IF c%=1 THEN

    IF multiple_choices% THEN
      IF NOT FNload_file (s$)         ERROR  254 ,FNmsg_0(A%! 12 ,"OKD")

    ELSE
      IF NOT FNload_file( "<Choices$Write>.Printers" +".Settings")        ERROR  254 ,FNmsg_0(A%! 12 ,"OKD")

    ENDIF
    ts%=FNmatch_line("fv:")
    IF ts%=0 THEN
      PROCerror_box(FNmsg_0(A%! 12 ,"OKV"),1)
    ELSE
       
      IF FNevaluate($ts%)<>1 THEN
        PROCerror_box(FNmsg_0(A%! 12 ,"OKV"),1)
      ELSE

        PROCsparrow_local_file  

           



        REPEAT
          ts%=FNmatch_line("cl:")

          PROCsparrow_local_file_2

          flags% = 0
          thing% = FNmatch_line("fg:")
          IF thing% THEN
            flags% = FNevaluate ($thing%)
          ENDIF
            

          name%=FNmatch_line("sn:")
          IF name% name$=$name% ELSE name$=""

            

          PROCsparrow_restore_file_2

          IF (ts% > 0) AND ((flags% AND  (1<<17) ) = 0) AND (thing% > 0) THEN

             

            d%=INSTR($ts%,":")
            IF d%=0 d%=LEN $ts%+1
            s$=MID$($ts%,d%+1)
            $ts%=LEFT$($ts%,d%-1)

             
            psup%=psup_head%
            found_psup%= 0 
            WHILE psup% AND NOT found_psup%
              IF $psup%! 4 =$ts% found_psup%= -1 
              IF NOT found_psup% psup%=psup%! 0 
            ENDWHILE

            IF NOT found_psup% THEN
               
                
              PROClocal_file
              PROCinitialise_one_support_library($ts%)  
              PROCinitialise_one_psup($ts%,psup%)
              PROCrestore_file
              found_psup%= -1 
            ENDIF

            IF NOT found_psup% THEN
               
              name%=FNmatch_line("nm:")
              IF name% name$=$name% ELSE name$=""
              PROCerror_warning(FNmsg_2(A%! 12 ,"WA1",$ts%,name$))
            ELSE
              PROCinitialise_one_printer(psup%)
            ENDIF
          ENDIF
        UNTIL ts%=0

        PROCsparrow_restore_file  

        REPEAT
  
          ts%=FNmatch_line("cl:")

           



          odp% = !data_ptr%
          odl% = data_line%

          PROCsparrow_local_file

          flags% = 0
          thing% = FNmatch_line("fg:")
  
          IF thing% THEN
            flags% = FNevaluate ($thing%)
          ENDIF

  
          thing% = FNmatch_line("pn:")
          IF thing% str$=$thing% ELSE str$=""

          name%=FNmatch_line("sn:")
          IF name% name$=$name% ELSE name$=""

            

          PROCsparrow_restore_file

            

          IF (ts% > 0) AND ((flags% AND  (1<<17) ) > 0) AND (thing% > 0) THEN

              

             


            found% =  0 
            rmtp% = remote_printers%
            WHILE rmtp% AND NOT found%
              IF name$ = $rmtp%! 4  THEN
                found% =  -1 
              ELSE
                rmtp% = rmtp%! 0 
              ENDIF
            ENDWHILE

            IF NOT found% OR NOT sparrow_present% THEN
               


                
              p% = INSTR($ts%, ":")
              IF p% = 0 THEN 
                p% = LEN$ts%
              ENDIF
              PROCadd_unavailable_printer (name$, MID$($t%,1,p%-1)," ")
            ELSE
              IF flags% AND  1  THEN
                  
                PROCsparrow_local_file
                prnt% = FNensure_printer (rmtp%, flags%,  -1 ,  0 , err%)
                PROCsparrow_restore_file

                PROCsparrow_local_file
                !data_ptr% = odp%
                data_line% = odl%
                PROCinitialise_one_remote_printer (prnt%)

                PROCsparrow_restore_file

                PROCremove_from_list (remote_printers%, $rmtp%! 4 )

                IF flags% AND  2  THEN
                  prnt%! 24  = prnt%! 24  OR  2 
                ELSE
                  prnt%! 24  = prnt%! 24  AND NOT  2 
                ENDIF

                d%=psize_head%
                WHILE d%
                  IF $d%! 4 =str$ THEN
                      
                    prnt%! 36 =d%
                    d%=0
                  ELSE
                    d%=d%! 0 
                    IF d%=0 THEN
                      d%=psize_head%
                      prnt%! 36 =d%
                      PROCerror_warning(FNmsg_3(A%! 12 ,"WA11",str$,$d%! 4 ,name$))
                      d%=0
                    ENDIF
                  ENDIF
                ENDWHILE

              ENDIF
            ENDIF  
          ENDIF  

        UNTIL ts% = 0  

      ENDIF  
    ENDIF  

    PROCrelease_file
  ENDIF  

   

  PROCbroadcast_reason_code(A%! 48 ,-5,0)


  sel% =  0 
  prnt% = A%! 48 
  WHILE prnt%
    IF prnt%! 24  AND  2  THEN
      sel% =  -1 
      dosel% = prnt%
      prnt% = 0
    ELSE
      prnt% = prnt%! 0 
    ENDIF
  ENDWHILE
  prnt% = A%! 48 
  IF (NOT sel%) AND (prnt%) THEN
    PROCselect_printer (prnt%,  -1 ,  0 )
  ELSE 
    IF sel% AND dosel% THEN
      PROCselect_printer (dosel%,  -1 ,  0 )
    ENDIF
  ENDIF

    
ENDPROC














































































DEF PROCinitialise_one_printer(psup%)
  LOCAL ts%,prdt%,prnt%,d%,cnct%,h%,nm$,head%
    

  ts%=FNmatch_line_or_error("nm:")
  nm$=$ts%
  IF psup%! 44 >100 THEN
     
    PROCerror_warning(FNmsg_1(A%! 12 ,"WA7",nm$))
    ENDPROC
  ENDIF
   

   
  head%=psup%! 12 
  prdt%=head%! 4 
  WHILE prdt%>0
    IF $prdt%! 8 =nm$ THEN
      prdt%!(prdt%! 4 *4+ 8 )+=1
      prdt%=-1
    ELSE
      prdt%=prdt%! 0 
    ENDIF
  ENDWHILE

  IF prdt%=0 THEN
     
    PROCerror_warning(FNmsg_1(A%! 12 ,"WA8",nm$))
    ENDPROC
  ENDIF

  B%= &544E5250 
  C%= 68 
  prnt%=USR(code_entry%+ 12 )
  IF prnt%=0 ERROR  253 ,FNmsg_1(A%! 12 ,"FA5","PRNT")
  B%=ts%
  C%=2
  prnt%! 8 =USR(code_entry%+ 28 )
    

   
  prnt%! 0 =0
  prnt%! 4 =psup%

  IF psup%! 24  AND  8      prnt%! 56 =10*psup%?( 24 +1)   ELSE     prnt%! 56 =-1



    

   
  IF psup%! 24  AND  4  THEN
     
    h%=FNevaluate($FNmatch_line_or_error("cn:"))

    B%= &54434E43 
    C%=h%*4
    cnct%=USR(code_entry%+ 12 )
    IF cnct%=0 ERROR  253 ,FNmsg_1(A%! 12 ,"FA5","CNCT")
    prnt%! 12 =cnct%
    IF 0<=h%-1 THEN
      FOR d%=0 TO h%-1
        ts%=FNmatch_any_line
        IF ts% THEN
          ss%=FNmatch_string(ts%,"nl:")
          IF ss% THEN
            cnct%!(d%*4)=0
          ELSE
            ss%=FNmatch_string(ts%,"in:")
            IF ss% THEN
              cnct%!(d%*4)=FNstore_integer(FNevaluate($ss%))
            ELSE
              ss%=FNmatch_string(ts%,"st:")
              IF ss% THEN
                B%=ss%
                C%=2
                cnfg%!(d%*4)=USR(code_entry%+ 28 )
              ELSE
                ss%=FNmatch_string(ts%,"s0:")
                IF ss% THEN
                  B%=ss%
                  C%=3
                  cnfg%!(d%*4)=USR(code_entry%+ 28 )
                ELSE
                  ss%=FNmatch_string(ts%,"gs:")
                  IF ss% THEN
                    B%=ss%
                    C%=4
                    cnfg%!(d%*4)=USR(code_entry%+ 28 )
                  ELSE
                    ss%=FNmatch_string(ts%,"pt:")
                    IF ss% THEN
                      B%= &52544F50 
                      C%=4
                      cnct%!(d%*4)=USR(code_entry%+ 12 )
                      IF cnct%!(d%*4)=0                         ERROR  253 ,FNmsg_1(A%! 12 ,"FA5","POTR")

                      !cnct%!(d%*4)=FNfix_up_pointer($ss%, 0 )
                    ELSE
                      PROCsettings_error(FNmsg_1(A%! 12 ,"OKH",$ts%))
                    ENDIF
                  ENDIF
                ENDIF
              ENDIF
            ENDIF
          ENDIF
        ENDIF
      NEXT          
    ENDIF
  ELSE
     
    B%= &54434E43 
    C%= 36 
    cnct%=USR(code_entry%+ 12 )
    IF cnct%=0       ERROR  253 ,FNmsg_1(A%! 12 ,"FA5","CNCT")

    prnt%! 12 =cnct%

    cnct%! 0 =FNevaluate($FNmatch_line_or_error("ct:"))

     







    cnct%! 4 =FNevaluate($FNmatch_line_or_error("bd:"))
    IFNOTFNsupport_higher_baudrates AND (cnct%? 4  > 15) THEN
      PROCerror_box(FNmsg_1(A%! 12 ,"OKAM",FNmsg_0(A%! 12 ,"BR"+STR$(cnct%? 4 ))),1)
      cnct%? 4  = 0
    ENDIF

    cnct%! 8 =FNevaluate($FNmatch_line_or_error("ft:"))

    C%=2
    B%=FNmatch_line_or_error("et:")
    cnct%! 12 =USR(code_entry%+ 28 )

    B%=FNmatch_line_or_error("fl:")
    cnct%! 16 =USR(code_entry%+ 28 )

    B%=FNmatch_line_or_error("ns:")
    cnct%! 20 =USR(code_entry%+ 28 )

    B%=FNmatch_line_or_error("np:")
    cnct%! 24 =USR(code_entry%+ 28 )

    B%=FNmatch_line_or_error("nu:")
    cnct%! 28 =USR(code_entry%+ 28 )

    B%=FNmatch_line_or_error("no:")
    cnct%! 32 =USR(code_entry%+ 28 )

    ts%=FNmatch_line("cf:")
    IF ts% THEN
      cnct%? 6 =FNevaluate($ts%)
    ELSE
       
      cnct%? 6 =0
    ENDIF

     
    CASE cnct%! 0  OF
      WHEN 4
        IF NOT FNeconet_installed THEN
          cnct%! 0 =0
          PROCerror_warning(FNmsg_2(A%! 12 ,"WA9",              $prnt%! 8 ,FNmsg_0(A%! 12 ,"CN4")))

        ENDIF
      WHEN 6
        IF NOT FNnfs_installed THEN
          cnct%! 0 =0
          PROCerror_warning(FNmsg_2(A%! 12 ,"WA9",              $prnt%! 8 ,FNmsg_0(A%! 12 ,"CN6")))

        ENDIF
    ENDCASE
  ENDIF

   
  h%=FNevaluate($FNmatch_line_or_error("cs:"))
  B%= &47464E43 
  C%=h%*4
  cnfg%=USR(code_entry%+ 12 )
  IF cnfg%=0     ERROR  253 ,FNmsg_1(A%! 12 ,"FA5","CNFG")

  prnt%! 16 =cnfg%
  IF 0<=h%-1 THEN
    FOR d%=0 TO h%-1
      ts%=FNmatch_any_line
      IF ts% THEN
        ss%=FNmatch_string(ts%,"nl:")
        IF ss% THEN
          cnfg%!(d%*4)=0
        ELSE
          ss%=FNmatch_string(ts%,"in:")
          IF ss% THEN
            cnfg%!(d%*4)=FNstore_integer(FNevaluate($ss%))
          ELSE
            ss%=FNmatch_string(ts%,"st:")
            IF ss% THEN
              B%=ss%
              C%=2
              cnfg%!(d%*4)=USR(code_entry%+ 28 )
            ELSE
              ss%=FNmatch_string(ts%,"s0:")
              IF ss% THEN
                B%=ss%
                C%=3
                cnfg%!(d%*4)=USR(code_entry%+ 28 )
              ELSE
                ss%=FNmatch_string(ts%,"gs:")
                IF ss% THEN
                  B%=ss%
                  C%=4
                  cnfg%!(d%*4)=USR(code_entry%+ 28 )
                ELSE
                  ss%=FNmatch_string(ts%,"pt:")
                  IF ss% THEN
                    B%= &52544F50 
                    C%=4
                    cnfg%!(d%*4)=USR(code_entry%+ 12 )
                    IF cnfg%!(d%*4)=0                       ERROR  253 ,FNmsg_1(A%! 12 ,"FA5","POTR")

                    !cnfg%!(d%*4)=FNfix_up_pointer($ss%, 0 )
                  ELSE
                    PROCsettings_error(FNmsg_1(A%! 12 ,"OKH",$ts%))
                  ENDIF
                ENDIF
              ENDIF
            ENDIF
          ENDIF
        ENDIF
      ENDIF
    NEXT
  ENDIF

   
  prnt%! 20 =-1
  prnt%! 24 =FNevaluate($FNmatch_line_or_error("fg:"))
  prnt%! 28 =-1
  prnt%! 32 =0

  ts%=FNmatch_line_or_error("pn:")
  d%=psize_head%
  WHILE d%
    IF $d%! 4 =$ts% THEN
        
      prnt%! 36 =d%
      d%=0
    ELSE
      d%=d%! 0 
      IF d%=0 THEN
        d%=psize_head%
        prnt%! 36 =d%
        PROCerror_warning(FNmsg_3(A%! 12 ,"WA11",$ts%,$d%! 4 ,nm$))
        d%=0
      ENDIF
    ENDIF
  ENDWHILE

  C%=2
  B%=FNmatch_line_or_error("sn:")
  prnt%! 40 =USR(code_entry%+ 28 )

  B%=FNmatch_line_or_error("ic:")
  prnt%! 44 =USR(code_entry%+ 28 )

   
  IF psup%! 32  AND %100     prnt%! 48 =FNallocate_pause_window   ELSE     prnt%! 48 =0




  prnt%! 52 =0
  IF prnt%! 24  AND  1  THEN
    PROCcreate_printer_icon(prnt%)
    IF prnt%! 24  AND  2  THEN
       
        
      PROCselect_printer(prnt%, -1 , 0 )
    ENDIF
  ENDIF


   




  IF prnt%! 24  AND  (1<<16)  AND sparrow_present% THEN
    PROCshare_one_printer (prnt%)
  ENDIF


   
  d%=A%+ 48 
  WHILE !d%
    d%=!d%+ 0 
  ENDWHILE
  !d%=prnt%

  printer_count%+=1

   
  PROCtimeout_reinitialise
ENDPROC

DEF FNmatch_line_or_error(ts$)
  LOCAL ts%
    
  ts%=FNmatch_line(ts$)
  IF ts%=0 PROCsettings_error(FNmsg_1(A%! 12 ,"OKG",ts$))
=ts%

DEF PROCsettings_error(e$)
    
  PROCram_file_error(FNmsg_1(A%! 12 ,"OKE",e$))
ENDPROC

DEF FNpsup_res(psup%,s$)
    
="Printers:"+$psup%! 4 +"."+s$

DEF FNone_of_ours(h%)
  LOCAL p%
    
  IF h%=-2 THEN = -1   
  IF h%=save_wind% THEN = -1 
  IF h%=shutdown% THEN = -1 
  IF h%=howquery% THEN = -1 
  IF h%=papersize% THEN = -1 
  IF h%=query% THEN = -1 
  IF h%=A%! 40  THEN = -1 
  IF h%=connections% THEN = -1 
  IF h%=prntctrl% THEN = -1 
  IF h%=info% THEN = -1 
   
  p%=A%! 48 
  WHILE p%
    IF p%! 48 =h% THEN = -1 
    p%=p%! 0 
  ENDWHILE
= 0 

DEF PROCinitialise_windows
   



  LOCAL i%,fmt$,tr$,p1%,p2%,p3%,p4%,j%
    
  PROCwin_template_open("Printers:Templates","Printers:Template3D")
  PROCwin_load_create("","info",1,info%)
  PROCwin_load_create("","prntctrl",1,prntctrl%)
  PROCwin_load_create("","connections",1,connections%)
  PROCwin_load_create("","queue",1,A%! 40 )
  PROCwin_load_create("","query",1,query%)
  PROCwin_load_create("","papersize",1,papersize%)
  PROCwin_load_create("","howquery",1,howquery%)
  PROCwin_load_create("","shutdown",1,shutdown%)
  PROCwin_load_create("","save",1,save_wind%)
  PROCwin_template_close

  PROCicon_write(info%,3,FNmsg_0(A%! 12 ,"VSN"))
   
  FOR j%=0 TO 5
    B%= &46444349 
    C%=40
    i%=USR(code_entry%+ 12 )
    IF i%=0       ERROR  253 ,          FNmsg_1(A%! 12 ,"FA5","ICDF")


    !i%=A%! 40 
    i%!4=j%
    SYS "Wimp_GetIconState",,i%
    SYS "Wimp_DeleteIcon",,i%
    A%!( 52 +4*j%)=i%+8
  NEXT

   
   



  FOR j%=0 TO 4
    B%= &46444349 
    C%=40
    i%=USR(code_entry%+ 12 )
    IF i%=0       ERROR  253 ,          FNmsg_1(A%! 12 ,"FA5","ICDF")


    !i%=prntctrl%
    i%!4=j%
    SYS "Wimp_GetIconState",,i%
    IF j%=4 THEN
      SYS "Wimp_DeleteIcon",,i%
    ELSE
       
      B%= &58585858 
      C%=i%!36+1
      i%!28=USR(code_entry%+ 12 )
      IF i%!28=0         ERROR  253 ,            FNmsg_1(A%! 12 ,"FA5","XXXX")


    ENDIF
    prntctrl_icdf%(j%)=i%+8
  NEXT

   
  FOR j%=0 TO 3
    prntctrl_icdf%(j%)!16 = prntctrl_icdf%(4)!16
  NEXT

   
  FOR j%=0 TO 3
    PROCicon_write(prntctrl%,j%,        FNmsg_0(A%! 12 ,        FNicon_read(prntctrl%,j%)))


  NEXT
ENDPROC

DEF FNmax(a,b): IF a>b THEN =a ELSE =b

DEF FNallocate_pause_window
  LOCAL p%
    
  PROCwin_template_open("Printers:Templates","Printers:Template3D")
  PROCwin_load_create("","pause",1,p%)
  PROCwin_template_close
=p%

DEF PROCdeallocate_pause_window(handle%)
   



    
  !buff1%=handle%
  SYS "Wimp_GetWindowInfo",,buff1% OR 1
  B%= &46465542 
  C%=buff1%!76
  CALL code_entry%+ 16 
  SYS "Wimp_DeleteWindow",,buff1%
ENDPROC

DEF PROCredraw_window
  LOCAL more%,i%,t$,con$,prnt%,psup%,wind%

  LOCAL rmtp%

    
  CASE !task_buff% OF
    WHEN A%! 40 
      SYS "Wimp_RedrawWindow",,task_buff% TO more%
      B%=task_buff%
      C%=more%
      CALL code_entry%+ 36 
    WHEN prntctrl%
       
      SYS "Wimp_RedrawWindow",,task_buff% TO more%
      WHILE more%
         
        FOR i%=0 TO 3
           
          prntctrl_icdf%(i%)!4=prntctrl_icdf%(4)!4
          prntctrl_icdf%(i%)!12=prntctrl_icdf%(4)!12
        NEXT

        prnt%=A%! 48 
        prnt_count%=0
        WHILE prnt%
          prnt_count%+=1

           
          IF prnt%! 40  THEN
            $prntctrl_icdf%(0)!20=$prnt%! 40 
          ELSE
            ?prntctrl_icdf%(0)!20=13
          ENDIF

           
          $prntctrl_icdf%(1)!20=$prnt%! 8 
  
           
          t$=STR$ !(prnt%! 12 + 0 )
          con$=FNmsg_0(A%! 12 ,"IC"+t$)
          IF con$="IC"+t$               con$=FNmsg_1(A%! 12 ,"ICx",t$)

          $prntctrl_icdf%(2)!20=con$
  
           

           


          IF prnt%! 24  AND  (1<<16)  THEN
             t$ = "SHA"
          ELSE 
            IF prnt%! 24  AND  1  THEN
              t$="ACT"
            ELSE
              t$="INA"
            ENDIF
          ENDIF



          $prntctrl_icdf%(3)!20=FNmsg_0(A%! 12 ,t$)

          FOR i%=0 TO 3
            SYS "Wimp_PlotIcon",,prntctrl_icdf%(i%)
            
             
            prntctrl_icdf%(i%)!12=prntctrl_icdf%(i%)!4
            prntctrl_icdf%(i%)!4-=(prntctrl_icdf%(4)!12 - prntctrl_icdf%(4)!4)
          NEXT

          prnt%=prnt%! 0 
        ENDWHILE


        rmtp% = remote_printers%
        WHILE rmtp%
          $prntctrl_icdf%(0)!20 = $rmtp%! 4 
          $prntctrl_icdf%(1)!20 = $rmtp%! 8 
          $prntctrl_icdf%(2)!20 = FNmsg_0 (A%! 12 , "IC9")
           


          IF rmtp%! 20  > 0 THEN
            $prntctrl_icdf%(3)!20 = FNmsg_0 (A%! 12 , "UNA")
          ELSE
            $prntctrl_icdf%(3)!20 = FNmsg_0 (A%! 12 , "INA")
          ENDIF

          FOR i%=0 TO 3
            SYS "Wimp_PlotIcon",,prntctrl_icdf%(i%)
            
             
            prntctrl_icdf%(i%)!12=prntctrl_icdf%(i%)!4
            prntctrl_icdf%(i%)!4-=(prntctrl_icdf%(4)!12 - prntctrl_icdf%(4)!4)
          NEXT

          rmtp% = rmtp%! 0 
        ENDWHILE


        SYS "Wimp_GetRectangle",,task_buff% TO more%
      ENDWHILE
    OTHERWISE
      PROCprinter_find_handle(!task_buff%,wind%,psup%,prnt%)
      PROCprinter_reason_code(psup%,prnt%,1,task_buff%)
  ENDCASE
ENDPROC

DEF PROCopen_pause_window(prnt%)
   
  LOCAL y%,s$
    
   
  IF prnt%! 40  s$=$prnt%! 40  ELSE s$=$prnt%! 8 
  PROCwin_title(prnt%! 48 ,FNmsg_1(A%! 12 ,"PAU",s$))
  !buff1%=-2
  SYS "Wimp_GetWindowState",,buff1%
  y%=buff1%!4-buff1%!20
  buff1%!4=prnt%! 20 
  SYS "Wimp_GetIconState",,buff1%
  y%+=buff1%!16-680  
  !buff1%=prnt%! 48 
  SYS "Wimp_GetWindowState",,buff1%
  buff1%!12=(buff1%!12-buff1%!4)+y%
  buff1%!16=140+240  
  buff1%!4=y%
  buff1%!8=buff1%!16-240
  buff1%!28=-1
  SYS "Wimp_OpenWindow",,buff1%
ENDPROC

DEF PROCtell_pinboard(handle%)
 




!buff1%=24
buff1%!12=0
buff1%!16=&400CB
buff1%!20=handle%
SYS"Wimp_SendMessage",17,buff1%,0
ENDPROC

DEF PROCclose_window
  LOCAL i%,j%,prnt%,psup%,wind%
    
  PROCtell_pinboard(!task_buff%)
  IF FNone_of_ours(!task_buff%)THEN
    SYS "Wimp_CloseWindow",,task_buff%
  ELSE
    PROCprinter_find_handle(!task_buff%,wind%,psup%,prnt%)
    PROCprinter_reason_code(psup%,prnt%,3,task_buff%)
  ENDIF
ENDPROC

DEF PROCfree_structure(p%)
   

  LOCAL i%
  





  IF p%=0 ENDPROC
  CASE p%!-4 OF
    WHEN  &4454534C 
      WHILE p%
        IF 0<=p%! 4 -1 THEN
          FOR i%=0 TO p%! 4 -1
            PROCfree_structure(p%!(i%*4+ 8 ))
          NEXT
        ENDIF
        i%=p%! 0 
        B%= &4454534C 
        C%=p%
        CALL code_entry%+ 16 
        p%=i%
      ENDWHILE
    WHEN  &4C4f4F42 
      PROCfree_structure(p%! 0 )
      PROCfree_structure(p%! 4 )
      B%= &4C4f4F42 
      C%=p%
      CALL code_entry%+ 16 
    WHEN  &47544E49 , &47525453 , &30525453 , &52545347 , &52544F50 
      B%=p%!-4
      C%=p%
      CALL code_entry%+ 16 
  



    WHEN  &52414843 
      WHILE p%
        i%=!p%
        B%= &52414843 
        C%=p%
        CALL code_entry%+ 16 
        p%=i%
      ENDWHILE
    OTHERWISE
      ERROR  253 ,FNmsg_1(A%! 12 ,"FAA",STR$~(p%-4))
  ENDCASE
ENDPROC

DEF PROCreceive(r%)
   
  LOCAL s$,prnt%,psup%,wind%,to%,i%
    
  to%=task_buff%!4
  CASE task_buff%!16 OF
    WHEN 0  
      PROCdestroy_queue
      PROChost_shutdown
    WHEN 1  
      PROCdatasave
    WHEN 2  
      IF NOT task_buff%!36 THEN
        SYS "Wimp_CreateMenu",,-1
        i%=task_buff%+44
        CALL Z%,i%,s$  
        PROCicon_write(connections%, 30 ,s$)
      ENDIF
    WHEN 3  
      PROCdataload
    WHEN 5  
       

      IF task_buff%!40=&FC6 THEN
        task_buff%!12=task_buff%!8
        task_buff%!16=4
        SYS "Wimp_SendMessage",17,task_buff%,to%
          
        PROCadd_to_prdata
      ENDIF

    WHEN 8  
      IF A%! 32  THEN
        IF!task_buff%<>20 THEN
          IF(task_buff%!20 AND 1)=0 shutdown_type%=1 ELSE shutdown_type%=2
        ELSE
          shutdown_type%=1
        ENDIF
        task_buff%!12=task_buff%!8
        SYS "Wimp_SendMessage",19,task_buff%,to%
          
        A%! 20 =A%! 20  OR 1
        PROCmenu_window_centre(shutdown%)
      ENDIF
    WHEN 10  
      BPUT#task_buff%!20,"/"+FNtask_read_env("Printers$Dir",buff1%)
    WHEN 11  
       
      prnt%=A%! 48 
      WHILE prnt%
        IF(prnt%! 24  AND  8 )<>0 AND prnt%<>claim_ref% THEN
           
          r%=prnt%! 12 
          IF r%! 0 =task_buff%!20 AND task_buff%!24<=0 THEN
            s$=FNmsg_0(A%! 12 ,"INU")
            !task_buff%=32+LEN s$ AND NOT 3
            task_buff%!12=task_buff%!8
            task_buff%!16=12  
            $(task_buff%+28)=s$+CHR$ 0
            SYS "Wimp_SendMessage",17,task_buff%,to%
              
            prnt%=0
          ENDIF
        ENDIF
        IF prnt% prnt%=prnt%! 0 
      ENDWHILE
    WHEN 12  
      claim_state%=2
    WHEN &502  
      IF FNone_of_ours(task_buff%!32)THEN
        PROCdetermine_help
      ELSE
        PROCprinter_find_handle(task_buff%!32,wind%,psup%,prnt%)
        IF wind% THEN
          PROCprinter_reason_code(psup%,prnt%,r%,task_buff%)
        ELSE
           
          IF NOT task_buff%!36 THEN
            IF menu_prnt%               PROCprinter_reason_code (menu_prnt%! 4 ,                  menu_prnt%,r%,task_buff%)             ELSE               PROCdetermine_help




          ENDIF
        ENDIF
      ENDIF
    WHEN &400C9
       
      IF task_buff%!20=shutdown% THEN
        IFA%! 32 >0  A%! 20  = A%! 20  AND NOT 1
      ELSE
        PROCcancel_menued_item
      ENDIF
    WHEN &80141
       
      A%! 36 = 0 
    WHEN &80142
       
       
      IF selected_prnt% THEN
        task_buff%!20=-2
        task_buff%!24=selected_prnt%! 20 
        PROCdatasave
      ELSE
        prnt%=A%! 48 
        IFprnt% THEN
          task_buff%!20=1
          s$=FNmsg_0(A%! 12 ,"OKU")+CHR$ 0
        ELSE
          task_buff%!20=2
          s$=FNmsg_0(A%! 12 ,"OKW")+CHR$ 0
        ENDIF
        !task_buff%=28+LEN s$ AND NOT 3
        task_buff%!12=task_buff%!8
        task_buff%!16=&80144  
        $(task_buff%+24)=s$+CHR$ 0
        SYS "Wimp_SendMessage",17,task_buff%,to%
          
      ENDIF
    WHEN &80143
       
       

      IF task_buff%!4<>task_handle% THEN
        IF task_buff%!0=20 THEN
           
          PROCdestroy_queue
          PROChost_shutdown
        ELSE
           
          IF task_buff%!12=task_your_ref% THEN
             
            PROCerror_warning(FNmsg_0(A%! 12 ,"FAJ"))
            PROCdestroy_queue
            PROChost_shutdown
          ELSE
             
            task_buff%!12=task_buff%!8
            task_buff%!20=34  
            SYS "Wimp_SendMessage",17,task_buff%,to%
              
          ENDIF
        ENDIF
      ENDIF
 


       
       





    WHEN &80146
       
      type_state%=2
    WHEN &80152
       
      IF selected_prnt% THEN
          
        PROCselect_printer(selected_prnt%, -1 , 0 )
      ENDIF
    OTHERWISE
       
       
       
      IFFNinitialise_scrap
      PROCbroadcast_reason_code(selected_prnt%,r%,task_buff%)
  ENDCASE
    
ENDPROC

DEF PROCdetermine_help
  LOCAL s$,prnt%,token$
    
  CASE task_buff%!32 OF
    WHEN -2
      IF A%! 48 =0 THEN
        PROCinteractive_help(FNmsg_0(A%! 12 ,"ICON0"))
        ENDPROC
      ENDIF
      PROCmatch_icon(task_buff%!36,prnt%)
      IF prnt%! 40            s$=$prnt%! 40  ELSE s$=$prnt%! 8 

      PROCinteractive_help(FNmsg_1(A%! 12 ,"ICON1",s$))
    WHEN save_wind%
      s$=FNmsg_0(A%! 12 ,"SAVE"+STR$ task_buff%!36)
      IF s$="SAVE"+STR$ task_buff%!36 s$=FNmsg_0(A%! 12 ,"SAVE")
      PROCinteractive_help(s$)
    WHEN shutdown%
      s$=FNmsg_0(A%! 12 ,"SHTDWN"+STR$ task_buff%!36)
      IF s$="SHTDWN"+STR$ task_buff%!36 s$=FNmsg_0(A%! 12 ,"SHTDWN")
      PROCinteractive_help(s$)
    WHEN howquery%
      s$=FNmsg_0(A%! 12 ,"HWQRY"+STR$ task_buff%!36)
      IF s$="HWQRY"+STR$ task_buff%!36 s$=FNmsg_0(A%! 12 ,"HWQRY")
      PROCinteractive_help(s$)
    WHEN papersize%
      s$=FNmsg_0(A%! 12 ,"PAPER"+STR$ task_buff%!36)
      IF s$="PAPER"+STR$ task_buff%!36 s$=FNmsg_0(A%! 12 ,"PAPER")
      PROCinteractive_help(s$)
    WHEN query%
      s$=FNmsg_0(A%! 12 ,"QUERY"+STR$ task_buff%!36)
      IF s$="QUERY"+STR$ task_buff%!36 s$=FNmsg_0(A%! 12 ,"QUERY")
      PROCinteractive_help(s$)
    WHEN A%! 40 
      PROCinteractive_help(FNmsg_0(A%! 12 ,"QUEUE"))
    WHEN connections%
      token$="CNCT"+STR$ task_buff%!36
      IF task_buff%!36= 13  THEN
        IF FNicon_set(connections%, 13 )token$+="b" ELSE token$+="a"
      ENDIF
      IF task_buff%!36= 35  THEN
        IF FNicon_set(connections%, 35 ) token$+="b" ELSE token$+="a"
      ENDIF
      IF task_buff%!36= 37  THEN
        IF FNicon_set(connections%, 37 ) token$+="b" ELSE token$+="a"
      ENDIF
      s$=FNmsg_0(A%! 12 ,token$)
      IF s$=token$ s$=FNmsg_0(A%! 12 ,"CNCT")
      PROCinteractive_help(s$)
    WHEN prntctrl%
      PROCinteractive_help(FNmsg_0(A%! 12 ,"PRCTRL"))
    WHEN info%
      PROCinteractive_help(FNmsg_0(A%! 12 ,"INFO"))
    OTHERWISE  
      SYS "Wimp_GetMenuState",1,win_buff%,task_buff%!32,task_buff%!36
      CASE menu_chsn$ OF
        WHEN "ME1"
          IF!win_buff%<>2 THEN
            PROCinteractive_help(FNmsg_0(A%! 12 ,"HME1-"+STR$!win_buff%))
          ELSE
            IF A%! 44 =0 THEN
              PROCinteractive_help(FNmsg_0(A%! 12 ,"HME1-2a"))
            ELSE
              PROCinteractive_help(FNmsg_0(A%! 12 ,"HME1-2"))
            ENDIF
          ENDIF
        WHEN "ME2","ME3","ME4","ME5","ME6","MP1"
          PROCinteractive_help(FNmsg_0(A%! 12 ,"H"+menu_chsn$))
        WHEN "MQ1"
          IF FNmenu_shade(menu_top%,!win_buff%)THEN
            IF !win_buff%>3 AND menued_queu%=0 THEN
              PROCinteractive_help(FNmsg_0(A%! 12 ,"SMQ1-7"))
            ELSE
              PROCinteractive_help(FNmsg_0(A%! 12 ,"SMQ1-"+STR$(!win_buff%)))
            ENDIF
          ELSE
            IF !win_buff%<>4 THEN
              PROCinteractive_help(FNmsg_0(A%! 12 ,"HMQ1-"+STR$(!win_buff%)))
            ELSE
              IF menued_queu%! 12  THEN
                PROCinteractive_help(FNmsg_0(A%! 12 ,"HMQ1-4a"))
              ELSE
                PROCinteractive_help(FNmsg_0(A%! 12 ,"HMQ1-4b"))
              ENDIF
            ENDIF
          ENDIF
        WHEN "MC1"
          IF FNmenu_shade(menu_top%,!win_buff%)THEN
            IF !win_buff%=6 THEN
              PROCinteractive_help(FNmsg_0(A%! 12 ,"SMC1-6"))
              ENDPROC
            ENDIF
            SYS "Wimp_WhichIcon",prntctrl%,buff1%,1<<21,1<<21
            IF !buff1%=-1 THEN
              PROCinteractive_help(FNmsg_0(A%! 12 ,"SMC1-2"))
            ELSE
              PROCinteractive_help(FNmsg_0(A%! 12 ,"SMC1-0"))
            ENDIF
          ELSE
            PROCinteractive_help(FNmsg_0(A%! 12 ,"HMC1-"+STR$!win_buff%))
          ENDIF

        WHEN "MC1s"
          IF FNmenu_shade(menu_top%,!win_buff%)THEN
            IF !win_buff%=7 THEN
              PROCinteractive_help(FNmsg_0(A%! 12 ,"SMC1s-7"))
              ENDPROC
            ENDIF
            IF !win_buff%=2 AND sparrow_present%= 0  THEN
              PROCinteractive_help(FNmsg_0(A%! 12 ,"SMC1s-2"))
              ENDPROC
            ENDIF
            SYS "Wimp_WhichIcon",prntctrl%,buff1%,1<<21,1<<21
            IF !buff1%=-1 THEN
              PROCinteractive_help(FNmsg_0(A%! 12 ,"SMC1s-3"))
            ELSE
              PROCinteractive_help(FNmsg_0(A%! 12 ,"SMC1s-0"))
            ENDIF
          ELSE
            PROCinteractive_help(FNmsg_0(A%! 12 ,"HMC1s-"+STR$!win_buff%))
          ENDIF

      ENDCASE
  ENDCASE
ENDPROC

DEF PROCinteractive_help(m$)
  LOCAL to%
    
  !task_buff%=24+LEN m$ AND NOT 3
  task_buff%!12=task_buff%!8
  task_buff%!16=&503  
  $(task_buff%+20)=m$+CHR$ 0
  to%=task_buff%!4
  SYS "Wimp_SendMessage",17,task_buff%,to%
    
ENDPROC

DEF PROCdatasave
   
  LOCAL s$,i%,y%,prnt%,queu%
    

  IF task_buff%!20=A%! 40  THEN
     
    !win_buff%=A%! 40 
    SYS "Wimp_GetWindowState",,win_buff%
    B%=task_buff%!32-win_buff%!16+win_buff%!24  
    y%=USR(code_entry%+ 44 )
    i%=A%! 16 
    prnt%=!i%
    queu%=i%!4
    IF prnt% THEN
      task_buff%!20=-2
      task_buff%!24=prnt%! 20 
    ENDIF
  ELSE
    PROCmatch_icon(task_buff%!24, prnt%)
  ENDIF

  IF task_buff%!20<>-2       ERROR  254 ,FNmsg_0(A%! 12 ,"OKN")


   

  i%=task_buff%+44
  CALL Z%,i%,s$  

  i%=LEN s$
  WHILE i%>0
   IF MID$(s$,i%,1)="." OR MID$(s$,i%,1)=":" THEN
     s$=MID$(s$,i%+1)
     i%=0
   ENDIF
   i%-=1
  ENDWHILE
  queue_leafname$=s$
  A%! 36 = 0 
  queue_temphand%=task_buff%!4

   




  s$=FNtemporary_name( -1 )
  IF (prnt%! 32 )<>0 OR (prnt%! 24  AND  36 )<>0 THEN
    SYS "XOS_SetVarVal","Printer$Temp",,-1
    task_buff%!0=48+LEN s$ AND NOT 3
    task_buff%!12=task_buff%!8
    task_buff%!16=2  
    task_buff%!36=-1  
    $(task_buff%+44)=s$+CHR$ 0
    SYS "Wimp_SendMessage",17,task_buff%,queue_temphand%
     
    queue_tempref%=task_buff%!8
  ELSE
     
     
     
     
     
     
    task_buff%!12=task_buff%!8
    SYS "Wimp_SendMessage",19,task_buff%,queue_temphand%
     

     
    PROCselect_printer(prnt%, 0 , 0 )

     

      
    SYS "OS_SetVarVal","Printer$Temp",s$,LEN s$
     
    task_buff%!16=&80140  
    SYS "Wimp_SendMessage",18,task_buff%,queue_temphand%
      

    PROCsave_sender_info (queue_temphand%, queue_leafname$)

  ENDIF
ENDPROC

DEF FNtemporary_name(generate_error%)
  LOCAL c%
    

   
  IFNOTFNinitialise_scrap THEN
    IFgenerate_error% THEN
      ERROR  254 , FNmsg_0(A%! 12 , "OKAO")
    ELSE
      PROCerror_box(FNmsg_0(A%! 12 , "OKAO"),1)
      =""
    ENDIF
  ENDIF

  REPEAT
     

    temp_count%+=1
    SYS "OS_File",17,"<Wimp$ScrapDir>.Printers."+STR$ temp_count% TO c%
         
  UNTIL c%=0

    
=FNgstrans("<Wimp$ScrapDir>.Printers."+STR$ temp_count%)

DEF PROCdataload
  LOCAL s$,i%,prnt%,sender$,leaf$,type%,to%
    

  IF task_buff%!40=&FC6 AND task_buff%!20=prntctrl% THEN
    PROCadd_to_prdata
    ENDPROC
  ENDIF

   
  i%=task_buff%+44
  CALL Z%,i%,leaf$  
  SYS"OS_File",17,leaf$ TO type%
   
  IF(type%AND2) AND (task_buff%!40<&1000) task_buff%!40=&1000

  IF task_buff%!20=A%! 40  THEN
     
    !win_buff%=A%! 40 
    SYS "Wimp_GetWindowState",,win_buff%
    B%=task_buff%!32-win_buff%!16+win_buff%!24  
    y%=USR(code_entry%+ 44 )
    i%=A%! 16 
    prnt%=!i%
    queu%=i%!4
    IF prnt% THEN
      task_buff%!20=-2
      task_buff%!24=prnt%! 20 
    ENDIF
  ENDIF

  IF task_buff%!20<>-2       ERROR  254 ,FNmsg_0(A%! 12 ,"OKN")


   
  A%! 36 =      queue_tempref%<>0 AND queue_tempref%=task_buff%!12

  task_buff%!12=task_buff%!8
  task_buff%!16=4  
  to%=task_buff%!4
  SYS "Wimp_SendMessage",17,task_buff%,to%
    
  queue_tempref%=0

  PROCmatch_icon(task_buff%!24,prnt%)
  type%=task_buff%!40
  IF prnt%=0 THEN
     
    IF type%<>&FC6 ERROR  254 ,FNmsg_0(A%! 12 ,"OKW")
    PROCadd_to_prdata
    ENDPROC
  ENDIF

   
  IF A%! 36  THEN
    SYS "TaskManager_TaskNameFromHandle",queue_temphand% TO i%
    CALL Z%,i%,sender$  
    leaf$=queue_leafname$
    s$=FNtask_read_env("Printer$Temp",buff1%)
    IF s$="" i%=task_buff%+44: CALL Z%,i%,s$  
  ELSE
     
    i%=task_buff%+44: CALL Z%,i%,s$  
    i%=LEN s$: WHILE MID$(s$,i%,1)<>".": i%-=1: ENDWHILE
    leaf$=MID$(s$,i%+1)
    i%=1: WHILE MID$(s$,i%,1)<>".": i%+=1: ENDWHILE
    sender$=LEFT$(s$,i%-1)
  ENDIF
  PROCadd_queue_entry(A%! 36 ,sender$,s$,leaf$,      prnt%,type%)

ENDPROC

DEF PROCcancel_menued_item
    
  CASE menu_chsn$ OF
    WHEN "MQ1"
      IF menued_prnt% THEN
         
        IF menued_queu%           menued_queu%? 11 =              menued_queu%? 11  AND NOT 8         ELSE           menued_prnt%! 24 =              menued_prnt%! 24  AND NOT  16 





        PROCredraw_queue_entry(-1,menued_prnt%,menued_queu%)
        menued_y%=0
        menued_prnt%=0
        menued_queu%=0
      ENDIF
    WHEN "MC1", "MC1s"
      SYS "Wimp_WhichIcon",prntctrl%,buff1%,1<<21,1<<21
      IF NOT !buff1% AND buff1%!4=-1 AND select_all%= 0  PROCicon_deselect(prntctrl%,!buff1%)
  ENDCASE
  menu_chsn$=""
ENDPROC

DEF PROCack
  LOCAL s$,prnt%,queu%,cnct%,spooling%,spool_file$,psup%,ptmp$,t%,load%,    size%,from%,leaf$


  LOCAL qname$, prnt%, found%, sname$, name$, application$

    
  CASE task_buff%!16 OF
    WHEN 11  
      claim_state%=1
    WHEN &80140  
       





        
      PROCmatch_icon(task_buff%!24,prnt%)
      IF prnt%=0           ERROR  254 ,FNmsg_0(A%! 12 ,"OKW")


      queu%=prnt%! 32 
      psup%=prnt%! 4 
      cnct%=prnt%! 12 

       
      IF queu%=0 AND(prnt%! 24  AND  36 )=0 THEN
         

          

        i%=task_buff%+44: CALL Z%,i%,leaf$

         



        CASE cnct%! 0  OF
         WHEN 5
          spooling%=(cnct%? 6  AND 2)<>0
         WHEN 9
          spooling% =  0 
         OTHERWISE
          spooling%=(cnct%? 6  AND 1)<>0
        ENDCASE







        IF spooling% THEN
          printer_output$=FNtemporary_name( -1 )
          IFcnct%! 0 =5 THEN
             
           SYS "OS_SetVarVal","PrinterType$5",printer_output$,LEN printer_output$
           PROCfx5(5)
          ELSE
             
           SYS "OS_SetVarVal","PrinterType$10",printer_output$,LEN printer_output$
           PROCfx5(10)
          ENDIF
            
          spool_file$=printer_output$
        ENDIF

         
        ptmp$=FNtemporary_name( -1 )
          
        SYS "OS_SetVarVal","Printer$Temp",ptmp$,LEN ptmp$

        task_buff%!0=20
         
        task_buff%!16=&80145  
        SYS "Wimp_SendMessage",18,task_buff%,queue_temphand%
          
        type_state%=0
        REPEAT
          PROCdespatch_poll(message_mask%)
        UNTIL type_state%

        b%=(type_state%=2)
        from%=task_buff%!4
           




        IF spooling% THEN
            
          s$=FNselect_connection(prnt%, -1 )
          IF s$<>"" THEN
            PROCerror_warning(s$)
            IF prnt%! 32  THEN
              prnt%! 24  = prnt%! 24  OR  4 
              PROCprinter_status(prnt%)
              PROCredraw_queue_entry(-1,prnt%,0)
            ENDIF
          ENDIF
        ENDIF

          


        IF b% THEN
            

          SYS "OS_File",17,ptmp$ TO t%,,load%,,size%  
          IF t% THEN
              
 
             












             
            s$=ptmp$
            SYS "OS_File",23,ptmp$ TO,,,,,,type%  
          ELSE
              
            IF spooling% THEN
               
              IF cnct%! 0 =5 THEN
                 

                PROCappend_file($cnct%! 16 ,spool_file$)
                  
                ENDPROC
              ELSE
                 


                  
                s$=spool_file$
                type%=psup%! 28 
              ENDIF
            ELSE
                

              IF cnct%! 0  = 9 AND printer_prefix$<>"" THEN
                  
                name$ = $(prnt%! 40 )
                ptr% = INSTR(name$, " ")
                WHILE ptr%
                  MID$(name$,ptr%,1) = CHR$160
                  ptr% = INSTR(name$, " ", ptr%+1)
                ENDWHILE
                sname$ = printer_prefix$+"RemSpool."+unique_string$+"."+name$
                qname$ = printer_prefix$+"RemQueue."+unique_string$+"."+STR$(remote_jobno%)

                SYS"XOS_File",17,sname$ TO t%,,,,l%;f%
                 
                IF (l% > 0) AND ((f% AND 1) = 0) AND (t% = 1) THEN
                  SYS "TaskManager_TaskNameFromHandle",queue_temphand% TO i%
                  CALL Z%,i%,application$
                  IF FNwrite_information_file (prnt%, application$, leaf$) THEN
                      
                    lpsup% = selected_prnt%! 4 
                     
                    SYS "XOS_FSControl", 25, sname$, qname$
                  ELSE
                      
                    SYS "XOS_File", 6, sname$
                  ENDIF
                ENDIF
              ENDIF

              PROCselect_printer(selected_prnt%, 0 , -1 )
                
              ENDPROC
            ENDIF
          ENDIF

          SYS "TaskManager_TaskNameFromHandle",from% TO sender$

           

          i%=LEN leaf$
          WHILE i%>0
            IF MID$(leaf$,i%,1)="." OR MID$(leaf$,i%,1)=":" THEN
              leaf$=MID$(leaf$,i%+1)
              i%=0
            ENDIF
            i%-=1
          ENDWHILE

            
          PROCadd_queue_entry( -1 ,sender$,s$,leaf$,prnt%,type%)
            
          ENDPROC
           
        ENDIF
         
      ENDIF

       



      PROCselect_printer(prnt%, 0 , -1 )
        
       
      SYS "OS_SetVarVal","Printer$Temp",,-1
        
      s$=FNtemporary_name( -1 )
        
      task_buff%!0=48+LEN s$ AND NOT 3
       
      task_buff%!16=2  
      task_buff%!36=-1  
      $(task_buff%+44)=s$+CHR$ 0
      SYS "Wimp_SendMessage",17,task_buff%,queue_temphand%
        
       
      queue_tempref%=task_buff%!8
    WHEN &80145  
      type_state%=1
    OTHERWISE
      PROCbroadcast_reason_code(selected_prnt%,19,task_buff%)
  ENDCASE
    
ENDPROC

DEF PROChost_shutdown
  LOCAL psup%

  LOCAL prnt%, name$, type%, name$, ip%, f%, cnct%

    

   
  PROCtell_the_world



  IF selected_prnt% THEN

    name$ = $selected_prnt%! 40 
    cnct% = selected_prnt%! 12 
    psup% = selected_prnt%! 4 
    type% = psup%! 28 

    IF cnct%! 0  = 9 THEN
      SYS "XFreeway_Read", 0,  2 , name$, 0, 0 TO ,,,,,ip% ; f%
 
      IF (ip% > 0) AND ((f% AND 0) = 0) THEN
        SYS "XRemotePrinterSupport_Enable", 0, ip%, name$, type%
      ENDIF

    ENDIF

  ENDIF
      
   



  IF sparrow_present% THEN
    prnt% = A%! 48 

    WHILE prnt%
      IF (prnt%! 24 ) AND  (1<<16)  THEN
        IF (prnt%! 40  = 0) THEN
          psup% = prnt%! 4 
          name$ = $psup%! 4 
        ELSE
          name$ = $prnt%! 40 
        ENDIF
        PROCunshare_one_printer (prnt%)
      ENDIF
      prnt% = prnt%! 0 
    ENDWHILE
 




  ENDIF


   










  SYS "XOS_CLI","%Wipe <Wimp$ScrapDir>.Printers.* RF~C~V"


   
  psup%=psup_head%
  WHILE psup%
    PROCmsg_end(psup%! 16 )
    psup%=psup%! 0 
  ENDWHILE
  PROCmsg_end(A%! 12 )

   

  PROCbroadcast_reason_code(0,-2,0)
  PROCtask_shutdown
ENDPROC

DEF PROCkeypress
  LOCAL psup%,prnt%,wind%,old_name$,new_name$,old_selected_prnt%
    
  IF NOT FNone_of_ours(!task_buff%) THEN
      
    PROCprinter_find_handle(!task_buff%,wind%,psup%,prnt%)
     


    IF prnt%! 40  old_name$=$prnt%! 40  ELSE old_name$=""
    old_selected_prnt%=selected_prnt%
    PROCprinter_reason_code(psup%,prnt%,8,task_buff%)
    IF $(wind%+ 16 )="configure" THEN
      IF prnt%! 40  new_name$=$prnt%! 40  ELSE new_name$=""
      IF new_name$<>old_name$ THEN

       IF NOT (prnt%! 24  AND  (1<<16) ) THEN
         

        PROCredraw_prntctrl_entry(prnt%)
        PROCprinter_status(prnt%)
        PROCredraw_queue_entry(-1,prnt%,0)
         



        IF(psup%! 24  AND  4 )=0           IF FNwindow_open(connections%)             PROCopen_connections_window(prnt%)



       ELSE
        PROCerror_warning (FNmsg_0(A%! 12 ,"OKAP"))
        new_name$ = old_name$
        PROCfree ( &47525453 , prnt%! 40 )
        PROCstrcpy (prnt%! 40 , old_name$)
       ENDIF

      ENDIF
      IF prnt%! 20 <>-1 AND old_selected_prnt%<>selected_prnt% THEN
         
        PROCselect_printer(old_selected_prnt%, -1 , 0 )
      ENDIF
    ENDIF
  ELSE
    IF task_buff%!24=13 THEN
      CASE !task_buff% OF
        WHEN connections%
          PROCsave_connection
          IF menu_chsn$="ME6" SYS "Wimp_CreateMenu",,-1
          !task_buff%=connections%
          PROCclose_window
        WHEN papersize%
          PROCsave_papersize
          !task_buff%=papersize%
          PROCclose_window
        WHEN save_wind%
          SYS "Wimp_CreateMenu",,-1
           
          PROCicon_write(connections%, 30 ,              FNcanonicalise(FNicon_read(save_wind%, 1 )))

      ENDCASE
    ELSE
      SYS "Wimp_ProcessKey",task_buff%!24
    ENDIF
  ENDIF
ENDPROC

DEF PROCunset_selection(window%)
  LOCAL i%
    
  !win_buff%=window%
  SYS "Wimp_GetWindowInfo",,win_buff% OR 1
  i%=win_buff%!88
  WHILE i%
    PROCicon_deselect(window%,i%-1)
    i%-=1
  ENDWHILE
ENDPROC

DEF PROCmouseclick
  LOCAL prnt%,icon%,queu%,tpub%,psup%,wind%,new_name$,old_name$,B%,C%,old_selected_prnt%

  LOCAL rmtp%

    
  IF FNone_of_ours(task_buff%!12)= 0  THEN
      
    PROCprinter_find_handle(task_buff%!12,wind%,psup%,prnt%)
     


    IF prnt%! 40  old_name$=$prnt%! 40  ELSE old_name$=""
    old_selected_prnt%=selected_prnt%
    PROCprinter_reason_code(wind%! 8 ,wind%! 12 ,6,task_buff%)
    IF $(wind%+ 16 )="configure" THEN
      IF prnt%! 40  new_name$=$prnt%! 40  ELSE new_name$=""
      IF new_name$<>old_name$ THEN

       IF NOT (prnt%! 24  AND  (1<<16) ) THEN
         

        PROCredraw_prntctrl_entry(prnt%)
        PROCprinter_status(prnt%)
        PROCredraw_queue_entry(-1,prnt%,0)
         



        IF(psup%! 24  AND  4 )=0           IF FNwindow_open(connections%)             PROCopen_connections_window(prnt%)



       ELSE
        PROCerror_warning (FNmsg_0(A%! 12 ,"OKAP"))
        new_name$ = old_name$
        PROCfree ( &47525453 , prnt%! 40 )
        PROCstrcpy (prnt%! 40 , old_name$)
       ENDIF

      ENDIF
      IF prnt%! 20 <>-1 AND old_selected_prnt%<>selected_prnt% THEN
         
        PROCselect_printer(old_selected_prnt%, -1 , 0 )
      ENDIF
    ENDIF
  ELSE
    CASE task_buff%!8 OF
      WHEN 1024  
        CASE task_buff%!12 OF
          WHEN prntctrl%
            IF NOT task_buff%!16 THEN
              IF NOT FNicon_set(task_buff%!12,task_buff%!16)THEN
                PROCunset_selection(task_buff%!12)
                PROCicon_select(task_buff%!12,task_buff%!16)
              ENDIF
            ELSE
              PROCunset_selection(task_buff%!12)
            ENDIF
        ENDCASE
      WHEN 256  
        CASE task_buff%!12 OF
          WHEN prntctrl%
            IF NOT task_buff%!16 THEN
              IF FNicon_set(task_buff%!12,task_buff%!16)THEN
                PROCicon_deselect(task_buff%!12,task_buff%!16)
              ELSE
                PROCicon_select(task_buff%!12,task_buff%!16)
              ENDIF
            ENDIF
        ENDCASE
      WHEN 64  
        IF task_buff%!12=save_wind%           PROCsave_dragicon(!task_buff%,task_buff%!4)

      WHEN 2  
        CASE task_buff%!12 OF
          WHEN -2
            PROCmenu("ME1", -1 , 0 )
          WHEN A%! 40 
            PROCmenu("MQ1", -1 , 0 )
          WHEN prntctrl%

            PROCmenu("MC1s", -1 , 0 )



          WHEN connections%
            CASE task_buff%!16 OF
              WHEN  8 
                PROCmenu("ME2", -1 , -1 )
              WHEN  11 
                PROCmenu("ME3", -1 , -1 )
              WHEN  14 
                PROCmenu("ME4", -1 , -1 )
              WHEN  16 
                PROCmenu("ME5", -1 , -1 )
              WHEN  20 
                PROCmenu("ME6", -1 , -1 )
              WHEN  32 
                PROCmenu("SVE", -1 , -1 )
            ENDCASE
          WHEN papersize%
            IF task_buff%!16= 47  PROCmenu("MP1", -1 , -1 )
        ENDCASE
      WHEN 4  
        CASE task_buff%!12 OF
          WHEN -2
            PROCprinter_selection
          WHEN query%
            query_state%=task_buff%!16
          WHEN howquery%
            query_state%=task_buff%!16
          WHEN save_wind%
            IF task_buff%!16= 2  THEN
              SYS "Wimp_CreateMenu",,-1
               
              PROCicon_write(connections%, 30 ,                  FNcanonicalise(FNicon_read(save_wind%, 1 )))

            ENDIF
          WHEN shutdown%
            SYS "Wimp_CreateMenu",,-1
            IF task_buff%!16= 3  THEN
              !task_buff%=A%! 40 
              PROCclose_window
              PROCdestroy_queue
              CASE shutdown_type% OF
                WHEN 1  
                  SYS "Wimp_ProcessKey",&1FC
                WHEN 2  
                  PROChost_shutdown
              ENDCASE
            ELSE
               
              A%! 20 =                  A%! 20  AND NOT 1

            ENDIF
          WHEN prntctrl%
            IF NOT task_buff%!16 THEN
               
              IFNOTFNicon_set(task_buff%!12,task_buff%!16) THEN
                PROCunset_selection(task_buff%!12)
                PROCicon_select(task_buff%!12,task_buff%!16)
              ENDIF

              PROCfind_prnt(prnt%,rmtp%,icon%)
              IF prnt% THEN
                PROCprinter_reason_code(prnt%! 4 ,prnt%,-3,0)
                PROCprinter_open_window(prnt%,"configure")
              ENDIF
               









            ENDIF
          WHEN connections%
            CASE task_buff%!16 OF
              WHEN  0 , 1 , 2 ,                   3 , 4 , 33 

                PROCcheck_shaded_connections
              WHEN  5 
                PROCsave_connection
                !task_buff%=connections%
                PROCclose_window
              WHEN  8 
                PROCmenu("ME2", -1 , -1 )
              WHEN  11 
                PROCmenu("ME3", -1 , -1 )
              WHEN  14 
                PROCmenu("ME4", -1 , -1 )
              WHEN  16 
                PROCmenu("ME5", -1 , -1 )
              WHEN  20 
                PROCmenu("ME6", -1 , -1 )
              WHEN  32 
                PROCmenu("SVE", -1 , -1 )
              WHEN  38 
                !task_buff%=connections%
                PROCclose_window
            ENDCASE
          WHEN papersize%
            CASE task_buff%!16 OF
              WHEN  42 
                PROCsave_papersize
                !task_buff%=papersize%
                PROCclose_window
              WHEN  33 
                PROCdelete_papersize
                !task_buff%=papersize%
                PROCclose_window
              WHEN  48 
                B%= &455A5350 
                C%=psize_edit%
                CALL code_entry%+ 16 
                psize_edit%=0
                !task_buff%=papersize%
                PROCclose_window
              WHEN  23 , 22 
                PROCicon_select(papersize%,task_buff%!16)
                PROCreview_papersize_units
              WHEN  47 
                PROCmenu("MP1", -1 , -1 )
            ENDCASE
          OTHERWISE
             
            prnt%=A%! 48 
            WHILE prnt%
              IF prnt%! 48 =task_buff%!12 THEN
                 
                queu%=prnt%! 32 
                tpub%=queu%! 44 
                IF tpub% THEN
                  IF tpub%! 40  THEN
                    IF  task_buff%!16=4 THEN
                      PROCdelete_queue_entry(prnt%,queu%, -1 )
                    ELSE
                      prnt%! 24 =prnt%! 24  AND NOT  36 
                      tpub%! 40 =0
                      PROCprinter_status(prnt%)  
                      PROCredraw_queue_entry(-1,prnt%,0)  
                      !task_buff%=prnt%! 48 
                      PROCclose_window
                    ENDIF
                  ENDIF
                ENDIF
                prnt%=0
              ELSE
                prnt%=prnt%! 0 
              ENDIF
            ENDWHILE
        ENDCASE
      WHEN 1  
        CASE task_buff%!12 OF
          WHEN -2
            PROCprinter_selection
          WHEN connections%
            CASE task_buff%!16 OF
              WHEN  0 , 1 , 2 ,                   3 , 4 , 33 

                PROCcheck_shaded_connections
              WHEN  5 
                PROCsave_connection
            ENDCASE
          WHEN papersize%
            CASE task_buff%!16 OF
              WHEN  42 
                PROCsave_papersize
              WHEN  33 
                PROCdelete_papersize
              WHEN  23 , 22 
                PROCicon_select(papersize%,task_buff%!16)
                PROCreview_papersize_units
            ENDCASE
        ENDCASE
    ENDCASE
  ENDIF
ENDPROC

DEF PROCcheck_shaded_connections
  LOCAL c%,h%,i%,n%
    
  c%=-1
  IF FNicon_set(connections%, 1 )THEN
   PROCicon_unshade(connections%, 15 )
   PROCicon_unshade(connections%, 8 )
   PROCicon_unshade(connections%, 17 )
   PROCicon_unshade(connections%, 11 )
   PROCicon_unshade(connections%, 18 )
   PROCicon_unshade(connections%, 14 )
   PROCicon_unshade(connections%, 19 )
   PROCicon_unshade(connections%, 16 )
   PROCicon_unshade(connections%, 13 )
  ELSE
   PROCicon_shade(connections%, 15 )
   PROCicon_shade(connections%, 8 )
   PROCicon_shade(connections%, 17 )
   PROCicon_shade(connections%, 11 )
   PROCicon_shade(connections%, 18 )
   PROCicon_shade(connections%, 14 )
   PROCicon_shade(connections%, 19 )
   PROCicon_shade(connections%, 16 )
   PROCicon_shade(connections%, 13 )
  ENDIF
  IF FNicon_set(connections%, 2 )THEN
   PROCicon_unshade(connections%, 25 )
   PROCicon_unshade(connections%, 20 )
   c%= 25 
  ELSE
   PROCicon_shade(connections%, 25 )
   PROCicon_shade(connections%, 20 )
  ENDIF
  IF FNicon_set(connections%, 3 )THEN
   PROCicon_unshade(connections%, 26 )
   PROCicon_unshade(connections%, 27 )
   PROCicon_unshade(connections%, 28 )
   PROCicon_unshade(connections%, 29 )
   c%= 26 
  ELSE
   PROCicon_shade(connections%, 26 )
   PROCicon_shade(connections%, 27 )
   PROCicon_shade(connections%, 28 )
   PROCicon_shade(connections%, 29 )
  ENDIF
  IF FNicon_set(connections%, 4 )THEN
   PROCicon_unshade(connections%, 30 )
   PROCicon_unshade(connections%, 32 )
   PROCicon_unshade(connections%, 35 )
   c%= 30 
  ELSE
   PROCicon_shade(connections%, 30 )
   PROCicon_shade(connections%, 32 )
   PROCicon_shade(connections%, 35 )
  ENDIF
  IF c%=-1 THEN
   PROCcaret_info(h%,i%,n%)
   IF h%=connections% SYS "Wimp_SetCaretPosition",-1
  ELSE
   PROCcaret_set(connections%,c%)
  ENDIF
ENDPROC

DEF PROCmatch_icon(handle%,RETURN prnt%)
   
    
  prnt%=A%! 48 
  WHILE prnt%
   IF prnt%! 20 =handle% ENDPROC
   prnt%=prnt%! 0 
  ENDWHILE
ENDPROC

DEF PROCprinter_selection
  LOCAL prnt%,adjust%,shift%
    
  shift%=INKEY -1
  adjust%=(task_buff%!8=1)
  PROCmatch_icon(task_buff%!16,prnt%)
  IF prnt% THEN
    
   IF adjust% THEN
    IF shift% PROCopen_connections_window(prnt%)ELSE PROCopen_queue_window
   ELSE
    IF shift% THEN
       
     PROCprinter_reason_code(prnt%! 4 ,prnt%,-3,0)
     PROCprinter_open_window(prnt%,"configure")
    ELSE
       
     PROCselect_printer(prnt%, -1 , 0 )
     IF FNwindow_open(prntctrl%)PROCselect_printer_control(prnt%)
    ENDIF
   ENDIF
   ENDPROC
  ENDIF
   
  PROCprinter_control(prnt%)
ENDPROC

DEF PROCselect_printer(prnt%,permanent%,restore%)
   

  LOCAL old_prnt%,i%,s$
    

   
  old_prnt%=selected_prnt%
  IF NOT restore% selected_prnt%=prnt%  
  IF selected_prnt%=0 ENDPROC  

   
  s$=FNselect_connection(selected_prnt%, 0 )
  IF s$<>"" THEN
     

    IF permanent% THEN
     selected_prnt%! 24  = selected_prnt%! 24  AND NOT  2 
    ENDIF
    IF selected_prnt%! 32  THEN
      selected_prnt%! 24  = selected_prnt%! 24  OR  4 
      PROCprinter_status(selected_prnt%)
      PROCredraw_queue_entry(-1,selected_prnt%,0)
    ENDIF
    IF selected_prnt%=old_prnt% THEN
       
      PROCicon_deselect(-1,old_prnt%! 20 )
       
      SYS"PDriver_SelectDriver",-1
      old_prnt%=0
    ENDIF
    selected_prnt%=old_prnt%
     
    PROCerror_warning(s$)
    ENDPROC
  ENDIF
  PROCprinter_reason_code(selected_prnt%! 4 ,selected_prnt%,-6,0)
  PROCset_page_size(selected_prnt%)
  PROCtell_the_world

  IF permanent% THEN
      
    IF old_prnt% THEN
      PROCicon_deselect(-1,old_prnt%! 20 )
      old_prnt%! 24 =old_prnt%! 24  AND NOT  2 
    ENDIF
      
    selected_prnt%! 24 =selected_prnt%! 24  OR  2 
    PROCicon_select(-1,selected_prnt%! 20 )
     
    SYS "PDriver_Info" TO,,,,i%
    IF ?i%       CALL Z%,i%,s$:         SYS "OS_SetVarVal","Printer$",i%,LEN s$


  ELSE
      
    selected_prnt%=old_prnt%
  ENDIF
    
ENDPROC

DEF PROCset_page_size(prnt%)
  LOCAL psize%
    
  psize%=prnt%! 36 
  SYS "PDriver_SetPageSize",,psize%! 8 ,psize%! 12 ,psize%! 24 ,psize%! 16 ,psize%! 28 ,psize%! 20 
    
ENDPROC

DEF PROCtell_the_world
   
    
  !msg_text%=20
  msg_text%!12=0
  msg_text%!16=&80147  
  SYS "Wimp_SendMessage",17,msg_text%
    
    
ENDPROC

DEF FNdevice_claim(dev%,prnt%)
  LOCAL claim$,r%,s$,i%
    
  claim$=FNmsg_0(A%! 12 ,"CLM")
  !task_buff%=32+LEN claim$ AND NOT 3
  task_buff%!12=0
  task_buff%!16=11  
  task_buff%!20=dev%
  task_buff%!24=0
  $(task_buff%+28)=claim$+CHR$ 0
  SYS "Wimp_SendMessage",18,task_buff%
    
  claim_state%=0
  claim_ref%=prnt%
  REPEAT
      
    PROCdespatch_poll(message_mask%)
  UNTIL claim_state%
    
  claim_ref%=0
  IF claim_state%=2 i%=task_buff%+28: CALL Z%,i%,s$: =s$  
=""

DEF FNselect_connection(prnt%,reselection%)
  LOCAL cnct%,claim$,psup%,r0%,f%,s$,buf%

  LOCAL dir$, r0%, flags%, ip%, name$, ptr%

    

   



  FORr0%=0 TO 255
    evaluation_buff%?r0%=task_buff%?r0%
  NEXT

  psup%=prnt%! 4 
  cnct%=prnt%! 12 
  printer_output$=      FNtask_read_env("PrinterType$"+STR$ cnct%! 0 ,msg_text%)


   
  SYS "OS_Byte",&CC,old_ignore_state%

  SYS "XRemotePrinterSupport_Disable"

  CASE cnct%! 0  OF
    WHEN 1  
      IF NOT reselection% THEN
        claim$=FNdevice_claim(1,prnt%)
        IF claim$<>"" THEN =FNmsg_1(A%! 12 ,"OKI",claim$)
      ENDIF
      buf%=FNbuffer(1)
      IF buf%=0 buf%=3
      IF prnt%! 24  AND  128  THEN
        printer_output$="devices#buffer"+STR$buf%+":$."+FNsupport_fast_parallel
      ELSE
        printer_output$="devices#buffer"+STR$ buf%+":$.Parallel"
      ENDIF
    WHEN 2  
      IF NOT reselection% THEN
        claim$=FNdevice_claim(2,prnt%)
        IF claim$<>"" THEN =FNmsg_1(A%! 12 ,"OKJ",claim$)
      ENDIF
      SYS "OS_SerialOp",5,cnct%? 4 
      SYS "OS_SerialOp",6,cnct%? 4 
      SYS "OS_SerialOp",1,cnct%! 8 
      SYS "OS_SerialOp",0,cnct%? 5 ,NOT 1
      SYS "OS_Byte",&CC,1 TO,old_ignore_state%  
      buf%=FNbuffer(2)
      IF buf%=0 buf%=3
      printer_output$="devices#buffer"+STR$ buf%+":$.Serial"
    WHEN 4  
      IF $cnct%! 12 ="" THEN =FNmsg_0(A%! 12 ,"OKAG")
      printer_output$="NetPrint#"+$cnct%! 12 +":"
      SYS "Hourglass_On"
      SYS "NetPrint_SetPSName",$cnct%! 12 
      SYS "Hourglass_Off"
    WHEN 5  
       
      printer_output$="null:"
      IF cnct%! 16  <> 0 THEN
        IF ?(cnct%! 16 ) > 32 AND ?(cnct%! 16 ) < 127            printer_output$=$cnct%! 16 

      ENDIF
      SYS "XOS_File",17,printer_output$ TO r0%;f%  
      IF f% AND 1 r0%=0
      IF r0% THEN
         
        SYS"XOS_Find",&43,printer_output$ TO r0%;f%
        IF (f%AND1)=0 CLOSE#r0%:SYS "XOS_File",18,printer_output$,psup%! 28   
      ELSE
        SYS "XOS_File",11,printer_output$,psup%! 28  TO r0%;f%  
         
        IF (f%AND1) THEN
          r0%+=4
          CALL Z%,r0%,s$
          =s$
        ENDIF
      ENDIF
    WHEN 6  
      s$=FNselect_nfs(cnct%,printer_output$)
      IF s$<>"" THEN =s$
    WHEN 8  
      SYS"XOS_ReadVarVal","PrinterType$8",buff1%,256,,3 TO ,,f%
      buff1%?f%=13:printer_output$=$buff1%
      IFprinter_output$="" printer_output$="null:"

    WHEN 9  
     IF sparrow_present% THEN
      name$ = $prnt%! 40 

      SYS "XFreeway_Read", 0,  2 , name$, 0, 0 TO r0%,,,dlen%,,ip% ; flags%
      IF (flags% AND 1) THEN
        =FNmsg_1 (A%! 12 , "OKAR", name$)
      ENDIF

      SYS "XRemotePrinterSupport_Enable", 1, ip%, name$ TO r0% ; flags%
      IF (flags% AND 1) THEN
        =FNmsg_1 (A%! 12 , "OKAR", name$)
      ENDIF

      printer_prefix$ = "Share::_S"+FNip_string(ip%)+"."

      dir$ = "Share::_S"+FNip_string(ip%)+".RemSpool."+unique_string$
      SYS "RemotePrinterSupport_DisableUpcalls"
      SYS "XOS_File", 8, dir$,,,0 TO r0% ; flags%
      SYS "RemotePrinterSupport_EnableUpcalls"
      IF (flags% AND 1) THEN
        =FNmsg_1 (A%! 12 , "OKAR", name$)
      ENDIF

      dir$ = "Share::_S"+FNip_string(ip%)+".RemQueue."+unique_string$
      SYS "RemotePrinterSupport_DisableUpcalls"
      SYS "XOS_File", 8, dir$,,,0 TO r0% ; flags%
      SYS "RemotePrinterSupport_EnableUpcalls"
      IF (flags% AND 1) THEN
        =FNmsg_1 (A%! 12 , "OKAR", name$)
      ENDIF

      s$ = FNset_jobno
      IF s$ <> "" THEN
        =FNmsg_1 (A%! 12 , "OKAR", name$)
      ENDIF

      ptr% = INSTR(name$, " ")  
      WHILE ptr%
        MID$(name$,ptr%,1) = CHR$160
        ptr% = INSTR(name$, " ", ptr%+1)
      ENDWHILE

      printer_output$ = "Share::_S"+FNip_string(ip%)+".RemSpool."+unique_string$+"."+name$

       
       
      SYS "RemotePrinterSupport_DisableUpcalls"
      SYS "XOS_File",17,printer_output$ TO r0%;f%  
      IF f% AND 1 r0%=0
      IF r0% THEN
         
        SYS"XOS_Find",&43,printer_output$ TO r0%;f%
        IF (f%AND1)=0 CLOSE#r0%:SYS "XOS_File",18,printer_output$,psup%! 28   
        SYS "RemotePrinterSupport_EnableUpcalls"
      ELSE
        SYS "XOS_File",11,printer_output$,psup%! 28  TO r0%;f%  
        SYS "RemotePrinterSupport_EnableUpcalls"
         
        IF (f%AND1) THEN
          =FNmsg_1 (A%! 12 , "OKAR", name$)
        ENDIF
      ENDIF
     ELSE
      =FNmsg_1 (A%! 12 , "OKAR", name$)
     ENDIF
  

  ENDCASE

  SYS "OS_SetVarVal","PrinterType$"+STR$ cnct%! 0 ,printer_output$,LEN printer_output$
  PROCfx5(cnct%! 0 )

   
  FORr0%=0 TO 255
    task_buff%?r0%=evaluation_buff%?r0%
  NEXT
=""

DEF PROCflush(buf%)
    
  IF buf% SYS "OS_Byte",21,buf%
ENDPROC

DEF PROCfx5(new_fx5%)
  LOCAL x%
  LOCAL ERROR

  


    ON ERROR LOCAL RESTORE ERROR: PROCesc_off: PROCflush(FNbuffer(x%)): SYS "OS_Byte",5,new_fx5%: ENDPROC
  

    
  SYS "OS_Byte",245,,255 TO,x%
  IF x%<>new_fx5% THEN
    PROCesc_on
    SYS "OS_Byte",5,new_fx5%
    PROCesc_off
  ENDIF
ENDPROC

DEF PROCesc_on
    
  SYS "OS_Byte",229
ENDPROC

DEF PROCesc_off
    
  SYS "OS_Byte",229,1
ENDPROC

DEF FNselect_nfs(cnct%,RETURN a$)
  LOCAL c%,f%,s$
    
   
  IF NOT FNnfs_installed THEN =FNmsg_0(A%! 12 ,"OKL")
  IF cnct%! 20 =0 THEN =FNmsg_0(A%! 12 ,"OKK")
  a$="NFS#Printer::"+$cnct%! 20 
  IF cnct%! 24 =0 a$+=".lp" ELSE a$+="."+$cnct%! 24 
  IF cnct%! 28 =0 a$+=".nobody" ELSE a$+="."+$cnct%! 28 
  IF cnct%! 32  a$+="."+$cnct%! 32 
  SYS "XOS_Find",&8F,a$ TO c%;f%
  IF f% AND 1 THEN
    CASE !c% OF
      WHEN 204
        =FNmsg_0(A%! 12 ,"OKM")
      OTHERWISE
        f%=c%+4
        CALL Z%,f%,s$  
        =s$+" ("+STR$ !c%+")"
    ENDCASE
  ENDIF
  SYS "XOS_Find",,c%
=""

DEF PROCmenu(top$,rebuild%,iconpos%)
  LOCAL y%,i%,ix%,iy%,indirected_title%

  LOCAL prnt%, rmtp%, icon%

    
  IF rebuild% THEN
    menu_xpos%=task_buff%!0-64
    menu_ypos%=task_buff%!4
  ENDIF
  IF iconpos% THEN
    !buff1%=task_buff%!12
    buff1%!4=task_buff%!16
    SYS "Wimp_GetIconState",,buff1%
    ix%=buff1%!16
    iy%=buff1%!20
    SYS "Wimp_GetWindowState",,buff1%
    menu_xpos%=buff1%!20+buff1%!4+ix%+2
    menu_ypos%=buff1%!24+buff1%!16+iy%-2
  ENDIF
  IF top$="SVE" THEN
    PROCsave_setup(psup_edit%! 28 ,FNmsg_0(A%! 12 ,"OP"))
    SYS "Wimp_CreateMenu",,save_wind%,menu_xpos%,menu_ypos%
  ELSE
    CASE top$ OF
      WHEN "ME1"
        PROCmenu_create(menu%,FNmsg_0(A%! 12 ,"ME1"))
        PROCmenu_attach(menu%, 0 ,info%, 0 )




        PROCmenu_shade(menu%, 2 ,A%! 44 =0)
        menu_ypos%=96+( 5 +1)*line_space%
        IF got_icon%           menued_prnt%=0         ELSE           PROCmatch_icon(task_buff%!16,menued_prnt%)



      WHEN "ME2"
        IFFNsupport_higher_baudrates THEN
          PROCmenu_create(menu%,FNmsg_0(A%! 12 ,"ME2")+FNmsg_0(A%! 12 ,"ME2a")+FNmsg_0(A%! 12 ,"ME2b"))
        ELSE
          PROCmenu_create(menu%,FNmsg_0(A%! 12 ,"ME2")+FNmsg_0(A%! 12 ,"ME2b"))
        ENDIF
        PROCmenu_tick_match(menu%,FNicon_read(connections%, 15 ))
      WHEN "ME3"
        PROCmenu_create(menu%,FNmsg_0(A%! 12 ,"ME3"))
        PROCmenu_tick_match(menu%,FNicon_read(connections%, 17 ))
      WHEN "ME4"
        PROCmenu_create(menu%,FNmsg_0(A%! 12 ,"ME4"))
        PROCmenu_tick_match(menu%,FNicon_read(connections%, 18 ))
      WHEN "ME5"
        PROCmenu_create(menu%,FNmsg_0(A%! 12 ,"ME5"))
        indirected_title%=(menu%!28 AND &100)<>0
        IF NOT(FNnew_databits=0 AND FNnew_parity<>0)THEN
          IF FNnew_databits=3 AND FNnew_parity=0 THEN
            PROCmenu_item(menu%,1,FNmsg_0(A%! 12 ,"ME5c"),indirected_title%)
          ELSE
            PROCmenu_item(menu%,1,FNmsg_0(A%! 12 ,"ME5a"),indirected_title%)
          ENDIF
        ENDIF
        PROCmenu_tick_match(menu%,FNicon_read(connections%, 19 ))
      WHEN "ME6"
        IF rebuild% PROCbuild_printer_menu
        PROCmenu_tick_match(menu%,            FNicon_read(connections%, 25 ))

      WHEN "MQ1"
        IF rebuild% THEN
          PROCcancel_menued_item
          menued_y%=menu_ypos%
          !task_buff%=A%! 40 
          SYS "Wimp_GetWindowState",,task_buff%
          B%=menued_y%-task_buff%!16+task_buff%!24  
          menued_y%=USR(code_entry%+ 44 )
          i%=A%! 16 
          menued_prnt%=!i%
          menued_queu%=i%!4
           


          IF menued_queu%=-1 menued_queu%=0

          IF menued_queu%=0 THEN
            PROCmenu_create(menu%,FNmsg_1(A%! 12 ,                "MQ1",FNmsg_0(A%! 12 ,"MQ1a")))

             
            IF menued_prnt% menued_prnt%! 24 =                menued_prnt%! 24  OR  16 

          ELSE
            IF menued_queu%! 12  THEN
              PROCmenu_create(menu%,FNmsg_1(A%! 12 ,                  "MQ1",FNmsg_0(A%! 12 ,"MQ1a")))

            ELSE
              PROCmenu_create(menu%,FNmsg_1(A%! 12 ,                  "MQ1",FNmsg_0(A%! 12 ,"MQ1b")))

            ENDIF
            menued_queu%? 11 =                menued_queu%? 11  OR 8  

          ENDIF
          PROCredraw_queue_entry(-1,menued_prnt%,menued_queu%)
        ENDIF
        PROCmenu_shade(menu%,0, 0 )
        PROCmenu_shade(menu%,1, 0 )
        PROCmenu_shade(menu%,2, 0 )
        PROCmenu_shade(menu%,3, 0 )
        PROCmenu_shade(menu%,4, 0 )
        PROCmenu_shade(menu%,5, 0 )
        PROCmenu_shade(menu%,6, 0 )
        IF menued_queu%=0 THEN
          PROCmenu_shade(menu%,4, -1 )
          PROCmenu_shade(menu%,5, -1 )
          PROCmenu_shade(menu%,6, -1 )
        ELSE
          IF menued_queu%? 11  AND 5               PROCmenu_shade(menu%,4, -1 )ELSE PROCmenu_shade(menu%,5, -1 )

        ENDIF
        IF menued_prnt%! 24  AND  36  THEN
          PROCmenu_shade(menu%,0, -1 )
          PROCmenu_shade(menu%,1, -1 )
        ELSE
          PROCmenu_shade(menu%,2, -1 )
        ENDIF
      WHEN "MP1"
        PROCcreate_paper_menu(menu%,papersize%, 5 )
      WHEN "MC1", "MC1s"

        PROCmenu_create(menu%,FNmsg_0(A%! 12 ,"MC1s"))
         


        IF sparrow_present% =  0  THEN
          PROCmenu_shade(menu%, 2,  -1 )
        ENDIF



        SYS "Wimp_WhichIcon",prntctrl%,buff1%,1<<21,1<<21
        IF (!buff1%=-1 OR buff1%!4=-1) AND select_all%= 0  THEN
           
          IF NOT !buff1% PROCicon_deselect(prntctrl%,!buff1%)
           
          IF task_buff%!12=prntctrl% AND task_buff%!16>3 THEN
             
            PROCicon_select(prntctrl%,task_buff%!16)
            i%=1
          ELSE
            i%=0
          ENDIF
        ELSE
          i%=2
        ENDIF
        CASE i% OF
          WHEN 0

             


            PROCmenu_shade(menu%,0, -1 )
            PROCmenu_shade(menu%,1, -1 )
            PROCmenu_shade(menu%,2, -1 )
            PROCmenu_shade(menu%,3, -1 )
            PROCmenu_shade(menu%,4, -1 )
            PROCmenu_shade(menu%,5, -1 )
            PROCmenu_shade(menu%,7, -1 )
            IF A%! 48 =0                 PROCmenu_shade(menu%,6, -1 )












          WHEN 1
             


            PROCfind_prnt (prnt%, rmtp%, icon%)
            IF rmtp% THEN
              PROCmenu_shade (menu%, 0,  -1 )  
              PROCmenu_shade (menu%, 1,  -1 )  
              PROCmenu_shade (menu%, 2,  -1 )  
              IF rmtp%! 20  > 0 THEN  
                PROCmenu_shade (menu%, 3,  -1 )  
              ELSE                                         
                PROCmenu_shade (menu%, 4,  -1 )  
              ENDIF
              PROCmenu_shade (menu%, 5,  -1 )  
            ENDIF
            IF prnt% THEN
              IF prnt%! 24  AND  (1<<17)  THEN
                PROCmenu_shade (menu%, 1,  -1 )  
                PROCmenu_shade (menu%, 2,  -1 )  
                PROCmenu_shade (menu%, 3,  -1 )  
                PROCmenu_shade (menu%, 5,  -1 )  
              ENDIF
            ENDIF
           




          WHEN 2
            PROCmenu_shade(menu%,0, -1 )
            PROCmenu_shade(menu%,1, -1 )
        ENDCASE
    ENDCASE
    menu_chsn$=top$
    PROCdisplay_menu(0,menu%,menu_xpos%,menu_ypos%)
  ENDIF
ENDPROC

DEF PROCcreate_paper_menu(RETURN handle%,window%,icon%)
  LOCAL psize%,i%,indirected_title%
    
  PROCmenu_create(handle%,FNmsg_0(A%! 12 ,"MP1"))
  indirected_title%=(handle%!28 AND &100)<>0
  


  psize%=psize_head%
  i%=0
  WHILE psize%
   PROCmenu_item(handle%,i%,$psize%! 4 ,indirected_title%)
   i%+=1
   psize%=psize%! 0 
  ENDWHILE
  PROCmenu_tick_match(handle%,FNicon_read(window%,icon%))
ENDPROC

DEF PROCdisplay_menu(prnt%,menu%,xp%,yp%)
    
    
  menu_prnt%=prnt%
  SYS "Wimp_CreateMenu",,menu%,xp%,yp%
ENDPROC

DEF FNwas_adjust_used
  SYS "Wimp_GetPointerInfo",,buff1%
=(buff1%!8 AND 1)<>0

DEF PROCmenuaction
  LOCAL adjust%,redraw%,psize%,i%,h%,n%,prnt%,icon%

  LOCAL rmtp%

    
  IF menu_prnt% THEN
    PROCprinter_reason_code(menu_prnt%! 4 ,menu_prnt%,9,task_buff%)
    ENDPROC
  ENDIF
  adjust%=FNwas_adjust_used
  CASE menu_chsn$ OF
    WHEN "ME1"
      CASE !task_buff% OF







        WHEN  1 
          PROCprinter_control(menued_prnt%)
        WHEN  2 
          PROCopen_queue_window
        WHEN  3 
          PROCopen_papersize_window(menued_prnt%)
        WHEN  4 
          PROCsave_settings
          PROCsave_prdata
        WHEN  5 
          IF A%! 32  THEN
             
            A%! 20 =A%! 20  OR 1
            shutdown_type%=2
            PROCmenu_window_centre(shutdown%)
          ELSE
            PROChost_shutdown
          ENDIF
      ENDCASE
    WHEN "ME2"
      PROCicon_write(connections%, 15 ,$(!task_buff%*24+40+menu%))
    WHEN "ME3"
      PROCicon_write(connections%, 17 ,$(!task_buff%*24+40+menu%))
      PROCensure_new_stopbits(-1)
    WHEN "ME4"
      PROCicon_write(connections%, 18 ,$(!task_buff%*24+40+menu%))
      PROCensure_new_stopbits(-1)
    WHEN "ME5"
      PROCensure_new_stopbits(!task_buff%)
    WHEN "ME6"
       
      PROCmenu_tick_match(menu%,FNicon_read(connections%, 25 ))
      PROCicon_write(connections%, 25 ,$(!task_buff%*24+40+menu%))
    WHEN "MQ1"
      redraw%= -1 
      CASE !task_buff% OF
        WHEN 0
          menued_prnt%! 24 =menued_prnt%! 24  OR  4 
        WHEN 1
          menued_prnt%! 24 =menued_prnt%! 24  OR  32 
        WHEN 2
          menued_prnt%! 24 =menued_prnt%! 24  AND NOT  36 
           
          i%=menued_prnt%! 32 
          IF i% THEN
             
            i%=i%! 44 
            IF i% THEN
               
              IF i%! 40  THEN
                 
                i%! 40 =0
                IF menued_prnt%! 48  THEN
                  !task_buff%=menued_prnt%! 48 
                  PROCclose_window
                ENDIF
              ENDIF
            ENDIF
          ENDIF
        WHEN 3
          PROCflush_queue(menued_prnt%)
          redraw%= 0 
        WHEN 4
          IF menued_queu%! 12  THEN
            menued_queu%? 11 =menued_queu%? 11  OR 1
          ELSE
            menued_queu%? 11 =menued_queu%? 11  OR 4
          ENDIF
        WHEN 5
          menued_queu%? 11 =menued_queu%? 11  AND NOT 5
        WHEN 6
          PROCdelete_queue_entry(menued_prnt%,menued_queu%, -1 )
          redraw%= 0 
      ENDCASE
      IF redraw% THEN
        PROCprinter_status(menued_prnt%)
        IF !task_buff%<3 THEN
          PROCredraw_queue_entry(-1,menued_prnt%,0)
        ELSE
          PROCredraw_queue_entry(menued_y%,menued_prnt%,menued_queu%)
        ENDIF
      ENDIF
    WHEN "MP1"
      psize%=psize_head%
      i%=!task_buff%
      WHILE i%
        psize%=psize%! 0 
        i%-=1
      ENDWHILE
      FOR i%= 0  TO  52  STEP 4
        psize_edit%!i%=psize%!i%
      NEXT
      PROCinitialise_papersize_window
    WHEN "MC1", "MC1s"
      CASE !task_buff% OF
        WHEN 0
           

          PROCfind_prnt(prnt%,rmtp%,icon%)
          IF prnt% THEN
            PROCprinter_reason_code(prnt%! 4 ,prnt%,-3,0)
            PROCprinter_open_window(prnt%,"configure")
          ENDIF
           








        WHEN 1
           

          PROCfind_prnt(prnt%,rmtp%,icon%)
          IF prnt% THEN
            PROCopen_connections_window(prnt%)
          ENDIF
           









         


        WHEN 2
           
          PROCshare_printer
        WHEN 3
           
          PROCactivate_printer
          PROCcreate_installed_printer_icons
        WHEN 4
           
          PROCdeactivate_printer
          PROCcreate_installed_printer_icons
        WHEN 5
           
          PROCremove_printer
          PROCcreate_installed_printer_icons
        WHEN 6
           
          IF A%! 48  THEN
            IF 0<=printer_count%-1 THEN
              FOR i%=0 TO printer_count%-1
                PROCicon_select(prntctrl%,i%+4)
              NEXT
            ENDIF
          ENDIF
          IF remote_printers% THEN
            IF 0<=remote_printer_count%-1 THEN
              FOR i% = printer_count% TO printer_count%+remote_printer_count%
                PROCicon_select(prntctrl%,i%+4)
              NEXT
            ENDIF
          ENDIF
          select_all%= -1 
        WHEN 7
           
          PROCunset_selection(prntctrl%)
























      ENDCASE
  ENDCASE
  IF adjust% THEN
    SYS "Wimp_GetPointerInfo",,task_buff%
    PROCmenu(menu_chsn$, 0 , 0 )
  ELSE
    PROCcancel_menued_item
  ENDIF
ENDPROC

DEF PROCsave_settings
  LOCAL c%,f%,psup%,prnt%,ptr%,p%,size%,s$,f$

  LOCAL attr%, rmtp%

    
  SYS "Hourglass_On"

  IF multiple_choices% THEN
    f$ =  "<Choices$Write>.Printers" +".Remote.ID"+unique_string$+".Settings1"
  ELSE

  f$ =  "<Choices$Write>.Printers" +".Settings1"

  ENDIF

  SYS "XOS_Find",&8F,f$ TO c%;f%
  IF f% AND 1     f%=c%+4:     CALL Z%,f%,s$:       ERROR  254 ,FNmsg_1(A%! 12 ,"OKB",s$)




  LOCAL ERROR
  ON ERROR LOCAL RESTORE ERROR:     SYS"XOS_Find",0,c%:     SYS"XOS_File",6,f$:     ERROR  254 , FNmsg_1(A%! 12 ,"OKB",REPORT$)




  BPUT#c%,"fv: 1"
  prnt%=A%! 48 
  WHILE prnt%
   psup%=prnt%! 4 
   BPUT#c%,"cl: "+$psup%! 4 +":"+STR$ psup%! 40 
   BPUT#c%,"nm: "+$prnt%! 8 

    
   ptr%=prnt%! 12 
   IF psup%! 24  AND  4  THEN
     
    size%=psup%! 48 
    BPUT#c%,"cn: "+STR$ size%
    IF 1<=size% THEN
     FOR f%=1 TO size%
      p%=!ptr%
      ptr%+=4
      CASE  -1  OF
       WHEN p%=0
        BPUT#c%,"nl: "
       WHEN p%!-4= &47544E49 
        BPUT#c%,"in: "+STR$ !p%
       WHEN p%!-4= &47525453 
        BPUT#c%,"st: "+$p%
       WHEN p%!-4= &30525453 
        CALL Z%,p%,s$  
        BPUT#c%,"s0: "+s$
       WHEN p%!-4= &52545347 
        CALL Y%,p%,s$  
        BPUT#c%,"gs: "+FNungstrans(s$)
       WHEN p%!-4= &52544F50 
        BPUT#c%,"pt: "+FNdiscover_ptr(!p%,psup%)
       OTHERWISE
        SYS "XOS_Find",,c%  
        ERROR  254 ,FNmsg_1(A%! 12 ,"OKC",$prnt%! 8 )
      ENDCASE
     NEXT
    ENDIF
   ELSE
     
    BPUT#c%,"ct: 16_"+STR$~ptr%! 0 
     







    BPUT#c%,"bd: 16_"+STR$~ptr%! 4 
     

    IF ptr%! 8  AND %110000 ptr%! 8 =ptr%! 8  OR %1000
    BPUT#c%,"ft: 16_"+STR$~ptr%! 8 
    BPUT#c%,"et: ";
    IF ptr%! 12 =0 BPUT#c%,10 ELSE BPUT#c%,$ptr%! 12 
    BPUT#c%,"fl: ";
    IF ptr%! 16 =0 BPUT#c%,10 ELSE BPUT#c%,$ptr%! 16 
    BPUT#c%,"ns: ";
    IF ptr%! 20 =0 BPUT#c%,10 ELSE BPUT#c%,$ptr%! 20 
    BPUT#c%,"np: ";
    IF ptr%! 24 =0 BPUT#c%,10 ELSE BPUT#c%,$ptr%! 24 
    BPUT#c%,"nu: ";
    IF ptr%! 28 =0 BPUT#c%,10 ELSE BPUT#c%,$ptr%! 28 
    BPUT#c%,"no: ";
    IF ptr%! 32 =0 BPUT#c%,10 ELSE BPUT#c%,$ptr%! 32 
     
    BPUT#c%,"cf: 16_"+STR$~ptr%? 6 
   ENDIF

    
   ptr%=prnt%! 16 
   size%=psup%! 36 
   BPUT#c%,"cs: "+STR$ size%
   IF 1<=size% THEN
     FOR f%=1 TO size%
       p%=!ptr%
       ptr%+=4
       CASE  -1  OF
         WHEN p%=0
           BPUT#c%,"nl: "
         WHEN p%!-4= &47544E49 
           BPUT#c%,"in: "+STR$ !p%
         WHEN p%!-4= &47525453 
           BPUT#c%,"st: "+$p%
         WHEN p%!-4= &30525453 
           CALL Z%,p%,s$  
           BPUT#c%,"s0: "+s$
         WHEN p%!-4= &52545347 
           CALL Y%,p%,s$  
           BPUT#c%,"gs: "+FNungstrans(s$)
         WHEN p%!-4= &52544F50 
           BPUT#c%,"pt: "+FNdiscover_ptr(!p%,psup%)
         OTHERWISE
           SYS "XOS_Find",,c%  
           ERROR  254 ,FNmsg_1(A%! 12 ,"OKC",$prnt%! 8 )
       ENDCASE
     NEXT
   ENDIF
   REM save the following flags:
   REM bit 0: whether or not the printer is active
   REM bit 1: whether or not the printer is selected
   REM bit 7: whether or not the printer supports fast parallel

   REM bit 16: whether the printer is shared
   REM bit 17: whether the printer is remote

   BPUT#c%,"fg: 16_"+STR$~(prnt%! 24  AND  195+65536+131072 )
   f%=prnt%! 36 
   BPUT#c%,"pn: "+$f%! 4 
   BPUT#c%,"sn: "+FNprinter_read_string(prnt%! 40 )
   BPUT#c%,"ic: "+FNprinter_read_string(prnt%! 44 )
   prnt%=prnt%! 0 
  ENDWHILE

  rmtp% = remote_printers%
  WHILE rmtp%
    IF rmtp%! 20  > 0 THEN
      BPUT#c%, "cl:"
      BPUT#c%, "nm: "+$rmtp%! 8   
      BPUT#c%, "ct: 16_9"
      BPUT#c%, "bd: 16_8"
      BPUT#c%, "ft: 16_5"
      BPUT#c%, "et:"
      BPUT#c%, "fl:"
      BPUT#c%, "ns:"
      BPUT#c%, "np:"
      BPUT#c%, "nu:"
      BPUT#c%, "no:"
      BPUT#c%, "cf: 16_0"
      BPUT#c%, "cs: 2"
      BPUT#c%, "in: 25600"
      BPUT#c%, "in: 6"
      BPUT#c%, "fg: 16_20000"
      BPUT#c%, "pn:"
      BPUT#c%, "sn: "+$rmtp%! 4 
      BPUT#c%, "ic:"
    ENDIF
    rmtp% = rmtp%! 0 
  ENDWHILE

  CLOSE#c%  
  SYS "XOS_File",18,f$,&FC6  

  SYS "XOS_File",6,LEFT$(f$)
  SYS "XOS_FSControl", 25, f$, LEFT$(f$)
  SYS "XOS_File",4,LEFT$(f$),,,,&13  

  SYS "Hourglass_Off"
ENDPROC

DEF PROCsave_prdata
  LOCAL psup%,head%,prdt%,c%,tmpt%,ntry%,list%,i%,j%,k%,l%,s$,f%,f$

   









    
  SYS "Hourglass_On"
  psup%=psup_head%
  WHILE psup%
   IF psup%! 8  THEN
     
      
    IF psup%! 24  AND  2  THEN
       

     IF multiple_choices% THEN
       f$ =  "<Choices$Write>.Printers" +".Remote.ID"+unique_string$+"."+$psup%! 4 
       SYS "OS_File", 8, f$  
       f$ += ".PrData1"
     ELSE

       f$ =  "<Choices$Write>.Printers" +"."+$psup%! 4 +".PrData1"

     ENDIF


      

     SYS "XOS_File",4,LEFT$(f$),,,,3  

     SYS "XOS_Find",&8F,f$ TO c%;f%
     IF f% AND 1        f%=c%+4:        CALL Z%,f%,s$:          ERROR  254 ,FNmsg_1(A%! 12 ,"OKB",s$)




     LOCAL ERROR
     ON ERROR LOCAL RESTORE ERROR:        SYS"XOS_Find",0,c%:        SYS"XOS_File",6,f$:        ERROR  254 , FNmsg_1(A%! 12 ,"OKB",REPORT$)




     tmpt%=psup%! 8 
     head%=psup%! 12 
     WHILE tmpt%
      BPUT#c%,$(tmpt%+ 12 )+":"
      BPUT#c%,"#"
      prdt%=head%! 4 
      WHILE prdt%
       IF prdt%!(prdt%! 4 *4+ 8 )THEN
        BPUT#c%,"# Usage: "+STR$ prdt%!(prdt%! 4 *4+ 8 )
        ntry%=tmpt%! 4 
        i%=prdt%+ 8 
        WHILE ntry%
         BPUT#c%,$(ntry%+ 16 )+" ";
         IF !i%=0 THEN
          IF ntry%! 4 =6 THEN
            BPUT#c%,48  
          ELSE
            IF ntry%! 4 =1 THEN
              BPUT#c%,48  
            ENDIF
          ENDIF
          BPUT#c%,10
         ELSE
          j%=!i%  
          CASE ntry%! 4  OF
           WHEN 1
             
            IF $(ntry%+ 16 ) = "palette:" THEN
              BPUT#c%,STR$((!j%) AND &7FFFFF)
            ELSE
              BPUT#c%,STR$ !j%
            ENDIF
           WHEN 2
            BPUT#c%,FNprinter_read_string(j%)
           WHEN 3
            BPUT#c%,FNprinter_read_string(j%)
           WHEN 4
            BPUT#c%,FNungstrans(FNprinter_read_string(j%))
           WHEN 5
            BPUT#c%,10
            CASE ntry%! 8  OF
             WHEN 1
              BPUT#c%," "+STR$ !j%! 0 +", "+STR$ !j%! 4 
             WHEN 2
              BPUT#c%," "+FNprinter_read_string(j%! 0 )
              BPUT#c%," "+FNprinter_read_string(j%! 4 )
             WHEN 3
              BPUT#c%," "+FNprinter_read_string(j%! 0 )
              BPUT#c%," "+FNprinter_read_string(j%! 4 )
             WHEN 4
              BPUT#c%," "+FNungstrans(FNprinter_read_string(j%! 0 ))
              BPUT#c%," "+FNungstrans(FNprinter_read_string(j%! 4 ))
             WHEN 7
              BPUT#c%," "+FNdiscover_ptr(!j%! 0 ,psup%)+", "+FNdiscover_ptr(!j%! 4 ,psup%)
            ENDCASE
           WHEN 6
            k%=j%
            l%=0
            WHILE k%
             l%+=1
             k%=!k%
            ENDWHILE
            BPUT#c%,STR$ l%
            WHILE j%
             IF 0<=j%! 4 -1 THEN
               FOR k%=0 TO j%! 4 -1
                l%=j%!(k%*4+ 8 )
                CASE l%!-4 OF
                 WHEN  &47544E49 
                  BPUT#c%," "+STR$ !l%+", ";
                 WHEN  &47525453 
                  BPUT#c%," "+$l%+", ";
                 WHEN  &30525453 
                  CALL Z%,l%,s$  
                  BPUT#c%," "+s$+", ";
                 WHEN  &52545347 
                  CALL Y%,l%,s$  
                  BPUT#c%," "+FNungstrans(s$)+", ";
                 WHEN  &52544F50 
                  BPUT#c%," "+FNdiscover_ptr(!l%,psup%)+", ";
                ENDCASE
               NEXT
             ENDIF
             PTR#c%=PTR#c%-2
             BPUT#c%,10
             j%=!j%
            ENDWHILE
           WHEN 7
            BPUT#c%,FNdiscover_ptr(!j%,psup%)
           WHEN 8
            k%=j%
            l%=0
            WHILE k%
             l%+=1
             k%=!k%
            ENDWHILE
            BPUT#c%,STR$ l%
            WHILE j%
             s$=CHR$ j%?4
             IF 1<=j%?5 THEN
              FOR k%=1 TO j%?5
               s$+=CHR$ j%?(k%+5)
              NEXT
             ENDIF
             BPUT#c%," "+FNungstrans(s$)
             j%=!j%
            ENDWHILE
          ENDCASE
         ENDIF
         ntry%=ntry%! 0 
         i%+=4
        ENDWHILE
        BPUT#c%,"#"
       ENDIF
       prdt%=prdt%! 0 
      ENDWHILE
      tmpt%=tmpt%! 0 
      head%=head%! 0 
     ENDWHILE
     CLOSE#c%  
     SYS "XOS_File",18,f$,&FC6  

     SYS "XOS_File",6,LEFT$(f$)
     SYS "XOS_FSControl",25,f$,LEFT$(f$)
     SYS "XOS_File",4,LEFT$(f$),,,,&13  

       
     psup%! 24 =psup%! 24  AND NOT  2 
    ELSE
       
    ENDIF
   ENDIF
   psup%=psup%! 0 
  ENDWHILE
  SYS "Hourglass_Off"
ENDPROC

DEF FNdiscover_ptr(p%,psup%)
   
  LOCAL head%,prdt%,tmpt%,head_count%,prdt_count%
    
  head%=psup%! 12 
  WHILE head%
    prdt%=head%! 4 
    prdt_count%=0
    WHILE prdt%
      IF prdt%!(prdt%! 4 *4+ 8 )THEN
        prdt_count%+=1
        IF p%=prdt% THEN
          tmpt%=psup%! 8 
          WHILE head_count%
            tmpt%=tmpt%! 0 
            head_count%-=1
          ENDWHILE
          =$(tmpt%+ 12 )+":"+STR$ prdt_count%
        ENDIF
      ENDIF
      prdt%=prdt%! 0 
    ENDWHILE
    head_count%+=1
    head%=head%! 0 
  ENDWHILE
  PROCerror_warning(FNmsg_0(A%! 12 ,"FAF"))
=""

DEF FNwindow_open(h%)
    
  !win_buff%=h%
  SYS "Wimp_GetWindowState",,win_buff%
=(win_buff%!32 AND 1<<16)<>0

DEF PROCprinter_control(prnt%)
   
    

  IF NOT FNwindow_open(prntctrl%) THEN
    IF A%! 48  OR remote_printers% THEN
      PROCcreate_installed_printer_icons
    ENDIF
  ENDIF  



  PROCtell_pinboard(prntctrl%)
  PROCwin_open(prntctrl%)
  PROCselect_printer_control(prnt%)
ENDPROC

DEF PROCselect_printer_control(prnt%)
  LOCAL p%
    
  IF prnt% THEN
    SYS "Wimp_WhichIcon",prntctrl%,buff1%,1<<21,1<<21
    p%=buff1%
    WHILE NOT !p%
      IF !p%<>prnt%! 28  PROCicon_deselect(prntctrl%,!p%)
      p%+=4
    ENDWHILE
    IF(prnt%! 24  AND  44 )=0       PROCicon_select(prntctrl%,prnt%! 28 )

  ENDIF
ENDPROC

DEF PROCcheck_prdata_ptr(p%)
   







  LOCAL ptr%,i%,tmp%
    
  IF p%=0 ENDPROC
  CASE p%!-4 OF
    WHEN  &52544F50 
      ptr%=!p%  
      tmp%=ptr%+ptr%! 4 *4+ 8 
      !tmp%-=1
      IF !tmp%=0 THEN
        tmp%=ptr%+ 8 
        IF 1<=ptr%! 4  THEN
          FOR i%=1 TO ptr%! 4 
            PROCcheck_prdata_ptr(!tmp%)
            tmp%+=4
          NEXT
        ENDIF
      ENDIF
    WHEN  &4C4f4F42 
      PROCcheck_prdata_ptr(p%! 0 )
      PROCcheck_prdata_ptr(p%! 4 )
    WHEN  &4454534C 
      WHILE p%
        IF 0<=p%! 4 -1 THEN
          FOR ptr%=0 TO p%! 4 -1
            PROCcheck_prdata_ptr(p%!(ptr%*4+ 8 ))
          NEXT
        ENDIF
        p%=p%! 0 
      ENDWHILE
  ENDCASE
ENDPROC

DEF PROCdelete_prdata_entry(printer_type$)
  LOCAL psup%,head%,old_prdt%,prdt%,i%,j%,k%,l%,tmp%
    
  psup%=psup_head%
  WHILE psup%
      
    old_prdt%=0
    head%=psup%! 12   
    prdt%=head%! 4   
    WHILE prdt%
        
      IF $prdt%! 8 =printer_type$ THEN
         
          
        IF (prdt%!(prdt%! 4 *4+ 8 )) = 0 THEN
           
            
          psup%! 24 =psup%! 24  OR  2 
          IF 0<=prdt%! 4 -1 THEN
            FOR i%=0 TO prdt%! 4 -1
              tmp%=prdt%!(i%*4+ 8 )
              PROCcheck_prdata_ptr(tmp%)
              PROCfree_structure(tmp%)
            NEXT
          ENDIF
          IF old_prdt% THEN
            old_prdt%! 0 =prdt%! 0 
          ELSE
            head%! 4 =prdt%! 0 
          ENDIF
            
          B%= &54445250 
          C%=prdt%
          CALL code_entry%+ 16 
        ENDIF
        prdt%=0
        psup%=0
      ELSE
        old_prdt%=prdt%
        prdt%=prdt%! 0 
      ENDIF
    ENDWHILE
    IF psup% psup%=psup%! 0 
  ENDWHILE
ENDPROC

DEF PROCvalidate_error(err$)
    
  PROCram_file_error(FNmsg_1(A%! 12 ,"OKZ",err$))
ENDPROC

DEF PROCvalidate_prdata_file(RETURN psup%)
   

  LOCAL ptr%,ts%,c%,d%
    

   
  ts%=FNmatch_line("cl:")
  IF ts%=0 PROCvalidate_error(FNmsg_0(A%! 12 ,"OKZa"))

   
  psup%=psup_head%
  WHILE psup%
    IF $psup%! 4 =$ts% THEN
       
       
       
      IF psup%! 24  AND  32  THEN
        SYS"XOS_File",7,"PrinterChoices:"+$ts%+".WriteTest" TO ;c%
        IF(c%AND1) PROCrelease_file:ERROR  254 ,FNmsg_1(A%! 12 ,"OKAN",$ts%)
         
        SYS"XOS_File",6,"PrinterChoices:"+$ts%+".WriteTest" TO d%;c%
      ENDIF

      ptr%=!data_ptr%
      PROCvalidate_one_entry(psup%,psup%! 8 )
      !data_ptr%=ptr%
      ENDPROC
    ELSE
      psup%=psup%! 0 
    ENDIF
  ENDWHILE

  IF psup%=0 THEN















    PROClocal_file
    PROCinitialise_one_support_library($ts%)
    PROCinitialise_one_psup($ts%,psup%)  
    PROCrestore_file
    PROCtimeout_reinitialise
     
     
    IF psup%! 24  AND  32  THEN
      SYS"XOS_File",7,"PrinterChoices:"+$ts%+".WriteTest" TO ;c%
      IF(c%AND1) PROCrelease_file:ERROR  254 ,FNmsg_1(A%! 12 ,"OKAN",$ts%)
      SYS"XOS_File",6,"PrinterChoices:"+$ts%+".WriteTest"
    ENDIF
     



    PROCprinter_reason_code(psup%,A%! 48 ,-5,0)
  ENDIF
  IF psup%=0 PROCvalidate_error(FNmsg_1(A%! 12 ,"OKZb",$ts%))

ENDPROC

DEF PROCvalidate_one_entry(psup%,tmpt%)
  LOCAL ntry%,ts%
    
  ntry%=tmpt%! 4 
  REPEAT
    ts%=FNmatch_line($(ntry%+ 16 ))
    IF ts% THEN
       

      CASE ntry%! 4  OF
        WHEN 5
          PROCvalidate_one_boolean(psup%,tmpt%,$ts%)
        WHEN 6
          IF ?ts%=13 PROCvalidate_error(FNmsg_1(A%! 12 ,"OK7a",$(ntry%+ 16 )))
          PROCvalidate_one_list(psup%,tmpt%,$ts%)
        WHEN 7
          PROCvalidate_one_pointer(psup%,tmpt%,$ts%)
        WHEN 8
          IF ?ts%=13 PROCvalidate_error(FNmsg_1(A%! 12 ,"OK7a",$(ntry%+ 16 )))
          PROCvalidate_one_charlist(psup%,tmpt%,$ts%)
      ENDCASE





    ENDIF
    ntry%=ntry%! 0 
  UNTIL ntry%=0
ENDPROC

DEF PROCvalidate_one_boolean(psup%,tmpt%,t$)
  LOCAL ts%,int$,str$
    
  ts%=FNmatch_any_line
  IF ts% THEN
    CASE ntry%! 8  OF
      WHEN 1
        ts%=FNsplit_integer(ts%,int%)
        IF ?ts%=13 ts%=FNmatch_any_line
      WHEN 2,3,4
        ts%=FNsplit_string(ts%,str$)
        IF ?ts%=13 ts%=FNmatch_any_line
      WHEN 7
        ts%=FNsplit_string(ts%,str$)
        PROCvalidate_one_pointer(psup%,tmpt%,str$)
        IF ?ts%=13 ts%=FNmatch_any_line
        PROCvalidate_one_pointer(psup%,tmpt%,$ts%)
    ENDCASE
  ENDIF
ENDPROC

DEF PROCvalidate_one_list(psup%,tmpt%,t$)
  LOCAL i%,p%,ned%,ts%
    
  ned%=VAL t$
  IF 1<=ned% THEN
    FOR i%=1 TO ned%
      ts%=FNmatch_any_line
      IF ts% THEN
        p%=ntry%! 8 
        WHILE p%
          IF p%! 4 =7 PROCvalidate_one_pointer(psup%,tmpt%,$ts%)
          p%=!p%
        ENDWHILE
      ENDIF
    NEXT
  ENDIF
ENDPROC

DEF PROCvalidate_one_pointer(psup%,tmpt%,name$)
  LOCAL i%,s$,t$
    
  i%=INSTR(name$,":")
  IF i%=0 PROCvalidate_error(FNmsg_1(A%! 12 ,"OKAA",name$))
  s$=LEFT$(name$,i%-1)
  t$=MID$(name$,i%+1)
  tmpt%=psup%! 8 
  WHILE tmpt%
    IF $(tmpt%+ 12 )=s$ THEN
      IF VAL t$>0 THEN
         
        ENDPROC
      ELSE
        PROCvalidate_one_entry(psup%,tmpt%)
        ENDPROC
      ENDIF
    ELSE
      tmpt%=tmpt%! 0 
    ENDIF
  ENDWHILE
  PROCvalidate_error(FNmsg_1(A%! 12 ,"OKAB",s$))
ENDPROC

DEF PROCvalidate_one_charlist(psup%,tmpt%,t$)
  LOCAL i%,ned%
    
  ned%=VAL t$
  IF 1<=ned% THEN
    FOR i%=1 TO ned%
      IF FNmatch_any_line
    NEXT
  ENDIF
ENDPROC

DEF PROCadd_to_prdata
   
  LOCAL ts%,psup%,ptr%,s$,ntry%,prdata%,last_prdata%,this_prhead%,matched%,fix_up%
    
  ts%=task_buff%+44
  CALL Z%,ts%,s$  
  IF NOT FNload_file(s$)     ERROR  254 ,FNmsg_1(A%! 12 ,"OKX",s$)

  SYS "Hourglass_On"
   
  PROCvalidate_prdata_file(psup%)
  this_prhead%=psup%! 12 
  IF this_prhead% THEN
     
    prdata%=this_prhead%! 4 
    IF prdata% THEN
       


      ptr%=!data_ptr%
      ntry%=psup%! 8 
      ntry%=ntry%! 4 
      ts%=FNmatch_line($(ntry%+ 16 ))
      IF ts% THEN
         
        WHILE prdata%
          IF $prdata%! 8 =$ts% THEN
            PROCrelease_file
            SYS "Hourglass_Off"
            PROCinstall_printer(psup%,prdata%)
            ENDPROC
          ENDIF
          last_prdata%=prdata%
          prdata%=prdata%! 0 
        ENDWHILE
         

      ELSE
         
        PROCvalidate_error(FNmsg_1(A%! 12 ,"OKZc",            $(ntry%+ 16 )))

      ENDIF
      !data_ptr%=ptr%
    ELSE
      last_prdata%=0
    ENDIF
  ELSE
    last_prdata%=0
  ENDIF

    
  PROCprocess_one_entry(psup%! 8 ,last_prdata%,this_prhead%,0,      matched%,fix_up%,psup%)

  PROCrelease_file
    
  psup%! 24 =psup%! 24  OR  2 
       

  PROCinstall_printer(psup%,last_prdata%)
  SYS "Hourglass_Off"
ENDPROC

   








DEF PROCram_file_error(s$)
    
  PROCrelease_file
  ERROR  254 ,FNmsg_3(A%! 12 ,"OK0",STR$ data_line%,data_file$,s$)
ENDPROC

DEF PROCprdata_error(psup%,s$,tag$)
    
  PROCram_file_error(FNmsg_2(A%! 12 ,tag$,$psup%! 4 ,s$))
ENDPROC

DEF PROCprocess_template(database%)
   
  LOCAL ts%,ss%,depth%,i%,this_template%,last_template%,this_entry%,last_entry%
    
  ts%=FNmatch_line("tp:")
  IF ts%=0 PROCprdata_error(database%,FNmsg_0(A%! 12 ,"OK3"),"OK2a")
  REPEAT
    ts%=FNmatch_any_line
    IF ts% THEN
      ss%=FNmatch_string(ts%,"tp:")
      IF ss% THEN
         
        depth%+=1
        B%= &54504D54 
        C%= 12 +1+LEN $ss%
        this_template%=USR(code_entry%+ 12 )
        IF this_template%=0 PROCprdata_error(database%,FNmsg_1(A%! 12 ,"FA5","TMPT"),"OK2a")
        IF last_template% THEN
          last_template%! 0 =this_template%
        ELSE
          database%! 8 =this_template%
        ENDIF
        this_template%! 0 =0
        this_template%! 4 =0
        this_template%! 8 =0
        $(this_template%+ 12 )=$ss%
        last_entry%=0
      ELSE
         
        ss%=FNmatch_string(ts%,"end:")
        IF ss% THEN
          IF ?ss%<>13 PROCprdata_error(database%,FNmsg_0(A%! 12 ,"OK3a"),"OK2a")
          depth%-=1
          last_template%=this_template%
        ELSE
           
          i%=INSTR($ts%,":")
          IF i%=0 PROCprdata_error(database%,FNmsg_1(A%! 12 ,"OK4",$ts%),"OK2a")
          IF depth%<>1 PROCprdata_error(database%,FNmsg_1(A%! 12 ,"OK4a",$ts%),"OK2a")
          this_template%! 8 +=1
          B%= &5952544E 
          C%= 16 +1+i%
          this_entry%=USR(code_entry%+ 12 )
          IF this_entry%=0 PROCprdata_error(database%,FNmsg_1(A%! 12 ,"FA5","NTRY"),"OK2a")
          IF last_entry% last_entry%! 0 =this_entry% ELSE this_template%! 4 =this_entry%
          this_entry%! 0 =0
          this_entry%! 4 =0
          this_entry%! 8 =0
          this_entry%! 12 =0
          $(this_entry%+ 16 )=LEFT$($ts%,i%)
          ts%+=i%+1

          CASE  -1  OF
            WHEN FNmatch_string(ts%,"in")<>0
              this_entry%! 4 =1
            WHEN FNmatch_string(ts%,"st")<>0
              this_entry%! 4 =2
            WHEN FNmatch_string(ts%,"s0")<>0
              this_entry%! 4 =3
            WHEN FNmatch_string(ts%,"gs")<>0
              this_entry%! 4 =4
            WHEN FNmatch_string(ts%,"bl")<>0
              this_entry%! 4 =5
              ss%=FNmatch_string(ts%,"bl")  
              WHILE ?ss%=32
                ss%+=1
              ENDWHILE
              IF ?ss%=ASC "," ss%+=1

              CASE  -1  OF
                WHEN FNmatch_string(ss%,"in")<>0
                  this_entry%! 8 =1
                WHEN FNmatch_string(ss%,"st")<>0
                  this_entry%! 8 =2
                WHEN FNmatch_string(ss%,"s0")<>0
                  this_entry%! 8 =3
                WHEN FNmatch_string(ss%,"gs")<>0
                  this_entry%! 8 =4
                WHEN FNmatch_string(ss%,"ptr")<>0
                  this_entry%! 8 =7
                OTHERWISE
                  PROCprdata_error(database%,FNmsg_1(A%! 12 ,"OK5",$ss%),"OK2a")
              ENDCASE
            WHEN FNmatch_string(ts%,"ls")<>0
              this_entry%! 4 =6
              ss%=FNmatch_string(ts%,"ls")
              PROCmatch_list(ss%,this_entry%,database%)
            WHEN FNmatch_string(ts%,"ptr")<>0
              this_entry%! 4 =7
            WHEN FNmatch_string(ts%,"ch")<>0
              this_entry%! 4 =8
            OTHERWISE
              PROCprdata_error(database%,FNmsg_1(A%! 12 ,"OK6",$ts%),"OK2a")
          ENDCASE
          last_entry%=this_entry%
        ENDIF
      ENDIF
    ENDIF
  UNTIL depth%=-1
ENDPROC

DEF PROCmatch_list(rs%,ntry%,database%)
  LOCAL list%,ptr%,t%
    
  ptr%=ntry%+ 8 
  REPEAT
    WHILE ?rs%=32
      rs%+=1
    ENDWHILE

    IF ?rs%=44 rs%+=1  

    WHILE ?rs%=32
      rs%+=1
    ENDWHILE

    IF ?rs%<>13 THEN
      ntry%! 12 +=1  
      B%= &5453494C 
      C%= 8 
      list%=USR(code_entry%+ 12 )
      IF list%=0 ERROR  253 ,FNmsg_1(A%! 12 ,"FA5","LIST")
      !ptr%=list%
      ptr%=list%
      list%! 0 =0
      t%=FNmatch_string(rs%,"in")
      IF t% THEN
        rs%=t%
        list%! 4 =1
      ELSE
        t%=FNmatch_string(rs%,"st")
        IF t% THEN
          rs%=t%
          list%! 4 =2
        ELSE
          t%=FNmatch_string(rs%,"s0")
          IF t% THEN
            rs%=t%
            list%! 4 =3
          ELSE
            t%=FNmatch_string(rs%,"gs")
            IF t% THEN
              rs%=t%
              list%! 4 =4
            ELSE
              t%=FNmatch_string(rs%,"ptr")
              IF t% THEN
                rs%=t%
                list%! 4 =7
              ELSE
                PROCprdata_error(database%,FNmsg_1(A%! 12 ,"OK7",$rs%),"OK2a")
              ENDIF
            ENDIF
          ENDIF
        ENDIF
      ENDIF
    ENDIF
  UNTIL ?rs%=13
ENDPROC

DEF FNmatch_line(m$)
  LOCAL tail%,i%
   










    

   
  i%=data_block%+!data_ptr%
  WHILE i%<data_block%+data_size%
     
      
      
    WHILE ?i%=32
      i%+=1
        
    ENDWHILE

    IF ?i%=35 OR ?i%=13 THEN
       
        
      i%+=LEN $i%+1
      data_line%+=1
    ELSE
       
        
      IF m$=LEFT$($i%,LEN m$)THEN
         
        tail%=i%+LEN m$
        WHILE ?tail%=32
          tail%+=1
        ENDWHILE

         
        i%+=LEN $i%+1
        !data_ptr%=i%-data_block%
        data_line%+=1
         
        =tail%
      ELSE
         
         
          
        i%+=LEN $i%+1
        data_line%+=1
      ENDIF
    ENDIF
    


  ENDWHILE
=0

DEF FNmatch_any_line
  LOCAL tail%,i%

    

   
  i%=data_block%+!data_ptr%
  WHILE i%<data_block%+data_size%
     
    WHILE ?i%=32
      i%+=1
    ENDWHILE

    IF ?i%=35 OR ?i%=13 THEN
       
      i%+=LEN $i%+1
      !data_ptr%=i%-data_block%  
      data_line%+=1
    ELSE
       
      tail%=i%

       
      i%+=LEN $i%+1
      !data_ptr%=i%-data_block%
      data_line%+=1
       
      =tail%
    ENDIF
    


  ENDWHILE
=0

DEF FNmatch_string(ts%,m$)
  



   
  WHILE ?ts%=32
    ts%+=1
  ENDWHILE

   
  IF m$=LEFT$($ts%,LEN m$)THEN
     
    ts%+=LEN m$
    WHILE ?ts%=32
      ts%+=1
    ENDWHILE
    =ts%
  ENDIF
=0

DEF PROCprocess_one_entry(tmpt%,RETURN last_prdata%,this_prhead%,last_prhead%,RETURN matched%,RETURN fix_up%,psup%)
  LOCAL offset%,this_prdata%,file_ptr%,ts%,ss%,ntry%,i%,size%
    
  ntry%=tmpt%! 4 
  offset%=-1
  REPEAT
    file_ptr%=!data_ptr%
    matched%=0
    ts%=FNmatch_any_line:  
    IF ts% THEN
      IF offset%=-1 THEN
         

          
        size%=4*tmpt%! 8 + 8 
        B%= &54445250 
        C%=size%+8
        this_prdata%=USR(code_entry%+ 12 )
          
        IF this_prdata%=0           ERROR  253 ,FNmsg_1(A%! 12 ,"FA5","PRDT")

        IF 0<=size%+7 THEN
          FOR i%=0 TO size%+7 STEP 4
            this_prdata%!i%=0
          NEXT
        ENDIF
        IF last_prdata% last_prdata%! 0 =this_prdata% ELSE this_prhead%! 4 =this_prdata%
        this_prdata%! 4 =tmpt%! 8 
        offset%=8
      ENDIF
      REPEAT
        ss%=FNmatch_string(ts%,$(ntry%+ 16 )):  
        IF ss% THEN
          matched%=1
          CASE ntry%! 4  OF
            WHEN 1
              this_prdata%!offset%=FNstore_integer(FNevaluate($ss%))
            WHEN 2,3,4
              B%=ss%
              C%=ntry%! 4 
              this_prdata%!offset%=USR(code_entry%+ 28 )
            WHEN 5
              this_prdata%!offset%=FNretrieve_boolean(ntry%,fix_up%)
            WHEN 6
              IF ?ss%=13 PROCprdata_error(psup%,FNmsg_1(A%! 12 ,"OK7a",$ts%),"OK2")
              this_prdata%!offset%=FNretrieve_list(ntry%,FNevaluate($ss%),fix_up%)
            WHEN 7
              IF ?ss%<>13 PROCretrieve_ptr(psup%,$ss%,this_prdata%+offset%,fix_up%)
            WHEN 8
              IF ?ss%=13 PROCprdata_error(psup%,FNmsg_1(A%! 12 ,"OK7a",$ts%),"OK2")
              this_prdata%!offset%=FNretrieve_charlist(ntry%,FNevaluate($ss%))
          ENDCASE
        ENDIF
         
         









        offset%+=4
        ntry%=ntry%! 0 
      UNTIL ntry%=0 OR matched%
    ENDIF
    IF matched%=0 THEN
       
      IF !data_ptr%>=data_size% matched%=3
       
      !data_ptr%=file_ptr%
       
      ntry%=tmpt%! 4 
      ss%=FNmatch_string(ts%,$(ntry%+ 16 ))
      IF ss% THEN
        matched%=1
      ELSE
         
        tmpt%=tmpt%! 0 
        ss%=FNmatch_string(ts%,$(tmpt%+ 12 )+":")
        IF ss% matched%=2
      ENDIF
      ntry%=0
    ENDIF
  UNTIL ntry%=0
    
  last_prdata%=this_prdata%
ENDPROC

DEF PROCprocess_file(psup%)
  LOCAL tmpt%,s$,ts%,file_ptr%,ntry%,matched%,this_prdata%,last_prdata%,this_prhead%,last_prhead%,fix_up%,i%
    
  tmpt%=psup%! 8 
  REPEAT
     
    ts%=FNmatch_line($(tmpt%+ 12 )+":")
    IF ts%=0 PROCprdata_error(psup%,FNmsg_1(A%! 12 ,"OK8",$(tmpt%+ 12 )),"OK2")
    B%= &44414548 
    C%= 12 
    this_prhead%=USR(code_entry%+ 12 )
    IF this_prhead%=0 PROCprdata_error(psup%,FNmsg_1(A%! 12 ,"FA5","HEAD"),"OK2")
    this_prhead%! 0 =0
    this_prhead%! 4 =0
    IF last_prhead% last_prhead%! 0 =this_prhead% ELSE psup%! 12 =this_prhead%
    last_prdata%=0
    REPEAT
      ntry%=tmpt%! 4 
        
      PROCprocess_one_entry(tmpt%,last_prdata%,this_prhead%,last_prhead%,matched%,fix_up%,psup%)
       



      IF matched%=0 THEN
        ts%=FNmatch_any_line
        PROCprdata_error(psup%,FNmsg_1(A%! 12 ,"OK9",$ts%),"OK2")
      ENDIF
    UNTIL matched%<>1
    tmpt%=tmpt%! 0 
    last_prhead%=this_prhead%
  UNTIL tmpt%=0
  WHILE fix_up%
    i%=fix_up%!4
    s$=$!i%
    B%= &52544F50 
    C%=!i%
    CALL code_entry%+ 16 
    B%= &52544F50 
    C%=4
    !i%=USR(code_entry%+ 12 )
    IF !i%=0 PROCprdata_error(psup%,FNmsg_1(A%! 12 ,"FA5","POTR"),"OK2")
    !!i%=FNfix_up_pointer(s$, -1 )
    i%=fix_up%
    fix_up%=!fix_up%
    B%= &58585858 
    C%=i%
    CALL code_entry%+ 16 
  ENDWHILE
ENDPROC

DEF FNfix_up_pointer(s$,inc_count%)
  LOCAL j%,k%,t$
    
  j%=INSTR(s$,":")
  t$=MID$(s$,j%+1)
  s$=LEFT$(s$,j%-1)
  j%=psup%! 8 
  k%=0
   
  WHILE j%
   IF$(j%+ 12 )=s$ THEN
     
    j%=psup%! 12 
    WHILE k%
     j%=j%! 0 
     k%-=1
    ENDWHILE
     
    k%=VAL t$-1
    j%=j%! 4 
    WHILE k%
     j%=j%! 0 
     k%-=1
    ENDWHILE
     

    IF inc_count% j%!(j%! 4 *4+ 8 )+=1
     
    =j%
   ELSE
    j%=j%! 0 
    k%+=1
   ENDIF
  ENDWHILE
  PROCerror_warning(FNmsg_2(A%! 12 ,"FAG",s$,t$))
=0

DEF FNstore_integer(v%)
  LOCAL b%
    
  B%= &47544E49 
  C%=4
  b%=USR(code_entry%+ 12 )
  IF b%=0 ERROR  253 ,FNmsg_1(A%! 12 ,"FA5","INTG")
  !b%=v%
=b%

DEF FNgstrans(s$)
  LOCAL t$,i%,len%
  SYS "OS_GSTrans",s$,buff1%,256 TO,,len%
  IF len%=0 THEN =""
  FOR i%=0 TO len%-1
    t$+=CHR$ buff1%?i%
  NEXT
   
=t$

DEF FNungstrans(s$)
  LOCAL t$,i%,c%
  IF s$="" THEN =""
  FOR i%=1 TO LEN s$
    c%=ASC MID$(s$,i%,1)
    


    IF c%>=128 c%-=128: t$+="|!"
    IF c%<32 c%+=64: t$+="|"
    IF c%=127 c%=63: t$+="|"  
    IF INSTR("|<""",CHR$ c%)THEN t$+="|"
    t$+=CHR$ c%
  NEXT
=t$

DEF FNretrieve_boolean(ntry%,RETURN fix_up%)
  LOCAL ts%,int%,b%,str$
    
  B%= &4C4f4F42 
  C%= 8 
  b%=USR(code_entry%+ 12 )
  IF b%=0 ERROR  253 ,FNmsg_1(A%! 12 ,"FA5","BOOL")
  ts%=FNmatch_any_line
  IF ts% THEN
    CASE ntry%! 8  OF
      WHEN 1
        ts%=FNsplit_integer(ts%,int%)
        b%! 0 =FNstore_integer(int%)
        IF ?ts%=13 ts%=FNmatch_any_line
        b%! 4 =FNstore_integer(FNevaluate($ts%))
      WHEN 2,3,4
        ts%=FNsplit_string(ts%,str$)
        $task_buff%=str$
        B%=task_buff%
        C%=ntry%! 8 
        b%! 0 =USR(code_entry%+ 28 )
        IF ?ts%=13 ts%=FNmatch_any_line
        B%=ts%
        C%=ntry%! 8 
        b%! 4 =USR(code_entry%+ 28 )
      WHEN 7
        ts%=FNsplit_string(ts%,str$)
        PROCretrieve_ptr(psup%,s$,b%+ 0 ,fix_up%)
        IF ?ts%=13 ts%=FNmatch_any_line
        PROCretrieve_ptr(psup%,$ts%,b%+ 4 ,fix_up%)
    ENDCASE
  ENDIF
=b%

DEF FNretrieve_list(ntry%,num%,RETURN fix_up%)
  LOCAL i%,ptr%,this_rec%,last_rec%,ts%,list_ptr%,list_off%,int%,str$
    
  IF 1<=num% THEN
    FOR i%=1 TO num%
      B%= &4454534C 
      C%=4*ntry%! 12 + 8 
      this_rec%=USR(code_entry%+ 12 )
      IF this_rec%=0 ERROR  253 ,FNmsg_1(A%! 12 ,"FA5","LSTD")
      IF last_rec% last_rec%! 0 =this_rec% ELSE ptr%=this_rec%
      this_rec%! 0 =0
      this_rec%! 4 =ntry%! 12 
      list_off%=8
      ts%=FNmatch_any_line
      IF ts% THEN
        list_ptr%=ntry%! 8 
        WHILE list_ptr%
          CASE list_ptr%! 4  OF
            WHEN 1
             ts%=FNsplit_integer(ts%,int%)
             this_rec%!list_off%=FNstore_integer(int%)
            WHEN 2,3,4
             ts%=FNsplit_string(ts%,str$)
             $task_buff%=str$
             B%=task_buff%
             C%=list_ptr%! 4 
             this_rec%!list_off%=USR(code_entry%+ 28 )
            WHEN 7
             ts%=FNsplit_string(ts%,str$)
             PROCretrieve_ptr(psup%,str$,this_rec%+list_off%,fix_up%)
          ENDCASE
          list_ptr%=!list_ptr%
          list_off%+=4
        ENDWHILE
      ENDIF
      last_rec%=this_rec%
    NEXT
  ENDIF
=ptr%

DEF FNretrieve_charlist(ntry%,num%)
  LOCAL i%,this_rec%,ts%,last_rec%,ptr%,j%,t$
    
  IF 1<=num% THEN
    FOR i%=1 TO num%
      ts%=FNmatch_any_line
      IF ts% THEN
        t$=FNgstrans($ts%)
        B%= &52414843 
        C%=5+LEN t$
        this_rec%=USR(code_entry%+ 12 )
        IF this_rec%=0 ERROR  253 ,FNmsg_1(A%! 12 ,"FA5","CHAR")
        this_rec%!0=0
        this_rec%?4=ASC t$
        this_rec%?5=LEN t$-1
        t$=MID$(t$,2)
        IF 1<=LEN t$ THEN
          FOR j%=1 TO LEN t$
            this_rec%?(j%+5)=ASC MID$(t$,j%,1)
          NEXT
        ENDIF
        IF last_rec% last_rec%!0=this_rec% ELSE ptr%=this_rec%
      ENDIF
      last_rec%=this_rec%
    NEXT
  ENDIF
=ptr%

DEF PROCretrieve_ptr(psup%,name$,addr%,RETURN fix_up%)
  LOCAL i%,s$,t$,xxxx%,old_last_prdata%,last_prhead%,tmpt%,last_prdata%,prhead%,matched%,this_prdata%,t$
    
  i%=INSTR(name$,":"): IF i%=0 PROCprdata_error(psup%,FNmsg_1(A%! 12 ,"OKAA",name$),"OK2")
  s$=LEFT$(name$,i%-1)
  t$=MID$(name$,i%+1)
   
  tmpt%=psup%! 8 
  prhead%=psup%! 12 
  last_prhead%=0
  WHILE tmpt%
   IF $(tmpt%+ 12 )=s$ THEN
     
    IF VAL t$>0 THEN
     B%= &52544F50 
     C%=LEN name$+1
     i%=USR(code_entry%+ 12 )
     IF i%=0 ERROR  253 ,FNmsg_1(A%! 12 ,"FA5","POTR")
     $i%=name$
     !addr%=i%
     B%= &58585858 
     C%=8
     xxxx%=USR(code_entry%+ 12 )
     IF xxxx%=0 ERROR  253 ,FNmsg_1(A%! 12 ,"FA5","XXXX")
     !xxxx%=fix_up%
     xxxx%!4=addr%
     fix_up%=xxxx%
     ENDPROC
    ELSE
      
     IF prhead% THEN
      last_prdata%=prhead%! 4 
      IF last_prdata% THEN
       WHILE last_prdata%! 0 
        last_prdata%=last_prdata%! 0 
       ENDWHILE
      ENDIF
     ELSE
      last_prdata%=0
     ENDIF
     old_last_prdata%=last_prdata%
     PROCprocess_one_entry(tmpt%,last_prdata%,prhead%,last_prhead%,matched%,fix_up%,psup%)
     IF matched%=0 AND last_prdata%=0 THEN
      ts%=FNmatch_any_line
      IF ts% t$=$ts% ELSE t$=""
      PROCprdata_error(psup%,FNmsg_1(A%! 12 ,"OK9",t$),"OK2")
     ENDIF
      



     this_prdata%=prhead%! 4 
     WHILE this_prdata%<>last_prdata%
       
      IF this_prdata%!(this_prdata%!4*4+8)THEN
       matched%= -1 
       IF 0<=this_prdata%! 4 -1 THEN
         FOR i%=0 TO this_prdata%! 4 -1
          IF NOTFNmatch_prdata_entry(this_prdata%,last_prdata%,i%*4+ 8 )THEN
           matched%= 0 
           i%=this_prdata%! 4 
          ENDIF
         NEXT
       ENDIF
       IF matched% THEN
        IF 0<=last_prdata%! 4 -1 THEN
          FOR i%=0 TO last_prdata%! 4 -1
           xxxx%=last_prdata%!(i%*4+ 8 )
           PROCcheck_prdata_ptr(xxxx%)
           PROCfree_structure(xxxx%)
          NEXT
        ENDIF
        old_last_prdata%! 0 =0
        B%= &54445250 
        C%=last_prdata%
        CALL code_entry%+ 16 
        last_prdata%=this_prdata%
       ELSE
        this_prdata%=!this_prdata%
       ENDIF
      ELSE
       this_prdata%=!this_prdata%
      ENDIF
     ENDWHILE
     B%= &52544F50 
     C%=4
     i%=USR(code_entry%+ 12 )
     IF i%=0 ERROR  253 ,FNmsg_1(A%! 12 ,"FA5","POTR")
     !i%=last_prdata%
     !addr%=i%
      
     last_prdata%!(last_prdata%! 4 *4+ 8 )+=1
     ENDPROC
    ENDIF
   ELSE
    tmpt%=tmpt%! 0 
     

    IF VAL t$=0 THEN
     last_prhead%=prhead%
     prhead%=prhead%! 0 
    ENDIF
   ENDIF
  ENDWHILE
  PROCprdata_error(psup%,FNmsg_1(A%! 12 ,"OKAB",s$),"OK2")
ENDPROC

DEF FNmatch_prdata_entry(s%,d%,o%)
  LOCAL s$,d$
    
  s%=s%!o%
  d%=d%!o%
  IF s%=0 OR d%=0 THEN
    
   =(s%=d%)
  ELSE
   CASE s%!-4 OF
    WHEN  &47544E49 
     =!s%=!d%
    WHEN  &47525453 
     =$s%=$d%
    WHEN  &30525453 
      CALL Z%,s%,s$  
      CALL Z%,d%,d$  
     =s$=d$
    WHEN  &52545347 
      CALL Y%,s%,s$  
      CALL Y%,d%,d$  
     =s$=d$
    WHEN  &4C4f4F42 
     =FNmatch_prdata_bool(s%,d%)
    WHEN  &4454534C 
     =FNmatch_prdata_list(s%,d%)
    WHEN  &52544F50 
     =!s%=!d%
    WHEN  &52414843 
     =FNmatch_prdata_char(s%,d%)
    OTHERWISE
     PROCerror_warning(FNmsg_1(A%! 12 ,"WA10",STR$~s%!-4))
   ENDCASE
  ENDIF
= 0 

DEF FNmatch_prdata_bool(s%,d%)
    
IF FNmatch_prdata_entry(s%,d%, 0 )THEN =FNmatch_prdata_entry(s%,d%, 4 )ELSE = 0 

DEF FNmatch_prdata_list(s%,d%)
  LOCAL i%
    
  WHILE s%
    IF 0<=s%! 4 -1 THEN
      FOR i%=0 TO s%! 4 -1
        IF NOT FNmatch_prdata_entry(s%,d%,i%*4+ 8 )THEN = 0 
      NEXT
    ENDIF
    s%=s%! 0 
    d%=d%! 0 
  ENDWHILE
= -1 

DEF FNmatch_prdata_char(s%,d%)
  LOCAL i%
    
  WHILE s%
   IF s%?4<>d%?4 THEN = 0 
   IF s%?5<>d%?5 THEN = 0 
   i%=s%?5
   WHILE i%
     IF s%?(i%+5)<>d%?(i%+5)THEN = 0 
     i%-=1
   ENDWHILE
   s%=!s%
   d%=!d%
  ENDWHILE
= -1 

DEF FNsplit_integer(input%,RETURN int%)
  LOCAL i%,output%
   
  i%=INSTR($input%,",")
  IF i%=0 THEN
    int%=FNevaluate($input%)
    output%=input%+LEN $input%
  ELSE
    int%=FNevaluate(LEFT$($input%,i%-1))
    output%=input%+i%
    WHILE ?output%=32
      output%+=1
    ENDWHILE
  ENDIF
=output%

DEF FNsplit_string(input%,RETURN str$)
  LOCAL i%,output$,outside%,quoted%
   
  str$=""
  i%=0
  WHILE input%?i%=32
    i%+=1
  ENDWHILE
  outside%= -1 
  quoted%=(input%?i%=34)
   
  WHILE NOT(input%?i%=13 OR(outside% AND input%?i%=44))
     

    IF NOT quoted% OR input%?i%<>34 OR outside% str$+=CHR$ input%?i%

    IF quoted% AND input%?i%=34 outside%=NOT outside%
    i%+=1
  ENDWHILE
  



  IF input%?i%=13 THEN
    output%=input%+i%
  ELSE
    output%=input%+i%+1
    WHILE ?output%=32
      output%+=1
    ENDWHILE
  ENDIF
=output%

DEF FNload_file(name$)
  LOCAL c%,i%,load_addr%,file_type%,ws_size%,ws%,output_size%,output%,status%,err%
    
  SYS "OS_File",17,name$ TO c%,,load_addr%,,data_size%  
  IF NOT(c%=0 OR c%=1)THEN SYS "OS_File",19,name$,c%  
  IF c%=0 THEN = 0 
  IF(load_addr%>>>20)=&FFF file_type%=load_addr%>>8 AND &FFF ELSE file_type%=-1
  IF file_type%<>&FC6 ERROR  254 ,FNmsg_1(A%! 12 ,"OKAL",name$)
  B%= &41544144 
   
  C%=4+data_size%+1
    
  data_block%=USR(code_entry%+ 12 )+4
  IF data_block%=4 ERROR  253 ,FNmsg_1(A%! 12 ,"FA5","DATA")
  SYS "OS_File",16,name$,data_block%  

   
  IF data_size%>=20 AND data_block%!0=&48535153 THEN
     

    SYS "Squash_Decompress",%1000,-1 TO ws_size%
    output_size%=data_block%!4

     
    B%= &41544144 
    C%=4+output_size%+1
      
    output%=USR(code_entry%+ 12 )+4
    IF output%=4 ERROR  253 ,FNmsg_1(A%! 12 ,"FA5","DATA")

      
    SYS "XOS_Module",6,,,ws_size% TO C%,,ws%;err%
    IF(err%AND1) ERROR  253 ,FNmsg_1(A%! 12 ,"FA5","squash")

     
    SYS "Squash_Decompress",%100,ws%,data_block%+20,data_size%-20,output%,output_size% TO status%

     
      
    SYS "OS_Module",7,,ws%

      
    B%= &41544144 
    C%=data_block%-4
    CALL code_entry%+ 16 

     
    data_block%=output%
    data_size%=output_size%
  ENDIF

  data_ptr%=data_block%-4
  !data_ptr%=0
  data_line%=1

   
  B%=data_block%
  C%=data_size%
  CALL code_entry%+ 52 
  IF data_block%?(data_size%-1)<>13 data_size%+=1: data_block%?(data_size%-1)=13

  data_file$=name$
    
= -1 

DEF PROCrelease_file
    
  B%= &41544144 
  C%=data_block%-4
    
  CALL code_entry%+ 16 
  data_block%=0
  data_size%=0
ENDPROC

DEF PROClocal_file
   

    
  saved_data_block%=data_block%
  saved_data_ptr%=data_ptr%
  saved_data_size%=data_size%
  saved_data_line%=data_line%
  saved_data_file$=data_file$
ENDPROC

DEF PROCrestore_file
   
    
  data_block%=saved_data_block%
  data_ptr%=saved_data_ptr%
  data_size%=saved_data_size%
  data_line%=saved_data_line%
  data_file$=saved_data_file$
ENDPROC

DEF PROCinstall_printer(psup%,prdt%)
  LOCAL s%,t%,s$,prnt%,cnct%
    
   

    
    
    
    

  prdt%!(prdt%! 4 *4+ 8 )+=1
  B%= &544E5250 
  C%= 68 
  prnt%=USR(code_entry%+ 12 )
  IF prnt%=0     ERROR  253 ,FNmsg_1(A%! 12 ,"FA5","PRNT")

  IF A%! 48  THEN
    s%=A%! 48 
    WHILE s%! 0 
      s%=s%! 0 
    ENDWHILE
    s%! 0 =prnt%
  ELSE
    A%! 48 =prnt%
  ENDIF
  prnt%! 0 =0
  prnt%! 4 =psup%
  B%=prdt%! 8 
  C%=2
  prnt%! 8 =USR(code_entry%+ 28 )
  B%= &54434E43 
  C%= 36 
  cnct%=USR(code_entry%+ 12 )
  IF cnct%=0     ERROR  253 ,FNmsg_1(A%! 12 ,"FA5","CNCT")

  SYS "OS_Byte",161,15 TO,,s%
  cnct%! 0 =(s% AND %11100000)>>5
  cnct%? 4 =1+((s% AND %11100)>>2)
  cnct%? 5 =0
  SYS "OS_Byte",161,16 TO,,s%
  cnct%! 8 =(s% AND %11100000)>>5
  IF NOT FNeconet_installed THEN
    cnct%! 12 =0
  ELSE
    SYS "OS_Byte",161,3 TO,,s%
    SYS "OS_Byte",161,4 TO,,t%
    IF s% THEN
       
      $task_buff%=STR$ t%+"."+STR$ s%
      B%=task_buff%
      C%=2
      cnct%! 12 =USR(code_entry%+ 28 )
    ELSE
      s$=CHR$ t%
      FOR s%=1 TO 5
        SYS "OS_Byte",161,152+s% TO,,t%
        IF t% s$+=CHR$ t% ELSE s%=5
      NEXT
      $task_buff%=s$
      B%=task_buff%
      C%=2
      cnct%! 12 =USR(code_entry%+ 28 )
    ENDIF
  ENDIF
  SYS "XOS_ReadVarVal","PrinterType$5",buff1%,256,,3 TO,,t%
  buff1%?t%=13
  B%=buff1%
  C%=2
  cnct%! 16 =USR(code_entry%+ 28 )
  cnct%! 20 =0
  cnct%! 24 =0
  cnct%! 28 =0
  cnct%! 32 =0
  cnct%? 6 =0
  prnt%! 12 =cnct%
  B%= &47464E43 
  C%=4*psup%! 36 
  s%=USR(code_entry%+ 12 )
  IF s%=0 ERROR  253 ,FNmsg_1(A%! 12 ,"FA5","CNFG")
  IF 0<=psup%! 36 -1 THEN
    FOR t%=0 TO psup%! 36 -1
      s%!(t%*4)=0
    NEXT
  ENDIF
  prnt%! 16 =s%
  prnt%! 20 =-1  
  prnt%! 24 =0  
  prnt%! 28 =-1  
  prnt%! 32 =0  

   
  prnt%! 36 =0  
  prnt%! 40 =0  
  prnt%! 44 =0  
  IF psup%! 32  AND %100 THEN
     
    prnt%! 48 =FNallocate_pause_window
  ELSE
    prnt%! 48 =0
  ENDIF
  prnt%! 52 =0
  PROCprinter_reason_code(psup%,prnt%,-4,0)
  IF psup%! 24  AND  4  PROCprinter_reason_code(psup%,prnt%,-12,0)
  PROCcreate_installed_printer_icons  

  IF psup%! 24  AND  8  THEN
    prnt%! 56 =10*psup%?( 24 +1)
  ELSE
    prnt%! 56 =-1
  ENDIF
    

   
  PROCactivate_this_printer(prnt%)
ENDPROC


DEF PROCfind_prnt(RETURN prnt%, RETURN rmtp%, RETURN icon%)
   



    
  SYS "Wimp_WhichIcon",prntctrl%,buff1%,1<<21,1<<21
  icon%=!buff1%
  rmtp% = 0
  prnt%=A%! 48 

  WHILE prnt%
    IF prnt%! 28 =icon% THEN
      ENDPROC
    ELSE 
      prnt%=prnt%! 0 
    ENDIF
  ENDWHILE

  rmtp% = remote_printers%
  WHILE rmtp%
    IF rmtp%! 16  = icon% THEN
      ENDPROC
    ELSE
      rmtp% = rmtp%! 0 
    ENDIF
  ENDWHILE

ENDPROC

DEF PROCfind_only_prnt (RETURN prnt%,RETURN icon%)

    
  SYS "Wimp_WhichIcon",prntctrl%,buff1%,1<<21,1<<21
  icon%=!buff1%
  rmtp% = 0
  prnt%=A%! 48 

  WHILE prnt%
    IF prnt%! 28 =icon% THEN
      ENDPROC
    ELSE 
      prnt%=prnt%! 0 
    ENDIF
  ENDWHILE

ENDPROC

DEF PROCfind_only_rmtp (RETURN rmtp%, RETURN icon%)

    
  SYS "Wimp_WhichIcon",prntctrl%,buff1%,1<<21,1<<21
  icon%=!buff1%

  rmtp% = remote_printers%
  WHILE rmtp%
    IF rmtp%! 16  = icon% THEN
      ENDPROC
    ELSE
      rmtp% = rmtp%! 0 
    ENDIF
  ENDWHILE

ENDPROC















DEF PROCopen_connections_window(prnt%)
  LOCAL cnct%,i%,databits%,parity%,stopbits%
    
  IF prnt%! 24  AND  8      ERROR  254 ,FNmsg_0(A%! 12 ,"OKAJ")

  prnt_edit%=prnt%
  psup_edit%=prnt%! 4 
  cnct%=prnt%! 12 


  IF prnt%! 24  AND  (1<<17)  THEN
    ENDPROC  
  ENDIF


  IF psup_edit%! 24  AND  4  THEN
      
    PROCprinter_reason_code(psup_edit%,prnt_edit%,-11,0)
    PROCtell_pinboard(FNprinter_find_window(prnt_edit%,"connections"))
    PROCwin_open(FNprinter_find_window(prnt_edit%,"connections"))
  ELSE
      
    IF prnt%! 40        PROCicon_write(connections%, 31 ,$prnt%! 40 )     ELSE       PROCicon_write(connections%, 31 ,$prnt%! 8 )



    IF cnct%? 6  AND  1        PROCicon_select(connections%, 37 )     ELSE       PROCicon_deselect(connections%, 37 )



    PROCicon_deselect(connections%, 0 )
    PROCicon_deselect(connections%, 1 )
    PROCicon_deselect(connections%, 2 )
    PROCicon_deselect(connections%, 3 )
    PROCicon_deselect(connections%, 4 )
    PROCicon_deselect(connections%, 33 )
    i%=-1
    CASE cnct%! 0  OF
      WHEN 1
        i%= 0 
      WHEN 2
        i%= 1 
      WHEN 4
        IF FNeconet_installed i%= 2 
      WHEN 5
        i%= 4 
      WHEN 6
        IF FNnfs_installed i%= 3 
      WHEN 8
        IF psup_edit%! 24  AND  16  i%= 33 
    ENDCASE
    IF NOT i% PROCicon_select(connections%,i%)
    PROCicon_write(connections%, 15 ,        FNmsg_0(A%! 12 ,        "BR"+STR$ cnct%? 4 ))


    i%=cnct%! 8 
    databits%=i% AND %11
    stopbits%=(i% AND %100)>>2
    parity%=(i% AND %110000)>>4
    IF(i% AND %1000)=0 parity%=0 ELSE parity%+=1
    PROCicon_write(connections%, 17 ,        FNmsg_0(A%! 12 ,"DA"+STR$ databits%))

    PROCicon_write(connections%, 18 ,        FNmsg_0(A%! 12 ,"PA"+STR$ parity%))

    IF stopbits%=0 THEN
      PROCicon_write(connections%, 19 ,          FNmsg_0(A%! 12 ,"SB0"))

    ELSE
      IF databits%=0 AND parity%<>0 THEN
        PROCicon_write(connections%, 19 ,            FNmsg_0(A%! 12 ,"SB1b"))

      ELSE
        IF databits%=3 AND parity%=0 THEN
          PROCicon_write(connections%, 19 ,              FNmsg_0(A%! 12 ,"SB1c"))

        ELSE
          PROCicon_write(connections%, 19 ,              FNmsg_0(A%! 12 ,"SB1a"))

        ENDIF
      ENDIF
    ENDIF
    IF cnct%? 5        PROCicon_select(connections%, 13 )     ELSE       PROCicon_deselect(connections%, 13 )



    IF cnct%? 6  AND  2        PROCicon_select(connections%, 35 )     ELSE       PROCicon_deselect(connections%, 35 )




    PROCset_string(connections%, 25 ,cnct%, 12 )
    PROCset_string(connections%, 26 ,cnct%, 20 )
    PROCset_string(connections%, 27 ,cnct%, 24 )
    PROCset_string(connections%, 28 ,cnct%, 28 )
    PROCset_string(connections%, 29 ,cnct%, 32 )

     
    IF cnct%! 16  <> 0 THEN
      IF ?(cnct%! 16 ) > 32 AND ?(cnct%! 16 ) < 127         PROCset_string(connections%, 30 ,cnct%, 16 )       ELSE         PROCicon_write(connections%, 30 ,"null:")



    ELSE
        PROCicon_write(connections%, 30 ,"null:")
    ENDIF

    IF FNeconet_installed        PROCicon_unshade(connections%, 2 )     ELSE        PROCicon_shade(connections%, 2 )




    IF FNnfs_installed       PROCicon_unshade(connections%, 3 )     ELSE       PROCicon_shade(connections%, 3 )




     
    !win_buff%=connections%
    SYS "Wimp_GetWindowInfo",,win_buff% OR 1  
    win_buff%!28=-1
    


     
    IF psup_edit%! 24  AND  16        PROCicon_unshade(connections%, 33 )     ELSE       PROCicon_shade(connections%, 33 )




    PROCtell_pinboard(connections%)
    SYS "Wimp_OpenWindow",,win_buff%
    PROCcheck_shaded_connections
  ENDIF
ENDPROC

DEF PROCset_string(wind%,icon%,block%,offset%)
    
  PROCicon_write(wind%,icon%,FNprinter_read_string(block%!offset%))
ENDPROC

DEF PROCreset_string(block%,offset%,icon%)
   

    
  IF block%!offset% THEN
   B%= &47525453 
   C%=block%!offset%
   CALL code_entry%+ 16 
   block%!offset%=0
  ENDIF
  !icon_buffer%=connections%
  icon_buffer%!4=icon%
  SYS "Wimp_GetIconState",,icon_buffer%
  B%=icon_buffer%!28
  C%=2
  block%!offset%=USR(code_entry%+ 28 )
ENDPROC

DEF FNnew_databits
    
=FNmatch_option(connections%, 17 ,3,"DA",A%! 12 )

DEF FNnew_parity
    
=FNmatch_option(connections%, 18 ,4,"PA",A%! 12 )

DEF FNnew_stopbits
    
IF FNicon_read(connections%, 19 )=FNmsg_0(A%! 12 ,"SB0")THEN =0 ELSE =1

DEF PROCensure_new_stopbits(new%)
    
  IF new%=-1 new%=FNnew_stopbits
  IF new%=0 THEN
    PROCicon_write(connections%, 19 ,FNmsg_0(A%! 12 ,"SB0"))
  ELSE
    IF FNnew_databits=0 AND FNnew_parity<>0 THEN
      PROCicon_write(connections%, 19 ,FNmsg_0(A%! 12 ,"SB1b"))
    ELSE
      IF FNnew_databits=3 AND FNnew_parity=0 THEN
        PROCicon_write(connections%, 19 ,FNmsg_0(A%! 12 ,"SB1c"))
      ELSE
        PROCicon_write(connections%, 19 ,FNmsg_0(A%! 12 ,"SB1a"))
      ENDIF
    ENDIF
  ENDIF
ENDPROC

DEF FNmatch_option(wind%,icon%,limit%,prefix$,desc%)
  LOCAL i%,s$
    
  s$=FNicon_read(wind%,icon%)
  IF 0<=limit% THEN
    FOR i%=0 TO limit%
      IF s$=FNmsg_0(desc%,prefix$+STR$ i%)THEN =i%
    NEXT
  ENDIF
=0

DEF PROCsave_connection
  LOCAL cnct%,i%,claim$,s$
    
  cnct%=prnt_edit%! 12 
  cnct%! 0 =0
  IF FNicon_set(connections%, 37 ) THEN
    cnct%? 6 =cnct%? 6  OR  1 
  ELSE
    cnct%? 6 =cnct%? 6  AND NOT  1 
  ENDIF
  IF FNicon_set(connections%, 0 )THEN
    claim$=FNdevice_claim(1,prnt_edit%)
    IF claim$=""       cnct%! 0 =1     ELSE       ERROR  254 ,FNmsg_1(A%! 12 ,"OKI",claim$)



  ENDIF
  IF FNicon_set(connections%, 1 )THEN
    claim$=FNdevice_claim(2,prnt_edit%)
    IF claim$=""       cnct%! 0 =2     ELSE       ERROR  254 ,FNmsg_1(A%! 12 ,"OKJ",claim$)



  ENDIF
  IF FNicon_set(connections%, 2 )cnct%! 0 =4
  IF FNicon_set(connections%, 3 )cnct%! 0 =6
  IF FNicon_set(connections%, 4 )cnct%! 0 =5
  IF FNicon_set(connections%, 33 )cnct%! 0 =8
  s$=FNicon_read(connections%, 15 )
  FOR i%=0 TO 18
    IF FNmsg_0(A%! 12 ,"BR"+STR$ i%)=s$ THEN
      cnct%? 4 =i%
      i%=18
    ENDIF
  NEXT
  i%=FNnew_databits OR FNnew_stopbits<<2
   
  IF FNnew_parity i%=i% OR FNnew_parity-1<<4 OR %1000
  cnct%! 8 =i%
  IF FNicon_set(connections%, 13 ) THEN
   cnct%? 5 =1
  ELSE
   cnct%? 5 =0
  ENDIF
  IF FNicon_set(connections%, 35 ) THEN
   cnct%? 6 =cnct%? 6  OR  2 
  ELSE
   cnct%? 6 =cnct%? 6  AND NOT  2 
  ENDIF
  PROCreset_string(cnct%,12,25)
  PROCreset_string(cnct%,20,26)
  PROCreset_string(cnct%,24,27)
  PROCreset_string(cnct%,28,28)
  PROCreset_string(cnct%,32,29)
  PROCreset_string(cnct%,16,30)
  PROCredraw_prntctrl_entry(prnt_edit%)
  PROCredraw_queue_entry(-1,prnt_edit%,0)
  IF NOT prnt_edit%! 20  THEN
     





    IF prnt_edit%! 24  AND  2  THEN
        
      PROCselect_printer(prnt_edit%, -1 , 0 )
    ENDIF
    PROCprinter_status(prnt_edit%)
  ENDIF
ENDPROC

DEF PROCprinter_status(prnt%)
   
  LOCAL new_text$,i%,sprite$,st$,icon_set%,psup%
    
  IF prnt%! 20 =-1 ENDPROC  
  psup%=prnt%! 4 
  new_text$=FNiconbar_string(prnt%)
  IF prnt%! 44  sprite$=$prnt%! 44  ELSE sprite$=$psup%! 4 
  st$="ss_"+sprite$+","+sprite$
  !buff1%=-1
  buff1%!4=prnt%! 20 
  SYS "Wimp_GetIconState",,buff1%
  icon_set%=buff1%!24 AND 1<<21
  IF new_text$<>$buff1%!28 OR st$<>$buff1%!32 THEN
    i%=FNiconbar_tands(new_text$,sprite$,-4,prnt%! 20 )
    PROCicon_delete(-1,prnt%! 20 )
    prnt%! 20 =i%
    IF icon_set% PROCicon_select(-1,i%)
  ENDIF
ENDPROC

DEF FNiconbar_string(prnt%)
  LOCAL cnct%,queu%
    
  IF prnt%! 24  AND  4  THEN =FNmsg_0(A%! 12 ,"QU1")
  IF prnt%! 24  AND  8  THEN
     
    queu%=prnt%! 32 
    IF queu%? 11  AND 1 THEN =FNmsg_0(A%! 12 ,"QU1")ELSE =FNmsg_0(A%! 12 ,"QU2")
  ENDIF
  IF prnt%! 24  AND  32  THEN =FNmsg_0(A%! 12 ,"QU3")
  IF prnt%! 40  THEN =$prnt%! 40 
  cnct%=prnt%! 12 
  CASE cnct%! 0  OF
    WHEN 0,1,2,5
      =FNmsg_0(A%! 12 ,"IC"+STR$cnct%! 0 )
    WHEN 4
      =$cnct%! 12 
    WHEN 6
      =$cnct%! 24 
  ENDCASE
=""

DEF PROCbuild_printer_menu
  LOCAL offset%,status%,list%,i%,s$,indirected_title%
  B%= &5453494C 
  C%=2048
  list%=USR(code_entry%+ 12 )
  IF list%=0 ERROR  253 ,FNmsg_1(A%! 12 ,"FA5","LIST")
   





  SYS "XNetPrint_ListServers",1,list%,2048,500 TO offset%;i%
  IF i% AND 1     i%=offset%+4:     CALL Z%,i%,s$:       ERROR  254 ,s$



  PROCmenu_create(menu%,FNmsg_0(A%! 12 ,"ME6"))
  indirected_title%=(menu%!28 AND &100)<>0
  status%=list%
  i%=0
  WHILE i%<offset%
    CALL Z%,status%,s$
    status%+=LEN s$+1
    PROCmenu_item(menu%,i%,s$,indirected_title%)
    i%+=1
  ENDWHILE
  B%= &5453494C 
  C%=list%
  CALL code_entry%+ 16 
ENDPROC


DEF PROCactivate_printer
  LOCAL prnt%,cnct%,icon%, err%
  LOCAL rmtp%, junk%, tmplist%, thing%, othing%
    

  REPEAT
    PROCfind_only_prnt(prnt%, icon%)
       
    IF prnt% THEN
      PROCicon_deselect(prntctrl%,icon%)
      IF(prnt%! 24  AND  1 )=0 PROCactivate_this_printer(prnt%)
       




      IF (prnt%! 24  AND  (1<<16) ) THEN
        PROCunshare_one_printer (prnt%)
      ENDIF
    ENDIF
  UNTIL prnt% = 0
      
  tmplist% = 0

  SYS "Hourglass_On"

  REPEAT
    PROCfind_only_rmtp (rmtp%, icon%)
    IF rmtp% THEN
     IF rmtp%! 20  <= 0 THEN
      PROCicon_deselect(prntctrl%,icon%)
        
      thing% = FNconstruct_rmtp (rmtp%! 4 , rmtp%! 8 , rmtp%! 12 )
      PROCadd_to_list (tmplist%, thing%)

     ENDIF
    ENDIF
  UNTIL rmtp% = 0

  thing% = tmplist%

  WHILE thing%
    junk% = FNensure_printer(thing%, 0,  0 ,  0 , err%)
    PROCremove_from_list (remote_printers%, $thing%! 4 )
    othing% = thing%
    thing% = thing%! 0 
    PROCfree ( &524D5450 , othing%)
  ENDWHILE

  SYS "Hourglass_Off"

ENDPROC
















DEF PROCactivate_this_printer(prnt%)
    
  prnt%! 24 =prnt%! 24  OR  1 
  cnct%=prnt%! 12 
  PROCcreate_printer_icon(prnt%)
  PROCflush_queue(prnt%)
   
  IF A%! 44 =1 THEN
      
    PROCselect_printer(prnt%, -1 , 0 )
  ENDIF
ENDPROC

DEF PROCcreate_printer_icon(prnt%)
  LOCAL s$,i%,side%,psup%
    
  psup%=prnt%! 4 
  IF prnt%! 44  THEN
   s$=$prnt%! 44 
     
  ELSE
   s$=$psup%! 4 
     
  ENDIF
  i%=FNright_of(prnt%)
  side%=-4
  IF i%=-1 THEN
    i%=FNleft_of(prnt%)
    side%=-3
  ENDIF
  IF i%=-1 THEN
    i%=&0F000000
    side%=-5
  ENDIF
  prnt%! 20 =FNiconbar_tands(FNiconbar_string(prnt%),s$,side%,i%)
  IF got_icon% THEN
    PROCicon_delete(-1,main_icon%)
    got_icon%= 0 
  ENDIF
  A%! 44 +=1
ENDPROC

DEF FNright_of(prnt%)
    
   
  LOCAL icon%,l_prnt%
  IF got_icon% THEN
    icon%=main_icon%
  ELSE
     

    icon%=-1
    l_prnt%=A%! 48 
    WHILE l_prnt%
      IF NOT l_prnt%! 20  icon%=l_prnt%! 20 
      IF l_prnt%=prnt% l_prnt%=0 ELSE l_prnt%=l_prnt%! 0 
    ENDWHILE
  ENDIF
=icon%

DEF FNleft_of(prnt%)
   

    
  WHILE prnt%! 20 =-1
    prnt%=prnt%! 0 
    IF prnt%=0 THEN =-1
  ENDWHILE
=prnt%! 20 

DEF PROCcreate_main_icon
    
  



    main_icon%=FNiconbar_tands(FNmsg_0(A%! 12 ,"NNE"),        "s"+FNmsg_0(A%! 12 ,"IC"),-5,&0F000000)

  
  got_icon%= -1 
  !task_buff%=A%! 40 
  PROCclose_window
ENDPROC


DEF PROCdeactivate_printer
  LOCAL prnt%,icon%,doit%, name$, othing%
  LOCAL rmtp%, doit%, tmplist%, thing%, prnt%

  tmplist% = 0

    

  REPEAT
    PROCfind_prnt(prnt%, rmtp%, icon%)

    PROCicon_deselect(prntctrl%,icon%)

    IF prnt% THEN
      IF prnt%! 24  AND  (1<<17)  THEN
        thing% = FNconstruct_rmtp (0, 0, prnt%)
        PROCadd_to_list (tmplist%, thing%)
      ELSE
        PROCdeactivate_this_printer(prnt%)
      ENDIF
    ENDIF

    IF rmtp% AND rmtp%! 20  > 0 THEN
      PROCremove_unavailable_printer ($rmtp%! 4 )
  
      IF FNunavailable_count = 0 AND A%! 44  = 0 THEN
        PROCcreate_main_icon
      ENDIF
    ENDIF

  UNTIL prnt% = 0 AND rmtp% = 0

  thing% = tmplist%
  WHILE thing%    
    prnt% = thing%! 12 
    name$ = $prnt%! 40 
    PROCremove_one_printer (prnt%)
    PROCadd_remote_printer (name$)
    othing% = thing%
    thing% = thing%! 0 
    PROCfree ( &524D5450 , othing%)
  ENDWHILE

  PROCcreate_installed_printer_icons

  IF selected_prnt%=0 THEN
    IF A%! 44  THEN
      doit%=A%! 48 
      WHILE doit%
        IF NOT doit%! 20  THEN
            
          PROCselect_printer(doit%, -1 , 0 )
          doit%=0
        ELSE
          doit%=doit%! 0 
        ENDIF
      ENDWHILE
    ENDIF
  ENDIF
ENDPROC



































DEF PROCdeactivate_this_printer(prnt%)
    

  LOCAL was_remote%


  IF prnt%! 24  AND  (1<<16)  THEN
    PROCunshare_one_printer (prnt%)
  ENDIF
  IF prnt%! 24  AND  (1<<17)  THEN
    was_remote% =  -1 
  ENDIF


  IF prnt%! 24  AND  1  THEN

        IF prnt%! 24  AND  (1<<17)  THEN
          doit% =  -1   
        ELSE
          IF prnt%! 32  THEN
            doit%=FNquery("WA2",$prnt%! 8 )
          ELSE
            doit%= -1 
          ENDIF
        ENDIF



    IF doit% THEN
       
      PROCprinter_reason_code(prnt%! 4 ,prnt%,-10,0)
      IF NOT prnt%! 20  THEN

        IF A%! 44 =1 AND FNunavailable_count=0 THEN
          PROCcreate_main_icon  
        ENDIF
        IF A%! 44 =1 AND FNunavailable_count>0 THEN
          !task_buff%=A%! 40 
          PROCclose_window
        ENDIF



        PROCicon_delete(-1,prnt%! 20 )
        prnt%! 20 =-1
        A%! 44 -=1
      ENDIF
       
      prnt%! 24 =prnt%! 24  AND NOT  63+65536 
      IF selected_prnt%=prnt% SYS"PDriver_SelectDriver",-1:selected_prnt%=0
      PROCflush_queue(prnt%)
    ENDIF
  ENDIF

ENDPROC

DEF PROCremove_printer
  LOCAL i%,prnt%,ptr%,last_prnt%,private_buff%,doit%,type$
    
   
  B%= &58585858 
  C%=256
  private_buff%=USR(code_entry%+ 12 )
  IF private_buff%=0     ERROR  253 ,FNmsg_1(A%! 12 ,"FA5","XXXX")

  SYS "Wimp_WhichIcon",prntctrl%,private_buff%,1<<21,1<<21
  ptr%=private_buff%
  SYS "Hourglass_On"
  WHILE NOT !ptr%
    i%=!ptr%
    prnt%=A%! 48 
    last_prnt%=0
    WHILE prnt%

      


     IF ((prnt%! 24  AND  (1<<17) ) = 0) AND prnt%! 28 =i% THEN



       IF prnt%! 32  THEN
          SYS "Hourglass_Off"
          doit%=FNquery("WA3",$prnt%! 8 )
          SYS "Hourglass_On"
          IFdoit% PROCflush_queue(prnt%)
       ELSE
         doit%= -1 
       ENDIF
       IF doit% THEN
        type$=$prnt%! 8 
         PROCremove_this_printer(prnt%,last_prnt%)
         PROCdelete_prdata_entry(type$)
       ENDIF
       prnt%=0
     ELSE
       last_prnt%=prnt%
       prnt%=prnt%! 0 
     ENDIF
    ENDWHILE
    ptr%+=4
  ENDWHILE
  IF selected_prnt%=0 THEN
     
    IF A%! 44  THEN
      doit%=A%! 48 
      WHILE doit%
        IF NOT doit%! 20  THEN
            
          PROCselect_printer(doit%, -1 , 0 )
          doit%=0
        ELSE
          doit%=doit%! 0 
        ENDIF
      ENDWHILE
    ENDIF
  ENDIF
   
  IF selected_prnt%=0 PROCtell_the_world
  B%= &58585858 
  C%=private_buff%
  CALL code_entry%+ 16 
   
  PROCcreate_installed_printer_icons
  PROCwin_open(prntctrl%)
  SYS "Hourglass_Off"
ENDPROC

DEF PROCremove_this_printer(prnt%,last_prnt%)
  LOCAL j%,i%,size%,psup%,prdt%
    
  psup%=prnt%! 4 
  prdt%=psup%! 12 
  prdt%=prdt%! 4 
   
  PROCprinter_reason_code(psup%,prnt%,-9,0)
  PROCdeactivate_this_printer(prnt%)

   
  WHILE prdt%
    IF$prdt%! 8 =$prnt%! 8  THEN
       
      prdt%!(prdt%! 4 *4+ 8 )-=1
      prdt%=0
    ELSE
      prdt%=prdt%! 0 
    ENDIF
  ENDWHILE

   
  IF prnt_edit%=prnt% THEN
    !task_buff%=connections%
    PROCclose_window
  ENDIF

  i%=psup%! 20 
  WHILE i%
   IF i%! 12 =prnt% THEN
     !task_buff%=i%! 4 
     PROCclose_window
   ENDIF
   i%=i%! 0 
  ENDWHILE

  IF prnt%! 48      PROCdeallocate_pause_window(prnt%! 48 )

  IF selected_prnt%=prnt% selected_prnt%=0
    
  PROCfree_structure(prnt%! 8 )  

   
    
  j%=prnt%! 12 
  IF (psup%! 24  AND  4 ) THEN
     
    size% = psup%! 48 
    IF 1 <= size% THEN
      FOR i%=1 TO size%
        PROCfree_structure(!j%)
        j%+=4
      NEXT
    ENDIF
  ELSE
    PROCfree_structure(j%! 12 )  
    PROCfree_structure(j%! 16 )  
    PROCfree_structure(j%! 20 )  
    PROCfree_structure(j%! 24 )  
    PROCfree_structure(j%! 28 )  
    PROCfree_structure(j%! 32 )  
  ENDIF
  B%= &54434E43 
  C%=j%
  CALL code_entry%+ 16 

   
    
  j%=prnt%! 16 
  IF j% THEN
    size%=psup%! 36 
    IF 0<=size%-1 THEN
      FOR i%=0 TO size%-1
        PROCfree_structure(j%!(i%*4))
      NEXT
    ENDIF
  ENDIF
  B%= &47464E43 
  C%=j%
  CALL code_entry%+ 16 

  !task_buff%=prntctrl%
  task_buff%!4=prnt%! 28 
  SYS "Wimp_GetIconState",,task_buff%
   








  task_buff%!8=1<<7 OR 1<<23
  task_buff%!12=1<<7 OR 1<<23 OR 1<<21
  SYS "Wimp_SetIconState",,task_buff%
















  j%=prnt%! 52 
  WHILE j%
    PROCfree_structure(j%! 4 )
    PROCfree_structure(j%! 8 )
    i%=j%! 0 
    B%= &544E4F46 
    C%=j%
    CALL code_entry%+ 16 
    j%=i%
  ENDWHILE
  j%=prnt%! 0 
  B%= &544E5250 
  C%=prnt%
  CALL code_entry%+ 16 

  IF last_prnt% THEN
    last_prnt%! 0 =j%
  ELSE
    A%! 48 =j%
  ENDIF
   


ENDPROC

DEF FNquery(tag$,p1$)
  LOCAL x%,y%,w%,h%
    
  PROCicon_write(query%, 0 ,FNmsg_1(A%! 12 ,tag$,p1$))
  PROCicon_write(query%, 3 ,FNmsg_0(A%! 12 ,tag$+"a"))
  SYS "Wimp_GetPointerInfo",,task_buff%
  x%=!task_buff%
  y%=task_buff%!4
  !task_buff%=query%
  SYS "Wimp_GetWindowState",,task_buff%
  w%=task_buff%!12-task_buff%!4
  h%=task_buff%!16-task_buff%!8
  task_buff%!4=x%-340  
  task_buff%!8=y%-120  
  task_buff%!12=task_buff%!4+w%
  task_buff%!16=task_buff%!8+h%
  task_buff%!28=-1
  SYS "Wimp_OpenWindow",,task_buff%
  PROCbound_mouse(query%)
  query_state%=0
  REPEAT
      
    PROCdespatch_poll(click_mask%)
  UNTIL query_state%
    
  !task_buff%=query%
  PROCclose_window
  PROCunbound_mouse
=(query_state%= 3 )

DEF PROCbound_mouse(h%)
   
    
  !task_buff%=h%
  SYS "Wimp_GetWindowOutline",,task_buff%
  ?task_buff%=1
  task_buff%!1=task_buff%!4
  task_buff%!3=task_buff%!8
  task_buff%!5=task_buff%!12
  task_buff%!7=task_buff%!16
  SYS "OS_Word",21,task_buff%
ENDPROC

DEF PROCunbound_mouse
  LOCAL mc_sw%,mc_dx%,mc_sh%,mc_dy%,scrx%,scry%
    
  SYS "OS_ReadModeVariable",-1,4 TO,,mc_dx%
  mc_dx%=1<<mc_dx%
  SYS "OS_ReadModeVariable",-1,5 TO,,mc_dy%
  mc_dy%=1<<mc_dy%
  SYS "OS_ReadModeVariable",-1,11 TO,,mc_sw%
  mc_sw%+=1
  SYS "OS_ReadModeVariable",-1,12 TO,,mc_sh%
  mc_sh%+=1
  scrx%=mc_sw%*mc_dx%
  scry%=mc_sh%*mc_dy%
  ?task_buff%=1
  task_buff%!1=0
  task_buff%!3=0
  task_buff%!5=scrx%
  task_buff%!7=scry%
  SYS "OS_Word",21,task_buff%
ENDPROC

DEF PROCcreate_installed_printer_icons
  LOCAL prnt%,ptr%,i%

  LOCAL rmtp%

    
  !buff1%=prntctrl%
  IF printer_count% THEN
    FOR i%=0 TO printer_count%-1
      buff1%!4=i%+4
      SYS "Wimp_DeleteIcon",,buff1%
    NEXT
  ENDIF

  IF remote_printer_count% THEN
    FOR i% = printer_count% TO printer_count%+remote_printer_count%
      buff1%!4=i%+4
      SYS "Wimp_DeleteIcon",,buff1%
    NEXT
  ENDIF


 





  printer_count%=0

  remote_printer_count% = 0

  !buff1%=prntctrl%
  buff1%!4=0
  buff1%!8=prntctrl_icdf%(4)!4  
  buff1%!12=1030
  buff1%!16=prntctrl_icdf%(4)!12
  buff1%!20=prntctrl_icdf%(4)!16
  buff1%!24=prntctrl_icdf%(4)!20
  buff1%!28=prntctrl_icdf%(4)!24
  buff1%!32=prntctrl_icdf%(4)!28
  prnt%=A%! 48 
  WHILE prnt%
    SYS "Wimp_CreateIcon",,buff1% TO i%
    printer_count%+=1
    buff1%!16=buff1%!8
    buff1%!8-=(prntctrl_icdf%(4)!12 - prntctrl_icdf%(4)!4)
    prnt%! 28 =i%
     
    prnt%=prnt%! 0 
  ENDWHILE


  rmtp% = remote_printers%
  WHILE rmtp%
    SYS "Wimp_CreateIcon",,buff1% TO i%

    remote_printer_count% += 1
    buff1%!16=buff1%!8
    buff1%!8-=(prntctrl_icdf%(4)!12 - prntctrl_icdf%(4)!4)
    rmtp%! 16 =i%
     
    rmtp% = rmtp%! 0 
  ENDWHILE


  SYS "Wimp_GetWindowInfo",,buff1% OR 1
  buff1%!0=0

  buff1%!4=-(printer_count%+remote_printer_count%+1)*(prntctrl_icdf%(4)!12 - prntctrl_icdf%(4)!4)



  buff1%!8=buff1%!52-buff1%!44
  buff1%!12=0
  SYS "Wimp_SetExtent",prntctrl%,buff1%
   

  buff1%!4=-(printer_count%+remote_printer_count%+2)*(prntctrl_icdf%(4)!12 - prntctrl_icdf%(4)!4)



  SYS "Wimp_ForceRedraw",prntctrl%,buff1%!0,buff1%!4,buff1%!8,buff1%!12

  IF FNwindow_open (prntctrl%) THEN
    PROCwin_open(prntctrl%)
  ENDIF



ENDPROC

DEF FNnfs_installed
  LOCAL i%
    
  SYS "XOS_SWINumberFromString",,"NFS_Mount" TO;i%
=((i% AND 1)=0)

DEF FNeconet_installed
  LOCAL i%
    
  SYS "XOS_SWINumberFromString",,"NetPrint_ReadPSName" TO;i%
=((i% AND 1)=0)

   



DEF FNevaluate(s$)
  LOCAL t%,n%,f%
    
  SYS "XOS_EvaluateExpression",s$,evaluation_buff%,256 TO,t%,n%;f%
  IF t% OR(f% AND 1)ERROR  253 ,FNmsg_1(A%! 12 ,"FAD",s$)
=n%

 
DEF FNcanonicalise(s$)
  LOCAL unused%,f%
    
  SYS "XOS_FSControl",37,s$,evaluation_buff%,0,0,256 TO ,,,,,unused%;f%
  IF (unused%<=0) OR (f% AND 1) : =s$
  evaluation_buff%?(256-unused%)=13
=$evaluation_buff%

DEF PROCbroadcast_reason_code(prnt%,reason%,task_buffer%)
LOCAL p%
p%=psup_head%
WHILE p%
  PROCprinter_reason_code(p%,prnt%,reason%,task_buffer%)
  p%=p%! 0 
ENDWHILE
ENDPROC

DEF PROCprinter_reason_code(psup%,prnt%,reason%,extra_buffer%)
  LOCAL i%
  LOCAL ERROR
  ON ERROR LOCAL: RESTORE ERROR: PROCprinter_reason_error(psup%,prnt%,reason%): ENDPROC
    
  buff1%!0=reason%
  buff1%!4=psup%
  buff1%!8=prnt%
  buff1%!12=extra_buffer%
  buff1%!16=psize_head%
  buff1%!20=code_entry%
  buff1%!24=A%:  

    
    
    
    
    
    

  IF psup%! 24  AND  1  THEN
     
      
    i%=EVAL("FN"+$psup%! 4 +"_support("+STR$ buff1%+")")
      
  ELSE
     
    IF 0<=utility_count%-1 THEN
      FOR i%=0 TO utility_count%-1
        IF $psup%! 4 =utility$(i%)THEN
            
          B%=buff1%
          CALL utility%(i%)
            
        ENDIF
      NEXT
    ENDIF
  ENDIF
ENDPROC

DEF PROCprinter_reason_error(psup%,prnt%,reason%)
   
    
  IF (prnt%! 24  AND  8 ) ERROR  254 ,REPORT$
   
  


    IF ERR= 253  ERROR  253 ,REPORT$
  
   
  PROCerror_warning(FNmsg_4(A%! 12 ,"WA6",$psup%! 4 ,STR$ reason%,REPORT$,STR$ ERL))
ENDPROC

DEF PROCpause_printer(prnt%)
    
  prnt%! 24 =prnt%! 24  OR  4 
  PROCprinter_status(prnt%)
  PROCredraw_queue_entry(-1,prnt%,0)
ENDPROC

DEF PROCprinter_open_window(prnt%,name$)
  LOCAL handle%, num_icons%, i%
    
  IF name$="configure" THEN
   IF prnt%! 24  AND  8  ERROR  254 ,FNmsg_0(A%! 12 ,"OKAI")
  ENDIF
  handle%=FNprinter_find_window(prnt%,name$)
  PROCtell_pinboard(handle%)
  PROCwin_open(handle%)
   
  !buff1%=handle%
  SYS"Wimp_GetWindowInfo",,buff1% OR 1
  num_icons%=buff1%!88
  FOR i%=0 TO num_icons%
    !buff1%=handle%:buff1%!4=i%:SYS"Wimp_GetIconState",,buff1%
    IF (buff1%!24 AND (1<<23))=0 THEN
       
      IF (buff1%!24 AND (%1111<<12)) = (15<<12) THEN

        IF (prnt%! 24  AND  (1<<16) ) OR (prnt%! 24  AND  (1<<17) ) THEN
         PROCicon_shade (handle%, i%) : REM Is name always first icon?
         PROCcaret_set (-1, -1)
        ELSE
         PROCicon_unshade (handle%, i%) : REM Is name always first icon?

         PROCcaret_set(handle%,i%)

        ENDIF

       ENDPROC
      ENDIF
    ENDIF
  NEXT
ENDPROC

DEF FNprinter_find_window(prnt%,name$)
  LOCAL psup%
    
  psup%=prnt%! 4 
  i%=psup%! 20 
  WHILE i%
   IF $(i%+ 16 )=name$ THEN
    i%! 8 =psup%
    i%! 12 =prnt%
    =i%! 4 
   ENDIF
   i%=i%! 0 
  ENDWHILE
  ERROR  253 ,FNmsg_1(A%! 12 ,"FAE",name$)
=0

DEF PROCprinter_find_handle(handle%,RETURN wind%,RETURN psup%,RETURN prnt%)
    
  psup%=psup_head%
  WHILE psup%
    wind%=psup%! 20 
    WHILE wind%
      IF wind%! 4 =handle% THEN
        prnt%=wind%! 12 
        ENDPROC
      ENDIF
      wind%=wind%! 0 
    ENDWHILE
    psup%=psup%! 0 
  ENDWHILE
  wind%=0
  psup%=0
  prnt%=0
ENDPROC

DEF FNprinter_find_prdata_entry(psup%,name$)
  LOCAL prdt%
    
  IF psup%=0 THEN =0
  prdt%=psup%! 12 
  IF prdt%=0 THEN =0
  prdt%=prdt%! 4 
  IF prdt%=0 THEN =0
  WHILE $prdt%! 8 <>name$
    prdt%=prdt%! 0 
    IF prdt%=0 THEN =0
  ENDWHILE
=prdt%

DEF FNprinter_read_integer(ptr%)
    
  IF ptr%=0 THEN =0
  IF ptr%!-4<> &47544E49  AND ptr%!-4<> &52544F50  THEN
    ERROR  253 ,FNmsg_0(A%! 12 ,"FA6")
  ENDIF
=!ptr%

DEF FNprinter_read_string(ptr%)
  LOCAL i%,s$
    
  IF ptr%=0 THEN =""
  CASE ptr%!-4 OF
    WHEN  &47525453 
 
      =$ptr%
    WHEN  &30525453 
      CALL Z%,ptr%,s$  
 
      =s$
    WHEN  &52545347 
      CALL Y%,ptr%,s$  
 
      =s$
  ENDCASE
  ERROR  253 ,FNmsg_0(A%! 12 ,"FA7")
=""

DEF FNprinter_read_integer_entry(prdt%,entry%)
    
   
  IF prdt%=0 THEN =0
=FNprinter_read_integer(prdt%!(4+entry%*4))

REM wahay! write_entry? only used to set flag bit in dp/lj palette number at present
DEF PROCprinter_write_integer_entry(prdt%,entry%,value%)
  LOCAL ptr%
  IF prdt% <> 0 THEN
    ptr% = prdt%!(4+entry%*4)
    IF ptr%!-4<> &47544E49  AND ptr%!-4<> &52544F50  THEN
      ERROR  253 ,FNmsg_0(A%! 12 ,"FA6")
    ENDIF
    !ptr%=value%
  ENDIF
ENDPROC

DEF FNprinter_read_string_entry(prdt%,entry%)
    
   
  IF prdt%=0 THEN =""
=FNprinter_read_string(prdt%!(4+entry%*4))

   










DEF FNprinter_read_boolean_string_entry(prdt%,entry%,true%)
  LOCAL ptr%
    
   
  IF prdt%=0 =""
  ptr%=prdt%!(4+entry%*4)
  IF ptr%!-4<> &4C4f4F42  ERROR  253 ,FNmsg_0(A%! 12 ,"FA8")
  IF true% THEN
   =FNprinter_read_string(ptr%! 4 )
  ELSE
   =FNprinter_read_string(ptr%! 0 )
  ENDIF

DEF FNprinter_read_list_integer_entry(prdt%,entry%,list%,list_entry%)
  LOCAL ptr%
    
   
  IF prdt%=0 THEN =0
   
  ptr%=prdt%!(4+entry%*4)
  IF ptr%=0 =0
  IF ptr%!-4<> &4454534C  ERROR  253 ,FNmsg_0(A%! 12 ,"FA9")
   
  WHILE list%<>1 AND ptr%
    ptr%=ptr%! 0 
    list%-=1
  ENDWHILE
  IF ptr%=0 =0
   
  ptr%+=8
  WHILE list_entry%<>1
    ptr%+=4
    list_entry%-=1
  ENDWHILE
=FNprinter_read_integer(!ptr%)

DEF FNprinter_read_list_string_entry(prdt%,entry%,list%,list_entry%)
  LOCAL ptr%
    
  IF prdt%=0 THEN =""
  ptr%=prdt%!(4+entry%*4)
  IF ptr%=0 =""
  IF ptr%!-4<> &4454534C  ERROR  253 ,FNmsg_0(A%! 12 ,"FA9")
  WHILE list%<>1 AND ptr%
    ptr%=ptr%! 0 
    list%-=1
  ENDWHILE
  IF ptr%=0 =""
  ptr%+=8
  WHILE list_entry%<>1
    ptr%+=4
    list_entry%-=1
  ENDWHILE
=FNprinter_read_string(!ptr%)

   

DEF PROCmsg_initialise(N$,RETURN msg_desc%)
  LOCAL ERROR
  ON ERROR LOCAL RESTORE ERROR: ERROR 0,REPORT$
   
    
  SYS "OS_Module",6,,,17+LEN N$ TO,,msg_desc%
  $(msg_desc%+16)=N$
  SYS "MessageTrans_OpenFile",msg_desc%,msg_desc%+16
ENDPROC

DEF FNmsg_0(msg_desc%,T$)=FNmsg_4(msg_desc%,T$,"","","","")

DEF FNmsg_1(msg_desc%,T$,S$)=FNmsg_4(msg_desc%,T$,S$,"","","")

DEF FNmsg_2(msg_desc%,T$,S0$,S1$)=FNmsg_4(msg_desc%,T$,S0$,S1$,"","")

DEF FNmsg_3(msg_desc%,T$,S0$,S1$,S2$)=FNmsg_4(msg_desc%,T$,S0$,S1$,S2$,"")

DEF FNmsg_4(msg_desc%,T$,S0$,S1$,S2$,S3$)
  LOCAL F%,L%
    
  SYS "XMessageTrans_Lookup",msg_desc%,T$,msg_text%,256,S0$,S1$,S2$,S3$ TO,,,L%;F%
  IF F% AND 1 THEN =T$
  msg_text%?L%=13
    
=$msg_text%

DEF PROCmsg_end(msg_desc%)
    
  IF msg_desc% THEN
    SYS "MessageTrans_CloseFile",msg_desc%
    SYS "XOS_Module",7,,msg_desc%
  ENDIF
ENDPROC

   

DEF PROCtask_initialise(n$)
    
  task_id$=n$
   
  task_buff%!0=&80152  
  task_buff%!4=&80146  
  task_buff%!8=&80145  
  task_buff%!12=&80143  
  task_buff%!16=&80142  
  task_buff%!20=&80141  
  task_buff%!24=&80140  
  task_buff%!28=&400C9  
  task_buff%!32=&502  
  task_buff%!36=12  
  task_buff%!40=11  
  task_buff%!44=10  
  task_buff%!48=8  
  task_buff%!52=3  
  task_buff%!56=2  
  task_buff%!60=1  
  task_buff%!64=5  
  task_buff%!68=0  
  SYS "Wimp_Initialise",300,&4B534154,n$,task_buff% TO wimp_version%,task_handle%
ENDPROC

DEF PROCtask_shutdown
    
  SYS "Wimp_CloseDown"
  



  END

DEF FNtask_poll(mask%)
   
  LOCAL task_action%,time_after%,prnt%,t%
    
    
    
    
  IF file_to_delete$<>"" mask%=mask% OR 1
  IF(mask% AND 1)=0 OR timeout%=-1 OR mask%<>A%! 20  THEN
     
      

    SYS "Wimp_Poll",mask%,task_buff%,,pollword_location% TO task_action%



  ELSE
     
    IF timeout%=0 OR file_to_delete$<>"" THEN
       
        

      SYS "Wimp_Poll",mask% AND NOT 1,task_buff%,, pollword_location% TO task_action%



    ELSE
       
        

      SYS "Wimp_PollIdle",mask% AND NOT 1,task_buff%,time_before%+timeout%, pollword_location% TO task_action%



    ENDIF
  ENDIF
    

   
  SYS "OS_ReadMonotonicTime" TO time_after%
  elapsed_time%=time_after%-time_before%
    
  time_before%=time_after%  

   
  prnt%=A%! 48 
  WHILE prnt%
    t%=prnt%+ 56   
    IF NOT !t% THEN
        
      IF elapsed_time%<!t% !t%-=elapsed_time% ELSE !t%=0
        
    ENDIF
    prnt%=prnt%! 0 
  ENDWHILE
=task_action%

DEF PROCdespatch_null
  LOCAL prnt%,psup%,t%

   
  IF file_to_delete$<>"" THEN
    SYS "XOS_File",6,file_to_delete$
    file_to_delete$=""
  ENDIF

   
    
  prnt%=A%! 48 
  WHILE prnt%
    t%=prnt%+ 56   
    IF !t%=0 THEN
       
      psup%=prnt%! 4 
       
      PROCprinter_reason_code(psup%,prnt%,0,0)
       
      !t%=10*psup%?( 24 +1)
    ENDIF
    prnt%=prnt%! 0 
  ENDWHILE
ENDPROC

DEF FNtask_read_env(n$,buff%)
  LOCAL len%,flags%
    
  SYS "XOS_ReadVarVal",n$,buff%,256,,3 TO,,len%;flags%
  IF flags% AND 1 len%=0
  buff%?len%=13
=$buff%

DEF FNtask_compare(a$,b$)
   
  LOCAL cmp%
    
  SYS "Territory_Collate",-1,a$,b$,%11 TO cmp%
=cmp%

DEF FNtask_lower(s$)
  LOCAL l$,table%,i%
  SYS "Territory_LowerCaseTable",-1 TO table%
  l$=""
  IF 1<=LEN s$ THEN
    FOR i%=1 TO LEN s$
      l$+=CHR$ table%?ASC MID$(s$,i%,i%)
    NEXT
  ENDIF
=l$

DEF FNtask_upper(s$)
  LOCAL u$,table%,i%
  SYS "Territory_UpperCaseTable",-1 TO table%
  u$=""
  IF 1<=LEN s$ THEN
    FOR i%=1 TO LEN s$
      u$+=CHR$ table%?ASC MID$(s$,i%,i%)
    NEXT
  ENDIF
=u$

   

DEF PROCerror_initialise
    
  DIM error_buff% 256
    
ENDPROC

DEF PROCerror
  LOCAL r$,r%
    
  r$=REPORT$
  


     



    r%=INSTR(r$,"in "+CHR$34+"!")
    IF r% r$=LEFT$(r$,r%-1)
  
  CASE ERR OF
    WHEN  254 
      PROCerror_box(r$,1)
    WHEN  253 
      PROCerror_box(r$,2)
    OTHERWISE
       
       
      PROCerror_box(r$+" (&"+STR$~ERR+") @"+STR$ERL,3)
  ENDCASE
ENDPROC

DEF PROCerror_box(r$,error_flag%)
  LOCAL r%
    
  SYS "Wimp_CreateMenu",,-1
  !error_buff%=ERR
  


    $(error_buff%+4)=r$+CHR$ 0
  
    
  SYS "Wimp_ReportError",error_buff%,error_flag%,task_id$ TO,r%
  IF r%=2 THEN
    ON ERROR OFF
    shutdown_type%=2
    


    PROCdestroy_queue
    PROChost_shutdown  
  ENDIF
ENDPROC

DEF PROCerror_warning(r$)
    
  !error_buff%=1
  


    $(error_buff%+4)=r$+CHR$ 0
  
    
  SYS "Wimp_ReportError",error_buff%,1 OR 1<<4,FNmsg_1(A%! 12 ,"ER2",task_id$)
ENDPROC

   
































































   

DEF PROCicon_initialise
    
  icon_priority%=0
   
ENDPROC

DEF FNiconbar_tands(text$,sprite$,side%,nextto%)
  LOCAL t%,s%,i%,v$,w%
    
  IF sprite$="s"+FNmsg_0(A%! 12 ,"IC") THEN
    v$="s"+sprite$
    SYS "Wimp_SpriteOp",40,,sprite$ TO,,,w%
  ELSE
    SYS "XWimp_SpriteOp",40,,sprite$ TO,,,w%;i%
    IF i% AND 1 THEN
      SYS "Wimp_SpriteOp",40,,"s"+FNmsg_0(A%! 12 ,"IC") TO,,,w%

       
     IF LEFT$(sprite$, 3) = "su_" THEN
      v$ = "ssu"+FNmsg_0(A%! 12 ,"IC")
     ELSE

      v$="ss"+FNmsg_0(A%! 12 ,"IC")+","+FNmsg_0(A%! 12 ,"IC")

     ENDIF

    ELSE

       
      IF LEFT$(sprite$, 3) = "su_" THEN
       v$ = "s"+sprite$
      ELSE

       v$="ss_"+sprite$+","+sprite$

      ENDIF

    ENDIF
  ENDIF
  B%= &46464249 
  C%=LEN text$+1
  t%=USR(code_entry%+ 12 )
  IF t%=0 ERROR  253 ,FNmsg_1(A%! 12 ,"FA5","IBFF")
  $t%=text$
  B%= &46464249 
  C%=LEN v$+1
  s%=USR(code_entry%+ 12 )
  IF s%=0 ERROR  253 ,FNmsg_1(A%! 12 ,"FA5","IBFF")
  $s%=v$
  SYS "OS_ReadModeVariable",-1,4 TO,,i%
  IF(w%<<i%)<LEN text$*16 w%=LEN text$*16 ELSE w%=w%<<i%
   
  icon_buffer%!0=side%
  icon_buffer%!4=0
  icon_buffer%!8=-16
  icon_buffer%!12=w%
  icon_buffer%!16=88
  icon_buffer%!20=&1700310B
     






     








  icon_buffer%!24=t%
  icon_buffer%!28=s%
  icon_buffer%!32=LEN text$+1
  SYS "Wimp_CreateIcon",nextto%,icon_buffer% TO i%
=i%

DEF PROCicon_delete(a%,b%)
    
  !icon_buffer%=a%
  icon_buffer%!4=b%
  SYS "Wimp_GetIconState",,icon_buffer%
  SYS "Wimp_DeleteIcon",,icon_buffer%
  IF icon_buffer%!24 AND 1<<8 THEN
     
    IF icon_buffer%!24 AND 3 THEN
       
      B%= &46464249 
      C%=icon_buffer%!28
      CALL code_entry%+ 16 
      IF icon_buffer%!24 AND 1 THEN
         
        IF NOT icon_buffer%!32 THEN
          B%= &46464249 
          C%=icon_buffer%!32
          CALL code_entry%+ 16 
        ENDIF
      ENDIF
    ENDIF
  ENDIF
ENDPROC

DEF PROCicon_write(a%,b%,s$)
  LOCAL h%,i%,n%
    
  PROCcaret_info(h%,i%,n%)
  !icon_buffer%=a%
  icon_buffer%!4=b%
  SYS "Wimp_GetIconState",,icon_buffer%
  IF LEN s$+1>icon_buffer%!36 THEN
    ERROR  253 ,FNmsg_2(A%! 12 ,"FAH",s$,STR$ b%)
  ENDIF
  $icon_buffer%!28=s$
  icon_buffer%!8=0
  icon_buffer%!12=0
  SYS "Wimp_SetIconState",,icon_buffer%
  IF h%=a% AND i%=b% PROCcaret_set(a%,b%)
ENDPROC

DEF PROCicon_validation(a%,b%,s$)
    
  !icon_buffer%=a%
  icon_buffer%!4=b%
  SYS "Wimp_GetIconState",,icon_buffer%
  $icon_buffer%!32=s$
  icon_buffer%!8=0
  icon_buffer%!12=0
  SYS "Wimp_SetIconState",,icon_buffer%
ENDPROC

DEF FNicon_read(a%,b%)
    
  !icon_buffer%=a%
  icon_buffer%!4=b%
  SYS "Wimp_GetIconState",,icon_buffer%
=$icon_buffer%!28

DEF PROCicon_unshade(a%,b%)
    
  !icon_buffer%=a%
  icon_buffer%!4=b%
  icon_buffer%!8=0
  icon_buffer%!12=1<<22
  SYS "Wimp_SetIconState",,icon_buffer%
ENDPROC

DEF PROCicon_shade(a%,b%)
    
  !icon_buffer%=a%
  icon_buffer%!4=b%
  icon_buffer%!8=1<<22
  icon_buffer%!12=1<<22
  SYS "Wimp_SetIconState",,icon_buffer%
ENDPROC

DEF PROCicon_deselect(a%,b%)
    
  !icon_buffer%=a%
  icon_buffer%!4=b%
  icon_buffer%!8=0
  icon_buffer%!12=1<<21
  SYS "Wimp_SetIconState",,icon_buffer%
   







  IFa%=prntctrl% select_all%= 0 
ENDPROC

DEF PROCicon_select(a%,b%)
    
  !icon_buffer%=a%
  icon_buffer%!4=b%
  icon_buffer%!8=1<<21
  icon_buffer%!12=1<<21
  SYS "Wimp_SetIconState",,icon_buffer%
   







  IFa%=prntctrl% select_all%= 0 
ENDPROC

DEF FNicon_set(a%,b%)
    
  !icon_buffer%=a%
  icon_buffer%!4=b%
  SYS "Wimp_GetIconState",,icon_buffer%
=(icon_buffer%!24 AND 1<<21)<>0

DEF PROCicon_info(a%,b%,RETURN x1%,RETURN y1%,RETURN x2%,RETURN y2%)
    
  !icon_buffer%=a%
  icon_buffer%!4=b%
  SYS "Wimp_GetIconState",,icon_buffer%
  x1%=icon_buffer%!8
  y1%=icon_buffer%!12
  x2%=icon_buffer%!16
  y2%=icon_buffer%!20
ENDPROC

DEF PROCcaret_set(h%,i%)
  LOCAL j%
    
  j%=LEN FNicon_read(h%,i%)
  SYS "Wimp_SetCaretPosition",h%,i%,-1,-1,,j%
  SYS "Wimp_SetCaretPosition",h%,i%,-1,-1,-1,j%
ENDPROC

DEF PROCcaret_info(RETURN h%,RETURN i%,RETURN n%)
    
  SYS "Wimp_GetCaretPosition",,icon_buffer%
  h%=!icon_buffer%
  i%=icon_buffer%!4
  n%=icon_buffer%!20
ENDPROC

   

DEF PROCwin_initialise
    
   



  win_template$=""
ENDPROC

DEF PROCwin_template_open(f2$,f3$)
  LOCAL a$,a%
    
   




  SYS"OS_Byte",161,&8C TO ,,a%
  IF (a%AND1)=1 THEN
    SYS"OS_File",17,f3$ TO a%
    IFa%=1 win_template$=f3$ ELSE win_template$=f2$
  ELSE
   win_template$=f2$
  ENDIF
  SYS"Wimp_OpenTemplate",,win_template$
ENDPROC

DEF PROCwin_template_close
    
  SYS "Wimp_CloseTemplate"
ENDPROC

DEF PROCwin_load_create(f$,n$,sprite_pool%,RETURN handle%)
  LOCAL buff%
    
  PROCwin_load(f$,n$,buff%)  
  buff%!64=sprite_pool%
  PROCwin_create(buff%,handle%)
  B%= &444E4957 
  C%=buff%
  CALL code_entry%+ 16 
ENDPROC

DEF PROCwin_load(f$,n$,RETURN buf%)
   






  LOCAL ws_buf%,size%,data%,found%,s%,f%,s$
    
  PROCwin_sizes(f$,n$,size%,data%)
  B%= &444E4957 
  C%=size%+data%
  buf%=USR(code_entry%+ 12 )
  IF buf%=0     ERROR  253 ,FNmsg_1(A%! 12 ,"FA5","WIND")

  IF f$<>"" SYS "Wimp_OpenTemplate",,f$
  IF data% THEN
   B%= &46465542 
   C%=data%
   ws_buf%=USR(code_entry%+ 12 )
   IF ws_buf%=0      ERROR  253 ,FNmsg_1(A%! 12 ,"FA5","BUFF")

   SYS "XWimp_LoadTemplate",,buf%,ws_buf%,ws_buf%+data%,-1,n$ TO        s%,,,,,,found%;f%

  ELSE
   SYS "XWimp_LoadTemplate",,buf%,,,-1,n$ TO s%,,,,,,found%;f%
  ENDIF
  IF f$<>"" SYS "Wimp_CloseTemplate"
  IF f% AND 1     f%=s%+4:     CALL Z%,f%,s$:       ERROR  254 ,n$+": "+s$



  IF found%=0     ERROR  254 ,FNmsg_1(A%! 12 ,"OKAK",n$)

ENDPROC

DEF PROCwin_create(buf%,RETURN handle%)
   

    
  SYS "Wimp_CreateWindow",,buf% TO handle%
ENDPROC

DEF PROCwin_open(a%)
    
  !win_buff%=a%
  SYS "Wimp_GetWindowState",,win_buff%
  win_buff%!28=-1
  SYS "Wimp_OpenWindow",,win_buff%
ENDPROC

DEF PROCwin_title(a%,s$)
  LOCAL wox0%,way1%,wox1%,woy1%
    
  !win_buff%=a%
  SYS "Wimp_GetWindowInfo",,win_buff% OR 1
  $win_buff%!76=s$
  IF win_buff%!32 AND 1<<16 THEN
    way1%=win_buff%!16
    SYS "Wimp_GetWindowOutline",,win_buff%
    wox0%=win_buff%!4
    wox1%=win_buff%!12
    woy1%=win_buff%!16
    SYS "Wimp_ForceRedraw",-1,wox0%,way1%,wox1%,woy1%
  ENDIF
ENDPROC

DEF PROCwin_get_next_name(file$,RETURN ptr%,RETURN name$)
  LOCAL f%,offset%,type%
    
  IF f$="" AND wimp_version%>=300 THEN
     
    SYS "Wimp_LoadTemplate",,,,,-1,"*"+STRING$(12,CHR$ 0),ptr% TO        ,,,,,name$,ptr%

    


  ELSE
     
    IF file$="" file$=win_template$
    f%=OPENIN file$
    IF ptr%=0 ptr%=16
    REPEAT
      PTR#f%=ptr%
      offset%=FNwin_word(f%)
      IF offset% THEN
        PTR#f%=ptr%+8
        type%=FNwin_word(f%)
        name$=FNwin_string(f%)
        ptr%+=24
        IF type%=1 offset%=0
      ELSE
        ptr%=0
      ENDIF
    UNTIL offset%=0
    SYS "XOS_Find",,f%  
  ENDIF
ENDPROC

   


DEF PROCwin_sizes(f$,n$,RETURN size%,RETURN data%)
  LOCAL i%,file%,ptr%,offset%,type%,ident$,num_icons%
    
  IF f$="" AND wimp_version%>=300 THEN
     
    SYS "Wimp_LoadTemplate",,,,,-1,n$ TO,size%,data%
      
  ELSE
     
    IF f$="" f$=win_template$
    file%=OPENIN f$
    size%=0
    data%=0
    ptr%=16
    REPEAT
      PTR#file%=ptr%
      offset%=FNwin_word(file%)
      IF offset% THEN
        PTR#file%=ptr%+8
        type%=FNwin_word(file%)
        ident$=FNwin_string(file%)
        ptr%+=24
        IF type%=1 THEN
          IF ident$=n$ THEN
            PTR#file%=offset%+84
            num_icons%=FNwin_word(file%)
            data%=FNwin_title(file%,offset%)
            IF num_icons% data%+=FNwin_icon(file%,num_icons%,offset%)
            size%=88+(num_icons%*32)
            offset%=0  
          ENDIF
        ENDIF
      ENDIF
    UNTIL offset%=0
    SYS "XOS_Find",,file%  
      
  ENDIF
ENDPROC

DEF FNwin_word(h%)
    
=BGET#h% OR BGET#h%<<8 OR BGET#h%<<16 OR BGET#h%<<24

DEF FNwin_string(h%)
  LOCAL s$,c%
    
  REPEAT
   c%=BGET#h%
   IF c%>31 s$+=CHR$ c%
  UNTIL c%<32
=s$

DEF FNwin_title(file%,offset%)
  LOCAL v%
    
  PTR#file%=offset%+28
  v%=FNwin_word(file%)
  IF v% AND 1<<31 THEN
    IF v% AND 1<<26 THEN =FNwin_isd(file%,offset%+56,offset%+72,offset%)
  ELSE
    IF v% AND 1 THEN =FNwin_isd(file%,offset%+56,offset%+72,offset%)
  ENDIF
=0

DEF FNwin_icon(file%,num%,offset%)
  LOCAL i%,j%
    
  j%=0
  IF 0<=num%-1 THEN
    FOR i%=0 TO num%-1
     j%+=FNwin_isd(file%,offset%+88+i%*32+16,offset%+88+i%*32+20,offset%)
    NEXT
  ENDIF
=j%

DEF FNwin_isd(file%,o1%,o2%,offset%)
  LOCAL v%,ist%,size%,i%
    
  PTR#file%=o1%
  v%=FNwin_word(file%)
   

  i%=v% AND %100000000
  ist%=(v% AND 3)+(i% >> 6)
  CASE ist% OF
   WHEN 0,1,2,3,4
    size%=0
   WHEN 5,7
    PTR#file%=o2%+4
    v%=FNwin_word(file%)
    IF v%=-1 THEN
      size%=0
    ELSE
      PTR#file%=offset%+v%
      size%=LEN FNwin_string(file%)+1
    ENDIF
    PTR#file%=o2%+8
    size%+=FNwin_word(file%)
   WHEN 6
    PTR#file%=o2%+8
    size%=FNwin_word(file%)
  ENDCASE
=size%

   

DEF PROCsave_initialise
  LOCAL f%
    
  SYS "XOS_SWINumberFromString",,"DragASprite_Start" TO save_start%;f%
  IF f% AND 1 save_start%=-1
  SYS "XOS_SWINumberFromString",,"DragASprite_Stop" TO save_stop%;f%
  IF f% AND 1 save_stop%=-1
  SYS "OS_Byte",161,&1C TO,,f%
  IF(f% AND 2)=0 THEN
    
   save_start%=-1
   save_stop%=-1
  ENDIF
  B%= &45564153 
  C%=256
  save_buff%=USR(code_entry%+ 12 )
  IF save_buff%=0 ERROR  253 ,FNmsg_1(A%! 12 ,"FA5","SAVE")
  save_dragging%= 0 
ENDPROC

DEF PROCsave_setup(filetype%,icon_name$)
  LOCAL b$
    
  b$=STR$~filetype%
  b$=RIGHT$("000"+b$,3)
  save_filetype%=filetype%
  PROCicon_validation(save_wind%, 0 ,"sfile_"+b$)
  PROCicon_write(save_wind%, 1 ,icon_name$)
ENDPROC

DEF PROCsave_dragicon(mousex%,mousey%)
  LOCAL bx%,by%,ix0%,ix1%,iy0%,iy1%,scrx%,scry%,f$,mc_sw%,mc_dx%,mc_sh%,mc_dy%
    
  !save_buff%=save_wind%
  SYS "Wimp_GetWindowState",,save_buff%
  bx%=save_buff%!4 - save_buff%!20
  by%=save_buff%!16 - save_buff%!24
  PROCicon_info(save_wind%, 0 ,ix0%,iy0%,ix1%,iy1%)
  SYS "OS_ReadModeVariable",-1,4 TO,,mc_dx%
  mc_dx%=1<<mc_dx%
  SYS "OS_ReadModeVariable",-1,5 TO,,mc_dy%
  mc_dy%=1<<mc_dy%
  SYS "OS_ReadModeVariable",-1,11 TO,,mc_sw%
  mc_sw%+=1
  SYS "OS_ReadModeVariable",-1,12 TO,,mc_sh%
  mc_sh%+=1
  scrx%=mc_sw%*mc_dx%
  scry%=mc_sh%*mc_dy%
  !save_buff%=save_wind%
  save_buff%!4=5
  save_buff%!8=bx%+ix0%
  save_buff%!12=by%+iy0%
  save_buff%!16=bx%+ix1%
  save_buff%!20=by%+iy1%
  save_buff%!24=save_buff%!8-mousex%
  save_buff%!28=save_buff%!12-mousey%
  save_buff%!32=scrx%+save_buff%!16-mousex%
  save_buff%!36=scry%+save_buff%!20-mousey%
  IF NOT save_start% THEN
   f$="file_"+RIGHT$("000"+STR$~save_filetype%,3)
   SYS save_start%,%11000101,1,f$,save_buff%+8,save_buff%+24
  ELSE
   SYS "Wimp_DragBox",,save_buff%
  ENDIF
  save_dragging%= -1 
ENDPROC

DEF PROCsave_decodedrag
  LOCAL h%,i%,mx%,my%,ft%
    
  save_dragging%= 0 
  IF NOT save_stop% SYS save_stop%
  SYS "Wimp_GetPointerInfo",,save_buff%
  mx%=!save_buff%
  my%=save_buff%!4
  h%=save_buff%!12
  i%=save_buff%!16
  IF h%=save_wind% ENDPROC  
  PROCsave_dragfile(h%,i%,mx%,my%)
ENDPROC

DEF PROCsave_dragfile(h%,i%,mx%,my%)
  LOCAL f1$
    
  f1$=FNsave_leafname
  !save_buff%=48+LEN f1$ AND NOT 3
  save_buff%!12=0
  save_buff%!16=1  
  save_buff%!20=h%
  save_buff%!24=i%
  save_buff%!28=mx%
  save_buff%!32=my%
  save_buff%!36=0
  save_buff%!40=save_filetype%
  $(save_buff%+44)=f1$+CHR$ 0
  SYS "Wimp_SendMessage",17,save_buff%,h%,i%
    
ENDPROC

DEF FNsave_leafname
  LOCAL f$,i%
    
  f$=FNicon_read(save_wind%, 1 )
  REPEAT
   i%=INSTR(f$,":")
   IF i% f$=MID$(f$,i%+1)
  UNTIL i%=0
  REPEAT
   i%=INSTR(f$,".")
   IF i% f$=MID$(f$,i%+1)
  UNTIL i%=0
=f$

   

DEF PROCmenu_initialise
    
  menu_top%=0
  menu_count%=0
ENDPROC

DEF PROCmenu_create(RETURN menu%,menu$)
  LOCAL menutitle$,i%,menu1$,item$,j%,x%,t%
    
  IF menu_top% THEN
    PROCmenu_release
    menu_top%=0
    menu_count%=0
  ENDIF
  IF LEFT$(menu$,1)="#" THEN
    i%=1
    menutitle$=FNmenu_par(menu$,",",i%)
  ELSE
    menutitle$=""
  ENDIF
  



  menu1$=menu$
  j%=i%
  REPEAT
    item$=FNmenu_par(menu$,",",i%)
    IF item$<>"" menu_count%+=1
  UNTIL item$=""
  menu$=menu1$
  i%=j%
  B%= &554E454D 
  C%=28+menu_count%*24
  menu_top%=USR(code_entry%+ 12 )
  IF menu_top%=0     ERROR  253 ,FNmsg_1(A%! 12 ,"FA5","MENU")

  IF LEN menutitle$<=12 THEN
      
    $menu_top%=menutitle$
  ELSE
      
    B%= &554E454D 
    C%=LEN menutitle$+2
    t%=USR(code_entry%+ 12 )
    IF t%=0       ERROR  253 ,FNmsg_1(A%! 12 ,"FA5","MENU")

    $t%=menutitle$+CHR$ 0
    menu_top%!0=t%
  ENDIF
  menu_top%?12=7
  menu_top%?13=2
  menu_top%?14=7
  menu_top%?15=0
  menu_top%!16=196
  menu_top%!20=44
  menu_top%!24=0
  x%=LEN menutitle$-3
  menu_top%!16=(x%*8+6)*2
  


  FOR j%=0 TO menu_count%-1
    item$=FNmenu_par(menu$,",",i%)
      
    PROCmenu_item(menu_top%,j%,item$,LEN menutitle$>12)
  NEXT
  menu%=menu_top%
    
ENDPROC

DEF PROCmenu_release
  LOCAL i%,p%,indirected_title%
    
  p%=menu_top%+28
  indirected_title%=p%!0 AND &100
  IF 0<=menu_count%-1 THEN
    FOR i%=0 TO menu_count%-1
      IF p%!8 AND &100 THEN
         

        IF(!p% AND 4)=0 THEN
           
          B%= &554E454D 
          C%=p%!12
          CALL code_entry%+ 16 
        ENDIF
      ENDIF
      p%+=24
    NEXT
  ENDIF

  IF indirected_title% THEN
      
    B%= &554E454D 
    C%=menu_top%!0
    CALL code_entry%+ 16 
  ENDIF
  





  B%= &554E454D 
  C%=menu_top%
  CALL code_entry%+ 16 
    
ENDPROC

DEF PROCmenu_item(RETURN menu%,item%,item$,indirected_title%)
  LOCAL F%,p%,i%,x%,m%
    
  x%=(menu%!16/2-6)/8
  IF RIGHT$(item$,1)="#" THEN
    item$=LEFT$(item$)
    F%=F% OR 2  
  ENDIF
  IF RIGHT$(item$,1)="@" THEN
    item$=LEFT$(item$)
    F%=F% OR 8  
  ENDIF
  IF item%>=menu_count% THEN
     
    B%= &554E454D 
    C%=menu_top%
    D%=(item%-menu_count%+1)*24
    m%=USR(code_entry%+ 20 )
    IF m%=0       ERROR  253 ,FNmsg_1(A%! 12 ,"FA5","MENU")

    menu_top%=m%
    p%=menu_top%+28+(menu_count%-1)*24
    !p%=!p% AND NOT &80  
    menu_count%=item%+1
  ENDIF
  IF item%=menu_count%-1 F%=F% OR &80  
  IF item%=0 AND indirected_title% F%=F% OR &100  
  p%=menu_top%+28+item%*24
  p%!0=F%
  p%!4=-1
  p%!8=&07000021
  IF LEFT$(item$,1)="$" THEN
    !p%+=4
    item$=STRING$(12," ")
  ELSE
    IF LEN item$<12 THEN
      $(p%+12)=item$
    ELSE
      B%= &554E454D 
      C%=LEN item$+1
      i%=USR(code_entry%+ 12 )
      IF i%=0         ERROR  253 ,FNmsg_1(A%! 12 ,"FA5","MENU")

      $i%=item$
      p%!8=p%!8 OR &100
      p%!12=i%
      p%!16=-1
      p%!20=LEN item$+1
    ENDIF
  ENDIF
  menu%=menu_top%
  IF LEN item$>x% THEN
    x%=LEN item$
    menu%!16=(x%*8+6)*2
  ENDIF
ENDPROC

DEF PROCmenu_attach(menu%,item%,ptr%,traverse%)
    
  menu%+=28+item%*24
  IF traverse% THEN !menu%=!menu% OR 1<<4
  menu%!4=ptr%
ENDPROC

DEF FNmenu_par(menu$,sep$,RETURN I%)
  LOCAL L%
    
  L%=I%+1
  I%=INSTR(menu$+sep$,sep$,L%)
=MID$(menu$,L%,I%-L%)

DEF PROCmenu_shade(menuhandle%,item%,value%)
    
  IF((menuhandle%!(28+8+24*item%)AND &400000)=&400000)<>value% THEN
   menuhandle%!(28+8+24*item%)=menuhandle%!(28+8+24*item%)EOR &400000
  ENDIF
ENDPROC

DEF FNmenu_shade(menuhandle%,item%)
    
=((menuhandle%!(28+8+24*item%)AND &400000)=&400000)

DEF PROCmenu_tick_match(menuhandle%,match$)
  LOCAL item%,string$
    
  item%=menuhandle%+28
  REPEAT
   IF item%!8 AND &100 string$=$item%!12 ELSE string$=$(item%+12)
   IF FNtask_compare(string$,match$)=0 THEN
    !item%=!item% EOR 1
    ENDPROC
   ENDIF
   IF !item% AND &80 ENDPROC
   item%+=24
  UNTIL  0 
ENDPROC

DEF PROCmenu_tick(menuhandle%,item%,on%)
  IF on%     menuhandle%!(28+24*item%)=menuhandle%!(28+24*item%) OR 1   ELSE     menuhandle%!(28+24*item%)=menuhandle%!(28+24*item%) AND NOT 1



ENDPROC

DEF PROCmenu_window_centre(h%)
  LOCAL x%,y%,mc_sw%,mc_dx%,mc_sh%,mc_dy%
    
  SYS "OS_ReadModeVariable",-1,4 TO,,mc_dx%
  mc_dx%=1<<mc_dx%
  SYS "OS_ReadModeVariable",-1,5 TO,,mc_dy%
  mc_dy%=1<<mc_dy%
  SYS "OS_ReadModeVariable",-1,11 TO,,mc_sw%
  mc_sw%+=1
  SYS "OS_ReadModeVariable",-1,12 TO,,mc_sh%
  mc_sh%+=1
  !task_buff%=h%
  SYS "Wimp_GetWindowState",,task_buff%
  x%=mc_sw%*mc_dx%
  y%=mc_sh%*mc_dy%
  x%=(x%-task_buff%!12+task_buff%!4)DIV 2
  y%=(y%+task_buff%!16-task_buff%!8)DIV 2
  SYS "Wimp_CreateMenu",,h%,x%,y%
ENDPROC

   

DEF PROClocale_initialise
  LOCAL p%
  SYS "Territory_ReadSymbols",-1,0 TO p%
  CALL Z%,p%,decimal_point$
ENDPROC

DEF FNlocale_val(n$)
  IF decimal_point$="." : =VALn$
  LOCAL i%
  i%=INSTR(n$,decimal_point$)
  IF i%<>0 : =VAL(LEFT$(n$,i%-1)+"."+MID$(n$,i%+1))
=VALn$

   

DEF PROCopen_papersize_window(a%)
  LOCAL i%
    
  B%= &455A5350 
  C%= 56 
  psize_edit%=USR(code_entry%+ 12 )
  IF psize_edit%=0 ERROR  253 ,FNmsg_1(A%! 12 ,"FA5","PSZE")

  IF a% THEN
     
    a%=a%! 36 
    IF  0  <  52  THEN
      FOR i%= 0  TO  52  STEP 4
        psize_edit%!i%=a%!i%
      NEXT
    ENDIF
  ELSE
    IF  0 <= 52  THEN
      FOR i%= 0  TO  52  STEP 4
        psize_edit%!i%=0
      NEXT
    ENDIF
  ENDIF
  PROCinitialise_papersize_window
  PROCtell_pinboard(papersize%)
  PROCwin_open(papersize%)
  PROCcaret_set(papersize%, 5 )
ENDPROC

DEF PROCinitialise_papersize_window
  LOCAL h%,i%,n%
    
  PROCcaret_info(h%,i%,n%)
  PROCset_string(papersize%, 5 ,psize_edit%, 4 )
  PROCreset_papertext( 12 , 36 )
  PROCreset_papertext( 13 , 32 )
  PROCreset_papertext( 14 , 40 )
  PROCreset_papertext( 15 , 44 )
  PROCreset_papertext( 16 , 48 )
  PROCreview_papersize_units
   
  IF psize_edit%! 52 = 1  THEN
    PROCicon_unshade(papersize%, 33 )
  ELSE
    PROCicon_shade(papersize%, 33 )
  ENDIF
ENDPROC

DEF PROCreview_papersize_units
  LOCAL s$
    

   
  IF NOTFNicon_set(papersize%, 23 ) AND NOTFNicon_set(papersize%, 22 ) THEN
    PROCicon_select(papersize%, 23 )
  ENDIF

  IF FNicon_set(papersize%, 23 )THEN
   s$=FNmsg_0(A%! 12 ,"mm")
  ELSE
   s$=FNmsg_0(A%! 12 ,"in")
  ENDIF
  PROCicon_write(papersize%, 26 ,s$)
  PROCicon_write(papersize%, 29 ,s$)
  PROCicon_write(papersize%, 27 ,s$)
  PROCicon_write(papersize%, 30 ,s$)
  PROCicon_write(papersize%, 28 ,s$)
  PROCicon_write(papersize%, 31 ,s$)
  PROCreset_papersize( 6 , 8 )
  PROCreset_papersize( 7 , 12 )
  PROCreset_papersize( 8 , 20 )
  PROCreset_papersize( 9 , 16 )
  PROCreset_papersize( 10 , 24 )
  PROCreset_papersize( 11 , 28 )
ENDPROC

DEF PROCreset_papertext(icon%,offset%)
    
  PROCicon_write(papersize%,icon%,STR$ psize_edit%!offset%)
ENDPROC

DEF PROCreset_papersize(icon%,offset%)
  LOCAL v%
    
  v%=psize_edit%!offset%
  CASE icon% OF
    WHEN  8 
      v%=psize_edit%! 12 -v%
    WHEN  11 
      v%=psize_edit%! 8 -v%
  ENDCASE
  PROCicon_write(papersize%,icon%,FNmills(v%))
ENDPROC

DEF FNmills(v%)
  LOCAL @%
    
  IF FNicon_set(papersize%, 23 )THEN
   @%="+F10"+decimal_point$+"1"
   =STR$(v%/mm_to_72000)
  ELSE
   @%="+F10"+decimal_point$+"3"
   =STR$(v%/in_to_72000)
  ENDIF

DEF PROCread_paper_file(f$,flag%)
  LOCAL ts%,psize%,head%,last%,t$
    
  IF FNload_file(f$)THEN
   REPEAT
    ts%=FNmatch_line("pn:")
    IF ts% THEN
     t$=FNload_paper_size(psize%,$ts%)
     IF t$<>"" PROCpaper_error(f$,t$)
     psize%! 52 =flag%
     head%=psize_head%
     last%=0
     WHILE head%>0
      IF $psize%! 4 =$head%! 4  THEN
        




       IF head%! 52  =  0  THEN
         psize%! 0 =head%! 0 
         PROCfree_structure(head%! 4 )
         B%= &455A5350 
         C%=head%
         CALL code_entry%+ 16 
         head%=-1
       ELSE
          
         B%= &455A5350 
         C%=psize%
         CALL code_entry%+ 16 
         psize%=0
         head%=-1
       ENDIF
      ELSE
       IF $psize%! 4 <$head%! 4  THEN
         
        psize%! 0 =head%
        head%=-1
       ELSE
        last%=head%
        head%=head%! 0 
       ENDIF
      ENDIF
     ENDWHILE
     IF psize% THEN
        




       IF last% last%! 0 =psize% ELSE psize_head%=psize%
     ENDIF
    ENDIF
   UNTIL ts%=0  
   PROCrelease_file
  ENDIF
ENDPROC

DEF PROCpaper_error(f$,t$)
    
  PROCram_file_error(FNmsg_2(A%! 12 ,"OKO",f$,t$))
ENDPROC

DEF FNload_paper_size(RETURN psize%,name$)
  LOCAL t$
    
  B%= &455A5350 
  C%= 56 
  psize%=USR(code_entry%+ 12 )
  IF psize%=0 ERROR  253 ,FNmsg_1(A%! 12 ,"FA5","PSZE")
  psize%! 0 =0
  $task_buff%=name$
  B%=task_buff%
  C%=2
  psize%! 4 =USR(code_entry%+ 28 )
  ts%=FNmatch_line("pw:")
  IF ts% psize%! 8 =VAL $ts% ELSE ="pw:"
  ts%=FNmatch_line("ph:")
  IF ts% psize%! 12 =VAL $ts% ELSE ="ph:"
  ts%=FNmatch_line("pb:")
  IF ts% psize%! 16 =VAL $ts% ELSE ="pb:"
  ts%=FNmatch_line("pt:")
  IF ts% psize%! 20 =VAL $ts% ELSE ="pt:"
  ts%=FNmatch_line("pl:")
  IF ts% psize%! 24 =VAL $ts% ELSE ="pl:"
  ts%=FNmatch_line("pr:")
  IF ts% psize%! 28 =VAL $ts% ELSE ="pr:"
  ts%=FNmatch_line("tb:")
  IF ts% psize%! 32 =VAL $ts% ELSE ="tb:"
  ts%=FNmatch_line("tt:")
  IF ts% psize%! 36 =VAL $ts% ELSE ="tt:"
  ts%=FNmatch_line("tl:")
  IF ts% psize%! 40 =VAL $ts% ELSE ="tl:"
  ts%=FNmatch_line("tr:")
  IF ts% psize%! 44 =VAL $ts% ELSE ="tr:"
  ts%=FNmatch_line("th:")
  IF ts% psize%! 48 =VAL $ts% ELSE ="th:"
=""

DEF PROCsave_paper_size(c%,ptr%)
    
  BPUT#c%,"pn: "+$ptr%! 4 
  BPUT#c%,"pw: "+STR$ ptr%! 8 
  BPUT#c%,"ph: "+STR$ ptr%! 12 
  BPUT#c%,"pb: "+STR$ ptr%! 16 
  BPUT#c%,"pt: "+STR$ ptr%! 20 
  BPUT#c%,"pl: "+STR$ ptr%! 24 
  BPUT#c%,"pr: "+STR$ ptr%! 28 
  BPUT#c%,"tb: "+STR$ ptr%! 32 
  BPUT#c%,"tt: "+STR$ ptr%! 36 
  BPUT#c%,"tl: "+STR$ ptr%! 40 
  BPUT#c%,"tr: "+STR$ ptr%! 44 
  BPUT#c%,"th: "+STR$ ptr%! 48 
ENDPROC

DEF PROCsave_papersize
  LOCAL psize%,s$,this_psize%,head%,last%,c%,prnt%
  LOCAL width, height, left, right, top, bottom
    

   
   
  width = FNlocale_val(FNicon_read(papersize%,  6 ))
  height = FNlocale_val(FNicon_read(papersize%,  7 ))
  left = FNlocale_val(FNicon_read(papersize%,  10 ))
  right = FNlocale_val(FNicon_read(papersize%,  11 ))
  top = FNlocale_val(FNicon_read(papersize%,  8 ))
  bottom = FNlocale_val(FNicon_read(papersize%,  9 ))

  s$=FNicon_read(papersize%, 5 )
  IF s$="" ERROR  254 ,FNmsg_0(A%! 12 ,"OKAD")

   
  IF FNlocale_val(FNicon_read(papersize%, 6 ))=0 ERROR  254 ,FNmsg_0(A%! 12 ,"OKAE")
  IF FNlocale_val(FNicon_read(papersize%, 7 ))=0 ERROR  254 ,FNmsg_0(A%! 12 ,"OKAE")

  IF (top+bottom > height) ERROR  254 ,     FNmsg_1(A%! 12 ,"OKAY",FNmsg_0(A%! 12 ,"OKAZ"))


  IF (left+right > width) ERROR  254 ,     FNmsg_1(A%! 12 ,"OKAY",FNmsg_0(A%! 12 ,"OKBA"))


   
  SYS "Hourglass_On"
  psize%=psize_head%
  WHILE psize%
   IF $psize%! 4 =s$ THEN
     
    this_psize%=psize%
    psize%=0
   ELSE
    psize%=psize%! 0 
   ENDIF
  ENDWHILE

  IFthis_psize%     IFthis_psize%! 52 = 2        ERROR  254 ,FNmsg_0(A%! 12 ,"OKAX")



  IF this_psize%=0 THEN
    
   B%= &455A5350 
   C%= 56 
   this_psize%=USR(code_entry%+ 12 )
   IF this_psize%=0 ERROR  253 ,FNmsg_1(A%! 12 ,"FA5","PSZE")
   this_psize%! 0 =0
   $task_buff%=s$
   B%=task_buff%
   C%=2
   this_psize%! 4 =USR(code_entry%+ 28 )
    
   head%=psize_head%
   last%=0
   WHILE head%>0
    IF $this_psize%! 4 <$head%! 4  THEN
      
     this_psize%! 0 =head%
     head%=-1
    ELSE
     last%=head%
     head%=head%! 0 
    ENDIF
   ENDWHILE
   IF last% last%! 0 =this_psize% ELSE psize_head%=this_psize%
  ENDIF
   
  PROCsave_value( 6 ,this_psize%, 8 , -1 ,saveit%)
  PROCsave_value( 7 ,this_psize%, 12 , -1 ,saveit%)
  PROCsave_value( 9 ,this_psize%, 16 , -1 ,saveit%)
  PROCsave_value( 8 ,this_psize%, 20 , -1 ,saveit%)
  PROCsave_value( 10 ,this_psize%, 24 , -1 ,saveit%)
  PROCsave_value( 11 ,this_psize%, 28 , -1 ,saveit%)
  PROCsave_value( 13 ,this_psize%, 32 , 0 ,saveit%)
  PROCsave_value( 12 ,this_psize%, 36 , 0 ,saveit%)
  PROCsave_value( 14 ,this_psize%, 40 , 0 ,saveit%)
  PROCsave_value( 15 ,this_psize%, 44 , 0 ,saveit%)
  PROCsave_value( 16 ,this_psize%, 48 , 0 ,saveit%)
  this_psize%! 52 = 1 
  PROCsave_user_defined_paper_sizes
   
  prnt%=A%! 48 
  WHILE prnt%
   IF prnt%! 36 =this_psize% THEN
     
    IF prnt%! 24  AND  2  THEN
     PROCselect_printer(prnt%, -1 , 0 )
     PROCset_page_size(prnt%)
     PROCtell_the_world
    ENDIF
   ENDIF
   prnt%=prnt%! 0 
  ENDWHILE
  SYS "Hourglass_Off"
ENDPROC

DEF PROCsave_user_defined_paper_sizes
    
  LOCAL c%,psize%,count%,s$,r0%

  IF multiple_choices% THEN
    s$ =  "<Choices$Write>.Printers" +".Remote.ID"+unique_string$+".PaperRW"
  ELSE

    s$ =  "<Choices$Write>.Printers" +".PaperRW"

  ENDIF


   
  SYS "XOS_File",17,s$ TO r0%;f%
  IF(f%AND1) !r0%= 254 :SYS"OS_GenerateError",r0%
   
  IF(r0%=0) THEN
    SYS "XOS_File",11,s$,&FC6,,0,0 TO r0%;f%
    IF(f%AND1) PROCerror_warning(FNmsg_0(A%! 12 ,"WA14")):ENDPROC
  ELSE
     
     
    SYS "XOS_File",4,s$,,,,0 TO r0%;f%
    IF(f%AND1)=0 SYS "XOS_File",4,s$,,,,3 TO r0%;f%
    IF(f%AND1) PROCerror_warning(FNmsg_0(A%! 12 ,"WA14")):ENDPROC
  ENDIF

   
  SYS "XOS_Find",&8F,s$ TO c%;f%
  IF(f%AND1) PROCerror_warning(FNmsg_0(A%! 12 ,"WA14")):ENDPROC
  IF c% THEN
   psize%=psize_head%
   WHILE psize%
    IF psize%! 52 = 1  THEN
      PROCsave_paper_size(c%,psize%)
      count%+=1
    ENDIF
    psize%=psize%! 0 
   ENDWHILE
   SYS "XOS_Find",,c%  
   IF count% THEN
    SYS "XOS_File",18,s$,&FC6
    SYS "XOS_File",4,s$,,,,&13  
   ELSE
    SYS "XOS_File",6,s$
   ENDIF
  ENDIF
ENDPROC

DEF PROCsave_value(icon%,block%,offset%,convert%,RETURN flag%)
    
  LOCAL v,v%
   
  v=FNlocale_val(FNicon_read(papersize%,icon%))
  CASE icon% OF
    WHEN  8 
      v=FNlocale_val(FNicon_read(papersize%, 7 ))-v
    WHEN  11 
      v=FNlocale_val(FNicon_read(papersize%, 6 ))-v
  ENDCASE
  IF convert% THEN
    IF FNicon_set(papersize%, 23 )v%=v*mm_to_72000 ELSE v%=v*in_to_72000
  ELSE
    v%=v  
  ENDIF
  IF block%!offset%<>v% THEN
    flag%= -1 
    block%!offset%=v%

     
    IFpsize_edit% psize_edit%!offset%=v%
  ENDIF
ENDPROC

DEF PROCdelete_papersize
    
  LOCAL s$,psize%,last%,i%,prnt%
  SYS "Hourglass_On"
  s$=FNicon_read(papersize%, 5 )
  psize%=psize_head%
  WHILE psize%>0
   IF$psize%! 4 =s$ THEN
    IF psize%! 52 = 1  THEN
      

     prnt%=A%! 48 
     WHILE prnt%
      IF prnt%! 36 =psize% ERROR  254 ,FNmsg_0(A%! 12 ,"OKQa")
      prnt%=prnt%! 0 
     ENDWHILE
     IF last% THEN
      last%! 0 =psize%! 0 
     ELSE
      psize_head%=psize%! 0 
     ENDIF
     PROCfree_structure(psize%! 4 )
     B%= &455A5350 
     C%=psize%
     CALL code_entry%+ 16 
     PROCsave_user_defined_paper_sizes
    ELSE
     ERROR  254 ,FNmsg_0(A%! 12 ,"OKR")
    ENDIF
    FOR i%= 0  TO  52  STEP 4
      psize_edit%!i%=0
    NEXT
    PROCinitialise_papersize_window
    psize%=-1
   ELSE
    last%=psize%
    psize%=psize%! 0 
   ENDIF
  ENDWHILE
  IF psize%=0 ERROR  254 ,FNmsg_0(A%! 12 ,"OKQ")
  SYS "Hourglass_Off"
ENDPROC

   

DEF PROCopen_queue_window
    
  PROCtell_pinboard(A%! 40 )
  !task_buff%=A%! 40 
  SYS "Wimp_GetWindowInfo",,task_buff% OR 1
  task_buff%!48=task_buff%!56-(A%! 44 *line_space%*2)-(A%! 32 *line_space%)
  SYS "Wimp_SetExtent",A%! 40 ,task_buff%+44
  task_buff%!28=-1  
  SYS "Wimp_OpenWindow",,task_buff%
ENDPROC

DEF PROCredraw_prntctrl_entry(prnt%)
    
  IF NOT FNwindow_open(prntctrl%) ENDPROC
  !win_buff%=prntctrl%
  win_buff%!4=prnt%! 28 
  SYS "Wimp_GetIconState",,win_buff%
  SYS "Wimp_ForceRedraw",prntctrl%,win_buff%!8,win_buff%!12,win_buff%!16,win_buff%!20
ENDPROC

DEF PROCredraw_queue_entry(y%,prnt%,queu%)
  LOCAL more%
    
  IF NOT FNwindow_open(A%! 40 )ENDPROC
  IF y%=-1 THEN
    B%=prnt%
    C%=queu%
    y%=USR(code_entry%+ 48 )
      
  ENDIF
  !win_buff%=A%! 40 
  SYS "Wimp_GetWindowState",,win_buff%
    
  win_buff%!12=win_buff%!12-win_buff%!4
  win_buff%!4=0
  win_buff%!8=y%-line_space%
  win_buff%!16=y%
    
  SYS "Wimp_ForceRedraw",!win_buff%,win_buff%!4,win_buff%!8,win_buff%!12,win_buff%!16
  



ENDPROC

DEF PROCredraw_queue_block(y%,prnt%,queu1%,queu2%)
  LOCAL count%
    
  IF NOT FNwindow_open(A%! 40 )ENDPROC
  IF y%=-1 THEN
    B%=prnt%
    C%=queu%
    y%=USR(code_entry%+ 48 )
  ENDIF
  !win_buff%=A%! 40 
  SYS "Wimp_GetWindowState",,win_buff%
  win_buff%!12=win_buff%!12-win_buff%!4
  win_buff%!4=0
  count%=2
  WHILE queu1%<>queu2%
   count%+=1
   queu1%=queu1%! 0 
  ENDWHILE
  win_buff%!8=y%-line_space%*count%
  win_buff%!16=y%
  SYS "Wimp_ForceRedraw",!win_buff%,win_buff%!4,win_buff%!8,win_buff%!12,win_buff%!16
 



ENDPROC

DEF PROCadd_queue_entry(temp_file%,sender$,pathname$,leafname$,prnt%,type%)
  B%=temp_file%
  C%=task_buff%: $C%=sender$
  D%=buff1%: $D%=pathname$
  E%=buff1%+256: $E%=leafname$
  F%=prnt%
  G%=type%
  CALL code_entry%+ 24 
ENDPROC

DEF PROCdelete_queue_entry(prnt%,queu%,redraw%)
  LOCAL head%,p%,cnct%
    

   

  IF menued_prnt%=prnt% AND menued_queu%=queu% menued_queu%=0:SYS"Wimp_CreateMenu",-1

   

  p%=queu%! 44 
  IF p% THEN
    IF p%! 40  THEN
      prnt%! 24 =prnt%! 24  AND NOT  36 
      IF prnt%! 48  THEN
        !task_buff%=prnt%! 48 
        PROCclose_window
      ENDIF
    ENDIF
  ENDIF

   
  IF prnt%! 32 =queu% THEN
    prnt%! 32 =queu%! 0 
    head%=0
  ELSE
    head%=prnt%! 32 
    WHILE head%! 0 <>queu%
      head%=head%! 0 
    ENDWHILE
    head%! 0 =queu%! 0 
  ENDIF

  IF queu%! 12  THEN
    SYS "XOS_Find",,queu%! 12   
    queu%! 12 =0
    prnt%! 24 =prnt%! 24  AND NOT  8 
    PROCprinter_status(prnt%)
    IF NOT prnt%! 28  THEN
      buff1%!0=prntctrl%
      buff1%!4=prnt%! 28 
      buff1%!8=0
      buff1%!12=1<<22
      SYS "Wimp_SetIconState",,buff1%
    ENDIF
  ENDIF

   

  p%=0
  REPEAT
    SYS "PDriver_EnumerateJobs",p% TO p%
    IF p% IF p%=queu%! 40  OR p%=queu%! 72  SYS "PDriver_AbortJob",p%
  UNTIL p%=0

  IF queu%! 40  THEN
    cnct%=prnt%! 12 
     



    


    IF cnct%! 0 =1 OR cnct%! 0 =2 SYS "OS_Byte",21,FNbuffer(cnct%! 0 )
      
    SYS "XOS_Find",0,queu%! 40   
      
    queu%! 40 =0
    PROCbuffer_free(cnct%! 0 )

     


    !task_buff%=queu%
    PROCprinter_reason_code(prnt%! 4 ,prnt%,-7,task_buff%)
  ENDIF

  IF queu%! 72  THEN
    SYS "XOS_Find",,queu%! 72   
    queu%! 72 =0
  ENDIF
  SYS "XOS_File",6,$queu%! 68   
  PROCfree_structure(queu%! 68 )

   
  IF queu%? 11  AND 2 SYS "XOS_File",6,$queu%! 20 
    
  PROCfree_structure(queu%! 16 )
    
  PROCfree_structure(queu%! 20 )
    
  PROCfree_structure(queu%! 24 )
    
  p%=queu%! 44 
  IF p% THEN
    PROCfree_structure(p%! 104 )  
    PROCfree_structure(p%! 108 )  
    PROCfree_structure(p%! 112 )  
    PROCfree_structure(p%! 120 )  
    B%= &42555054 
    C%=p%
    CALL code_entry%+ 16 
  ENDIF

    
  IF queu%! 52  THEN
     B%= &46464254 
     C%=queu%! 52 
     CALL code_entry%+ 16 
  ENDIF
    
  B%= &55455551 
  C%=queu%
  CALL code_entry%+ 16 
  A%! 32 -=1
  IF A%! 32 <=0 A%! 20 =A%! 20  OR 1  

  IF redraw% THEN
    !task_buff%=A%! 40 
    SYS "Wimp_GetWindowInfo",,task_buff% OR 1
    IF task_buff%!32 AND 1<<16 THEN
      task_buff%!48=task_buff%!56-A%! 44 *line_space%*2-A%! 32 *line_space%
      SYS "Wimp_SetExtent",A%! 40 ,task_buff%+44
      SYS "Wimp_OpenWindow",,task_buff%
      B%=prnt%
      C%=head%
      CALL code_entry%+ 32 
    ENDIF
  ENDIF
ENDPROC

DEF PROCflush_queue(prnt%)
  LOCAL queu%,next%
    
  SYS "Hourglass_On"
  REPEAT
    queu%=prnt%! 32 
    IF queu% PROCdelete_queue_entry(prnt%,queu%, 0 )
  UNTIL queu%=0
  !task_buff%=A%! 40 
  SYS "Wimp_GetWindowInfo",,task_buff% OR 1
  IF task_buff%!32 AND 1<<16 THEN
    task_buff%!48=task_buff%!56-A%! 44 *line_space%*2-A%! 32 *line_space%
    SYS "Wimp_SetExtent",A%! 40 ,task_buff%+44
    SYS "Wimp_OpenWindow",,task_buff%
    B%=prnt%
    C%=0
    CALL code_entry%+ 32 
  ENDIF
  SYS "Hourglass_Off"
ENDPROC

DEF PROCdestroy_queue
  LOCAL prnt%
    
  prnt%=A%! 48 
  WHILE prnt%
    PROCflush_queue(prnt%)
    prnt%=prnt%! 0 
  ENDWHILE
   
  A%! 32 =0
ENDPROC

DEF PROCprocess_queue
   

  LOCAL last_queu%,j%,prnt%,queu%
    

  REPEAT
    IF A%! 24        A%! 24 =          !(A%! 24 + 0 )


    IF A%! 24 =0       A%! 24 =A%! 48 

  UNTIL A%! 24 

  prnt%=A%! 24 

  IF(prnt%! 24  AND  4 )=0 THEN
     

    A%! 28 =prnt%! 32 
    last_queu%=0
    WHILE A%! 28 
      IF ?(A%! 28 + 11 )AND 1 THEN
         
        A%! 28 =0
      ELSE
        IF ?(A%! 28 + 11 )AND 4 THEN
           
          last_queu%=A%! 28 
          A%! 28 =!(A%! 28 + 0 )
        ELSE
           
          IF !(A%! 28 + 12 )THEN
            PROCprint_file(prnt%,A%! 28 )
          ELSE
             

            IF(prnt%! 24  AND  32 )=0 THEN
              IF A%! 28 <>prnt%! 32  THEN
                 
                IF last_queu% last_queu%! 0 =                    !(A%! 28 + 0 )

                !(A%! 28 + 0 )=                    prnt%! 32 

                prnt%! 32 =A%! 28 
                PROCredraw_queue_block(-1,prnt%,                    A%! 28 ,last_queu%)

              ENDIF

               

              IF prnt_edit%=prnt% THEN
                !task_buff%=connections%
                PROCclose_window
              ENDIF

              j%=prnt%! 4 
              j%=j%! 20 
              WHILE j%
                IF $(j%+ 16 )="configure" THEN
                  IF j%! 12 =prnt% THEN
                    !task_buff%=j%! 4 
                    PROCclose_window
                  ENDIF
                ENDIF
                j%=j%! 0 
              ENDWHILE

              PROCprint_file(prnt%,A%! 28 )
            ENDIF
          ENDIF
           
          A%! 28 =0
        ENDIF
      ENDIF
    ENDWHILE
  ENDIF

   

  A%! 32 =0
  prnt%=A%! 48 
  WHILE prnt%
    queu%=prnt%! 32 
      
    WHILE queu%
      A%! 32 +=1
      queu%=queu%! 0 
    ENDWHILE
    prnt%=prnt%! 0 
  ENDWHILE

  IF A%! 32 =0     A%! 20 =A%! 20  OR 1

         
ENDPROC

DEF FNcheck_type(queu%,output_type%,RETURN alias$)
  LOCAL type$,i%,name$,psup%
    
  alias$=""
   
  type$=RIGHT$("00"+STR$~queu%! 36 ,3)
  SYS "XOS_ReadVarVal","Alias$@PrintType_"+type$,,-1 TO,,i%
  IF i%<0 alias$="@PrintType_"+type$: = -1 

  CASE queu%! 36  OF
    WHEN -1  
      name$=FNmsg_0(A%! 12 ,"UNT")
    WHEN &2000  
      PROCerror_box(FNmsg_0(A%! 12 ,"OKT"),1)
      = 0 
    WHEN &1000  
      PROCerror_box(FNmsg_0(A%! 12 ,"OKS"),1)
      = 0 
    WHEN &FFF,&AF8  
      queu%! 36 =&FFF
      = -1 
    WHEN &FD6,&FD7,&FEA,&FEB,&FFE  
      queu%! 36 =&FFE
      = -1 
    WHEN output_type%
      queu%! 36 =output_type%
      = -1 
    OTHERWISE
      name$=FNtask_read_env("File$Type_"+type$,task_buff%)
      IF name$=""         name$=FNmsg_1(A%! 12 ,"TYP",type$)

  ENDCASE

  CASE FNpicktype(name$,queu%)OF
    WHEN  4 
       
      queu%! 36 =&FFE
      = -1 
    WHEN  2 
       
      queu%! 36 =&FFF
      = -1 
  ENDCASE
= 0 

DEF FNpicktype(name$,queu%)
  LOCAL x%,y%,w%,h%
    
  PROCicon_write(howquery%, 0 ,      FNmsg_2(A%! 12 ,"WA5",name$,      $queu%! 24 ))


  SYS "Wimp_GetPointerInfo",,task_buff%
  x%=!task_buff%
  y%=task_buff%!4
  !task_buff%=howquery%
  SYS "Wimp_GetWindowState",,task_buff%
  w%=task_buff%!12-task_buff%!4
  h%=task_buff%!16-task_buff%!8
  task_buff%!4=x%-340  
  task_buff%!8=y%-120  
  task_buff%!12=task_buff%!4+w%
  task_buff%!16=task_buff%!8+h%
  task_buff%!28=-1
  SYS "Wimp_OpenWindow",,task_buff%
  PROCbound_mouse(howquery%)
  query_state%=0
  REPEAT
      
    PROCdespatch_poll(click_mask%)
  UNTIL query_state%
    
  !task_buff%=howquery%
  PROCclose_window
  PROCunbound_mouse
=query_state%

DEF PROCappend_file_tidyup(in%,out%,out_size%,in$)
   
  IFin% SYS"XOS_Find",0,in%
  IFout% EXT#out%=out_size%
  IFout% SYS"XOS_Find",0,out%
  SYS"XOS_File",6,in$
ENDPROC

DEF PROCappend_file(out$,in$)
  LOCAL in_f%,out_f%,in_size%,out_size%,i%
  LOCAL ERROR

  ON ERROR LOCAL RESTORE ERROR:PROCappend_file_tidyup(in_f%,out_f%,out_size%,in$):    PROCerror_box(REPORT$, 1):ENDPROC


    

  in_f%=OPENIN in$
  in_size%=EXT#in_f%

   
  IF in_size% THEN
    SYS"Hourglass_On"
    out_f%=OPENUP out$
    out_size%=EXT#out_f%  
    PTR#out_f%=out_size%

    FOR i%=1 TO in_size% DIV 512
      SYS "OS_GBPB",4,in_f%,buff1%,512  
      SYS "OS_GBPB",2,out_f%,buff1%,512  
    NEXT

    IF in_size% MOD 512       SYS "OS_GBPB",4,in_f%,buff1%,in_size% MOD 512  :       SYS "OS_GBPB",2,out_f%,buff1%,in_size% MOD 512  


    CLOSE#out_f%
    SYS"Hourglass_Off"
  ENDIF

  CLOSE#in_f%
  SYS "OS_File",6,in$  
ENDPROC

DEF PROCprint_file(prnt%,queu%)
  LOCAL psup%,cnct%,pr_type%,b%,t%,file$,t$,alias$,load%,size%,    finished%,s%,spooling%,ptmp$,check_type%,spool_file$


  LOCAL application$, leafname$, lpsup%, l%, f%

    

  psup%=prnt%! 4 
  cnct%=prnt%! 12 
  pr_type%=psup%! 28 

  IF queu%! 12 =0 THEN
      
     











     
     
     
     
      
    PROCselect_printer(prnt%, 0 , 0 )

     
    IF (prnt%! 24  AND  4 )<>0 ENDPROC

     
     
     
     
    file$=$queu%! 20 


     
    last_application$ = $queu%! 16 
    last_leafname$    = $queu%! 24 


     
    IF cnct%! 0 =5 THEN
      spooling%=(cnct%? 6  AND  2 )<>0
    ELSE
      spooling%=(cnct%? 6  AND  1 )<>0
    ENDIF

    IF spooling% THEN
      printer_output$=FNtemporary_name( 0 )
      IFprinter_output$="" THEN
        prnt%! 24  = prnt%! 24  OR  4 
        PROCprinter_status(prnt%)
        PROCredraw_queue_entry(-1,prnt%,0)
        ENDPROC
      ENDIF
      IFcnct%! 0 =5 THEN
         
       SYS "OS_SetVarVal","PrinterType$5",printer_output$,LEN printer_output$
       PROCfx5(5)
      ELSE
         
       SYS "OS_SetVarVal","PrinterType$10",printer_output$,LEN printer_output$
       PROCfx5(10)
      ENDIF
        
      spool_file$=printer_output$
    ENDIF

     
    ptmp$=FNtemporary_name( 0 )
    IFptmp$="" THEN
      prnt%! 24  = prnt%! 24  OR  4 
      PROCprinter_status(prnt%)
      PROCredraw_queue_entry(-1,prnt%,0)
      ENDPROC
    ENDIF
      
    SYS "OS_SetVarVal","Printer$Temp",ptmp$,LEN ptmp$

    task_buff%!0=48+LEN file$ AND NOT 3
    task_buff%!12=0
    task_buff%!16=&80145  
    task_buff%!40=queu%! 36 
    $(task_buff%+44)=file$+CHR$ 0
    SYS "Wimp_SendMessage",18,task_buff%
      
    type_state%=0
    REPEAT
      PROCdespatch_poll(message_mask%)
    UNTIL type_state%

    b%= -1 
    IF type_state%<>2 THEN
        
       

      b%=FNcheck_type(queu%,pr_type%,alias$)
      IF b% THEN
         
        IF alias$<>"" THEN
            
          SYS "Wimp_StartTask",alias$+" "+file$
        ENDIF
      ENDIF
    ENDIF

     





    IF NOTb% THEN
       
      PROCdelete_queue_entry(prnt%,queu%, -1 )
      ENDPROC
    ENDIF

    IF spooling% THEN
        
      s$=FNselect_connection(prnt%, -1 )
      IF s$<>"" THEN
        PROCerror_warning(s$)
        IF prnt%! 32  THEN
          prnt%! 24  = prnt%! 24  OR  4 
          PROCprinter_status(prnt%)
          PROCredraw_queue_entry(-1,prnt%,0)
        ENDIF
      ENDIF
    ENDIF

      
    IF NOT(queu%! 36 =&FFF OR queu%! 36 =&FFE OR         queu%! 36 =pr_type%)THEN

        

      SYS "OS_File",17,ptmp$ TO t%,,load%,,size%  
      IF t% THEN
          

         
        IF queu%? 11  AND 2 THEN
          IF file_to_delete$<>"" SYS "XOS_File",6,file_to_delete$  
               
          file_to_delete$=$queu%! 20 
               
        ENDIF

          
        PROCfree_structure(queu%! 20 )
        $task_buff%=ptmp$
        B%=task_buff%
        C%=2
        queu%! 20 =USR(code_entry%+ 28 )
        queu%! 28 =size%
        queu%! 36 =(load% AND &FFF00)>>8
          
        queu%? 11 =queu%? 11  OR 2
      ELSE
          
        IF spooling% THEN
             

           
          IF cnct%! 0 =5 THEN
             

            PROCappend_file($cnct%! 16 ,spool_file$)
            PROCdelete_queue_entry(prnt%,queu%, -1 )
          ELSE
              

            SYS "OS_File",17,spool_file$ TO b%,,,,size%  

            IF b%=0 OR size%=0 THEN
              REM nothing to print - remove the entry and the spool file
              SYS"XOS_File",6,spool_file$
              PROCdelete_queue_entry(prnt%,queu%, -1 )
            ELSE
               



              IF (queu%? 11  AND 2)                 SYS"XOS_File",6,$queu%! 20 

              PROCfree_structure(queu%! 20 )
              $task_buff%=spool_file$
              B%=task_buff%
              C%=2
              queu%! 20 =USR(code_entry%+ 28 )
              queu%! 28 =size%
              queu%! 36 =pr_type%
              queu%? 11 =queu%? 11  OR 2
            ENDIF
          ENDIF
        ELSE

          application$ = $queu%! 16 
          leafname$    = $queu%! 24 

          PROCdelete_queue_entry(prnt%,queu%, -1 )

          IF cnct%! 0  = 9 AND printer_prefix$ <> "" THEN
              
            name$ = $(prnt%! 40 )
            ptr% = INSTR(name$, " ")  
            WHILE ptr%
              MID$(name$,ptr%,1) = CHR$160
              ptr% = INSTR(name$, " ", ptr%+1)
            ENDWHILE
            sname$ = printer_prefix$+"RemSpool."+unique_string$+"."+name$
            qname$ = printer_prefix$+"RemQueue."+unique_string$+"."+STR$(remote_jobno%)

            SYS "XOS_File", 17, sname$ TO t%,,,,l% ; f%
            IF (l% > 0) AND ((f% AND 1) = 0) AND (t% = 1) THEN

              IF FNwrite_information_file (prnt%, application$, leafname$) THEN
                  
                lpsup% = selected_prnt%! 4 
                 
                SYS "XOS_FSControl", 25, sname$, qname$  
              ELSE
                  
                SYS "XOS_File", 6, sname$
              ENDIF
              last_application$ = ""
              last_leafname$ = ""
              s$=FNselect_connection(prnt%, -1 )
              IF s$<>"" THEN
                PROCerror_warning(s$)
              ENDIF

            ENDIF
          ENDIF

           


          PROCselect_printer(0, -1 , -1 )
        ENDIF
      ENDIF
    ELSE
        

       
        
      CASE cnct%! 0  OF
        WHEN 1
          IFprnt%! 24  AND  128  THEN
            printer_output$="devices#buffer"+STR$FNbuffer_ensure(1)+":$."+FNsupport_fast_parallel
          ELSE
            printer_output$="devices#buffer"+STR$ FNbuffer_ensure(1)+":$.Parallel"
          ENDIF
          SYS "OS_SetVarVal","PrinterType$1",printer_output$,LEN printer_output$
        WHEN 2
          printer_output$="devices#buffer"+STR$ FNbuffer_ensure(2)+              ":$.Serial"

          SYS "OS_SetVarVal","PrinterType$2",printer_output$,              LEN printer_output$

      ENDCASE

      SYS "Hourglass_On"
        
       

      IF cnct%! 0 =5 AND (cnct%? 6  AND  2 )<>0 THEN
        SYS "XOS_Find",&CF,printer_output$ TO b%;t%  

        IF(t% AND 1)=0 PTR#b%=EXT#b%  
      ELSE
        SYS "XOS_Find",&8F,printer_output$ TO b%;t%  

      ENDIF
      IF t% AND 1 i%=b%+4: CALL Z%,i%,t$  
      SYS "Hourglass_Off"

        
      PROCselect_printer(0, -1 , -1 )
      IF t% AND 1 THEN
         
        PROCpause_printer(prnt%)
        PROCbuffer_free(cnct%! 0 )
        ERROR  254 ,FNmsg_1(A%! 12 ,"OKP",t$)
      ENDIF
      queu%! 40 =b%
      SYS"XOS_Find",&40,$queu%! 20  TO queu%! 12 ;t%
      IF(t%AND1) queu%! 12  = 0
      IF queu%! 12 =0 THEN
         
        PROCdelete_queue_entry(prnt%,queu%, -1 )
        ERROR  254 ,FNmsg_1(A%! 12 ,            "OKAF",$queu%! 20 )

      ENDIF
      t$=FNtemporary_name( 0 )
      IFt$="" THEN
        prnt%! 24  = prnt%! 24  OR  4 
        PROCprinter_status(prnt%)
        PROCredraw_queue_entry(-1,prnt%,0)
        ENDPROC
      ENDIF
        
      SYS "XOS_File",11,t$,&FFD TO b%;t%  
      IF(t% AND 1)=0 SYS "XOS_Find",&CF,t$ TO b%;t%  

      IF t% AND 1 THEN
        PROCpause_printer(prnt%)
        b%+=4
        CALL Z%,b%,s$  
        ERROR  254 ,FNmsg_1(A%! 12 ,"OKP",s$)
      ENDIF
      queu%! 72 =b%
      $task_buff%=t$
      B%=task_buff%
      C%=2
      queu%! 68 =          USR(code_entry%+ 28 )

        
      B%= &46464254 
      C%= 1024 
      s%=USR(code_entry%+ 12 )
      IF s%=0 ERROR  253 ,          FNmsg_1(A%! 12 ,"FA5","TBFF")

      queu%! 52 =s%
      prnt%! 24 =prnt%! 24  OR  8 
      PROCprinter_status(prnt%)
      PROCredraw_queue_entry(-1,prnt%,0)
      IF queu%! 36 <>pr_type% THEN
        IF prnt%! 24  AND  64  THEN
          PROCdelete_queue_entry(prnt%,queu%, -1 )
          IF prnt%! 40 =0             s$=$prnt%! 8            ELSE             s$=$prnt%! 40 



          ERROR  254 ,              FNmsg_1(A%! 12 ,"OKAC",s$)

        ENDIF
        PROCstart_job(queu%,pr_type%)
      ENDIF
       
    ENDIF
     
  ELSE
     










    IF EOF#queu%! 12  AND queu%! 56 =0 THEN
       
      t%=EXT#queu%! 72 -          PTR#queu%! 72 

      IF t% THEN
        IF cnct%! 0 =1 OR cnct%! 0 =2 THEN
          SYS "OS_Byte",128,NOT FNbuffer(cnct%! 0 )TO              ,size%,load%

          size%=size% OR load%<<8
          IF size%> 1024  size%= 1024 
        ELSE
          size%=  1024 /2 
        ENDIF

        PROCprocess_scratch_file(queu%,t%,size%)
        ENDPROC
      ENDIF

       
      finished%= -1 

       
      IF cnct%! 0 =1 OR cnct%! 0 =2 THEN
        SYS "OS_Byte",152,FNbuffer(cnct%! 0 )TO;b%
        IF(b% AND 2)=0 finished%= 0 
      ENDIF

      IF finished% THEN
         

        PROCprinter_status(prnt%)

        application$ = $queu%! 16 
        leafname$    = $queu%! 24 

        PROCdelete_queue_entry(prnt%,queu%, -1 )

        IF cnct%! 0  = 9 AND printer_prefix$ <> "" THEN
  
          name$ = $(prnt%! 40 )
          ptr% = INSTR(name$, " ")  
          WHILE ptr%
            MID$(name$,ptr%,1) = CHR$160
            ptr% = INSTR(name$, " ", ptr%+1)
          ENDWHILE
          sname$ = printer_prefix$+"RemSpool."+unique_string$+"."+name$
          qname$ = printer_prefix$+"RemQueue."+unique_string$+"."+STR$(remote_jobno%)
          IF FNwrite_information_file (prnt%, application$, leafname$) THEN
             
           lpsup% = selected_prnt%! 4 
            
           SYS "XOS_FSControl", 25, sname$, qname$
          ELSE
             
           SYS "XOS_File", 6, sname$
          ENDIF
          s$=FNselect_connection(prnt%, -1 )
          IF s$<>"" THEN
            PROCerror_warning(s$)
          ENDIF
        ENDIF

      ENDIF
    ELSE
      PROCjob_chunk(prnt%,queu%,pr_type%)
    ENDIF
  ENDIF
ENDPROC

   

DEF PROCstart_job(queu%,output_type%)
  LOCAL i%,p%,name$
  LOCAL ERROR
  ON ERROR LOCAL RESTORE ERROR: PROCjob_chunk_error(A%! 24 ,A%! 28 )
    
   
  B%= &42555054 
  C%= 124 
  p%=USR(code_entry%+ 12 )
  IF p%=0 ERROR  253 ,FNmsg_1(A%! 12 ,"FA5","TPUB")
  queu%! 44 =p%
  IF 0<= 124 -4
    FOR i%=0 TO  124 -4 STEP 4
      p%!i%=0
    NEXT
  ENDIF

  ?buff1%=3
  SYS "OS_Word",14,buff1%
  SYS "OS_ConvertStandardDateAndTime",buff1%,buff1%+5,250
  B%=buff1%+5
  C%=2
  p%! 120 =USR(code_entry%+ 28 )
  IF queu%? 11  AND 2 THEN
    name$=$queu%! 16 +" - "+$queu%! 24 
  ELSE
    name$=$queu%! 20 
    IF LEN name$>40 THEN
      name$=RIGHT$(name$,40)
      name$=MID$(name$,1+INSTR(name$,"."))
    ENDIF
  ENDIF
  $task_buff%=name$
  B%=task_buff%
  C%=2
  p%! 112 =USR(code_entry%+ 28 )
  p%! 16 =1  
  $task_buff%=STRING$(32," ")
  B%=task_buff%
  C%=5
  D%=32
  p%! 104 =USR(code_entry%+ 28 )  
  p%! 96 =&80
  PROCtext_printer_code(A%! 24 ,A%! 28 ,-1)
ENDPROC

DEF PROCjob_chunk_error(prnt%,queu%)
    
    
   
  PROCdelete_queue_entry(prnt%,queu%, -1 )
   
  IF prnt%! 32 <>0 THEN
    prnt%! 24  = prnt%! 24  OR  32 
    PROCprinter_status(prnt%)
  ENDIF
  ERROR  254 ,FNmsg_1(A%! 12 ,"OKPa",REPORT$)
ENDPROC

DEF PROCjob_chunk(prnt%,queu%,output_type%)
  LOCAL l%,t%,new_perc%,len%,b$,p%,tpub%,cnct%,text%,psup%
  LOCAL ERROR
  ON ERROR LOCAL RESTORE ERROR: PROCjob_chunk_error(prnt%,queu%)
    

  cnct%=prnt%! 12 
  psup%=prnt%! 4 
  tpub%=queu%! 44 

  IF cnct%! 0 =1 OR cnct%! 0 =2 THEN
    SYS "OS_Byte",128,NOT FNbuffer(cnct%! 0 )TO,len%,l%
    len%=len% OR l%<<8
      
    IF len%> 1024  len%= 1024 
  ELSE
    len%=  1024 /2 
  ENDIF

   

  l%=EXT#queu%! 72 -PTR#queu%! 72 
  IF queu%! 56  l%=0
    
  IF l% PROCprocess_scratch_file(queu%,l%,len%): ENDPROC

  SYS "Hourglass_On"
  l%=queu%! 28 -PTR#queu%! 12 

  IF queu%! 36 =output_type% THEN
    IF PTR#(queu%! 12 )=0 THEN
      task_buff%!8=queu%! 40 
      task_buff%!12=queu%! 12 
      PROCtext_printer_code(prnt%,queu%,-20)
    ENDIF

     
    IF l%>len% l%=len%
      
    SYS "OS_GBPB",4,queu%! 12 ,task_buff%,l%  
    SYS "OS_GBPB",2,queu%! 40 ,task_buff%,l%  
  ELSE
    IF queu%! 36 =&FFF OR (psup%! 32  AND 1)<>0 THEN
       
      CASE tpub%! 92  OF
        WHEN 0
          task_buff%!8=queu%! 72 
          PROCtext_printer_code(prnt%,queu%,-2)
          queu%! 32 =-1
          tpub%! 92 =1
        WHEN 1
          task_buff%!8=queu%! 72 
          PROCtext_printer_code(prnt%,queu%,-3)
          queu%! 32 =0
          tpub%! 92 =2
        WHEN 2
          IF psup%! 32  AND 2 THEN
            IF queu%! 56 =0 THEN
              PROCtext_trans(0)
              task_buff%!8=queu%! 56 
              PROCprinter_buffer(queu%,FNtext_printer_string(prnt%,queu%,-4))
              PROCoutput_buffer(prnt%,queu%,len%)
               

              IF tpub%! 92 =3 THEN
                task_buff%!8=queu%! 72 
                PROCtext_printer_code(prnt%,queu%,-14)
                tpub%! 92 =1
              ENDIF
            ELSE
              PROCoutput_buffer(prnt%,queu%,len%)
            ENDIF
          ELSE
            IF queu%! 56 =0 THEN
               



              t%=  1024 /4 
              IF t%>len% t%=len%
              queu%! 60 =0
              PROCtext_trans(t%)
              IF tpub%! 40  THEN
                 
                PROCpause_printer(prnt%)
                PROCopen_pause_window(prnt%)
                p%=tpub%! 40 
              ENDIF
            ENDIF
            IF len%>queu%! 56  len%=queu%! 56 
            IF tpub%! 40 <>0 AND len%>p% len%=p%
              
            IF len%               SYS "OS_GBPB",2,queu%! 40 ,                  queu%! 52 +queu%! 60 ,len%


                   
            queu%! 56 -=len%
            queu%! 60 +=len%
          ENDIF
      ENDCASE
    ELSE
       
      t%=LEN FNprinter_read_string(tpub%! 108 )
        
      WHILE l% AND len%>t%
        b$=FNtext_plain(BGET#queu%! 12 ,tpub%)
        l%-=1
        IF b$<>"" BPUT#queu%! 40 ,b$;
        len%-=LEN b$
      ENDWHILE
    ENDIF
  ENDIF

   
  IF EOF#queu%! 12  AND queu%! 56 =0 THEN
    task_buff%!8=queu%! 72 
    PROCtext_printer_code(A%! 24 ,        A%! 28 ,-15)

  ENDIF

  IF queu%! 28 =0     new_perc%=0   ELSE     new_perc%=PTR#queu%! 12 *100/queu%! 28 




  IF new_perc%<>queu%! 32  THEN
    queu%! 32 =new_perc%
      
    PROCredraw_queue_entry(-1,prnt%,queu%)
  ENDIF

   
  PTR#queu%! 72 =0
  SYS "Hourglass_Off"
ENDPROC

DEF PROCprocess_scratch_file(queu%,to_do%,len%)
    
  IF to_do%>len% to_do%=len%
  SYS "OS_GBPB",4,queu%! 72 ,task_buff%,to_do%  
  SYS "OS_GBPB",2,queu%! 40 ,task_buff%,to_do%  
  IF EXT#queu%! 72 -PTR#queu%! 72 =0 THEN
    PTR#queu%! 72 =0
    EXT#queu%! 72 =0
  ENDIF
ENDPROC

DEF FNtext_plain(C%,tpub%)
  LOCAL r$
    

  IF C%=10 OR C%=13 THEN
    IF tpub%! 16 =1 OR tpub%! 16 =C%       r$=FNprinter_read_string(tpub%! 108 )


    tpub%! 16 =C%
  ELSE
    IF tpub%! 16  r$=FNprinter_read_string(tpub%! 108 )
    r$+=CHR$ C%
  
    tpub%! 16 =0
  ENDIF
=r$

DEF PROCprinter_buffer(queu%,s$)
  LOCAL prbff_ptr%,prbff%
    
  prbff%=queu%! 52 
  prbff_ptr%=queu%! 56 
  IF s$<>"" THEN
    $(prbff%+prbff_ptr%)=s$
    queu%! 56 +=LEN s$
  ENDIF
ENDPROC

DEF PROCoutput_buffer(prnt%,queu%,len%)
  LOCAL prbff_ptr%,prbff%
    
  prbff%=queu%! 52 
  prbff_ptr%=queu%! 56 
  IF prbff_ptr% THEN
    IF cnct%! 0 =1 OR cnct%! 0 =2 THEN
      IF prbff_ptr%>=len% ENDPROC
    ENDIF
    prbff%?prbff_ptr%=10
    prbff_ptr%+=1
    prbff%?prbff_ptr%=13
    SYS "OS_GBPB",2,queu%! 40 ,prbff%,prbff_ptr%  
    queu%! 56 =0
  ENDIF
ENDPROC

DEF PROCtext_printer_code(prnt%,queu%,code%)
   




    
    
    
  task_buff%!0=code%
  task_buff%!4=queu%
  PROCprinter_reason_code(prnt%! 4 ,prnt%,-8,task_buff%)
ENDPROC

DEF FNtext_printer_string(prnt%,queu%,code%)
  LOCAL s$,i%
    

  task_buff%!0=code%
  task_buff%!4=queu%
  PROCprinter_reason_code(prnt%! 4 ,prnt%,-8,task_buff%)

  i%=task_buff%+8
  CALL Y%,i%,s$  
=s$

DEF PROCtext_trans(F%)
  LOCAL psup%
    
  psup%=prnt%! 4 
  B%=psup%
  C%=queu%
  D%=tpub%
  E%=buff1%+128
  E%!0=psup%
  E%!4=prnt%
  E%!8=queu%
  E%!12=tpub%
  E%!16=task_buff%
  E%!20=buff1%+356
  $(buff1%+356)=CHR$ &A4+$psup%! 4 +"_support("+STR$ buff1%+")"
  buff1%!0=-8
  buff1%!4=psup%
  buff1%!8=prnt%
  buff1%!12=task_buff%
  buff1%!16=psize_head%
  buff1%!20=code_entry%
  buff1%!24=F%
  IF F%=0 CALL code_entry%+ 4  ELSE CALL code_entry%+ 0 
ENDPROC

 
 
 

DEF FNbuffer_ensure(t%)
    
  CASE t% OF
    WHEN 1
       
      IF A%! 80 =0 THEN
        IF A%! 76 <>3 THEN
          A%! 80 =3
        ELSE
          A%! 80 =10
        ENDIF
      ENDIF
      =A%! 80 
    WHEN 2
       
      IF A%! 76 =0 THEN
        IF A%! 80 <>3 THEN
          A%! 76 =3
        ELSE
          A%! 76 =2
        ENDIF
      ENDIF
      =A%! 76 
  ENDCASE
=0

DEF PROCbuffer_free(t%)
    
  CASE t% OF
    WHEN 1
      A%! 80 =0
    WHEN 2
      A%! 76 =0
  ENDCASE
ENDPROC

DEF FNbuffer(t%)
    
  CASE t% OF
    WHEN 1
      =A%! 80 
    WHEN 2
      =A%! 76 
  ENDCASE
=0

DEF FNsupport_higher_baudrates
LOCAL r0%,r1%
SYS"OS_ReadSysInfo",3 TO r0%,r1%
REM if bits 12-15 of R0 = 1 and bits 12-15 of R1 = 1 then yes we do
IF(r0%AND61440)=4096 AND (r1%AND61440)=4096 := -1 
= 0 

DEF FNsupport_fast_parallel
LOCAL r0%
SYS"OS_File",5,"Devices:FastParallel" TO r0%
IFr0%<>0 THEN
 := "FastParallel"
ELSE
 := "Parallel"
ENDIF

DEF FNrmload_latest_module(name$, path$)
 









LOCAL ram_version%, rom_version%, disc_version%
LOCAL ptr%,f%,r1%,r2%,r6%,s$,rom_state%

ram_version%=-1
SYS"XOS_Module",18,name$ TO ,,,ptr%;f%
IF(f%AND1)=0 AND ptr%!&14<>0 THEN
 ptr%+=(ptr%!&14)
 WHILE ?ptr%<>9 AND ?ptr%<>0
  ptr%+=1
 ENDWHILE
 IF?ptr%<>0 THEN
  ram_version%=0:ptr%+=1
  WHILE ?ptr%<>32
   IF?ptr%>=ASC"0" AND ?ptr%<=ASC"9" THEN
    ram_version%=ram_version%*10+?ptr%-ASC"0"
   ENDIF
   ptr%+=1
  ENDWHILE
 ENDIF
ENDIF

rom_version%=-1
r1%=0:r2%=-1
REPEAT
 SYS"XOS_Module",20,r1%,r2% TO ,r1%,r2%,ptr%,rom_state%,,r6%;f%
 IF(f%AND1)=0 THEN
  CALL Z%,ptr%,s$
  IFs$=name$ rom_version%=VAL(STR$~(r6%))/100
 ENDIF
UNTIL (rom_version%<>-1) OR (f%AND1)<>0

disc_version%=-1
SYS"XOS_Find",&43,path$ TO f%;ptr%
IF(ptr%AND1) f%=0
IFf%<>0 THEN
 PTR#f%=&14:ptr%=BGET#f%+((BGET#f%)<<8)+((BGET#f%)<<16)+((BGET#f%)<<24)
 IFptr%<>0 THEN
  PTR#f%=ptr%
  REM find the start of the version number
  REPEAT
   r1%=BGET#f%
  UNTIL r1%=0 OR r1%=9
  IFr1%<>0 THEN
   disc_version%=0
   REPEAT
    r1%=BGET#f%
    IFr1%>=ASC"0" AND r1%<=ASC"9" THEN
     disc_version%=disc_version%*10+r1%-ASC"0"
    ENDIF
   UNTIL r1%=32
  ENDIF
 ENDIF
 CLOSE#f%
ENDIF

 
IFram_version%>rom_version% r1%=ram_version% ELSE r1%=rom_version%
IFr1%>disc_version% f%=r1% ELSE f%=disc_version%

 
r1%=0
 
IFrom_version%=f% THEN
 IFrom_state%<1 THEN
  SYS"XOS_Module",4  , name$
  SYS"XOS_Module",3  , name$ TO ptr%;r1%
 ENDIF
ENDIF

 
IFdisc_version%=f% AND disc_version%>rom_version% AND disc_version%>ram_version%THEN
 SYS"XOS_Module",1  , path$ TO ptr%;r1%
ENDIF

 
IF(r1%AND1)=0 SYS"XOS_Module",18,name$ TO ptr%;r1%
IF(r1%AND1) !ptr%= 253 :SYS"OS_GenerateError",ptr%

 
=f%

#line 1 "sources.Sparrow"


DEF PROCinitialise_sparrow (startup%)

  LOCAL f%, g%, fs%, rps%, s$

    

  multiple_choices% =  0 

   
  IFFNrmload_latest_module("PDriver","Printers:Modules.PDriver")
  IFFNrmload_latest_module("RemotePrinterSupport","Printers:Modules.RemPrnSpt")

  fs%=0
  SYS "XOS_Module", 18, "Freeway" TO ;f%
  IF (f% AND 1) = 0 THEN
    SYS "XOS_SWINumberFromString",,"Freeway_Status" TO ;g%
    IF (g% AND 1) = 0 THEN SYS "XFreeway_Status",0 TO ,fs% ELSE fs% = 1
  ENDIF
  SYS "XOS_Module", 18, "RemotePrinterSupport" TO ;rps%
  SYS "XOS_Module", 18, "ShareFS" TO ;g%

  IF (f% AND 1) OR (fs% = 0) OR (g% AND 1) OR (rps% AND 1) THEN
    sparrow_present% =  0 
  ELSE
  
    SYS "XOS_CLI", "RMEnsure ShareFS 2.00 ERROR Foo" TO ;f%
    
    IF (f% AND 1) THEN
      sparrow_present% =  0 
    ELSE
    
      unique_string$ = FNtask_read_env("Inet$LocalAddr", task_buff%)
    
      sparrow_present% =  -1 
      PROCfreeway_register
    
      PROCenumerate_remote_printers
    
      SYS "XRemotePrinterSupport_Enable", 2  
    
      printer_scrap$ = "<Wimp$ScrapDir>.Printers"
    
      s$ = FNtask_read_env ("Printers$Dir", task_buff%)
      IF INSTR(s$, "Share:") THEN
        multiple_choices% =  -1 
      ELSE
        multiple_choices% =  0 
      ENDIF
      
    ENDIF

  ENDIF

   



  IF (rps% AND 1) = 0 THEN
    SYS "XRemotePrinterSupport_ReadPollwordLocation" TO pollword_location%
  ENDIF

  IF multiple_choices% THEN
    SYS "XOS_File", 8, "<Printers$Path>Remote" TO ; f%
    s$ = "<Printers$Path>Remote.ID"+unique_string$
    SYS "XOS_File", 8, s$ TO ; f%
  ENDIF

ENDPROC


DEF PROCfreeway_register

    

  SYS "Freeway_Register",  0 ,  2 

ENDPROC


DEF FNconvert_null(nullstr%)

  LOCAL thing$

  CALL Z%, nullstr%, thing$

= thing$


DEF PROCenumerate_queue_directory


  ENDPROC

































































DEF PROCenumerate_remote_printers

  LOCAL here%, enum_ref%, new_enum_ref%, nlen%, dlen%, ip%, name$, err%
  LOCAL printer_name%, printer_descriptor%, name$, descriptor$, rmtp%, doit%

    

  enum_ref% = 0
  new_enum_ref% = 0

  remote_printer_count% = 0

  REPEAT
      

    enum_ref% = new_enum_ref%

    SYS "Freeway_Enumerate", 0,  2 , 0, 0, 0, 0, 0, enum_ref%                              TO ,,nlen%,,dlen%,,,new_enum_ref%


       

    IF (new_enum_ref% > 0) THEN

        

      printer_name%        = FNmalloc ( &47525453 , nlen%)
      printer_descriptor%  = FNmalloc ( &47525453 , dlen%+1)
      printer_name1%        = FNmalloc ( &30525453 , nlen%)
      printer_descriptor1%  = FNmalloc ( &30525453 , dlen%+1)

        

      SYS "Freeway_Enumerate", 0,  2 , nlen% , printer_name1%,                                dlen%+1, printer_descriptor1%, 0, enum_ref%                                TO ,,,,,,ip%



       

      printer_descriptor1%?dlen% = 0

      $printer_name% = FNconvert_null (printer_name1%)
      $printer_descriptor% = FNconvert_null (printer_descriptor1%)

      PROCfree ( &30525453 , printer_name1%)
      PROCfree ( &30525453 , printer_descriptor1%)

        

      rmtp% = FNconstruct_rmtp (printer_name%, printer_descriptor%, ip%)

      PROCadd_to_list (remote_printers%, rmtp%)

        

      name$ = $printer_name%  

      IF FNprinter_wanted (name$) THEN
        junk% = FNensure_printer (rmtp%, 0,  0 ,  -1 , err%)
        IF NOT err% THEN
          PROCremove_unavailable_printer (name$)
          PROCremove_remote_printer (name$)
          IF selected_prnt%=0 THEN
            IF A%! 44  THEN
              doit%=A%! 48 
              WHILE doit%
                IF NOT doit%! 20  THEN
                    
                  PROCselect_printer(doit%, -1 , 0 )
                  doit%=0
                ELSE
                  doit%=doit%! 0 
                ENDIF
              ENDWHILE
            ENDIF
          ENDIF
        ENDIF
      ENDIF

      remote_printer_count% += 1

    ENDIF  

  UNTIL (new_enum_ref% < 0)
ENDPROC


DEF PROCadd_remote_printer (name$)
   



  LOCAL printer_name%, printer_descriptor%, dlen%, ip%, descriptor$, flags%, rmtp%, junk$, doit%, err%, found%

  SYS "XFreeway_Read", 0,  2 , name$, 0, 0 TO ,,,dlen%,,ip% ; flags%
  IF (flags% AND 1) THEN
     
      
    ENDPROC
  ENDIF

   




  found% =  0 
  rmtp% = remote_printers%
  WHILE rmtp%
    IF ($rmtp%! 4  = name$) AND ((rmtp%! 20 ) <= 0) THEN
        
      ENDPROC
    ENDIF
    rmtp% = rmtp%! 0 
  ENDWHILE

  printer_name% = FNmalloc ( &47525453 , LENname$ + 1)
  printer_descriptor% = FNmalloc ( &47525453 , dlen% + 1)
  printer_descriptor1% = FNmalloc ( &30525453 , dlen% + 1)

  $printer_name% = name$
  
  SYS "XFreeway_Read", 0,  2 , name$, dlen% + 1, printer_descriptor1% TO ; flags%
  IF (flags% AND 1) THEN
     
    ENDPROC
  ENDIF

  printer_descriptor1%?dlen% = 0

  $printer_descriptor% = FNconvert_null (printer_descriptor1%)

  PROCfree ( &30525453 , printer_descriptor1%)

  rmtp% = FNconstruct_rmtp (printer_name%, printer_descriptor%, ip%)

  PROCadd_to_list (remote_printers%, rmtp%)

  remote_printer_count% += 1

  IF FNprinter_wanted (name$) THEN
    junk% = FNensure_printer (rmtp%, 0,  0 ,  -1 , err%)

    IF NOT err% THEN 
      PROCremove_unavailable_printer (name$)
      PROCremove_remote_printer (name$)
      IF selected_prnt%=0 THEN
        IF A%! 44  THEN
          doit%=A%! 48 
          WHILE doit%
            IF NOT doit%! 20  THEN
                
              PROCselect_remote_printer(doit%, -1 , 0 , -1 ,err%)
              doit%=0
            ELSE
              doit%=doit%! 0 
            ENDIF
          ENDWHILE
        ENDIF
      ENDIF
    ENDIF
  ENDIF

  PROCcreate_installed_printer_icons

ENDPROC


DEF PROCremove_unavailable_printer (name$)

  LOCAL last%, here%, found%, iter%

  here%  = remote_printers%
  last%  = 0
  found% =  0 

  IF here% THEN

    REPEAT
  
      IF ($here%! 4 ) = name$ AND here%! 20  > 0 THEN
        found% =  -1 
      ELSE
        last% = here%
        here% = here%! 0 
      ENDIF
    UNTIL found% OR (here% = 0)

    IF (last% = 0) AND (here% <> 0) THEN   
   
      remote_printers% = here%! 0 

      PROCicon_delete (-2, here%! 20 )
  
      PROCfree ( &47525453 , here%! 4 )
  
        PROCfree ( &47525453 , here%! 8 )
  
      PROCfree ( &524D5450 , here%)

    ELSE
      IF here% THEN  
  
        last%! 0  = here%! 0 

        PROCicon_delete (-2, here%! 20 )
  
        PROCfree ( &47525453 , here%! 4 )
  
        PROCfree ( &47525453 , here%! 8 )
  
        PROCfree ( &524D5450 , here%)

      ENDIF
    ENDIF

  ENDIF

ENDPROC


DEF FNprinter_wanted (name$)

  LOCAL here%, wanted%

  here% = remote_printers%
  wanted% =  0 

  WHILE here% AND NOT wanted%
    IF $here%! 4  = name$ AND here%! 20  > 0 THEN
      wanted% =  -1 
    ELSE
      here% = here%! 0 
    ENDIF
  ENDWHILE

= wanted%


DEF PROCremove_remote_printer (name$)

  LOCAL prnt%, last_prnt%, ptr%, cnct%, doit%, type$, psup%, class$

    


  IF FNmember_of_list (remote_printers%, name$) THEN
     
    PROCremove_from_list (remote_printers%, name$)
  ELSE
    last_prnt% = 0
    prnt% = A%! 48 
    ptr% = prnt%
    cnct% = prnt%! 12 

    WHILE ptr%
      IF $ptr%! 40  = name$ AND cnct%! 0  = 9 THEN
         
        ptr% = 0
      ELSE
        last_prnt% = prnt%
        prnt% = prnt%! 0 
        ptr% = prnt%
        cnct% = prnt%! 12 
      ENDIF
    ENDWHILE

    IF prnt% THEN
      psup% = prnt%! 4 
      class$ = $psup%! 4 
      type$ = $prnt%! 8 
      PROCadd_unavailable_printer (name$, class$, type$)
      PROCremove_this_printer (prnt%,last_prnt%)
      PROCdelete_prdata_entry (type$)
    ENDIF
  ENDIF

  IF FNwindow_open (prntctrl%) THEN
    PROCcreate_installed_printer_icons
    PROCwin_open (prntctrl%)
  ENDIF

ENDPROC


DEF FNip_string(ip%)
= STR$~ip%


 



DEF FNmalloc (ident%, size%)

  LOCAL ret%

  B% = ident%
  C% = size%

    

  ret% = USR (code_entry% +  12 )
  IF (ret% = 0) THEN
    ERROR  253 , FNmsg_1 (A%! 12 , "FA5",         CHR$((B% AND &FF000000) >> 24)+CHR$((B% AND &00FF0000) >> 16)+CHR$((B% AND &0000FF00) >> 8)+CHR$(B% AND &000000ff))

  ENDIF

= ret%


DEF PROCfree (ident%, block%)
    
  B% = ident%
  C% = block%
  CALL code_entry% +  16 

ENDPROC


DEF PROCstrcpy (RETURN dest%, str$)

  $task_buff% = str$
  B% = task_buff%
  C% = 2

  dest% = USR(code_entry%+ 28 )

ENDPROC


 

    

DEF FNconstruct_rmtp (printer_name%, printer_descriptor%, printer_ip_address%)

  LOCAL ret%

    

   



  ret% = FNmalloc ( &524D5450 ,  24 )

   



  ret%! 0  = 0
  ret%! 4  = printer_name%
  ret%! 8  = printer_descriptor%
  ret%! 12  = printer_ip_address%
  ret%! 16  = -1
  ret%! 20  = -1

= ret%

DEF FNconstruct_unavailable (name$, icon%, desc$)

  LOCAL ret%, str%, desc%
  
  ret% = FNmalloc ( &524D5450 ,  24 )

   



  PROCstrcpy (str%, name$)
  PROCstrcpy (desc%, desc$)

  ret%! 0  = 0
  ret%! 4  = str%
  ret%! 8  = desc%
  ret%! 12  = -1
  ret%! 16  = -1
  ret%! 20  = icon%

= ret%

DEF PROCadd_to_list (RETURN list%, item%)

   





  LOCAL here%

    

  IF list% = 0 THEN
      

    list% = item%
  ELSE
    here% = list%
    
      

      
    WHILE (here%! 0  <> 0)
      here% = here%! 0 
        
    ENDWHILE

    here%! 0  = item%
  ENDIF
ENDPROC


DEF FNmember_of_list (RETURN list%, name$)

  LOCAL here%
   
  IF list% = 0 THEN
     
    =  0 
  ELSE
    here% = list%
    WHILE here%
      IF $here%! 4  = name$ THEN
        = -1 
      ELSE
        here% = here%! 0 
      ENDIF
    ENDWHILE
  ENDIF

= 0 


DEF PROCremove_from_list (RETURN list%, name$)

  LOCAL last%, here%, found%, iter%

  IF list% THEN
    here%  = list%
    last%  = 0
    found% =  0 

    REPEAT
  
      IF ($here%! 4 ) = name$ THEN
        found% =  -1 
      ELSE
        last% = here%
        here% = here%! 0 
      ENDIF
    UNTIL found% OR (here% = 0)

    IF (last% = 0) AND (here% <> 0) THEN   
   
      list% = here%! 0 

      PROCfree ( &47525453 , here%! 4 )
      PROCfree ( &47525453 , here%! 8 )
      PROCfree ( &524D5450 , here%)

    ELSE 
     IF here% THEN  
  
      last%! 0  = here%! 0 

  
      PROCfree ( &47525453 , here%! 4 )
  
      PROCfree ( &47525453 , here%! 8 )
  
      PROCfree ( &524D5450 , here%)
     ENDIF
    ENDIF
  ENDIF
       
ENDPROC


DEF PROCpollword_changed

  LOCAL reason%, prnt%, cnct%, doit%
  LOCAL name%, bufsize%, s$, psup%, s%, t%, l%, t$, ptr%

  REPEAT
    SYS "XRemotePrinterSupport_GetNextEvent",,,-1 TO reason%,,bufsize%
       
    IF reason% > 0 THEN  

       





      IF bufsize% > 0 THEN  
        name% = FNmalloc ( &47525453 , bufsize%)
        SYS "XRemotePrinterSupport_GetNextEvent",,name%, bufsize%
      ELSE
        SYS "XRemotePrinterSupport_GetNextEvent",,0, 0
      ENDIF

      CASE reason% OF
        WHEN  1 
            
            
          IF selected_prnt% THEN
            cnct% = selected_prnt%! 12 
            IF cnct%! 0  = 9 AND printer_prefix$ <> "" THEN
  
              t$ = $(selected_prnt%! 40 )

              ptr% = INSTR(t$, " ")
              WHILE ptr%
                MID$(t$,ptr%,1) = CHR$160
                ptr% = INSTR(t$, " ", ptr%+1)
              ENDWHILE

              sname$ = printer_prefix$+"RemSpool."+unique_string$+"."+t$
              qname$ = printer_prefix$+"RemQueue."+unique_string$+"."+STR$(remote_jobno%)

               
               
              SYS "XOS_File", 17, sname$ TO t%,,,,l% ; f%
              IF (l% > 0) AND ((f% AND 1) = 0) AND (t% = 1)THEN
                IF last_application$ = "" THEN
                  last_application$ = FNmsg_0(A%! 12 , "UNKN")
                ENDIF
                IF last_leafname$ = "" THEN
                  last_leafname$ = FNmsg_0(A%! 12 , "UNKN")
                ENDIF
                IF FNwrite_information_file (selected_prnt%, last_application$, last_leafname$) THEN
                   
                 psup% = selected_prnt%! 4 
                  
                 SYS "XOS_FSControl", 25, sname$, qname$  
                ELSE
                   
                 SYS "XOS_File", 6, sname$
                ENDIF
                last_application$ = ""
                last_leafname$ = ""
                s$=FNselect_connection(selected_prnt%, -1 )
                IF s$<>"" THEN 
                   PROCerror_warning(s$)
                ENDIF
              ENDIF
            ENDIF
          ENDIF

        WHEN  2 
            
            
          PROCadd_to_queue (FNconvert_null (name%))

        WHEN  3 
            
            
          IF sparrow_present% THEN
            PROCadd_remote_printer (FNconvert_null (name%))
          ENDIF

        WHEN  4 
            
            
          PROCremove_remote_printer (FNconvert_null (name%))

        WHEN  5 
            
            

        WHEN  6 
            
            
          PROClocalprinter_deleted (FNconvert_null (name%))

        WHEN  7 
            
            
          PROCremove_remote_available_printers
          PROCinitialise_sparrow ( 0 )
REM          freeway_just_started% = 1
    
        WHEN  8 
            
            
          PROCfreeway_terminating
      
      ENDCASE
      IF (bufsize% > 0) THEN
        PROCfree ( &47525453 , name%)
      ENDIF
      
    ENDIF
  UNTIL reason% < 0
  IF selected_prnt%=0 THEN
    IF A%! 44  THEN
      doit%=A%! 48 
      WHILE doit%
        IF NOT doit%! 20  THEN
            
          PROCselect_printer(doit%, -1 , 0 )
          doit%=0
        ELSE
          doit%=doit%! 0 
        ENDIF
      ENDWHILE
    ENDIF
  ENDIF

ENDPROC


DEF PROCfreeway_starting

  PROCremove_remote_available_printers
  PROCinitialise_sparrow ( 0 )
  freeway_just_started% = 0

ENDPROC
       

DEF PROClocalprinter_deleted (name$)
ENDPROC


DEF FNset_jobno

  LOCAL qname$, f%, v%, w%, e$, num%, first%

  

  REPEAT 
      
    qname$ = printer_prefix$+"RemQueue."+unique_string$+"."+STR$remote_jobno%
    SYS "XRemotePrinterSupport_DisableUpcalls"
    SYS "XOS_File", 5, qname$ TO v%; f%
    SYS "XRemotePrinterSupport_EnableUpcalls"
    IF f% AND 1 THEN
       


      remote_jobno% = -1
      = FNmsg_0 (A%! 12 , "OKAS", FNconvert_null(v%+4))
    ENDIF

    IF (v%<>0) THEN  
      remote_jobno% += 1
    ENDIF

  UNTIL v%=0

=""


DEF PROCadd_to_queue (filename$)
  LOCAL fullpath$, infopath$, handle%, printer$, leafname$, c%, prnt%
  LOCAL ptr%, name$, psup%, type%, sender_id$, application$

   







  leafname$ = MID$(filename$, INSTR(filename$, ".") + 1)
  fullpath$ = printer_scrap$+"."+filename$
  infopath$ = printer_scrap$+".RemQueue."+leafname$+"I"
  printer$ = ""
  sender$ = ""

    
    

  h% = OPENIN infopath$
  IF h% = 0 THEN
     


      
    ENDPROC
  ENDIF

   



  c% = BGET#h%
  WHILE (NOT EOF#h%) AND (c% <> 0)
    printer$ += CHR$c%
    c% = BGET#h%
  ENDWHILE

    

   



  c% = BGET#h%
  WHILE (NOT EOF#h%) AND (c% <> 0)
    sender_id$ += CHR$c%
    c% = BGET#h%
  ENDWHILE

      

   



  c% = BGET#h%
  WHILE (NOT EOF#h%) AND (c% <> 0)
    application$ += CHR$c%
    c% = BGET#h%
  ENDWHILE

      

   


  leafname$ = ""
  c% = BGET#h%
  WHILE (NOT EOF#h%) AND (c% > 31)
    leafname$ += CHR$c%
    c% = BGET#h%
  ENDWHILE

  CLOSE# h%

    

  SYS "XOS_File", 6, infopath$  

   




      

  ptr% = A%! 48   
  prnt% = 0

  WHILE (ptr%)

     



    IF (ptr%! 40  = 0) THEN
      psup% = ptr%! 4 
      name$ = $(psup%! 4 )
    ELSE
      name$ = $(ptr%! 40 )
    ENDIF

      

    IF name$ = printer$ THEN 
      prnt% = ptr%
      ptr% = 0
    ELSE
      ptr% = ptr%! 0 
    ENDIF
    
  ENDWHILE

    
    

    

   




  IF (prnt% <> 0) THEN
      

    psup% = prnt%! 4 
     
    SYS "XOS_File", 23, fullpath$ TO ,,,,,,type%
      
     
    PROCadd_queue_entry ( -1 , "("+FNmsg_0 (A%! 12 , "IC9")+") "+application$, fullpath$, leafname$, prnt%, type%)
  ENDIF

ENDPROC

DEF PROCsave_sender_info (receiver_handle%, leaf$)

  LOCAL e%, f%

  SYS "XTaskManager_TaskNameFromHandle",receiver_handle% TO e% ; f%

  IF (f% AND 1) THEN
    last_application$ = FNmsg_0(A%! 12 , "UNKN")
    last_leafname$ = FNmsg_0(A%! 12 , "UNKN")
  ELSE
      
    last_application$ = FNconvert_null (e%)
    last_leafname$ = leaf$
  ENDIF

ENDPROC

DEF FNwrite_information_file (prnt%, application$, leaf$)
  REM returns  -1  if successful, else  0 
  LOCAL filename$, h%, f%, name$, ptr%

  filename$ = printer_prefix$+"RemQueue."+unique_string$+"."+STR$(remote_jobno%)+"I"

  name$ = $prnt%! 40 









  SYS "XOS_Find", &83, filename$ TO h%;f%
  IF (f%AND1) h%=0
  IF h% <> 0 THEN
      
    BPUT#h%, name$+CHR$0+unique_string$+CHR$0+application$+CHR$0+leaf$
    SYS "XOS_Find", 0, h% TO ;f%
  ENDIF

  IF (f%AND1) OR h%=0 := 0 

= -1 

DEF PROCshare_printer

  LOCAL prnt%, icon%, rmtp%

   



    

  IF NOTFNinitialise_scrap THEN
    PROCerror_box(FNmsg_0(A%! 12 , "OKAV"),1)
    ENDPROC
  ENDIF

    

  IF INSTR(FNscrap_location, "Share:") > 0 THEN
    PROCerror_warning (FNmsg_0 (A%! 12 , "OKAT"))
    ENDPROC
  ENDIF

  REPEAT

    PROCfind_prnt (prnt%, rmtp%, icon%)

    PROCicon_deselect (prntctrl%, icon%)

    IF prnt% AND ((prnt%! 24  AND  (1<<17) ) = 0) THEN
      PROCshare_one_printer (prnt%)
    ENDIF

  UNTIL (prnt% = 0) AND (rmtp% = 0)

ENDPROC


DEF PROCshare_one_printer (prnt%)

  LOCAL name$, vptr%, buf%, vlen%, thing$, f%, r0%, f$, xprnt%, xname$, psup%

   






    IF (prnt%! 24  AND  (1<<17) ) > 0 THEN
      ENDPROC
    ENDIF

    IF (prnt%! 40  = 0) THEN
      psup% = prnt%! 4 
      name$ = $(psup%! 4 )
    ELSE
      name$ = $(prnt%! 40 )
    ENDIF

    IF NOTFNinitialise_scrap THEN
      PROCerror_box(FNmsg_1(A%! 12 , "OKAW",name$),1)
      prnt%! 24  = prnt%! 24  AND (NOT  (1<<16) )
      ENDPROC
    ENDIF

    IF INSTR(FNscrap_location, "Share:") > 0 THEN
      PROCerror_warning (FNmsg_1 (A%! 12 , "OKAU", name$))
      prnt%! 24  = prnt%! 24  AND (NOT  (1<<16) )
      ENDPROC
    ENDIF

    desc$ = $(prnt%! 8 )

    IF (prnt%! 24  AND  1 ) = 0 THEN
      PROCactivate_this_printer (prnt%)
    ENDIF

    vptr% = 0

    REPEAT

        

      SYS "XOS_ReadVarVal", "Inet$LocalAddr*", 0, 1<<31, vptr%, 0 TO ,,vlen%

        

       






      IF vlen% < 0 THEN

        buf% = FNmalloc ( &47525453 , NOT(vlen%) + 1)

          

        IF (buf% > 0) THEN

          SYS "OS_ReadVarVal", "Inet$LocalAddr*", buf%, NOT(vlen%), vptr%, 0 TO ,,,vptr%

          buf%?(NOT(vlen%)) = 0  

          thing$ = FNconvert_null (buf%)

          PROCfree ( &47525453 , buf%)

            
            

           




          f$ = "unshare _S"+thing$
          SYS "XOS_CLI", f$

           



          f$ = "share <Wimp$ScrapDir>.Printers _S"+thing$+" -noicon"
          SYS "XOS_CLI", f$

        ENDIF

      ENDIF

    UNTIL vlen% >= 0

    PROCshare_one_prdata (prnt%, name$)

    SYS "XFreeway_Read", 0,  2 , name$, 0, 0 TO ,,,,,ip% ; f%

    IF (f% AND 1) = 0 THEN
      PROCerror_warning (FNmsg_1 (A%! 12 , "OKAQ", name$))
      ENDPROC
    ENDIF

    xprnt% = A%! 48 

    WHILE xprnt%

      IF (xprnt%! 40  = 0) THEN
        psup% = xprnt%! 4 
        xname$ = $(psup%! 4 )
      ELSE
        xname$ = $(xprnt%! 40 )
      ENDIF

      IF (xname$ = name$) AND ((xprnt%! 24  AND  (1<<16) ) > 0) THEN
        PROCerror_warning (FNmsg_1 (A%! 12 , "OKAQa", name$))
        ENDPROC
      ENDIF

      xprnt% = xprnt%! 0 

    ENDWHILE

    SYS "XFreeway_Write", 0,  2 , name$, LENdesc$, desc$ TO r0% ; f%
  
    IF (f% AND 1) THEN
       
      PROCerror_warning (FNmsg_1 (A%! 12 , "OKAQ", name$))
      ENDPROC
    ENDIF

    prnt%! 24  = prnt%! 24  OR  (1<<16) 

ENDPROC


DEF PROCunshare_one_printer (prnt%)

  LOCAL name$, vlen%, buf%, lptr%, desc$, thing$, psup%

   



  IF (prnt%! 40  = 0) THEN
    psup% = prnt%! 4 
    name$ = $(psup%! 4 )
  ELSE
    name$ = $(prnt%! 40 )
  ENDIF

  IF (prnt%! 24  AND  (1<<16) ) THEN
  
  
  
    prnt%! 24  = prnt%! 24  AND  (&FFFFFFFF - (1<<16)) 
  
  ENDIF

  IF sparrow_present% THEN
    SYS "Freeway_Write", 1,  2 , name$, 0, 0
  ENDIF

    
     
ENDPROC

DEF PROCunshare_directories



































ENDPROC

DEF PROCsparrow_local_file
   

    
  sparrow_saved_data_block%=data_block%
  sparrow_saved_data_ptr%=data_ptr%
  sparrow_saved_data_ptrc%=!data_ptr%
  sparrow_saved_data_size%=data_size%
  sparrow_saved_data_line%=data_line%
  sparrow_saved_data_file$=data_file$
ENDPROC

DEF PROCsparrow_restore_file
   
    
  data_block%=sparrow_saved_data_block%
  data_ptr%=sparrow_saved_data_ptr%
  !data_ptr%=sparrow_saved_data_ptrc%
  data_size%=sparrow_saved_data_size%
  data_line%=sparrow_saved_data_line%
  data_file$=sparrow_saved_data_file$
ENDPROC

DEF PROCsparrow_local_file_2
   

    
  sparrow_saved_data_block2%=data_block%
  sparrow_saved_data_ptr2%=data_ptr%
  sparrow_saved_data_ptrc2%=!data_ptr%
  sparrow_saved_data_size2%=data_size%
  sparrow_saved_data_line2%=data_line%
  sparrow_saved_data_file2$=data_file$
ENDPROC

DEF PROCsparrow_restore_file_2
   
    
  data_block%=sparrow_saved_data_block2%
  data_ptr%=sparrow_saved_data_ptr2%
  !data_ptr%=sparrow_saved_data_ptrc2%
  data_size%=sparrow_saved_data_size2%
  data_line%=sparrow_saved_data_line2%
  data_file$=sparrow_saved_data_file2$
ENDPROC

DEF FNensure_printer(rmtp%, settings_flags%, in_settings%, ret_error%, RETURN error%)
  LOCAL scrap$, settings$, class$
  LOCAL printer$, s$, rempath$, name$, raise_error%
  LOCAL flags%, fileptr%, cl%, sn%, found%, p%, prnt%
  LOCAL ERROR

  error% =  0 

    

  SYS "Hourglass_On"

  scrap$  = "Share::_S"+FNip_string (rmtp%! 12 )+".$"

  flags% = 0 
  SYS "XRemotePrinterSupport_DisableUpcalls"
  SYS "XOS_File", 17, scrap$ TO ; flags%
  SYS "XRemotePrinterSupport_EnableUpcalls"
  IF (flags% AND 1) THEN
    IF ret_error% THEN
      error% =  -1 
    ELSE
      PROCerror_warning(FNmsg_1 (A%! 12 ,"OKAOs", $rmtp%! 4 ))
    ENDIF
    SYS "Hourglass_Off"
    = 0
  ENDIF

  name$ = $rmtp%! 4 
  p% = INSTR(name$, " ")  
  WHILE p%
    MID$(name$,p%,1) = CHR$160  
    p% = INSTR(name$, " ", p%+1)  
  ENDWHILE

  rempath$ = scrap$+"."+name$

    

  prnt% = FNadd_remote_to_prdata(rmtp%, rempath$, settings_flags%, in_settings%, ret_error%, error%)

  SYS "Hourglass_Off"

= prnt%


DEF FNadd_remote_to_prdata (rmtp%, prpath$, flags%, in_settings%, ret_error%, RETURN error%)
  LOCAL name%,psup%,ptr%,s$,ntry%,prdata%,last_prdata%,this_prhead%,matched%,fix_up%, last_prhead%
  LOCAL prnt%, cnct%, junk$, class$, cl%, i%, last_prdata1%, tmpt%, saved_prhead%, odb%, ods%, prd%
  LOCAL new_prhead%, error%, raise_error%

  error% =  0 

    
  IF NOT FNload_file (prpath$) THEN
    SYS "Hourglass_Off"
    IF ret_error% THEN
      error% =  -1 
      = 0
    ELSE
      PROCerror_warning (FNmsg_1(A%! 12 ,"OKAOs",$rmtp%! 4 ))
    ENDIF
  ENDIF
  SYS "Hourglass_On"

  PROCvalidate_prdata_file(psup%)
  this_prhead%=psup%! 12 
  IF this_prhead% THEN
     
    prdata%=this_prhead%! 4 
    IF prdata% THEN
       


      ptr%=!data_ptr%
      ntry%=psup%! 8 
      ntry%=ntry%! 4 
      ts%=FNmatch_line($(ntry%+ 16 ))
      IF ts% THEN
         
        WHILE prdata%
          IF $prdata%! 8 =$ts% THEN
            PROCrelease_file
            SYS "Hourglass_Off"
            prnt% = FNinstall_remote_printer($rmtp%! 4 , $rmtp%! 8 ,psup%,prdata%,in_settings%, ret_error%, error%)
            = prnt%
          ENDIF
          last_prdata%=prdata%
          prdata%=prdata%! 0 
        ENDWHILE
         

      ELSE
         
        PROCvalidate_error(FNmsg_1(A%! 12 ,"OKZc",            $(ntry%+ 16 )))

      ENDIF
      !data_ptr%=ptr%
    ELSE
      last_prdata%=0
    ENDIF
  ELSE
    last_prdata%=0
  ENDIF

    
  PROCprocess_one_entry(psup%! 8 ,last_prdata%,this_prhead%,0,      matched%,fix_up%,psup%)

  PROCrelease_file
    
  psup%! 24 =psup%! 24  OR 2
       

  prnt% = FNinstall_remote_printer($rmtp%! 4 , $rmtp%! 8 ,psup%,last_prdata%,in_settings%, ret_error%, error%)

  SYS "Hourglass_Off"

= prnt%



DEF PROCremove_one_printer (prnt%)
  LOCAL i%,ptr%,last_prnt%,private_buff%,doit%,type$, icon%, rmtp%, dontcare%
    

  PROCfind_prnt (dontcare%, rmtp%, icon%)
  IF (NOT dontcare%) AND rmtp% THEN
     


    ENDPROC
  ENDIF

  SYS "Hourglass_On"

   





  ptr% = A%! 48 
  WHILE ptr%
    IF ptr%! 0  = prnt% THEN
      last_prnt% = ptr%
      ptr% = 0
    ELSE
      ptr% = ptr%! 0 
    ENDIF
  ENDWHILE

  

  type$=$prnt%! 8 
  PROCremove_this_printer(prnt%,last_prnt%)
  PROCdelete_prdata_entry(type$)

  IF selected_prnt%=0 THEN
     
    IF A%! 44  THEN
      doit%=A%! 48 
      WHILE doit%
        IF NOT doit%! 20  THEN
            
          PROCselect_printer(doit%, -1 , 0 )
          doit%=0
        ELSE
          doit%=doit%! 0 
        ENDIF
      ENDWHILE
    ENDIF
  ENDIF

   

  IF selected_prnt%=0 PROCtell_the_world
  B%= &58585858 
  C%=private_buff%
  CALL code_entry%+ 16 
   
  PROCcreate_installed_printer_icons
  IF FNwindow_open(prntctrl%) THEN 
    PROCwin_open(prntctrl%)
  ENDIF
  SYS "Hourglass_Off"
ENDPROC

DEF FNpsup_used (psup%)

  LOCAL prnt%, ret%

  prnt% = A%! 48 
  ret% =  0 

   






  
  WHILE prnt%
  
    IF prnt%! 4  = psup% THEN
      ret% =  -1 
      prnt% = 0
    ELSE
      prnt% = prnt%! 0 
    ENDIF
  ENDWHILE

  

= ret%

DEF FNunavailable_count

  LOCAL here%, ret%

  ret% = 0

  here% = remote_printers%

  WHILE here%
    IF here%! 20  > 0 THEN
      ret% += 1
    ENDIF
    here% = here%! 0 
  ENDWHILE

= ret%

DEF PROCfreeway_terminating

  LOCAL prnt%, doit%

  IF NOT sparrow_present% THEN
    ENDPROC
  ENDIF

   



  prnt% = A%! 48 
  WHILE prnt%
    IF prnt%! 24  AND  (1<<17)  THEN
      PROCremove_remote_printer ($prnt%! 40 )
    ENDIF
    prnt% = prnt%! 0 
  ENDWHILE

   


  PROCremove_remote_available_printers

  PROCcreate_installed_printer_icons

  IF selected_prnt%=0 THEN
    IF A%! 44  THEN
      doit%=A%! 48 
      WHILE doit%
        IF NOT doit%! 20  THEN
            
          PROCselect_printer(doit%, -1 , 0 )
          doit%=0
        ELSE
          doit%=doit%! 0 
        ENDIF
      ENDWHILE
    ENDIF
  ENDIF

  sparrow_present% =  0 

ENDPROC

DEF PROCremove_remote_available_printers

  LOCAL here%, next%, doit%

  here% = remote_printers%

  WHILE here%  
    next% = here%! 0 
    IF here%! 20  <= 0 THEN
      PROCremove_remote_printer ($here%! 4 )
    ENDIF
    here% = next%
  ENDWHILE
  IF selected_prnt%=0 THEN
    IF A%! 44  THEN
      doit%=A%! 48 
      WHILE doit%
        IF NOT doit%! 20  THEN
            
          PROCselect_printer(doit%, -1 , 0 )
          doit%=0
        ELSE
          doit%=doit%! 0 
        ENDIF
      ENDWHILE
    ENDIF
  ENDIF

ENDPROC

DEF FNpsup_multiple_res(psup%,id$,s$)
    
="Printers:Remote.ID"+id$+"."+$psup%! 4 +"."+s$

DEF PROCadd_config (prnt%)

ENDPROC



DEF FNinstall_remote_printer(name$,desc$,psup%,prdt%,in_settings%, ret_error%, RETURN error%)
  LOCAL s%,t%,s$,prnt%,cnct%
    
   

    
    
    
    

  error% =  0 

 

  prdt%!(prdt%! 4 *4+ 8 )+=1

  B%= &544E5250 
  C%= 68 
  prnt%=USR(code_entry%+ 12 )
  IF prnt%=0     ERROR  254 ,FNmsg_1(A%! 12 ,"FA5","PRNT")

   
  IF A%! 48  THEN
    s%=A%! 48 
    WHILE s%! 0 
      s%=s%! 0 
    ENDWHILE
    s%! 0 =prnt%
  ELSE
    A%! 48 =prnt%
  ENDIF
  prnt%! 0 =0
  prnt%! 4 =psup%
  B%=prdt%! 8 
  C%=2
  prnt%! 8 =USR(code_entry%+ 28 )
    
  B%= &54434E43 
  C%= 36 
  cnct%=USR(code_entry%+ 12 )
  IF cnct%=0     ERROR  254 ,FNmsg_1(A%! 12 ,"FA5","CNCT")


  cnct%! 0  = 9  
  cnct%? 4 =1+((s% AND %11100)>>2)
  cnct%? 5 =0
  SYS "OS_Byte",161,16 TO,,s%
  cnct%! 8 =(s% AND %11100000)>>5
  IF NOT FNeconet_installed THEN
    cnct%! 12 =0
  ELSE
    SYS "OS_Byte",161,3 TO,,s%
    SYS "OS_Byte",161,4 TO,,t%
    IF s% THEN
       
      $task_buff%=STR$ t%+"."+STR$ s%
      B%=task_buff%
      C%=2
      cnct%! 12 =USR(code_entry%+ 28 )
    ELSE
      s$=CHR$ t%
      FOR s%=1 TO 5
        SYS "OS_Byte",161,152+s% TO,,t%
        IF t% s$+=CHR$ t% ELSE s%=5
      NEXT
      $task_buff%=s$
      B%=task_buff%
      C%=2
      cnct%! 12 =USR(code_entry%+ 28 )
    ENDIF
  ENDIF
  SYS "XOS_ReadVarVal","PrinterType$5",buff1%,256,,3 TO,,t%
  buff1%?t%=13
  B%=buff1%
  C%=2
  cnct%! 16 =USR(code_entry%+ 28 )
  cnct%! 20 =0
  cnct%! 24 =0
  cnct%! 28 =0
  cnct%! 32 =0
  cnct%? 6 =0
  prnt%! 12 =cnct%
  B%= &47464E43 
  C%=4*psup%! 36 
  s%=USR(code_entry%+ 12 )
  IF s%=0 ERROR  254 ,FNmsg_1(A%! 12 ,"FA5","CNFG")
  IF 0<=psup%! 36 -1 THEN
    FOR t%=0 TO psup%! 36 -1
      s%!(t%*4)=0
    NEXT
  ENDIF
  prnt%! 16 =s%
  prnt%! 20 =-1  
  prnt%! 24 =0  
  prnt%! 28 =-1  
  prnt%! 32 =0  

   
  prnt%! 36 =0  
  prnt%! 40 =0  
  prnt%! 44 =0  
  IF psup%! 32  AND %100 THEN
     
    prnt%! 48 =FNallocate_pause_window
  ELSE
    prnt%! 48 =0
  ENDIF
  prnt%! 52 =0
  PROCprinter_reason_code(psup%,prnt%,-4,0)
  IF psup%! 24  AND %100 PROCprinter_reason_code(psup%,prnt%,-12,0)
  PROCstrcpy (prnt%! 40 , $rmtp%! 4 )
  PROCcreate_installed_printer_icons  

  IF psup%! 24  AND %1000 THEN
    prnt%! 56 =10*psup%?( 24 +1)
  ELSE
    prnt%! 56 =-1
  ENDIF
    

   

  prnt%! 24  = prnt%! 24  OR  (1<<17) 

  IF NOT in_settings% THEN
    PROCactivate_this_remote_printer(prnt%, ret_error%, error%)
  ENDIF
= prnt%


DEF PROCadd_unavailable_printer (name$, class$, desc$)

  LOCAL prnt%, icon%, side%, p%, ih%, here%

  prnt% = A%! 48 
  IF NOT prnt% THEN
      icon% = &0F000000
      side% = -5
  ELSE
      icon% = FNleft_of (prnt%)
      side% = -3
  ENDIF
  spr$ = "su_"+class$

  

  ih% = FNiconbar_tands (name$, spr$, side%, icon%)

  PROCadd_to_list (remote_printers%, FNconstruct_unavailable (name$, ih%, desc$))

  IF A%! 48  = 0 AND main_icon% > 0 THEN
    PROCicon_delete (-1, main_icon%)
    main_icon% = -1
  ENDIF

ENDPROC


DEF PROCinitialise_one_remote_printer(prnt%)
  LOCAL ts%,prdt%,d%,cnct%,h%,nm$,head%, psup%
    

       
    

  cnfg% = prnt%! 16 
  psup% = prnt%! 4 

  h%=FNevaluate($FNmatch_line_or_error("cs:"))
    
  IF 0<=h%-1 THEN
    FOR d%=0 TO h%-1
      ts%=FNmatch_any_line
      IF ts% THEN
        ss%=FNmatch_string(ts%,"nl:")
        IF ss% THEN
          cnfg%!(d%*4)=0
        ELSE
          ss%=FNmatch_string(ts%,"in:")
          IF ss% THEN
            cnfg%!(d%*4)=FNstore_integer(FNevaluate($ss%))
          ELSE
            ss%=FNmatch_string(ts%,"st:")
            IF ss% THEN
              B%=ss%
              C%=2
              cnfg%!(d%*4)=USR(code_entry%+ 28 )
            ELSE
              ss%=FNmatch_string(ts%,"s0:")
              IF ss% THEN
                B%=ss%
                C%=3
                cnfg%!(d%*4)=USR(code_entry%+ 28 )
              ELSE
                ss%=FNmatch_string(ts%,"gs:")
                IF ss% THEN
                  B%=ss%
                  C%=4
                  cnfg%!(d%*4)=USR(code_entry%+ 28 )
                ELSE
                  ss%=FNmatch_string(ts%,"pt:")
                  IF ss% THEN
                    B%= &52544F50 
                    C%=4
                    cnfg%!(d%*4)=USR(code_entry%+ 12 )
                    IF cnfg%!(d%*4)=0                       ERROR  253 ,FNmsg_1(A%! 12 ,"FA5","POTR")

                    !cnfg%!(d%*4)=FNfix_up_prdata_pointer($ss%)  
                  ELSE
                    PROCsettings_error(FNmsg_1(A%! 12 ,"OKH",$ts%))
                  ENDIF
                ENDIF
              ENDIF
            ENDIF
          ENDIF
        ENDIF
      ENDIF
    NEXT
  ENDIF
  
  PROCactivate_this_printer (prnt%)

ENDPROC

DEF FNscrap_location

= FNtask_read_env ("Wimp$ScrapDir", msg_text%)


DEF PROCshare_one_prdata (prnt%, name$)
  LOCAL psup%,head%,prdt%,c%,tmpt%,ntry%,list%,i%,j%,k%,l%,s$,p%,oname$, tmp%, gotit%, level%

    

  SYS "Hourglass_On"
  psup%=prnt%! 4 

  oname$ = $prnt%! 8 

  IF psup% THEN
   IF psup%! 8  THEN
     
      

     

    p% = INSTR(name$, " ")  
    WHILE p%
      MID$(name$,p%,1) = CHR$160  
      p% = INSTR(name$, " ", p%+1)  
    ENDWHILE








    c% = OPENOUT("<Wimp$ScrapDir>.Printers."+name$)
    BPUT#c%, "cl: "+$psup%! 4 

    tmpt%=psup%! 8 
    head%=psup%! 12 
     IF $(tmpt%+ 12 ) <> "printers" THEN
       BPUT#c%,$(tmpt%+ 12 )+":"
       BPUT#c%,"#"
     ENDIF
     prdt%=head%! 4 
     WHILE prdt%
      IF prdt%!(prdt%! 4 *4+ 8 )THEN
       ntry%=tmpt%! 4 
       i%=prdt%+ 8 
  
       IF LEFT$($(ntry%+ 16 ), 6) = "pr_nme" THEN
  
         IF FNprinter_read_string(!i%) = oname$ THEN
           gotit% =  -1  
         ELSE
           gotit% =  0 
         ENDIF
       ELSE
         gotit% =  -1 
       ENDIF
         WHILE ntry%
          IF gotit% THEN BPUT#c%,$(ntry%+ 16 )+" ";
          IF !i%=0 THEN
           IF ntry%! 4 =6 THEN
             IF gotit% THEN BPUT#c%,48  
           ELSE
             IF ntry%! 4 =1 THEN
               IF gotit% THEN BPUT#c%,48  
             ENDIF
           ENDIF
           IF gotit% THEN BPUT#c%,10
          ELSE
           j%=!i%  
           CASE ntry%! 4  OF
            WHEN 1
             IF gotit% THEN BPUT#c%,STR$ !j%
            WHEN 2
             IF gotit% THEN BPUT#c%,FNprinter_read_string(j%)
            WHEN 3
             IF gotit% THEN BPUT#c%,FNprinter_read_string(j%)
            WHEN 4
             IF gotit% THEN BPUT#c%,FNungstrans(FNprinter_read_string(j%))
            WHEN 5
             IF gotit% THEN BPUT#c%,10
             CASE ntry%! 8  OF
              WHEN 1
               IF gotit% THEN BPUT#c%," "+STR$ !j%! 0 +", "+STR$ !j%! 4 
              WHEN 2
               IF gotit% THEN BPUT#c%," "+FNprinter_read_string(j%! 0 )
               IF gotit% THEN BPUT#c%," "+FNprinter_read_string(j%! 4 )
              WHEN 3
               IF gotit% THEN BPUT#c%," "+FNprinter_read_string(j%! 0 )
               IF gotit% THEN BPUT#c%," "+FNprinter_read_string(j%! 4 )
              WHEN 4
               IF gotit% THEN BPUT#c%," "+FNungstrans(FNprinter_read_string(j%! 0 ))
               IF gotit% THEN BPUT#c%," "+FNungstrans(FNprinter_read_string(j%! 4 ))
              WHEN 7
               IF gotit% THEN BPUT#c%," ";
               IF gotit% THEN PROCfollow_pointer(!j%! 0 ,psup%,c%,level%)
               IF gotit% THEN BPUT#c%,", ";
               IF gotit% THEN PROCfollow_pointer(!j%! 4 ,psup%,c%,level%)
             ENDCASE
            WHEN 6
             k%=j%
             l%=0
             WHILE k%
              l%+=1
              k%=!k%
             ENDWHILE
             IF gotit% THEN BPUT#c%,STR$ l%
             WHILE j%
              IF 0<=j%! 4 -1 THEN
                FOR k%=0 TO j%! 4 -1
                 l%=j%!(k%*4+ 8 )
                 CASE l%!-4 OF
                  WHEN  &47544E49 
                   IF gotit% THEN BPUT#c%," "+STR$ !l%+", ";
                  WHEN  &47525453 
                   IF gotit% THEN BPUT#c%," "+$l%+", ";
                  WHEN  &30525453 
                   CALL Z%,l%,s$  
                   IF gotit% THEN BPUT#c%," "+s$+", ";
                  WHEN  &52545347 
                   CALL Y%,l%,s$  
                   IF gotit% THEN BPUT#c%," "+FNungstrans(s$)+", ";
                  WHEN  &52544F50 
                   IF gotit% THEN PROCfollow_pointer (!l%, psup%, c%, level%)
                   IF gotit% THEN BPUT#c%, "##"
                 ENDCASE
                NEXT
              ENDIF
              IF gotit% THEN PTR#c%=PTR#c%-2
              IF gotit% THEN BPUT#c%,10
              j%=!j%
             ENDWHILE
            WHEN 7
             IF gotit% THEN PROCfollow_pointer (!j%, psup%, c%, level%)
            WHEN 8
             k%=j%
             l%=0
             WHILE k%
              l%+=1
              k%=!k%
             ENDWHILE
             IF gotit% THEN BPUT#c%,STR$ l%
             WHILE j%
              s$=CHR$ j%?4
              IF 1<=j%?5 THEN
               FOR k%=1 TO j%?5
                s$+=CHR$ j%?(k%+5)
               NEXT
              ENDIF
              IF gotit% THEN BPUT#c%," "+FNungstrans(s$)
              j%=!j%
             ENDWHILE
           ENDCASE
          ENDIF
          ntry%=ntry%! 0 
          i%+=4
         ENDWHILE
         IF gotit% THEN BPUT#c%,"#"
      ENDIF
      prdt%=prdt%! 0 
     ENDWHILE

    CLOSE#c%






    SYS "XOS_File",18,"<Wimp$ScrapDir>.Printers."+name$,&FC6  
    SYS "XOS_File", 4, "<Wimp$ScrapDir>.Printers."+name$,,,,3  






   ENDIF
  ENDIF


  SYS "Hourglass_Off"
ENDPROC

DEF PROCfollow_pointer (ptr%, psup%, c%, level%)

  LOCAL template$, tmpt%, ntry%, found%, i%, j%, ptr$, tmp%, k%, l%, p%, s$

  level% += 1

  ptr$ = FNdiscover_ptr (ptr%, psup%)
  
  ntry% = INSTR(ptr$, ":")
  template$ = MID$(ptr$, 1, ntry% - 1)

  

  tmpt% = psup%! 8 
  found% =  0 
  WHILE tmpt% AND NOT found%
  
    IF $(tmpt%+ 12 ) = template$ THEN
      found% =  -1 
    ELSE
      tmpt% = tmpt%! 0 
    ENDIF
  ENDWHILE

  IF NOT found% AND NOT tmpt% THEN
      
    ENDPROC
  ENDIF

  BPUT#c%, " "+template$+":"

  ntry%=tmpt%! 4 
    
  i% = FNfix_up_prdata_pointer (ptr$)

REM  WHILE (i%!(i%! 4 *4+ 8 ) = 0) AND (i% > 0)
REMFtracef ("Zero usage prdt, skipping")
REM    i% = i%! 0 
REM  ENDWHILE

  IF i% = 0 THEN
      
    ENDPROC
  ENDIF

  i% = i%+ 8 

  WHILE ntry%
     

   BPUT#c%,$(ntry%+ 16 )+" ";

     

   IF !i%=0 THEN
    IF ntry%! 4 =6 THEN
      BPUT#c%,48  
    ELSE
      IF ntry%! 4 =1 THEN
        BPUT#c%,48  
      ENDIF
    ENDIF
    BPUT#c%,10
   ELSE
    j%=!i%  
      
    CASE ntry%! 4  OF
     WHEN 1
      BPUT#c%,STR$ !j%
     WHEN 2
      BPUT#c%,FNprinter_read_string(j%)
     WHEN 3
      BPUT#c%,FNprinter_read_string(j%)
     WHEN 4
      BPUT#c%,FNungstrans(FNprinter_read_string(j%))
     WHEN 5
      BPUT#c%,10
      CASE ntry%! 8  OF
       WHEN 1
        BPUT#c%," "+STR$ !j%! 0 +", "+STR$ !j%! 4 
       WHEN 2
        BPUT#c%," "+FNprinter_read_string(j%! 0 )
        BPUT#c%," "+FNprinter_read_string(j%! 4 )
       WHEN 3
        BPUT#c%," "+FNprinter_read_string(j%! 0 )
        BPUT#c%," "+FNprinter_read_string(j%! 4 )
       WHEN 4
        BPUT#c%," "+FNungstrans(FNprinter_read_string(j%! 0 ))
        BPUT#c%," "+FNungstrans(FNprinter_read_string(j%! 4 ))
       WHEN 7
        BPUT#c%," ";
        PROCfollow_pointer(!j%! 0 ,psup%,c%,level%)
        BPUT#c%,", ";
        PROCfollow_pointer(!j%! 4 ,psup%,c%,level%)
      ENDCASE
     WHEN 6
      k%=j%
      l%=0
      WHILE k%  
       l%+=1
       k%=!k%
      ENDWHILE
      BPUT#c%,STR$ l%
      WHILE j%
       IF 0<=j%! 4 -1 THEN
         FOR k%=0 TO j%! 4 -1
          l%=j%!(k%*4+ 8 )
          CASE l%!-4 OF
           WHEN  &47544E49 
            BPUT#c%," "+STR$ !l%+", ";
           WHEN  &47525453 
            BPUT#c%," "+$l%+", ";
           WHEN  &30525453 
            CALL Z%,l%,s$  
            BPUT#c%," "+s$+", ";
           WHEN  &52545347 
            CALL Y%,l%,s$  
            BPUT#c%," "+FNungstrans(s$)+", ";
           WHEN  &52544F50 
            PROCfollow_pointer (!l%, psup%, c%,level%)
            BPUT#c%, "##"  
          ENDCASE
         NEXT
       ENDIF
       PTR#c%=PTR#c%-2
       BPUT#c%,10
       j%=!j%
      ENDWHILE
     WHEN 7
      PROCfollow_pointer (!j%, psup%, c%,level%)
     WHEN 8
      k%=j%
      l%=0
      WHILE k%
       l%+=1
       k%=!k%
      ENDWHILE
      BPUT#c%,STR$ l%
      WHILE j%
       s$=CHR$ j%?4
       IF 1<=j%?5 THEN
        FOR k%=1 TO j%?5
         s$+=CHR$ j%?(k%+5)
        NEXT
       ENDIF
       BPUT#c%," "+FNungstrans(s$)
       j%=!j%
      ENDWHILE
    ENDCASE
   ENDIF
   ntry%=ntry%! 0 
   i%+=4
  ENDWHILE
  BPUT#c%,"#"

ENDPROC




































































































































DEF FNfix_up_prdata_pointer(s$)
  LOCAL j%,k%,t$
    
  j%=INSTR(s$,":")
  t$=MID$(s$,j%+1)
  s$=LEFT$(s$,j%-1)
  j%=psup%! 8 
  k%=0
   
  WHILE j%
   IF$(j%+ 12 )=s$ THEN
     
    j%=psup%! 12 
    WHILE k%
     j%=j%! 0 
     k%-=1
    ENDWHILE
     
    k%=VAL t$-1
    j%=j%! 4 
    WHILE (j%!(j%! 4 *4+ 8 ) = 0) AND (j% > 0)  
     j% = j%! 0 
    ENDWHILE
    WHILE k%
     j%=j%! 0 
  
     IF j%!(j%! 4 *4+ 8 ) THEN
      k%-=1
     ENDIF
    ENDWHILE

     
    =j%
   ELSE
    j%=j%! 0 
    k%+=1
   ENDIF
  ENDWHILE
  PROCerror_warning(FNmsg_2(A%! 12 ,"FAG",s$,t$))
=0

DEF PROCactivate_this_remote_printer(prnt%, ret_error%, RETURN error%)

  error% =  0 

    
  prnt%! 24 =prnt%! 24  OR  1 
  cnct%=prnt%! 12 
  PROCcreate_printer_icon(prnt%)
  PROCflush_queue(prnt%)
  IF A%! 44 =1 THEN
      
    PROCselect_remote_printer(prnt%, -1 , 0 , ret_error%, error%)
  ENDIF
ENDPROC

DEF PROCselect_remote_printer(prnt%,permanent%,restore%, ret_error%, RETURN error%)
   

  LOCAL old_prnt%,i%,s$
    

  error% =  0 

   
  old_prnt%=selected_prnt%
  IF NOT restore% selected_prnt%=prnt%  
  IF selected_prnt%=0 ENDPROC  

   
  s$=FNselect_connection(selected_prnt%, 0 )
  IF s$<>"" THEN
     

    IF permanent% THEN
     selected_prnt%! 24  = selected_prnt%! 24  AND NOT  2 
    ENDIF
    selected_prnt%! 24  = selected_prnt%! 24  OR  4 
    PROCprinter_status(selected_prnt%)
    PROCredraw_queue_entry(-1,selected_prnt%,0)
    IF selected_prnt%=old_prnt% THEN
       
      PROCicon_deselect(-1,old_prnt%! 20 )
      old_prnt%=0
    ENDIF
    selected_prnt%=old_prnt%
     
    IF ret_error% THEN
      error% =  -1 
    ELSE
      PROCerror_warning(s$)
    ENDIF
    ENDPROC
  ENDIF
  PROCprinter_reason_code(selected_prnt%! 4 ,selected_prnt%,-6,0)
  PROCset_page_size(selected_prnt%)
  PROCtell_the_world

  IF permanent% THEN
      
    IF old_prnt% THEN
      PROCicon_deselect(-1,old_prnt%! 20 )
      old_prnt%! 24 =old_prnt%! 24  AND NOT  2 
    ENDIF
      
    selected_prnt%! 24 =selected_prnt%! 24  OR  2 
    PROCicon_select(-1,selected_prnt%! 20 )
     
    SYS "PDriver_Info" TO,,,,i%
    IF ?i%       CALL Z%,i%,s$:         SYS "OS_SetVarVal","Printer$",i%,LEN s$


  ELSE
      
    selected_prnt%=old_prnt%
  ENDIF
    
ENDPROC


#line 10123 "sources.RunImage"

 

#line 1 "sources.SupportDP"
REM > Support - for dot matrix printers

 










#line 1 "h.Values"
 
























  






  





  











  





  





























































































































































































































































































































 























































 




 





 




 

























 



 
















































































































#line 15 "sources.SupportDP"
#line 1 "h.Trace"






   
   
   
   

#line 16 "sources.SupportDP"

DEF FNdp_support(buff%)
  LOCAL reason%,psup%,prnt%,prdt%,cnfg%,xbuff%,psize_head%,code_entry%
  VDU: PROCftracef("FNdp_support")
  reason%=buff%!0
  psup%=buff%!4
  prnt%=buff%!8
  xbuff%=buff%!12
  psize_head%=buff%!16
  code_entry%=buff%!20
  IF prnt% THEN
    prdt%=FNprinter_find_prdata_entry(psup%,$prnt%! 8 )
    cnfg%=prnt%! 16 
  ENDIF
  CASE reason% OF
    WHEN -1: PROCdp_m1
    WHEN -2: PROCdp_m2
    WHEN -3: PROCdp_m3
    WHEN -4: PROCdp_m4
    WHEN -5: PROCdp_m5
    WHEN -6: PROCdp_m6
    WHEN -7: PROCdp_m7
    WHEN -8: PROCdp_m8
    WHEN 3: PROCdp_p3
    WHEN 6: PROCdp_p6
    WHEN 8: PROCdp_p8
    WHEN 9: PROCdp_p9
    WHEN 17,18: PROCdp_p17
  ENDCASE
= 0 

DEF PROCdp_m1
  LOCAL colours%, pdriverdp%, exists%
  VDU: PROCftracef("PROCdp_m1")
  REM psup%! 24  OR= 0
  psup%! 28 =&FF4
  psup%! 32 =%0100
  psup%! 36 = 16 /4
  psup%! 40 =2
  REM note that the version number really only reflects
  REM the status of the files being read, ie only change
  REM this number if the file contents change.
  psup%! 44 =100
  psup%! 52 =0
  colours%=FNrmload_latest_module("ColourTrans","System:Modules.Colours")
  IFFNrmload_latest_module("PDriver","Printers:Modules.PDriver")
  IFFNrmload_latest_module("PDumperSupport","Printers:Modules.PDumperSpt")
  pdriverdp%=FNrmload_latest_module("PDriverDP","Printers:Modules.PDriverDP")
  REM ***** WARNING!
  REM ***** THESE VERSION NUMBERS ARE HARD CODED!
  IFpdriverdp%>400 AND colours%<150 THEN
    SYS"Wimp_ReportError",FNmsg_0(FNdp_host_desc,"WA12"), 1 OR 1<<4,FNmsg_1(FNdp_host_desc,"ER2",FNmsg_0(FNdp_host_desc,"ID"))
  ENDIF
 



DPQ$="S"
ENDPROC

DEF PROCdp_m2
  VDU: PROCftracef("PROCdp_m2")
 







ENDPROC

DEF PROCdp_m3
  REM initialise the configuration window
  LOCAL config%,dp_i%,dp_j%
  VDU: PROCftracef("PROCdp_m3")
  config%=FNprinter_find_window(prnt%,"configure")
  PROCicon_write(config%,30,FNprinter_read_string(prnt%! 40 ))
  PROCicon_write(config%,6,$prnt%! 8 )
  PROCicon_write(config%,3,FNdp_res(cnfg%))
  PROCicon_write(config%,15,FNdp_qual(cnfg%))
  dp_i%=!cnfg%! 0 
  dp_j%=dp_i%>> 16  AND  15 
  PROCicon_write(config%,17,FNmsg_0(psup%! 16 ,"PF"+STR$ dp_j%))
  IF prnt%! 24  AND 1<<6 THEN
    PROCicon_shade(config%,8)
    PROCicon_shade(config%,11)
    PROCicon_shade(config%,12)
    PROCicon_shade(config%,14)
    PROCicon_shade(config%,19)
    PROCicon_shade(config%,23)
    PROCicon_shade(config%,24)
  ELSE
    dp_j%=dp_i% AND %000010
    IF dp_j% PROCicon_select(config%,8)ELSE PROCicon_deselect(config%,8)
    dp_j%=dp_i% AND %000100
    IF dp_j% PROCicon_select(config%,11)ELSE PROCicon_deselect(config%,11)
    dp_j%=dp_i% AND %001000
    IF dp_j% PROCicon_select(config%,12)ELSE PROCicon_deselect(config%,12)
    dp_j%=(dp_i% AND %110000)>>4
    PROCicon_write(config%,14,FNmsg_0(psup%! 16 ,"TQ"+STR$ dp_j%))
    dp_j%=(dp_i% AND &F00)>>8
    PROCicon_write(config%,23,FNmsg_0(psup%! 16 ,"CC"+STR$ dp_j%))
  ENDIF
  dp_i%=prnt%! 36 
  PROCicon_write(config%,27,$dp_i%! 4 )
ENDPROC

DEF PROCdp_m4
  REM create a CNFG block with suitable defaults
  LOCAL dp_s$,dp_nm$,dp_nm2$,dp_i%,dp_s%,dp_t%,dp_co%,dp_ht%,B%,C%,dp_inf%,dp_x%,dp_y%
  VDU: PROCftracef("PROCdp_m4")

  REM OSS set the text options to be no highlights, Print linefeeds.
  REM PJC: default changed to be draft with linefeeds.
  cnfg%! 0 =FNstore_integer(%011000)
  dp_i%=FNprinter_read_list_integer_entry(prdt%,5,2,1)
  IF dp_i%=0 THEN
    REM no draft - fall back to no highlights
    !cnfg%! 0 =%001000
    dp_i%=FNprinter_read_list_integer_entry(prdt%,5,1,1)
  ENDIF
  IF dp_i% THEN
    B%= &52544F50 
    C%=4
    cnfg%! 4 =USR(code_entry%+ 12 )
    IFcnfg%! 4 =0 ERROR  253 , FNmsg_0(FNdp_host_desc,"FA5")
    !cnfg%! 4 =dp_i%
  ELSE
    prnt%! 24 =prnt%! 24  OR 1<<6
  ENDIF

  REM try to read the default x and y resolutions and name from the PRDT block
  dp_x%=FNprinter_read_integer_entry(prdt%,8)
  dp_y%=FNprinter_read_integer_entry(prdt%,9)
  dp_nm$=FNprinter_read_string_entry(prdt%,12)
  IF dp_nm$<>"" THEN
    REM try to find the graphics mode which matches this name
    C%=1
    REPEAT
      B%=FNprinter_read_list_integer_entry(prdt%,4,C%,1)
 
      IF B%=0 THEN
        C%=-1
      ELSE
        dp_nm2$=FNprinter_read_string_entry(B%,8)
        REM if no match, try the next mode
        IFdp_nm$<>dp_nm2$ C%+=1
      ENDIF
    UNTIL C%=-1 OR dp_nm$=dp_nm2$
    REM if we found it, remember where it was
    IF C%<>-1 dp_i%=C%
  ELSE
    IF (dp_x%<>0 AND dp_y%<>0) THEN
      REM try to find the graphics mode which matches this resolution
      C%=1
      REPEAT
        B%=FNprinter_read_list_integer_entry(prdt%,4,C%,1)
   
        IF B%=0 THEN
          C%=-1
        ELSE
          dp_s%=FNprinter_read_integer_entry(B%,4)
          dp_t%=FNprinter_read_integer_entry(B%,5)
          REM if no match, try the next mode
          IFdp_s%<>dp_x% OR dp_t%<>dp_y% C%+=1
        ENDIF
      UNTIL C%=-1 OR (dp_s%=dp_x% AND dp_t%=dp_y%)
      REM if we found it, remember where it was
      IF C%<>-1 dp_i%=C%
    ELSE
      REM show we didn't match - which we couldn't 'cos we didn't have the values
      C%=-1
    ENDIF
  ENDIF

 


  IF C%=-1 THEN
    REM OSS set the graphics options to be the highest non-interlaced resolution
    B%= &46424450 
    C%=256
    dp_inf%=USR(code_entry%+ 12 )
    IFdp_inf%=0 ERROR  253 , FNmsg_0(FNdp_host_desc,"FA5")
    C%=1
    dp_i%= 0 
    REPEAT
      B%=FNprinter_read_list_integer_entry(prdt%,4,C%,1)
      IF B%=0 THEN
        REM run out of parameters, go back to the last one
        C%-=1
        dp_i%= -1 
      ELSE
        $dp_inf%=FNprinter_read_string_entry(B%,6)
        IF dp_inf%? 1 =0 AND dp_inf%? 2 =0 THEN
          C%+=1
        ELSE
          C%-=1
          dp_i%= -1 
        ENDIF
      ENDIF
    UNTIL dp_i%
    dp_i%=C%
    B%= &46424450 
    C%=dp_inf%
    CALL code_entry%+ 16 
  ENDIF

  B%= &52544F50 
  C%=4
  cnfg%! 8 =USR(code_entry%+ 12 )
  IFcnfg%! 8 =0 ERROR  253 , FNmsg_0(FNdp_host_desc,"FA5")
  !cnfg%! 8 =FNprinter_read_list_integer_entry(prdt%,4,dp_i%,1)

  REM ensure that the module is present in memory
  dp_s$=FNprinter_read_string_entry(FNprinter_read_integer_entry(!cnfg%! 8 ,1),2)
  IFFNrmload_latest_module(dp_s$,"Printers:PDumpers."+dp_s$)

  REM ensure that the palette file needed at the resolution is cached
  REM bit 23 of palette no. flags whether already ensured or not
  dp_s$=STR$(FNprinter_read_integer_entry(!cnfg%! 8 ,2) AND &7FFFFF)
  PROCdp_ensure_resource_file("Resources.Printers.Palettes."+dp_s$,"Printers:Palettes."+dp_s$,!cnfg%! 8 )

  REM initialise the quality
  REM see if a quality was provided in the PDF
  dp_i%=FNprinter_read_integer_entry(prdt%,10)
  REM get the qualities available at the configured resolution
  dp_s%=FNdp_get_quality_options(!cnfg%! 8 )
  IF dp_i%<>0 THEN
 







    dp_co%=dp_i% AND &FF
    dp_ht%=(dp_i% AND &FF00)>>8
    CASE dp_co% OF
      WHEN 0: REM mono
        IF (dp_s% AND 7) THEN
          IF dp_ht%=4 AND (dp_s% AND 1)=0 dp_i%=0
          IF dp_ht%=8 AND (dp_s% AND 2)=0 dp_i%=0
          IF dp_ht%=1 AND (dp_s% AND 4)=0 dp_i%=0
        ELSE
          dp_i%=0
        ENDIF
      WHEN 1: REM greyscale
        IF (dp_s% AND &70) THEN
          IF dp_ht%=4 AND ((dp_s%>>4) AND 1)=0 dp_i%=0
          IF dp_ht%=8 AND ((dp_s%>>4) AND 2)=0 dp_i%=0
          IF dp_ht%=1 AND ((dp_s%>>4) AND 4)=0 dp_i%=0
        ELSE
          dp_i%=0
        ENDIF
      WHEN 2: REM colour
        IF (dp_s% AND &700) THEN
          IF dp_ht%=4 AND ((dp_s%>>8) AND 1)=0 dp_i%=0
          IF dp_ht%=8 AND ((dp_s%>>8) AND 2)=0 dp_i%=0
          IF dp_ht%=1 AND ((dp_s%>>8) AND 4)=0 dp_i%=0
        ELSE
          dp_i%=0
        ENDIF
    ENDCASE
  ENDIF
  IF dp_i%<>0 THEN
    cnfg%! 12 =FNstore_integer(dp_i%)
  ELSE
    PROCdp_decode_options(dp_s%,dp_co%,dp_ht%)
    cnfg%! 12 =FNstore_integer(dp_ht%<<8 OR dp_co%)
  ENDIF

  $buff%=FNprinter_read_string_entry(prdt%,2)
  B%=buff%
  C%=2
  prnt%! 40 =USR(code_entry%+ 28 )
  dp_s$=FNprinter_read_string_entry(prdt%,3)
 
  IF dp_s$<>"dp" $buff%=dp_s$:B%=buff%:C%=2:prnt%! 44 =USR(code_entry%+ 28 )

  REM initialise the best paper size we can find ...
  REM start by trying to read the 'default_paper_size' entry
  REM from the PRDT block (entry 7)
  dp_s$=FNprinter_read_string_entry(prdt%,7)
  REM fall back to going for the default
  IF dp_s$="" dp_s$=FNmsg_0(psup%! 16 ,"PAP")

  dp_i%=psize_head%
  WHILE dp_s$<>FNprinter_read_string(dp_i%! 4 )
    dp_i%=dp_i%! 0 
    REM if we run out of paper entries, go for the first one
    IF dp_i%=0 dp_i%=psize_head%: dp_s$=FNprinter_read_string(dp_i%! 4 )
  ENDWHILE
  prnt%! 36 =dp_i%

  REM if this printer supports fast parallel, set the appropriate flag
  dp_i%=FNprinter_read_integer_entry(prdt%,11)
  IFdp_i%<>0 prnt%! 24  = prnt%! 24  OR (1<<7)
ENDPROC

DEF PROCdp_ensure_resource_file(resource$,disc$,gprdt%)
  LOCAL obj_type%,load_addr%,exec_addr%,file_size%,obj_attr%,rma_size%,rma_block%
  LOCAL found_type%,found_load%,found_exec%,found_size%,c%,a%,w%,pnum%,reload_if_outofdate%
  VDU: PROCftracef("dp_ensure_resource_file")
  REM We use this to load palette files for the printers in order to reduce
  REM the probability of having to ask for the printers disc again later.

  REM check for out of date palette if we have not ensured this one before (bit 23 of palette number)
  pnum% = FNprinter_read_integer_entry(gprdt%,2)
  reload_if_outofdate% = ((pnum% AND &800000) = 0)
  PROCprinter_write_integer_entry(gprdt%,2,pnum% OR &800000):REM we (will) have ensured it

  REM First of all, check if the file exists already
  SYS "OS_File",17,"Resources:"+resource$ TO found_type%,,found_load%,found_exec%,found_size%: REM OS_FileReadNoPath
  
  IF found_type% AND reload_if_outofdate%= 0  ENDPROC

  SYS "OS_File",17,disc$ TO obj_type%,,load_addr%,exec_addr%,file_size%,obj_attr%: REM OS_FileReadNoPath
  IF obj_type%<>1 SYS "OS_File",19,disc$,obj_type%: REM OS_FileMakeError

  IF found_type% THEN
    IFfound_load%=load_addr% AND found_exec%=exec_addr% AND found_size%=file_size% ENDPROC
    REM cached palette is not the same as the one on disc
    REM try to remove the cached palette
    c%=OPENIN("Resources:"+resource$)
    IFc%=0 ERROR  254 , FNmsg_1(FNdp_host_desc,"OKBB",resource$)
    SYS"OS_FSControl",21,c% TO ,a%,w%
    CLOSE#c%
    IF(w%AND&FF)<>46 ERROR  254 , FNmsg_1(FNdp_host_desc,"OKBC",resource$)
    a%-=(LENresource$+4ANDNOT3)+4
    a%-=20
    IFa%!-4 = &48434143 THEN
      SYS"ResourceFS_DeregisterFiles",a%
      SYS"OS_Module",7,,a%-4
    ENDIF
  ENDIF

  rma_size%=20+(LEN resource$+4 AND NOT 3)+4+(file_size%+3 AND NOT 3): REM Size needed for this file only
  VDU: PROCftracef("File "+disc$+", size "+STR$ file_size%)

  REM claim some RMA for the file
  SYS "OS_Module",6,,,rma_size%+8 TO,,rma_block%: REM OSModule_Alloc
  REM Put a check tag at the beginning of the block
  !rma_block%=&48434143:REM CACH
  rma_block%+=4
 
  rma_block%!0=rma_size%
  rma_block%!4=load_addr%
  rma_block%!8=exec_addr%
  rma_block%!12=file_size%
  rma_block%!16=obj_attr%
  $(rma_block%+20)=resource$
  rma_block%!(20+LEN resource$)=0  
  rma_block%!(20+(LEN resource$+4 AND NOT 3))=file_size%+4
  SYS "OS_File",16,disc$,rma_block%+20+(LEN resource$+4 AND NOT 3)+4: REM OS_FileLoadNoPath
  rma_block%!rma_size%=0: REM Terminator
  SYS "ResourceFS_RegisterFiles",rma_block%
ENDPROC

DEF PROCdp_m5
  REM cache any palette files that are used by dp printers and ensure
  REM that the relevant PDumper modules are loaded
  LOCAL dp_prnt%,dp_cnfg%,dp_graphics_prdt%,dp_pal$
  VDU: PROCftracef("PROCdp_m5")
  dp_prnt%=prnt%
  WHILE dp_prnt%>0
    IF dp_prnt%! 4 =psup% THEN
      REM got a printer in our class - cache the palette file
      dp_cnfg%=dp_prnt%! 16 
      dp_graphics_prdt%=!dp_cnfg%! 8 
      REM bit 23 of palette no. flags whether already ensured or not
      dp_pal$=STR$(FNprinter_read_integer_entry(dp_graphics_prdt%,2) AND &7FFFFF)
      PROCdp_ensure_resource_file("Resources.Printers.Palettes."+dp_pal$,"Printers:Palettes."+dp_pal$,dp_graphics_prdt%)

      REM and ensure the pdumper module
      dp_pal$=FNprinter_read_string_entry(FNprinter_read_integer_entry(dp_graphics_prdt%,1),2)
      IFFNrmload_latest_module(dp_pal$, "Printers:PDumpers."+dp_pal$)
    ENDIF
    dp_prnt%=dp_prnt%! 0 
  ENDWHILE
ENDPROC

DEF PROCdp_m6
  REM do whatever is necessary to prime the specified printer
  LOCAL dp_s$,dp_t$,dp_i%,xres%,yres%,halftone%,ptr%,flags%,pal%,dmp$,inf%,strip%,graphics_prdt%,text_prdt%,B%,C%
  VDU: PROCftracef("PROCdp_m6")
  REM 7 is the magic number for the dumper driver
  SYS "XPDriver_SelectDriver",7
  dp_s$=FNprinter_read_string(prnt%! 40 )
  IF dp_s$="" THEN
    dp_s$=$prnt%! 8 
    IF LEN dp_s$>20 THEN
      dp_i%=LEN dp_s$
      WHILE MID$(dp_s$,dp_i%,1)<>" " AND dp_i%>0
        dp_i%-=1
      ENDWHILE
      IF dp_i% dp_s$=LEFT$(dp_s$,dp_i%-1)ELSE dp_s$=LEFT$(dp_s$,20)
    ENDIF
  ENDIF
  graphics_prdt%=!cnfg%! 8 
  xres%=FNprinter_read_integer_entry(graphics_prdt%,4)
  yres%=FNprinter_read_integer_entry(graphics_prdt%,5)
  halftone%=(!cnfg%! 12  AND &FF00)>>8
  strip%=!cnfg%! 12  AND &FF
  REM WARNING!
  REM The comparison is made against strip type 2 (colour) or greater
  REM This assumes, therefore, that any strip types that are 2 or greater
  REM are colour which is currently true
  IF (strip% >= 2) THEN
   SYS"XPDriver_SetInfo",,xres%,yres%,1,dp_s$,xres%/halftone%,yres%/halftone% TO ptr%;dp_i%
  ELSE
   SYS"XPDriver_SetInfo",,xres%,yres%,0,dp_s$,xres%/halftone%,yres%/halftone% TO ptr%;dp_i%
  ENDIF
  IF (dp_i% AND 1) AND (ptr%<>0) THEN
    dp_s$="": ptr%+=4
    WHILE ?ptr%: dp_s$+=CHR$ ?ptr%: ptr%+=1: ENDWHILE
    ERROR  254 ,dp_s$
    ENDPROC
  ENDIF

  REM bit 23 of palette no. flags whether already ensured or not
  dp_s$=STR$(FNprinter_read_integer_entry(graphics_prdt%,2) AND &7FFFFF)
  B%= &46424450 
  C%=256
  pal%=USR(code_entry%+ 12 )
  IFpal%=0 ERROR  253 , FNmsg_0(FNdp_host_desc,"FA5")
  $pal%="Resources:$.Resources.Printers.Palettes."+dp_s$
  inf%=USR(code_entry%+ 12 )
  IFinf%=0 ERROR  253 , FNmsg_0(FNdp_host_desc,"FA5")
  $inf%=FNprinter_read_string_entry(graphics_prdt%,6)
  strip%=!cnfg%! 12  AND &FF
 


  IF strip%=5 THEN
   dp_i%=FNprinter_read_integer_entry(graphics_prdt%,1)
   dp_i%=FNprinter_read_integer_entry(dp_i%,1)
 
   SYS"XPDriver_MiscOp",&80000002,dp_i% TO ptr%;dp_i%
   IF(dp_i%AND1)=0 IFptr%<>&80000002 IF(ptr% AND (1<<5))=0 strip%=3
  ENDIF
 
  PROCdp_ensure_resource_file("Resources.Printers.Palettes."+dp_s$,"Printers:Palettes."+dp_s$,graphics_prdt%)

  REM Module name:
  dp_s$=FNprinter_read_string_entry(FNprinter_read_integer_entry(graphics_prdt%,1),2)
  dmp$="RMLoad Printers:PDumpers."+dp_s$+CHR$ 13

  REM set passes per line entry
  REM WARNING!
  REM The comparison is made against strip type 2 (colour) or greater
  REM This assumes, therefore, that any strip types that are 2 or greater
  REM are colour which is currently true
  IF strip%>=2 inf%? 3 =4 ELSE inf%? 3 =1

  REM set strip type field
  inf%? 4 =strip%

  REM set output bpp field
  IF strip%=0 inf%? 5 =1 ELSE inf%? 5 =8

  REM set num passes field
  IF strip%=3 inf%? 6 =3 ELSE inf%? 6 =1

  REM OSS Set the NoPageAdvance bit in the flags if paper feed is "Roll"
  flags%=FNprinter_read_integer_entry(graphics_prdt%,7)
  IF(!cnfg%! 0 >> 16  AND  15 )= 2  flags%+=2

  REM OSS Fixup old version numbers by moving it to the new location.
  IF(flags%>>>24)=0 flags%=flags% OR inf%? 8 <<24

  REM OSS Set lines per page if version>0. We only need to check the new
  REM version field as the fixup has already been done.
  IF(flags%>>>24)>0 THEN
    dp_i%=prnt%! 36 
    inf%? 34 =dp_i%! 48 
  ENDIF

  SYS "XPDriver_SetDriver",,FNprinter_read_integer_entry(FNprinter_read_integer_entry(graphics_prdt%,1),1),dmp$,pal%,inf%,flags%
  B%= &46424450 
  C%=pal%
  CALL code_entry%+ 16 
  C%=inf%
  CALL code_entry%+ 16 
  SYS "OS_CLI","Unset PDriver$TextChars1"

  REM point to the chars PRDT block
  dp_i%=FNprinter_read_integer_entry(prdt%,6)
  IF dp_i% THEN
    dp_i%=dp_i%! 8 
    WHILE dp_i%
      IF dp_i%? 4 =ASC"" THEN
        dp_s$=FNdp_hex2(ASC "")+FNdp_hex2(dp_i%? 5 )
        ptr%=dp_i%+ 6 : dp_i%=dp_i%? 5 
        WHILE dp_i%
          dp_s$+=FNdp_hex2(?ptr%)
          ptr%+=1
          dp_i%-=1
        ENDWHILE
        SYS"OS_CLI","Set PDriver$TextChars1 "+dp_s$
      ELSE
        dp_i%=dp_i%! 0 
      ENDIF
    ENDWHILE
  ENDIF

  IF cnfg%! 4 =0 THEN
    SYS"OS_CLI","Unset PDriver$TextPage"
  ELSE
    text_prdt%=!cnfg%! 4 
    dp_i%=prnt%! 36 
    dp_s$="-Ph "+STR$ dp_i%! 48 +" -Mt "+STR$ dp_i%! 36 +" -Mb "
    dp_s$+=STR$ dp_i%! 32 +" -Ml "+STR$ dp_i%! 40 +" -Th "
    IF cnfg%! 0  AND 2 dp_s$+="2" ELSE dp_s$+="0"
    dp_s$+=" -Nl "
    IF cnfg%! 0  AND 8 THEN
      dp_s$+=FNungstrans(FNungstrans(FNprinter_read_string_entry(text_prdt%,6)))
    ELSE
      dp_s$+=FNungstrans(FNungstrans(FNprinter_read_string_entry(text_prdt%,5)))
    ENDIF
    dp_t$=FNprinter_read_string_entry(text_prdt%,7)
    IF dp_t$<>"" dp_s$+=" -Rs "+FNungstrans(FNungstrans(dp_t$))
    dp_t$=FNprinter_read_string_entry(text_prdt%,11)
    IF dp_t$<>"" dp_s$+=" -Cd "+FNungstrans(FNungstrans(dp_t$))
    SYS"OS_CLI","Set PDriver$TextPage "+dp_s$
  ENDIF
ENDPROC

DEF PROCdp_m7
  LOCAL queu%,dp_p%,B%,C%
  VDU: PROCftracef("PROCdp_m7")
  queu%=!xbuff%
  dp_p%=queu%! 48 
  IF dp_p% THEN
    PROCfree_structure(dp_p%! 4 )
    B%= &56525054 
    C%=dp_p%
    CALL code_entry%+ 16 
    queu%! 48 =0
  ENDIF
ENDPROC

DEF PROCdp_p3
  VDU: PROCftracef("PROCdp_p3")
  SYS"Wimp_CloseWindow",,xbuff%
ENDPROC

DEF PROCdp_p6
  LOCAL wind%
  VDU: PROCftracef("PROCdp_p6")
  REM mouseclick on the configure window
  CASE xbuff%!8 OF
    WHEN 2: REM menu
      CASE xbuff%!16 OF
        WHEN 20: PROCdp_menu("ME1", -1 , -1 )
        WHEN 18: PROCdp_menu("ME2", -1 , -1 )
        WHEN  4: PROCdp_menu("ME3", -1 , -1 )
        WHEN 19: PROCdp_menu("ME4", -1 , -1 )
        WHEN 24: PROCdp_menu("ME5", -1 , -1 )
        WHEN 26: PROCdp_menu("MP1", -1 , -1 )
      ENDCASE
    WHEN 4: REM select
      CASE xbuff%!16 OF
        WHEN 25
          wind%=xbuff%!12
          PROCdp_save_configuration(wind%)
          !xbuff%=wind%:SYS"Wimp_CloseWindow",,xbuff%
        WHEN 20
          PROCdp_menu("ME1", -1 , -1 )
        WHEN 18
          PROCdp_menu("ME2", -1 , -1 )
        WHEN  4
          PROCdp_menu("ME3", -1 , -1 )
        WHEN 19
          PROCdp_menu("ME4", -1 , -1 )
        WHEN 24
          PROCdp_menu("ME5", -1 , -1 )
        WHEN 26
          PROCdp_menu("MP1", -1 , -1 )
        WHEN 31
          !xbuff%=xbuff%!12
          SYS"Wimp_CloseWindow",,xbuff%
      ENDCASE
    WHEN 1: REM adjust
      CASE xbuff%!16 OF
        WHEN 25
          wind%=xbuff%!12
          PROCdp_save_configuration(wind%)
      ENDCASE
  ENDCASE
ENDPROC

DEF PROCdp_p8
  REM a key press!
  LOCAL dp_i%
  VDU: PROCftracef("PROCdp_p8")
  dp_i%=psup%! 20 
  WHILE dp_i%
    IF dp_i%! 4 =!xbuff% THEN
      IF xbuff%!24=13 THEN
        CASE $(dp_i%+ 16 )OF
          WHEN "configure"
            SYS "Wimp_CloseWindow",,xbuff%
            PROCdp_save_configuration(!xbuff%)
        ENDCASE
      ELSE
        SYS "Wimp_ProcessKey",xbuff%!24
      ENDIF

      ENDPROC
    ENDIF

    dp_i%=dp_i%! 0 
  ENDWHILE
ENDPROC

DEF PROCdp_p9
  LOCAL adjust%,wind%,icon%,ptr%,xres%,yres%,dp_s$,dp_i%,dp_j%,dp_k%
  VDU: PROCftracef("PROCdp_p9")
 






  wind%=FNprinter_find_window(prnt%,"configure")
  adjust%=FNwas_adjust_used
  CASE dp_menu_chsn$ OF
    WHEN "ME1": icon%=3
    WHEN "ME2": icon%=17
    WHEN "ME3": icon%=15
    WHEN "ME4": icon%=14
    WHEN "ME5": icon%=23
    WHEN "MP1": icon%=27
  ENDCASE
  ptr%=dp_menu%+28+!xbuff%*24
  IF ptr%!8 AND &100 THEN
    PROCicon_write(wind%,icon%,$ptr%!12)
  ELSE
    PROCicon_write(wind%,icon%,$(ptr%+12))
  ENDIF
  IF dp_menu_chsn$="ME1" THEN
    REM if the resolution changes, we may have to change the quality as well
    dp_j%=prdt%!20
    dp_s$=FNicon_read(wind%,3)
    WHILE dp_j%
      dp_k%=!dp_j%! 8 
      IF (dp_s$=FNmsg_2(psup%! 16 ,"RES",STR$ !dp_k%!20,STR$ !dp_k%!24)) OR          (dp_s$=$(dp_k%!36)) THEN

 




        dp_s$=FNicon_read(wind%,15): dp_i%=INSTR(dp_s$,",")
        CASE LEFT$(dp_s$,dp_i%-1)OF
          WHEN FNmsg_0(psup%! 16 ,"CO1"):  dp_j%=1
          WHEN FNmsg_0(psup%! 16 ,"CO1s"): dp_j%=1
          WHEN FNmsg_0(psup%! 16 ,"CO2"):  dp_j%=2
          WHEN FNmsg_0(psup%! 16 ,"CO4"):  dp_j%=4
          WHEN FNmsg_0(psup%! 16 ,"CO5"):  dp_j%=5
          WHEN FNmsg_0(psup%! 16 ,"CO5s"): dp_j%=5
          OTHERWISE:                                 dp_j%=0
        ENDCASE
        dp_s$=MID$(dp_s$,dp_i%+2)
        CASE dp_s$ OF
          WHEN FNmsg_0(psup%! 16 ,"HT8"):  dp_i%=8
          WHEN FNmsg_0(psup%! 16 ,"HT8s"): dp_i%=8
          WHEN FNmsg_0(psup%! 16 ,"HT1"):  dp_i%=1
          WHEN FNmsg_0(psup%! 16 ,"HT1s"): dp_i%=1
          OTHERWISE:                                 dp_i%=4
        ENDCASE
        dp_k%=FNdp_get_quality_options(dp_k%)
        IF(dp_k% AND (7<<(dp_j%*4)))=0 dp_j%=-1
        IF dp_j%<>-1 THEN
          dp_j%=dp_k%>>(dp_j%*4)
          CASE dp_i% OF
            WHEN 4: IF(dp_j% AND 1)=0 dp_i%=-1
            WHEN 8: IF(dp_j% AND 2)=0 dp_i%=-1
            WHEN 1: IF(dp_j% AND 4)=0 dp_i%=-1
          ENDCASE
        ENDIF
        IF dp_j%=-1 OR dp_i%=-1 THEN
          PROCdp_decode_options(dp_k%,dp_j%,dp_i%)
          PROCicon_write(wind%,15,FNdp_qual_name(dp_j% + (dp_i% << 8)))
        ENDIF
        dp_j%=0
      ELSE
        dp_j%=!dp_j%
      ENDIF
    ENDWHILE
  ENDIF
  IF adjust% THEN
    SYS"Wimp_GetPointerInfo",,xbuff%
    PROCdp_menu(dp_menu_chsn$, 0 , 0 )
  ENDIF
ENDPROC

DEF PROCdp_p17
  LOCAL wind%,dp_s$,dp_t$
  VDU: PROCftracef("PROCdp_p17")
  CASE xbuff%!16 OF
    WHEN &502: REM HelpRequest
      wind%=psup%! 20 
      WHILE wind%
        IF wind%! 4 =xbuff%!32 THEN
          CASE $(wind%+ 16 )OF
            WHEN "configure"
              dp_s$=STR$ xbuff%!36
              CASE xbuff%!36 OF
                WHEN 8,11,12: IF FNicon_set(xbuff%!32,xbuff%!36)dp_s$+="b" ELSE dp_s$+="a"
              ENDCASE
              dp_t$=FNmsg_0(psup%! 16 ,"CON"+dp_s$)
              IFdp_t$="CON"+dp_s$ dp_t$=FNmsg_0(psup%! 16 ,"CON")
              PROCinteractive_help(dp_t$)
          ENDCASE
          wind%=0
        ELSE
          wind%=wind%! 0 
          IF wind%=0 PROCinteractive_help(FNmsg_0(psup%! 16 ,"H"+dp_menu_chsn$))
        ENDIF
      ENDWHILE
  ENDCASE
ENDPROC

DEF PROCdp_save_configuration(window%)
  LOCAL dp_i%,dp_j%,dp_k%,dp_s$,B%,C%
  VDU: PROCftracef("PROCdp_save_configuration")
  prdt%=FNprinter_find_prdata_entry(psup%,FNicon_read(window%,6))
  PROCfree_structure(prnt%! 40 )
  $buff%=FNicon_read(window%,30)
  B%=buff%
  C%=2
  prnt%! 40 =USR(code_entry%+ 28 )
  dp_i%=cnfg%
  FOR dp_j%=1 TO  16 /4
    PROCfree_structure(!dp_i%)
   !dp_i%=0: dp_i%+=4
  NEXT

  dp_j%=0
  IF FNicon_read(window%,17)=FNmsg_0(psup%! 16 ,"PF1")dp_j%+= 1 << 16 
  IF FNicon_read(window%,17)=FNmsg_0(psup%! 16 ,"PF2")dp_j%+= 2 << 16 
  IF FNicon_set(window%,8)dp_j%+=2
  IF FNicon_set(window%,11)dp_j%+=4
  IF FNicon_set(window%,12)dp_j%+=8
  CASE FNicon_read(window%,14)OF
    WHEN FNmsg_0(psup%! 16 ,"TQ1"): dp_j%+=1<<4: dp_i%=2
    WHEN FNmsg_0(psup%! 16 ,"TQ2"): dp_j%+=1<<5: dp_i%=3
    OTHERWISE: dp_i%=1
  ENDCASE
  CASE FNicon_read(window%,23)OF
    WHEN FNmsg_0(psup%! 16 ,"CC1"): dp_j%+=1<<8
    WHEN FNmsg_0(psup%! 16 ,"CC2"): dp_j%+=1<<9
  ENDCASE
  cnfg%! 0 =FNstore_integer(dp_j%)

  dp_j%=FNprinter_read_list_integer_entry(prdt%,5,dp_i%,1)
  IF dp_j% THEN
    B%= &52544F50 
    C%=4
    cnfg%! 4 =USR(code_entry%+ 12 )
    IFcnfg%! 4 =0 ERROR  253 , FNmsg_0(FNdp_host_desc,"FA5")
    !cnfg%! 4 =dp_j%
    prnt%! 24 =prnt%! 24  AND NOT(1<<6)
  ELSE
    prnt%! 24 =prnt%! 24  OR 1<<6
  ENDIF

  REM point to the resolution possibilities
  dp_j%=prdt%!20: REM printer name is 8, short name is 12, sprite name is 16, resolution is 20
  dp_s$=FNicon_read(window%,3)
  WHILE dp_j%
    dp_k%=!dp_j%! 8 : REM get the pointer
    REM module is 8, palette is 12, options is 16, pxres is 20, pyres is 24
    IF (dp_s$=FNmsg_2(psup%! 16 ,"RES",STR$ !dp_k%!20,STR$ !dp_k%!24)) OR        (dp_s$=$(dp_k%!36)) THEN

      dp_j%=0
    ELSE
      dp_j%=!dp_j%
    ENDIF
  ENDWHILE
  B%= &52544F50 :C%=4
  cnfg%! 8 =USR(code_entry%+ 12 )
  IFcnfg%! 8 =0 ERROR  253 , FNmsg_0(FNdp_host_desc,"FA5")
  !cnfg%! 8 =dp_k%

  dp_s$=FNicon_read(window%,15)
  dp_i%=INSTR(dp_s$,",")
  CASE LEFT$(dp_s$,dp_i%-1)OF
    WHEN FNmsg_0(psup%! 16 ,"CO1"):  dp_j%=1
    WHEN FNmsg_0(psup%! 16 ,"CO1s"): dp_j%=1
    WHEN FNmsg_0(psup%! 16 ,"CO2"):  dp_j%=2
    WHEN FNmsg_0(psup%! 16 ,"CO4"):  dp_j%=4
    WHEN FNmsg_0(psup%! 16 ,"CO5"):  dp_j%=5
    WHEN FNmsg_0(psup%! 16 ,"CO5s"): dp_j%=5
    OTHERWISE: dp_j%=0
  ENDCASE
  dp_s$=MID$(dp_s$,dp_i%+2)
  CASE dp_s$ OF
    WHEN FNmsg_0(psup%! 16 ,"HT8"):  dp_i%=8
    WHEN FNmsg_0(psup%! 16 ,"HT8s"): dp_i%=8
    WHEN FNmsg_0(psup%! 16 ,"HT1"):  dp_i%=1
    WHEN FNmsg_0(psup%! 16 ,"HT1s"): dp_i%=1
    OTHERWISE: dp_i%=4
  ENDCASE
  cnfg%! 12 =FNstore_integer((dp_i%<<8)+dp_j%)

  dp_j%=prnt%! 36 
  dp_s$=FNicon_read(window%,27)
  IF $dp_j%! 4 <>dp_s$ THEN
    dp_i%=psize_head%
    WHILE dp_i%
      IF $dp_i%! 4 =dp_s$ THEN
        prnt%! 36 =dp_i%
        dp_i%=0
      ELSE
        dp_i%=!dp_i%
      ENDIF
    ENDWHILE
  ENDIF

  IF prnt%! 20 <>-1 THEN
 



    PROCselect_printer(prnt%, -1 , 0 )
 




  ENDIF
ENDPROC

DEF FNdp_res(cnfg%)
  LOCAL xres%,yres%,graphics_prdt%,nm$
  VDU: PROCftracef("FNdp_res")
  graphics_prdt%=!cnfg%! 8 
  xres%=FNprinter_read_integer_entry(graphics_prdt%,4)
  yres%=FNprinter_read_integer_entry(graphics_prdt%,5)
  nm$=FNprinter_read_string_entry(graphics_prdt%,8)
  IF nm$="" THEN  nm$=FNmsg_2(psup%! 16 ,"RES",STR$ xres%,STR$ yres%)
=nm$

DEF FNdp_qual_name(dp_i%)
  LOCAL dp_s$,dp_t$
  IF DPQ$ = "S" THEN
    dp_s$=FNmsg_0(psup%! 16 ,"CO"+STR$(dp_i% AND &FF)+"s")
    dp_t$=FNmsg_0(psup%! 16 ,"HT"+STR$((dp_i% AND &FF00)>>8)+"s")
  ELSE
    dp_s$=FNmsg_0(psup%! 16 ,"CO"+STR$(dp_i% AND &FF))
    dp_t$=FNmsg_0(psup%! 16 ,"HT"+STR$((dp_i% AND &FF00)>>8))
  ENDIF
=dp_s$+", "+dp_t$

DEF FNdp_qual(cnfg%)
  LOCAL dp_i%
  VDU: PROCftracef("FNdp_qual")
  dp_i%=!cnfg%! 12 
=FNdp_qual_name(dp_i%)

DEF FNdp_get_quality_options(graphics_definition%)
LOCAL s%,c%,t%
s%=FNprinter_read_integer_entry(graphics_definition%,3)
REM if colour small halftone present, add colour large halftone
IF (s% AND &100) s% = s% OR &200
REM if colour available, add new colour options
IF (s% AND &700) THEN
 t%=FNprinter_read_integer_entry(graphics_definition%,1):REM ptr to module defn
 t%=FNprinter_read_integer_entry(t%,1):REM module number
 REM need to pass the MiscOp through to the dumper driver
 SYS"XPDriver_MiscOpForDriver",&80000002,t%,,,,,,,7 TO t%;c%:REM strip type mask
 IF(c%AND1)=0 AND t%<>&80000002 THEN
  IF (t% AND (1<<3)) THEN
   REM add strip type 3 based on the greyscale options (or colour, if no grey)
   c%=s% AND &70
   IF c%=0 THEN c%=(s% AND &700)>>4
   s%=s% OR (c%<<16)
  ENDIF
  IF (t% AND (1<<4)) THEN
 
   c%=s% AND &700
   s%=s% OR (c%<<8)
  ENDIF
  IF (t% AND (1<<5)) THEN
   REM add strip type 5 based on the colour options
   c%=s% AND &700
   s%=s% OR (c%<<12)
  ENDIF
 ENDIF
ENDIF
REM If simple qualities, knock out Mono,256 colours,32k colours
IF DPQ$ = "S" s%=s% AND &700070
=s%

REM If DPQ$ = "S" then the following qualities are
REM actually deemed not to exist:
REM - Any 'Mono'; '256 colours'; '32k colours'

REM This procedure tries to find a good default quality to pick.
REM Modified on 22-Jul-93/3-Dec-93 to pick in this order:
REM Modified on 02-Aug-95 to favour error diff instead of halftone
REM * 16 million, diffused
REM * colour, diffused
REM * grey, diffused
REM * mono, diffused
REM
REM The option value is split into 3 nibbles:
REM &7xxxxx = 24bpp colour, either strip type 3 or 5 depending on
REM                         whether or not it is a full colour system
REM &x7xxxx = 16bpp colour, strip type 4
REM &xxx7xx = colour, strip type 2
REM &xxxx7x = greyscale, strip type 1
REM &xxxxx7 = monochrome, strip type 0
REM
REM Within the 3 nibbles, the following values are valid:
REM 1 = small halftone, tone type 4
REM 2 = large halftone, tone type 8
REM 4 = dithered, tone type 1
DEF PROCdp_decode_options(option%,RETURN strip%,RETURN tone%)
  VDU: PROCftracef("PROCdp_decode_options")
  REM try to pick colour, then grey, then mono
  IF option% AND &700000 THEN
   strip%=5
  ELSE 
   IF option% AND &700 THEN
    strip%=2
   ELSE
    IF option% AND &70 THEN
     strip%=1
    ELSE
     REM force grey if Simple (Mono not allowed)
     IF DPQ$ = "S" THEN strip%=1 ELSE strip%=0
    ENDIF
   ENDIF
  ENDIF

 
  option%=option%>>(strip%*4)
  tone%=-1
  IF (strip%=5 AND (option% AND 4)<>0) tone%=1
  IF (strip%=2 AND (option% AND 4)<>0) tone%=1
  IF (strip%=1 AND (option% AND 4)<>0) tone%=1
  IF (strip%=0 AND (option% AND 4)<>0) tone%=1
 



  IF tone%=-1 THEN
    IF option% AND 4 THEN
      tone%=1
    ELSE
      IF option% AND 2 THEN
        tone%=8
      ELSE
        tone%=4
      ENDIF
    ENDIF
  ENDIF
ENDPROC

DEF PROCdp_menu(top$,rebuild%,iconpos%)
  LOCAL wind%,dp_ix%,dp_iy%,dp_i%,dp_x%,dp_j%,dp_k%,xres%,yres%,indt%
  VDU: PROCftracef("PROCdp_menu")
  IF rebuild% dp_menu_xpos%=xbuff%!0-64: dp_menu_ypos%=xbuff%!4
  IF iconpos% THEN
    !buff%=xbuff%!12:buff%!4=xbuff%!16:SYS"Wimp_GetIconState",,buff%
    dp_ix%=buff%!16:dp_iy%=buff%!20
    SYS"Wimp_GetWindowState",,buff%
    dp_menu_xpos%=buff%!20+buff%!4+dp_ix%+2
    dp_menu_ypos%=buff%!24+buff%!16+dp_iy%-2
  ENDIF
  wind%=FNprinter_find_window(prnt%,"configure")
  dp_menu_chsn$=top$
  REM because of the way the configuration window works,
  REM we have to adjust prdt% to point to the printer data
  REM record for the printer specified in the window, NOT
  REM the current printer.
  prdt%=FNprinter_find_prdata_entry(psup%,FNicon_read(wind%,6))
  CASE top$ OF
    WHEN "ME1"
      PROCmenu_create(dp_menu%,FNmsg_0(psup%! 16 ,"ME1"))
      indt%=(dp_menu%!28 AND &100)<>0
      REM get the resolution strings for this printer
      dp_j%=prdt%!20: dp_i%=0: dp_x%=0
      WHILE dp_j%
        dp_k%=!dp_j%! 8 
        xres%=FNprinter_read_integer_entry(dp_k%,4)
        yres%=FNprinter_read_integer_entry(dp_k%,5)
        nm$=FNprinter_read_string_entry(dp_k%,8)
        IF nm$<>"" THEN
          PROCmenu_item(dp_menu%,dp_i%,nm$,indt%)
        ELSE
          PROCmenu_item(dp_menu%,dp_i%,FNmsg_2(psup%! 16 ,"RES",STR$ xres%,STR$ yres%),indt%)
        ENDIF
        dp_i%+=1
        dp_j%=!dp_j%
      ENDWHILE
      PROCmenu_tick_match(dp_menu%,FNicon_read(wind%,3))
    WHEN "ME2"
      PROCmenu_create(dp_menu%,FNmsg_0(psup%! 16 ,"ME2"))
      PROCmenu_tick_match(dp_menu%,FNicon_read(wind%,17))
    WHEN "ME3"
      PROCmenu_create(dp_menu%,FNmsg_0(psup%! 16 ,"ME3"))
      REM need to find the right graphics entry for the current resolution
      dp_j%=prdt%!20: REM point to first record for this list
      WHILE dp_j%
        dp_k%=!dp_j%! 8 
        IF (FNicon_read(wind%,3)=FNmsg_2(psup%! 16 ,"RES",STR$ !dp_k%!20,STR$ !dp_k%!24)) OR            (FNicon_read(wind%,3)=$(dp_k%!36)) THEN

          REM ok - found the graphics entry, now get the options word
          dp_j%=FNdp_get_quality_options(dp_k%): dp_i%=0: dp_x%=0
          IF dp_j% AND &000007 PROCdp_menu_quality(dp_menu%,dp_i%,FNmsg_0(psup%! 16 ,"CO0"),dp_j%)
          IF dp_j% AND &000070 THEN
            IF DPQ$="S" THEN
              PROCdp_menu_quality(dp_menu%,dp_i%,FNmsg_0(psup%! 16 ,"CO1s"),dp_j%>>4)
            ELSE
              PROCdp_menu_quality(dp_menu%,dp_i%,FNmsg_0(psup%! 16 ,"CO1"),dp_j%>>4)
            ENDIF
          ENDIF
          IF dp_j% AND &000700 PROCdp_menu_quality(dp_menu%,dp_i%,FNmsg_0(psup%! 16 ,"CO2"),dp_j%>>8)
          IF dp_j% AND &070000 PROCdp_menu_quality(dp_menu%,dp_i%,FNmsg_0(psup%! 16 ,"CO4"),dp_j%>>16)
          IF dp_j% AND &700000 THEN
            IF DPQ$="S" THEN
              PROCdp_menu_quality(dp_menu%,dp_i%,FNmsg_0(psup%! 16 ,"CO5s"),dp_j%>>20)
            ELSE
              PROCdp_menu_quality(dp_menu%,dp_i%,FNmsg_0(psup%! 16 ,"CO5"),dp_j%>>20)
            ENDIF
          ENDIF
          dp_j%=0
        ELSE
          dp_j%=!dp_j%
        ENDIF
      ENDWHILE
      PROCmenu_tick_match(dp_menu%,FNicon_read(wind%,15))
    WHEN "ME4"
      PROCmenu_create(dp_menu%,FNmsg_0(psup%! 16 ,"ME4"))
      indt%=(dp_menu%!28 AND &100)<>0
      IF FNprinter_read_list_integer_entry(prdt%,5,2,1)THEN
        REM we have draft highlights
        PROCmenu_item(dp_menu%,1,FNmsg_0(psup%! 16 ,"TQ1"),indt%)
        IF FNprinter_read_list_integer_entry(prdt%,5,3,1)PROCmenu_item(dp_menu%,2,FNmsg_0(psup%! 16 ,"TQ2"),indt%)
      ENDIF
      PROCmenu_tick_match(dp_menu%,FNicon_read(wind%,14))
    WHEN "ME5"
      PROCmenu_create(dp_menu%,FNmsg_0(psup%! 16 ,"ME5"))
      PROCmenu_tick_match(dp_menu%,FNicon_read(wind%,23))
    WHEN "MP1"
      PROCcreate_paper_menu(dp_menu%,wind%,27)
  ENDCASE
  PROCdisplay_menu(prnt%,dp_menu%,dp_menu_xpos%,dp_menu_ypos%)
ENDPROC

DEF PROCdp_menu_quality(RETURN dp_menu%,RETURN dp_i%,strip$,tone%)
  LOCAL indt%
  VDU: PROCftracef("PROCdp_menu_quality")
  indt%=(dp_menu%!28 AND &100)<>0
  IF tone% AND 1 THEN
    IF DPQ$="S" THEN
      PROCmenu_item(dp_menu%,dp_i%,strip$+", "+FNmsg_0(psup%! 16 ,"HT4s"),indt%)
    ELSE
      PROCmenu_item(dp_menu%,dp_i%,strip$+", "+FNmsg_0(psup%! 16 ,"HT4"),indt%)
    ENDIF
    dp_i%+=1
  ENDIF
  IF tone% AND 2 THEN
    IF DPQ$="S" THEN
      PROCmenu_item(dp_menu%,dp_i%,strip$+", "+FNmsg_0(psup%! 16 ,"HT8s"),indt%)
    ELSE
      PROCmenu_item(dp_menu%,dp_i%,strip$+", "+FNmsg_0(psup%! 16 ,"HT8"),indt%)
    ENDIF
    dp_i%+=1
  ENDIF
  IF tone% AND 4 THEN
    IF DPQ$="S" THEN
      PROCmenu_item(dp_menu%,dp_i%,strip$+", "+FNmsg_0(psup%! 16 ,"HT1s"),indt%)
    ELSE
      PROCmenu_item(dp_menu%,dp_i%,strip$+", "+FNmsg_0(psup%! 16 ,"HT1"),indt%)
    ENDIF
    dp_i%+=1
  ENDIF
ENDPROC

DEF FNdp_hex2(v%)
  VDU: PROCftracef("FNdp_hex2")
=RIGHT$("0"+STR$~v%,2)

REM text printing code

DEF PROCdp_m8
  LOCAL dp_r%,queu%,tpub%,tprv%,text_prdt%
  VDU: PROCftracef("PROCdp_m8, reason "+STR$!xbuff%)
  VDU: PROCftracef(STR$~cnfg%)
  VDU: PROCftracef(STR$~cnfg%! 4 )
  VDU: PROCftracef(STR$~!cnfg%! 4 )
  text_prdt%=!cnfg%! 4 
  dp_r%=!xbuff%
  queu%=xbuff%!4
  tpub%=queu%! 44 
  tprv%=queu%! 48 
  CASE dp_r% OF
    WHEN  -1: PROCdp_1
    WHEN  -2: PROCdp_2
    WHEN  -4: PROCdp_4
    WHEN  -6: PROCdp_6
    WHEN  -7: PROCdp_7
    WHEN  -9: PROCdp_9
    WHEN -10: PROCdp_10
    WHEN -11: PROCdp_11
    WHEN -12: PROCdp_12
    WHEN -13: PROCdp_13
    WHEN -15: PROCdp_15
    WHEN -16: PROCdp_16
    WHEN -17: PROCdp_17
    WHEN -18: PROCdp_18
    WHEN -19: PROCdp_19
  ENDCASE
  VDU: PROCftracef("Afterwards ...")
  VDU: PROCftracef(STR$~cnfg%)
  VDU: PROCftracef(STR$~cnfg%! 4 )
  VDU: PROCftracef(STR$~!cnfg%! 4 )
ENDPROC

DEF PROCdp_1
 
  LOCAL dp_i%,dp_i$,psze%,dp_j%,B%,C%,D%
  VDU: PROCftracef("PROCdp_1")
  B%= &56525054 :C%= 20 
  tprv%=USR(code_entry%+ 12 )
  IFtprv%=0 ERROR  253 , FNmsg_0(FNdp_host_desc,"FA5")
  queu%! 48 =tprv%
  FOR dp_i%=0 TO  20 -4
    tprv%!dp_i%=0
  NEXT
  psze%=prnt%! 36 
  tprv%! 8 =psze%! 40 
  dp_j%=!cnfg%! 0 
  tpub%! 44 =(dp_j% AND &FF00)>>8
  IF dp_j% AND 4 tpub%! 48 = -1 
  IF dp_j% AND 2 tpub%! 52 = -1 
  IF(dp_j%>> 16  AND  15 )= 1  tpub%! 20 = -1 
  REM set the line epilogue string
  IF dp_j% AND 8 THEN
    dp_i$=FNprinter_read_string_entry(text_prdt%,6)
  ELSE
    dp_i$=FNprinter_read_string_entry(text_prdt%,5)
  ENDIF
  B%=A%! 16 
  $B%=dp_i$
  C%=5
  D%=LEN dp_i$
  tpub%! 108 =USR(code_entry%+ 28 )
  dp_i$=STRING$(psze%! 36 ,dp_i$)
  $B%=dp_i$
  C%=5
  D%=LEN dp_i$
  tprv%! 4 =USR(code_entry%+ 28 )
  tprv%! 0 =psze%! 48 
  tpub%! 76 =psze%! 48 -psze%! 36 -psze%! 32 
  REM set the pointer to the char translation list
  dp_j%=FNprinter_read_integer_entry(prdt%,6): REM point to the PRDT block
  IF dp_j% dp_j%=dp_j%! 8 
  queu%! 64 =dp_j%
ENDPROC

DEF PROCdp_2
  LOCAL dp_s$,pheight%,graphics_prdt%
  VDU: PROCftracef("PROCdp_2")
  REM output job start string
  dp_s$=FNprinter_read_string_entry(text_prdt%,7)
  IF dp_s$<>"" BPUT#xbuff%!8,dp_s$;
  dp_s$=FNprinter_read_string_entry(text_prdt%,1)
  pheight%=prnt%! 36 
  pheight%=pheight%! 48 

  REM Ouput set lines if both string exists and page length is not zero.
  REM OSS Kludge - if dumper name = "PDumperIW" then output as 144ths of
  REM an inch as a four digit decimal number with leading zeros. Assume
 REM 6 lines per inch, 144/6 = 24.

  IF dp_s$<>"" AND pheight%<>0 THEN
    graphics_prdt%=!cnfg%! 8 
    IF FNprinter_read_string_entry(FNprinter_read_integer_entry(graphics_prdt%,1),2)="PDumperIW" THEN
      dp_s$+="0000"
      RIGHT$(dp_s$,4)=STR$(pheight%*24)
      BPUT#xbuff%!8,dp_s$;
    ELSE
      BPUT#xbuff%!8,dp_s$+CHR$(pheight%);
    ENDIF
  ENDIF
ENDPROC

DEF PROCdp_4
  REM no data to output
  VDU: PROCftracef("PROCdp_4")
  xbuff%?8=0
ENDPROC

DEF PROCdp_6
  REM do control code processing
  LOCAL dp_b$
  VDU: PROCftracef("PROCdp_6")
  dp_b$=FNdp_display(xbuff%!8)
  xbuff%?8=LEN dp_b$
  $(xbuff%+9)=dp_b$
ENDPROC

DEF PROCdp_7
  REM process a backspace
  LOCAL dp_b$
  VDU: PROCftracef("PROCdp_7")
  dp_b$=FNprinter_read_string_entry(text_prdt%,2)
  xbuff%?8=LEN dp_b$
  $(xbuff%+9)=dp_b$
ENDPROC

DEF PROCdp_9
  LOCAL changed_bits%,clr_bits%,set_bits%,bit%,dp_b$
  VDU: PROCftracef("PROCdp_9")
  changed_bits%=tpub%! 96  EOR xbuff%!8
  clr_bits%=tpub%! 96  AND changed_bits%
  set_bits%=changed_bits% AND NOTclr_bits%
  IF clr_bits% OR set_bits% THEN
    FOR bit%=0 TO 5
      IF clr_bits% AND 1<<bit% THEN dp_b$+=FNdp_style_off(bit%)
      IF set_bits% AND 1<<bit% THEN dp_b$+=FNdp_style_on(bit%)
    NEXT
  ENDIF
  xbuff%?8=LEN dp_b$
  $(xbuff%+9)=dp_b$
ENDPROC

DEF PROCdp_10
  REM start a new line
  LOCAL dp_s$,dp_b$
  VDU: PROCftracef("PROCdp_10")
  tpub%! 80 +=1
  tpub%! 72 +=1
  IF tpub%! 48 <>0 OR tprv%! 8 >0 THEN
    dp_b$=FNdp_font(0): REM pica
    FOR bit%=0 TO 5
     IF tpub%! 96  AND 1<<bit% dp_b$+=FNdp_style_off(bit%)
    NEXT
    dp_b$+=STRING$(tprv%! 8 ," ")
    IF tpub%! 48  THEN
      dp_s$=STR$ tpub%! 72 
      dp_b$+=STRING$(5-LEN dp_s$," ")+dp_s$+" "
    ENDIF
    FOR bit%=0 TO 5
      IF tpub%! 96  AND 1<<bit% dp_b$+=FNdp_style_on(bit%)
    NEXT
  ENDIF
  dp_b$+=FNdp_font(tpub%! 64 )+STRING$(tprv%! 12 ," ")
  xbuff%?8=LEN dp_b$
  $(xbuff%+9)=dp_b$
ENDPROC

DEF PROCdp_11
  LOCAL dp_b$,dp_i%
  VDU: PROCftracef("PROCdp_11")
  PROCdp_10:dp_b$=FNprinter_read_string(tpub%! 108 )+$(xbuff%+9)
  PROCdp_10:dp_b$+=FNprinter_read_string(tpub%! 108 )+$(xbuff%+9)
  dp_b$+=FNdp_style_on(4): REM superscript
  dp_b$+=FNdp_trans(RIGHT$("  "+STR$ tpub%! 60 ,3)+STRING$(3,FNprinter_read_string_entry(text_prdt%,2)))
  dp_b$+=FNdp_style_off(4)
  xbuff%?8=LEN dp_b$
  $(xbuff%+9)=dp_b$
ENDPROC

DEF PROCdp_12
  LOCAL dp_b$
  VDU: PROCftracef("PROCdp_12")
  dp_b$=FNdp_trans($(xbuff%+8))
  xbuff%?8=LEN dp_b$
  $(xbuff%+9)=dp_b$
ENDPROC

DEF PROCdp_13
  VDU: PROCftracef("PROCdp_13")
  tpub%! 64 =xbuff%!8
  xbuff%?8=0
ENDPROC

DEF PROCdp_15
 
  LOCAL text_prdt%,tpub%,dp_epilogue$,dp_formfeed$,dp_lineepi$
  VDU: PROCftracef("PROCdp_15")
  IF queu%! 36 <>&FF4 THEN
    text_prdt%=!cnfg%! 4 
    tpub%=queu%! 44 
    dp_lineepi$=FNprinter_read_string(tpub%! 108 )
    IF queu%! 36 =&FFF THEN
 



      IF(tpub%! 40 )=0 THEN
        dp_epilogue$=FNprinter_read_string_entry(text_prdt%,8)
        dp_formfeed$=FNprinter_read_string_entry(text_prdt%,4)
        IF INSTR(dp_epilogue$,dp_lineepi$)<>1 THEN
          IF dp_lineepi$<>"" BPUT#xbuff%!8,dp_lineepi$;
        ENDIF
        IF dp_epilogue$<>"" BPUT#xbuff%!8,dp_epilogue$;
      ENDIF
    ELSE
      REM output a blank line between files
      IF dp_lineepi$<>"" BPUT#xbuff%!8,dp_lineepi$;
    ENDIF
  ENDIF
ENDPROC

DEF PROCdp_16
  REM process a tab
  LOCAL dp_b$
  VDU: PROCftracef("PROCdp_16")
  dp_b$=FNprinter_read_string_entry(text_prdt%,3)
  xbuff%?8=LEN dp_b$
  $(xbuff%+9)=dp_b$
ENDPROC

DEF PROCdp_17
  REM do a formfeed
  LOCAL dp_b$
  VDU: PROCftracef("PROCdp_17")
  dp_b$=FNprinter_read_string_entry(text_prdt%,4)
  xbuff%?8=LEN dp_b$
  $(xbuff%+9)=dp_b$
ENDPROC

DEF PROCdp_18
  REM change layout
  LOCAL layout_height%,layout_top%,layout_bottom%,dp_b$,dp_i%,dp_i$,B%,C%,D%,graphics_prdt%
  VDU: PROCftracef("PROCdp_18")
  layout_height%=xbuff%!8
  layout_top%=xbuff%!12
  layout_bottom%=xbuff%!16
  IF layout_height%<=tprv%! 0  AND layout_top%<=layout_height%*0.33 AND layout_bottom%<=layout_height%*0.33 THEN
    tpub%! 76 =layout_height%-layout_top%-layout_bottom%
    IF tprv%! 4  THEN
      VDU: PROCftracef("Calling heap free with ptr "+STR$~tprv%! 4 )
      B%= &52545347 
      C%=tprv%! 4 
      CALL code_entry%+ 16 
    ENDIF
    dp_i$=STRING$(layout_top%,FNprinter_read_string(tpub%! 108 ))
    B%=A%! 16 
    $B%=dp_i$
    C%=5
    D%=LEN dp_i$
    tprv%! 4 =USR(code_entry%+ 28 )
    dp_b$=FNprinter_read_string_entry(text_prdt%,1): REM text_page_line

    REM OSS Kludge - if dumper name = "PDumperIW" then output as 144ths of
    REM an inch as a four digit decimal number with leading zeros. Assume
    REM 6 lines per inch, 144/6 = 24.

    IF dp_b$<>"" AND layout_height%<>0 THEN
      graphics_prdt%=!(cnfg%! 8 )
      IF FNprinter_read_string_entry(FNprinter_read_integer_entry(graphics_prdt%,1),2)="PDumperIW" THEN
        dp_b$+="0000"
        RIGHT$(dp_b$,4)=STR$(layout_height%*24)
      ELSE
        dp_b$+=CHR$ layout_height%
      ENDIF
    ENDIF
  ENDIF
  xbuff%?8=LEN dp_b$
  $(xbuff%+9)=dp_b$
ENDPROC

DEF PROCdp_19
  VDU: PROCftracef("PROCdp_19")
  LOCAL dp_b$,dp_i%,dp_s$,bit%
  dp_b$=FNprinter_read_string(tprv%! 4 )
  tpub%! 80 =0
  tpub%! 84 +=1
  IF tpub%! 52  THEN
    tpub%! 80 +=2
    dp_b$+=FNdp_font(0): REM pica
    FOR bit%=0 TO 5
     IF tpub%! 96  AND 1<<bit% dp_b$+=FNdp_style_off(bit%)
    NEXT
    dp_b$+=STRING$(tprv%! 8 +tprv%! 12 ," ")
    dp_s$=FNprinter_read_string(tpub%! 112 )+"   "+FNprinter_read_string(tpub%! 120 )
    dp_s$+="   "+FNmsg_1(psup%! 16 ,"PAG",STR$ tpub%! 84 )
    dp_b$+=FNdp_trans(dp_s$)
    FOR bit%=0 TO 5
      IF tpub%! 96  AND 1<<bit% dp_b$+=FNdp_style_on(bit%)
    NEXT
    dp_b$+=STRING$(2,FNprinter_read_string(tpub%! 108 ))
  ENDIF
  xbuff%?8=LEN dp_b$
  $(xbuff%+9)=dp_b$
ENDPROC

DEF FNdp_trans(dp_s$)
  LOCAL dp_i%,byte%,out$,str$
  VDU: PROCftracef("FNdp_trans")
  IF dp_s$="" THEN =""
  FOR dp_i%=1 TO LEN dp_s$
    byte%=ASC MID$(dp_s$,dp_i%,1)
    str$=""
    CASE  -1  OF
      WHEN byte%<32 OR byte%=127
        IF tpub%! 44 =1 str$=FNdp_display(byte%)
      WHEN byte%>127 AND tpub%! 44 <>0
        IF tpub%! 44 =1 str$=FNdp_display(byte%)
      WHEN tpub%! 44 <>0
        str$=CHR$ byte%
      OTHERWISE
        str$=FNdp_text_char(byte%)
        IF str$="" str$=CHR$ byte%
    ENDCASE
    out$+=str$
  NEXT
=out$

DEF FNdp_text_char(byte%)
  LOCAL dp_p%,dp_s$,dp_i%
  VDU: PROCftracef("FNdp_text_char")
  dp_p%=queu%! 64 
  WHILE dp_p%
    CASE  -1  OF
      WHEN dp_p%?4=byte%
        dp_i%=dp_p%?5:dp_p%=dp_p%+6
        WHILE dp_i%
          dp_s$+=CHR$ ?dp_p%
          dp_p%+=1
          dp_i%-=1
        ENDWHILE
        =dp_s$
      WHEN dp_p%?4>byte%
        dp_p%=0
      OTHERWISE
        dp_p%=!dp_p%
    ENDCASE
  ENDWHILE
=""

DEF FNdp_display(byte%)
  VDU: PROCftracef("FNdp_display")
="["+RIGHT$("0"+FNtask_lower(STR$~byte%),2)+"]"

DEF FNdp_style_on(bit%)
  VDU: PROCftracef("FNdp_style_on")
  CASE bit% OF
    WHEN 0: =FNprinter_read_string_entry(text_prdt%,13): REM bold on
    WHEN 1: =FNprinter_read_string_entry(text_prdt%,17): REM light on
    WHEN 2: =FNprinter_read_string_entry(text_prdt%,15): REM italic on
    WHEN 3: =FNprinter_read_string_entry(text_prdt%,23): REM underline on
    WHEN 4: =FNprinter_read_string_entry(text_prdt%,19): REM superscript on
    WHEN 5: =FNprinter_read_string_entry(text_prdt%,21): REM subscript on
  ENDCASE
=""
:
DEF FNdp_style_off(bit%)
  VDU: PROCftracef("FNdp_style_off")
  CASE bit% OF
    WHEN 0: =FNprinter_read_string_entry(text_prdt%,14): REM bold off
    WHEN 1: =FNprinter_read_string_entry(text_prdt%,18): REM light off
    WHEN 2: =FNprinter_read_string_entry(text_prdt%,16): REM italic off
    WHEN 3: =FNprinter_read_string_entry(text_prdt%,24): REM underline off
    WHEN 4: =FNprinter_read_string_entry(text_prdt%,20): REM superscript off
    WHEN 5: =FNprinter_read_string_entry(text_prdt%,22): REM subscript off
  ENDCASE
=""

DEF FNdp_font(font%)
  VDU: PROCftracef("FNdp_font")
  CASE font% OF
    WHEN 0: =FNprinter_read_string_entry(text_prdt%,9):REM pica
    WHEN 1: =FNprinter_read_string_entry(text_prdt%,10):REM elite
    WHEN 2: =FNprinter_read_string_entry(text_prdt%,11):REM condensed
    WHEN 3: =FNprinter_read_string_entry(text_prdt%,12):REM expanded
  ENDCASE
=""

DEF FNdp_host_desc
LOCAL a%
a%=buff%!24
=a%! 12 
#line 10127 "sources.RunImage"
#line 1 "sources.SupportLJ"
REM > Support - for Laser/Desk Jet printers

 










#line 1 "h.Values"
 
























  






  





  











  





  





























































































































































































































































































































 























































 




 





 




 

























 



 
















































































































#line 15 "sources.SupportLJ"
#line 1 "h.Trace"






   
   
   
   

#line 16 "sources.SupportLJ"

DEF FNlj_support(buff%)
  LOCAL reason%,psup%,prnt%,prdt%,cnfg%,xbuff%,psize_head%,code_entry%
  VDU: PROCftracef("PROClj_support")
  reason%=buff%!0
  psup%=buff%!4
  prnt%=buff%!8
  xbuff%=buff%!12
  psize_head%=buff%!16
  code_entry%=buff%!20
  IF prnt% THEN
    prdt%=FNprinter_find_prdata_entry(psup%,$prnt%! 8 )
    cnfg%=prnt%! 16 
  ENDIF
  CASE reason% OF
    WHEN -1: PROClj_m1
    WHEN -2: PROClj_m2
    WHEN -3: PROClj_m3
    WHEN -4: PROClj_m4
    WHEN -5: PROClj_m5
    WHEN -6: PROClj_m6
    WHEN -7: PROClj_m7
    WHEN -8: PROClj_m8
    WHEN 3: PROClj_p3
    WHEN 6: PROClj_p6
    WHEN 8: PROClj_p8
    WHEN 9: PROClj_p9
    WHEN 17,18: PROClj_p17
  ENDCASE
= 0 

DEF PROClj_m1
  LOCAL colours%, pdriverdp%, exists%
  REM psup%! 24  OR= 0
  VDU: PROCftracef("PROClj_m1")
  psup%! 28 =&FF4
  psup%! 32 =%1001
  psup%! 36 = 16 /4
  psup%! 40 =2
  REM note that the version number really only reflects
  REM the status of the files being read, ie only change
  REM this number if the file contents change.
  psup%! 44 =100
  psup%! 52 =0
  colours%=FNrmload_latest_module("ColourTrans","System:Modules.Colours")
  IFFNrmload_latest_module("PDriver","Printers:Modules.PDriver")
  IFFNrmload_latest_module("PDumperSupport","Printers:Modules.PDumperSpt")
  pdriverdp%=FNrmload_latest_module("PDriverDP","Printers:Modules.PDriverDP")
  REM ***** WARNING!
  REM ***** THESE VERSION NUMBERS ARE HARD CODED!
  IFpdriverdp%>400 AND colours%<150 THEN
    SYS"Wimp_ReportError",FNmsg_0(FNlj_host_desc,"WA12"), 1 OR 1<<4,FNmsg_1(FNlj_host_desc,"ER2",FNmsg_0(FNlj_host_desc,"ID"))
  ENDIF
 



LJQ$="S"
ENDPROC

DEF PROClj_m2
  VDU: PROCftracef("PROClj_m2")
 







ENDPROC

DEF PROClj_m3
  REM initialise the configuration window
  LOCAL config%,lj_i%,lj_j%
  VDU: PROCftracef("PROClj_m3")
  config%=FNprinter_find_window(prnt%,"configure")
  PROCicon_write(config%,27,FNprinter_read_string(prnt%! 40 ))
  PROCicon_write(config%,6,$prnt%! 8 )
  PROCicon_write(config%,3,FNlj_res(cnfg%))
  PROCicon_write(config%,15,FNlj_qual(cnfg%))
  lj_i%=!cnfg%! 0 
  lj_j%=lj_i% AND 1
  PROCicon_write(config%,17,FNmsg_0(psup%! 16 ,"PF"+STR$ lj_j%))
  IF prnt%! 24  AND 1<<6 THEN
    PROCicon_shade(config%,8)
    PROCicon_shade(config%,11)
    PROCicon_shade(config%,13)
    PROCicon_shade(config%,14)
    PROCicon_shade(config%,22)
    PROCicon_shade(config%,23)
  ELSE
    PROCicon_unshade(config%,8)
    PROCicon_unshade(config%,11)
    PROCicon_unshade(config%,13)
    PROCicon_unshade(config%,14)
    PROCicon_unshade(config%,22)
    PROCicon_unshade(config%,23)
    lj_j%=lj_i% AND %000010
    IF lj_j% PROCicon_select(config%,8)ELSE PROCicon_deselect(config%,8)
    lj_j%=lj_i% AND %000100
    IF lj_j% PROCicon_select(config%,11)ELSE PROCicon_deselect(config%,11)
    lj_j%=lj_i% AND %001000
    PROCicon_write(config%,13,FNmsg_0(psup%! 16 ,"PO"+STR$(lj_j%>>3)))
    lj_j%=(lj_i% AND &F00)>>8
    PROCicon_write(config%,22,FNmsg_0(psup%! 16 ,"CC"+STR$ lj_j%))
  ENDIF
  lj_i%=prnt%! 36 
  PROCicon_write(config%,25,$lj_i%! 4 )
ENDPROC

DEF PROClj_m4
  REM create a CNFG block with suitable defaults
  LOCAL lj_s$,lj_nm$,lj_nm2$,lj_i%,lj_s%,lj_t%,lj_x%,lj_y%,lj_co%,lj_ht%,B%,C%
  VDU: PROCftracef("PROClj_m4")
  REM PJC: set the text options to be draft
  cnfg%! 0 =FNstore_integer(%010000)
  REM portrait mode is no-highlights entry
  lj_i%=FNprinter_read_list_integer_entry(prdt%,5,1,1)
  IF lj_i% THEN
    B%= &52544F50 
    C%=4
    cnfg%! 4 =USR(code_entry%+ 12 )
    IF cnfg%! 4 =0 ERROR  253 , FNmsg_0(FNlj_host_desc,"FA5")
    !cnfg%! 4 =lj_i%
  ELSE
    prnt%! 24 =prnt%! 24  OR 1<<6
  ENDIF

  REM try to read the default x and y resolutions and name from the PRDT block
  lj_x%=FNprinter_read_integer_entry(prdt%,8)
  lj_y%=FNprinter_read_integer_entry(prdt%,9)
  lj_nm$=FNprinter_read_string_entry(prdt%,12)
  IF lj_nm$<>"" THEN
    REM try to find the graphics mode which matches this name
    C%=1
    REPEAT
      B%=FNprinter_read_list_integer_entry(prdt%,4,C%,1)
 
      IF B%=0 THEN
        C%=-1
      ELSE
        lj_nm2$=FNprinter_read_string_entry(B%,8)
        REM if no match, try the next mode
        IFlj_nm$<>lj_nm2$ C%+=1
      ENDIF
    UNTIL C%=-1 OR lj_nm$=lj_nm2$
    REM if we found it, remember where it was
    IF C%<>-1 lj_i%=C%
  ELSE
    IF (lj_x%<>0 AND lj_y%<>0) THEN
      REM try to find the graphics mode which matches this resolution
      C%=1
      REPEAT
        B%=FNprinter_read_list_integer_entry(prdt%,4,C%,1)
   
        IF B%=0 THEN
          C%=-1
        ELSE
          lj_s%=FNprinter_read_integer_entry(B%,4)
          lj_t%=FNprinter_read_integer_entry(B%,5)
          REM if no match, try the next mode
          IFlj_s%<>lj_x% OR lj_t%<>lj_y% C%+=1
        ENDIF
      UNTIL C%=-1 OR (lj_s%=lj_x% AND lj_t%=lj_y%)
      REM if we found it, remember where it was
      IF C%<>-1 lj_i%=C%
    ELSE
      REM show we didn't match - which we couldn't 'cos we didn't have the values
      C%=-1
    ENDIF
  ENDIF
 



  IF C%=-1 THEN
    C%=1
    lj_i%= 0 
    REPEAT
      B%=FNprinter_read_list_integer_entry(prdt%,4,C%,1)
      IF B%=0 THEN
        REM run out of parameters, go back to the last one
        C%-=1: lj_i%= -1 
      ELSE
        lj_x%=FNprinter_read_integer_entry(B%,4)
        lj_y%=FNprinter_read_integer_entry(B%,5)
        IF lj_x%<300 OR lj_y%<300 C%+=1 ELSE lj_i%= -1 
      ENDIF
    UNTIL lj_i%
    lj_i%=C%
  ENDIF

  B%= &52544F50 
  C%=4
  cnfg%! 8 =USR(code_entry%+ 12 )
  IF cnfg%! 8 =0 ERROR  253 , FNmsg_0(FNlj_host_desc,"FA5")
  !cnfg%! 8 =FNprinter_read_list_integer_entry(prdt%,4,lj_i%,1)

  REM ensure that the module is present in memory
  lj_s$=FNprinter_read_string_entry(FNprinter_read_integer_entry(!cnfg%! 8 ,1),2)
  IFFNrmload_latest_module(lj_s$, "Printers:PDumpers."+lj_s$)

  REM ensure that the palette file needed at the resolution is cached
  REM bit 23 of palette no. flags whether already ensured or not
  lj_s$=STR$(FNprinter_read_integer_entry(!cnfg%! 8 ,2) AND &7FFFFF)
  PROClj_ensure_resource_file("Resources.Printers.Palettes."+lj_s$,"Printers:Palettes."+lj_s$,!cnfg%! 8 )

  REM initialise the quality
  REM see if a quality was provided in the PDF
  lj_i%=FNprinter_read_integer_entry(prdt%,10)
  REM get the qualities available at the configured resolution
  lj_s%=FNlj_get_quality_options(!cnfg%! 8 )
  IF lj_i%<>0 THEN
 




    lj_co%=lj_i% AND &FF
    lj_ht%=(lj_i% AND &FF00)>>8
    CASE lj_co% OF
      WHEN 0: REM mono
        IF (lj_s% AND 7) THEN
          IF lj_ht%=4 AND (lj_s% AND 1)=0 lj_i%=0
          IF lj_ht%=8 AND (lj_s% AND 2)=0 lj_i%=0
          IF lj_ht%=1 AND (lj_s% AND 4)=0 lj_i%=0
        ELSE
          lj_i%=0
        ENDIF
      WHEN 1: REM greyscale
        IF (lj_s% AND &70) THEN
          IF lj_ht%=4 AND ((lj_s%>>4) AND 1)=0 lj_i%=0
          IF lj_ht%=8 AND ((lj_s%>>4) AND 2)=0 lj_i%=0
          IF lj_ht%=1 AND ((lj_s%>>4) AND 4)=0 lj_i%=0
        ELSE
          lj_i%=0
        ENDIF
      WHEN 2: REM colour
        IF (lj_s% AND &700) THEN
          IF lj_ht%=4 AND ((lj_s%>>8) AND 1)=0 lj_i%=0
          IF lj_ht%=8 AND ((lj_s%>>8) AND 2)=0 lj_i%=0
          IF lj_ht%=1 AND ((lj_s%>>8) AND 4)=0 lj_i%=0
        ELSE
          lj_i%=0
        ENDIF
    ENDCASE
  ENDIF

  IF lj_i%<>0 THEN
    cnfg%! 12 =FNstore_integer(lj_i%)
  ELSE
    PROClj_decode_options(lj_s%,lj_co%,lj_ht%)
    cnfg%! 12 =FNstore_integer(lj_ht%<<8 OR lj_co%)
  ENDIF

  $buff%=FNprinter_read_string_entry(prdt%,2)
  B%=buff%
  C%=2
  prnt%! 40 =USR(code_entry%+ 28 )
  lj_s$=FNprinter_read_string_entry(prdt%,3)
 
  IF lj_s$<>"lj" $buff%=lj_s$:B%=buff%:C%=2:prnt%! 44 =USR(code_entry%+ 28 )
 




  lj_s$=FNprinter_read_string_entry(prdt%,7)
  REM fall back to going for the default
  IF lj_s$="" lj_s$=FNmsg_0(psup%! 16 ,"PAP")

  VDU: PROCftracef("initialise the best paper size we can find")
  lj_i%=psize_head%
  WHILE lj_s$<>FNprinter_read_string(lj_i%! 4 )
    lj_i%=lj_i%! 0 
    REM if we run out of paper entries, go for the first one
    IF lj_i%=0 lj_i%=psize_head%: lj_s$=FNprinter_read_string(lj_i%! 4 )
  ENDWHILE
  prnt%! 36 =lj_i%

  REM if this printer supports fast parallel, set the appropriate flag
  lj_i%=FNprinter_read_integer_entry(prdt%,11)
  IFlj_i%<>0 prnt%! 24  = prnt%! 24  OR (1<<7)

  VDU: PROCftracef("PROClj_m4 done")
ENDPROC

DEF PROClj_ensure_resource_file(resource$,disc$,gprdt%)
  LOCAL obj_type%,load_addr%,exec_addr%,file_size%,obj_attr%,rma_size%,rma_block%
  LOCAL found_type%,found_load%,found_exec%,found_size%,c%,a%,w%,pnum%,reload_if_outofdate%
  VDU: PROCftracef("lj_ensure_resource_file("+resource$+disc$+")")
  REM We use this to load palette files for the printers in order to reduce
  REM the probability of having to ask for the printers disc again later.

  REM check for out of date palette if we have not ensured this one before (bit 23 of palette number)
  pnum% = FNprinter_read_integer_entry(gprdt%,2)
  reload_if_outofdate% = ((pnum% AND &800000) = 0)
  PROCprinter_write_integer_entry(gprdt%,2,pnum% OR &800000):REM we (will) have ensured it

  REM First of all, check if the file exists already
  SYS "OS_File",17,"Resources:"+resource$ TO found_type%,,found_load%,found_exec%,found_size%: REM OS_FileReadNoPath

  IF found_type% AND reload_if_outofdate%= 0  ENDPROC

  SYS "OS_File",17,disc$ TO obj_type%,,load_addr%,exec_addr%,file_size%,obj_attr%: REM OS_FileReadNoPath
  IF obj_type%<>1 SYS "OS_File",19,disc$,obj_type%: REM OS_FileMakeError

  IF found_type% THEN
    IFfound_load%=load_addr% AND found_exec%=exec_addr% AND found_size%=file_size% ENDPROC
    REM cached palette is not the same as the one on disc
    REM try to remove the cached palette
    c%=OPENIN("Resources:"+resource$)
    IFc%=0 ERROR  254 , FNmsg_1(FNlj_host_desc,"OKBB",resource$)
    SYS"OS_FSControl",21,c% TO ,a%,w%
    CLOSE#c%
    IF(w%AND&FF)<>46 ERROR  254 , FNmsg_1(FNlj_host_desc,"OKBC",resource$)
    a%-=(LENresource$+4ANDNOT3)+4
    a%-=20
    IFa%!-4 = &48434143 THEN
      SYS"ResourceFS_DeregisterFiles",a%
      SYS"OS_Module",7,,a%-4
    ENDIF
  ENDIF

  rma_size%=20+(LEN resource$+4 AND NOT 3)+4+(file_size%+3 AND NOT 3): REM Size needed for this file only
  VDU: PROCftracef("File "+disc$+", size "+STR$ file_size%)

  REM claim some RMA for the file
  SYS "OS_Module",6,,,rma_size%+8 TO,,rma_block%: REM OSModule_Alloc
  REM Put a check tag at the beginning of the block
  !rma_block%=&48434143:REM CACH
  rma_block%+=4
  REM Fill in the block
  rma_block%!0=rma_size%
  rma_block%!4=load_addr%
  rma_block%!8=exec_addr%
  rma_block%!12=file_size%
  rma_block%!16=obj_attr%
  $(rma_block%+20)=resource$
  rma_block%!(20+LEN resource$)=0  
  rma_block%!(20+(LEN resource$+4 AND NOT 3))=file_size%+4
  SYS "OS_File",16,disc$,rma_block%+20+(LEN resource$+4 AND NOT 3)+4: REM OS_FileLoadNoPath
  rma_block%!rma_size%=0: REM Terminator
  SYS "ResourceFS_RegisterFiles",rma_block%
ENDPROC

DEF PROClj_m5
  REM cache any palette files that are used by lj printers and ensure
  REM that the relevant PDumper modules are loaded
  LOCAL lj_prnt%,lj_cnfg%,lj_graphics_prdt%,lj_pal$
  VDU: PROCftracef("PROClj_m5")
  lj_prnt%=prnt%
  WHILE lj_prnt%>0
    IF lj_prnt%! 4 =psup% THEN
      REM got a printer in our class - cache the palette file
      lj_cnfg%=lj_prnt%! 16 
      lj_graphics_prdt%=!lj_cnfg%! 8 
      REM bit 23 of palette no. flags whether already ensured or not
      lj_pal$=STR$(FNprinter_read_integer_entry(lj_graphics_prdt%,2) AND &7FFFFF)
      PROClj_ensure_resource_file("Resources.Printers.Palettes."+lj_pal$,"Printers:Palettes."+lj_pal$,lj_graphics_prdt%)

      REM and ensure the pdumper module
      lj_pal$=FNprinter_read_string_entry(FNprinter_read_integer_entry(lj_graphics_prdt%,1),2)
      IFFNrmload_latest_module(lj_pal$, "Printers:PDumpers."+lj_pal$)
    ENDIF
    lj_prnt%=lj_prnt%! 0 
  ENDWHILE
ENDPROC

DEF PROClj_m6
  REM do whatever is necessary to prime the specified printer
  LOCAL lj_s$,lj_t$,lj_i%,lj_j%,xres%,yres%,halftone%,ptr%,pal%,dmp$,inf%,strip%,graphics_prdt%,text_prdt%
  LOCAL format_print%,local_pl%,local_pr%,local_pb%,local_pt%,local_ph%,local_A%,local_B%,local_G%,local_B$,B%,C%
  VDU: PROCftracef("PROClj_m6")
  REM 7 is the magic number for the dumper driver
  IF(lj_i% AND 1)=0 SYS"XPDriver_SelectDriver",7
  lj_s$=FNprinter_read_string(prnt%! 40 )
  IF lj_s$="" THEN
    lj_s$=$prnt%! 8 
    IF LEN lj_s$>20 THEN
      lj_i%=LEN lj_s$
      WHILE MID$(lj_s$,lj_i%,1)<>" " AND lj_i%>0
        lj_i%-=1
      ENDWHILE
      IF lj_i% lj_s$=LEFT$(lj_s$,lj_i%-1)ELSE lj_s$=LEFT$(lj_s$,20)
    ENDIF
  ENDIF
  graphics_prdt%=!cnfg%! 8 
  xres%=FNprinter_read_integer_entry(graphics_prdt%,4)
  yres%=FNprinter_read_integer_entry(graphics_prdt%,5)
  halftone%=(!cnfg%! 12  AND &FF00)>>8
  strip%=!cnfg%! 12  AND &FF
  REM WARNING!
  REM The comparison is made against strip type 2 (colour) or greater
  REM This assumes, therefore, that any strip types that are 2 or greater
  REM are colour which is currently true
  IF (strip% >= 2) THEN
   SYS"XPDriver_SetInfo",,xres%,yres%,1,lj_s$,xres%/halftone%,yres%/halftone% TO ptr%;lj_i%
  ELSE
   SYS"XPDriver_SetInfo",,xres%,yres%,0,lj_s$,xres%/halftone%,yres%/halftone% TO ptr%;lj_i%
  ENDIF
  IF (lj_i% AND 1) AND (ptr%<>0) THEN
    lj_s$="": ptr%+=4
    WHILE ?ptr%: lj_s$+=CHR$ ?ptr%: ptr%+=1: ENDWHILE
    ERROR  254 ,lj_s$
    ENDPROC
  ENDIF

  REM bit 23 of palette no. flags whether already ensured or not
  lj_s$=STR$(FNprinter_read_integer_entry(graphics_prdt%,2) AND &7FFFFF)
  B%= &46424450 
  C%=256
  pal%=USR(code_entry%+ 12 )
  IFpal%=0 ERROR  253 , FNmsg_0(FNlj_host_desc,"FA5")
  $pal%="Resources:$.Resources.Printers.Palettes."+lj_s$
  inf%=USR(code_entry%+ 12 )
  IFinf%=0 ERROR  253 , FNmsg_0(FNlj_host_desc,"FA5")
  $inf%=FNprinter_read_string_entry(graphics_prdt%,6)
  strip%=!cnfg%! 12  AND &FF
 



  IF strip%=5 THEN
   lj_i%=FNprinter_read_integer_entry(graphics_prdt%,1)
   lj_i%=FNprinter_read_integer_entry(lj_i%,1)
   SYS"XPDriver_MiscOp",&80000002,lj_i% TO ptr%;lj_i%
   IF(lj_i%AND1)=0 IF ptr%<>&80000002 IF(ptr% AND (1<<5))=0 strip%=3
  ENDIF
 
  PROClj_ensure_resource_file("Resources.Printers.Palettes."+lj_s$,"Printers:Palettes."+lj_s$,graphics_prdt%)

  REM Module name:
  lj_s$=FNprinter_read_string_entry(FNprinter_read_integer_entry(graphics_prdt%,1),2)
  dmp$="RMLoad Printers:PDumpers."+lj_s$+CHR$ 13

  REM set passes per line entry
  REM WARNING!
  REM The comparison is made against strip type 2 (colour) or greater
  REM This assumes, therefore, that any strip types that are 2 or greater
  REM are colour which is currently true
  IF strip%>=2 inf%? 3 =4 ELSE inf%? 3 =1

  REM set strip type field
  inf%? 4 =strip%

  REM set output bpp field
  IF strip%=0 inf%? 5 =1 ELSE inf%? 5 =8

  REM set num passes field
  IF strip%=3 inf%? 6 =3 ELSE inf%? 6 =1

  SYS "XPDriver_SetDriver",,FNprinter_read_integer_entry(FNprinter_read_integer_entry(graphics_prdt%,1),1),dmp$,pal%,inf%,FNprinter_read_integer_entry(graphics_prdt%,7)
  B%= &46424450 
  C%=pal%
  CALL code_entry%+ 16 
  C%=inf%
  CALL code_entry%+ 16 
  SYS"OS_CLI","Unset PDriver$TextChars1"
  lj_i%=FNprinter_read_integer_entry(prdt%,6): REM point to the chars PRDT block
  IF lj_i% THEN
    lj_i%=lj_i%! 8 
    WHILE lj_i%
      IF lj_i%? 4 =ASC"" THEN
        lj_s$=FNlj_hex2(ASC"")+FNlj_hex2(lj_i%? 5 )
        ptr%=lj_i%+ 6 
        lj_i%=lj_i%? 5 
        WHILE lj_i%
          lj_s$+=FNlj_hex2(?ptr%)
          ptr%+=1
          lj_i%-=1
        ENDWHILE
        SYS"OS_CLI","Set PDriver$TextChars1 "+lj_s$
      ELSE
        lj_i%=lj_i%! 0 
      ENDIF
    ENDWHILE
  ENDIF
  text_prdt%=!cnfg%! 4 
  lj_i%=prnt%! 36 
  lj_s$=$lj_i%! 4 
  lj_j%=0
  WHILE MID$(lj_s$,lj_j%,1)<>" " AND lj_j%<=LEN lj_s$
    lj_j%+=1
  ENDWHILE
  lj_t$="PT_"+LEFT$(lj_s$,lj_j%-1)
  lj_s$=FNmsg_0(psup%! 16 ,lj_t$)
  IF lj_s$=lj_t$ lj_s$=FNmsg_0(psup%! 16 ,"PT_A4")
  IF !cnfg%! 0  AND 1 THEN
    lj_t$=FNmsg_0(psup%! 16 ,"MANUAL_FEED")
  ELSE
    lj_t$=FNmsg_0(psup%! 16 ,"AUTO_FEED")
  ENDIF
  SYS"OS_CLI","Set PDumperLJ$Extra "+FNungstrans(lj_t$+lj_s$)
  format_print%=(!cnfg%! 0  AND 8)>>3
  local_pl%=lj_i%! 24 
  local_pr%=lj_i%! 28 
  local_pb%=lj_i%! 16 
  local_pt%=lj_i%! 20 
  local_ph%=lj_i%! 12 
  IF format_print%=0 THEN
    local_yt%=0
    WHILE local_yt%*12000<local_ph%-local_pt%
      local_yt%+=1
    ENDWHILE
    local_pt%=local_ph%-local_yt%*12000: REM 72000 DIV 6
    local_B%=(local_pr%-local_pl%)*10 DIV 72000
    local_A%=(local_pt%-local_pb%)*6 DIV 72000
  ELSE
    local_yt%=0
    WHILE local_yt%*9000<local_pl%
      local_yt%+=1
    ENDWHILE
    local_pl%=local_yt%*9000: REM 72000 DIV 8
    local_B%=((local_pt%-local_pb%)*16.66 DIV 72000 - 1)DIV 2
    local_A%=(local_pr%-local_pl%)*8 DIV 72000
  ENDIF
  IF !cnfg%! 0  AND %1000 local_G%=2 ELSE local_G%=0
  lj_t$="-Ph "+STR$ local_A%+" -Pw "+STR$ local_B%+" -Mt "+STR$ lj_i%! 36 
  lj_t$+=" -Mb "+STR$ lj_i%! 32 +" -Ml "+STR$ lj_i%! 40 
  lj_t$+=" -Mr "+STR$ lj_i%! 44 +" -Th "+STR$ local_G%+" -Nl |<10>|<13>"
  local_B$=FNungstrans(FNungstrans(FNlj_font(0)))
  IF local_B$<>"" lj_t$+=" -Rs "+local_B$
  local_B$=FNungstrans(FNungstrans(FNlj_font(2)))
  IF local_B$<>"" lj_t$+=" -Cd "+local_B$
  SYS"OS_CLI","Set PDriver$TextPage "+lj_t$
  VDU: PROCftracef("PROClj_m6 done")
ENDPROC

DEF PROClj_m7
  LOCAL queu%,lj_p%,B%,C%
  VDU: PROCftracef("PROClj_m7")
  queu%=!xbuff%
  lj_p%=queu%! 48 
  IF lj_p% THEN
    B%= &56525054 
    C%=lj_p%
    CALL code_entry%+ 16 
    queu%! 48 =0
  ENDIF
ENDPROC

DEF PROClj_p3
  VDU: PROCftracef("PROClj_p3")
  SYS"Wimp_CloseWindow",,xbuff%
ENDPROC

DEF PROClj_p6
  LOCAL wind%
  REM mouseclick on the configure window
  VDU: PROCftracef("PROClj_p6")
  CASE xbuff%!8 OF
    WHEN 2: REM menu
      CASE xbuff%!16 OF
        WHEN 20: PROClj_menu("ME1", -1 , -1 )
        WHEN 18: PROClj_menu("ME2", -1 , -1 )
        WHEN  4: PROClj_menu("ME3", -1 , -1 )
        WHEN 14: PROClj_menu("ME4", -1 , -1 )
        WHEN 23: PROClj_menu("ME5", -1 , -1 )
        WHEN 26: PROClj_menu("MP1", -1 , -1 )
      ENDCASE
    WHEN 4: REM select
      CASE xbuff%!16 OF
        WHEN 24
          wind%=xbuff%!12
          PROClj_save_configuration(wind%)
          !xbuff%=wind%
          SYS"Wimp_CloseWindow",,xbuff%
        WHEN 20: PROClj_menu("ME1", -1 , -1 )
        WHEN 18: PROClj_menu("ME2", -1 , -1 )
        WHEN  4: PROClj_menu("ME3", -1 , -1 )
        WHEN 14: PROClj_menu("ME4", -1 , -1 )
        WHEN 23: PROClj_menu("ME5", -1 , -1 )
        WHEN 26: PROClj_menu("MP1", -1 , -1 )
        WHEN 30
          !xbuff%=xbuff%!12
          SYS"Wimp_CloseWindow",,xbuff%
      ENDCASE
    WHEN 1: REM adjust
      IF xbuff%!16=24 THEN
        wind%=xbuff%!12
        PROClj_save_configuration(wind%)
      ENDIF
  ENDCASE
ENDPROC

DEF PROClj_p8
  REM a key press!
  LOCAL lj_i%
  VDU: PROCftracef("PROClj_p8")
  lj_i%=psup%! 20 
  WHILE lj_i%
    IF lj_i%! 4 =!xbuff% THEN
      IF xbuff%!24=13 THEN
        CASE $(lj_i%+ 16 )OF
          WHEN "configure"
            SYS "Wimp_CloseWindow",,xbuff%
            PROClj_save_configuration(!xbuff%)
        ENDCASE
      ELSE
        SYS "Wimp_ProcessKey",xbuff%!24
      ENDIF

      ENDPROC
    ENDIF

    lj_i%=lj_i%! 0 
  ENDWHILE
ENDPROC

DEF PROClj_p9
  LOCAL adjust%,wind%,icon%,ptr%,xres%,yres%
 






  VDU: PROCftracef("PROClj_p9")
  wind%=FNprinter_find_window(prnt%,"configure")
  adjust%=FNwas_adjust_used
  CASE lj_menu_chsn$ OF
    WHEN "ME1": icon%=3
    WHEN "ME2": icon%=17
    WHEN "ME3": icon%=15
    WHEN "ME4": icon%=13
    WHEN "ME5": icon%=22
    WHEN "MP1": icon%=25
  ENDCASE
  ptr%=lj_menu%+28+!xbuff%*24
  IF ptr%!8 AND &100 THEN
    PROCicon_write(wind%,icon%,$ptr%!12)
  ELSE
    PROCicon_write(wind%,icon%,$(ptr%+12))
  ENDIF
  IF lj_menu_chsn$="ME1" THEN
    REM if the resolution changes, we may have to change the quality as well
    lj_j%=prdt%!20
    lj_s$=FNicon_read(wind%,3)
    WHILE lj_j%
      lj_k%=!lj_j%! 8 
      IF (lj_s$=FNmsg_2(psup%! 16 ,"RES",STR$ !lj_k%!20,STR$ !lj_k%!24)) OR          (lj_s$=$(lj_k%!36)) THEN

 




        lj_s$=FNicon_read(wind%,15): lj_i%=INSTR(lj_s$,",")
        CASE LEFT$(lj_s$,lj_i%-1)OF
          WHEN FNmsg_0(psup%! 16 ,"CO1"):  lj_j%=1
          WHEN FNmsg_0(psup%! 16 ,"CO1s"): lj_j%=1
          WHEN FNmsg_0(psup%! 16 ,"CO2"):  lj_j%=2
          WHEN FNmsg_0(psup%! 16 ,"CO4"):  lj_j%=4
          WHEN FNmsg_0(psup%! 16 ,"CO5"):  lj_j%=5
          WHEN FNmsg_0(psup%! 16 ,"CO5s"): lj_j%=5
          OTHERWISE:                                 lj_j%=0
        ENDCASE
        lj_s$=MID$(lj_s$,lj_i%+2)
        CASE lj_s$ OF
          WHEN FNmsg_0(psup%! 16 ,"HT8"):  lj_i%=8
          WHEN FNmsg_0(psup%! 16 ,"HT8s"): lj_i%=8
          WHEN FNmsg_0(psup%! 16 ,"HT1"):  lj_i%=1
          WHEN FNmsg_0(psup%! 16 ,"HT1s"): lj_i%=1
          OTHERWISE:                                 lj_i%=4
        ENDCASE
        lj_k%=FNlj_get_quality_options(lj_k%)
        IF(lj_k% AND (7<<(lj_j%*4)))=0 lj_j%=-1
        IF lj_j%<>-1 THEN
          lj_j%=lj_k%>>lj_j%*4
          CASE lj_i% OF
            WHEN 4: IF(lj_j% AND 1)=0 lj_i%=-1
            WHEN 8: IF(lj_j% AND 2)=0 lj_i%=-1
            WHEN 1: IF(lj_j% AND 4)=0 lj_i%=-1
          ENDCASE
        ENDIF
        IF lj_j%=-1 OR lj_i%=-1 THEN
          PROClj_decode_options(lj_k%,lj_j%,lj_i%)
          PROCicon_write(wind%,15,FNlj_qual_name(lj_j% + (lj_i% << 8)))
        ENDIF
        lj_j%=0
      ELSE
        lj_j%=!lj_j%
      ENDIF
    ENDWHILE
  ENDIF
  IF adjust% THEN
    SYS"Wimp_GetPointerInfo",,xbuff%
    PROClj_menu(lj_menu_chsn$, 0 , 0 )
  ENDIF
ENDPROC

DEF PROClj_p17
  LOCAL wind%,lj_s$,lj_t$
  VDU: PROCftracef("PROClj_p17")
  CASE xbuff%!16 OF
    WHEN &502
      wind%=psup%! 20 
      WHILE wind%
        IF wind%! 4 =xbuff%!32 THEN
          CASE $(wind%+ 16 ) OF
            WHEN "configure"
              lj_s$=STR$ xbuff%!36
              CASE xbuff%!36 OF
                WHEN 8,11,12
                  IF FNicon_set(xbuff%!32,xbuff%!36)lj_s$+="b" ELSE lj_s$+="a"
              ENDCASE
              lj_t$=FNmsg_0(psup%! 16 ,"CON"+lj_s$)
              IF lj_t$="CON"+lj_s$ lj_t$=FNmsg_0(psup%! 16 ,"CON")
              PROCinteractive_help(lj_t$)
          ENDCASE
          wind%=0
        ELSE
          wind%=wind%! 0 
          IF wind%=0 PROCinteractive_help(FNmsg_0(psup%! 16 ,"H"+lj_menu_chsn$))
        ENDIF
      ENDWHILE
  ENDCASE
ENDPROC

DEF PROClj_save_configuration(window%)
  LOCAL lj_i%,lj_j%,lj_k%,lj_s$,B%,C%
  VDU: PROCftracef("PROClj_save_configuration_window")
  prdt%=FNprinter_find_prdata_entry(psup%,FNicon_read(window%,6))
  PROCfree_structure(prnt%! 40 )
  $buff%=FNicon_read(window%,27)
  B%=buff%
  C%=2
  prnt%! 40 =USR(code_entry%+ 28 )
  lj_i%=cnfg%
  FOR lj_j%=1 TO  16 /4
    PROCfree_structure(!lj_i%)
    !lj_i%=0
    lj_i%+=4
  NEXT
  lj_j%=0
  IF FNicon_read(window%,17)=FNmsg_0(psup%! 16 ,"PF1")lj_j%+=1
  IF FNicon_set(window%,8)lj_j%+=2
  IF FNicon_set(window%,11)lj_j%+=4
  IF FNicon_read(window%,13)=FNmsg_0(psup%! 16 ,"PO1")lj_j%+=8
  CASE FNicon_read(window%,22)OF
    WHEN FNmsg_0(psup%! 16 ,"CC1"): lj_j%+=1<<8
    WHEN FNmsg_0(psup%! 16 ,"CC2"): lj_j%+=1<<9
  ENDCASE
  cnfg%! 0 =FNstore_integer(lj_j%)
  REM portrait mode is no-highlights entry
  REM landscape mode is drafts entry
  IF lj_j% AND 8 THEN
    lj_j%=FNprinter_read_list_integer_entry(prdt%,5,2,1)
  ELSE
    lj_j%=FNprinter_read_list_integer_entry(prdt%,5,1,1)
  ENDIF
  IF lj_j% THEN
    B%= &52544F50 
    C%=4
    cnfg%! 4 =USR(code_entry%+ 12 )
    IF cnfg%! 4 =0 ERROR  253 , FNmsg_0(FNlj_host_desc,"FA5")
    !cnfg%! 4 =lj_j%
    prnt%! 24 =prnt%! 24  AND NOT(1<<6)
  ELSE
    prnt%! 24 =prnt%! 24  OR 1<<6
  ENDIF
  REM point to the resolution possibilities
  lj_j%=prdt%!20: REM printer name is 8, short name is 12, sprite name is 16, resolution is 20
  lj_s$=FNicon_read(window%,3)
  WHILE lj_j%
    lj_k%=!lj_j%! 8 : REM get the pointer
    REM module is 8, palette is 12, options is 16, pxres is 20, pyres is 24
    IF (lj_s$=FNmsg_2(psup%! 16 ,"RES",STR$ !lj_k%!20,STR$ !lj_k%!24)) OR        (lj_s$=$(lj_k%!36)) THEN

      lj_j%=0
    ELSE
      lj_j%=!lj_j%
    ENDIF
  ENDWHILE
  B%= &52544F50 
  C%=4
  cnfg%! 8 =USR(code_entry%+ 12 )
  IF cnfg%! 8 =0 ERROR  253 , FNmsg_0(FNlj_host_desc,"FA5")
  !cnfg%! 8 =lj_k%
  lj_s$=FNicon_read(window%,15)
  lj_i%=INSTR(lj_s$,",")
  CASE LEFT$(lj_s$,lj_i%-1)OF
    WHEN FNmsg_0(psup%! 16 ,"CO1"):  lj_j%=1
    WHEN FNmsg_0(psup%! 16 ,"CO1s"): lj_j%=1
    WHEN FNmsg_0(psup%! 16 ,"CO2"):  lj_j%=2
    WHEN FNmsg_0(psup%! 16 ,"CO4"):  lj_j%=4
    WHEN FNmsg_0(psup%! 16 ,"CO5"):  lj_j%=5
    WHEN FNmsg_0(psup%! 16 ,"CO5s"): lj_j%=5
    OTHERWISE: lj_j%=0
  ENDCASE
  lj_s$=MID$(lj_s$,lj_i%+2)
  CASE lj_s$ OF
    WHEN FNmsg_0(psup%! 16 ,"HT8"):  lj_i%=8
    WHEN FNmsg_0(psup%! 16 ,"HT8s"): lj_i%=8
    WHEN FNmsg_0(psup%! 16 ,"HT1"):  lj_i%=1
    WHEN FNmsg_0(psup%! 16 ,"HT1s"): lj_i%=1
    OTHERWISE:                                 lj_i%=4
  ENDCASE
  cnfg%! 12 =FNstore_integer((lj_i%<<8)+lj_j%)
  lj_j%=prnt%! 36 
  lj_s$=FNicon_read(window%,25)
  IF $lj_j%! 4 <>lj_s$ THEN
    lj_i%=psize_head%
    WHILE lj_i%
      IF $lj_i%! 4 =lj_s$ THEN
        prnt%! 36 =lj_i%
        lj_i%=0
      ELSE
        lj_i%=!lj_i%
      ENDIF
    ENDWHILE
  ENDIF

  IF prnt%! 20 <>-1 THEN
    REM this printer is ACTIVE!
    REM ensure that its details are correct
    PROCselect_printer(prnt%, -1 , 0 )
    REM The front end code will spot that the selected printer has
    REM changed and put everything back the way it was
    REM PROCselect_printer(0, -1 , -1 ): REM don't do this (calls into overlay). JRC 12 Feb '92
  ENDIF
ENDPROC

DEF FNlj_res(cnfg%)
  LOCAL xres%,yres%,graphics_prdt%,nm$
  VDU: PROCftracef("FNlj_res")
  graphics_prdt%=!cnfg%! 8 
  xres%=FNprinter_read_integer_entry(graphics_prdt%,4)
  yres%=FNprinter_read_integer_entry(graphics_prdt%,5)
  nm$=FNprinter_read_string_entry(graphics_prdt%,8)
  IF nm$="" THEN  nm$=FNmsg_2(psup%! 16 ,"RES",STR$ xres%,STR$ yres%)
=nm$

DEF FNlj_qual_name(lj_i%)
  LOCAL lj_s$,lj_t$
  IF LJQ$ = "S" THEN
    lj_s$=FNmsg_0(psup%! 16 ,"CO"+STR$(lj_i% AND &FF)+"s")
    lj_t$=FNmsg_0(psup%! 16 ,"HT"+STR$((lj_i% AND &FF00)>>8)+"s")
  ELSE
    lj_s$=FNmsg_0(psup%! 16 ,"CO"+STR$(lj_i% AND &FF))
    lj_t$=FNmsg_0(psup%! 16 ,"HT"+STR$((lj_i% AND &FF00)>>8))
  ENDIF
=lj_s$+", "+lj_t$

DEF FNlj_qual(cnfg%)
  LOCAL lj_i%
  VDU: PROCftracef("FNlj_qual")
  lj_i%=!cnfg%! 12 
=FNlj_qual_name(lj_i%)

DEF FNlj_get_quality_options(graphics_definition%)
LOCAL s%,c%,t%
s%=FNprinter_read_integer_entry(graphics_definition%,3)
REM if colour small halftone present, add colour large halftone
IF (s% AND &100) s% = s% OR &200
REM if colour available, add new colour options
IF (s% AND &700) THEN
 t%=FNprinter_read_integer_entry(graphics_definition%,1):REM ptr to module defn
 t%=FNprinter_read_integer_entry(t%,1):REM module number
 REM pass the MiscOp through to the dumper driver
 SYS"XPDriver_MiscOpForDriver",&80000002,t%,,,,,,,7 TO t%;c%:REM strip type mask
 IF(c%AND1)=0 AND t%<>&80000002 THEN
  IF (t% AND (1<<3)) THEN
   REM add strip type 3 based on the greyscale options (or colour, if no grey)
   c%=s% AND &70
   IF c%=0 THEN c%=(s% AND &700)>>4
   s%=s% OR (c%<<16)
  ENDIF
  IF (t% AND (1<<4)) THEN
   REM add strip type 4 based on the colour options
   c%=s% AND &700
   s%=s% OR (c%<<8)
  ENDIF
  IF (t% AND (1<<5)) THEN
   REM add strip type 5 based on the colour options
   c%=s% AND &700
   s%=s% OR (c%<<12)
  ENDIF
 ENDIF
ENDIF
REM If simple qualities, knock out Mono,256 colours,32k colours
IF LJQ$ = "S" s%=s% AND &700070
=s%

REM If LJQ$ = "S" then the following qualities are
REM actually deemed not to exist:
REM - Any 'Mono'; '256 colours'; '32k colours'

REM This procedure tries to find a good default quality to pick.
REM Modified on 22-Jul-93/3-Dec-93 to pick in this order:
REM Modified on 02-Aug-95 to favour error diff instead of halftone
REM * 16 million, diffused
REM * colour, diffused
REM * grey, diffused
REM * mono, diffused
REM
REM The option value is split into 3 nibbles:
REM &7xxxxx = 24bpp colour, either strip type 3 or 5 depending on
REM                        whether or not it is a full colour system
REM &x7xxxx = 16bpp colour, strip type 4
REM &xxx7xx = colour, strip type 2
REM &xxxx7x = greyscale, strip type 1
REM &xxxxx7 = monochrome, strip type 0
REM
REM Within the 3 nibbles, the following values are valid:
REM 1 = small halftone, tone type 4
REM 2 = large halftone, tone type 8
REM 4 = dithered, tone type 1
DEF PROClj_decode_options(option%,RETURN strip%,RETURN tone%)
  VDU: PROCftracef("PROClj_decode_options")
  REM try to pick colour, then grey, then mono
  IF option% AND &700000 THEN
   strip%=5
  ELSE
   IF option% AND &700 THEN
    strip%=2
   ELSE
    IF option% AND &70 THEN
     strip%=1
    ELSE
     REM force grey if "Simple" (Mono not allowed)
     IF LJQ$ = "S" THEN strip%=1 ELSE strip%=0
    ENDIF
   ENDIF
  ENDIF

  REM find out what is available now
  option%=option%>>(strip%*4)
  tone%=-1
  IF (strip%=5 AND (option% AND 4)<>0) tone%=1
  IF (strip%=2 AND (option% AND 4)<>0) tone%=1
  IF (strip%=1 AND (option% AND 4)<>0) tone%=1
  IF (strip%=0 AND (option% AND 4)<>0) tone%=1

 


  IF tone%=-1 THEN
    IF option% AND 4 THEN
      tone%=1
    ELSE
      IF option% AND 2 THEN
        tone%=8
      ELSE
        tone%=4
      ENDIF
    ENDIF
  ENDIF
ENDPROC

DEF PROClj_menu(top$,rebuild%,iconpos%)
  LOCAL wind%,lj_ix%,lj_iy%,lj_i%,lj_x%,lj_j%,lj_k%,xres%,yres%,indt%,nm$
  VDU: PROCftracef("PROClj_menu")
  IF rebuild% THEN
    lj_menu_xpos%=xbuff%!0-64
    lj_menu_ypos%=xbuff%!4
  ENDIF
  IF iconpos% THEN
    !buff%=xbuff%!12
    buff%!4=xbuff%!16
    SYS"Wimp_GetIconState",,buff%
    lj_ix%=buff%!16
    lj_iy%=buff%!20
    SYS"Wimp_GetWindowState",,buff%
    lj_menu_xpos%=buff%!20+buff%!4+lj_ix%+2
    lj_menu_ypos%=buff%!24+buff%!16+lj_iy%-2
  ENDIF
  wind%=FNprinter_find_window(prnt%,"configure")
  lj_menu_chsn$=top$
  REM because of the way the configuration window works,
  REM we have to adjust prdt% to point to the printer data
  REM record for the printer specified in the window, NOT
  REM the current printer.
  prdt%=FNprinter_find_prdata_entry(psup%,FNicon_read(wind%,6))
  CASE top$ OF
    WHEN "ME1"
      PROCmenu_create(lj_menu%,FNmsg_0(psup%! 16 ,"ME1"))
      indt%=(lj_menu%!28 AND &100)<>0
      REM get the resolution strings for this printer
      lj_j%=prdt%!20
      lj_i%=0
      lj_x%=0
      WHILE lj_j%
        lj_k%=!lj_j%! 8 
        xres%=FNprinter_read_integer_entry(lj_k%,4)
        yres%=FNprinter_read_integer_entry(lj_k%,5)
        nm$=FNprinter_read_string_entry(lj_k%,8)
        IF nm$<>"" THEN
          PROCmenu_item(lj_menu%,lj_i%,nm$,indt%)
        ELSE
          PROCmenu_item(lj_menu%,lj_i%,FNmsg_2(psup%! 16 ,"RES",STR$ xres%,STR$ yres%),indt%)
        ENDIF
        lj_i%+=1
        lj_j%=!lj_j%
      ENDWHILE
      PROCmenu_tick_match(lj_menu%,FNicon_read(wind%,3))
    WHEN "ME2"
      PROCmenu_create(lj_menu%,FNmsg_0(psup%! 16 ,"ME2"))
      PROCmenu_tick_match(lj_menu%,FNicon_read(wind%,17))
    WHEN "ME3"
      PROCmenu_create(lj_menu%,FNmsg_0(psup%! 16 ,"ME3"))
      REM need to find the right graphics entry for the current resolution
      lj_j%=prdt%!20: REM point to first record for this list
      WHILE lj_j%
        lj_k%=!lj_j%! 8 
        IF (FNicon_read(wind%,3)=FNmsg_2(psup%! 16 ,"RES",STR$ !lj_k%!20,STR$ !lj_k%!24)) OR            (FNicon_read(wind%,3)=$(lj_k%!36)) THEN

          REM ok - found the graphics entry, now get the options word
          lj_j%=FNlj_get_quality_options(lj_k%)
          lj_i%=0
          lj_x%=0
          IF lj_j% AND &000007 PROClj_menu_quality(lj_menu%,lj_i%,FNmsg_0(psup%! 16 ,"CO0"),lj_j%)
          IF lj_j% AND &000070 THEN
            IF LJQ$="S" THEN
              PROClj_menu_quality(lj_menu%,lj_i%,FNmsg_0(psup%! 16 ,"CO1s"),lj_j%>>4)
            ELSE
              PROClj_menu_quality(lj_menu%,lj_i%,FNmsg_0(psup%! 16 ,"CO1"),lj_j%>>4)
            ENDIF
          ENDIF
          IF lj_j% AND &000700 PROClj_menu_quality(lj_menu%,lj_i%,FNmsg_0(psup%! 16 ,"CO2"),lj_j%>>8)
          IF lj_j% AND &070000 PROClj_menu_quality(lj_menu%,lj_i%,FNmsg_0(psup%! 16 ,"CO4"),lj_j%>>16)
          IF lj_j% AND &700000 THEN
            IF LJQ$="S" THEN
              PROClj_menu_quality(lj_menu%,lj_i%,FNmsg_0(psup%! 16 ,"CO5s"),lj_j%>>20)
            ELSE
              PROClj_menu_quality(lj_menu%,lj_i%,FNmsg_0(psup%! 16 ,"CO5"),lj_j%>>20)
            ENDIF
          ENDIF
          lj_j%=0
        ELSE
          lj_j%=!lj_j%
        ENDIF
      ENDWHILE
      PROCmenu_tick_match(lj_menu%,FNicon_read(wind%,15))
    WHEN "ME4"
      IFFNprinter_read_list_integer_entry(prdt%,5,2,1)<>0 THEN
        PROCmenu_create(lj_menu%,FNmsg_0(psup%! 16 ,"ME4a"))
      ELSE
        PROCmenu_create(lj_menu%,FNmsg_0(psup%! 16 ,"ME4b"))
      ENDIF
      PROCmenu_tick_match(lj_menu%,FNicon_read(wind%,13))
    WHEN "ME5"
      PROCmenu_create(lj_menu%,FNmsg_0(psup%! 16 ,"ME5"))
      PROCmenu_tick_match(lj_menu%,FNicon_read(wind%,22))
    WHEN "MP1"
      PROCcreate_paper_menu(lj_menu%,wind%,25)
  ENDCASE
  PROCdisplay_menu(prnt%,lj_menu%,lj_menu_xpos%,lj_menu_ypos%)
ENDPROC

DEF PROClj_menu_quality(RETURN lj_menu%,RETURN lj_i%,strip$,tone%)
  LOCAL indt%
  VDU: PROCftracef("PROClj_menu")
  indt%=(lj_menu%!28 AND &100)<>0
  IF tone% AND 1 THEN
    IF LJQ$="S" THEN
      PROCmenu_item(lj_menu%,lj_i%,strip$+", "+FNmsg_0(psup%! 16 ,"HT4s"),indt%)
    ELSE
      PROCmenu_item(lj_menu%,lj_i%,strip$+", "+FNmsg_0(psup%! 16 ,"HT4"),indt%)
    ENDIF
    lj_i%+=1
  ENDIF
  IF tone% AND 2 THEN
    IF LJQ$="S" THEN
      PROCmenu_item(lj_menu%,lj_i%,strip$+", "+FNmsg_0(psup%! 16 ,"HT8s"),indt%)
    ELSE
      PROCmenu_item(lj_menu%,lj_i%,strip$+", "+FNmsg_0(psup%! 16 ,"HT8"),indt%)
    ENDIF
    lj_i%+=1
  ENDIF
  IF tone% AND 4 THEN
    IF LJQ$="S" THEN
      PROCmenu_item(lj_menu%,lj_i%,strip$+", "+FNmsg_0(psup%! 16 ,"HT1s"),indt%)
    ELSE
      PROCmenu_item(lj_menu%,lj_i%,strip$+", "+FNmsg_0(psup%! 16 ,"HT1"),indt%)
    ENDIF
    lj_i%+=1
  ENDIF
ENDPROC

DEF FNlj_hex2(v%)
  VDU: PROCftracef("PROClj_hex2")
=RIGHT$("00"+STR$~v%,2)

REM text printing code

DEF PROClj_m8
  LOCAL lj_r%,queu%,tpub%,tprv%,text_prdt%
  VDU: PROCftracef("PROClj_m8")
  text_prdt%=!cnfg%! 4 
  lj_r%=!xbuff%
  queu%=xbuff%!4
  tpub%=queu%! 44 
  tprv%=queu%! 48 
  CASE lj_r% OF
    WHEN  -1: PROClj_1
    WHEN  -2: PROClj_2
    WHEN  -4: PROClj_4
    WHEN  -6: PROClj_6
    WHEN  -7: PROClj_7
    WHEN  -9: PROClj_9
    WHEN -10: PROClj_10
    WHEN -11: PROClj_11
    WHEN -12: PROClj_12
    WHEN -13: PROClj_13
    WHEN -15: PROClj_15
    WHEN -16: PROClj_16
    WHEN -17: PROClj_17
    WHEN -18: PROClj_18
    WHEN -19: PROClj_19
  ENDCASE
ENDPROC

DEF PROClj_1
 
  LOCAL lj_i%,lj_i$,lj_j%,B%,C%
  VDU: PROCftracef("PROClj_1")
  B%= &56525054 
  C%= 36 
  tprv%=USR(code_entry%+ 12 )
  IF tprv%=0 ERROR  253 , FNmsg_0(FNlj_host_desc,"FA5")
  queu%! 48 =tprv%
  FOR lj_i%=0 TO  36 -4
    tprv%!lj_i%=0
  NEXT
  lj_j%=!cnfg%! 0 
  tpub%! 44 =(lj_j% AND &FF00)>>8
  IF lj_j% AND 4 THEN
    tpub%! 48 = -1 
    tprv%! 8 =6
  ELSE
    tprv%! 8 =0
  ENDIF
  IF lj_j% AND 2 tpub%! 52 = -1 
  lj_i$=FNprinter_read_string_entry(text_prdt%,6)
  B%=A%! 16 
  $B%=lj_i$
  C%=5
  D%=LEN lj_i$
  tpub%! 108 =USR(code_entry%+ 28 )
  REM set the pointer to the char translation list
  lj_j%=FNprinter_read_integer_entry(prdt%,6): REM point to the PRDT block
  IF lj_j% lj_j%=lj_j%! 8 
  queu%! 64 =lj_j%
ENDPROC

DEF PROClj_2
  REM output job start strings
  LOCAL format_print%,lj_pl%,lj_pr%,lj_pb%,lj_pt%,lj_ph%,psze%,lj_yt%
  LOCAL lj_i%, lj_j%, lj_s$, lj_t$
  VDU: PROCftracef("PROClj_2")
  REM first reset the printer
  BPUT#xbuff%!8,CHR$ 27+"E";
  REM set paper feed ...
  IF !cnfg%! 0  AND 1 THEN
    lj_s$=FNmsg_0(psup%! 16 ,"MANUAL_FEED")
  ELSE
    lj_s$=FNmsg_0(psup%! 16 ,"AUTO_FEED")
  ENDIF
  IF lj_s$<>"" THEN
    SYS "OS_GSTrans",lj_s$,buff%,256 TO ,,lj_j%
    lj_i%=0
    WHILE lj_j%: BPUT#xbuff%!8,buff%?lj_i%: lj_i%+=1: lj_j%-=1: ENDWHILE
  ENDIF
  REM set paper size ...
  lj_i%=prnt%! 36 
  lj_s$=$lj_i%! 4 
  lj_j%=0
  WHILE MID$(lj_s$,lj_j%,1)<>" " AND lj_j%<=LEN lj_s$
    lj_j%+=1
  ENDWHILE
  lj_t$="PT_"+LEFT$(lj_s$,lj_j%-1)
  lj_s$=FNmsg_0(psup%! 16 ,lj_t$)
  IF lj_s$=lj_t$ lj_s$=FNmsg_0(psup%! 16 ,"PT_A4")
  IF lj_s$<>"" THEN
    SYS "OS_GSTrans",lj_s$,buff%,256 TO ,,lj_j%
    lj_i%=0
    WHILE lj_j%: BPUT#xbuff%!8,buff%?lj_i%: lj_i%+=1: lj_j%-=1: ENDWHILE
  ENDIF
  format_print%=(!cnfg%! 0  AND 8)>>3
  psze%=prnt%! 36 
  lj_pl%=psze%! 24 
  lj_pr%=psze%! 28 
  lj_pb%=psze%! 16 
  lj_pt%=psze%! 20 
  lj_ph%=psze%! 12 
  IF format_print%=0 THEN
    REM portrait
    lj_yt%=0
    WHILE lj_yt%*12000<lj_ph%-lj_pt%
      lj_yt%+=1
    ENDWHILE
    lj_pt%=lj_ph%-lj_yt%*12000: REM 72000 DIV 6
    lj_yt%+=psze%! 36 
    tpub%! 100 =(lj_pr%-lj_pl%)*10 DIV 72000
    tprv%! 16 =(lj_pt%-lj_pb%)*6 DIV 72000
  ELSE
    lj_yt%=0
    WHILE lj_yt%*9000<lj_pl%
      lj_yt%+=1
    ENDWHILE
    lj_pl%=lj_yt%*9000: REM 72000 DIV 8
    lj_yt%+=psze%! 36 
    tpub%! 100 =((lj_pt%-lj_pb%)*16.66 DIV 72000 -1) DIV 2
    tprv%! 16 =(lj_pr%-lj_pl%)*8 DIV 72000
  ENDIF
  tprv%! 28 =psze%! 44 
  tpub%! 100 -=tprv%! 28 
  tprv%! 16 -=psze%! 36 +psze%! 32 
  lj_s$=FNprinter_read_string_entry(text_prdt%,7)
  IFlj_s$<>"" BPUT#xbuff%!8,lj_s$;
  REM finally, set the number of lines per page
  BPUT#xbuff%!8,CHR$ 27+"&l"+STR$(tprv%! 16 +lj_yt%)+"F";
  tprv%! 12 =tpub%! 100 
  tprv%! 24 =psze%! 40 
  tprv%! 32 =0
  tprv%! 20 =lj_yt%
  tpub%! 76 =tprv%! 16 
  tprv%! 4 =tprv%! 24 
  IF tpub%! 48  tprv%! 4 +=6
ENDPROC

DEF PROClj_4
  REM no data to output
  VDU: PROCftracef("PROClj_4")
  xbuff%?8=0
ENDPROC

DEF PROClj_6
  REM do control code processing
  LOCAL lj_b$
  VDU: PROCftracef("PROClj_6")
  lj_b$=FNlj_display(xbuff%!8)
  xbuff%?8=LEN lj_b$
  $(xbuff%+9)=lj_b$
ENDPROC

DEF PROClj_7
  REM process a backspace
  LOCAL lj_b$
  VDU: PROCftracef("PROClj_7")
  lj_b$=FNprinter_read_string_entry(text_prdt%,2)
  xbuff%?8=LEN(lj_b$)
  $(xbuff%+9)=lj_b$
ENDPROC

DEF PROClj_9
  LOCAL changed_bits%,clr_bits%,set_bits%,bit%,lj_b$
  VDU: PROCftracef("PROClj_9")
  changed_bits%=tpub%! 96  EOR xbuff%!8
  clr_bits%=tpub%! 96  AND changed_bits%
  set_bits%=changed_bits% AND NOTclr_bits%
  IF clr_bits% OR set_bits% THEN
    FOR bit%=0 TO 5
      IF clr_bits% AND 1<<bit% lj_b$+=FNlj_style_off(bit%)
      IF set_bits% AND 1<<bit% lj_b$+=FNlj_style_on(bit%)
    NEXT
  ENDIF
  xbuff%?8=LEN lj_b$
  $(xbuff%+9)=lj_b$
ENDPROC

DEF PROClj_10
  REM end the previous line and start a new line
  LOCAL lj_b$,wrap%,line_num$,lj_bit%
  VDU: PROCftracef("PROClj_10")
  tpub%! 80 +=1
  tpub%! 72 +=1
  FOR lj_bit%=0 TO 5
    IF tpub%! 96  AND 1<<lj_bit% lj_b$+=FNlj_style_off(lj_bit%)
  NEXT
  REM lj_b$+=FNprinter_read_string_entry(text_prdt%,6)
  lj_b$+=CHR$ 27+"&a"
  lj_b$+=STR$(tprv%! 24 +tprv%! 32 +tprv%! 0 *(tprv%! 12 +1))+"C"
  wrap%=(tpub%! 56 >=tpub%! 100 )
  IF tpub%! 48  THEN
    REM print line number unless wrapped line
    lj_b$+=FNlj_font(0)
    IF wrap% THEN
      tpub%! 72 -=1
      lj_b$+=STRING$(6," ")
    ELSE
      line_num$=STR$ tpub%! 72 
      lj_b$+=STRING$(5-LEN line_num$," ")+line_num$+" "
    ENDIF
    lj_b$+=FNlj_font(tpub%! 64 )
    tpub%! 56 =6
  ELSE
    tpub%! 56 =0
  ENDIF
  IF wrap% THEN
    tpub%! 56 +=1
    lj_b$+=FNlj_style_on(0)+"|"+FNlj_style_off(0)
  ENDIF
  FOR lj_bit%=0 TO 5
    IF tpub%! 96  AND 1<<lj_bit% lj_b$+=FNlj_style_on(lj_bit%)
  NEXT
  tpub%! 56 +=tprv%! 24 +tprv%! 32 
  xbuff%?8=LEN lj_b$
  $(xbuff%+9)=lj_b$
ENDPROC

DEF PROClj_11
  REM print a footnote number
  LOCAL lj_b$,lj_i%
  VDU: PROCftracef("PROClj_11")
  PROClj_10: lj_b$=FNprinter_read_string(tpub%! 108 )+$(xbuff%+9)
  PROClj_10: lj_b$+=FNprinter_read_string(tpub%! 108 )+$(xbuff%+9)
  lj_b$+=FNlj_style_on(4): REM superscript
  lj_b$+=FNlj_trans(RIGHT$("  "+STR$ tpub%! 60 ,3)+STRING$(3,FNprinter_read_string_entry(text_prdt%,2)))
  lj_b$+=FNlj_style_off(4)
  xbuff%?8=LEN lj_b$
  $(xbuff%+9)=lj_b$
ENDPROC

DEF PROClj_12
  REM do bulk string translation
  LOCAL lj_b$
  VDU: PROCftracef("PROClj_12")
  lj_b$=FNlj_trans($(xbuff%+8))
  xbuff%?8=LEN lj_b$
  $(xbuff%+9)=lj_b$
ENDPROC

DEF PROClj_13
  REM do font change
  LOCAL lj_b$,lj_i%
  VDU: PROCftracef("PROClj_13")
  tpub%! 64 =xbuff%!8
  lj_i%=tprv%! 4 
  lj_i%+=INT((tprv%! 12 -tprv%! 4 -tprv%! 28 )*FNlj_fontsize(xbuff%!8)/FNlj_fontsize(0))
  tpub%! 100 =lj_i%
  IF tpub%! 68 <tpub%! 100 -tprv%! 4  THEN
    tprv%! 32 =tpub%! 68 
  ELSE
    tprv%! 32 =0
  ENDIF
  IF tpub%! 88 <tpub%! 100 -tprv%! 4  AND tpub%! 88 >tprv%! 32  THEN
    tpub%! 100 =tprv%! 4 +tpub%! 88 
  ENDIF
  lj_b$=FNlj_font(xbuff%!8)
  xbuff%?8=LEN lj_b$
  $(xbuff%+9)=lj_b$
ENDPROC

DEF PROClj_15
  REM end of job
  LOCAL text_prdt%,tpub%,lj_s$
  VDU: PROCftracef("PROClj_15")
  IF queu%! 36 <>&FF4 THEN
    text_prdt%=!cnfg%! 4 
    tpub%=queu%! 44 
    REM finish off the text printing
    lj_s$=FNprinter_read_string_entry(text_prdt%,8)
    IF lj_s$<>"" BPUT#xbuff%!8,lj_s$;
  ENDIF
ENDPROC

DEF PROClj_16
  REM process a tab
  LOCAL lj_b$
  VDU: PROCftracef("PROClj_16")
  lj_b$=CHR$ 27+"&a+"
  lj_b$+=STR$(8-((tpub%! 56 -tprv%! 24 -tprv%! 32 +1-tprv%! 8 )MOD 8))+"C"
  tpub%! 100 +=8-((tpub%! 56 -tprv%! 24 -tprv%! 32 +1-tprv%! 8 )MOD 8)
  xbuff%?8=LEN lj_b$
  $(xbuff%+9)=lj_b$
ENDPROC

DEF PROClj_17
  REM do a formfeed
  VDU: PROCftracef("PROClj_17")
  xbuff%?8=0
ENDPROC

DEF PROClj_18
  REM change layout
  LOCAL layout_height%,layout_top%,layout_bottom%
  VDU: PROCftracef("PROClj_18")
  layout_height%=xbuff%!8
  layout_top%=xbuff%!12
  layout_bottom%=xbuff%!16
  IF layout_height%-layout_top%-layout_bottom%>3 AND layout_height%<=tprv%! 16  THEN
    tpub%! 76 =layout_height%-layout_top%-layout_bottom%
    tprv%! 20 =layout_top%
  ENDIF
  xbuff%?8=0
ENDPROC

DEF PROClj_19
  REM start a new page
  LOCAL lj_b$,lj_bit%,lj_p%,lj_t$
  VDU: PROCftracef("PROClj_19")
  tpub%! 80 =0
  tpub%! 84 +=1
  IF((!cnfg%! 0  AND 8)>>3)=0 OR (tpub%! 84  MOD 2)<>0 THEN
    tprv%! 0 =0
  ELSE
    tprv%! 0 =1
  ENDIF
  IF tpub%! 84 >1 THEN
    REM turn off the highlights from the previous page
    FOR lj_bit%=0 TO 5
      IF tpub%! 96  AND 1<<lj_bit% lj_b$+=FNlj_style_off(lj_bit%)
    NEXT
  ENDIF
  REM physical formfeed only if not staying on same piece of paper
  IF tprv%! 0 =0 AND tpub%! 84 >1 THEN
    lj_b$+=FNprinter_read_string_entry(text_prdt%,4)
  ENDIF
  lj_b$+=CHR$ 27+"&a"+STR$ tprv%! 20 +"R"
  IF tpub%! 52  THEN
    lj_p%=tpub%! 84 
    IF(!cnfg%! 0  AND 8)>>3 THEN
      REM if landscape mode, we fit two pages per physical page
      lj_p%=(lj_p%+1)DIV 2
    ENDIF
    tpub%! 80 +=2
    IF tprv%! 0 =0 THEN
      lj_b$+=CHR$ 27+"&a"+STR$(tprv%! 24 +tprv%! 32 )+"C"+CHR$ 14
      lj_t$=FNprinter_read_string(tpub%! 112 )+"   "+FNprinter_read_string(tpub%! 120 )
      lj_t$+="   "+FNmsg_1(psup%! 16 ,"PAG",STR$ lj_p%)
      lj_b$+=FNlj_trans(lj_t$)+CHR$ 15
    ENDIF
    lj_b$+=FNprinter_read_string_entry(text_prdt%,6)+FNprinter_read_string_entry(text_prdt%,6)
  ENDIF
  xbuff%?8=LEN lj_b$
  $(xbuff%+9)=lj_b$
ENDPROC

DEF FNlj_trans(lj_s$)
  LOCAL lj_i%,byte%,out$,str$
  VDU: PROCftracef("FNlj_trans")
  IF lj_s$="" THEN =""
  FOR lj_i%=1 TO LEN lj_s$
    byte%=ASC MID$(lj_s$,lj_i%,1): str$=""
    CASE  -1  OF
      WHEN byte%<32 OR byte%=127
        IF tpub%! 44 =1 str$=FNlj_display(byte%)
      WHEN byte%>127 AND tpub%! 44 <>0
        IF tpub%! 44 =1 str$=FNlj_display(byte%)
      WHEN tpub%! 44 <>0
        str$=CHR$ byte%
      OTHERWISE
        str$=FNlj_text_char(byte%)
        IF str$="" str$=CHR$ byte%
    ENDCASE
    out$+=str$
  NEXT
=out$

DEF FNlj_text_char(byte%)
  LOCAL lj_p%,lj_s$,lj_i%
  VDU: PROCftracef("FNlj_text_char")
  lj_p%=queu%! 64 
  WHILE lj_p%
    CASE  -1  OF
      WHEN lj_p%?4=byte%
        lj_i%=lj_p%?5
        lj_p%=lj_p%+6
        WHILE lj_i%
          lj_s$+=CHR$ ?lj_p%
          lj_p%+=1
          lj_i%-=1
        ENDWHILE
        =lj_s$
      WHEN lj_p%?4>byte%
        lj_p%=0
      OTHERWISE
        lj_p%=!lj_p%
    ENDCASE
  ENDWHILE
=""

DEF FNlj_display(byte%)
  VDU: PROCftracef("FNlj_display")
="["+RIGHT$("0"+STR$~byte%,2)+"]"

DEF FNlj_style_on(bit%)
  VDU: PROCftracef("FNlj_style_on")
  CASE bit% OF
    WHEN 0: =FNprinter_read_string_entry(text_prdt%,13): REM bold on
    WHEN 1: =FNprinter_read_string_entry(text_prdt%,17): REM light on
    WHEN 2: =FNprinter_read_string_entry(text_prdt%,15): REM italic on
    WHEN 3: =FNprinter_read_string_entry(text_prdt%,23): REM underline on
    WHEN 4: =FNprinter_read_string_entry(text_prdt%,19): REM superscript on
    WHEN 5: =FNprinter_read_string_entry(text_prdt%,21): REM subscript on
  ENDCASE
=""

DEF FNlj_style_off(bit%)
  VDU: PROCftracef("FNlj_style_off")
  CASE bit% OF
    WHEN 0: =FNprinter_read_string_entry(text_prdt%,14): REM bold off
    WHEN 1: =FNprinter_read_string_entry(text_prdt%,18): REM light off
    WHEN 2: =FNprinter_read_string_entry(text_prdt%,16): REM italic off
    WHEN 3: =FNprinter_read_string_entry(text_prdt%,24): REM underline off
    WHEN 4: =FNprinter_read_string_entry(text_prdt%,20): REM superscript off
    WHEN 5: =FNprinter_read_string_entry(text_prdt%,22): REM subscript off
  ENDCASE
=""

DEF FNlj_font(font%)
  VDU: PROCftracef("FNlj_font")
  CASE font% OF
    WHEN 0: =FNprinter_read_string_entry(text_prdt%,9): REM pica
    WHEN 1: =FNprinter_read_string_entry(text_prdt%,10): REM elite
    WHEN 2: =FNprinter_read_string_entry(text_prdt%,11): REM condensed
    WHEN 3: =FNprinter_read_string_entry(text_prdt%,12): REM expanded
  ENDCASE
  VDU: PROCftracef("FNlj_font done")
=""

DEF FNlj_fontsize(num%)
  REM provide notional cpi sizes
  VDU: PROCftracef("FNlj_fontsize")
  CASE num% OF
    WHEN 0: =10: REM pica
    WHEN 1: =12: REM elite
    WHEN 2: =17: REM condensed
    WHEN 3: = 6: REM expanded
  ENDCASE
=10

DEF FNlj_host_desc
LOCAL a%
a%=buff%!24
=a%! 12 
#line 10128 "sources.RunImage"
#line 1 "sources.SupportPS"
REM > Support - for PostScript printers

 















#line 1 "h.Values"
 
























  






  





  











  





  





























































































































































































































































































































 























































 




 





 




 

























 



 
















































































































#line 20 "sources.SupportPS"
#line 1 "h.Trace"






   
   
   
   

#line 21 "sources.SupportPS"

DEF FNps_support(buff%)
  LOCAL reason%,psup%,prnt%,prdt%,cnfg%,xbuff%,psize_head%,code_entry%
  REM On entry, A%=interface pointer. This must be preserved.
  reason%=buff%!0
  psup%=buff%!4
  prnt%=buff%!8
  xbuff%=buff%!12
  psize_head%=buff%!16
  code_entry%=buff%!20
  IF prnt% THEN
    prdt%=FNprinter_find_prdata_entry(psup%,$prnt%! 8 )
    cnfg%=prnt%! 16 
  ENDIF
  CASE reason% OF
  WHEN -1: PROCps_m1
  WHEN -3: PROCps_m3
  WHEN -4: PROCps_m4
  WHEN -5: PROCps_m5
  WHEN -6: PROCps_m6
  WHEN -7: PROCps_m7
  WHEN -8: PROCps_m8
  WHEN -9: PROCps_m9
  WHEN-10: PROCps_m10
  WHEN 3: PROCps_p3
  WHEN 6: PROCps_p6
  WHEN 8: PROCps_p8
  WHEN 9: PROCps_p9
  WHEN 17,18: PROCps_p17
  ENDCASE
= 0 

DEF PROCps_m1
  VDU: PROCftracef("PROCps_m1")
  VDU: psup%! 24 =psup%! 24  OR 200<<8 OR %11000
  psup%! 24  = psup%! 24  OR (1<<5):REM need to be able to write
  psup%! 28 =&FF5
  psup%! 32 =%1011
  psup%! 36 = 12 /4
  psup%! 40 =1
  REM note that the version number really only reflects
  REM the status of the files being read, ie only change
  REM this number if the file contents change.
  psup%! 44 =100
  buff%!0 =&80151
  buff%!4 =&80150
  buff%!8 =&8014F
  buff%!12=&8014E
  buff%!16=&8014D
  buff%!20=&8014C
  buff%!24=0
  SYS"Wimp_AddMessages",buff%
  IFFNrmload_latest_module("PDriver","Printers:Modules.PDriver")
  IFFNrmload_latest_module("PDriverPS","Printers:Modules.PDriverPS")
  IFFNrmload_latest_module("MakePSFont","Printers:Modules.MakePSFont")
ENDPROC

DEF PROCps_m3
  REM initialise the configuration window
  LOCAL config%,ps_i%
  VDU: PROCftracef("PROCps_m3")
  config%=FNprinter_find_window(prnt%,"configure")
  PROCicon_write(config%,13,FNprinter_read_string(prnt%! 40 ))
  PROCicon_write(config%,6,$prnt%! 8 )
  ps_i%=!cnfg%! 0 
  IF ps_i% AND 1 PROCicon_select(config%,8)ELSE PROCicon_deselect(config%,8)
  IF ps_i% AND 2 PROCicon_select(config%,11)ELSE PROCicon_deselect(config%,11)
  PROCicon_write(config%,18,FNmsg_0(psup%! 16 ,"PO"+STR$((ps_i% AND 4)>>2)))
  IF FNprinter_read_string_entry(prdt%, 14 )="" THEN
    REM no feed information - choose between manual or automatic
    PROCicon_write(config%,3,FNmsg_0(psup%! 16 ,"PF"+STR$((ps_i% AND 8)>>3)))
  ELSE
    IF cnfg%! 8  = 0 THEN
      REM using default settings in printer
      PROCicon_write(config%,3,FNmsg_0(psup%! 16 ,"ME1b"))
    ELSE
      PROCicon_write(config%,3,FNps_get_feed_name(FNprinter_read_string(cnfg%! 8 )))
    ENDIF
  ENDIF
  IF FNprinter_read_integer_entry(prdt%, 10 )=1 THEN
    PROCicon_unshade(config%,7)
    IF ps_i% AND 16 PROCicon_select(config%,7)ELSE PROCicon_deselect(config%,7)
  ELSE
    PROCicon_deselect(config%,7)
    PROCicon_shade(config%,7)
  ENDIF
  IF ps_i% AND 32 PROCicon_select(config%,31)ELSE PROCicon_deselect(config%,31)
  IF ps_i% AND 64 PROCicon_select(config%,32)ELSE PROCicon_deselect(config%,32)
  PROCicon_write(config%,30,STR$((ps_i% AND &FF00)>>8))
  PROCicon_write(config%,16,FNmsg_0(psup%! 16 ,"TC"+STR$((ps_i% AND &FF0000)>>16)))
  PROCicon_write(config%,23,FNmsg_0(psup%! 16 ,"CC"+STR$((ps_i% AND &FF000000)>>24)))
  ps_i%=prnt%! 36 
  PROCicon_write(config%,27,$ps_i%! 4 )
ENDPROC

DEF PROCps_m4
  REM create a CNFG block with suitable defaults
  LOCAL ps_s$,ps_i%,ps_t%,B%,C%,ps_n$
  VDU: PROCftracef("PROCps_m4")

  cnfg%! 0 =FNstore_integer(100<<8)
  $buff%=FNprinter_read_string_entry(prdt%, 2 ): B%=buff%: C%=2: prnt%! 40 =USR(code_entry%+ 28 )
  ps_s$=FNprinter_read_string_entry(prdt%, 3 )
  IF ps_s$<>"ps" $buff%=ps_s$: B%=buff%: C%=2: prnt%! 44 =USR(code_entry%+ 28 )
  REM initialise the best paper size we can find ...
  ps_i%=psize_head%
  ps_s$=FNmsg_0(psup%! 16 ,"PAP")
  WHILE ps_s$<>FNprinter_read_string(ps_i%! 4 )
   ps_i%=ps_i%! 0 
   IF ps_i%=0 ps_i%=psize_head%: ps_s$=FNprinter_read_string(ps_i%! 4 )
  ENDWHILE
  prnt%! 36 =ps_i%
  ps_i%=0
  PROCps_ensure_dir
  REPEAT
   SYS"OS_File",5,"PrinterChoices:ps.Printers."+STR$ ps_i% TO ps_t%
   IF ps_t% ps_i%+=1
  UNTIL ps_t%=0
  cnfg%! 4 =FNstore_integer(ps_i%)
  PROCps_create_default_font_file
  PROCps_ensure_fonts(prnt%, 0 )

  REM if this printer supports fast parallel, set the appropriate flag
  ps_i%=FNprinter_read_integer_entry(prdt%, 12 )
  IFps_i%<>0 prnt%! 24  = prnt%! 24  OR (1<<7)

  REM if we have some paper feeds, pick the first file as the default, otherwise
  REM we will assume automatic paper feed.
  ps_s$=FNprinter_read_string_entry(prdt%, 14 )
  IFps_s$="" THEN
    cnfg%! 8  = 0
  ELSE
    SYS"OS_GBPB",9,ps_s$,buff%,1,0,256,"*" TO ,,,ps_i%
    IFps_i%=1 THEN
      CALL Z%,buff%,ps_n$
      $buff%=ps_s$+"."+ps_n$
      IFFNps_get_feed_name($buff%)<>"" THEN
        B%=buff%:C%=2:cnfg%! 8 =USR(code_entry%+ 28 )
      ELSE
        cnfg%! 8  = 0
      ENDIF
    ENDIF
  ENDIF
ENDPROC

DEF PROCps_m5
  REM check to see if there are any unused font files
  LOCAL ps_i%,ps_j%
  VDU: PROCftracef("PROCps_m5")
  PROCps_ensure_dir
  REPEAT
   SYS"OS_GBPB",9,"PrinterChoices:ps.Printers"+CHR$0,buff%,1,ps_i%,128,"*" TO ,,,ps_j%,ps_i%
   IF ps_j%=1 THEN
    ps_j%=buff%: WHILE ?ps_j%: ps_j%+=1: ENDWHILE: ?ps_j%=13
    ps_j%=prnt%
    WHILE ps_j%>0
     IF ps_j%! 4 =psup% THEN
      REM got a printer in our class - does the name of the font file match?
      cnfg%=ps_j%! 16 
      IF $buff%=STR$ !cnfg%! 4  THEN
       REM yes - leave it alone
       ps_j%=-1
      ELSE
       REM no - try the next printer
       ps_j%=ps_j%! 0 
      ENDIF
     ELSE
      REM not our class - try the next printer
      ps_j%=ps_j%! 0 
     ENDIF
    ENDWHILE
    IF ps_j%=0 THEN
     REM failed to match - delete the file
     VDU: PROCftracef("PROCps_m5: deleting PrinterChoices:ps.Printers."+$buff%)
     SYS"OS_File",6,"PrinterChoices:ps.Printers."+$buff%
     VDU: PROCftracef("PROCps_m5: deleted")
     REM need to reset the offset now
     ps_i%=0
    ENDIF
   ENDIF
  UNTIL ps_i%=-1
  REM now see if there are any printers that need fonts downloading
  PROCps_find_fonts_to_do(prnt%)
  VDU: PROCftracef("PROCps_m5 done")
ENDPROC

DEF PROCps_m6
  REM do whatever is necessary to prime the specified printer
  REM 0 is the magic number for the PostScript driver
  LOCAL ps_i%,ps_s$,ps_f$,ps_t$,cnct%,ptr%,ps_extra$
  LOCAL pxres%,pyres%,pxres_halftone%,pyres_halftone%,colour%,pslevel%
  LOCAL local_margin%,local_pl%,local_pr%,local_pb%,local_pt%
  LOCAL local_psze%,local_pw%,local_ph%,local_fsize%,local_w%
  LOCAL local_h%,local_A%,local_B%,local_G%
  VDU: PROCftracef("PROCps_m6")
  SYS"PDriver_SelectDriver",0
  ps_s$=FNprinter_read_string(prnt%! 40 )
  IF ps_s$="" THEN
   ps_s$=$prnt%! 8 
   IF LEN ps_s$>20 THEN
    ps_i%=LEN ps_s$
    WHILE MID$(ps_s$,ps_i%,1)<>" " AND ps_i%>0
     ps_i%-=1
    ENDWHILE
    IF ps_i% THEN
     ps_s$=LEFT$(ps_s$,ps_i%-1)
    ELSE
     ps_s$=LEFT$(ps_s$,20)
    ENDIF
   ENDIF
  ENDIF
  pxres%=FNprinter_read_integer_entry(prdt%, 4 )
  pyres%=FNprinter_read_integer_entry(prdt%, 5 )
  pxres_halftone%=FNprinter_read_integer_entry(prdt%, 6 )
  pyres_halftone%=FNprinter_read_integer_entry(prdt%, 7 )
  pslevel%=FNprinter_read_integer_entry(prdt%, 13 )
  IF pslevel%<1 OR pslevel%>32 THEN pslevel%=1
  IF !cnfg%! 0  AND 16 colour%=&2000001 ELSE colour%=&2000000
  SYS"XPDriver_SetInfo",,pxres%,pyres%,colour%,ps_s$,pxres_halftone%,pyres_halftone%,0 TO ptr%;ps_i%
  IF ps_i% AND 1 THEN
   ps_s$="": ptr%+=4
   WHILE ?ptr%: ps_s$+=CHR$ ?ptr%: ptr%+=1: ENDWHILE
   ERROR  254 ,ps_s$
   ENDPROC
  ENDIF
  cnct%=prnt%! 12 
  CASE cnct%! 0  OF
  WHEN 1,2: ps_i%=1: REM enable control D output
  OTHERWISE: ps_i%=0: REM disable control D output
  ENDCASE
  IF !cnfg%! 0  AND 32 ps_i%+=2: REM verbose prologue
  IF !cnfg%! 0  AND 64 ps_i%+=4: REM accented chars
  ps_i%+=(pslevel%-1)*8: REM PostScript level, in bits 3-7
  SYS"PDriver_SetDriver",ps_i%
  SYS"OS_CLI","Set PDriver$PSprologue Printers:ps.PSfiles.PSprolog"
  SYS"OS_CLI","Set PDriver$PSprologue2 Printers:ps.PSfiles.Level"+     STR$(pslevel%)+"."+FNprinter_read_string_entry(prdt%, 8 )

  local_psze%=prnt%! 36 
  VDU: PROCftracef("Ptr to paper size block = &"+STR$~(local_psze%))
  ps_s$=$local_psze%! 4 
  VDU: PROCftracef("Paper size name = "+ps_s$)
  ps_i%=0
  WHILE MID$(ps_s$,ps_i%,1)<>" " AND ps_i%<=LEN ps_s$
    ps_i%+=1
  ENDWHILE
  ps_s$=LEFT$(ps_s$,ps_i%-1)

  ps_extra$=""
  SYS"OS_CLI","Unset PDriver$PSextra"
  SYS"OS_CLI","Unset PDriver$PSpaper"
  SYS"OS_CLI","Unset PDriver$PSfeed"

  SYS"OS_File",17,"Printers:ps.Paper."+FNtask_lower(ps_s$) TO ps_i%
  IFps_i%<>1 THEN
     
    ps_extra$=FNmsg_2(psup%! 16 ,"PT",ps_s$,FNtask_lower(ps_s$))
  ELSE
     
    SYS"OS_CLI","Set PDriver$PSPaper Printers:ps.Paper."+FNtask_lower(ps_s$)
  ENDIF

  IF cnfg%! 8  <> 0 THEN
     
    SYS"OS_CLI","Set PDriver$PSFeed "+FNprinter_read_string(cnfg%! 8 )
  ELSE
    REM only do auto/manual code if we do not have any feed information otherwise this
    REM means that the user wants to use the default printer setting
    IF FNprinter_read_string_entry(prdt%, 14 )="" THEN
      IF !cnfg%! 0  AND 8 THEN
       ps_f$=FNungstrans(FNprinter_read_boolean_string_entry(prdt%, 9 , -1 ))
      ELSE
       ps_f$=FNungstrans(FNprinter_read_boolean_string_entry(prdt%, 9 , 0 ))
      ENDIF
      IF ps_extra$<>"" ps_extra$=ps_f$+"|J"+ps_extra$ ELSE ps_extra$=ps_f$
    ENDIF
  ENDIF

  IF ps_extra$<>"" SYS"OS_CLI","Set PDriver$PSextra "+ps_extra$

  SYS"OS_CLI","Unset PDriver$TextChars1": REM no character translation to speak of
  local_margin%=50
  local_pl% = local_psze%! 24  DIV 100 + 1 + local_margin%
  local_pr% = local_psze%! 28  DIV 100 - local_margin%
  local_pb% = local_psze%! 16  DIV 100 + 1 + local_margin%
  local_pt% = local_psze%! 20  DIV 100 - local_margin%
  IF(!cnfg%! 0  AND 4)=0 THEN
   IF !cnfg%! 0  AND 1 local_pt%-=150
   local_pw% = local_pr%-local_pl%
   local_ph% = local_pt%-local_pb%
  ELSE
   IF !cnfg%! 0  AND 1 local_pl%+=150
   local_pw% = local_pt%-local_pb%
   local_ph% = local_pr%-local_pl%
  ENDIF

  local_fsize%=(!cnfg%! 0  AND &FF00)>>8
  VDU: PROCftracef("Local font size is "+STR$ local_fsize%)
  local_w%=0.72*local_fsize%
  local_h%=1.2*local_fsize%
  VDU: PROCftracef("=> (w, h) = ("+STR$ local_w%+", "+STR$ local_h%+")")
  local_pw%=local_pw% DIV local_w%
  local_ph%=local_ph% DIV local_h%
  IF !cnfg%! 0  AND 1 THEN
   local_G%=2
   local_A%=local_ph%+2
  ELSE
   local_G%=0
   local_A%=local_ph%
  ENDIF
  local_B%=(local_pw%+2)DIV(1+((!cnfg%! 0  AND &FF0000)>>16))-2
  ps_t$="-Ph "+STR$ local_A%+" -Pw "+STR$ local_B%+" -Mt "+STR$ local_psze%! 36 
  ps_t$+=" -Mb "+STR$ local_psze%! 32 +" -Ml "+STR$ local_psze%! 40 
  ps_t$+=" -Mr "+STR$ local_psze%! 44 +" -Th "+STR$ local_G%
  SYS"OS_CLI","Set PDriver$TextPage "+ps_t$
  PROCps_add_fonts( 0 )
  VDU: PROCftracef("PROCps_m6 done")
ENDPROC

DEF PROCps_m7
  LOCAL queu%,ps_p%,ps_i%,B%,C%
  VDU: PROCftracef("PROCps_m7")
  queu%=!xbuff%
 
  ps_p%=queu%! 48 
  IF ps_p% THEN
   REM free the two strings we hold
   PROCfree_structure(ps_p%! 0 )
   PROCfree_structure(ps_p%! 32 )
   B%= &56525054 : C%=ps_p%: CALL code_entry%+ 16 
   queu%! 48 =0
  ENDIF
  REM now free the character translation list
  ps_p%=queu%! 64 
  WHILE ps_p%
   ps_i%=!ps_p%
   B%= &52414843 : C%=ps_p%: CALL code_entry%+ 16 
   ps_p%=ps_i%
  ENDWHILE
  queu%! 64 =0
ENDPROC

DEF PROCps_m9
  REM printer being removed
  REM delete the printer font file
  SYS"XOS_File",6,"PrinterChoices:ps.Printers."+STR$(!cnfg%! 4 )
  REM then check the download window
  PROCps_m10
ENDPROC

DEF PROCps_m10
  REM printer being deactivated
  REM if the font download window is open for this printer, move on
  REM to the next one
  LOCAL ps_i%
  VDU: PROCftracef("PROCps_m9")
  ps_i%=psup%! 20 
  WHILE ps_i%
   IF $(ps_i%+ 16 )="download" THEN
    REM is the window open?
    !buff%=ps_i%! 4 : SYS"Wimp_GetWindowState",,buff%
    IF buff%!32 AND 1<<16 THEN
     REM yes - it is for this printer? If so, move to next printer
     IF ps_i%! 12 =prnt% THEN
      SYS"Wimp_CloseWindow",,buff%
      PROCps_find_fonts_to_do(prnt%! 0 )
     ENDIF
    ENDIF
    ps_i%=0
   ELSE
    ps_i%=ps_i%! 0 
   ENDIF
  ENDWHILE
ENDPROC

DEF PROCps_p3
  REM a window closing
  LOCAL ps_i%
  VDU: PROCftracef("PROCps_p3")
  SYS"Wimp_CloseWindow",,xbuff%
  ps_i%=psup%! 20 
  WHILE ps_i%
    IF ps_i%! 4 =!xbuff% THEN
      IF $(ps_i%+ 16 )="download" THEN
        REM if currently selected printer - reselect it so the mappings are good
        IF prnt%! 24  AND 2 !buff%=20: buff%!12=0: buff%!16=&80152: SYS"Wimp_SendMessage",17,buff%,0
        REM since the user has decided not to download the fonts, cancel the flag bit
        ps_i%=prnt%! 52 
        WHILE ps_i%
          ps_i%! 12 =ps_i%! 12  AND NOT(1<<31)
          ps_i%=ps_i%! 0 
        ENDWHILE
        PROCps_find_fonts_to_do(prnt%! 0 )
      ENDIF
      ps_i%=0
    ELSE
      ps_i%=ps_i%! 0 
    ENDIF
  ENDWHILE
ENDPROC

DEF PROCps_p6
  REM mouseclick on the configure window
  LOCAL wind%
  VDU: PROCftracef("PROCps_p6")
  CASE xbuff%!8 OF
    WHEN 2: REM Menu
      CASE xbuff%!16 OF
        WHEN  4: PROCps_menu("ME1", -1 , -1 )
        WHEN 20: PROCps_menu("ME2", -1 , -1 )
        WHEN 19: PROCps_menu("ME3", -1 , -1 )
        WHEN 24: PROCps_menu("ME4", -1 , -1 )
        WHEN 26: PROCps_menu("MP1", -1 , -1 )
      ENDCASE
    WHEN 4: REM Select
      CASE xbuff%!16 OF
        WHEN 25
          VDU: PROCftracef("saving and closing configuration (click SELECT)")
          wind%=xbuff%!12
          PROCps_save_configuration(wind%)
          !xbuff%=wind%
          SYS"Wimp_CloseWindow",,xbuff%
        WHEN  4: PROCps_menu("ME1", -1 , -1 )
        WHEN 20: PROCps_menu("ME2", -1 , -1 )
        WHEN 19: PROCps_menu("ME3", -1 , -1 )
        WHEN 24: PROCps_menu("ME4", -1 , -1 )
        WHEN 26: PROCps_menu("MP1", -1 , -1 )
        WHEN 33
          !xbuff%=xbuff%!12
          SYS"Wimp_CloseWindow",,xbuff%
      ENDCASE
    WHEN 1: REM Adjust
      IF xbuff%!16=25 THEN
        wind%=xbuff%!12
        PROCps_save_configuration(wind%)
      ENDIF
  ENDCASE
ENDPROC

DEF PROCps_p8
  REM a key press!
  LOCAL ps_i%
  VDU: PROCftracef("PROCps_p8")
  ps_i%=psup%! 20 
  WHILE ps_i%
    IF ps_i%! 4 =!xbuff% THEN
      IF xbuff%!24=13 THEN
        CASE $(ps_i%+ 16 )OF
          WHEN "configure"
            VDU: PROCftracef("saving and closing configuration (press RETURN)")
            SYS "Wimp_CloseWindow",,xbuff%
            PROCps_save_configuration(!xbuff%)
          WHEN "download"
            SYS "Wimp_CloseWindow",,xbuff%
            PROCps_download_fonts(!xbuff%)
        ENDCASE
      ELSE
        SYS "Wimp_ProcessKey",xbuff%!24
      ENDIF

      ENDPROC
    ENDIF

    ps_i%=ps_i%! 0 
  ENDWHILE
ENDPROC

DEF PROCps_p9
  LOCAL adjust%,wind%,icon%,ptr%
 






  VDU: PROCftracef("PROCps_p9")
  wind%=FNprinter_find_window(prnt%,"configure")
  adjust%=FNwas_adjust_used
  CASE ps_menu_chsn$ OF
  WHEN "ME1": icon%=3
  WHEN "ME2": icon%=16
  WHEN "ME3": icon%=18
  WHEN "ME4": icon%=23
  WHEN "MP1": icon%=27
  ENDCASE
  ptr%=ps_menu%+28+!xbuff%*24
  IF ptr%!8 AND &100 THEN
   PROCicon_write(wind%,icon%,$ptr%!12)
  ELSE
   PROCicon_write(wind%,icon%,$(ptr%+12))
  ENDIF
  IF ps_menu_chsn$="ME3" THEN
   IF FNicon_read(wind%,18)=FNmsg_0(psup%! 16 ,"PO0")THEN
    PROCicon_write(wind%,16,FNmsg_0(psup%! 16 ,"PC"))
    PROCicon_write(wind%,30,FNmsg_0(psup%! 16 ,"PS"))
   ELSE
    PROCicon_write(wind%,16,FNmsg_0(psup%! 16 ,"LC"))
    PROCicon_write(wind%,30,FNmsg_0(psup%! 16 ,"LS"))
   ENDIF
  ENDIF
  IF adjust% THEN
   SYS"Wimp_GetPointerInfo",,xbuff%
   PROCps_menu(ps_menu_chsn$, 0 , 0 )
  ENDIF
ENDPROC

DEF PROCps_p17
  LOCAL wind%,ps_s$,ps_t$,ps_f$,size%,dest%,recv%
  VDU: PROCftracef("PROCps_p17")
  CASE xbuff%!16 OF
  WHEN &502:
    wind%=psup%! 20 
    WHILE wind%
      IF wind%! 4 =xbuff%!32 THEN
        CASE $(wind%+ 16 )OF
          WHEN "configure": ps_s$=STR$ xbuff%!36
            CASE xbuff%!36 OF
              WHEN 7,31,32,8,11: IF FNicon_set(xbuff%!32,xbuff%!36)ps_s$+="b" ELSE ps_s$+="a"
            ENDCASE
            ps_t$=FNmsg_0(psup%! 16 ,"CON"+ps_s$)
            IF ps_t$="CON"+ps_s$ ps_t$=FNmsg_0(psup%! 16 ,"CON")
            PROCinteractive_help(ps_t$)
        ENDCASE
        wind%=0
      ELSE
        wind%=wind%! 0 
        IF wind%=0 THEN
          REM must be a menu
          PROCinteractive_help(FNmsg_0(psup%! 16 ,"H"+ps_menu_chsn$))
        ENDIF
      ENDIF
    ENDWHILE
  WHEN &8014C: IF prnt%=0 THEN
      xbuff%!12=xbuff%!8
      xbuff%!16=&80151: REM PSPrinterNotPS
      SYS"Wimp_SendMessage",17,xbuff%,xbuff%!4
    ELSE
      IF prnt%! 4 <>psup% THEN
        xbuff%!12=xbuff%!8
        xbuff%!16=&80151: REM PSPrinterNotPS
        SYS"Wimp_SendMessage",17,xbuff%,xbuff%!4
      ELSE
        REM everything checks out. Calculate the size required then send
        REM the acknowledgement BEFORE doing the transfer block as this
        REM then gives us our task handle!
        ps_s$="": IF prnt%! 40  ps_s$=$prnt%! 40 
        ps_t$="": IF prnt%! 8  ps_t$=$prnt%! 8 
        ps_f$="PrinterChoices:ps.Printers."+STR$ !cnfg%! 4 
        PROCps_ensure_dir
        size%=LEN ps_s$+LEN ps_t$+LEN ps_f$+3
        recv%=xbuff%!4
        xbuff%!24=size%
        xbuff%!12=xbuff%!8
        xbuff%!16=&8014D: REM PSPrinterAck
        SYS"Wimp_SendMessage",17,xbuff%,recv%
        IF xbuff%!20 THEN
          dest%=xbuff%!20
          $buff%=ps_s$+CHR$ 0
          SYS"Wimp_TransferBlock",xbuff%!4,buff%,recv%,dest%,LEN ps_s$+1
          dest%+=LEN ps_s$+1
          $buff%=ps_t$+CHR$ 0
          SYS"Wimp_TransferBlock",xbuff%!4,buff%,recv%,dest%,LENps_t$+1
          dest%+=LEN ps_t$+1
          $buff%=ps_f$+CHR$ 0
          SYS"Wimp_TransferBlock",xbuff%!4,buff%,recv%,dest%,LENps_f$+1
        ENDIF
      ENDIF
    ENDIF
  WHEN &8014E: PROCps_try_to_find_fonts(prnt%)
  WHEN &8014F: PROCps_create_default_font_file
    PROCps_ensure_fonts(prnt%, 0 )
    PROCps_add_fonts( 0 )
    xbuff%!12=xbuff%!8
    xbuff%!16=&80150: REM PSPrinterDefaulted
    SYS"Wimp_SendMessage",17,xbuff%,xbuff%!4
  ENDCASE
  VDU: PROCftracef("PROCps_p17 done")
ENDPROC

DEF FNps_get_feed_name(f$)
  LOCAL ps_c%, ps_s$
  ps_c%=OPENIN(f$):IFps_c%=0 :=""
  ps_s$=GET$#ps_c%:CLOSE#ps_c%
  IFLEFT$(ps_s$,19)="%%RISCOS_FeedName: " THEN :=MID$(ps_s$,20)
  =""

DEF PROCps_create_default_font_file
  LOCAL ps_c%,ps_d%,ps_t%,ps_i%,prdt%
  VDU: PROCftracef("PROCps_create_default_font_file")
  ps_i%=A%! 16 
 




  PROCps_ensure_dir
  SYS"OS_FSControl",37,"PrinterChoices:ps.Printers",ps_i%,,,128
  ps_t%=ps_i%: WHILE ?ps_t%: ps_t%+=1: ENDWHILE
  REM add the name of the font file onto the end of the path string
  $ps_t%="."+STR$ !cnfg%! 4 
  REM and create the file
  ps_c%=OPENOUT $ps_i%
  IF ps_c% THEN
   REM point ps_d% at the font list PRDT block
   prdt%=FNprinter_find_prdata_entry(psup%,$prnt%! 8 )
   ps_d%=FNprinter_read_integer_entry(prdt%, 11 )
   REM now point at the head of the LSTD list
   ps_d%=ps_d%! 8 
   WHILE ps_d%
    BPUT#ps_c%,$ps_d%!8+" "+$ps_d%!12+" "+$ps_d%!16
    ps_d%=ps_d%! 0 
   ENDWHILE
   CLOSE#ps_c%
   SYS "XOS_File",4,$ps_i%,,,,&13  
  ENDIF
ENDPROC

DEF PROCps_try_to_find_fonts(prnt%)
 




  LOCAL ps_i%,ps_j%
  VDU: PROCftracef("PROCps_try_to_find")
  REM is the download window open?
  ps_i%=psup%! 20 
  WHILE ps_i%
   IF $(ps_i%+ 16 )="download" THEN
    REM is the window open?
    !buff%=ps_i%! 4 : SYS"Wimp_GetWindowState",,buff%
    IF buff%!32 AND 1<<16 THEN
     REM try to find this prnt either from the window
     REM or from later on in the linked list
     ps_j%=ps_i%! 12 
     WHILE ps_j%
      IF ps_j%=prnt% ENDPROC: REM found - will be dealt with in due course
      ps_j%=ps_j%! 0 
     ENDWHILE
    ENDIF
    REM not found or window closed ... change the window to point
    REM to THIS prnt since it must be earlier in the linked list
    PROCps_find_fonts_to_do(prnt%)
    ENDPROC
   ELSE
    ps_i%=ps_i%! 0 
   ENDIF
  ENDWHILE
ENDPROC

DEF PROCps_find_fonts_to_do(prnt%)
  VDU: PROCftracef("PROCps_find_fonts_to_do")
  WHILE prnt%
 



   IF prnt%! 4 =psup% PROCps_ensure_fonts(prnt%, -1 )
   prnt%=prnt%! 0 
  ENDWHILE
ENDPROC

DEF PROCps_ensure_fonts(prnt%,take_action%)
  LOCAL ps_i%,ps_j%,ps_k%,ps_s$,ps_t$,ps_e$,ps_download%,ps_changed%
  VDU: PROCftracef("PROCps_ensure_fonts")
  cnfg%=prnt%! 16 
  ps_download%= 0 : REM nothing to download yet
  ps_changed%= 0 
  REM set all the flags to show no matches against the file
  ps_j%=prnt%! 52 
  PROCps_ensure_dir
  WHILE ps_j%
   ps_j%! 12 =ps_j%! 12  OR 1<<30
   IF ps_j%! 12  AND 1<<31 THEN
 
    ps_download%= -1 
    ps_changed%= -1 
   ENDIF
   ps_j%=ps_j%! 0 
  ENDWHILE
  ps_i%=OPENIN("PrinterChoices:ps.Printers."+STR$ !cnfg%! 4 )
  IF ps_i%=0 THEN
   PROCps_create_default_font_file
   ps_i%=OPENIN("PrinterChoices:ps.Printers."+STR$ !cnfg%! 4 )
  ENDIF
  IF ps_i% THEN
   WHILE NOTEOF#ps_i%
    REM marry up the contents of the file against the current list
    ps_s$=GET$#ps_i%: ps_t$="": ps_e$=""
    ps_j%=INSTR(ps_s$," ")
    IF ps_j%<>0 THEN
     ps_t$=MID$(ps_s$,ps_j%+1)
     ps_s$=LEFT$(ps_s$,ps_j%-1)
     ps_k%=INSTR(ps_t$," ")
     IF ps_k%<>0 THEN
      ps_e$=MID$(ps_t$,ps_k%+1)
      ps_t$=LEFT$(ps_t$,ps_k%-1)
     ENDIF
    ENDIF
    ps_s$="\F"+ps_s$: IF ps_e$<>"" ps_s$+="\E"+ps_e$
    ps_k%=prnt%! 52 
    WHILE ps_k%>0
     IF ps_k%! 8  ps_e$=$ps_k%! 8  ELSE ps_e$=""
     IF $ps_k%! 4 =ps_s$ AND ps_e$=ps_t$ THEN
      REM matched this entry in the file
      ps_k%! 12 =ps_k%! 12  AND NOT(1<<30)
      ps_k%=-1
     ELSE
      ps_k%=ps_k%! 0 
     ENDIF
    ENDWHILE
    IF ps_k%=0 THEN
     REM got to add font to list
     ps_changed%= -1 
     B%= &544E4F46 
     C%= 16 
     ps_k%=USR(code_entry%+ 12 )
     IFps_k%=0 ERROR  253 , FNmsg_0(FNps_host_desc,"FA5")
     ps_k%! 0 =prnt%! 52 : prnt%! 52 =ps_k%
     $buff%=ps_s$: B%=buff%: C%=2: ps_k%! 4 =USR(code_entry%+ 28 )
     VDU: PROCftracef("Length of block for '"+$buff%+"' is &"+STR$~(!((ps_k%! 4 )-8)))
     $buff%=ps_t$: B%=buff%: C%=2: ps_k%! 8 =USR(code_entry%+ 28 )
     VDU: PROCftracef("Length of block for '"+$buff%+"' is &"+STR$~(!((ps_k%! 8 )-8)))
     ps_k%! 12 =1
     IF ps_j%=0 THEN
      ps_download%= -1 : REM got SOMETHING to download
      ps_k%! 12 =ps_k%! 12  OR 1<<31
     ENDIF
    ENDIF
   ENDWHILE
   CLOSE#ps_i%
   PROCps_lose_fonts
   IF ps_changed% AND take_action% THEN
    IF ps_download% THEN
     ps_i%=FNprinter_find_window(prnt%,"download")
     PROCicon_write(ps_i%,3,FNprinter_read_string(prnt%! 40 ))
     PROCicon_write(ps_i%,4,$prnt%! 8 )
     PROCicon_write(ps_i%,5,"0"): REM The default password for PostScript
     !buff%=ps_i%: SYS"Wimp_GetWindowState",,buff%
     SYS"Wimp_OpenWindow",,buff%
     PROCcaret_set(ps_i%,5): REM get caret at end of string
     REM was SYS"Wimp_SetCaretPosition",ps_i%,5,-1,-1,-1,0
     ENDPROC
    ELSE
     IF prnt%! 24  AND 2 THEN
 



      !buff%=20: buff%!12=0: buff%!16=&80152: SYS"Wimp_SendMessage",17,buff%,0
     ENDIF
    ENDIF
   ENDIF
  ELSE
   PROCps_lose_fonts
  ENDIF
ENDPROC

DEF PROCps_download_fonts(wind%)
  LOCAL ps_i%,ps_c%,ps_j%,ps_k%,ps_l%,ps_s$,B%,C%,D%,E%,F%,G%,ptr%
  LOCAL ERROR
  VDU: PROCftracef("PROCps_download_fonts")
  REM Check that there is a password.
  IF FNicon_read(wind%,5)="" ERROR  254 ,FNmsg_0(psup%! 16 ,"OK0")
  SYS"Hourglass_On"
  REM need to find a file to spit the data into
  ps_i%=0
  REPEAT
   SYS"OS_File",17,"<Wimp$ScrapDir>.Printers."+STR$ ps_i% TO ps_c%
   IF ps_c% ps_i%+=1
  UNTIL ps_c%=0
  REM now select the PostScript driver module
  SYS"PDriver_SelectDriver",0
  PROCps_add_fonts( -1 ): REM declare the MAPPED fonts
  ps_c%=OPENOUT("<Wimp$ScrapDir>.Printers."+STR$ ps_i%)
  ON ERROR LOCAL RESTORE ERROR: CLOSE#ps_c%: ERROR ERR,REPORT$
  BPUT#ps_c%,"%!PS-Adobe-2.0 ExitServer"
  BPUT#ps_c%,"%%Creator: "+FNmsg_0(psup%! 16 ,"ID")
  BPUT#ps_c%,"%%CreationDate: ";
  ?buff%=3: SYS"OS_Word",14,buff%
  SYS"OS_ConvertStandardDateAndTime",buff%,buff%+5,250: ps_k%=buff%+5
  WHILE ?ps_k% BPUT#ps_c%,?ps_k%: ps_k%+=1: ENDWHILE: BPUT#ps_c%,10
  BPUT#ps_c%,"%%DocumentSuppliedFonts: ";
  ps_j%=prnt%! 52 : ps_l%= 0 
  WHILE ps_j%
   IF ps_j%! 12  AND 1<<31 THEN
    SYS "MakePSFont_MakeFont",-2,$ps_j%! 4 +CHR$ 0,buff%,256,0
    IF ps_l% BPUT#ps_c%,"%%+ ";
    ps_k%=buff%: ps_l%= -1 
    WHILE ?ps_k% BPUT#ps_c%,?ps_k%: ps_k%+=1: ENDWHILE
    BPUT#ps_c%,10
   ENDIF
   ps_j%=ps_j%! 0 
  ENDWHILE
  BPUT#ps_c%,"%%Pages: 0"
  BPUT#ps_c%,"%%BoundingBox: 0 0 0 0"
  BPUT#ps_c%,"%%EndComments"
  BPUT#ps_c%,"%%BeginSetup"
  BPUT#ps_c%,"%%BeginExitServer: "+FNicon_read(wind%,5)
  BPUT#ps_c%,"serverdict begin "+FNicon_read(wind%,5)+" exitserver"
  BPUT#ps_c%,"%%EndExitServer"
  BPUT#ps_c%,"%%EndSetup"
  ps_j%=prnt%! 52 
  WHILE ps_j%
   IF ps_j%! 12  AND 1<<31 THEN
    SYS "MakePSFont_MakeFont",ps_c%,$ps_j%! 4 +CHR$0,buff%,256,0
    ps_j%! 12 =ps_j%! 12  AND NOT(1<<31)
   ENDIF
   ps_j%=ps_j%! 0 
  ENDWHILE
  BPUT#ps_c%,"%%EOF"
  CLOSE#ps_c%
  RESTORE ERROR
  SYS"OS_File",18,"<Wimp$ScrapDir>.Printers."+STR$ ps_i%,&FF5
  REM re-select the default printer so that the font settings are true
  !buff%=20: buff%!12=0: buff%!16=&80152: SYS"Wimp_SendMessage",17,buff%,0
 



  B%= -1 
  C%=xbuff%: $C%=FNmsg_0(psup%! 16 ,"PR")
  D%=C%+LEN $C%+1: $D%="<Wimp$ScrapDir>.Printers."+STR$ ps_i%
  E%=D%+LEN $D%+1: $E%=FNmsg_0(psup%! 16 ,"DF")
  F%=prnt%
  G%=&FF5
  CALL code_entry%+ 24 
  PROCps_find_fonts_to_do(prnt%! 0 )
  SYS"Hourglass_Off"
  VDU: PROCftracef("PROCps_download_fonts done")
ENDPROC

DEF PROCps_lose_fonts
  LOCAL ps_i%,ps_old_i%
  VDU: PROCftracef("PROCps_lose_fonts")
  ps_i%=prnt%! 52 
  WHILE ps_i%
   IF ps_i%! 12  AND 1<<30 THEN
    REM make the link
    IF ps_old_i% THEN
     ps_old_i%! 0 =ps_i%! 0 
    ELSE
     prnt%! 52 =ps_i%! 0 
    ENDIF
    B%= &47525453 : C%=ps_i%! 4 : CALL code_entry%+ 16 
    B%= &47525453 : C%=ps_i%! 8 : CALL code_entry%+ 16 
    B%= &544E4F46 : C%=ps_i%: ps_i%=ps_i%! 0 : CALL code_entry%+ 16 
   ELSE
    ps_old_i%=ps_i%
    ps_i%=ps_i%! 0 
   ENDIF
  ENDWHILE
ENDPROC

DEF PROCps_add_fonts(only_mapped%)
  LOCAL ps_i%,ps_j%,ps_old_driver%
  VDU: PROCftracef("PROCps_add_fonts")
  SYS"PDriver_SelectDriver",0 TO ps_old_driver%
  SYS"PDriver_MiscOp",1: REM clear all fonts
  ps_i%=prnt%! 52 
  WHILE ps_i%
   ps_j%=ps_i%! 12  AND NOT(3<<30): REM lose our private bits
   IF ps_i%! 8 =0 THEN
    IF only_mapped%= 0  THEN
     REM a downloaded font - need to call MakePSFont in case derived fonts are needed
     REM note that -1 means no output generated
     SYS "MakePSFont_MakeFont",-1,$ps_i%! 4 +CHR$ 0,buff%,256,0
    ENDIF
   ELSE
    REM a remap - just declare it
    SYS"PDriver_MiscOp",0,$ps_i%! 4 ,$ps_i%! 8 ,ps_j%
   ENDIF
   ps_i%=ps_i%! 0 
  ENDWHILE
  SYS"PDriver_SelectDriver",ps_old_driver%
  VDU: PROCftracef("PROCps_add_fonts done")
ENDPROC

DEF PROCps_save_configuration(window%)
  LOCAL ps_i%,ps_j%,ps_k%,ps_s$,B%,C%,ps_t$
  VDU: PROCftracef("PROCps_save_configuration_window")
  prdt%=FNprinter_find_prdata_entry(psup%,FNicon_read(window%,6))
  PROCfree_structure(prnt%! 40 )
  $buff%=FNicon_read(window%,13)
  B%=buff%
  C%=2
  prnt%! 40 =USR(code_entry%+ 28 )

  IF cnfg%! 8  <> 0 THEN
    PROCfree_structure(cnfg%! 8 ):cnfg%! 8 =0
    ps_i%=0
    ps_t$=FNprinter_read_string_entry(prdt%, 14 )
    REM if the default setting has been chosen, do not save anything away
    IFps_t$<>FNmsg_0(psup%! 16 ,"ME1b") THEN
      REM otherwise match up on the feed name
      REPEAT
        SYS"OS_GBPB",9,ps_t$,buff%,1,ps_i%,256,"*" TO ,,,ps_j%
        IFps_j%=1 THEN
          CALL Z%,buff%,ps_s$
          $buff%=ps_t$+"."+ps_s$
          IFFNps_get_feed_name($buff%)=FNicon_read(window%,3) THEN
            B%=buff%
            C%=2
            cnfg%! 8 =USR(code_entry%+ 28 )
            ps_i%=-1
          ELSE
            ps_i%+=1
          ENDIF
        ENDIF
      UNTIL ps_j%<>1 OR ps_i%<0
    ENDIF
  ENDIF

  ps_j%=0
  IF FNicon_set(window%,8)                                                                       ps_j%+=1
  IF FNicon_set(window%,11)                                                                      ps_j%+=2
  IF FNicon_read(window%,18)=FNmsg_0(psup%! 16 ,"PO1")                                 ps_j%+=4
  IF cnfg%! 8  = 0 AND FNicon_read(window%,3)=FNmsg_0(psup%! 16 ,"PF1") ps_j%+=8
  IF FNicon_set(window%,7)                                                                       ps_j%+=16
  IF FNicon_set(window%,31)                                                                      ps_j%+=32
  IF FNicon_set(window%,32)                                                                      ps_j%+=64
  ps_i%=VAL FNicon_read(window%,30)
  IF ps_i%>200 ps_i%=100
  IF ps_i%<20  ps_i%=100
  ps_j%+=ps_i%<<8
  ps_j%+=VAL FNicon_read(window%,16)-1<<16
  CASE FNicon_read(window%,23)OF
    WHEN FNmsg_0(psup%! 16 ,"CC1"): ps_j%+=1<<24
    WHEN FNmsg_0(psup%! 16 ,"CC2"): ps_j%+=1<<25
  ENDCASE
  !cnfg%! 0 =ps_j%

  ps_j%=prnt%! 36 : ps_s$=FNicon_read(window%,27)
  IF $ps_j%! 4 <>ps_s$ THEN
   ps_i%=psize_head%
   WHILE ps_i%
    IF $ps_i%! 4 =ps_s$ THEN
     prnt%! 36 =ps_i%
     ps_i%=0
    ELSE
     ps_i%=ps_i%! 0 
    ENDIF
   ENDWHILE
  ENDIF

  IF prnt%! 20 <>-1 THEN
    REM this printer is ACTIVE!
    REM ensure that its details are correct
    PROCselect_printer(prnt%, -1 , 0 )
    REM The front end code will spot that the selected printer has
    REM changed and put everything back the way it was
    REM PROCselect_printer(0, -1 , -1 ): REM don't do this (calls into overlay). JRC 12 Feb '92
  ENDIF
ENDPROC

DEF PROCps_menu(top$,rebuild%,iconpos%)
  LOCAL wind%,ps_i%,ps_ix%,ps_iy%,ind_title%,list_index%,menu_index%,s$,t$
  VDU: PROCftracef("PROCps_menu")
  IF rebuild% THEN
   ps_menu_xpos%=xbuff%!0-64
   ps_menu_ypos%=xbuff%!4
  ENDIF
  IF iconpos% THEN
   !buff%=xbuff%!12: buff%!4=xbuff%!16: SYS"Wimp_GetIconState",,buff%
   ps_ix%=buff%!16: ps_iy%=buff%!20
   SYS"Wimp_GetWindowState",,buff%
   ps_menu_xpos%=buff%!20+buff%!4+ps_ix%+2
   ps_menu_ypos%=buff%!24+buff%!16+ps_iy%-2
  ENDIF
  wind%=FNprinter_find_window(prnt%,"configure")
  ps_menu_chsn$=top$
  CASE top$ OF
  WHEN "ME1": IF FNprinter_read_string_entry(prdt%, 14 )="" THEN
                PROCmenu_create(ps_menu%,FNmsg_0(psup%! 16 ,"ME1a"))
              ELSE
                PROCmenu_create(ps_menu%,FNmsg_0(psup%! 16 ,"ME1")+","+FNmsg_0(psup%! 16 ,"ME1b")+"#")
                ind_title%=(ps_menu%!28 AND &100)<>0
                 
                list_index%=0
                menu_index%=1:REM add items after default entry
                t$=FNprinter_read_string_entry(prdt%, 14 )
                SYS"Hourglass_On"
                REPEAT
                  SYS"OS_GBPB",9,t$,buff%,1,list_index%,256,"*" TO ,,,ps_i%
                  IFps_i%=1 THEN
                    CALL Z%,buff%,s$
                    s$=FNps_get_feed_name(t$+"."+s$)
                    IFs$<>"" PROCmenu_item(ps_menu%,menu_index%,s$,ind_title%):menu_index%+=1
                    list_index%+=1
                  ENDIF
                UNTIL ps_i%<>1
                SYS"Hourglass_Off"
              ENDIF
              PROCmenu_tick_match(ps_menu%,FNicon_read(wind%,3))
  WHEN "ME2": PROCmenu_create(ps_menu%,FNmsg_0(psup%! 16 ,"ME2"))
              PROCmenu_tick_match(ps_menu%,FNicon_read(wind%,16))
  WHEN "ME3": PROCmenu_create(ps_menu%,FNmsg_0(psup%! 16 ,"ME3"))
              PROCmenu_tick_match(ps_menu%,FNicon_read(wind%,18))
  WHEN "ME4": PROCmenu_create(ps_menu%,FNmsg_0(psup%! 16 ,"ME4"))
              PROCmenu_tick_match(ps_menu%,FNicon_read(wind%,23))
  WHEN "MP1": PROCcreate_paper_menu(ps_menu%,wind%,27)
  ENDCASE
  PROCdisplay_menu(prnt%,ps_menu%,ps_menu_xpos%,ps_menu_ypos%)
ENDPROC

  REM Text printing code

DEF PROCps_m8
  LOCAL ps_r%,queu%,tpub%,tprv%
  VDU: PROCftracef("PROCps_m8")
  ps_r%=!xbuff%
  queu%=xbuff%!4
  tpub%=queu%! 44 
  tprv%=queu%! 48 
  CASE ps_r% OF
  WHEN -1: PROCps_1
  WHEN -2: PROCps_2
  WHEN -3: PROCps_3
  WHEN -4: PROCps_4
  WHEN -6: PROCps_6
  WHEN -7: PROCps_7
  WHEN -8: PROCps_8
  WHEN -9: PROCps_9
  WHEN-10: PROCps_10
  WHEN-11: PROCps_11
  WHEN-12: PROCps_12
  WHEN-13: PROCps_13
  WHEN-14: PROCps_14
  WHEN-15: PROCps_15
  WHEN-16: PROCps_16
  WHEN-17: PROCps_17
  WHEN-18: PROCps_18
  WHEN-19: PROCps_19
  WHEN-20: PROCps_20
  ENDCASE
ENDPROC

DEF PROCps_1
 
  LOCAL local_pl%,local_pr%,local_pb%,local_pt%,local_margin%
  LOCAL local_psze%,local_format_print%,local_pw%
  LOCAL last_char%
  LOCAL ps_i%,ps_s$,ps_h,ps_w,B%,C%
  VDU: PROCftracef("PROCps_1")
 
  B%= &56525054 : C%= 56 
  tprv%=USR(code_entry%+ 12 )
  IFtprv%=0 ERROR  253 , FNmsg_0(FNps_host_desc,"FA5")
  queu%! 48 =tprv%
  FORps_i%= 0  TO  52  STEP 4: tprv%!ps_i%=0: NEXT
  REM
  local_format_print%=(!cnfg%! 0  AND 4)>>2
  tprv%! 8 =1+((!cnfg%! 0  AND &FF0000)>>16)
  tpub%! 48 =(!cnfg%! 0  AND 2)>>1
  tpub%! 52 =!cnfg%! 0  AND 1
  IF queu%! 36 =&FFF THEN
   tpub%! 44 =(!cnfg%! 0  AND &FF000000)>>24
  ELSE
   tpub%! 44 =(!cnfg%! 0  AND &FF000000)>>24: REM was 1 JRC
  ENDIF
  local_margin%=50
  local_psze%=prnt%! 36 
  local_pl%=local_psze%! 24  DIV 100 + 1 + local_margin%
  local_pr%=local_psze%! 28  DIV 100 - local_margin%
  local_pb%=local_psze%! 16  DIV 100 + 1 + local_margin%
  local_pt%=local_psze%! 20  DIV 100 - local_margin%
  ps_s$=STR$(local_pl% DIV 10)+" "+STR$(local_pb% DIV 10)
  ps_s$+=" "+STR$((local_pr%+9)DIV 10)+" "+STR$((local_pt%+9)DIV 10)
  $buff%=ps_s$: B%=buff%: C%=2: tprv%! 0 =USR(code_entry%+ 28 )
  IF local_format_print%=0 THEN
   REM portrait
   IF tpub%! 52  local_pt%-=150
   local_pw%=local_pr%-local_pl%
   tprv%! 28 =local_pt%-local_pb%
   $buff%=STR$ local_pl%+" "+STR$ local_pt%+" 0"
  ELSE
   REM landscape
   IF tpub%! 52  local_pl%+=150
   local_pw%=local_pt%-local_pb%
   tprv%! 28 =local_pr%-local_pl%
   $buff%=STR$ local_pb%+" "+STR$ -local_pl%+" 90"
  ENDIF

  B%=buff%: C%=2: tprv%! 32 =USR(code_entry%+ 28 )
  tprv%! 16 =(!cnfg%! 0  AND &FF00)>>8
  VDU: PROCftracef("Local font size is "+STR$ tprv%! 16 )

  ps_w=0.72*tprv%! 16   
  ps_h=1.2*tprv%! 16 : REM allow 10% leading

  VDU: PROCftracef("=> (w, h) = ("+STR$ ps_w+", "+STR$ ps_h+")")

  local_pw%=local_pw% DIV ps_w: REM size of page in characters
  tprv%! 28 =tprv%! 28  DIV ps_h
  tprv%! 12 =(local_pw%+2)DIV tprv%! 8 -2: REM width of column in characters

  IF tprv%! 12 <10+local_psze%! 40 +local_psze%! 44  THEN
    ERROR  254 ,FNmsg_0(psup%! 16 ,"ErrNarr")
  ENDIF

  tprv%! 24 =local_psze%! 36 
  tpub%! 76 =tprv%! 28 -local_psze%! 32 
  tprv%! 44 =local_psze%! 40 
  tprv%! 52 =local_psze%! 44 
  tpub%! 100 =tprv%! 12 -tprv%! 52 
  tprv%! 40 =tprv%! 44 

  IF tpub%! 48  tprv%! 40 +=6

  REM build a character translation table
  PROCps_add_char(last_char%,40,"\(")
  PROCps_add_char(last_char%,41,"\)")
  PROCps_add_char(last_char%,92,"\\")
  FORps_i%=128 TO 255
   PROCps_add_char(last_char%,ps_i%,FNps_oct(ps_i%))
  NEXT
ENDPROC

DEF PROCps_add_char(RETURN last%,char%,trans$)
  LOCAL ps_p%,B%,C%
  VDU: PROCftracef("PROCps_add_char")
  B%= &52414843 : C%=7+LEN trans$
  ps_p%=USR(code_entry%+ 12 )
  IFps_p%=0 ERROR  253 , FNmsg_0(FNps_host_desc,"FA5")
  !ps_p%=0
  ps_p%?4=char%
  ps_p%?5=LEN trans$
  $(ps_p%+6)=trans$
  IF last% THEN
   !last%=ps_p%
  ELSE
   queu%! 64 =ps_p%
  ENDIF
  last%=ps_p%
ENDPROC

DEF PROCps_2
  REM Produce any required job initialisation output
  LOCAL ps_c%
  VDU: PROCftracef("PROCps_2")
  ps_c%=xbuff%!8
  PROCps_header(ps_c%)
  PROCps_prolog(ps_c%)
  PROCps_encoding(ps_c%)
  PROCps_setupline(ps_c%)
ENDPROC

DEF PROCps_header(ps_c%)
  LOCAL ps_old_job%,ps_old_driver%,ps_s$,ps_i%
  VDU: PROCftracef("PROCps_header")
  REM need to ensure that PDriverPS is the selected driver
  SYS"PDriver_SelectDriver",0 TO ps_old_driver%
  REM get PDriverPS to output the job header and start a job
  SYS"PDriver_SelectJob",ps_c%,FNprinter_read_string(tpub%! 112 )TO ps_old_job%
  REM now restore the old job
  SYS"PDriver_SelectJob",ps_old_job%
  REM and the old driver
  SYS"PDriver_SelectDriver",ps_old_driver%
   
  IF cnfg%! 8  <> 0 THEN
    ps_i%=OPENIN(FNprinter_read_string(cnfg%! 8 ))
    IFps_i%<>0 THEN WHILE NOT EOF#ps_i%:BPUT#ps_c%,BGET#ps_i%:ENDWHILE:CLOSE#ps_i%
  ENDIF
  BPUT#ps_c%,"/PDdict 50 dict def"
  BPUT#ps_c%,"PDdict begin"
ENDPROC

DEF PROCps_encoding(ps_c%)
  LOCAL ps_f%,ps_h%,ps_old_driver%,ps_b$,ps_bo$,ps_m$,ps_mo$
  LOCAL ps_acc%
  LOCAL ERROR
  VDU: PROCftracef("PROCps_encoding")
  REM SYS"XOS_Find",&40,"Printers:ps.PSfiles.PSencoding" TO ps_h%;ps_f%
  REM IF ps_f% AND 1 ps_h%=0
  REM IF ps_h%=0 ERROR  254 ,FNmsg_0(psup%! 16 ,"ErrEnc"): REM Error opening PSencoding file
  REM PROCps_outputfile(ps_h%,ps_c%)
  SYS"PDriver_SelectDriver",0 TO ps_old_driver%
  SYS"PDriver_SelectJob",ps_c% TO ps_h%
  ON ERROR LOCAL RESTORE ERROR: SYS"PDriver_SelectJob",ps_h%: ERROR ERR,REPORT$
  VDU: ON ERROR LOCAL RESTORE ERROR: SYS"PDriver_SelectJob",ps_h%: ERROR ERR,REPORT$+" ("+STR$ ERL+")"

  REM if accented chars button checked, then use RF/RFE proc for remapping.  Otherwise send
  REM inline code, which does not do PostScript runtime accent generation.
  REM R4=16+4+1 means use RF and RFE procs to do the remap (supplied in prolog), that this is a
  REM non-permanent print job, and to make the extra declarations for DocumentFonts and DocumentSuppliedFonts

  IF !cnfg%! 0  AND 64 ps_acc%=16+4+1 ELSE ps_acc%=4+1

  SYS "MakePSFont_MakeFont",ps_c%,"\FCorpus.Bold"+CHR$ 0,buff%,256,ps_acc%: ps_f%=buff%
  WHILE ?ps_f%: ps_b$+=CHR$ ?ps_f%: ps_f%+=1: ENDWHILE
  SYS "MakePSFont_MakeFont",ps_c%,"\FCorpus.Bold.Oblique"+CHR$ 0,buff%,256,ps_acc%: ps_f%=buff%
  WHILE ?ps_f%: ps_bo$+=CHR$ ?ps_f%: ps_f%+=1: ENDWHILE
  SYS "MakePSFont_MakeFont",ps_c%,"\FCorpus.Medium"+CHR$0,buff%,256,ps_acc%: ps_f%=buff%
  WHILE ?ps_f%: ps_m$+=CHR$ ?ps_f%: ps_f%+=1: ENDWHILE
  SYS "MakePSFont_MakeFont",ps_c%,"\FCorpus.Medium.Oblique"+CHR$ 0,buff%,256,ps_acc%: ps_f%=buff%
  WHILE ?ps_f%: ps_mo$+=CHR$ ?ps_f%: ps_f%+=1: ENDWHILE

  REM now add these names to the DocumentFont list (within the job)
  SYS"XPDriver_MiscOp",0,ps_m$,"X",40,0
  SYS"XPDriver_MiscOp",0,ps_b$,"X",40,0
  SYS"XPDriver_MiscOp",0,ps_mo$,"X",40,0
  SYS"XPDriver_MiscOp",0,ps_bo$,"X",40,0
  SYS"PDriver_SelectJob",ps_h%
  SYS"PDriver_SelectDriver",ps_old_driver%
  BPUT#ps_c%,"/TF /"+ps_b$+" def"
  BPUT#ps_c%,"/NF /"+ps_m$+" def"
  BPUT#ps_c%,"/BF /"+ps_b$+" def"
  BPUT#ps_c%,"/IF /"+ps_mo$+" def"
  BPUT#ps_c%,"/BIF /"+ps_bo$+" def"
  BPUT#ps_c%,10
ENDPROC

DEF PROCps_prolog(ps_c%)
  LOCAL ps_f%,ps_h%
  VDU: PROCftracef("PROCps_prologue")
  SYS"XOS_Find",&4F,"Printers:ps.PSfiles.PStprolog" TO ps_h%;ps_f%
  IF ps_f% AND 1 ps_h%=0
  IF ps_h%=0 ERROR  254 ,$(ps_h%+4)
  PROCps_outputfile(ps_h%,ps_c%)
ENDPROC

DEF PROCps_outputfile(ps_h%,ps_c%)
  VDU: PROCftracef("PROCps_output")
  WHILE NOT EOF#ps_h%
    BPUT#ps_c%,GET$#ps_h%
  ENDWHILE
  SYS"XOS_Find",0,ps_h%
ENDPROC

DEF PROCps_setupline(ps_c%)
  LOCAL ps_s$, ps_i%, local_psze%, ps_extra$
  VDU: PROCftracef("PROCps_setupline")
  BPUT#ps_c%,"%%EndProlog"
  BPUT#ps_c%,"%%BeginSetup"

  local_psze%=prnt%! 36 
  ps_s$=$local_psze%! 4 
  ps_i%=0
  WHILE MID$(ps_s$,ps_i%,1)<>" " AND ps_i%<=LEN ps_s$
    ps_i%+=1
  ENDWHILE
  ps_s$=LEFT$(ps_s$,ps_i%-1)

  SYS"OS_File",17,"Printers:ps.Paper."+FNtask_lower(ps_s$) TO ps_i%
  IF ps_i%=1 THEN
    ps_i%=OPENIN("Printers:ps.Paper."+FNtask_lower(ps_s$))
    IFps_i%<>0 THEN WHILE NOT EOF#ps_i%:BPUT#ps_c%,BGET#ps_i%:ENDWHILE:CLOSE#ps_i%
  ELSE
    ps_extra$=FNmsg_2(psup%! 16 ,"PT",ps_s$,FNtask_lower(ps_s$))
  ENDIF

  BPUT#ps_c%, STR$(FNps_fontsize(tpub%! 64 ))+" FI"

  IF FNprinter_read_string_entry(prdt%, 14 )="" AND cnfg%! 8  = 0 THEN
    IF !cnfg%! 0  AND 8 THEN
      ps_s$=FNungstrans(FNprinter_read_boolean_string_entry(prdt%, 9 , -1 ))
    ELSE
      ps_s$=FNungstrans(FNprinter_read_boolean_string_entry(prdt%, 9 , 0 ))
    ENDIF
    IF ps_extra$<>"" ps_extra$=ps_s$+"|J"+ps_extra$ ELSE ps_extra$=ps_s$
  ENDIF

  IF ps_extra$<>"" THEN
    BPUT#ps_c%,ps_extra$
  ENDIF
  BPUT#ps_c%,"%%EndSetup"
ENDPROC

DEF PROCps_3
  REM Produce page header
  LOCAL ps_s$,old_pos%,local_psze%,local_style_bits%,ps_c%,ps_t$,ps_w,ps_h,@%
  VDU: PROCftracef("PROCps_3")
  local_style_bits%=tpub%! 96 
  tpub%! 96 =64: REM title bit
  ps_c%=xbuff%!8
  ps_s$="%%Page: "
  IF tprv%! 8 >1 ps_s$+=STR$(tprv%! 8 *tpub%! 84 +1)+"-"
  tpub%! 84 +=1
  ps_s$+=STR$(tprv%! 8 *tpub%! 84 )+" "+STR$tpub%! 84 
  BPUT#ps_c%,ps_s$
  BPUT#ps_c%,"%%PageBoundingBox: "+FNprinter_read_string(tprv%! 0 )
  BPUT#ps_c%,FNprinter_read_string(tprv%! 32 );
  BPUT#ps_c%," "+STR$(1.2*tprv%! 16 );
  VDU: PROCftracef("Local font size is "+STR$(1.2*tprv%! 16 ))
  ps_w=0.72*tprv%! 16 : REM courier character width is 60% of size
  ps_h=1.2*tprv%! 16 
  VDU: PROCftracef("=> (w, h) = ("+STR$ ps_w+", "+STR$ ps_h+")")

  @%="+g10.9"
  BPUT#ps_c%," "+STR$ ps_w+" "+STR$ ps_h+" StartPage"
  IF tpub%! 52  THEN
    local_psze%=prnt%! 36 
    old_pos%=tpub%! 56 
    ps_s$=STR$(local_psze%! 36 -0.5)+" "+STR$ tprv%! 44 +" MT "+STR$ 64+" ("
    ps_t$=FNprinter_read_string(tpub%! 112 )+"   "+FNprinter_read_string(tpub%! 120 )
    ps_t$+="   "+FNmsg_1(psup%! 16 ,"PAG",STR$ tpub%! 84 )
    ps_s$+=FNps_trans(ps_t$)+") SS"
    BPUT#ps_c%,ps_s$
    tpub%! 56 =old_pos%
  ENDIF
  tpub%! 96 =local_style_bits%
  tprv%! 4 =0
ENDPROC

DEF PROCps_4
  REM post line processing
  LOCAL ps_i%,ps_b$
  VDU: PROCftracef("PROCps_4")
  REM if we've output something and we aren't formatting, end the string
  IF xbuff%!8<>0 AND tpub%! 8 =0 ps_b$=") SS"
  REM if we've reached the end or we're ending the page ...
  IF EOF#queu%! 12  OR(tpub%! 24 >1)THEN
    REM move on to the next column
    tprv%! 4 +=1
    REM if we've reached the end or we've run out of columns ...
    IF EOF#queu%! 12  OR tprv%! 4 >=tprv%! 8  THEN
      REM set the stage to deal with the footer
      tpub%! 92 =3
    ENDIF
  ENDIF
  xbuff%?8=LEN ps_b$
  $(xbuff%+9)=ps_b$
ENDPROC

DEF PROCps_6
  REMM Do control code processing
  LOCAL ps_s$
  VDU: PROCftracef("PROCps_6")
  ps_s$=FNps_display(xbuff%!8)
  xbuff%?8=LEN ps_s$
  $(xbuff%+9)=ps_s$
ENDPROC

DEF PROCps_7
  REM handle a backspace
  REM simple! just move back to where the last character is!
  LOCAL ps_b$
  VDU: PROCftracef("PROCps_7")
  PROCps_8: REM stores its value in xbuff%+9
  ps_b$=") SS "+$(xbuff%+9)
  xbuff%?8=LEN ps_b$
  $(xbuff%+9)=ps_b$
ENDPROC

DEF PROCps_8
  REM handle line splitting
  LOCAL ps_b$,ps_i
  VDU: PROCftracef("PROCps_8")
  ps_i=tprv%! 40 
  ps_i+=tprv%! 4 *(tprv%! 12 +1)
  ps_i+=(tpub%! 56 -tprv%! 40 )*(FNps_fontsize(0)/FNps_fontsize(tpub%! 64 ))
  ps_b$=STR$ tpub%! 80 +" "+STR$ ps_i+" MT "+STR$(tpub%! 96  AND &7F)+" ("
  xbuff%?8=LEN ps_b$
  $(xbuff%+9)=ps_b$
ENDPROC

DEF PROCps_9
  REM handle style changes
  LOCAL ps_b$
  VDU: PROCftracef("PROCps_9")
  ps_b$=") SS "+STR$(xbuff%!8 AND &7F)+" ("
  xbuff%?8=LEN ps_b$
  $(xbuff%+9)=ps_b$
ENDPROC

DEF PROCps_10
  REM start a new line
  LOCAL ps_b$,line_num$,wrap%,ps_i
  VDU: PROCftracef("PROCps_10")
  tpub%! 80 +=1
  tpub%! 72 +=1
  ps_i=tprv%! 44 +tprv%! 4 *(tprv%! 12 +1)
  ps_b$=STR$ tpub%! 80 +" "+STR$ ps_i+" MT "
  wrap%=(tpub%! 56 >=tpub%! 100 )
  IF tpub%! 48  THEN
    IF tpub%! 64  ps_b$+=STR$ FNps_fontsize(0)+" FS "
    ps_b$+="0 ("
    REM print line number, unless wrapped line
    IF wrap% THEN
      tpub%! 72 -=1
      ps_b$+=STRING$(6," ")
    ELSE
      line_num$=STR$ tpub%! 72 
      ps_b$+=STRING$(5-LEN line_num$," ")+line_num$+" "
    ENDIF
    tpub%! 56 =6
    ps_b$+=") SS "
    IF tpub%! 64  ps_b$+=STR$(FNps_fontsize(tpub%! 64 ))+" FS "
  ELSE
    tpub%! 56 =0
  ENDIF
  IF tprv%! 48 >0 ps_b$+="0 ("+STRING$(tprv%! 48 ," ")+") SS "
  IF wrap% THEN
    tpub%! 56 +=1
    ps_b$+="1 (|) SS ": REM print wrap bar in bold
  ENDIF
  ps_b$+=STR$(tpub%! 96  AND &7F)+" ("
  tpub%! 56 +=tprv%! 44 +tprv%! 48 
  xbuff%?8=LEN ps_b$
  $(xbuff%+9)=ps_b$
ENDPROC

DEF PROCps_11
  REM print footnote number
  LOCAL ps_b$,ps_i%
  VDU: PROCftracef("PROCps_11")
  PROCps_10: REM stores its value in xbuff%+9
  ps_b$=$(xbuff%+9)+") SS "
  PROCps_10: ps_b$+=$(xbuff%+9)+") SS "+STR$((tpub%! 96  OR 1<<4)AND &7F)+" ("
  REM                                                        turn on superscript ^
  ps_b$+=FNps_trans(RIGHT$("  "+STR$ tpub%! 60 ,3))
  tpub%! 56 -=3
  ps_b$+=") SS "
  PROCps_8: REM stores its value in xbuff%+9
  ps_b$+=$(xbuff%+9)+CHR$92                    
  xbuff%?8=LEN ps_b$
  $(xbuff%+9)=ps_b$
ENDPROC

DEF PROCps_12
  REM string translation
  LOCAL ps_b$
  VDU: PROCftracef("PROCps_12")
  ps_b$=FNps_trans($(xbuff%+8))
  xbuff%?8=LEN ps_b$
  $(xbuff%+9)=ps_b$
ENDPROC

DEF PROCps_13
  REM handle font change
  LOCAL font_new%,ps_b$,ps_i%
  VDU: PROCftracef("PROCps_13")
  font_new%=xbuff%!8
  ps_i%=tprv%! 40 
  ps_i%+=INT((tprv%! 12 -tprv%! 40 -tprv%! 52 )*FNps_fontsize(font_new%)/FNps_fontsize(0))
  tpub%! 100 =ps_i%
  tpub%! 64 =font_new%
  IF tpub%! 68 <tpub%! 100 -tprv%! 40  THEN
   tprv%! 48 =tpub%! 68 
  ELSE
   tprv%! 48 =0
  ENDIF
  IF tpub%! 88 <tpub%! 100 -tprv%! 40  AND tpub%! 88 >tprv%! 48  THEN
   tpub%! 100 =tprv%! 40 +tpub%! 88 
  ENDIF
  ps_b$=STR$ FNps_fontsize(font_new%)+" FS"
  xbuff%?8=LEN ps_b$
  $(xbuff%+9)=ps_b$
ENDPROC

DEF PROCps_14
  REM finish page
  VDU: PROCftracef("PROCps_14")
  BPUT#xbuff%!8,"EndPage"
ENDPROC

DEF PROCps_15
  REM finish job
  LOCAL ps_c%,cnct%,ps_ptr%,ps_ext%,ps_data%,ps_p%,B%,C%
  VDU: PROCftracef("PROCps_15")
  ps_c%=xbuff%!8
  IF queu%! 36 <>&FF5 THEN
   REM get the list of fonts ...
   REM (needs to be done before we end the job)
   SYS"PDriver_SelectJob",ps_c% TO ps_ext%
   SYS"PDriver_MiscOp",2,0,0,0,0 TO ,,C%
   IF C%<>0 THEN
    B%= &58585858 : ps_data%=USR(code_entry%+ 12 )
    IFps_data%=0 ERROR  253 , FNmsg_0(FNps_host_desc,"FA5")
    SYS"PDriver_MiscOp",2,ps_data%,C%,0,0
   ENDIF
   SYS"PDriver_SelectJob",ps_ext%
 



   ps_ptr%=PTR#ps_c%: ps_ext%=EXT#ps_c%
   SYS"PDriver_EndJob",ps_c%
   EXT#ps_c%=ps_ext%: PTR#ps_c%=ps_ptr%
   BPUT#ps_c%,"%%Trailer"
   BPUT#ps_c%,"end"
   BPUT#ps_c%,"%%Pages: "+STR$ tpub%! 84 
   BPUT#ps_c%,"%%BoundingBox: "+FNprinter_read_string(tprv%! 0 )
   IF C%<>0 THEN
    ps_ptr%=PTR#ps_c%: ps_ext%=EXT#ps_c%: BPUT#ps_c%,"%%DocumentFonts: ";
    ps_p%=ps_data%
    REPEAT
     IF ps_p%!8=40 OR ps_p%!8=41 THEN
      B%=!ps_p%
      WHILE ?B%: BPUT#ps_c%,?B%: B%+=1: ENDWHILE: BPUT#ps_c%,10
      ps_ptr%=PTR#ps_c%: ps_ext%=EXT#ps_c%: BPUT#ps_c%,"%%+ ";
     ENDIF
     ps_p%+=12
    UNTIL(ps_p%-ps_data%)>=C%
    EXT#ps_c%=ps_ext%: PTR#ps_c%=ps_ptr%
    ps_ptr%=PTR#ps_c%: ps_ext%=EXT#ps_c%: BPUT#ps_c%,"%%DocumentSuppliedFonts: ";
    ps_p%=ps_data%
    REPEAT
      IF ps_p%!8=41 THEN
        B%=!ps_p%
        WHILE ?B%: BPUT#ps_c%,?B%: B%+=1: ENDWHILE: BPUT#ps_c%,10
        ps_ptr%=PTR#ps_c%: ps_ext%=EXT#ps_c%: BPUT#ps_c%,"%%+ ";
      ENDIF
      ps_p%+=12
    UNTIL ps_p%-ps_data%>=C%
    EXT#ps_c%=ps_ext%: PTR#ps_c%=ps_ptr%
    B%= &58585858 : C%=ps_data%: CALL code_entry%+ 16 
   ENDIF
  ENDIF
  cnct%=prnt%! 12 
  IF cnct%! 0 =1 OR cnct%! 0 =2 BPUT#ps_c%,4
ENDPROC

DEF PROCps_16
  REM process a tab character
  LOCAL ps_b$
  VDU: PROCftracef("PROCps_16")
  ps_b$=STRING$(8-((tpub%! 56 -tprv%! 44 -tprv%! 48 +1-6*tpub%! 48 )MOD8)," ")
  tpub%! 56 +=LEN ps_b$
  xbuff%?8=LEN ps_b$
  $(xbuff%+9)=ps_b$
ENDPROC

DEF PROCps_17
  REM no formfeed text ...
  VDU: PROCftracef("PROCps_17")
  xbuff%?8=0
ENDPROC

DEF PROCps_18
  REM change layout
  LOCAL layout_height%,layout_top%,layout_bottom%
  VDU: PROCftracef("PROCps_18")
  layout_height%=xbuff%!8
  layout_top%=xbuff%!12
  layout_bottom%=xbuff%!16
  IF layout_height%-layout_top%-layout_bottom%>3 AND layout_height%<=tprv%! 28  THEN
   tpub%! 76 =layout_height%-layout_bottom%
   tprv%! 24 =layout_top%
  ENDIF
  xbuff%?8=0
ENDPROC

DEF PROCps_19
  REM start new page
  VDU: PROCftracef("PROCps_19")
  tpub%! 80 =tprv%! 24 
  xbuff%?8=0
ENDPROC

DEF PROCps_20
  REM prepend any code for a native (ie PostScript) file
  LOCAL ps_c%, ps_d%, ps_i%, ps_p%, ps_q%
  VDU: PROCftracef("PROCps_20")
  ps_c%=xbuff%!8
  ps_d%=xbuff%!12
  IF cnfg%! 8  <>0 THEN
    ps_i%=OPENIN(FNprinter_read_string(cnfg%! 8 ))
    IFps_i%<>0 THEN
      REM copy %!PS-Adobe line
      PROCps_copy_line(ps_d%, ps_c%)
      REM now copy all of the %% lines
      REPEAT
        ps_p%=BGET#ps_d%:ps_q%=BGET#ps_d%:PTR#ps_d%=PTR#ps_d%-2
        IFps_p%=ASC"%" AND ps_q%=ASC"%" PROCps_copy_line(ps_d%, ps_c%)
      UNTIL ps_p%<>ASC"%" OR ps_q%<>ASC"%"
      REM now copy the feed code
      WHILE NOT EOF#ps_i%:BPUT#ps_c%,BGET#ps_i%:ENDWHILE
      CLOSE#ps_i%
    ENDIF
  ENDIF
ENDPROC

DEF PROCps_copy_line(from%, to%)
  LOCAL ps_c%
  REPEAT
    ps_c%=BGET#from%
    BPUT#to%, ps_c%
  UNTIL ps_c%=10 OR ps_c%=13
  REPEAT
    ps_c%=BGET#from%
    IFps_c%=10 OR ps_c%=13 BPUT#to%,ps_c% ELSE PTR#from%=PTR#from%-1
  UNTIL ps_c%<>10 AND ps_c%<>13
ENDPROC

DEF FNps_fontsize(num%)
  REM provide notional cpi sizes
  VDU: PROCftracef("FNps_fontsize")
  CASE num% OF
  WHEN 0: =10: REM pica
  WHEN 1: =12: REM elite
  WHEN 2: =17: REM condensed
  WHEN 3: = 6: REM expanded
  ENDCASE
=0

DEF FNps_trans(ps_s$)
  LOCAL ps_i%,byte%,out$,str$
  VDU: PROCftracef("FNps_trans")
  IF ps_s$="" THEN =""
  FOR ps_i%=1 TO LEN ps_s$
    byte%=ASC MID$(ps_s$,ps_i%,1)
    str$=""
    CASE  -1  OF
      WHEN byte%<32 OR byte%=127
        IF tpub%! 44 =1 THEN str$=FNps_display(byte%)
      WHEN byte%>127 AND tpub%! 44 <>0
        IF tpub%! 44 =1 THEN str$=FNps_display(byte%)
      WHEN tpub%! 44 <>0
        str$=CHR$ byte%
        tpub%! 56 +=1
      OTHERWISE
        tpub%! 56 +=1
        IF byte%>127 THEN
          str$=FNps_oct(byte%)
        ELSE
          CASE byte% OF
            WHEN ASC"(": str$="\("
            WHEN ASC")": str$="\)"
            WHEN     92: str$="\\"                 
            OTHERWISE: str$=CHR$ byte%
          ENDCASE
        ENDIF
    ENDCASE
    out$+=str$
  NEXT
=out$

DEF FNps_display(byte%)
  LOCAL buf$
  VDU: PROCftracef("FNps_display")
  tpub%! 56 +=4
  buf$=") SS "+STR$((tpub%! 96  AND &7F)OR 1)+" ("
  REM                                          bold_bit ^
  buf$+="["+RIGHT$("0"+STR$~byte%,2)+"]"
  buf$+=") SS "+STR$(tpub%! 96  AND &7F)+" ("
=buf$

DEF FNps_oct(byte%)
  VDU: PROCftracef("FNps_oct")
=CHR$92+CHR$((byte%>>6 AND 7)+48)+CHR$((byte%>>3 AND 7)+48)+CHR$((byte% AND 7)+48)  

DEF PROCps_ensure_dir

  LOCAL f%

  SYS "XOS_File", 8, "PrinterChoices:ps" TO ; f%
  SYS "XOS_File", 8, "PrinterChoices:ps.Printers" TO ; f%

ENDPROC

DEF FNps_host_desc
LOCAL a%
a%=buff%!24
=a%! 12 
#line 10129 "sources.RunImage"

