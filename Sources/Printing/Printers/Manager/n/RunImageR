    1     ON ERROR ERROR EXT ERR,REPORT$
    2   SYS "Hourglass_On"
    3   DIM A%  84 ,A%! 16  256,win_buff% 256,    evaluation_buff% 256,buff1% 512,task_buff%  1024 ,icon_buffer% 256,    msg_text% 256
    4   DIM prntctrl_icdf%(4)
    5   PROCmsg_initialise("Printers:Messages",A%! 12 )
    6     ON ERROR PROCmsg_end(A%! 12 ):         ERROR EXT ERR,REPORT$
    7   PROCinitialise_code
    8   PROCtask_initialise(FNmsg_0(A%! 12 ,"ID"))
    9   PROCerror_initialise
   10   PROCicon_initialise
   11   PROCwin_initialise
   12   PROCmenu_initialise
   13   PROClocale_initialise
   14   PROCinitialise_support_libraries  
   15   CALL code_entry%+ 8 
   16   PROCsave_initialise
   17   PROCinitialise  
   18     PROCenumerate_queue_directory
   19   SYS "Hourglass_Off"
   20   ON ERROR PROCerror
   21   IF PDF_loading% THEN
   22     $(task_buff%+44)=PDF_to_load$
   23     ?(task_buff%+44+LEN(PDF_to_load$))=0:REM 0-terminate it
   24     PROCadd_to_prdata
   25   ENDIF
   26   REPEAT
   27     PROCdespatch_poll(A%! 20 )
   28   UNTIL  0 
   29 END
   30 DEF PROCdespatch_poll(mask%)
   31   LOCAL r%,t%,prnt%
   32   r%=FNtask_poll(mask%)
   33   CASE r% OF
   34     WHEN 0
   35       PROCprocess_queue
   36       PROCdespatch_null
   37     WHEN 1
   38       PROCredraw_window
   39     WHEN 2
   40       SYS "Wimp_OpenWindow",,task_buff%
   41     WHEN 3
   42       PROCclose_window
   43     WHEN 6
   44       PROCmouseclick
   45     WHEN 7
   46       IF save_dragging% THEN
   47         PROCsave_decodedrag
   48       ELSE
   49         PROCbroadcast_reason_code(selected_prnt%,7,task_buff%)
   50       ENDIF
   51     WHEN 8
   52       PROCkeypress
   53     WHEN 9
   54       PROCmenuaction
   55     WHEN 13  
   56       !(task_buff%!0) = 0  
   57       PROCpollword_changed  
   58     WHEN 17,18
   59       PROCreceive(r%)
   60     WHEN 19
   61       PROCack
   62     OTHERWISE
   63       PROCbroadcast_reason_code(selected_prnt%,r%,task_buff%)
   64   ENDCASE
   65   timeout%=-1
   66   prnt%=A%! 48 
   67   WHILE prnt%
   68     t%=prnt%! 56 
   69     IF NOT t% THEN
   70       IF timeout%=-1 timeout%=t% ELSE IF t%<timeout% timeout%=t%
   71     ENDIF
   72     prnt%=prnt%! 0 
   73   ENDWHILE
   74   CASE freeway_just_started% OF
   75     WHEN 1
   76       timeout% += 500
   77       freeway_just_started% = 2
   78     WHEN 2
   79       PROCfreeway_starting
   80       freeway_just_started% = 0
   81   ENDCASE
   82 ENDPROC
   83 DEF PROCinitialise
   84   LOCAL path$
   85   task_buff%!0=24
   86   task_buff%!12=0
   87   task_buff%!16=&80143  
   88   task_buff%!20=34  
   89   SYS "Wimp_SendMessage",18,task_buff%
   90   task_your_ref%=task_buff%!8
   91   PROCinitialise_constants
   92   PROCinitialise_globals
   93   PROCcheck_cmdline_args
   94   PROCinitialise_sparrow ( -1 )
   95   path$ =  "<Choices$Write>.Printers" 
   96   IF multiple_choices% THEN
   97     path$ += ".Remote"
   98     SYS "XOS_File", 8, path$
   99     path$ += ".ID"+unique_string$
  100     SYS "XOS_File", 8, path$
  101   ENDIF
  102   path$ += "."
  103   SYS "OS_SetVarVal", "PrinterChoices$Path", path$, LENpath$, 0, 0  
  104   PROCread_paper_file("Printers:PaperRO", 2 )
  105   PROCread_paper_file("PrinterChoices:PaperRW", 1 )
  106   IF psize_head%=0 ERROR  253 , FNmsg_0(A%! 12 ,"FAK")
  107   PROCinitialise_windows
  108   timeout%=-1: SYS "OS_ReadMonotonicTime" TO time_before%
  109   PROCinitialise_settings
  110 ENDPROC
  111 DEF PROCinitialise_constants
  112   A%! 20 =%110000000001100000110001
  113   message_mask%=%110000000001100101110011
  114   click_mask%=  %110000000001100100110001
  115 ENDPROC
  116 DEF PROCinitialise_code
  117   LOCAL h%,l%,a%,w%
  118   SYS "XOS_File", 8,  "<Choices$Write>.Printers" 
  119   h%=OPENIN "Printers:Code"
  120   l%=EXT#h%
  121   SYS "OS_FSControl",21,h% TO,a%,w%
  122   CLOSE#h%
  123   IF(w% AND &FF)=46 THEN
  124     code_entry%=a%
  125   ELSE
  126     DIM code_entry% l%+1
  127     SYS "OS_File",16,"Printers:Code",code_entry%  
  128   ENDIF
  129   Z%=code_entry%+ 64 
  130   Y%=code_entry%+ 68 
  131 ENDPROC
  132 DEF PROCcheck_cmdline_args
  133   LOCAL args%,args1%
  134   SYS"OS_GetEnv" TO args%
  135   REM syntax is BASIC -quit progname -pdf filename
  136   SYS"OS_ReadArgs","/g,quit/s,/g,pdf/s,/g",args%,buff1%,256
  137   IF buff1%!12=0 THEN
  138     PDF_loading%= 0 
  139   ELSE
  140     PDF_loading%= -1 
  141   ENDIF
  142   PDF_to_load$=""
  143   args%=buff1%!16
  144   IF args%<>0 THEN
  145     args1%=!args% AND &FFFF
  146     args%+=2
  147     WHILE args1%
  148       PDF_to_load$+=CHR$(?args%)
  149       args%+=1
  150       args1%-=1
  151     ENDWHILE
  152   ENDIF    
  153 ENDPROC
  154 DEF PROCinitialise_globals
  155   mm_to_72000=1814.4*72000/(180<<8)
  156   in_to_72000=72000
  157   line_space%=44  
  158   claim_state%=0
  159   claim_ref%=0
  160   query_state%=0
  161   type_state%=0
  162   psup_head%=0
  163   printer_count%=0  
  164   A%! 48 =0
  165   A%! 44 =0  
  166   selected_prnt%=0
  167   select_all%= 0 
  168   menu_chsn$=""
  169   menu_prnt%=0
  170   menued_y%=0
  171   menued_prnt%=0
  172   menued_queu%=0
  173   A%! 24 =0
  174   A%! 28 =0
  175   printer_output$="null:"
  176   prnt_edit%=0
  177   psup_edit%=0
  178   A%! 32 =0
  179   queue_leafname$=""
  180   A%! 36 = 0 
  181   queue_temphand%=0
  182   queue_tempref%=0
  183   psize_head%=0
  184   psize_edit%=0
  185   temp_count%=0
  186   SYS "OS_Byte",&CC,,255 TO,old_ignore_state%
  187   file_to_delete$=""
  188   last_scrap$ = ""
  189   A%! 76 =0
  190   A%! 80 =0
  191   sparrow_present%   =  0 
  192   remote_printers%  = 0       
  193   pollword_location% = 0
  194   remote_printer_count% = 0
  195   unique_string$ = ""
  196   remote_jobno% = 0
  197   printer_prefix$ = ""
  198   last_application$ = ""
  199   last_leafname$ = ""
  200   dealing_with_a_protocol% =  0 
  201   directories_shared% =  0 
  202   freeway_just_started% = 0
  203   multiple_choices% =  0 
  204 ENDPROC
  205 DEF PROCinitialise_support_libraries
  206 LOCAL c%,d%,load%,size%,basic_size%,utility_size%,needed%
  207 LOCAL basname$():DIM basname$(255)
  208 basic_size%=0      
  209 utility_size%=0    
  210 baslim%=0
  211 mclim%=0
  212 basic_count%=0     
  213 utility_count%=0   
  214 c%=-1
  215 REPEAT
  216   PROCget_next_directory(path$,currdir$,name$,c%)
  217   IF name$<>"" THEN
  218     SYS"OS_File",17,"Printers:"+name$+".Resources.Support" TO d%,,load%,,size%
  219     IF d%=1 AND (load% AND &FFF00000) = &FFF00000 THEN
  220       size%=size%+3 AND NOT 3
  221       CASE (load% AND &FFF00)>>8 OF
  222         WHEN &FFB
  223           IF size% > basic_size% basic_size% = size%
  224           IFbaslim%<255 basname$(baslim%)=name$
  225           baslim% += 1
  226         WHEN &FFC
  227           utility_size% += size%
  228           mclim% += 1
  229       ENDCASE
  230     ENDIF
  231   ENDIF
  232 UNTIL name$=""
  233 IF mclim% > 0 DIM utility%(mclim%-1), utility$(mclim%-1)
  234 needed%=HIMEM+utility_size%+basic_size%+16*1024
  235 END=needed%
  236 IF (HIMEM+utility_size%+basic_size%+16*1024) < needed% THEN
  237   needed%=needed%/1024
  238   needed%=needed%-needed% MOD 8+8
  239   ERROR  253 ,FNmsg_1(A%! 12 ,"FA4",STR$ needed%)
  240 ENDIF
  241 IF baslim% > 0 THEN
  242  DIM overlay$(baslim%-1)
  243  FORd%=0 TO baslim%-1
  244   overlay$(d%)="Printers:"+basname$(d%)+".Resources.Support"
  245  NEXT
  246  OVERLAY overlay$()
  247 ENDIF
  248 ENDPROC
  249 DEF PROCget_next_directory(RETURN path$,RETURN currdir$,RETURN name$,RETURN offset%)
  250   LOCAL i%,num_read%,flags%
  251   IF offset%=-1 path$=FNtask_read_env("Printers$Path",msg_text%)
  252   REPEAT
  253    IF offset%=-1 THEN
  254     IF path$="" THEN
  255      name$=""
  256      ENDPROC
  257     ENDIF
  258     i%=INSTR(path$,",")
  259     IF i%=0 i%=LEN path$+1
  260     currdir$=LEFT$(path$,i%-1)
  261     IF RIGHT$(currdir$)="." currdir$=LEFT$(currdir$)
  262     currdir$+=CHR$ 0
  263     path$=MID$(path$,i%+1)
  264     offset%=0
  265    ENDIF
  266    SYS "XOS_GBPB",10,currdir$,msg_text%,1,offset%,256,"*" TO,,,num_read%,offset%;flags%
  267    IF (flags% AND 1) num_read% = 0  
  268    IF num_read%=1 THEN
  269     IF msg_text%!16=2 THEN
  270       i%=msg_text%+20:CALL Z%,i%,name$
  271       ENDPROC
  272     ENDIF
  273    ELSE
  274     offset%=-1
  275    ENDIF
  276   UNTIL  0 
  277 ENDPROC
  278 DEF PROCinitialise_one_support_library(name$)
  279   LOCAL load%,size%,f$
  280   f$="Printers:"+name$+".Resources.Support"
  281   SYS "OS_File",17,f$ TO d%,,load%,,size%  
  282   size%=size%+3 AND NOT 3
  283   IF d%<>1 SYS "OS_File",19,f$,d%  
  284   IF(load% AND &FFF00000)<>&FFF00000     ERROR  254 ,FNmsg_1("FA3",name$)
  285   CASE(load% AND &FFF00)>>8 OF
  286     WHEN &FFB
  287     WHEN &FFC
  288       IF utility_count%<mclim% THEN
  289         DIM u% size%
  290         utility%(utility_count%)=u%
  291         utility$(utility_count%)=name$
  292         SYS "OS_File",16,f$,u%  
  293         utility_count%+=1
  294       ENDIF
  295     OTHERWISE
  296       ERROR  254 ,FNmsg_1("FA3",name$)
  297   ENDCASE
  298 ENDPROC
  299 DEF PROCinitialise_one_psup(name$,RETURN this_psup%)
  300   LOCAL d%,load%,f$,h%,this_wind%,last_wind%,psup%
  301   LOCAL tmpt%
  302   SYS "XOS_File", 8, "PrinterChoices:"+name$
  303   f$="Printers:"+name$+".Resources.Support"
  304   SYS "OS_File",17,f$ TO d%,,load%  
  305   IF d%<>1 SYS "OS_File",19,f$,d%  
  306   IF(load% AND &FFF00000)<>&FFF00000     ERROR  254 ,FNmsg_1("FA3",name$)
  307   B%= &50555350 
  308   C%= 60 
  309   this_psup%=USR(code_entry%+ 12 )
  310   IF this_psup%=0 ERROR  253 , FNmsg_1(A%! 12 ,"FA5","PSUP")
  311   CASE(load% AND &FFF00)>>8 OF
  312     WHEN &FFB
  313       this_psup%! 24 = 1 
  314     WHEN &FFC
  315       this_psup%! 24 =0
  316     OTHERWISE
  317       B%= &50555350 
  318       C%=this_psup%
  319       CALL code_entry%+ 16 
  320       ERROR  254 ,FNmsg_1(A%! 12 ,          "FA3",name$)
  321   ENDCASE
  322   this_psup%! 0 =0
  323   $task_buff%=name$
  324   B%=task_buff%
  325   C%=2
  326   this_psup%! 4 =USR(code_entry%+ 28 )
  327   this_psup%! 8 =0
  328   this_psup%! 12 =0
  329   SYS "OS_File",17,FNpsup_res(this_psup%,"Resources.!Sprites")TO d%
  330   IF d%=1 THEN
  331     SYS "XOS_CLI","IconSprites "+FNpsup_res(this_psup%,"Resources.!Sprites") TO C%;d%
  332     IF(d%AND1) !C%= 253 :SYS"OS_GenerateError",C%
  333   ENDIF
  334   SYS "OS_File",17,FNpsup_res(this_psup%,"Resources.Messages")TO d%
  335   IF d%=1 THEN
  336     PROCmsg_initialise(FNpsup_res(this_psup%,"Resources.Messages"),d%)
  337     this_psup%! 16 =d%
  338   ELSE
  339     this_psup%! 16 =0
  340   ENDIF
  341   SYS "OS_File",17,FNpsup_res(this_psup%,"Resources.Templates")TO d%
  342   IF d%<>1 ERROR  254 ,FNmsg_1(A%! 12 ,"FA2",name$)
  343   PROCwin_template_open(FNpsup_res(this_psup%,"Resources.Templates"),FNpsup_res(this_psup%,"Resources.Template3D"))
  344   d%=0
  345   last_wind%=this_psup%+ 20 
  346   REPEAT
  347     PROCwin_get_next_name("",d%,name$)
  348     IF d% THEN
  349       PROCwin_load_create("",name$,1,h%)
  350       B%= &444E4957 
  351       C%= 16 +1+LEN name$
  352       this_wind%=USR(code_entry%+ 12 )
  353       IF this_wind%=0 ERROR  253 , FNmsg_1(A%! 12 ,"FA5","WIND")
  354       this_wind%! 0 =0
  355       this_wind%! 4 =h%
  356       this_wind%! 8 =0
  357       this_wind%! 12 =0
  358       $(this_wind%+ 16 )=name$
  359       !last_wind%=this_wind%
  360       last_wind%=this_wind%+ 0 
  361     ENDIF
  362   UNTIL d%=0
  363   PROCwin_template_close
  364   PROCprinter_reason_code(this_psup%,0,-1,0)
  365   IF NOT FNload_file(FNpsup_res(this_psup%,"Template"))     ERROR  254 ,FNmsg_1(A%! 12 ,"OK1a",        $this_psup%! 4 )
  366   PROCprocess_template(this_psup%)
  367   PROCrelease_file
  368   IF multiple_choices% THEN
  369     IF NOT FNload_file(FNpsup_multiple_res(this_psup%,unique_string$,"PrData")) THEN
  370       f$ =  "<Choices$Write>.Printers" +".Remote.ID"+unique_string$+"."+$this_psup%! 4 
  371       SYS "XOS_File", 8, f$
  372       f$ =  "<Choices$Write>.Printers" +".Remote.ID"+unique_string$+"."+$this_psup%! 4 +".PrData"
  373       d% = OPENOUT(f$)
  374       IF d% = 0 THEN
  375         ERROR  254 ,FNmsg_1(A%! 12 ,"OK1",            $this_psup%! 4 )
  376       ELSE
  377         tmpt% = this_psup%! 8 
  378         WHILE tmpt%
  379           BPUT#d%, $(tmpt%+ 12 )+":"
  380           BPUT#d%,"#"
  381           tmpt% = tmpt%! 0 
  382         ENDWHILE
  383         CLOSE#d%
  384         SYS "OS_File", 18, f$, &FC6  
  385         IF NOT FNload_file(FNpsup_multiple_res(this_psup%,unique_string$,"PrData"))           ERROR  254 ,FNmsg_1(A%! 12 ,"OK1",             $this_psup%! 4 )
  386       ENDIF
  387     ENDIF
  388   ELSE
  389   IF NOT FNload_file(FNpsup_res(this_psup%,"PrData"))     ERROR  254 ,FNmsg_1(A%! 12 ,"OK1",        $this_psup%! 4 )
  390   ENDIF
  391   PROCprocess_file(this_psup%)
  392   PROCrelease_file
  393   PROCread_paper_file(FNpsup_res(this_psup%,"Resources.PaperRO"), 0 )
  394   IF psup_head% THEN
  395     psup%=psup_head%
  396     WHILE psup%! 0 
  397       psup%=psup%! 0 
  398     ENDWHILE
  399     psup%! 0 =this_psup%
  400   ELSE
  401     psup_head%=this_psup%
  402   ENDIF
  403 ENDPROC
  404 DEF PROCtimeout_reinitialise
  405   LOCAL prnt%,psup%,t%
  406   timeout%=-1
  407   prnt%=A%! 48 
  408   WHILE prnt%
  409     psup%=prnt%! 4 
  410     IF psup%! 24  AND  8  THEN
  411       t%=10*psup%?( 24 +1)
  412       IF timeout%=-1 timeout%=t% ELSE IF t%<timeout% timeout%=t%
  413       prnt%! 56 =t%
  414     ELSE
  415       prnt%! 56 =-1
  416     ENDIF
  417     prnt%=prnt%! 0 
  418   ENDWHILE
  419   SYS "OS_ReadMonotonicTime" TO time_before%
  420 ENDPROC
  421 DEF FNinitialise_scrap
  422   LOCAL new_scrap$,f%,r0%,s$
  423   LOCAL prnt%, psup%, name$
  424   new_scrap$=FNtask_read_env("Wimp$ScrapDir", msg_text%)
  425   IF new_scrap$="" :=  0 
  426   IF new_scrap$<>last_scrap$ THEN
  427     SYS "XOS_File", 8,"<Wimp$ScrapDir>.Printers" TO r0%;f%  
  428     IF(f%AND1) THEN
  429       r0%+=4:CALL Z%,r0%,s$
  430       PROCerror_warning(FNmsg_2(A%! 12 ,"WA13","<Wimp$ScrapDir>.Printers",s$))
  431     ELSE
  432       last_scrap$ = new_scrap$
  433       IF sparrow_present% THEN
  434         SYS "XOS_File", 8, "<Wimp$ScrapDir>.Printers.RemQueue" TO r0%;f%
  435         IF(f%AND1)=0 SYS "XOS_File", 8, "<Wimp$ScrapDir>.Printers.RemSpool" TO r0%;f%
  436         IF(f%AND1) THEN
  437           r0%+=4:CALL Z%,r0%,s$
  438           PROCerror_warning(FNmsg_2(A%! 12 ,"WA13","<Wimp$ScrapDir>.Printers",s$))
  439         ENDIF
  440       ENDIF
  441       prnt% = A%! 48 
  442       WHILE prnt%
  443         IF prnt%! 24  AND  (1<<16)  THEN
  444           IF (prnt%! 40  = 0) THEN
  445             psup% = prnt%! 4 
  446             name$ = $(psup%! 4 )
  447           ELSE
  448             name$ = $(prnt%! 40 )
  449           ENDIF
  450           PROCshare_one_printer (prnt%)
  451         ENDIF
  452         prnt% = prnt%! 0 
  453       ENDWHILE
  454     ENDIF
  455   ENDIF
  456 =  -1 
  457 DEF PROCinitialise_settings
  458   LOCAL c%,d%,s$,ts%,name$,psup%,cnfg%,t%,name%,found_psup%, dosel%, err%
  459   LOCAL flags%, thing%, rmtp%, found%, odp%, idx%, str$, prnt%, side%, icon%, spr$, p%, sel%, s$, tmp%
  460   LOCAL odp%, odl%
  461     main_icon%=FNiconbar_tands(FNmsg_0(A%! 12 ,"NNE"),        "s"+FNmsg_0(A%! 12 ,"IC"),-5,&0F000000)
  462   got_icon%= -1 
  463   IF multiple_choices% THEN
  464     s$ =  "<Choices$Write>.Printers" +".Remote.ID"+unique_string$+".Settings"
  465     SYS "OS_File",17,s$ TO c%  
  466   ELSE
  467     SYS "OS_File",17, "<Choices$Write>.Printers" +".Settings" TO c%  
  468   ENDIF
  469   IF c%=1 THEN
  470     IF multiple_choices% THEN
  471       IF NOT FNload_file (s$)         ERROR  254 ,FNmsg_0(A%! 12 ,"OKD")
  472     ELSE
  473       IF NOT FNload_file( "<Choices$Write>.Printers" +".Settings")        ERROR  254 ,FNmsg_0(A%! 12 ,"OKD")
  474     ENDIF
  475     ts%=FNmatch_line("fv:")
  476     IF ts%=0 THEN
  477       PROCerror_box(FNmsg_0(A%! 12 ,"OKV"),1)
  478     ELSE
  479       IF FNevaluate($ts%)<>1 THEN
  480         PROCerror_box(FNmsg_0(A%! 12 ,"OKV"),1)
  481       ELSE
  482         PROCsparrow_local_file  
  483         REPEAT
  484           ts%=FNmatch_line("cl:")
  485           PROCsparrow_local_file_2
  486           flags% = 0
  487           thing% = FNmatch_line("fg:")
  488           IF thing% THEN
  489             flags% = FNevaluate ($thing%)
  490           ENDIF
  491           name%=FNmatch_line("sn:")
  492           IF name% name$=$name% ELSE name$=""
  493           PROCsparrow_restore_file_2
  494           IF (ts% > 0) AND ((flags% AND  (1<<17) ) = 0) AND (thing% > 0) THEN
  495             d%=INSTR($ts%,":")
  496             IF d%=0 d%=LEN $ts%+1
  497             s$=MID$($ts%,d%+1)
  498             $ts%=LEFT$($ts%,d%-1)
  499             psup%=psup_head%
  500             found_psup%= 0 
  501             WHILE psup% AND NOT found_psup%
  502               IF $psup%! 4 =$ts% found_psup%= -1 
  503               IF NOT found_psup% psup%=psup%! 0 
  504             ENDWHILE
  505             IF NOT found_psup% THEN
  506               PROClocal_file
  507               PROCinitialise_one_support_library($ts%)  
  508               PROCinitialise_one_psup($ts%,psup%)
  509               PROCrestore_file
  510               found_psup%= -1 
  511             ENDIF
  512             IF NOT found_psup% THEN
  513               name%=FNmatch_line("nm:")
  514               IF name% name$=$name% ELSE name$=""
  515               PROCerror_warning(FNmsg_2(A%! 12 ,"WA1",$ts%,name$))
  516             ELSE
  517               PROCinitialise_one_printer(psup%)
  518             ENDIF
  519           ENDIF
  520         UNTIL ts%=0
  521         PROCsparrow_restore_file  
  522         REPEAT
  523           ts%=FNmatch_line("cl:")
  524           odp% = !data_ptr%
  525           odl% = data_line%
  526           PROCsparrow_local_file
  527           flags% = 0
  528           thing% = FNmatch_line("fg:")
  529           IF thing% THEN
  530             flags% = FNevaluate ($thing%)
  531           ENDIF
  532           thing% = FNmatch_line("pn:")
  533           IF thing% str$=$thing% ELSE str$=""
  534           name%=FNmatch_line("sn:")
  535           IF name% name$=$name% ELSE name$=""
  536           PROCsparrow_restore_file
  537           IF (ts% > 0) AND ((flags% AND  (1<<17) ) > 0) AND (thing% > 0) THEN
  538             found% =  0 
  539             rmtp% = remote_printers%
  540             WHILE rmtp% AND NOT found%
  541               IF name$ = $rmtp%! 4  THEN
  542                 found% =  -1 
  543               ELSE
  544                 rmtp% = rmtp%! 0 
  545               ENDIF
  546             ENDWHILE
  547             IF NOT found% OR NOT sparrow_present% THEN
  548               p% = INSTR($ts%, ":")
  549               IF p% = 0 THEN 
  550                 p% = LEN$ts%
  551               ENDIF
  552               PROCadd_unavailable_printer (name$, MID$($t%,1,p%-1)," ")
  553             ELSE
  554               IF flags% AND  1  THEN
  555                 PROCsparrow_local_file
  556                 prnt% = FNensure_printer (rmtp%, flags%,  -1 ,  0 , err%)
  557                 PROCsparrow_restore_file
  558                 PROCsparrow_local_file
  559                 !data_ptr% = odp%
  560                 data_line% = odl%
  561                 PROCinitialise_one_remote_printer (prnt%)
  562                 PROCsparrow_restore_file
  563                 PROCremove_from_list (remote_printers%, $rmtp%! 4 )
  564                 IF flags% AND  2  THEN
  565                   prnt%! 24  = prnt%! 24  OR  2 
  566                 ELSE
  567                   prnt%! 24  = prnt%! 24  AND NOT  2 
  568                 ENDIF
  569                 d%=psize_head%
  570                 WHILE d%
  571                   IF $d%! 4 =str$ THEN
  572                     prnt%! 36 =d%
  573                     d%=0
  574                   ELSE
  575                     d%=d%! 0 
  576                     IF d%=0 THEN
  577                       d%=psize_head%
  578                       prnt%! 36 =d%
  579                       PROCerror_warning(FNmsg_3(A%! 12 ,"WA11",str$,$d%! 4 ,name$))
  580                       d%=0
  581                     ENDIF
  582                   ENDIF
  583                 ENDWHILE
  584               ENDIF
  585             ENDIF  
  586           ENDIF  
  587         UNTIL ts% = 0  
  588       ENDIF  
  589     ENDIF  
  590     PROCrelease_file
  591   ENDIF  
  592   PROCbroadcast_reason_code(A%! 48 ,-5,0)
  593   sel% =  0 
  594   prnt% = A%! 48 
  595   WHILE prnt%
  596     IF prnt%! 24  AND  2  THEN
  597       sel% =  -1 
  598       dosel% = prnt%
  599       prnt% = 0
  600     ELSE
  601       prnt% = prnt%! 0 
  602     ENDIF
  603   ENDWHILE
  604   prnt% = A%! 48 
  605   IF (NOT sel%) AND (prnt%) THEN
  606     PROCselect_printer (prnt%,  -1 ,  0 )
  607   ELSE 
  608     IF sel% AND dosel% THEN
  609       PROCselect_printer (dosel%,  -1 ,  0 )
  610     ENDIF
  611   ENDIF
  612 ENDPROC
  613 DEF PROCinitialise_one_printer(psup%)
  614   LOCAL ts%,prdt%,prnt%,d%,cnct%,h%,nm$,head%
  615   ts%=FNmatch_line_or_error("nm:")
  616   nm$=$ts%
  617   IF psup%! 44 >100 THEN
  618     PROCerror_warning(FNmsg_1(A%! 12 ,"WA7",nm$))
  619     ENDPROC
  620   ENDIF
  621   head%=psup%! 12 
  622   prdt%=head%! 4 
  623   WHILE prdt%>0
  624     IF $prdt%! 8 =nm$ THEN
  625       prdt%!(prdt%! 4 *4+ 8 )+=1
  626       prdt%=-1
  627     ELSE
  628       prdt%=prdt%! 0 
  629     ENDIF
  630   ENDWHILE
  631   IF prdt%=0 THEN
  632     PROCerror_warning(FNmsg_1(A%! 12 ,"WA8",nm$))
  633     ENDPROC
  634   ENDIF
  635   B%= &544E5250 
  636   C%= 68 
  637   prnt%=USR(code_entry%+ 12 )
  638   IF prnt%=0 ERROR  253 ,FNmsg_1(A%! 12 ,"FA5","PRNT")
  639   B%=ts%
  640   C%=2
  641   prnt%! 8 =USR(code_entry%+ 28 )
  642   prnt%! 0 =0
  643   prnt%! 4 =psup%
  644   IF psup%! 24  AND  8      prnt%! 56 =10*psup%?( 24 +1)   ELSE     prnt%! 56 =-1
  645   IF psup%! 24  AND  4  THEN
  646     h%=FNevaluate($FNmatch_line_or_error("cn:"))
  647     B%= &54434E43 
  648     C%=h%*4
  649     cnct%=USR(code_entry%+ 12 )
  650     IF cnct%=0 ERROR  253 ,FNmsg_1(A%! 12 ,"FA5","CNCT")
  651     prnt%! 12 =cnct%
  652     IF 0<=h%-1 THEN
  653       FOR d%=0 TO h%-1
  654         ts%=FNmatch_any_line
  655         IF ts% THEN
  656           ss%=FNmatch_string(ts%,"nl:")
  657           IF ss% THEN
  658             cnct%!(d%*4)=0
  659           ELSE
  660             ss%=FNmatch_string(ts%,"in:")
  661             IF ss% THEN
  662               cnct%!(d%*4)=FNstore_integer(FNevaluate($ss%))
  663             ELSE
  664               ss%=FNmatch_string(ts%,"st:")
  665               IF ss% THEN
  666                 B%=ss%
  667                 C%=2
  668                 cnfg%!(d%*4)=USR(code_entry%+ 28 )
  669               ELSE
  670                 ss%=FNmatch_string(ts%,"s0:")
  671                 IF ss% THEN
  672                   B%=ss%
  673                   C%=3
  674                   cnfg%!(d%*4)=USR(code_entry%+ 28 )
  675                 ELSE
  676                   ss%=FNmatch_string(ts%,"gs:")
  677                   IF ss% THEN
  678                     B%=ss%
  679                     C%=4
  680                     cnfg%!(d%*4)=USR(code_entry%+ 28 )
  681                   ELSE
  682                     ss%=FNmatch_string(ts%,"pt:")
  683                     IF ss% THEN
  684                       B%= &52544F50 
  685                       C%=4
  686                       cnct%!(d%*4)=USR(code_entry%+ 12 )
  687                       IF cnct%!(d%*4)=0                         ERROR  253 ,FNmsg_1(A%! 12 ,"FA5","POTR")
  688                       !cnct%!(d%*4)=FNfix_up_pointer($ss%, 0 )
  689                     ELSE
  690                       PROCsettings_error(FNmsg_1(A%! 12 ,"OKH",$ts%))
  691                     ENDIF
  692                   ENDIF
  693                 ENDIF
  694               ENDIF
  695             ENDIF
  696           ENDIF
  697         ENDIF
  698       NEXT          
  699     ENDIF
  700   ELSE
  701     B%= &54434E43 
  702     C%= 36 
  703     cnct%=USR(code_entry%+ 12 )
  704     IF cnct%=0       ERROR  253 ,FNmsg_1(A%! 12 ,"FA5","CNCT")
  705     prnt%! 12 =cnct%
  706     cnct%! 0 =FNevaluate($FNmatch_line_or_error("ct:"))
  707     cnct%! 4 =FNevaluate($FNmatch_line_or_error("bd:"))
  708     IFNOTFNsupport_higher_baudrates AND (cnct%? 4  > 15) THEN
  709       PROCerror_box(FNmsg_1(A%! 12 ,"OKAM",FNmsg_0(A%! 12 ,"BR"+STR$(cnct%? 4 ))),1)
  710       cnct%? 4  = 0
  711     ENDIF
  712     cnct%! 8 =FNevaluate($FNmatch_line_or_error("ft:"))
  713     C%=2
  714     B%=FNmatch_line_or_error("et:")
  715     cnct%! 12 =USR(code_entry%+ 28 )
  716     B%=FNmatch_line_or_error("fl:")
  717     cnct%! 16 =USR(code_entry%+ 28 )
  718     B%=FNmatch_line_or_error("ns:")
  719     cnct%! 20 =USR(code_entry%+ 28 )
  720     B%=FNmatch_line_or_error("np:")
  721     cnct%! 24 =USR(code_entry%+ 28 )
  722     B%=FNmatch_line_or_error("nu:")
  723     cnct%! 28 =USR(code_entry%+ 28 )
  724     B%=FNmatch_line_or_error("no:")
  725     cnct%! 32 =USR(code_entry%+ 28 )
  726     ts%=FNmatch_line("cf:")
  727     IF ts% THEN
  728       cnct%? 6 =FNevaluate($ts%)
  729     ELSE
  730       cnct%? 6 =0
  731     ENDIF
  732     CASE cnct%! 0  OF
  733       WHEN 4
  734         IF NOT FNeconet_installed THEN
  735           cnct%! 0 =0
  736           PROCerror_warning(FNmsg_2(A%! 12 ,"WA9",              $prnt%! 8 ,FNmsg_0(A%! 12 ,"CN4")))
  737         ENDIF
  738       WHEN 6
  739         IF NOT FNnfs_installed THEN
  740           cnct%! 0 =0
  741           PROCerror_warning(FNmsg_2(A%! 12 ,"WA9",              $prnt%! 8 ,FNmsg_0(A%! 12 ,"CN6")))
  742         ENDIF
  743     ENDCASE
  744   ENDIF
  745   h%=FNevaluate($FNmatch_line_or_error("cs:"))
  746   B%= &47464E43 
  747   C%=h%*4
  748   cnfg%=USR(code_entry%+ 12 )
  749   IF cnfg%=0     ERROR  253 ,FNmsg_1(A%! 12 ,"FA5","CNFG")
  750   prnt%! 16 =cnfg%
  751   IF 0<=h%-1 THEN
  752     FOR d%=0 TO h%-1
  753       ts%=FNmatch_any_line
  754       IF ts% THEN
  755         ss%=FNmatch_string(ts%,"nl:")
  756         IF ss% THEN
  757           cnfg%!(d%*4)=0
  758         ELSE
  759           ss%=FNmatch_string(ts%,"in:")
  760           IF ss% THEN
  761             cnfg%!(d%*4)=FNstore_integer(FNevaluate($ss%))
  762           ELSE
  763             ss%=FNmatch_string(ts%,"st:")
  764             IF ss% THEN
  765               B%=ss%
  766               C%=2
  767               cnfg%!(d%*4)=USR(code_entry%+ 28 )
  768             ELSE
  769               ss%=FNmatch_string(ts%,"s0:")
  770               IF ss% THEN
  771                 B%=ss%
  772                 C%=3
  773                 cnfg%!(d%*4)=USR(code_entry%+ 28 )
  774               ELSE
  775                 ss%=FNmatch_string(ts%,"gs:")
  776                 IF ss% THEN
  777                   B%=ss%
  778                   C%=4
  779                   cnfg%!(d%*4)=USR(code_entry%+ 28 )
  780                 ELSE
  781                   ss%=FNmatch_string(ts%,"pt:")
  782                   IF ss% THEN
  783                     B%= &52544F50 
  784                     C%=4
  785                     cnfg%!(d%*4)=USR(code_entry%+ 12 )
  786                     IF cnfg%!(d%*4)=0                       ERROR  253 ,FNmsg_1(A%! 12 ,"FA5","POTR")
  787                     !cnfg%!(d%*4)=FNfix_up_pointer($ss%, 0 )
  788                   ELSE
  789                     PROCsettings_error(FNmsg_1(A%! 12 ,"OKH",$ts%))
  790                   ENDIF
  791                 ENDIF
  792               ENDIF
  793             ENDIF
  794           ENDIF
  795         ENDIF
  796       ENDIF
  797     NEXT
  798   ENDIF
  799   prnt%! 20 =-1
  800   prnt%! 24 =FNevaluate($FNmatch_line_or_error("fg:"))
  801   prnt%! 28 =-1
  802   prnt%! 32 =0
  803   ts%=FNmatch_line_or_error("pn:")
  804   d%=psize_head%
  805   WHILE d%
  806     IF $d%! 4 =$ts% THEN
  807       prnt%! 36 =d%
  808       d%=0
  809     ELSE
  810       d%=d%! 0 
  811       IF d%=0 THEN
  812         d%=psize_head%
  813         prnt%! 36 =d%
  814         PROCerror_warning(FNmsg_3(A%! 12 ,"WA11",$ts%,$d%! 4 ,nm$))
  815         d%=0
  816       ENDIF
  817     ENDIF
  818   ENDWHILE
  819   C%=2
  820   B%=FNmatch_line_or_error("sn:")
  821   prnt%! 40 =USR(code_entry%+ 28 )
  822   B%=FNmatch_line_or_error("ic:")
  823   prnt%! 44 =USR(code_entry%+ 28 )
  824   IF psup%! 32  AND %100     prnt%! 48 =FNallocate_pause_window   ELSE     prnt%! 48 =0
  825   prnt%! 52 =0
  826   IF prnt%! 24  AND  1  THEN
  827     PROCcreate_printer_icon(prnt%)
  828     IF prnt%! 24  AND  2  THEN
  829       PROCselect_printer(prnt%, -1 , 0 )
  830     ENDIF
  831   ENDIF
  832   IF prnt%! 24  AND  (1<<16)  AND sparrow_present% THEN
  833     PROCshare_one_printer (prnt%)
  834   ENDIF
  835   d%=A%+ 48 
  836   WHILE !d%
  837     d%=!d%+ 0 
  838   ENDWHILE
  839   !d%=prnt%
  840   printer_count%+=1
  841   PROCtimeout_reinitialise
  842 ENDPROC
  843 DEF FNmatch_line_or_error(ts$)
  844   LOCAL ts%
  845   ts%=FNmatch_line(ts$)
  846   IF ts%=0 PROCsettings_error(FNmsg_1(A%! 12 ,"OKG",ts$))
  847 =ts%
  848 DEF PROCsettings_error(e$)
  849   PROCram_file_error(FNmsg_1(A%! 12 ,"OKE",e$))
  850 ENDPROC
  851 DEF FNpsup_res(psup%,s$)
  852 ="Printers:"+$psup%! 4 +"."+s$
  853 DEF FNone_of_ours(h%)
  854   LOCAL p%
  855   IF h%=-2 THEN = -1   
  856   IF h%=save_wind% THEN = -1 
  857   IF h%=shutdown% THEN = -1 
  858   IF h%=howquery% THEN = -1 
  859   IF h%=papersize% THEN = -1 
  860   IF h%=query% THEN = -1 
  861   IF h%=A%! 40  THEN = -1 
  862   IF h%=connections% THEN = -1 
  863   IF h%=prntctrl% THEN = -1 
  864   IF h%=info% THEN = -1 
  865   p%=A%! 48 
  866   WHILE p%
  867     IF p%! 48 =h% THEN = -1 
  868     p%=p%! 0 
  869   ENDWHILE
  870 = 0 
  871 DEF PROCinitialise_windows
  872   LOCAL i%,fmt$,tr$,p1%,p2%,p3%,p4%,j%
  873   PROCwin_template_open("Printers:Templates","Printers:Template3D")
  874   PROCwin_load_create("","info",1,info%)
  875   PROCwin_load_create("","prntctrl",1,prntctrl%)
  876   PROCwin_load_create("","connections",1,connections%)
  877   PROCwin_load_create("","queue",1,A%! 40 )
  878   PROCwin_load_create("","query",1,query%)
  879   PROCwin_load_create("","papersize",1,papersize%)
  880   PROCwin_load_create("","howquery",1,howquery%)
  881   PROCwin_load_create("","shutdown",1,shutdown%)
  882   PROCwin_load_create("","save",1,save_wind%)
  883   PROCwin_template_close
  884   PROCicon_write(info%,3,FNmsg_0(A%! 12 ,"VSN"))
  885   FOR j%=0 TO 5
  886     B%= &46444349 
  887     C%=40
  888     i%=USR(code_entry%+ 12 )
  889     IF i%=0       ERROR  253 ,          FNmsg_1(A%! 12 ,"FA5","ICDF")
  890     !i%=A%! 40 
  891     i%!4=j%
  892     SYS "Wimp_GetIconState",,i%
  893     SYS "Wimp_DeleteIcon",,i%
  894     A%!( 52 +4*j%)=i%+8
  895   NEXT
  896   FOR j%=0 TO 4
  897     B%= &46444349 
  898     C%=40
  899     i%=USR(code_entry%+ 12 )
  900     IF i%=0       ERROR  253 ,          FNmsg_1(A%! 12 ,"FA5","ICDF")
  901     !i%=prntctrl%
  902     i%!4=j%
  903     SYS "Wimp_GetIconState",,i%
  904     IF j%=4 THEN
  905       SYS "Wimp_DeleteIcon",,i%
  906     ELSE
  907       B%= &58585858 
  908       C%=i%!36+1
  909       i%!28=USR(code_entry%+ 12 )
  910       IF i%!28=0         ERROR  253 ,            FNmsg_1(A%! 12 ,"FA5","XXXX")
  911     ENDIF
  912     prntctrl_icdf%(j%)=i%+8
  913   NEXT
  914   FOR j%=0 TO 3
  915     prntctrl_icdf%(j%)!16 = prntctrl_icdf%(4)!16
  916   NEXT
  917   FOR j%=0 TO 3
  918     PROCicon_write(prntctrl%,j%,        FNmsg_0(A%! 12 ,        FNicon_read(prntctrl%,j%)))
  919   NEXT
  920 ENDPROC
  921 DEF FNmax(a,b): IF a>b THEN =a ELSE =b
  922 DEF FNallocate_pause_window
  923   LOCAL p%
  924   PROCwin_template_open("Printers:Templates","Printers:Template3D")
  925   PROCwin_load_create("","pause",1,p%)
  926   PROCwin_template_close
  927 =p%
  928 DEF PROCdeallocate_pause_window(handle%)
  929   !buff1%=handle%
  930   SYS "Wimp_GetWindowInfo",,buff1% OR 1
  931   B%= &46465542 
  932   C%=buff1%!76
  933   CALL code_entry%+ 16 
  934   SYS "Wimp_DeleteWindow",,buff1%
  935 ENDPROC
  936 DEF PROCredraw_window
  937   LOCAL more%,i%,t$,con$,prnt%,psup%,wind%
  938   LOCAL rmtp%
  939   CASE !task_buff% OF
  940     WHEN A%! 40 
  941       SYS "Wimp_RedrawWindow",,task_buff% TO more%
  942       B%=task_buff%
  943       C%=more%
  944       CALL code_entry%+ 36 
  945     WHEN prntctrl%
  946       SYS "Wimp_RedrawWindow",,task_buff% TO more%
  947       WHILE more%
  948         FOR i%=0 TO 3
  949           prntctrl_icdf%(i%)!4=prntctrl_icdf%(4)!4
  950           prntctrl_icdf%(i%)!12=prntctrl_icdf%(4)!12
  951         NEXT
  952         prnt%=A%! 48 
  953         prnt_count%=0
  954         WHILE prnt%
  955           prnt_count%+=1
  956           IF prnt%! 40  THEN
  957             $prntctrl_icdf%(0)!20=$prnt%! 40 
  958           ELSE
  959             ?prntctrl_icdf%(0)!20=13
  960           ENDIF
  961           $prntctrl_icdf%(1)!20=$prnt%! 8 
  962           t$=STR$ !(prnt%! 12 + 0 )
  963           con$=FNmsg_0(A%! 12 ,"IC"+t$)
  964           IF con$="IC"+t$               con$=FNmsg_1(A%! 12 ,"ICx",t$)
  965           $prntctrl_icdf%(2)!20=con$
  966           IF prnt%! 24  AND  (1<<16)  THEN
  967              t$ = "SHA"
  968           ELSE 
  969             IF prnt%! 24  AND  1  THEN
  970               t$="ACT"
  971             ELSE
  972               t$="INA"
  973             ENDIF
  974           ENDIF
  975           $prntctrl_icdf%(3)!20=FNmsg_0(A%! 12 ,t$)
  976           FOR i%=0 TO 3
  977             SYS "Wimp_PlotIcon",,prntctrl_icdf%(i%)
  978             prntctrl_icdf%(i%)!12=prntctrl_icdf%(i%)!4
  979             prntctrl_icdf%(i%)!4-=(prntctrl_icdf%(4)!12 - prntctrl_icdf%(4)!4)
  980           NEXT
  981           prnt%=prnt%! 0 
  982         ENDWHILE
  983         rmtp% = remote_printers%
  984         WHILE rmtp%
  985           $prntctrl_icdf%(0)!20 = $rmtp%! 4 
  986           $prntctrl_icdf%(1)!20 = $rmtp%! 8 
  987           $prntctrl_icdf%(2)!20 = FNmsg_0 (A%! 12 , "IC9")
  988           IF rmtp%! 20  > 0 THEN
  989             $prntctrl_icdf%(3)!20 = FNmsg_0 (A%! 12 , "UNA")
  990           ELSE
  991             $prntctrl_icdf%(3)!20 = FNmsg_0 (A%! 12 , "INA")
  992           ENDIF
  993           FOR i%=0 TO 3
  994             SYS "Wimp_PlotIcon",,prntctrl_icdf%(i%)
  995             prntctrl_icdf%(i%)!12=prntctrl_icdf%(i%)!4
  996             prntctrl_icdf%(i%)!4-=(prntctrl_icdf%(4)!12 - prntctrl_icdf%(4)!4)
  997           NEXT
  998           rmtp% = rmtp%! 0 
  999         ENDWHILE
 1000         SYS "Wimp_GetRectangle",,task_buff% TO more%
 1001       ENDWHILE
 1002     OTHERWISE
 1003       PROCprinter_find_handle(!task_buff%,wind%,psup%,prnt%)
 1004       PROCprinter_reason_code(psup%,prnt%,1,task_buff%)
 1005   ENDCASE
 1006 ENDPROC
 1007 DEF PROCopen_pause_window(prnt%)
 1008   LOCAL y%,s$
 1009   IF prnt%! 40  s$=$prnt%! 40  ELSE s$=$prnt%! 8 
 1010   PROCwin_title(prnt%! 48 ,FNmsg_1(A%! 12 ,"PAU",s$))
 1011   !buff1%=-2
 1012   SYS "Wimp_GetWindowState",,buff1%
 1013   y%=buff1%!4-buff1%!20
 1014   buff1%!4=prnt%! 20 
 1015   SYS "Wimp_GetIconState",,buff1%
 1016   y%+=buff1%!16-680  
 1017   !buff1%=prnt%! 48 
 1018   SYS "Wimp_GetWindowState",,buff1%
 1019   buff1%!12=(buff1%!12-buff1%!4)+y%
 1020   buff1%!16=140+240  
 1021   buff1%!4=y%
 1022   buff1%!8=buff1%!16-240
 1023   buff1%!28=-1
 1024   SYS "Wimp_OpenWindow",,buff1%
 1025 ENDPROC
 1026 DEF PROCtell_pinboard(handle%)
 1027 !buff1%=24
 1028 buff1%!12=0
 1029 buff1%!16=&400CB
 1030 buff1%!20=handle%
 1031 SYS"Wimp_SendMessage",17,buff1%,0
 1032 ENDPROC
 1033 DEF PROCclose_window
 1034   LOCAL i%,j%,prnt%,psup%,wind%
 1035   PROCtell_pinboard(!task_buff%)
 1036   IF FNone_of_ours(!task_buff%)THEN
 1037     SYS "Wimp_CloseWindow",,task_buff%
 1038   ELSE
 1039     PROCprinter_find_handle(!task_buff%,wind%,psup%,prnt%)
 1040     PROCprinter_reason_code(psup%,prnt%,3,task_buff%)
 1041   ENDIF
 1042 ENDPROC
 1043 DEF PROCfree_structure(p%)
 1044   LOCAL i%
 1045   IF p%=0 ENDPROC
 1046   CASE p%!-4 OF
 1047     WHEN  &4454534C 
 1048       WHILE p%
 1049         IF 0<=p%! 4 -1 THEN
 1050           FOR i%=0 TO p%! 4 -1
 1051             PROCfree_structure(p%!(i%*4+ 8 ))
 1052           NEXT
 1053         ENDIF
 1054         i%=p%! 0 
 1055         B%= &4454534C 
 1056         C%=p%
 1057         CALL code_entry%+ 16 
 1058         p%=i%
 1059       ENDWHILE
 1060     WHEN  &4C4f4F42 
 1061       PROCfree_structure(p%! 0 )
 1062       PROCfree_structure(p%! 4 )
 1063       B%= &4C4f4F42 
 1064       C%=p%
 1065       CALL code_entry%+ 16 
 1066     WHEN  &47544E49 , &47525453 , &30525453 , &52545347 , &52544F50 
 1067       B%=p%!-4
 1068       C%=p%
 1069       CALL code_entry%+ 16 
 1070     WHEN  &52414843 
 1071       WHILE p%
 1072         i%=!p%
 1073         B%= &52414843 
 1074         C%=p%
 1075         CALL code_entry%+ 16 
 1076         p%=i%
 1077       ENDWHILE
 1078     OTHERWISE
 1079       ERROR  253 ,FNmsg_1(A%! 12 ,"FAA",STR$~(p%-4))
 1080   ENDCASE
 1081 ENDPROC
 1082 DEF PROCreceive(r%)
 1083   LOCAL s$,prnt%,psup%,wind%,to%,i%
 1084   to%=task_buff%!4
 1085   CASE task_buff%!16 OF
 1086     WHEN 0  
 1087       PROCdestroy_queue
 1088       PROChost_shutdown
 1089     WHEN 1  
 1090       PROCdatasave
 1091     WHEN 2  
 1092       IF NOT task_buff%!36 THEN
 1093         SYS "Wimp_CreateMenu",,-1
 1094         i%=task_buff%+44
 1095         CALL Z%,i%,s$  
 1096         PROCicon_write(connections%, 30 ,s$)
 1097       ENDIF
 1098     WHEN 3  
 1099       PROCdataload
 1100     WHEN 5  
 1101       IF task_buff%!40=&FC6 THEN
 1102         task_buff%!12=task_buff%!8
 1103         task_buff%!16=4
 1104         SYS "Wimp_SendMessage",17,task_buff%,to%
 1105         PROCadd_to_prdata
 1106       ENDIF
 1107     WHEN 8  
 1108       IF A%! 32  THEN
 1109         IF!task_buff%<>20 THEN
 1110           IF(task_buff%!20 AND 1)=0 shutdown_type%=1 ELSE shutdown_type%=2
 1111         ELSE
 1112           shutdown_type%=1
 1113         ENDIF
 1114         task_buff%!12=task_buff%!8
 1115         SYS "Wimp_SendMessage",19,task_buff%,to%
 1116         A%! 20 =A%! 20  OR 1
 1117         PROCmenu_window_centre(shutdown%)
 1118       ENDIF
 1119     WHEN 10  
 1120       BPUT#task_buff%!20,"/"+FNtask_read_env("Printers$Dir",buff1%)
 1121     WHEN 11  
 1122       prnt%=A%! 48 
 1123       WHILE prnt%
 1124         IF(prnt%! 24  AND  8 )<>0 AND prnt%<>claim_ref% THEN
 1125           r%=prnt%! 12 
 1126           IF r%! 0 =task_buff%!20 AND task_buff%!24<=0 THEN
 1127             s$=FNmsg_0(A%! 12 ,"INU")
 1128             !task_buff%=32+LEN s$ AND NOT 3
 1129             task_buff%!12=task_buff%!8
 1130             task_buff%!16=12  
 1131             $(task_buff%+28)=s$+CHR$ 0
 1132             SYS "Wimp_SendMessage",17,task_buff%,to%
 1133             prnt%=0
 1134           ENDIF
 1135         ENDIF
 1136         IF prnt% prnt%=prnt%! 0 
 1137       ENDWHILE
 1138     WHEN 12  
 1139       claim_state%=2
 1140     WHEN &502  
 1141       IF FNone_of_ours(task_buff%!32)THEN
 1142         PROCdetermine_help
 1143       ELSE
 1144         PROCprinter_find_handle(task_buff%!32,wind%,psup%,prnt%)
 1145         IF wind% THEN
 1146           PROCprinter_reason_code(psup%,prnt%,r%,task_buff%)
 1147         ELSE
 1148           IF NOT task_buff%!36 THEN
 1149             IF menu_prnt%               PROCprinter_reason_code (menu_prnt%! 4 ,                  menu_prnt%,r%,task_buff%)             ELSE               PROCdetermine_help
 1150           ENDIF
 1151         ENDIF
 1152       ENDIF
 1153     WHEN &400C9
 1154       IF task_buff%!20=shutdown% THEN
 1155         IFA%! 32 >0  A%! 20  = A%! 20  AND NOT 1
 1156       ELSE
 1157         PROCcancel_menued_item
 1158       ENDIF
 1159     WHEN &80141
 1160       A%! 36 = 0 
 1161     WHEN &80142
 1162       IF selected_prnt% THEN
 1163         task_buff%!20=-2
 1164         task_buff%!24=selected_prnt%! 20 
 1165         PROCdatasave
 1166       ELSE
 1167         prnt%=A%! 48 
 1168         IFprnt% THEN
 1169           task_buff%!20=1
 1170           s$=FNmsg_0(A%! 12 ,"OKU")+CHR$ 0
 1171         ELSE
 1172           task_buff%!20=2
 1173           s$=FNmsg_0(A%! 12 ,"OKW")+CHR$ 0
 1174         ENDIF
 1175         !task_buff%=28+LEN s$ AND NOT 3
 1176         task_buff%!12=task_buff%!8
 1177         task_buff%!16=&80144  
 1178         $(task_buff%+24)=s$+CHR$ 0
 1179         SYS "Wimp_SendMessage",17,task_buff%,to%
 1180       ENDIF
 1181     WHEN &80143
 1182       IF task_buff%!4<>task_handle% THEN
 1183         IF task_buff%!0=20 THEN
 1184           PROCdestroy_queue
 1185           PROChost_shutdown
 1186         ELSE
 1187           IF task_buff%!12=task_your_ref% THEN
 1188             PROCerror_warning(FNmsg_0(A%! 12 ,"FAJ"))
 1189             PROCdestroy_queue
 1190             PROChost_shutdown
 1191           ELSE
 1192             task_buff%!12=task_buff%!8
 1193             task_buff%!20=34  
 1194             SYS "Wimp_SendMessage",17,task_buff%,to%
 1195           ENDIF
 1196         ENDIF
 1197       ENDIF
 1198     WHEN &80146
 1199       type_state%=2
 1200     WHEN &80152
 1201       IF selected_prnt% THEN
 1202         PROCselect_printer(selected_prnt%, -1 , 0 )
 1203       ENDIF
 1204     OTHERWISE
 1205       IFFNinitialise_scrap
 1206       PROCbroadcast_reason_code(selected_prnt%,r%,task_buff%)
 1207   ENDCASE
 1208 ENDPROC
 1209 DEF PROCdetermine_help
 1210   LOCAL s$,prnt%,token$
 1211   CASE task_buff%!32 OF
 1212     WHEN -2
 1213       IF A%! 48 =0 THEN
 1214         PROCinteractive_help(FNmsg_0(A%! 12 ,"ICON0"))
 1215         ENDPROC
 1216       ENDIF
 1217       PROCmatch_icon(task_buff%!36,prnt%)
 1218       IF prnt%! 40            s$=$prnt%! 40  ELSE s$=$prnt%! 8 
 1219       PROCinteractive_help(FNmsg_1(A%! 12 ,"ICON1",s$))
 1220     WHEN save_wind%
 1221       s$=FNmsg_0(A%! 12 ,"SAVE"+STR$ task_buff%!36)
 1222       IF s$="SAVE"+STR$ task_buff%!36 s$=FNmsg_0(A%! 12 ,"SAVE")
 1223       PROCinteractive_help(s$)
 1224     WHEN shutdown%
 1225       s$=FNmsg_0(A%! 12 ,"SHTDWN"+STR$ task_buff%!36)
 1226       IF s$="SHTDWN"+STR$ task_buff%!36 s$=FNmsg_0(A%! 12 ,"SHTDWN")
 1227       PROCinteractive_help(s$)
 1228     WHEN howquery%
 1229       s$=FNmsg_0(A%! 12 ,"HWQRY"+STR$ task_buff%!36)
 1230       IF s$="HWQRY"+STR$ task_buff%!36 s$=FNmsg_0(A%! 12 ,"HWQRY")
 1231       PROCinteractive_help(s$)
 1232     WHEN papersize%
 1233       s$=FNmsg_0(A%! 12 ,"PAPER"+STR$ task_buff%!36)
 1234       IF s$="PAPER"+STR$ task_buff%!36 s$=FNmsg_0(A%! 12 ,"PAPER")
 1235       PROCinteractive_help(s$)
 1236     WHEN query%
 1237       s$=FNmsg_0(A%! 12 ,"QUERY"+STR$ task_buff%!36)
 1238       IF s$="QUERY"+STR$ task_buff%!36 s$=FNmsg_0(A%! 12 ,"QUERY")
 1239       PROCinteractive_help(s$)
 1240     WHEN A%! 40 
 1241       PROCinteractive_help(FNmsg_0(A%! 12 ,"QUEUE"))
 1242     WHEN connections%
 1243       token$="CNCT"+STR$ task_buff%!36
 1244       IF task_buff%!36= 13  THEN
 1245         IF FNicon_set(connections%, 13 )token$+="b" ELSE token$+="a"
 1246       ENDIF
 1247       IF task_buff%!36= 35  THEN
 1248         IF FNicon_set(connections%, 35 ) token$+="b" ELSE token$+="a"
 1249       ENDIF
 1250       IF task_buff%!36= 37  THEN
 1251         IF FNicon_set(connections%, 37 ) token$+="b" ELSE token$+="a"
 1252       ENDIF
 1253       s$=FNmsg_0(A%! 12 ,token$)
 1254       IF s$=token$ s$=FNmsg_0(A%! 12 ,"CNCT")
 1255       PROCinteractive_help(s$)
 1256     WHEN prntctrl%
 1257       PROCinteractive_help(FNmsg_0(A%! 12 ,"PRCTRL"))
 1258     WHEN info%
 1259       PROCinteractive_help(FNmsg_0(A%! 12 ,"INFO"))
 1260     OTHERWISE  
 1261       SYS "Wimp_GetMenuState",1,win_buff%,task_buff%!32,task_buff%!36
 1262       CASE menu_chsn$ OF
 1263         WHEN "ME1"
 1264           IF!win_buff%<>2 THEN
 1265             PROCinteractive_help(FNmsg_0(A%! 12 ,"HME1-"+STR$!win_buff%))
 1266           ELSE
 1267             IF A%! 44 =0 THEN
 1268               PROCinteractive_help(FNmsg_0(A%! 12 ,"HME1-2a"))
 1269             ELSE
 1270               PROCinteractive_help(FNmsg_0(A%! 12 ,"HME1-2"))
 1271             ENDIF
 1272           ENDIF
 1273         WHEN "ME2","ME3","ME4","ME5","ME6","MP1"
 1274           PROCinteractive_help(FNmsg_0(A%! 12 ,"H"+menu_chsn$))
 1275         WHEN "MQ1"
 1276           IF FNmenu_shade(menu_top%,!win_buff%)THEN
 1277             IF !win_buff%>3 AND menued_queu%=0 THEN
 1278               PROCinteractive_help(FNmsg_0(A%! 12 ,"SMQ1-7"))
 1279             ELSE
 1280               PROCinteractive_help(FNmsg_0(A%! 12 ,"SMQ1-"+STR$(!win_buff%)))
 1281             ENDIF
 1282           ELSE
 1283             IF !win_buff%<>4 THEN
 1284               PROCinteractive_help(FNmsg_0(A%! 12 ,"HMQ1-"+STR$(!win_buff%)))
 1285             ELSE
 1286               IF menued_queu%! 12  THEN
 1287                 PROCinteractive_help(FNmsg_0(A%! 12 ,"HMQ1-4a"))
 1288               ELSE
 1289                 PROCinteractive_help(FNmsg_0(A%! 12 ,"HMQ1-4b"))
 1290               ENDIF
 1291             ENDIF
 1292           ENDIF
 1293         WHEN "MC1"
 1294           IF FNmenu_shade(menu_top%,!win_buff%)THEN
 1295             IF !win_buff%=6 THEN
 1296               PROCinteractive_help(FNmsg_0(A%! 12 ,"SMC1-6"))
 1297               ENDPROC
 1298             ENDIF
 1299             SYS "Wimp_WhichIcon",prntctrl%,buff1%,1<<21,1<<21
 1300             IF !buff1%=-1 THEN
 1301               PROCinteractive_help(FNmsg_0(A%! 12 ,"SMC1-2"))
 1302             ELSE
 1303               PROCinteractive_help(FNmsg_0(A%! 12 ,"SMC1-0"))
 1304             ENDIF
 1305           ELSE
 1306             PROCinteractive_help(FNmsg_0(A%! 12 ,"HMC1-"+STR$!win_buff%))
 1307           ENDIF
 1308         WHEN "MC1s"
 1309           IF FNmenu_shade(menu_top%,!win_buff%)THEN
 1310             IF !win_buff%=7 THEN
 1311               PROCinteractive_help(FNmsg_0(A%! 12 ,"SMC1s-7"))
 1312               ENDPROC
 1313             ENDIF
 1314             IF !win_buff%=2 AND sparrow_present%= 0  THEN
 1315               PROCinteractive_help(FNmsg_0(A%! 12 ,"SMC1s-2"))
 1316               ENDPROC
 1317             ENDIF
 1318             SYS "Wimp_WhichIcon",prntctrl%,buff1%,1<<21,1<<21
 1319             IF !buff1%=-1 THEN
 1320               PROCinteractive_help(FNmsg_0(A%! 12 ,"SMC1s-3"))
 1321             ELSE
 1322               PROCinteractive_help(FNmsg_0(A%! 12 ,"SMC1s-0"))
 1323             ENDIF
 1324           ELSE
 1325             PROCinteractive_help(FNmsg_0(A%! 12 ,"HMC1s-"+STR$!win_buff%))
 1326           ENDIF
 1327       ENDCASE
 1328   ENDCASE
 1329 ENDPROC
 1330 DEF PROCinteractive_help(m$)
 1331   LOCAL to%
 1332   !task_buff%=24+LEN m$ AND NOT 3
 1333   task_buff%!12=task_buff%!8
 1334   task_buff%!16=&503  
 1335   $(task_buff%+20)=m$+CHR$ 0
 1336   to%=task_buff%!4
 1337   SYS "Wimp_SendMessage",17,task_buff%,to%
 1338 ENDPROC
 1339 DEF PROCdatasave
 1340   LOCAL s$,i%,y%,prnt%,queu%
 1341   IF task_buff%!20=A%! 40  THEN
 1342     !win_buff%=A%! 40 
 1343     SYS "Wimp_GetWindowState",,win_buff%
 1344     B%=task_buff%!32-win_buff%!16+win_buff%!24  
 1345     y%=USR(code_entry%+ 44 )
 1346     i%=A%! 16 
 1347     prnt%=!i%
 1348     queu%=i%!4
 1349     IF prnt% THEN
 1350       task_buff%!20=-2
 1351       task_buff%!24=prnt%! 20 
 1352     ENDIF
 1353   ELSE
 1354     PROCmatch_icon(task_buff%!24, prnt%)
 1355   ENDIF
 1356   IF task_buff%!20<>-2       ERROR  254 ,FNmsg_0(A%! 12 ,"OKN")
 1357   i%=task_buff%+44
 1358   CALL Z%,i%,s$  
 1359   i%=LEN s$
 1360   WHILE i%>0
 1361    IF MID$(s$,i%,1)="." OR MID$(s$,i%,1)=":" THEN
 1362      s$=MID$(s$,i%+1)
 1363      i%=0
 1364    ENDIF
 1365    i%-=1
 1366   ENDWHILE
 1367   queue_leafname$=s$
 1368   A%! 36 = 0 
 1369   queue_temphand%=task_buff%!4
 1370   s$=FNtemporary_name( -1 )
 1371   IF (prnt%! 32 )<>0 OR (prnt%! 24  AND  36 )<>0 THEN
 1372     SYS "XOS_SetVarVal","Printer$Temp",,-1
 1373     task_buff%!0=48+LEN s$ AND NOT 3
 1374     task_buff%!12=task_buff%!8
 1375     task_buff%!16=2  
 1376     task_buff%!36=-1  
 1377     $(task_buff%+44)=s$+CHR$ 0
 1378     SYS "Wimp_SendMessage",17,task_buff%,queue_temphand%
 1379     queue_tempref%=task_buff%!8
 1380   ELSE
 1381     task_buff%!12=task_buff%!8
 1382     SYS "Wimp_SendMessage",19,task_buff%,queue_temphand%
 1383     PROCselect_printer(prnt%, 0 , 0 )
 1384     SYS "OS_SetVarVal","Printer$Temp",s$,LEN s$
 1385     task_buff%!16=&80140  
 1386     SYS "Wimp_SendMessage",18,task_buff%,queue_temphand%
 1387     PROCsave_sender_info (queue_temphand%, queue_leafname$)
 1388   ENDIF
 1389 ENDPROC
 1390 DEF FNtemporary_name(generate_error%)
 1391   LOCAL c%
 1392   IFNOTFNinitialise_scrap THEN
 1393     IFgenerate_error% THEN
 1394       ERROR  254 , FNmsg_0(A%! 12 , "OKAO")
 1395     ELSE
 1396       PROCerror_box(FNmsg_0(A%! 12 , "OKAO"),1)
 1397       =""
 1398     ENDIF
 1399   ENDIF
 1400   REPEAT
 1401     temp_count%+=1
 1402     SYS "OS_File",17,"<Wimp$ScrapDir>.Printers."+STR$ temp_count% TO c%
 1403   UNTIL c%=0
 1404 =FNgstrans("<Wimp$ScrapDir>.Printers."+STR$ temp_count%)
 1405 DEF PROCdataload
 1406   LOCAL s$,i%,prnt%,sender$,leaf$,type%,to%
 1407   IF task_buff%!40=&FC6 AND task_buff%!20=prntctrl% THEN
 1408     PROCadd_to_prdata
 1409     ENDPROC
 1410   ENDIF
 1411   i%=task_buff%+44
 1412   CALL Z%,i%,leaf$  
 1413   SYS"OS_File",17,leaf$ TO type%
 1414   IF(type%AND2) AND (task_buff%!40<&1000) task_buff%!40=&1000
 1415   IF task_buff%!20=A%! 40  THEN
 1416     !win_buff%=A%! 40 
 1417     SYS "Wimp_GetWindowState",,win_buff%
 1418     B%=task_buff%!32-win_buff%!16+win_buff%!24  
 1419     y%=USR(code_entry%+ 44 )
 1420     i%=A%! 16 
 1421     prnt%=!i%
 1422     queu%=i%!4
 1423     IF prnt% THEN
 1424       task_buff%!20=-2
 1425       task_buff%!24=prnt%! 20 
 1426     ENDIF
 1427   ENDIF
 1428   IF task_buff%!20<>-2       ERROR  254 ,FNmsg_0(A%! 12 ,"OKN")
 1429   A%! 36 =      queue_tempref%<>0 AND queue_tempref%=task_buff%!12
 1430   task_buff%!12=task_buff%!8
 1431   task_buff%!16=4  
 1432   to%=task_buff%!4
 1433   SYS "Wimp_SendMessage",17,task_buff%,to%
 1434   queue_tempref%=0
 1435   PROCmatch_icon(task_buff%!24,prnt%)
 1436   type%=task_buff%!40
 1437   IF prnt%=0 THEN
 1438     IF type%<>&FC6 ERROR  254 ,FNmsg_0(A%! 12 ,"OKW")
 1439     PROCadd_to_prdata
 1440     ENDPROC
 1441   ENDIF
 1442   IF A%! 36  THEN
 1443     SYS "TaskManager_TaskNameFromHandle",queue_temphand% TO i%
 1444     CALL Z%,i%,sender$  
 1445     leaf$=queue_leafname$
 1446     s$=FNtask_read_env("Printer$Temp",buff1%)
 1447     IF s$="" i%=task_buff%+44: CALL Z%,i%,s$  
 1448   ELSE
 1449     i%=task_buff%+44: CALL Z%,i%,s$  
 1450     i%=LEN s$: WHILE MID$(s$,i%,1)<>".": i%-=1: ENDWHILE
 1451     leaf$=MID$(s$,i%+1)
 1452     i%=1: WHILE MID$(s$,i%,1)<>".": i%+=1: ENDWHILE
 1453     sender$=LEFT$(s$,i%-1)
 1454   ENDIF
 1455   PROCadd_queue_entry(A%! 36 ,sender$,s$,leaf$,      prnt%,type%)
 1456 ENDPROC
 1457 DEF PROCcancel_menued_item
 1458   CASE menu_chsn$ OF
 1459     WHEN "MQ1"
 1460       IF menued_prnt% THEN
 1461         IF menued_queu%           menued_queu%? 11 =              menued_queu%? 11  AND NOT 8         ELSE           menued_prnt%! 24 =              menued_prnt%! 24  AND NOT  16 
 1462         PROCredraw_queue_entry(-1,menued_prnt%,menued_queu%)
 1463         menued_y%=0
 1464         menued_prnt%=0
 1465         menued_queu%=0
 1466       ENDIF
 1467     WHEN "MC1", "MC1s"
 1468       SYS "Wimp_WhichIcon",prntctrl%,buff1%,1<<21,1<<21
 1469       IF NOT !buff1% AND buff1%!4=-1 AND select_all%= 0  PROCicon_deselect(prntctrl%,!buff1%)
 1470   ENDCASE
 1471   menu_chsn$=""
 1472 ENDPROC
 1473 DEF PROCack
 1474   LOCAL s$,prnt%,queu%,cnct%,spooling%,spool_file$,psup%,ptmp$,t%,load%,    size%,from%,leaf$
 1475   LOCAL qname$, prnt%, found%, sname$, name$, application$
 1476   CASE task_buff%!16 OF
 1477     WHEN 11  
 1478       claim_state%=1
 1479     WHEN &80140  
 1480       PROCmatch_icon(task_buff%!24,prnt%)
 1481       IF prnt%=0           ERROR  254 ,FNmsg_0(A%! 12 ,"OKW")
 1482       queu%=prnt%! 32 
 1483       psup%=prnt%! 4 
 1484       cnct%=prnt%! 12 
 1485       IF queu%=0 AND(prnt%! 24  AND  36 )=0 THEN
 1486         i%=task_buff%+44: CALL Z%,i%,leaf$
 1487         CASE cnct%! 0  OF
 1488          WHEN 5
 1489           spooling%=(cnct%? 6  AND 2)<>0
 1490          WHEN 9
 1491           spooling% =  0 
 1492          OTHERWISE
 1493           spooling%=(cnct%? 6  AND 1)<>0
 1494         ENDCASE
 1495         IF spooling% THEN
 1496           printer_output$=FNtemporary_name( -1 )
 1497           IFcnct%! 0 =5 THEN
 1498            SYS "OS_SetVarVal","PrinterType$5",printer_output$,LEN printer_output$
 1499            PROCfx5(5)
 1500           ELSE
 1501            SYS "OS_SetVarVal","PrinterType$10",printer_output$,LEN printer_output$
 1502            PROCfx5(10)
 1503           ENDIF
 1504           spool_file$=printer_output$
 1505         ENDIF
 1506         ptmp$=FNtemporary_name( -1 )
 1507         SYS "OS_SetVarVal","Printer$Temp",ptmp$,LEN ptmp$
 1508         task_buff%!0=20
 1509         task_buff%!16=&80145  
 1510         SYS "Wimp_SendMessage",18,task_buff%,queue_temphand%
 1511         type_state%=0
 1512         REPEAT
 1513           PROCdespatch_poll(message_mask%)
 1514         UNTIL type_state%
 1515         b%=(type_state%=2)
 1516         from%=task_buff%!4
 1517         IF spooling% THEN
 1518           s$=FNselect_connection(prnt%, -1 )
 1519           IF s$<>"" THEN
 1520             PROCerror_warning(s$)
 1521             IF prnt%! 32  THEN
 1522               prnt%! 24  = prnt%! 24  OR  4 
 1523               PROCprinter_status(prnt%)
 1524               PROCredraw_queue_entry(-1,prnt%,0)
 1525             ENDIF
 1526           ENDIF
 1527         ENDIF
 1528         IF b% THEN
 1529           SYS "OS_File",17,ptmp$ TO t%,,load%,,size%  
 1530           IF t% THEN
 1531             s$=ptmp$
 1532             SYS "OS_File",23,ptmp$ TO,,,,,,type%  
 1533           ELSE
 1534             IF spooling% THEN
 1535               IF cnct%! 0 =5 THEN
 1536                 PROCappend_file($cnct%! 16 ,spool_file$)
 1537                 ENDPROC
 1538               ELSE
 1539                 s$=spool_file$
 1540                 type%=psup%! 28 
 1541               ENDIF
 1542             ELSE
 1543               IF cnct%! 0  = 9 AND printer_prefix$<>"" THEN
 1544                 name$ = $(prnt%! 40 )
 1545                 ptr% = INSTR(name$, " ")
 1546                 WHILE ptr%
 1547                   MID$(name$,ptr%,1) = CHR$160
 1548                   ptr% = INSTR(name$, " ", ptr%+1)
 1549                 ENDWHILE
 1550                 sname$ = printer_prefix$+"RemSpool."+unique_string$+"."+name$
 1551                 qname$ = printer_prefix$+"RemQueue."+unique_string$+"."+STR$(remote_jobno%)
 1552                 SYS"XOS_File",17,sname$ TO t%,,,,l%;f%
 1553                 IF (l% > 0) AND ((f% AND 1) = 0) AND (t% = 1) THEN
 1554                   SYS "TaskManager_TaskNameFromHandle",queue_temphand% TO i%
 1555                   CALL Z%,i%,application$
 1556                   IF FNwrite_information_file (prnt%, application$, leaf$) THEN
 1557                     lpsup% = selected_prnt%! 4 
 1558                     SYS "XOS_FSControl", 25, sname$, qname$
 1559                   ELSE
 1560                     SYS "XOS_File", 6, sname$
 1561                   ENDIF
 1562                 ENDIF
 1563               ENDIF
 1564               PROCselect_printer(selected_prnt%, 0 , -1 )
 1565               ENDPROC
 1566             ENDIF
 1567           ENDIF
 1568           SYS "TaskManager_TaskNameFromHandle",from% TO sender$
 1569           i%=LEN leaf$
 1570           WHILE i%>0
 1571             IF MID$(leaf$,i%,1)="." OR MID$(leaf$,i%,1)=":" THEN
 1572               leaf$=MID$(leaf$,i%+1)
 1573               i%=0
 1574             ENDIF
 1575             i%-=1
 1576           ENDWHILE
 1577           PROCadd_queue_entry( -1 ,sender$,s$,leaf$,prnt%,type%)
 1578           ENDPROC
 1579         ENDIF
 1580       ENDIF
 1581       PROCselect_printer(prnt%, 0 , -1 )
 1582       SYS "OS_SetVarVal","Printer$Temp",,-1
 1583       s$=FNtemporary_name( -1 )
 1584       task_buff%!0=48+LEN s$ AND NOT 3
 1585       task_buff%!16=2  
 1586       task_buff%!36=-1  
 1587       $(task_buff%+44)=s$+CHR$ 0
 1588       SYS "Wimp_SendMessage",17,task_buff%,queue_temphand%
 1589       queue_tempref%=task_buff%!8
 1590     WHEN &80145  
 1591       type_state%=1
 1592     OTHERWISE
 1593       PROCbroadcast_reason_code(selected_prnt%,19,task_buff%)
 1594   ENDCASE
 1595 ENDPROC
 1596 DEF PROChost_shutdown
 1597   LOCAL psup%
 1598   LOCAL prnt%, name$, type%, name$, ip%, f%, cnct%
 1599   PROCtell_the_world
 1600   IF selected_prnt% THEN
 1601     name$ = $selected_prnt%! 40 
 1602     cnct% = selected_prnt%! 12 
 1603     psup% = selected_prnt%! 4 
 1604     type% = psup%! 28 
 1605     IF cnct%! 0  = 9 THEN
 1606       SYS "XFreeway_Read", 0,  2 , name$, 0, 0 TO ,,,,,ip% ; f%
 1607       IF (ip% > 0) AND ((f% AND 0) = 0) THEN
 1608         SYS "XRemotePrinterSupport_Enable", 0, ip%, name$, type%
 1609       ENDIF
 1610     ENDIF
 1611   ENDIF
 1612   IF sparrow_present% THEN
 1613     prnt% = A%! 48 
 1614     WHILE prnt%
 1615       IF (prnt%! 24 ) AND  (1<<16)  THEN
 1616         IF (prnt%! 40  = 0) THEN
 1617           psup% = prnt%! 4 
 1618           name$ = $psup%! 4 
 1619         ELSE
 1620           name$ = $prnt%! 40 
 1621         ENDIF
 1622         PROCunshare_one_printer (prnt%)
 1623       ENDIF
 1624       prnt% = prnt%! 0 
 1625     ENDWHILE
 1626   ENDIF
 1627   SYS "XOS_CLI","%Wipe <Wimp$ScrapDir>.Printers.* RF~C~V"
 1628   psup%=psup_head%
 1629   WHILE psup%
 1630     PROCmsg_end(psup%! 16 )
 1631     psup%=psup%! 0 
 1632   ENDWHILE
 1633   PROCmsg_end(A%! 12 )
 1634   PROCbroadcast_reason_code(0,-2,0)
 1635   PROCtask_shutdown
 1636 ENDPROC
 1637 DEF PROCkeypress
 1638   LOCAL psup%,prnt%,wind%,old_name$,new_name$,old_selected_prnt%
 1639   IF NOT FNone_of_ours(!task_buff%) THEN
 1640     PROCprinter_find_handle(!task_buff%,wind%,psup%,prnt%)
 1641     IF prnt%! 40  old_name$=$prnt%! 40  ELSE old_name$=""
 1642     old_selected_prnt%=selected_prnt%
 1643     PROCprinter_reason_code(psup%,prnt%,8,task_buff%)
 1644     IF $(wind%+ 16 )="configure" THEN
 1645       IF prnt%! 40  new_name$=$prnt%! 40  ELSE new_name$=""
 1646       IF new_name$<>old_name$ THEN
 1647        IF NOT (prnt%! 24  AND  (1<<16) ) THEN
 1648         PROCredraw_prntctrl_entry(prnt%)
 1649         PROCprinter_status(prnt%)
 1650         PROCredraw_queue_entry(-1,prnt%,0)
 1651         IF(psup%! 24  AND  4 )=0           IF FNwindow_open(connections%)             PROCopen_connections_window(prnt%)
 1652        ELSE
 1653         PROCerror_warning (FNmsg_0(A%! 12 ,"OKAP"))
 1654         new_name$ = old_name$
 1655         PROCfree ( &47525453 , prnt%! 40 )
 1656         PROCstrcpy (prnt%! 40 , old_name$)
 1657        ENDIF
 1658       ENDIF
 1659       IF prnt%! 20 <>-1 AND old_selected_prnt%<>selected_prnt% THEN
 1660         PROCselect_printer(old_selected_prnt%, -1 , 0 )
 1661       ENDIF
 1662     ENDIF
 1663   ELSE
 1664     IF task_buff%!24=13 THEN
 1665       CASE !task_buff% OF
 1666         WHEN connections%
 1667           PROCsave_connection
 1668           IF menu_chsn$="ME6" SYS "Wimp_CreateMenu",,-1
 1669           !task_buff%=connections%
 1670           PROCclose_window
 1671         WHEN papersize%
 1672           PROCsave_papersize
 1673           !task_buff%=papersize%
 1674           PROCclose_window
 1675         WHEN save_wind%
 1676           SYS "Wimp_CreateMenu",,-1
 1677           PROCicon_write(connections%, 30 ,              FNcanonicalise(FNicon_read(save_wind%, 1 )))
 1678       ENDCASE
 1679     ELSE
 1680       SYS "Wimp_ProcessKey",task_buff%!24
 1681     ENDIF
 1682   ENDIF
 1683 ENDPROC
 1684 DEF PROCunset_selection(window%)
 1685   LOCAL i%
 1686   !win_buff%=window%
 1687   SYS "Wimp_GetWindowInfo",,win_buff% OR 1
 1688   i%=win_buff%!88
 1689   WHILE i%
 1690     PROCicon_deselect(window%,i%-1)
 1691     i%-=1
 1692   ENDWHILE
 1693 ENDPROC
 1694 DEF PROCmouseclick
 1695   LOCAL prnt%,icon%,queu%,tpub%,psup%,wind%,new_name$,old_name$,B%,C%,old_selected_prnt%
 1696   LOCAL rmtp%
 1697   IF FNone_of_ours(task_buff%!12)= 0  THEN
 1698     PROCprinter_find_handle(task_buff%!12,wind%,psup%,prnt%)
 1699     IF prnt%! 40  old_name$=$prnt%! 40  ELSE old_name$=""
 1700     old_selected_prnt%=selected_prnt%
 1701     PROCprinter_reason_code(wind%! 8 ,wind%! 12 ,6,task_buff%)
 1702     IF $(wind%+ 16 )="configure" THEN
 1703       IF prnt%! 40  new_name$=$prnt%! 40  ELSE new_name$=""
 1704       IF new_name$<>old_name$ THEN
 1705        IF NOT (prnt%! 24  AND  (1<<16) ) THEN
 1706         PROCredraw_prntctrl_entry(prnt%)
 1707         PROCprinter_status(prnt%)
 1708         PROCredraw_queue_entry(-1,prnt%,0)
 1709         IF(psup%! 24  AND  4 )=0           IF FNwindow_open(connections%)             PROCopen_connections_window(prnt%)
 1710        ELSE
 1711         PROCerror_warning (FNmsg_0(A%! 12 ,"OKAP"))
 1712         new_name$ = old_name$
 1713         PROCfree ( &47525453 , prnt%! 40 )
 1714         PROCstrcpy (prnt%! 40 , old_name$)
 1715        ENDIF
 1716       ENDIF
 1717       IF prnt%! 20 <>-1 AND old_selected_prnt%<>selected_prnt% THEN
 1718         PROCselect_printer(old_selected_prnt%, -1 , 0 )
 1719       ENDIF
 1720     ENDIF
 1721   ELSE
 1722     CASE task_buff%!8 OF
 1723       WHEN 1024  
 1724         CASE task_buff%!12 OF
 1725           WHEN prntctrl%
 1726             IF NOT task_buff%!16 THEN
 1727               IF NOT FNicon_set(task_buff%!12,task_buff%!16)THEN
 1728                 PROCunset_selection(task_buff%!12)
 1729                 PROCicon_select(task_buff%!12,task_buff%!16)
 1730               ENDIF
 1731             ELSE
 1732               PROCunset_selection(task_buff%!12)
 1733             ENDIF
 1734         ENDCASE
 1735       WHEN 256  
 1736         CASE task_buff%!12 OF
 1737           WHEN prntctrl%
 1738             IF NOT task_buff%!16 THEN
 1739               IF FNicon_set(task_buff%!12,task_buff%!16)THEN
 1740                 PROCicon_deselect(task_buff%!12,task_buff%!16)
 1741               ELSE
 1742                 PROCicon_select(task_buff%!12,task_buff%!16)
 1743               ENDIF
 1744             ENDIF
 1745         ENDCASE
 1746       WHEN 64  
 1747         IF task_buff%!12=save_wind%           PROCsave_dragicon(!task_buff%,task_buff%!4)
 1748       WHEN 2  
 1749         CASE task_buff%!12 OF
 1750           WHEN -2
 1751             PROCmenu("ME1", -1 , 0 )
 1752           WHEN A%! 40 
 1753             PROCmenu("MQ1", -1 , 0 )
 1754           WHEN prntctrl%
 1755             PROCmenu("MC1s", -1 , 0 )
 1756           WHEN connections%
 1757             CASE task_buff%!16 OF
 1758               WHEN  8 
 1759                 PROCmenu("ME2", -1 , -1 )
 1760               WHEN  11 
 1761                 PROCmenu("ME3", -1 , -1 )
 1762               WHEN  14 
 1763                 PROCmenu("ME4", -1 , -1 )
 1764               WHEN  16 
 1765                 PROCmenu("ME5", -1 , -1 )
 1766               WHEN  20 
 1767                 PROCmenu("ME6", -1 , -1 )
 1768               WHEN  32 
 1769                 PROCmenu("SVE", -1 , -1 )
 1770             ENDCASE
 1771           WHEN papersize%
 1772             IF task_buff%!16= 47  PROCmenu("MP1", -1 , -1 )
 1773         ENDCASE
 1774       WHEN 4  
 1775         CASE task_buff%!12 OF
 1776           WHEN -2
 1777             PROCprinter_selection
 1778           WHEN query%
 1779             query_state%=task_buff%!16
 1780           WHEN howquery%
 1781             query_state%=task_buff%!16
 1782           WHEN save_wind%
 1783             IF task_buff%!16= 2  THEN
 1784               SYS "Wimp_CreateMenu",,-1
 1785               PROCicon_write(connections%, 30 ,                  FNcanonicalise(FNicon_read(save_wind%, 1 )))
 1786             ENDIF
 1787           WHEN shutdown%
 1788             SYS "Wimp_CreateMenu",,-1
 1789             IF task_buff%!16= 3  THEN
 1790               !task_buff%=A%! 40 
 1791               PROCclose_window
 1792               PROCdestroy_queue
 1793               CASE shutdown_type% OF
 1794                 WHEN 1  
 1795                   SYS "Wimp_ProcessKey",&1FC
 1796                 WHEN 2  
 1797                   PROChost_shutdown
 1798               ENDCASE
 1799             ELSE
 1800               A%! 20 =                  A%! 20  AND NOT 1
 1801             ENDIF
 1802           WHEN prntctrl%
 1803             IF NOT task_buff%!16 THEN
 1804               IFNOTFNicon_set(task_buff%!12,task_buff%!16) THEN
 1805                 PROCunset_selection(task_buff%!12)
 1806                 PROCicon_select(task_buff%!12,task_buff%!16)
 1807               ENDIF
 1808               PROCfind_prnt(prnt%,rmtp%,icon%)
 1809               IF prnt% THEN
 1810                 PROCprinter_reason_code(prnt%! 4 ,prnt%,-3,0)
 1811                 PROCprinter_open_window(prnt%,"configure")
 1812               ENDIF
 1813             ENDIF
 1814           WHEN connections%
 1815             CASE task_buff%!16 OF
 1816               WHEN  0 , 1 , 2 ,                   3 , 4 , 33 
 1817                 PROCcheck_shaded_connections
 1818               WHEN  5 
 1819                 PROCsave_connection
 1820                 !task_buff%=connections%
 1821                 PROCclose_window
 1822               WHEN  8 
 1823                 PROCmenu("ME2", -1 , -1 )
 1824               WHEN  11 
 1825                 PROCmenu("ME3", -1 , -1 )
 1826               WHEN  14 
 1827                 PROCmenu("ME4", -1 , -1 )
 1828               WHEN  16 
 1829                 PROCmenu("ME5", -1 , -1 )
 1830               WHEN  20 
 1831                 PROCmenu("ME6", -1 , -1 )
 1832               WHEN  32 
 1833                 PROCmenu("SVE", -1 , -1 )
 1834               WHEN  38 
 1835                 !task_buff%=connections%
 1836                 PROCclose_window
 1837             ENDCASE
 1838           WHEN papersize%
 1839             CASE task_buff%!16 OF
 1840               WHEN  42 
 1841                 PROCsave_papersize
 1842                 !task_buff%=papersize%
 1843                 PROCclose_window
 1844               WHEN  33 
 1845                 PROCdelete_papersize
 1846                 !task_buff%=papersize%
 1847                 PROCclose_window
 1848               WHEN  48 
 1849                 B%= &455A5350 
 1850                 C%=psize_edit%
 1851                 CALL code_entry%+ 16 
 1852                 psize_edit%=0
 1853                 !task_buff%=papersize%
 1854                 PROCclose_window
 1855               WHEN  23 , 22 
 1856                 PROCicon_select(papersize%,task_buff%!16)
 1857                 PROCreview_papersize_units
 1858               WHEN  47 
 1859                 PROCmenu("MP1", -1 , -1 )
 1860             ENDCASE
 1861           OTHERWISE
 1862             prnt%=A%! 48 
 1863             WHILE prnt%
 1864               IF prnt%! 48 =task_buff%!12 THEN
 1865                 queu%=prnt%! 32 
 1866                 tpub%=queu%! 44 
 1867                 IF tpub% THEN
 1868                   IF tpub%! 40  THEN
 1869                     IF  task_buff%!16=4 THEN
 1870                       PROCdelete_queue_entry(prnt%,queu%, -1 )
 1871                     ELSE
 1872                       prnt%! 24 =prnt%! 24  AND NOT  36 
 1873                       tpub%! 40 =0
 1874                       PROCprinter_status(prnt%)  
 1875                       PROCredraw_queue_entry(-1,prnt%,0)  
 1876                       !task_buff%=prnt%! 48 
 1877                       PROCclose_window
 1878                     ENDIF
 1879                   ENDIF
 1880                 ENDIF
 1881                 prnt%=0
 1882               ELSE
 1883                 prnt%=prnt%! 0 
 1884               ENDIF
 1885             ENDWHILE
 1886         ENDCASE
 1887       WHEN 1  
 1888         CASE task_buff%!12 OF
 1889           WHEN -2
 1890             PROCprinter_selection
 1891           WHEN connections%
 1892             CASE task_buff%!16 OF
 1893               WHEN  0 , 1 , 2 ,                   3 , 4 , 33 
 1894                 PROCcheck_shaded_connections
 1895               WHEN  5 
 1896                 PROCsave_connection
 1897             ENDCASE
 1898           WHEN papersize%
 1899             CASE task_buff%!16 OF
 1900               WHEN  42 
 1901                 PROCsave_papersize
 1902               WHEN  33 
 1903                 PROCdelete_papersize
 1904               WHEN  23 , 22 
 1905                 PROCicon_select(papersize%,task_buff%!16)
 1906                 PROCreview_papersize_units
 1907             ENDCASE
 1908         ENDCASE
 1909     ENDCASE
 1910   ENDIF
 1911 ENDPROC
 1912 DEF PROCcheck_shaded_connections
 1913   LOCAL c%,h%,i%,n%
 1914   c%=-1
 1915   IF FNicon_set(connections%, 1 )THEN
 1916    PROCicon_unshade(connections%, 15 )
 1917    PROCicon_unshade(connections%, 8 )
 1918    PROCicon_unshade(connections%, 17 )
 1919    PROCicon_unshade(connections%, 11 )
 1920    PROCicon_unshade(connections%, 18 )
 1921    PROCicon_unshade(connections%, 14 )
 1922    PROCicon_unshade(connections%, 19 )
 1923    PROCicon_unshade(connections%, 16 )
 1924    PROCicon_unshade(connections%, 13 )
 1925   ELSE
 1926    PROCicon_shade(connections%, 15 )
 1927    PROCicon_shade(connections%, 8 )
 1928    PROCicon_shade(connections%, 17 )
 1929    PROCicon_shade(connections%, 11 )
 1930    PROCicon_shade(connections%, 18 )
 1931    PROCicon_shade(connections%, 14 )
 1932    PROCicon_shade(connections%, 19 )
 1933    PROCicon_shade(connections%, 16 )
 1934    PROCicon_shade(connections%, 13 )
 1935   ENDIF
 1936   IF FNicon_set(connections%, 2 )THEN
 1937    PROCicon_unshade(connections%, 25 )
 1938    PROCicon_unshade(connections%, 20 )
 1939    c%= 25 
 1940   ELSE
 1941    PROCicon_shade(connections%, 25 )
 1942    PROCicon_shade(connections%, 20 )
 1943   ENDIF
 1944   IF FNicon_set(connections%, 3 )THEN
 1945    PROCicon_unshade(connections%, 26 )
 1946    PROCicon_unshade(connections%, 27 )
 1947    PROCicon_unshade(connections%, 28 )
 1948    PROCicon_unshade(connections%, 29 )
 1949    c%= 26 
 1950   ELSE
 1951    PROCicon_shade(connections%, 26 )
 1952    PROCicon_shade(connections%, 27 )
 1953    PROCicon_shade(connections%, 28 )
 1954    PROCicon_shade(connections%, 29 )
 1955   ENDIF
 1956   IF FNicon_set(connections%, 4 )THEN
 1957    PROCicon_unshade(connections%, 30 )
 1958    PROCicon_unshade(connections%, 32 )
 1959    PROCicon_unshade(connections%, 35 )
 1960    c%= 30 
 1961   ELSE
 1962    PROCicon_shade(connections%, 30 )
 1963    PROCicon_shade(connections%, 32 )
 1964    PROCicon_shade(connections%, 35 )
 1965   ENDIF
 1966   IF c%=-1 THEN
 1967    PROCcaret_info(h%,i%,n%)
 1968    IF h%=connections% SYS "Wimp_SetCaretPosition",-1
 1969   ELSE
 1970    PROCcaret_set(connections%,c%)
 1971   ENDIF
 1972 ENDPROC
 1973 DEF PROCmatch_icon(handle%,RETURN prnt%)
 1974   prnt%=A%! 48 
 1975   WHILE prnt%
 1976    IF prnt%! 20 =handle% ENDPROC
 1977    prnt%=prnt%! 0 
 1978   ENDWHILE
 1979 ENDPROC
 1980 DEF PROCprinter_selection
 1981   LOCAL prnt%,adjust%,shift%
 1982   shift%=INKEY -1
 1983   adjust%=(task_buff%!8=1)
 1984   PROCmatch_icon(task_buff%!16,prnt%)
 1985   IF prnt% THEN
 1986    IF adjust% THEN
 1987     IF shift% PROCopen_connections_window(prnt%)ELSE PROCopen_queue_window
 1988    ELSE
 1989     IF shift% THEN
 1990      PROCprinter_reason_code(prnt%! 4 ,prnt%,-3,0)
 1991      PROCprinter_open_window(prnt%,"configure")
 1992     ELSE
 1993      PROCselect_printer(prnt%, -1 , 0 )
 1994      IF FNwindow_open(prntctrl%)PROCselect_printer_control(prnt%)
 1995     ENDIF
 1996    ENDIF
 1997    ENDPROC
 1998   ENDIF
 1999   PROCprinter_control(prnt%)
 2000 ENDPROC
 2001 DEF PROCselect_printer(prnt%,permanent%,restore%)
 2002   LOCAL old_prnt%,i%,s$
 2003   old_prnt%=selected_prnt%
 2004   IF NOT restore% selected_prnt%=prnt%  
 2005   IF selected_prnt%=0 ENDPROC  
 2006   s$=FNselect_connection(selected_prnt%, 0 )
 2007   IF s$<>"" THEN
 2008     IF permanent% THEN
 2009      selected_prnt%! 24  = selected_prnt%! 24  AND NOT  2 
 2010     ENDIF
 2011     IF selected_prnt%! 32  THEN
 2012       selected_prnt%! 24  = selected_prnt%! 24  OR  4 
 2013       PROCprinter_status(selected_prnt%)
 2014       PROCredraw_queue_entry(-1,selected_prnt%,0)
 2015     ENDIF
 2016     IF selected_prnt%=old_prnt% THEN
 2017       PROCicon_deselect(-1,old_prnt%! 20 )
 2018       SYS"PDriver_SelectDriver",-1
 2019       old_prnt%=0
 2020     ENDIF
 2021     selected_prnt%=old_prnt%
 2022     PROCerror_warning(s$)
 2023     ENDPROC
 2024   ENDIF
 2025   PROCprinter_reason_code(selected_prnt%! 4 ,selected_prnt%,-6,0)
 2026   PROCset_page_size(selected_prnt%)
 2027   PROCtell_the_world
 2028   IF permanent% THEN
 2029     IF old_prnt% THEN
 2030       PROCicon_deselect(-1,old_prnt%! 20 )
 2031       old_prnt%! 24 =old_prnt%! 24  AND NOT  2 
 2032     ENDIF
 2033     selected_prnt%! 24 =selected_prnt%! 24  OR  2 
 2034     PROCicon_select(-1,selected_prnt%! 20 )
 2035     SYS "PDriver_Info" TO,,,,i%
 2036     IF ?i%       CALL Z%,i%,s$:         SYS "OS_SetVarVal","Printer$",i%,LEN s$
 2037   ELSE
 2038     selected_prnt%=old_prnt%
 2039   ENDIF
 2040 ENDPROC
 2041 DEF PROCset_page_size(prnt%)
 2042   LOCAL psize%
 2043   psize%=prnt%! 36 
 2044   SYS "PDriver_SetPageSize",,psize%! 8 ,psize%! 12 ,psize%! 24 ,psize%! 16 ,psize%! 28 ,psize%! 20 
 2045 ENDPROC
 2046 DEF PROCtell_the_world
 2047   !msg_text%=20
 2048   msg_text%!12=0
 2049   msg_text%!16=&80147  
 2050   SYS "Wimp_SendMessage",17,msg_text%
 2051 ENDPROC
 2052 DEF FNdevice_claim(dev%,prnt%)
 2053   LOCAL claim$,r%,s$,i%
 2054   claim$=FNmsg_0(A%! 12 ,"CLM")
 2055   !task_buff%=32+LEN claim$ AND NOT 3
 2056   task_buff%!12=0
 2057   task_buff%!16=11  
 2058   task_buff%!20=dev%
 2059   task_buff%!24=0
 2060   $(task_buff%+28)=claim$+CHR$ 0
 2061   SYS "Wimp_SendMessage",18,task_buff%
 2062   claim_state%=0
 2063   claim_ref%=prnt%
 2064   REPEAT
 2065     PROCdespatch_poll(message_mask%)
 2066   UNTIL claim_state%
 2067   claim_ref%=0
 2068   IF claim_state%=2 i%=task_buff%+28: CALL Z%,i%,s$: =s$  
 2069 =""
 2070 DEF FNselect_connection(prnt%,reselection%)
 2071   LOCAL cnct%,claim$,psup%,r0%,f%,s$,buf%
 2072   LOCAL dir$, r0%, flags%, ip%, name$, ptr%
 2073   FORr0%=0 TO 255
 2074     evaluation_buff%?r0%=task_buff%?r0%
 2075   NEXT
 2076   psup%=prnt%! 4 
 2077   cnct%=prnt%! 12 
 2078   printer_output$=      FNtask_read_env("PrinterType$"+STR$ cnct%! 0 ,msg_text%)
 2079   SYS "OS_Byte",&CC,old_ignore_state%
 2080   SYS "XRemotePrinterSupport_Disable"
 2081   CASE cnct%! 0  OF
 2082     WHEN 1  
 2083       IF NOT reselection% THEN
 2084         claim$=FNdevice_claim(1,prnt%)
 2085         IF claim$<>"" THEN =FNmsg_1(A%! 12 ,"OKI",claim$)
 2086       ENDIF
 2087       buf%=FNbuffer(1)
 2088       IF buf%=0 buf%=3
 2089       IF prnt%! 24  AND  128  THEN
 2090         printer_output$="devices#buffer"+STR$buf%+":$."+FNsupport_fast_parallel
 2091       ELSE
 2092         printer_output$="devices#buffer"+STR$ buf%+":$.Parallel"
 2093       ENDIF
 2094     WHEN 2  
 2095       IF NOT reselection% THEN
 2096         claim$=FNdevice_claim(2,prnt%)
 2097         IF claim$<>"" THEN =FNmsg_1(A%! 12 ,"OKJ",claim$)
 2098       ENDIF
 2099       SYS "OS_SerialOp",5,cnct%? 4 
 2100       SYS "OS_SerialOp",6,cnct%? 4 
 2101       SYS "OS_SerialOp",1,cnct%! 8 
 2102       SYS "OS_SerialOp",0,cnct%? 5 ,NOT 1
 2103       SYS "OS_Byte",&CC,1 TO,old_ignore_state%  
 2104       buf%=FNbuffer(2)
 2105       IF buf%=0 buf%=3
 2106       printer_output$="devices#buffer"+STR$ buf%+":$.Serial"
 2107     WHEN 4  
 2108       IF $cnct%! 12 ="" THEN =FNmsg_0(A%! 12 ,"OKAG")
 2109       printer_output$="NetPrint#"+$cnct%! 12 +":"
 2110       SYS "Hourglass_On"
 2111       SYS "NetPrint_SetPSName",$cnct%! 12 
 2112       SYS "Hourglass_Off"
 2113     WHEN 5  
 2114       printer_output$="null:"
 2115       IF cnct%! 16  <> 0 THEN
 2116         IF ?(cnct%! 16 ) > 32 AND ?(cnct%! 16 ) < 127            printer_output$=$cnct%! 16 
 2117       ENDIF
 2118       SYS "XOS_File",17,printer_output$ TO r0%;f%  
 2119       IF f% AND 1 r0%=0
 2120       IF r0% THEN
 2121         SYS"XOS_Find",&43,printer_output$ TO r0%;f%
 2122         IF (f%AND1)=0 CLOSE#r0%:SYS "XOS_File",18,printer_output$,psup%! 28   
 2123       ELSE
 2124         SYS "XOS_File",11,printer_output$,psup%! 28  TO r0%;f%  
 2125         IF (f%AND1) THEN
 2126           r0%+=4
 2127           CALL Z%,r0%,s$
 2128           =s$
 2129         ENDIF
 2130       ENDIF
 2131     WHEN 6  
 2132       s$=FNselect_nfs(cnct%,printer_output$)
 2133       IF s$<>"" THEN =s$
 2134     WHEN 8  
 2135       SYS"XOS_ReadVarVal","PrinterType$8",buff1%,256,,3 TO ,,f%
 2136       buff1%?f%=13:printer_output$=$buff1%
 2137       IFprinter_output$="" printer_output$="null:"
 2138     WHEN 9  
 2139      IF sparrow_present% THEN
 2140       name$ = $prnt%! 40 
 2141       SYS "XFreeway_Read", 0,  2 , name$, 0, 0 TO r0%,,,dlen%,,ip% ; flags%
 2142       IF (flags% AND 1) THEN
 2143         =FNmsg_1 (A%! 12 , "OKAR", name$)
 2144       ENDIF
 2145       SYS "XRemotePrinterSupport_Enable", 1, ip%, name$ TO r0% ; flags%
 2146       IF (flags% AND 1) THEN
 2147         =FNmsg_1 (A%! 12 , "OKAR", name$)
 2148       ENDIF
 2149       printer_prefix$ = "Share::_S"+FNip_string(ip%)+"."
 2150       dir$ = "Share::_S"+FNip_string(ip%)+".RemSpool."+unique_string$
 2151       SYS "RemotePrinterSupport_DisableUpcalls"
 2152       SYS "XOS_File", 8, dir$,,,0 TO r0% ; flags%
 2153       SYS "RemotePrinterSupport_EnableUpcalls"
 2154       IF (flags% AND 1) THEN
 2155         =FNmsg_1 (A%! 12 , "OKAR", name$)
 2156       ENDIF
 2157       dir$ = "Share::_S"+FNip_string(ip%)+".RemQueue."+unique_string$
 2158       SYS "RemotePrinterSupport_DisableUpcalls"
 2159       SYS "XOS_File", 8, dir$,,,0 TO r0% ; flags%
 2160       SYS "RemotePrinterSupport_EnableUpcalls"
 2161       IF (flags% AND 1) THEN
 2162         =FNmsg_1 (A%! 12 , "OKAR", name$)
 2163       ENDIF
 2164       s$ = FNset_jobno
 2165       IF s$ <> "" THEN
 2166         =FNmsg_1 (A%! 12 , "OKAR", name$)
 2167       ENDIF
 2168       ptr% = INSTR(name$, " ")  
 2169       WHILE ptr%
 2170         MID$(name$,ptr%,1) = CHR$160
 2171         ptr% = INSTR(name$, " ", ptr%+1)
 2172       ENDWHILE
 2173       printer_output$ = "Share::_S"+FNip_string(ip%)+".RemSpool."+unique_string$+"."+name$
 2174       SYS "RemotePrinterSupport_DisableUpcalls"
 2175       SYS "XOS_File",17,printer_output$ TO r0%;f%  
 2176       IF f% AND 1 r0%=0
 2177       IF r0% THEN
 2178         SYS"XOS_Find",&43,printer_output$ TO r0%;f%
 2179         IF (f%AND1)=0 CLOSE#r0%:SYS "XOS_File",18,printer_output$,psup%! 28   
 2180         SYS "RemotePrinterSupport_EnableUpcalls"
 2181       ELSE
 2182         SYS "XOS_File",11,printer_output$,psup%! 28  TO r0%;f%  
 2183         SYS "RemotePrinterSupport_EnableUpcalls"
 2184         IF (f%AND1) THEN
 2185           =FNmsg_1 (A%! 12 , "OKAR", name$)
 2186         ENDIF
 2187       ENDIF
 2188      ELSE
 2189       =FNmsg_1 (A%! 12 , "OKAR", name$)
 2190      ENDIF
 2191   ENDCASE
 2192   SYS "OS_SetVarVal","PrinterType$"+STR$ cnct%! 0 ,printer_output$,LEN printer_output$
 2193   PROCfx5(cnct%! 0 )
 2194   FORr0%=0 TO 255
 2195     task_buff%?r0%=evaluation_buff%?r0%
 2196   NEXT
 2197 =""
 2198 DEF PROCflush(buf%)
 2199   IF buf% SYS "OS_Byte",21,buf%
 2200 ENDPROC
 2201 DEF PROCfx5(new_fx5%)
 2202   LOCAL x%
 2203   LOCAL ERROR
 2204     ON ERROR LOCAL RESTORE ERROR: PROCesc_off: PROCflush(FNbuffer(x%)): SYS "OS_Byte",5,new_fx5%: ENDPROC
 2205   SYS "OS_Byte",245,,255 TO,x%
 2206   IF x%<>new_fx5% THEN
 2207     PROCesc_on
 2208     SYS "OS_Byte",5,new_fx5%
 2209     PROCesc_off
 2210   ENDIF
 2211 ENDPROC
 2212 DEF PROCesc_on
 2213   SYS "OS_Byte",229
 2214 ENDPROC
 2215 DEF PROCesc_off
 2216   SYS "OS_Byte",229,1
 2217 ENDPROC
 2218 DEF FNselect_nfs(cnct%,RETURN a$)
 2219   LOCAL c%,f%,s$
 2220   IF NOT FNnfs_installed THEN =FNmsg_0(A%! 12 ,"OKL")
 2221   IF cnct%! 20 =0 THEN =FNmsg_0(A%! 12 ,"OKK")
 2222   a$="NFS#Printer::"+$cnct%! 20 
 2223   IF cnct%! 24 =0 a$+=".lp" ELSE a$+="."+$cnct%! 24 
 2224   IF cnct%! 28 =0 a$+=".nobody" ELSE a$+="."+$cnct%! 28 
 2225   IF cnct%! 32  a$+="."+$cnct%! 32 
 2226   SYS "XOS_Find",&8F,a$ TO c%;f%
 2227   IF f% AND 1 THEN
 2228     CASE !c% OF
 2229       WHEN 204
 2230         =FNmsg_0(A%! 12 ,"OKM")
 2231       OTHERWISE
 2232         f%=c%+4
 2233         CALL Z%,f%,s$  
 2234         =s$+" ("+STR$ !c%+")"
 2235     ENDCASE
 2236   ENDIF
 2237   SYS "XOS_Find",,c%
 2238 =""
 2239 DEF PROCmenu(top$,rebuild%,iconpos%)
 2240   LOCAL y%,i%,ix%,iy%,indirected_title%
 2241   LOCAL prnt%, rmtp%, icon%
 2242   IF rebuild% THEN
 2243     menu_xpos%=task_buff%!0-64
 2244     menu_ypos%=task_buff%!4
 2245   ENDIF
 2246   IF iconpos% THEN
 2247     !buff1%=task_buff%!12
 2248     buff1%!4=task_buff%!16
 2249     SYS "Wimp_GetIconState",,buff1%
 2250     ix%=buff1%!16
 2251     iy%=buff1%!20
 2252     SYS "Wimp_GetWindowState",,buff1%
 2253     menu_xpos%=buff1%!20+buff1%!4+ix%+2
 2254     menu_ypos%=buff1%!24+buff1%!16+iy%-2
 2255   ENDIF
 2256   IF top$="SVE" THEN
 2257     PROCsave_setup(psup_edit%! 28 ,FNmsg_0(A%! 12 ,"OP"))
 2258     SYS "Wimp_CreateMenu",,save_wind%,menu_xpos%,menu_ypos%
 2259   ELSE
 2260     CASE top$ OF
 2261       WHEN "ME1"
 2262         PROCmenu_create(menu%,FNmsg_0(A%! 12 ,"ME1"))
 2263         PROCmenu_attach(menu%, 0 ,info%, 0 )
 2264         PROCmenu_shade(menu%, 2 ,A%! 44 =0)
 2265         menu_ypos%=96+( 5 +1)*line_space%
 2266         IF got_icon%           menued_prnt%=0         ELSE           PROCmatch_icon(task_buff%!16,menued_prnt%)
 2267       WHEN "ME2"
 2268         IFFNsupport_higher_baudrates THEN
 2269           PROCmenu_create(menu%,FNmsg_0(A%! 12 ,"ME2")+FNmsg_0(A%! 12 ,"ME2a")+FNmsg_0(A%! 12 ,"ME2b"))
 2270         ELSE
 2271           PROCmenu_create(menu%,FNmsg_0(A%! 12 ,"ME2")+FNmsg_0(A%! 12 ,"ME2b"))
 2272         ENDIF
 2273         PROCmenu_tick_match(menu%,FNicon_read(connections%, 15 ))
 2274       WHEN "ME3"
 2275         PROCmenu_create(menu%,FNmsg_0(A%! 12 ,"ME3"))
 2276         PROCmenu_tick_match(menu%,FNicon_read(connections%, 17 ))
 2277       WHEN "ME4"
 2278         PROCmenu_create(menu%,FNmsg_0(A%! 12 ,"ME4"))
 2279         PROCmenu_tick_match(menu%,FNicon_read(connections%, 18 ))
 2280       WHEN "ME5"
 2281         PROCmenu_create(menu%,FNmsg_0(A%! 12 ,"ME5"))
 2282         indirected_title%=(menu%!28 AND &100)<>0
 2283         IF NOT(FNnew_databits=0 AND FNnew_parity<>0)THEN
 2284           IF FNnew_databits=3 AND FNnew_parity=0 THEN
 2285             PROCmenu_item(menu%,1,FNmsg_0(A%! 12 ,"ME5c"),indirected_title%)
 2286           ELSE
 2287             PROCmenu_item(menu%,1,FNmsg_0(A%! 12 ,"ME5a"),indirected_title%)
 2288           ENDIF
 2289         ENDIF
 2290         PROCmenu_tick_match(menu%,FNicon_read(connections%, 19 ))
 2291       WHEN "ME6"
 2292         IF rebuild% PROCbuild_printer_menu
 2293         PROCmenu_tick_match(menu%,            FNicon_read(connections%, 25 ))
 2294       WHEN "MQ1"
 2295         IF rebuild% THEN
 2296           PROCcancel_menued_item
 2297           menued_y%=menu_ypos%
 2298           !task_buff%=A%! 40 
 2299           SYS "Wimp_GetWindowState",,task_buff%
 2300           B%=menued_y%-task_buff%!16+task_buff%!24  
 2301           menued_y%=USR(code_entry%+ 44 )
 2302           i%=A%! 16 
 2303           menued_prnt%=!i%
 2304           menued_queu%=i%!4
 2305           IF menued_queu%=-1 menued_queu%=0
 2306           IF menued_queu%=0 THEN
 2307             PROCmenu_create(menu%,FNmsg_1(A%! 12 ,                "MQ1",FNmsg_0(A%! 12 ,"MQ1a")))
 2308             IF menued_prnt% menued_prnt%! 24 =                menued_prnt%! 24  OR  16 
 2309           ELSE
 2310             IF menued_queu%! 12  THEN
 2311               PROCmenu_create(menu%,FNmsg_1(A%! 12 ,                  "MQ1",FNmsg_0(A%! 12 ,"MQ1a")))
 2312             ELSE
 2313               PROCmenu_create(menu%,FNmsg_1(A%! 12 ,                  "MQ1",FNmsg_0(A%! 12 ,"MQ1b")))
 2314             ENDIF
 2315             menued_queu%? 11 =                menued_queu%? 11  OR 8  
 2316           ENDIF
 2317           PROCredraw_queue_entry(-1,menued_prnt%,menued_queu%)
 2318         ENDIF
 2319         PROCmenu_shade(menu%,0, 0 )
 2320         PROCmenu_shade(menu%,1, 0 )
 2321         PROCmenu_shade(menu%,2, 0 )
 2322         PROCmenu_shade(menu%,3, 0 )
 2323         PROCmenu_shade(menu%,4, 0 )
 2324         PROCmenu_shade(menu%,5, 0 )
 2325         PROCmenu_shade(menu%,6, 0 )
 2326         IF menued_queu%=0 THEN
 2327           PROCmenu_shade(menu%,4, -1 )
 2328           PROCmenu_shade(menu%,5, -1 )
 2329           PROCmenu_shade(menu%,6, -1 )
 2330         ELSE
 2331           IF menued_queu%? 11  AND 5               PROCmenu_shade(menu%,4, -1 )ELSE PROCmenu_shade(menu%,5, -1 )
 2332         ENDIF
 2333         IF menued_prnt%! 24  AND  36  THEN
 2334           PROCmenu_shade(menu%,0, -1 )
 2335           PROCmenu_shade(menu%,1, -1 )
 2336         ELSE
 2337           PROCmenu_shade(menu%,2, -1 )
 2338         ENDIF
 2339       WHEN "MP1"
 2340         PROCcreate_paper_menu(menu%,papersize%, 5 )
 2341       WHEN "MC1", "MC1s"
 2342         PROCmenu_create(menu%,FNmsg_0(A%! 12 ,"MC1s"))
 2343         IF sparrow_present% =  0  THEN
 2344           PROCmenu_shade(menu%, 2,  -1 )
 2345         ENDIF
 2346         SYS "Wimp_WhichIcon",prntctrl%,buff1%,1<<21,1<<21
 2347         IF (!buff1%=-1 OR buff1%!4=-1) AND select_all%= 0  THEN
 2348           IF NOT !buff1% PROCicon_deselect(prntctrl%,!buff1%)
 2349           IF task_buff%!12=prntctrl% AND task_buff%!16>3 THEN
 2350             PROCicon_select(prntctrl%,task_buff%!16)
 2351             i%=1
 2352           ELSE
 2353             i%=0
 2354           ENDIF
 2355         ELSE
 2356           i%=2
 2357         ENDIF
 2358         CASE i% OF
 2359           WHEN 0
 2360             PROCmenu_shade(menu%,0, -1 )
 2361             PROCmenu_shade(menu%,1, -1 )
 2362             PROCmenu_shade(menu%,2, -1 )
 2363             PROCmenu_shade(menu%,3, -1 )
 2364             PROCmenu_shade(menu%,4, -1 )
 2365             PROCmenu_shade(menu%,5, -1 )
 2366             PROCmenu_shade(menu%,7, -1 )
 2367             IF A%! 48 =0                 PROCmenu_shade(menu%,6, -1 )
 2368           WHEN 1
 2369             PROCfind_prnt (prnt%, rmtp%, icon%)
 2370             IF rmtp% THEN
 2371               PROCmenu_shade (menu%, 0,  -1 )  
 2372               PROCmenu_shade (menu%, 1,  -1 )  
 2373               PROCmenu_shade (menu%, 2,  -1 )  
 2374               IF rmtp%! 20  > 0 THEN  
 2375                 PROCmenu_shade (menu%, 3,  -1 )  
 2376               ELSE                                         
 2377                 PROCmenu_shade (menu%, 4,  -1 )  
 2378               ENDIF
 2379               PROCmenu_shade (menu%, 5,  -1 )  
 2380             ENDIF
 2381             IF prnt% THEN
 2382               IF prnt%! 24  AND  (1<<17)  THEN
 2383                 PROCmenu_shade (menu%, 1,  -1 )  
 2384                 PROCmenu_shade (menu%, 2,  -1 )  
 2385                 PROCmenu_shade (menu%, 3,  -1 )  
 2386                 PROCmenu_shade (menu%, 5,  -1 )  
 2387               ENDIF
 2388             ENDIF
 2389           WHEN 2
 2390             PROCmenu_shade(menu%,0, -1 )
 2391             PROCmenu_shade(menu%,1, -1 )
 2392         ENDCASE
 2393     ENDCASE
 2394     menu_chsn$=top$
 2395     PROCdisplay_menu(0,menu%,menu_xpos%,menu_ypos%)
 2396   ENDIF
 2397 ENDPROC
 2398 DEF PROCcreate_paper_menu(RETURN handle%,window%,icon%)
 2399   LOCAL psize%,i%,indirected_title%
 2400   PROCmenu_create(handle%,FNmsg_0(A%! 12 ,"MP1"))
 2401   indirected_title%=(handle%!28 AND &100)<>0
 2402   psize%=psize_head%
 2403   i%=0
 2404   WHILE psize%
 2405    PROCmenu_item(handle%,i%,$psize%! 4 ,indirected_title%)
 2406    i%+=1
 2407    psize%=psize%! 0 
 2408   ENDWHILE
 2409   PROCmenu_tick_match(handle%,FNicon_read(window%,icon%))
 2410 ENDPROC
 2411 DEF PROCdisplay_menu(prnt%,menu%,xp%,yp%)
 2412   menu_prnt%=prnt%
 2413   SYS "Wimp_CreateMenu",,menu%,xp%,yp%
 2414 ENDPROC
 2415 DEF FNwas_adjust_used
 2416   SYS "Wimp_GetPointerInfo",,buff1%
 2417 =(buff1%!8 AND 1)<>0
 2418 DEF PROCmenuaction
 2419   LOCAL adjust%,redraw%,psize%,i%,h%,n%,prnt%,icon%
 2420   LOCAL rmtp%
 2421   IF menu_prnt% THEN
 2422     PROCprinter_reason_code(menu_prnt%! 4 ,menu_prnt%,9,task_buff%)
 2423     ENDPROC
 2424   ENDIF
 2425   adjust%=FNwas_adjust_used
 2426   CASE menu_chsn$ OF
 2427     WHEN "ME1"
 2428       CASE !task_buff% OF
 2429         WHEN  1 
 2430           PROCprinter_control(menued_prnt%)
 2431         WHEN  2 
 2432           PROCopen_queue_window
 2433         WHEN  3 
 2434           PROCopen_papersize_window(menued_prnt%)
 2435         WHEN  4 
 2436           PROCsave_settings
 2437           PROCsave_prdata
 2438         WHEN  5 
 2439           IF A%! 32  THEN
 2440             A%! 20 =A%! 20  OR 1
 2441             shutdown_type%=2
 2442             PROCmenu_window_centre(shutdown%)
 2443           ELSE
 2444             PROChost_shutdown
 2445           ENDIF
 2446       ENDCASE
 2447     WHEN "ME2"
 2448       PROCicon_write(connections%, 15 ,$(!task_buff%*24+40+menu%))
 2449     WHEN "ME3"
 2450       PROCicon_write(connections%, 17 ,$(!task_buff%*24+40+menu%))
 2451       PROCensure_new_stopbits(-1)
 2452     WHEN "ME4"
 2453       PROCicon_write(connections%, 18 ,$(!task_buff%*24+40+menu%))
 2454       PROCensure_new_stopbits(-1)
 2455     WHEN "ME5"
 2456       PROCensure_new_stopbits(!task_buff%)
 2457     WHEN "ME6"
 2458       PROCmenu_tick_match(menu%,FNicon_read(connections%, 25 ))
 2459       PROCicon_write(connections%, 25 ,$(!task_buff%*24+40+menu%))
 2460     WHEN "MQ1"
 2461       redraw%= -1 
 2462       CASE !task_buff% OF
 2463         WHEN 0
 2464           menued_prnt%! 24 =menued_prnt%! 24  OR  4 
 2465         WHEN 1
 2466           menued_prnt%! 24 =menued_prnt%! 24  OR  32 
 2467         WHEN 2
 2468           menued_prnt%! 24 =menued_prnt%! 24  AND NOT  36 
 2469           i%=menued_prnt%! 32 
 2470           IF i% THEN
 2471             i%=i%! 44 
 2472             IF i% THEN
 2473               IF i%! 40  THEN
 2474                 i%! 40 =0
 2475                 IF menued_prnt%! 48  THEN
 2476                   !task_buff%=menued_prnt%! 48 
 2477                   PROCclose_window
 2478                 ENDIF
 2479               ENDIF
 2480             ENDIF
 2481           ENDIF
 2482         WHEN 3
 2483           PROCflush_queue(menued_prnt%)
 2484           redraw%= 0 
 2485         WHEN 4
 2486           IF menued_queu%! 12  THEN
 2487             menued_queu%? 11 =menued_queu%? 11  OR 1
 2488           ELSE
 2489             menued_queu%? 11 =menued_queu%? 11  OR 4
 2490           ENDIF
 2491         WHEN 5
 2492           menued_queu%? 11 =menued_queu%? 11  AND NOT 5
 2493         WHEN 6
 2494           PROCdelete_queue_entry(menued_prnt%,menued_queu%, -1 )
 2495           redraw%= 0 
 2496       ENDCASE
 2497       IF redraw% THEN
 2498         PROCprinter_status(menued_prnt%)
 2499         IF !task_buff%<3 THEN
 2500           PROCredraw_queue_entry(-1,menued_prnt%,0)
 2501         ELSE
 2502           PROCredraw_queue_entry(menued_y%,menued_prnt%,menued_queu%)
 2503         ENDIF
 2504       ENDIF
 2505     WHEN "MP1"
 2506       psize%=psize_head%
 2507       i%=!task_buff%
 2508       WHILE i%
 2509         psize%=psize%! 0 
 2510         i%-=1
 2511       ENDWHILE
 2512       FOR i%= 0  TO  52  STEP 4
 2513         psize_edit%!i%=psize%!i%
 2514       NEXT
 2515       PROCinitialise_papersize_window
 2516     WHEN "MC1", "MC1s"
 2517       CASE !task_buff% OF
 2518         WHEN 0
 2519           PROCfind_prnt(prnt%,rmtp%,icon%)
 2520           IF prnt% THEN
 2521             PROCprinter_reason_code(prnt%! 4 ,prnt%,-3,0)
 2522             PROCprinter_open_window(prnt%,"configure")
 2523           ENDIF
 2524         WHEN 1
 2525           PROCfind_prnt(prnt%,rmtp%,icon%)
 2526           IF prnt% THEN
 2527             PROCopen_connections_window(prnt%)
 2528           ENDIF
 2529         WHEN 2
 2530           PROCshare_printer
 2531         WHEN 3
 2532           PROCactivate_printer
 2533           PROCcreate_installed_printer_icons
 2534         WHEN 4
 2535           PROCdeactivate_printer
 2536           PROCcreate_installed_printer_icons
 2537         WHEN 5
 2538           PROCremove_printer
 2539           PROCcreate_installed_printer_icons
 2540         WHEN 6
 2541           IF A%! 48  THEN
 2542             IF 0<=printer_count%-1 THEN
 2543               FOR i%=0 TO printer_count%-1
 2544                 PROCicon_select(prntctrl%,i%+4)
 2545               NEXT
 2546             ENDIF
 2547           ENDIF
 2548           IF remote_printers% THEN
 2549             IF 0<=remote_printer_count%-1 THEN
 2550               FOR i% = printer_count% TO printer_count%+remote_printer_count%
 2551                 PROCicon_select(prntctrl%,i%+4)
 2552               NEXT
 2553             ENDIF
 2554           ENDIF
 2555           select_all%= -1 
 2556         WHEN 7
 2557           PROCunset_selection(prntctrl%)
 2558       ENDCASE
 2559   ENDCASE
 2560   IF adjust% THEN
 2561     SYS "Wimp_GetPointerInfo",,task_buff%
 2562     PROCmenu(menu_chsn$, 0 , 0 )
 2563   ELSE
 2564     PROCcancel_menued_item
 2565   ENDIF
 2566 ENDPROC
 2567 DEF PROCsave_settings
 2568   LOCAL c%,f%,psup%,prnt%,ptr%,p%,size%,s$,f$
 2569   LOCAL attr%, rmtp%
 2570   SYS "Hourglass_On"
 2571   IF multiple_choices% THEN
 2572     f$ =  "<Choices$Write>.Printers" +".Remote.ID"+unique_string$+".Settings1"
 2573   ELSE
 2574   f$ =  "<Choices$Write>.Printers" +".Settings1"
 2575   ENDIF
 2576   SYS "XOS_Find",&8F,f$ TO c%;f%
 2577   IF f% AND 1     f%=c%+4:     CALL Z%,f%,s$:       ERROR  254 ,FNmsg_1(A%! 12 ,"OKB",s$)
 2578   LOCAL ERROR
 2579   ON ERROR LOCAL RESTORE ERROR:     SYS"XOS_Find",0,c%:     SYS"XOS_File",6,f$:     ERROR  254 , FNmsg_1(A%! 12 ,"OKB",REPORT$)
 2580   BPUT#c%,"fv: 1"
 2581   prnt%=A%! 48 
 2582   WHILE prnt%
 2583    psup%=prnt%! 4 
 2584    BPUT#c%,"cl: "+$psup%! 4 +":"+STR$ psup%! 40 
 2585    BPUT#c%,"nm: "+$prnt%! 8 
 2586    ptr%=prnt%! 12 
 2587    IF psup%! 24  AND  4  THEN
 2588     size%=psup%! 48 
 2589     BPUT#c%,"cn: "+STR$ size%
 2590     IF 1<=size% THEN
 2591      FOR f%=1 TO size%
 2592       p%=!ptr%
 2593       ptr%+=4
 2594       CASE  -1  OF
 2595        WHEN p%=0
 2596         BPUT#c%,"nl: "
 2597        WHEN p%!-4= &47544E49 
 2598         BPUT#c%,"in: "+STR$ !p%
 2599        WHEN p%!-4= &47525453 
 2600         BPUT#c%,"st: "+$p%
 2601        WHEN p%!-4= &30525453 
 2602         CALL Z%,p%,s$  
 2603         BPUT#c%,"s0: "+s$
 2604        WHEN p%!-4= &52545347 
 2605         CALL Y%,p%,s$  
 2606         BPUT#c%,"gs: "+FNungstrans(s$)
 2607        WHEN p%!-4= &52544F50 
 2608         BPUT#c%,"pt: "+FNdiscover_ptr(!p%,psup%)
 2609        OTHERWISE
 2610         SYS "XOS_Find",,c%  
 2611         ERROR  254 ,FNmsg_1(A%! 12 ,"OKC",$prnt%! 8 )
 2612       ENDCASE
 2613      NEXT
 2614     ENDIF
 2615    ELSE
 2616     BPUT#c%,"ct: 16_"+STR$~ptr%! 0 
 2617     BPUT#c%,"bd: 16_"+STR$~ptr%! 4 
 2618     IF ptr%! 8  AND %110000 ptr%! 8 =ptr%! 8  OR %1000
 2619     BPUT#c%,"ft: 16_"+STR$~ptr%! 8 
 2620     BPUT#c%,"et: ";
 2621     IF ptr%! 12 =0 BPUT#c%,10 ELSE BPUT#c%,$ptr%! 12 
 2622     BPUT#c%,"fl: ";
 2623     IF ptr%! 16 =0 BPUT#c%,10 ELSE BPUT#c%,$ptr%! 16 
 2624     BPUT#c%,"ns: ";
 2625     IF ptr%! 20 =0 BPUT#c%,10 ELSE BPUT#c%,$ptr%! 20 
 2626     BPUT#c%,"np: ";
 2627     IF ptr%! 24 =0 BPUT#c%,10 ELSE BPUT#c%,$ptr%! 24 
 2628     BPUT#c%,"nu: ";
 2629     IF ptr%! 28 =0 BPUT#c%,10 ELSE BPUT#c%,$ptr%! 28 
 2630     BPUT#c%,"no: ";
 2631     IF ptr%! 32 =0 BPUT#c%,10 ELSE BPUT#c%,$ptr%! 32 
 2632     BPUT#c%,"cf: 16_"+STR$~ptr%? 6 
 2633    ENDIF
 2634    ptr%=prnt%! 16 
 2635    size%=psup%! 36 
 2636    BPUT#c%,"cs: "+STR$ size%
 2637    IF 1<=size% THEN
 2638      FOR f%=1 TO size%
 2639        p%=!ptr%
 2640        ptr%+=4
 2641        CASE  -1  OF
 2642          WHEN p%=0
 2643            BPUT#c%,"nl: "
 2644          WHEN p%!-4= &47544E49 
 2645            BPUT#c%,"in: "+STR$ !p%
 2646          WHEN p%!-4= &47525453 
 2647            BPUT#c%,"st: "+$p%
 2648          WHEN p%!-4= &30525453 
 2649            CALL Z%,p%,s$  
 2650            BPUT#c%,"s0: "+s$
 2651          WHEN p%!-4= &52545347 
 2652            CALL Y%,p%,s$  
 2653            BPUT#c%,"gs: "+FNungstrans(s$)
 2654          WHEN p%!-4= &52544F50 
 2655            BPUT#c%,"pt: "+FNdiscover_ptr(!p%,psup%)
 2656          OTHERWISE
 2657            SYS "XOS_Find",,c%  
 2658            ERROR  254 ,FNmsg_1(A%! 12 ,"OKC",$prnt%! 8 )
 2659        ENDCASE
 2660      NEXT
 2661    ENDIF
 2662    REM save the following flags:
 2663    REM bit 0: whether or not the printer is active
 2664    REM bit 1: whether or not the printer is selected
 2665    REM bit 7: whether or not the printer supports fast parallel
 2666    REM bit 16: whether the printer is shared
 2667    REM bit 17: whether the printer is remote
 2668    BPUT#c%,"fg: 16_"+STR$~(prnt%! 24  AND  195+65536+131072 )
 2669    f%=prnt%! 36 
 2670    BPUT#c%,"pn: "+$f%! 4 
 2671    BPUT#c%,"sn: "+FNprinter_read_string(prnt%! 40 )
 2672    BPUT#c%,"ic: "+FNprinter_read_string(prnt%! 44 )
 2673    prnt%=prnt%! 0 
 2674   ENDWHILE
 2675   rmtp% = remote_printers%
 2676   WHILE rmtp%
 2677     IF rmtp%! 20  > 0 THEN
 2678       BPUT#c%, "cl:"
 2679       BPUT#c%, "nm: "+$rmtp%! 8   
 2680       BPUT#c%, "ct: 16_9"
 2681       BPUT#c%, "bd: 16_8"
 2682       BPUT#c%, "ft: 16_5"
 2683       BPUT#c%, "et:"
 2684       BPUT#c%, "fl:"
 2685       BPUT#c%, "ns:"
 2686       BPUT#c%, "np:"
 2687       BPUT#c%, "nu:"
 2688       BPUT#c%, "no:"
 2689       BPUT#c%, "cf: 16_0"
 2690       BPUT#c%, "cs: 2"
 2691       BPUT#c%, "in: 25600"
 2692       BPUT#c%, "in: 6"
 2693       BPUT#c%, "fg: 16_20000"
 2694       BPUT#c%, "pn:"
 2695       BPUT#c%, "sn: "+$rmtp%! 4 
 2696       BPUT#c%, "ic:"
 2697     ENDIF
 2698     rmtp% = rmtp%! 0 
 2699   ENDWHILE
 2700   CLOSE#c%  
 2701   SYS "XOS_File",18,f$,&FC6  
 2702   SYS "XOS_File",6,LEFT$(f$)
 2703   SYS "XOS_FSControl", 25, f$, LEFT$(f$)
 2704   SYS "XOS_File",4,LEFT$(f$),,,,&13  
 2705   SYS "Hourglass_Off"
 2706 ENDPROC
 2707 DEF PROCsave_prdata
 2708   LOCAL psup%,head%,prdt%,c%,tmpt%,ntry%,list%,i%,j%,k%,l%,s$,f%,f$
 2709   SYS "Hourglass_On"
 2710   psup%=psup_head%
 2711   WHILE psup%
 2712    IF psup%! 8  THEN
 2713     IF psup%! 24  AND  2  THEN
 2714      IF multiple_choices% THEN
 2715        f$ =  "<Choices$Write>.Printers" +".Remote.ID"+unique_string$+"."+$psup%! 4 
 2716        SYS "OS_File", 8, f$  
 2717        f$ += ".PrData1"
 2718      ELSE
 2719        f$ =  "<Choices$Write>.Printers" +"."+$psup%! 4 +".PrData1"
 2720      ENDIF
 2721      SYS "XOS_File",4,LEFT$(f$),,,,3  
 2722      SYS "XOS_Find",&8F,f$ TO c%;f%
 2723      IF f% AND 1        f%=c%+4:        CALL Z%,f%,s$:          ERROR  254 ,FNmsg_1(A%! 12 ,"OKB",s$)
 2724      LOCAL ERROR
 2725      ON ERROR LOCAL RESTORE ERROR:        SYS"XOS_Find",0,c%:        SYS"XOS_File",6,f$:        ERROR  254 , FNmsg_1(A%! 12 ,"OKB",REPORT$)
 2726      tmpt%=psup%! 8 
 2727      head%=psup%! 12 
 2728      WHILE tmpt%
 2729       BPUT#c%,$(tmpt%+ 12 )+":"
 2730       BPUT#c%,"#"
 2731       prdt%=head%! 4 
 2732       WHILE prdt%
 2733        IF prdt%!(prdt%! 4 *4+ 8 )THEN
 2734         BPUT#c%,"# Usage: "+STR$ prdt%!(prdt%! 4 *4+ 8 )
 2735         ntry%=tmpt%! 4 
 2736         i%=prdt%+ 8 
 2737         WHILE ntry%
 2738          BPUT#c%,$(ntry%+ 16 )+" ";
 2739          IF !i%=0 THEN
 2740           IF ntry%! 4 =6 THEN
 2741             BPUT#c%,48  
 2742           ELSE
 2743             IF ntry%! 4 =1 THEN
 2744               BPUT#c%,48  
 2745             ENDIF
 2746           ENDIF
 2747           BPUT#c%,10
 2748          ELSE
 2749           j%=!i%  
 2750           CASE ntry%! 4  OF
 2751            WHEN 1
 2752             IF $(ntry%+ 16 ) = "palette:" THEN
 2753               BPUT#c%,STR$((!j%) AND &7FFFFF)
 2754             ELSE
 2755               BPUT#c%,STR$ !j%
 2756             ENDIF
 2757            WHEN 2
 2758             BPUT#c%,FNprinter_read_string(j%)
 2759            WHEN 3
 2760             BPUT#c%,FNprinter_read_string(j%)
 2761            WHEN 4
 2762             BPUT#c%,FNungstrans(FNprinter_read_string(j%))
 2763            WHEN 5
 2764             BPUT#c%,10
 2765             CASE ntry%! 8  OF
 2766              WHEN 1
 2767               BPUT#c%," "+STR$ !j%! 0 +", "+STR$ !j%! 4 
 2768              WHEN 2
 2769               BPUT#c%," "+FNprinter_read_string(j%! 0 )
 2770               BPUT#c%," "+FNprinter_read_string(j%! 4 )
 2771              WHEN 3
 2772               BPUT#c%," "+FNprinter_read_string(j%! 0 )
 2773               BPUT#c%," "+FNprinter_read_string(j%! 4 )
 2774              WHEN 4
 2775               BPUT#c%," "+FNungstrans(FNprinter_read_string(j%! 0 ))
 2776               BPUT#c%," "+FNungstrans(FNprinter_read_string(j%! 4 ))
 2777              WHEN 7
 2778               BPUT#c%," "+FNdiscover_ptr(!j%! 0 ,psup%)+", "+FNdiscover_ptr(!j%! 4 ,psup%)
 2779             ENDCASE
 2780            WHEN 6
 2781             k%=j%
 2782             l%=0
 2783             WHILE k%
 2784              l%+=1
 2785              k%=!k%
 2786             ENDWHILE
 2787             BPUT#c%,STR$ l%
 2788             WHILE j%
 2789              IF 0<=j%! 4 -1 THEN
 2790                FOR k%=0 TO j%! 4 -1
 2791                 l%=j%!(k%*4+ 8 )
 2792                 CASE l%!-4 OF
 2793                  WHEN  &47544E49 
 2794                   BPUT#c%," "+STR$ !l%+", ";
 2795                  WHEN  &47525453 
 2796                   BPUT#c%," "+$l%+", ";
 2797                  WHEN  &30525453 
 2798                   CALL Z%,l%,s$  
 2799                   BPUT#c%," "+s$+", ";
 2800                  WHEN  &52545347 
 2801                   CALL Y%,l%,s$  
 2802                   BPUT#c%," "+FNungstrans(s$)+", ";
 2803                  WHEN  &52544F50 
 2804                   BPUT#c%," "+FNdiscover_ptr(!l%,psup%)+", ";
 2805                 ENDCASE
 2806                NEXT
 2807              ENDIF
 2808              PTR#c%=PTR#c%-2
 2809              BPUT#c%,10
 2810              j%=!j%
 2811             ENDWHILE
 2812            WHEN 7
 2813             BPUT#c%,FNdiscover_ptr(!j%,psup%)
 2814            WHEN 8
 2815             k%=j%
 2816             l%=0
 2817             WHILE k%
 2818              l%+=1
 2819              k%=!k%
 2820             ENDWHILE
 2821             BPUT#c%,STR$ l%
 2822             WHILE j%
 2823              s$=CHR$ j%?4
 2824              IF 1<=j%?5 THEN
 2825               FOR k%=1 TO j%?5
 2826                s$+=CHR$ j%?(k%+5)
 2827               NEXT
 2828              ENDIF
 2829              BPUT#c%," "+FNungstrans(s$)
 2830              j%=!j%
 2831             ENDWHILE
 2832           ENDCASE
 2833          ENDIF
 2834          ntry%=ntry%! 0 
 2835          i%+=4
 2836         ENDWHILE
 2837         BPUT#c%,"#"
 2838        ENDIF
 2839        prdt%=prdt%! 0 
 2840       ENDWHILE
 2841       tmpt%=tmpt%! 0 
 2842       head%=head%! 0 
 2843      ENDWHILE
 2844      CLOSE#c%  
 2845      SYS "XOS_File",18,f$,&FC6  
 2846      SYS "XOS_File",6,LEFT$(f$)
 2847      SYS "XOS_FSControl",25,f$,LEFT$(f$)
 2848      SYS "XOS_File",4,LEFT$(f$),,,,&13  
 2849      psup%! 24 =psup%! 24  AND NOT  2 
 2850     ELSE
 2851     ENDIF
 2852    ENDIF
 2853    psup%=psup%! 0 
 2854   ENDWHILE
 2855   SYS "Hourglass_Off"
 2856 ENDPROC
 2857 DEF FNdiscover_ptr(p%,psup%)
 2858   LOCAL head%,prdt%,tmpt%,head_count%,prdt_count%
 2859   head%=psup%! 12 
 2860   WHILE head%
 2861     prdt%=head%! 4 
 2862     prdt_count%=0
 2863     WHILE prdt%
 2864       IF prdt%!(prdt%! 4 *4+ 8 )THEN
 2865         prdt_count%+=1
 2866         IF p%=prdt% THEN
 2867           tmpt%=psup%! 8 
 2868           WHILE head_count%
 2869             tmpt%=tmpt%! 0 
 2870             head_count%-=1
 2871           ENDWHILE
 2872           =$(tmpt%+ 12 )+":"+STR$ prdt_count%
 2873         ENDIF
 2874       ENDIF
 2875       prdt%=prdt%! 0 
 2876     ENDWHILE
 2877     head_count%+=1
 2878     head%=head%! 0 
 2879   ENDWHILE
 2880   PROCerror_warning(FNmsg_0(A%! 12 ,"FAF"))
 2881 =""
 2882 DEF FNwindow_open(h%)
 2883   !win_buff%=h%
 2884   SYS "Wimp_GetWindowState",,win_buff%
 2885 =(win_buff%!32 AND 1<<16)<>0
 2886 DEF PROCprinter_control(prnt%)
 2887   IF NOT FNwindow_open(prntctrl%) THEN
 2888     IF A%! 48  OR remote_printers% THEN
 2889       PROCcreate_installed_printer_icons
 2890     ENDIF
 2891   ENDIF  
 2892   PROCtell_pinboard(prntctrl%)
 2893   PROCwin_open(prntctrl%)
 2894   PROCselect_printer_control(prnt%)
 2895 ENDPROC
 2896 DEF PROCselect_printer_control(prnt%)
 2897   LOCAL p%
 2898   IF prnt% THEN
 2899     SYS "Wimp_WhichIcon",prntctrl%,buff1%,1<<21,1<<21
 2900     p%=buff1%
 2901     WHILE NOT !p%
 2902       IF !p%<>prnt%! 28  PROCicon_deselect(prntctrl%,!p%)
 2903       p%+=4
 2904     ENDWHILE
 2905     IF(prnt%! 24  AND  44 )=0       PROCicon_select(prntctrl%,prnt%! 28 )
 2906   ENDIF
 2907 ENDPROC
 2908 DEF PROCcheck_prdata_ptr(p%)
 2909   LOCAL ptr%,i%,tmp%
 2910   IF p%=0 ENDPROC
 2911   CASE p%!-4 OF
 2912     WHEN  &52544F50 
 2913       ptr%=!p%  
 2914       tmp%=ptr%+ptr%! 4 *4+ 8 
 2915       !tmp%-=1
 2916       IF !tmp%=0 THEN
 2917         tmp%=ptr%+ 8 
 2918         IF 1<=ptr%! 4  THEN
 2919           FOR i%=1 TO ptr%! 4 
 2920             PROCcheck_prdata_ptr(!tmp%)
 2921             tmp%+=4
 2922           NEXT
 2923         ENDIF
 2924       ENDIF
 2925     WHEN  &4C4f4F42 
 2926       PROCcheck_prdata_ptr(p%! 0 )
 2927       PROCcheck_prdata_ptr(p%! 4 )
 2928     WHEN  &4454534C 
 2929       WHILE p%
 2930         IF 0<=p%! 4 -1 THEN
 2931           FOR ptr%=0 TO p%! 4 -1
 2932             PROCcheck_prdata_ptr(p%!(ptr%*4+ 8 ))
 2933           NEXT
 2934         ENDIF
 2935         p%=p%! 0 
 2936       ENDWHILE
 2937   ENDCASE
 2938 ENDPROC
 2939 DEF PROCdelete_prdata_entry(printer_type$)
 2940   LOCAL psup%,head%,old_prdt%,prdt%,i%,j%,k%,l%,tmp%
 2941   psup%=psup_head%
 2942   WHILE psup%
 2943     old_prdt%=0
 2944     head%=psup%! 12   
 2945     prdt%=head%! 4   
 2946     WHILE prdt%
 2947       IF $prdt%! 8 =printer_type$ THEN
 2948         IF (prdt%!(prdt%! 4 *4+ 8 )) = 0 THEN
 2949           psup%! 24 =psup%! 24  OR  2 
 2950           IF 0<=prdt%! 4 -1 THEN
 2951             FOR i%=0 TO prdt%! 4 -1
 2952               tmp%=prdt%!(i%*4+ 8 )
 2953               PROCcheck_prdata_ptr(tmp%)
 2954               PROCfree_structure(tmp%)
 2955             NEXT
 2956           ENDIF
 2957           IF old_prdt% THEN
 2958             old_prdt%! 0 =prdt%! 0 
 2959           ELSE
 2960             head%! 4 =prdt%! 0 
 2961           ENDIF
 2962           B%= &54445250 
 2963           C%=prdt%
 2964           CALL code_entry%+ 16 
 2965         ENDIF
 2966         prdt%=0
 2967         psup%=0
 2968       ELSE
 2969         old_prdt%=prdt%
 2970         prdt%=prdt%! 0 
 2971       ENDIF
 2972     ENDWHILE
 2973     IF psup% psup%=psup%! 0 
 2974   ENDWHILE
 2975 ENDPROC
 2976 DEF PROCvalidate_error(err$)
 2977   PROCram_file_error(FNmsg_1(A%! 12 ,"OKZ",err$))
 2978 ENDPROC
 2979 DEF PROCvalidate_prdata_file(RETURN psup%)
 2980   LOCAL ptr%,ts%,c%,d%
 2981   ts%=FNmatch_line("cl:")
 2982   IF ts%=0 PROCvalidate_error(FNmsg_0(A%! 12 ,"OKZa"))
 2983   psup%=psup_head%
 2984   WHILE psup%
 2985     IF $psup%! 4 =$ts% THEN
 2986       IF psup%! 24  AND  32  THEN
 2987         SYS"XOS_File",7,"PrinterChoices:"+$ts%+".WriteTest" TO ;c%
 2988         IF(c%AND1) PROCrelease_file:ERROR  254 ,FNmsg_1(A%! 12 ,"OKAN",$ts%)
 2989         SYS"XOS_File",6,"PrinterChoices:"+$ts%+".WriteTest" TO d%;c%
 2990       ENDIF
 2991       ptr%=!data_ptr%
 2992       PROCvalidate_one_entry(psup%,psup%! 8 )
 2993       !data_ptr%=ptr%
 2994       ENDPROC
 2995     ELSE
 2996       psup%=psup%! 0 
 2997     ENDIF
 2998   ENDWHILE
 2999   IF psup%=0 THEN
 3000     PROClocal_file
 3001     PROCinitialise_one_support_library($ts%)
 3002     PROCinitialise_one_psup($ts%,psup%)  
 3003     PROCrestore_file
 3004     PROCtimeout_reinitialise
 3005     IF psup%! 24  AND  32  THEN
 3006       SYS"XOS_File",7,"PrinterChoices:"+$ts%+".WriteTest" TO ;c%
 3007       IF(c%AND1) PROCrelease_file:ERROR  254 ,FNmsg_1(A%! 12 ,"OKAN",$ts%)
 3008       SYS"XOS_File",6,"PrinterChoices:"+$ts%+".WriteTest"
 3009     ENDIF
 3010     PROCprinter_reason_code(psup%,A%! 48 ,-5,0)
 3011   ENDIF
 3012   IF psup%=0 PROCvalidate_error(FNmsg_1(A%! 12 ,"OKZb",$ts%))
 3013 ENDPROC
 3014 DEF PROCvalidate_one_entry(psup%,tmpt%)
 3015   LOCAL ntry%,ts%
 3016   ntry%=tmpt%! 4 
 3017   REPEAT
 3018     ts%=FNmatch_line($(ntry%+ 16 ))
 3019     IF ts% THEN
 3020       CASE ntry%! 4  OF
 3021         WHEN 5
 3022           PROCvalidate_one_boolean(psup%,tmpt%,$ts%)
 3023         WHEN 6
 3024           IF ?ts%=13 PROCvalidate_error(FNmsg_1(A%! 12 ,"OK7a",$(ntry%+ 16 )))
 3025           PROCvalidate_one_list(psup%,tmpt%,$ts%)
 3026         WHEN 7
 3027           PROCvalidate_one_pointer(psup%,tmpt%,$ts%)
 3028         WHEN 8
 3029           IF ?ts%=13 PROCvalidate_error(FNmsg_1(A%! 12 ,"OK7a",$(ntry%+ 16 )))
 3030           PROCvalidate_one_charlist(psup%,tmpt%,$ts%)
 3031       ENDCASE
 3032     ENDIF
 3033     ntry%=ntry%! 0 
 3034   UNTIL ntry%=0
 3035 ENDPROC
 3036 DEF PROCvalidate_one_boolean(psup%,tmpt%,t$)
 3037   LOCAL ts%,int$,str$
 3038   ts%=FNmatch_any_line
 3039   IF ts% THEN
 3040     CASE ntry%! 8  OF
 3041       WHEN 1
 3042         ts%=FNsplit_integer(ts%,int%)
 3043         IF ?ts%=13 ts%=FNmatch_any_line
 3044       WHEN 2,3,4
 3045         ts%=FNsplit_string(ts%,str$)
 3046         IF ?ts%=13 ts%=FNmatch_any_line
 3047       WHEN 7
 3048         ts%=FNsplit_string(ts%,str$)
 3049         PROCvalidate_one_pointer(psup%,tmpt%,str$)
 3050         IF ?ts%=13 ts%=FNmatch_any_line
 3051         PROCvalidate_one_pointer(psup%,tmpt%,$ts%)
 3052     ENDCASE
 3053   ENDIF
 3054 ENDPROC
 3055 DEF PROCvalidate_one_list(psup%,tmpt%,t$)
 3056   LOCAL i%,p%,ned%,ts%
 3057   ned%=VAL t$
 3058   IF 1<=ned% THEN
 3059     FOR i%=1 TO ned%
 3060       ts%=FNmatch_any_line
 3061       IF ts% THEN
 3062         p%=ntry%! 8 
 3063         WHILE p%
 3064           IF p%! 4 =7 PROCvalidate_one_pointer(psup%,tmpt%,$ts%)
 3065           p%=!p%
 3066         ENDWHILE
 3067       ENDIF
 3068     NEXT
 3069   ENDIF
 3070 ENDPROC
 3071 DEF PROCvalidate_one_pointer(psup%,tmpt%,name$)
 3072   LOCAL i%,s$,t$
 3073   i%=INSTR(name$,":")
 3074   IF i%=0 PROCvalidate_error(FNmsg_1(A%! 12 ,"OKAA",name$))
 3075   s$=LEFT$(name$,i%-1)
 3076   t$=MID$(name$,i%+1)
 3077   tmpt%=psup%! 8 
 3078   WHILE tmpt%
 3079     IF $(tmpt%+ 12 )=s$ THEN
 3080       IF VAL t$>0 THEN
 3081         ENDPROC
 3082       ELSE
 3083         PROCvalidate_one_entry(psup%,tmpt%)
 3084         ENDPROC
 3085       ENDIF
 3086     ELSE
 3087       tmpt%=tmpt%! 0 
 3088     ENDIF
 3089   ENDWHILE
 3090   PROCvalidate_error(FNmsg_1(A%! 12 ,"OKAB",s$))
 3091 ENDPROC
 3092 DEF PROCvalidate_one_charlist(psup%,tmpt%,t$)
 3093   LOCAL i%,ned%
 3094   ned%=VAL t$
 3095   IF 1<=ned% THEN
 3096     FOR i%=1 TO ned%
 3097       IF FNmatch_any_line
 3098     NEXT
 3099   ENDIF
 3100 ENDPROC
 3101 DEF PROCadd_to_prdata
 3102   LOCAL ts%,psup%,ptr%,s$,ntry%,prdata%,last_prdata%,this_prhead%,matched%,fix_up%
 3103   ts%=task_buff%+44
 3104   CALL Z%,ts%,s$  
 3105   IF NOT FNload_file(s$)     ERROR  254 ,FNmsg_1(A%! 12 ,"OKX",s$)
 3106   SYS "Hourglass_On"
 3107   PROCvalidate_prdata_file(psup%)
 3108   this_prhead%=psup%! 12 
 3109   IF this_prhead% THEN
 3110     prdata%=this_prhead%! 4 
 3111     IF prdata% THEN
 3112       ptr%=!data_ptr%
 3113       ntry%=psup%! 8 
 3114       ntry%=ntry%! 4 
 3115       ts%=FNmatch_line($(ntry%+ 16 ))
 3116       IF ts% THEN
 3117         WHILE prdata%
 3118           IF $prdata%! 8 =$ts% THEN
 3119             PROCrelease_file
 3120             SYS "Hourglass_Off"
 3121             PROCinstall_printer(psup%,prdata%)
 3122             ENDPROC
 3123           ENDIF
 3124           last_prdata%=prdata%
 3125           prdata%=prdata%! 0 
 3126         ENDWHILE
 3127       ELSE
 3128         PROCvalidate_error(FNmsg_1(A%! 12 ,"OKZc",            $(ntry%+ 16 )))
 3129       ENDIF
 3130       !data_ptr%=ptr%
 3131     ELSE
 3132       last_prdata%=0
 3133     ENDIF
 3134   ELSE
 3135     last_prdata%=0
 3136   ENDIF
 3137   PROCprocess_one_entry(psup%! 8 ,last_prdata%,this_prhead%,0,      matched%,fix_up%,psup%)
 3138   PROCrelease_file
 3139   psup%! 24 =psup%! 24  OR  2 
 3140   PROCinstall_printer(psup%,last_prdata%)
 3141   SYS "Hourglass_Off"
 3142 ENDPROC
 3143 DEF PROCram_file_error(s$)
 3144   PROCrelease_file
 3145   ERROR  254 ,FNmsg_3(A%! 12 ,"OK0",STR$ data_line%,data_file$,s$)
 3146 ENDPROC
 3147 DEF PROCprdata_error(psup%,s$,tag$)
 3148   PROCram_file_error(FNmsg_2(A%! 12 ,tag$,$psup%! 4 ,s$))
 3149 ENDPROC
 3150 DEF PROCprocess_template(database%)
 3151   LOCAL ts%,ss%,depth%,i%,this_template%,last_template%,this_entry%,last_entry%
 3152   ts%=FNmatch_line("tp:")
 3153   IF ts%=0 PROCprdata_error(database%,FNmsg_0(A%! 12 ,"OK3"),"OK2a")
 3154   REPEAT
 3155     ts%=FNmatch_any_line
 3156     IF ts% THEN
 3157       ss%=FNmatch_string(ts%,"tp:")
 3158       IF ss% THEN
 3159         depth%+=1
 3160         B%= &54504D54 
 3161         C%= 12 +1+LEN $ss%
 3162         this_template%=USR(code_entry%+ 12 )
 3163         IF this_template%=0 PROCprdata_error(database%,FNmsg_1(A%! 12 ,"FA5","TMPT"),"OK2a")
 3164         IF last_template% THEN
 3165           last_template%! 0 =this_template%
 3166         ELSE
 3167           database%! 8 =this_template%
 3168         ENDIF
 3169         this_template%! 0 =0
 3170         this_template%! 4 =0
 3171         this_template%! 8 =0
 3172         $(this_template%+ 12 )=$ss%
 3173         last_entry%=0
 3174       ELSE
 3175         ss%=FNmatch_string(ts%,"end:")
 3176         IF ss% THEN
 3177           IF ?ss%<>13 PROCprdata_error(database%,FNmsg_0(A%! 12 ,"OK3a"),"OK2a")
 3178           depth%-=1
 3179           last_template%=this_template%
 3180         ELSE
 3181           i%=INSTR($ts%,":")
 3182           IF i%=0 PROCprdata_error(database%,FNmsg_1(A%! 12 ,"OK4",$ts%),"OK2a")
 3183           IF depth%<>1 PROCprdata_error(database%,FNmsg_1(A%! 12 ,"OK4a",$ts%),"OK2a")
 3184           this_template%! 8 +=1
 3185           B%= &5952544E 
 3186           C%= 16 +1+i%
 3187           this_entry%=USR(code_entry%+ 12 )
 3188           IF this_entry%=0 PROCprdata_error(database%,FNmsg_1(A%! 12 ,"FA5","NTRY"),"OK2a")
 3189           IF last_entry% last_entry%! 0 =this_entry% ELSE this_template%! 4 =this_entry%
 3190           this_entry%! 0 =0
 3191           this_entry%! 4 =0
 3192           this_entry%! 8 =0
 3193           this_entry%! 12 =0
 3194           $(this_entry%+ 16 )=LEFT$($ts%,i%)
 3195           ts%+=i%+1
 3196           CASE  -1  OF
 3197             WHEN FNmatch_string(ts%,"in")<>0
 3198               this_entry%! 4 =1
 3199             WHEN FNmatch_string(ts%,"st")<>0
 3200               this_entry%! 4 =2
 3201             WHEN FNmatch_string(ts%,"s0")<>0
 3202               this_entry%! 4 =3
 3203             WHEN FNmatch_string(ts%,"gs")<>0
 3204               this_entry%! 4 =4
 3205             WHEN FNmatch_string(ts%,"bl")<>0
 3206               this_entry%! 4 =5
 3207               ss%=FNmatch_string(ts%,"bl")  
 3208               WHILE ?ss%=32
 3209                 ss%+=1
 3210               ENDWHILE
 3211               IF ?ss%=ASC "," ss%+=1
 3212               CASE  -1  OF
 3213                 WHEN FNmatch_string(ss%,"in")<>0
 3214                   this_entry%! 8 =1
 3215                 WHEN FNmatch_string(ss%,"st")<>0
 3216                   this_entry%! 8 =2
 3217                 WHEN FNmatch_string(ss%,"s0")<>0
 3218                   this_entry%! 8 =3
 3219                 WHEN FNmatch_string(ss%,"gs")<>0
 3220                   this_entry%! 8 =4
 3221                 WHEN FNmatch_string(ss%,"ptr")<>0
 3222                   this_entry%! 8 =7
 3223                 OTHERWISE
 3224                   PROCprdata_error(database%,FNmsg_1(A%! 12 ,"OK5",$ss%),"OK2a")
 3225               ENDCASE
 3226             WHEN FNmatch_string(ts%,"ls")<>0
 3227               this_entry%! 4 =6
 3228               ss%=FNmatch_string(ts%,"ls")
 3229               PROCmatch_list(ss%,this_entry%,database%)
 3230             WHEN FNmatch_string(ts%,"ptr")<>0
 3231               this_entry%! 4 =7
 3232             WHEN FNmatch_string(ts%,"ch")<>0
 3233               this_entry%! 4 =8
 3234             OTHERWISE
 3235               PROCprdata_error(database%,FNmsg_1(A%! 12 ,"OK6",$ts%),"OK2a")
 3236           ENDCASE
 3237           last_entry%=this_entry%
 3238         ENDIF
 3239       ENDIF
 3240     ENDIF
 3241   UNTIL depth%=-1
 3242 ENDPROC
 3243 DEF PROCmatch_list(rs%,ntry%,database%)
 3244   LOCAL list%,ptr%,t%
 3245   ptr%=ntry%+ 8 
 3246   REPEAT
 3247     WHILE ?rs%=32
 3248       rs%+=1
 3249     ENDWHILE
 3250     IF ?rs%=44 rs%+=1  
 3251     WHILE ?rs%=32
 3252       rs%+=1
 3253     ENDWHILE
 3254     IF ?rs%<>13 THEN
 3255       ntry%! 12 +=1  
 3256       B%= &5453494C 
 3257       C%= 8 
 3258       list%=USR(code_entry%+ 12 )
 3259       IF list%=0 ERROR  253 ,FNmsg_1(A%! 12 ,"FA5","LIST")
 3260       !ptr%=list%
 3261       ptr%=list%
 3262       list%! 0 =0
 3263       t%=FNmatch_string(rs%,"in")
 3264       IF t% THEN
 3265         rs%=t%
 3266         list%! 4 =1
 3267       ELSE
 3268         t%=FNmatch_string(rs%,"st")
 3269         IF t% THEN
 3270           rs%=t%
 3271           list%! 4 =2
 3272         ELSE
 3273           t%=FNmatch_string(rs%,"s0")
 3274           IF t% THEN
 3275             rs%=t%
 3276             list%! 4 =3
 3277           ELSE
 3278             t%=FNmatch_string(rs%,"gs")
 3279             IF t% THEN
 3280               rs%=t%
 3281               list%! 4 =4
 3282             ELSE
 3283               t%=FNmatch_string(rs%,"ptr")
 3284               IF t% THEN
 3285                 rs%=t%
 3286                 list%! 4 =7
 3287               ELSE
 3288                 PROCprdata_error(database%,FNmsg_1(A%! 12 ,"OK7",$rs%),"OK2a")
 3289               ENDIF
 3290             ENDIF
 3291           ENDIF
 3292         ENDIF
 3293       ENDIF
 3294     ENDIF
 3295   UNTIL ?rs%=13
 3296 ENDPROC
 3297 DEF FNmatch_line(m$)
 3298   LOCAL tail%,i%
 3299   i%=data_block%+!data_ptr%
 3300   WHILE i%<data_block%+data_size%
 3301     WHILE ?i%=32
 3302       i%+=1
 3303     ENDWHILE
 3304     IF ?i%=35 OR ?i%=13 THEN
 3305       i%+=LEN $i%+1
 3306       data_line%+=1
 3307     ELSE
 3308       IF m$=LEFT$($i%,LEN m$)THEN
 3309         tail%=i%+LEN m$
 3310         WHILE ?tail%=32
 3311           tail%+=1
 3312         ENDWHILE
 3313         i%+=LEN $i%+1
 3314         !data_ptr%=i%-data_block%
 3315         data_line%+=1
 3316         =tail%
 3317       ELSE
 3318         i%+=LEN $i%+1
 3319         data_line%+=1
 3320       ENDIF
 3321     ENDIF
 3322   ENDWHILE
 3323 =0
 3324 DEF FNmatch_any_line
 3325   LOCAL tail%,i%
 3326   i%=data_block%+!data_ptr%
 3327   WHILE i%<data_block%+data_size%
 3328     WHILE ?i%=32
 3329       i%+=1
 3330     ENDWHILE
 3331     IF ?i%=35 OR ?i%=13 THEN
 3332       i%+=LEN $i%+1
 3333       !data_ptr%=i%-data_block%  
 3334       data_line%+=1
 3335     ELSE
 3336       tail%=i%
 3337       i%+=LEN $i%+1
 3338       !data_ptr%=i%-data_block%
 3339       data_line%+=1
 3340       =tail%
 3341     ENDIF
 3342   ENDWHILE
 3343 =0
 3344 DEF FNmatch_string(ts%,m$)
 3345   WHILE ?ts%=32
 3346     ts%+=1
 3347   ENDWHILE
 3348   IF m$=LEFT$($ts%,LEN m$)THEN
 3349     ts%+=LEN m$
 3350     WHILE ?ts%=32
 3351       ts%+=1
 3352     ENDWHILE
 3353     =ts%
 3354   ENDIF
 3355 =0
 3356 DEF PROCprocess_one_entry(tmpt%,RETURN last_prdata%,this_prhead%,last_prhead%,RETURN matched%,RETURN fix_up%,psup%)
 3357   LOCAL offset%,this_prdata%,file_ptr%,ts%,ss%,ntry%,i%,size%
 3358   ntry%=tmpt%! 4 
 3359   offset%=-1
 3360   REPEAT
 3361     file_ptr%=!data_ptr%
 3362     matched%=0
 3363     ts%=FNmatch_any_line:  
 3364     IF ts% THEN
 3365       IF offset%=-1 THEN
 3366         size%=4*tmpt%! 8 + 8 
 3367         B%= &54445250 
 3368         C%=size%+8
 3369         this_prdata%=USR(code_entry%+ 12 )
 3370         IF this_prdata%=0           ERROR  253 ,FNmsg_1(A%! 12 ,"FA5","PRDT")
 3371         IF 0<=size%+7 THEN
 3372           FOR i%=0 TO size%+7 STEP 4
 3373             this_prdata%!i%=0
 3374           NEXT
 3375         ENDIF
 3376         IF last_prdata% last_prdata%! 0 =this_prdata% ELSE this_prhead%! 4 =this_prdata%
 3377         this_prdata%! 4 =tmpt%! 8 
 3378         offset%=8
 3379       ENDIF
 3380       REPEAT
 3381         ss%=FNmatch_string(ts%,$(ntry%+ 16 )):  
 3382         IF ss% THEN
 3383           matched%=1
 3384           CASE ntry%! 4  OF
 3385             WHEN 1
 3386               this_prdata%!offset%=FNstore_integer(FNevaluate($ss%))
 3387             WHEN 2,3,4
 3388               B%=ss%
 3389               C%=ntry%! 4 
 3390               this_prdata%!offset%=USR(code_entry%+ 28 )
 3391             WHEN 5
 3392               this_prdata%!offset%=FNretrieve_boolean(ntry%,fix_up%)
 3393             WHEN 6
 3394               IF ?ss%=13 PROCprdata_error(psup%,FNmsg_1(A%! 12 ,"OK7a",$ts%),"OK2")
 3395               this_prdata%!offset%=FNretrieve_list(ntry%,FNevaluate($ss%),fix_up%)
 3396             WHEN 7
 3397               IF ?ss%<>13 PROCretrieve_ptr(psup%,$ss%,this_prdata%+offset%,fix_up%)
 3398             WHEN 8
 3399               IF ?ss%=13 PROCprdata_error(psup%,FNmsg_1(A%! 12 ,"OK7a",$ts%),"OK2")
 3400               this_prdata%!offset%=FNretrieve_charlist(ntry%,FNevaluate($ss%))
 3401           ENDCASE
 3402         ENDIF
 3403         offset%+=4
 3404         ntry%=ntry%! 0 
 3405       UNTIL ntry%=0 OR matched%
 3406     ENDIF
 3407     IF matched%=0 THEN
 3408       IF !data_ptr%>=data_size% matched%=3
 3409       !data_ptr%=file_ptr%
 3410       ntry%=tmpt%! 4 
 3411       ss%=FNmatch_string(ts%,$(ntry%+ 16 ))
 3412       IF ss% THEN
 3413         matched%=1
 3414       ELSE
 3415         tmpt%=tmpt%! 0 
 3416         ss%=FNmatch_string(ts%,$(tmpt%+ 12 )+":")
 3417         IF ss% matched%=2
 3418       ENDIF
 3419       ntry%=0
 3420     ENDIF
 3421   UNTIL ntry%=0
 3422   last_prdata%=this_prdata%
 3423 ENDPROC
 3424 DEF PROCprocess_file(psup%)
 3425   LOCAL tmpt%,s$,ts%,file_ptr%,ntry%,matched%,this_prdata%,last_prdata%,this_prhead%,last_prhead%,fix_up%,i%
 3426   tmpt%=psup%! 8 
 3427   REPEAT
 3428     ts%=FNmatch_line($(tmpt%+ 12 )+":")
 3429     IF ts%=0 PROCprdata_error(psup%,FNmsg_1(A%! 12 ,"OK8",$(tmpt%+ 12 )),"OK2")
 3430     B%= &44414548 
 3431     C%= 12 
 3432     this_prhead%=USR(code_entry%+ 12 )
 3433     IF this_prhead%=0 PROCprdata_error(psup%,FNmsg_1(A%! 12 ,"FA5","HEAD"),"OK2")
 3434     this_prhead%! 0 =0
 3435     this_prhead%! 4 =0
 3436     IF last_prhead% last_prhead%! 0 =this_prhead% ELSE psup%! 12 =this_prhead%
 3437     last_prdata%=0
 3438     REPEAT
 3439       ntry%=tmpt%! 4 
 3440       PROCprocess_one_entry(tmpt%,last_prdata%,this_prhead%,last_prhead%,matched%,fix_up%,psup%)
 3441       IF matched%=0 THEN
 3442         ts%=FNmatch_any_line
 3443         PROCprdata_error(psup%,FNmsg_1(A%! 12 ,"OK9",$ts%),"OK2")
 3444       ENDIF
 3445     UNTIL matched%<>1
 3446     tmpt%=tmpt%! 0 
 3447     last_prhead%=this_prhead%
 3448   UNTIL tmpt%=0
 3449   WHILE fix_up%
 3450     i%=fix_up%!4
 3451     s$=$!i%
 3452     B%= &52544F50 
 3453     C%=!i%
 3454     CALL code_entry%+ 16 
 3455     B%= &52544F50 
 3456     C%=4
 3457     !i%=USR(code_entry%+ 12 )
 3458     IF !i%=0 PROCprdata_error(psup%,FNmsg_1(A%! 12 ,"FA5","POTR"),"OK2")
 3459     !!i%=FNfix_up_pointer(s$, -1 )
 3460     i%=fix_up%
 3461     fix_up%=!fix_up%
 3462     B%= &58585858 
 3463     C%=i%
 3464     CALL code_entry%+ 16 
 3465   ENDWHILE
 3466 ENDPROC
 3467 DEF FNfix_up_pointer(s$,inc_count%)
 3468   LOCAL j%,k%,t$
 3469   j%=INSTR(s$,":")
 3470   t$=MID$(s$,j%+1)
 3471   s$=LEFT$(s$,j%-1)
 3472   j%=psup%! 8 
 3473   k%=0
 3474   WHILE j%
 3475    IF$(j%+ 12 )=s$ THEN
 3476     j%=psup%! 12 
 3477     WHILE k%
 3478      j%=j%! 0 
 3479      k%-=1
 3480     ENDWHILE
 3481     k%=VAL t$-1
 3482     j%=j%! 4 
 3483     WHILE k%
 3484      j%=j%! 0 
 3485      k%-=1
 3486     ENDWHILE
 3487     IF inc_count% j%!(j%! 4 *4+ 8 )+=1
 3488     =j%
 3489    ELSE
 3490     j%=j%! 0 
 3491     k%+=1
 3492    ENDIF
 3493   ENDWHILE
 3494   PROCerror_warning(FNmsg_2(A%! 12 ,"FAG",s$,t$))
 3495 =0
 3496 DEF FNstore_integer(v%)
 3497   LOCAL b%
 3498   B%= &47544E49 
 3499   C%=4
 3500   b%=USR(code_entry%+ 12 )
 3501   IF b%=0 ERROR  253 ,FNmsg_1(A%! 12 ,"FA5","INTG")
 3502   !b%=v%
 3503 =b%
 3504 DEF FNgstrans(s$)
 3505   LOCAL t$,i%,len%
 3506   SYS "OS_GSTrans",s$,buff1%,256 TO,,len%
 3507   IF len%=0 THEN =""
 3508   FOR i%=0 TO len%-1
 3509     t$+=CHR$ buff1%?i%
 3510   NEXT
 3511 =t$
 3512 DEF FNungstrans(s$)
 3513   LOCAL t$,i%,c%
 3514   IF s$="" THEN =""
 3515   FOR i%=1 TO LEN s$
 3516     c%=ASC MID$(s$,i%,1)
 3517     IF c%>=128 c%-=128: t$+="|!"
 3518     IF c%<32 c%+=64: t$+="|"
 3519     IF c%=127 c%=63: t$+="|"  
 3520     IF INSTR("|<""",CHR$ c%)THEN t$+="|"
 3521     t$+=CHR$ c%
 3522   NEXT
 3523 =t$
 3524 DEF FNretrieve_boolean(ntry%,RETURN fix_up%)
 3525   LOCAL ts%,int%,b%,str$
 3526   B%= &4C4f4F42 
 3527   C%= 8 
 3528   b%=USR(code_entry%+ 12 )
 3529   IF b%=0 ERROR  253 ,FNmsg_1(A%! 12 ,"FA5","BOOL")
 3530   ts%=FNmatch_any_line
 3531   IF ts% THEN
 3532     CASE ntry%! 8  OF
 3533       WHEN 1
 3534         ts%=FNsplit_integer(ts%,int%)
 3535         b%! 0 =FNstore_integer(int%)
 3536         IF ?ts%=13 ts%=FNmatch_any_line
 3537         b%! 4 =FNstore_integer(FNevaluate($ts%))
 3538       WHEN 2,3,4
 3539         ts%=FNsplit_string(ts%,str$)
 3540         $task_buff%=str$
 3541         B%=task_buff%
 3542         C%=ntry%! 8 
 3543         b%! 0 =USR(code_entry%+ 28 )
 3544         IF ?ts%=13 ts%=FNmatch_any_line
 3545         B%=ts%
 3546         C%=ntry%! 8 
 3547         b%! 4 =USR(code_entry%+ 28 )
 3548       WHEN 7
 3549         ts%=FNsplit_string(ts%,str$)
 3550         PROCretrieve_ptr(psup%,s$,b%+ 0 ,fix_up%)
 3551         IF ?ts%=13 ts%=FNmatch_any_line
 3552         PROCretrieve_ptr(psup%,$ts%,b%+ 4 ,fix_up%)
 3553     ENDCASE
 3554   ENDIF
 3555 =b%
 3556 DEF FNretrieve_list(ntry%,num%,RETURN fix_up%)
 3557   LOCAL i%,ptr%,this_rec%,last_rec%,ts%,list_ptr%,list_off%,int%,str$
 3558   IF 1<=num% THEN
 3559     FOR i%=1 TO num%
 3560       B%= &4454534C 
 3561       C%=4*ntry%! 12 + 8 
 3562       this_rec%=USR(code_entry%+ 12 )
 3563       IF this_rec%=0 ERROR  253 ,FNmsg_1(A%! 12 ,"FA5","LSTD")
 3564       IF last_rec% last_rec%! 0 =this_rec% ELSE ptr%=this_rec%
 3565       this_rec%! 0 =0
 3566       this_rec%! 4 =ntry%! 12 
 3567       list_off%=8
 3568       ts%=FNmatch_any_line
 3569       IF ts% THEN
 3570         list_ptr%=ntry%! 8 
 3571         WHILE list_ptr%
 3572           CASE list_ptr%! 4  OF
 3573             WHEN 1
 3574              ts%=FNsplit_integer(ts%,int%)
 3575              this_rec%!list_off%=FNstore_integer(int%)
 3576             WHEN 2,3,4
 3577              ts%=FNsplit_string(ts%,str$)
 3578              $task_buff%=str$
 3579              B%=task_buff%
 3580              C%=list_ptr%! 4 
 3581              this_rec%!list_off%=USR(code_entry%+ 28 )
 3582             WHEN 7
 3583              ts%=FNsplit_string(ts%,str$)
 3584              PROCretrieve_ptr(psup%,str$,this_rec%+list_off%,fix_up%)
 3585           ENDCASE
 3586           list_ptr%=!list_ptr%
 3587           list_off%+=4
 3588         ENDWHILE
 3589       ENDIF
 3590       last_rec%=this_rec%
 3591     NEXT
 3592   ENDIF
 3593 =ptr%
 3594 DEF FNretrieve_charlist(ntry%,num%)
 3595   LOCAL i%,this_rec%,ts%,last_rec%,ptr%,j%,t$
 3596   IF 1<=num% THEN
 3597     FOR i%=1 TO num%
 3598       ts%=FNmatch_any_line
 3599       IF ts% THEN
 3600         t$=FNgstrans($ts%)
 3601         B%= &52414843 
 3602         C%=5+LEN t$
 3603         this_rec%=USR(code_entry%+ 12 )
 3604         IF this_rec%=0 ERROR  253 ,FNmsg_1(A%! 12 ,"FA5","CHAR")
 3605         this_rec%!0=0
 3606         this_rec%?4=ASC t$
 3607         this_rec%?5=LEN t$-1
 3608         t$=MID$(t$,2)
 3609         IF 1<=LEN t$ THEN
 3610           FOR j%=1 TO LEN t$
 3611             this_rec%?(j%+5)=ASC MID$(t$,j%,1)
 3612           NEXT
 3613         ENDIF
 3614         IF last_rec% last_rec%!0=this_rec% ELSE ptr%=this_rec%
 3615       ENDIF
 3616       last_rec%=this_rec%
 3617     NEXT
 3618   ENDIF
 3619 =ptr%
 3620 DEF PROCretrieve_ptr(psup%,name$,addr%,RETURN fix_up%)
 3621   LOCAL i%,s$,t$,xxxx%,old_last_prdata%,last_prhead%,tmpt%,last_prdata%,prhead%,matched%,this_prdata%,t$
 3622   i%=INSTR(name$,":"): IF i%=0 PROCprdata_error(psup%,FNmsg_1(A%! 12 ,"OKAA",name$),"OK2")
 3623   s$=LEFT$(name$,i%-1)
 3624   t$=MID$(name$,i%+1)
 3625   tmpt%=psup%! 8 
 3626   prhead%=psup%! 12 
 3627   last_prhead%=0
 3628   WHILE tmpt%
 3629    IF $(tmpt%+ 12 )=s$ THEN
 3630     IF VAL t$>0 THEN
 3631      B%= &52544F50 
 3632      C%=LEN name$+1
 3633      i%=USR(code_entry%+ 12 )
 3634      IF i%=0 ERROR  253 ,FNmsg_1(A%! 12 ,"FA5","POTR")
 3635      $i%=name$
 3636      !addr%=i%
 3637      B%= &58585858 
 3638      C%=8
 3639      xxxx%=USR(code_entry%+ 12 )
 3640      IF xxxx%=0 ERROR  253 ,FNmsg_1(A%! 12 ,"FA5","XXXX")
 3641      !xxxx%=fix_up%
 3642      xxxx%!4=addr%
 3643      fix_up%=xxxx%
 3644      ENDPROC
 3645     ELSE
 3646      IF prhead% THEN
 3647       last_prdata%=prhead%! 4 
 3648       IF last_prdata% THEN
 3649        WHILE last_prdata%! 0 
 3650         last_prdata%=last_prdata%! 0 
 3651        ENDWHILE
 3652       ENDIF
 3653      ELSE
 3654       last_prdata%=0
 3655      ENDIF
 3656      old_last_prdata%=last_prdata%
 3657      PROCprocess_one_entry(tmpt%,last_prdata%,prhead%,last_prhead%,matched%,fix_up%,psup%)
 3658      IF matched%=0 AND last_prdata%=0 THEN
 3659       ts%=FNmatch_any_line
 3660       IF ts% t$=$ts% ELSE t$=""
 3661       PROCprdata_error(psup%,FNmsg_1(A%! 12 ,"OK9",t$),"OK2")
 3662      ENDIF
 3663      this_prdata%=prhead%! 4 
 3664      WHILE this_prdata%<>last_prdata%
 3665       IF this_prdata%!(this_prdata%!4*4+8)THEN
 3666        matched%= -1 
 3667        IF 0<=this_prdata%! 4 -1 THEN
 3668          FOR i%=0 TO this_prdata%! 4 -1
 3669           IF NOTFNmatch_prdata_entry(this_prdata%,last_prdata%,i%*4+ 8 )THEN
 3670            matched%= 0 
 3671            i%=this_prdata%! 4 
 3672           ENDIF
 3673          NEXT
 3674        ENDIF
 3675        IF matched% THEN
 3676         IF 0<=last_prdata%! 4 -1 THEN
 3677           FOR i%=0 TO last_prdata%! 4 -1
 3678            xxxx%=last_prdata%!(i%*4+ 8 )
 3679            PROCcheck_prdata_ptr(xxxx%)
 3680            PROCfree_structure(xxxx%)
 3681           NEXT
 3682         ENDIF
 3683         old_last_prdata%! 0 =0
 3684         B%= &54445250 
 3685         C%=last_prdata%
 3686         CALL code_entry%+ 16 
 3687         last_prdata%=this_prdata%
 3688        ELSE
 3689         this_prdata%=!this_prdata%
 3690        ENDIF
 3691       ELSE
 3692        this_prdata%=!this_prdata%
 3693       ENDIF
 3694      ENDWHILE
 3695      B%= &52544F50 
 3696      C%=4
 3697      i%=USR(code_entry%+ 12 )
 3698      IF i%=0 ERROR  253 ,FNmsg_1(A%! 12 ,"FA5","POTR")
 3699      !i%=last_prdata%
 3700      !addr%=i%
 3701      last_prdata%!(last_prdata%! 4 *4+ 8 )+=1
 3702      ENDPROC
 3703     ENDIF
 3704    ELSE
 3705     tmpt%=tmpt%! 0 
 3706     IF VAL t$=0 THEN
 3707      last_prhead%=prhead%
 3708      prhead%=prhead%! 0 
 3709     ENDIF
 3710    ENDIF
 3711   ENDWHILE
 3712   PROCprdata_error(psup%,FNmsg_1(A%! 12 ,"OKAB",s$),"OK2")
 3713 ENDPROC
 3714 DEF FNmatch_prdata_entry(s%,d%,o%)
 3715   LOCAL s$,d$
 3716   s%=s%!o%
 3717   d%=d%!o%
 3718   IF s%=0 OR d%=0 THEN
 3719    =(s%=d%)
 3720   ELSE
 3721    CASE s%!-4 OF
 3722     WHEN  &47544E49 
 3723      =!s%=!d%
 3724     WHEN  &47525453 
 3725      =$s%=$d%
 3726     WHEN  &30525453 
 3727       CALL Z%,s%,s$  
 3728       CALL Z%,d%,d$  
 3729      =s$=d$
 3730     WHEN  &52545347 
 3731       CALL Y%,s%,s$  
 3732       CALL Y%,d%,d$  
 3733      =s$=d$
 3734     WHEN  &4C4f4F42 
 3735      =FNmatch_prdata_bool(s%,d%)
 3736     WHEN  &4454534C 
 3737      =FNmatch_prdata_list(s%,d%)
 3738     WHEN  &52544F50 
 3739      =!s%=!d%
 3740     WHEN  &52414843 
 3741      =FNmatch_prdata_char(s%,d%)
 3742     OTHERWISE
 3743      PROCerror_warning(FNmsg_1(A%! 12 ,"WA10",STR$~s%!-4))
 3744    ENDCASE
 3745   ENDIF
 3746 = 0 
 3747 DEF FNmatch_prdata_bool(s%,d%)
 3748 IF FNmatch_prdata_entry(s%,d%, 0 )THEN =FNmatch_prdata_entry(s%,d%, 4 )ELSE = 0 
 3749 DEF FNmatch_prdata_list(s%,d%)
 3750   LOCAL i%
 3751   WHILE s%
 3752     IF 0<=s%! 4 -1 THEN
 3753       FOR i%=0 TO s%! 4 -1
 3754         IF NOT FNmatch_prdata_entry(s%,d%,i%*4+ 8 )THEN = 0 
 3755       NEXT
 3756     ENDIF
 3757     s%=s%! 0 
 3758     d%=d%! 0 
 3759   ENDWHILE
 3760 = -1 
 3761 DEF FNmatch_prdata_char(s%,d%)
 3762   LOCAL i%
 3763   WHILE s%
 3764    IF s%?4<>d%?4 THEN = 0 
 3765    IF s%?5<>d%?5 THEN = 0 
 3766    i%=s%?5
 3767    WHILE i%
 3768      IF s%?(i%+5)<>d%?(i%+5)THEN = 0 
 3769      i%-=1
 3770    ENDWHILE
 3771    s%=!s%
 3772    d%=!d%
 3773   ENDWHILE
 3774 = -1 
 3775 DEF FNsplit_integer(input%,RETURN int%)
 3776   LOCAL i%,output%
 3777   i%=INSTR($input%,",")
 3778   IF i%=0 THEN
 3779     int%=FNevaluate($input%)
 3780     output%=input%+LEN $input%
 3781   ELSE
 3782     int%=FNevaluate(LEFT$($input%,i%-1))
 3783     output%=input%+i%
 3784     WHILE ?output%=32
 3785       output%+=1
 3786     ENDWHILE
 3787   ENDIF
 3788 =output%
 3789 DEF FNsplit_string(input%,RETURN str$)
 3790   LOCAL i%,output$,outside%,quoted%
 3791   str$=""
 3792   i%=0
 3793   WHILE input%?i%=32
 3794     i%+=1
 3795   ENDWHILE
 3796   outside%= -1 
 3797   quoted%=(input%?i%=34)
 3798   WHILE NOT(input%?i%=13 OR(outside% AND input%?i%=44))
 3799     IF NOT quoted% OR input%?i%<>34 OR outside% str$+=CHR$ input%?i%
 3800     IF quoted% AND input%?i%=34 outside%=NOT outside%
 3801     i%+=1
 3802   ENDWHILE
 3803   IF input%?i%=13 THEN
 3804     output%=input%+i%
 3805   ELSE
 3806     output%=input%+i%+1
 3807     WHILE ?output%=32
 3808       output%+=1
 3809     ENDWHILE
 3810   ENDIF
 3811 =output%
 3812 DEF FNload_file(name$)
 3813   LOCAL c%,i%,load_addr%,file_type%,ws_size%,ws%,output_size%,output%,status%,err%
 3814   SYS "OS_File",17,name$ TO c%,,load_addr%,,data_size%  
 3815   IF NOT(c%=0 OR c%=1)THEN SYS "OS_File",19,name$,c%  
 3816   IF c%=0 THEN = 0 
 3817   IF(load_addr%>>>20)=&FFF file_type%=load_addr%>>8 AND &FFF ELSE file_type%=-1
 3818   IF file_type%<>&FC6 ERROR  254 ,FNmsg_1(A%! 12 ,"OKAL",name$)
 3819   B%= &41544144 
 3820   C%=4+data_size%+1
 3821   data_block%=USR(code_entry%+ 12 )+4
 3822   IF data_block%=4 ERROR  253 ,FNmsg_1(A%! 12 ,"FA5","DATA")
 3823   SYS "OS_File",16,name$,data_block%  
 3824   IF data_size%>=20 AND data_block%!0=&48535153 THEN
 3825     SYS "Squash_Decompress",%1000,-1 TO ws_size%
 3826     output_size%=data_block%!4
 3827     B%= &41544144 
 3828     C%=4+output_size%+1
 3829     output%=USR(code_entry%+ 12 )+4
 3830     IF output%=4 ERROR  253 ,FNmsg_1(A%! 12 ,"FA5","DATA")
 3831     SYS "XOS_Module",6,,,ws_size% TO C%,,ws%;err%
 3832     IF(err%AND1) ERROR  253 ,FNmsg_1(A%! 12 ,"FA5","squash")
 3833     SYS "Squash_Decompress",%100,ws%,data_block%+20,data_size%-20,output%,output_size% TO status%
 3834     SYS "OS_Module",7,,ws%
 3835     B%= &41544144 
 3836     C%=data_block%-4
 3837     CALL code_entry%+ 16 
 3838     data_block%=output%
 3839     data_size%=output_size%
 3840   ENDIF
 3841   data_ptr%=data_block%-4
 3842   !data_ptr%=0
 3843   data_line%=1
 3844   B%=data_block%
 3845   C%=data_size%
 3846   CALL code_entry%+ 52 
 3847   IF data_block%?(data_size%-1)<>13 data_size%+=1: data_block%?(data_size%-1)=13
 3848   data_file$=name$
 3849 = -1 
 3850 DEF PROCrelease_file
 3851   B%= &41544144 
 3852   C%=data_block%-4
 3853   CALL code_entry%+ 16 
 3854   data_block%=0
 3855   data_size%=0
 3856 ENDPROC
 3857 DEF PROClocal_file
 3858   saved_data_block%=data_block%
 3859   saved_data_ptr%=data_ptr%
 3860   saved_data_size%=data_size%
 3861   saved_data_line%=data_line%
 3862   saved_data_file$=data_file$
 3863 ENDPROC
 3864 DEF PROCrestore_file
 3865   data_block%=saved_data_block%
 3866   data_ptr%=saved_data_ptr%
 3867   data_size%=saved_data_size%
 3868   data_line%=saved_data_line%
 3869   data_file$=saved_data_file$
 3870 ENDPROC
 3871 DEF PROCinstall_printer(psup%,prdt%)
 3872   LOCAL s%,t%,s$,prnt%,cnct%
 3873   prdt%!(prdt%! 4 *4+ 8 )+=1
 3874   B%= &544E5250 
 3875   C%= 68 
 3876   prnt%=USR(code_entry%+ 12 )
 3877   IF prnt%=0     ERROR  253 ,FNmsg_1(A%! 12 ,"FA5","PRNT")
 3878   IF A%! 48  THEN
 3879     s%=A%! 48 
 3880     WHILE s%! 0 
 3881       s%=s%! 0 
 3882     ENDWHILE
 3883     s%! 0 =prnt%
 3884   ELSE
 3885     A%! 48 =prnt%
 3886   ENDIF
 3887   prnt%! 0 =0
 3888   prnt%! 4 =psup%
 3889   B%=prdt%! 8 
 3890   C%=2
 3891   prnt%! 8 =USR(code_entry%+ 28 )
 3892   B%= &54434E43 
 3893   C%= 36 
 3894   cnct%=USR(code_entry%+ 12 )
 3895   IF cnct%=0     ERROR  253 ,FNmsg_1(A%! 12 ,"FA5","CNCT")
 3896   SYS "OS_Byte",161,15 TO,,s%
 3897   cnct%! 0 =(s% AND %11100000)>>5
 3898   cnct%? 4 =1+((s% AND %11100)>>2)
 3899   cnct%? 5 =0
 3900   SYS "OS_Byte",161,16 TO,,s%
 3901   cnct%! 8 =(s% AND %11100000)>>5
 3902   IF NOT FNeconet_installed THEN
 3903     cnct%! 12 =0
 3904   ELSE
 3905     SYS "OS_Byte",161,3 TO,,s%
 3906     SYS "OS_Byte",161,4 TO,,t%
 3907     IF s% THEN
 3908       $task_buff%=STR$ t%+"."+STR$ s%
 3909       B%=task_buff%
 3910       C%=2
 3911       cnct%! 12 =USR(code_entry%+ 28 )
 3912     ELSE
 3913       s$=CHR$ t%
 3914       FOR s%=1 TO 5
 3915         SYS "OS_Byte",161,152+s% TO,,t%
 3916         IF t% s$+=CHR$ t% ELSE s%=5
 3917       NEXT
 3918       $task_buff%=s$
 3919       B%=task_buff%
 3920       C%=2
 3921       cnct%! 12 =USR(code_entry%+ 28 )
 3922     ENDIF
 3923   ENDIF
 3924   SYS "XOS_ReadVarVal","PrinterType$5",buff1%,256,,3 TO,,t%
 3925   buff1%?t%=13
 3926   B%=buff1%
 3927   C%=2
 3928   cnct%! 16 =USR(code_entry%+ 28 )
 3929   cnct%! 20 =0
 3930   cnct%! 24 =0
 3931   cnct%! 28 =0
 3932   cnct%! 32 =0
 3933   cnct%? 6 =0
 3934   prnt%! 12 =cnct%
 3935   B%= &47464E43 
 3936   C%=4*psup%! 36 
 3937   s%=USR(code_entry%+ 12 )
 3938   IF s%=0 ERROR  253 ,FNmsg_1(A%! 12 ,"FA5","CNFG")
 3939   IF 0<=psup%! 36 -1 THEN
 3940     FOR t%=0 TO psup%! 36 -1
 3941       s%!(t%*4)=0
 3942     NEXT
 3943   ENDIF
 3944   prnt%! 16 =s%
 3945   prnt%! 20 =-1  
 3946   prnt%! 24 =0  
 3947   prnt%! 28 =-1  
 3948   prnt%! 32 =0  
 3949   prnt%! 36 =0  
 3950   prnt%! 40 =0  
 3951   prnt%! 44 =0  
 3952   IF psup%! 32  AND %100 THEN
 3953     prnt%! 48 =FNallocate_pause_window
 3954   ELSE
 3955     prnt%! 48 =0
 3956   ENDIF
 3957   prnt%! 52 =0
 3958   PROCprinter_reason_code(psup%,prnt%,-4,0)
 3959   IF psup%! 24  AND  4  PROCprinter_reason_code(psup%,prnt%,-12,0)
 3960   PROCcreate_installed_printer_icons  
 3961   IF psup%! 24  AND  8  THEN
 3962     prnt%! 56 =10*psup%?( 24 +1)
 3963   ELSE
 3964     prnt%! 56 =-1
 3965   ENDIF
 3966   PROCactivate_this_printer(prnt%)
 3967 ENDPROC
 3968 DEF PROCfind_prnt(RETURN prnt%, RETURN rmtp%, RETURN icon%)
 3969   SYS "Wimp_WhichIcon",prntctrl%,buff1%,1<<21,1<<21
 3970   icon%=!buff1%
 3971   rmtp% = 0
 3972   prnt%=A%! 48 
 3973   WHILE prnt%
 3974     IF prnt%! 28 =icon% THEN
 3975       ENDPROC
 3976     ELSE 
 3977       prnt%=prnt%! 0 
 3978     ENDIF
 3979   ENDWHILE
 3980   rmtp% = remote_printers%
 3981   WHILE rmtp%
 3982     IF rmtp%! 16  = icon% THEN
 3983       ENDPROC
 3984     ELSE
 3985       rmtp% = rmtp%! 0 
 3986     ENDIF
 3987   ENDWHILE
 3988 ENDPROC
 3989 DEF PROCfind_only_prnt (RETURN prnt%,RETURN icon%)
 3990   SYS "Wimp_WhichIcon",prntctrl%,buff1%,1<<21,1<<21
 3991   icon%=!buff1%
 3992   rmtp% = 0
 3993   prnt%=A%! 48 
 3994   WHILE prnt%
 3995     IF prnt%! 28 =icon% THEN
 3996       ENDPROC
 3997     ELSE 
 3998       prnt%=prnt%! 0 
 3999     ENDIF
 4000   ENDWHILE
 4001 ENDPROC
 4002 DEF PROCfind_only_rmtp (RETURN rmtp%, RETURN icon%)
 4003   SYS "Wimp_WhichIcon",prntctrl%,buff1%,1<<21,1<<21
 4004   icon%=!buff1%
 4005   rmtp% = remote_printers%
 4006   WHILE rmtp%
 4007     IF rmtp%! 16  = icon% THEN
 4008       ENDPROC
 4009     ELSE
 4010       rmtp% = rmtp%! 0 
 4011     ENDIF
 4012   ENDWHILE
 4013 ENDPROC
 4014 DEF PROCopen_connections_window(prnt%)
 4015   LOCAL cnct%,i%,databits%,parity%,stopbits%
 4016   IF prnt%! 24  AND  8      ERROR  254 ,FNmsg_0(A%! 12 ,"OKAJ")
 4017   prnt_edit%=prnt%
 4018   psup_edit%=prnt%! 4 
 4019   cnct%=prnt%! 12 
 4020   IF prnt%! 24  AND  (1<<17)  THEN
 4021     ENDPROC  
 4022   ENDIF
 4023   IF psup_edit%! 24  AND  4  THEN
 4024     PROCprinter_reason_code(psup_edit%,prnt_edit%,-11,0)
 4025     PROCtell_pinboard(FNprinter_find_window(prnt_edit%,"connections"))
 4026     PROCwin_open(FNprinter_find_window(prnt_edit%,"connections"))
 4027   ELSE
 4028     IF prnt%! 40        PROCicon_write(connections%, 31 ,$prnt%! 40 )     ELSE       PROCicon_write(connections%, 31 ,$prnt%! 8 )
 4029     IF cnct%? 6  AND  1        PROCicon_select(connections%, 37 )     ELSE       PROCicon_deselect(connections%, 37 )
 4030     PROCicon_deselect(connections%, 0 )
 4031     PROCicon_deselect(connections%, 1 )
 4032     PROCicon_deselect(connections%, 2 )
 4033     PROCicon_deselect(connections%, 3 )
 4034     PROCicon_deselect(connections%, 4 )
 4035     PROCicon_deselect(connections%, 33 )
 4036     i%=-1
 4037     CASE cnct%! 0  OF
 4038       WHEN 1
 4039         i%= 0 
 4040       WHEN 2
 4041         i%= 1 
 4042       WHEN 4
 4043         IF FNeconet_installed i%= 2 
 4044       WHEN 5
 4045         i%= 4 
 4046       WHEN 6
 4047         IF FNnfs_installed i%= 3 
 4048       WHEN 8
 4049         IF psup_edit%! 24  AND  16  i%= 33 
 4050     ENDCASE
 4051     IF NOT i% PROCicon_select(connections%,i%)
 4052     PROCicon_write(connections%, 15 ,        FNmsg_0(A%! 12 ,        "BR"+STR$ cnct%? 4 ))
 4053     i%=cnct%! 8 
 4054     databits%=i% AND %11
 4055     stopbits%=(i% AND %100)>>2
 4056     parity%=(i% AND %110000)>>4
 4057     IF(i% AND %1000)=0 parity%=0 ELSE parity%+=1
 4058     PROCicon_write(connections%, 17 ,        FNmsg_0(A%! 12 ,"DA"+STR$ databits%))
 4059     PROCicon_write(connections%, 18 ,        FNmsg_0(A%! 12 ,"PA"+STR$ parity%))
 4060     IF stopbits%=0 THEN
 4061       PROCicon_write(connections%, 19 ,          FNmsg_0(A%! 12 ,"SB0"))
 4062     ELSE
 4063       IF databits%=0 AND parity%<>0 THEN
 4064         PROCicon_write(connections%, 19 ,            FNmsg_0(A%! 12 ,"SB1b"))
 4065       ELSE
 4066         IF databits%=3 AND parity%=0 THEN
 4067           PROCicon_write(connections%, 19 ,              FNmsg_0(A%! 12 ,"SB1c"))
 4068         ELSE
 4069           PROCicon_write(connections%, 19 ,              FNmsg_0(A%! 12 ,"SB1a"))
 4070         ENDIF
 4071       ENDIF
 4072     ENDIF
 4073     IF cnct%? 5        PROCicon_select(connections%, 13 )     ELSE       PROCicon_deselect(connections%, 13 )
 4074     IF cnct%? 6  AND  2        PROCicon_select(connections%, 35 )     ELSE       PROCicon_deselect(connections%, 35 )
 4075     PROCset_string(connections%, 25 ,cnct%, 12 )
 4076     PROCset_string(connections%, 26 ,cnct%, 20 )
 4077     PROCset_string(connections%, 27 ,cnct%, 24 )
 4078     PROCset_string(connections%, 28 ,cnct%, 28 )
 4079     PROCset_string(connections%, 29 ,cnct%, 32 )
 4080     IF cnct%! 16  <> 0 THEN
 4081       IF ?(cnct%! 16 ) > 32 AND ?(cnct%! 16 ) < 127         PROCset_string(connections%, 30 ,cnct%, 16 )       ELSE         PROCicon_write(connections%, 30 ,"null:")
 4082     ELSE
 4083         PROCicon_write(connections%, 30 ,"null:")
 4084     ENDIF
 4085     IF FNeconet_installed        PROCicon_unshade(connections%, 2 )     ELSE        PROCicon_shade(connections%, 2 )
 4086     IF FNnfs_installed       PROCicon_unshade(connections%, 3 )     ELSE       PROCicon_shade(connections%, 3 )
 4087     !win_buff%=connections%
 4088     SYS "Wimp_GetWindowInfo",,win_buff% OR 1  
 4089     win_buff%!28=-1
 4090     IF psup_edit%! 24  AND  16        PROCicon_unshade(connections%, 33 )     ELSE       PROCicon_shade(connections%, 33 )
 4091     PROCtell_pinboard(connections%)
 4092     SYS "Wimp_OpenWindow",,win_buff%
 4093     PROCcheck_shaded_connections
 4094   ENDIF
 4095 ENDPROC
 4096 DEF PROCset_string(wind%,icon%,block%,offset%)
 4097   PROCicon_write(wind%,icon%,FNprinter_read_string(block%!offset%))
 4098 ENDPROC
 4099 DEF PROCreset_string(block%,offset%,icon%)
 4100   IF block%!offset% THEN
 4101    B%= &47525453 
 4102    C%=block%!offset%
 4103    CALL code_entry%+ 16 
 4104    block%!offset%=0
 4105   ENDIF
 4106   !icon_buffer%=connections%
 4107   icon_buffer%!4=icon%
 4108   SYS "Wimp_GetIconState",,icon_buffer%
 4109   B%=icon_buffer%!28
 4110   C%=2
 4111   block%!offset%=USR(code_entry%+ 28 )
 4112 ENDPROC
 4113 DEF FNnew_databits
 4114 =FNmatch_option(connections%, 17 ,3,"DA",A%! 12 )
 4115 DEF FNnew_parity
 4116 =FNmatch_option(connections%, 18 ,4,"PA",A%! 12 )
 4117 DEF FNnew_stopbits
 4118 IF FNicon_read(connections%, 19 )=FNmsg_0(A%! 12 ,"SB0")THEN =0 ELSE =1
 4119 DEF PROCensure_new_stopbits(new%)
 4120   IF new%=-1 new%=FNnew_stopbits
 4121   IF new%=0 THEN
 4122     PROCicon_write(connections%, 19 ,FNmsg_0(A%! 12 ,"SB0"))
 4123   ELSE
 4124     IF FNnew_databits=0 AND FNnew_parity<>0 THEN
 4125       PROCicon_write(connections%, 19 ,FNmsg_0(A%! 12 ,"SB1b"))
 4126     ELSE
 4127       IF FNnew_databits=3 AND FNnew_parity=0 THEN
 4128         PROCicon_write(connections%, 19 ,FNmsg_0(A%! 12 ,"SB1c"))
 4129       ELSE
 4130         PROCicon_write(connections%, 19 ,FNmsg_0(A%! 12 ,"SB1a"))
 4131       ENDIF
 4132     ENDIF
 4133   ENDIF
 4134 ENDPROC
 4135 DEF FNmatch_option(wind%,icon%,limit%,prefix$,desc%)
 4136   LOCAL i%,s$
 4137   s$=FNicon_read(wind%,icon%)
 4138   IF 0<=limit% THEN
 4139     FOR i%=0 TO limit%
 4140       IF s$=FNmsg_0(desc%,prefix$+STR$ i%)THEN =i%
 4141     NEXT
 4142   ENDIF
 4143 =0
 4144 DEF PROCsave_connection
 4145   LOCAL cnct%,i%,claim$,s$
 4146   cnct%=prnt_edit%! 12 
 4147   cnct%! 0 =0
 4148   IF FNicon_set(connections%, 37 ) THEN
 4149     cnct%? 6 =cnct%? 6  OR  1 
 4150   ELSE
 4151     cnct%? 6 =cnct%? 6  AND NOT  1 
 4152   ENDIF
 4153   IF FNicon_set(connections%, 0 )THEN
 4154     claim$=FNdevice_claim(1,prnt_edit%)
 4155     IF claim$=""       cnct%! 0 =1     ELSE       ERROR  254 ,FNmsg_1(A%! 12 ,"OKI",claim$)
 4156   ENDIF
 4157   IF FNicon_set(connections%, 1 )THEN
 4158     claim$=FNdevice_claim(2,prnt_edit%)
 4159     IF claim$=""       cnct%! 0 =2     ELSE       ERROR  254 ,FNmsg_1(A%! 12 ,"OKJ",claim$)
 4160   ENDIF
 4161   IF FNicon_set(connections%, 2 )cnct%! 0 =4
 4162   IF FNicon_set(connections%, 3 )cnct%! 0 =6
 4163   IF FNicon_set(connections%, 4 )cnct%! 0 =5
 4164   IF FNicon_set(connections%, 33 )cnct%! 0 =8
 4165   s$=FNicon_read(connections%, 15 )
 4166   FOR i%=0 TO 18
 4167     IF FNmsg_0(A%! 12 ,"BR"+STR$ i%)=s$ THEN
 4168       cnct%? 4 =i%
 4169       i%=18
 4170     ENDIF
 4171   NEXT
 4172   i%=FNnew_databits OR FNnew_stopbits<<2
 4173   IF FNnew_parity i%=i% OR FNnew_parity-1<<4 OR %1000
 4174   cnct%! 8 =i%
 4175   IF FNicon_set(connections%, 13 ) THEN
 4176    cnct%? 5 =1
 4177   ELSE
 4178    cnct%? 5 =0
 4179   ENDIF
 4180   IF FNicon_set(connections%, 35 ) THEN
 4181    cnct%? 6 =cnct%? 6  OR  2 
 4182   ELSE
 4183    cnct%? 6 =cnct%? 6  AND NOT  2 
 4184   ENDIF
 4185   PROCreset_string(cnct%,12,25)
 4186   PROCreset_string(cnct%,20,26)
 4187   PROCreset_string(cnct%,24,27)
 4188   PROCreset_string(cnct%,28,28)
 4189   PROCreset_string(cnct%,32,29)
 4190   PROCreset_string(cnct%,16,30)
 4191   PROCredraw_prntctrl_entry(prnt_edit%)
 4192   PROCredraw_queue_entry(-1,prnt_edit%,0)
 4193   IF NOT prnt_edit%! 20  THEN
 4194     IF prnt_edit%! 24  AND  2  THEN
 4195       PROCselect_printer(prnt_edit%, -1 , 0 )
 4196     ENDIF
 4197     PROCprinter_status(prnt_edit%)
 4198   ENDIF
 4199 ENDPROC
 4200 DEF PROCprinter_status(prnt%)
 4201   LOCAL new_text$,i%,sprite$,st$,icon_set%,psup%
 4202   IF prnt%! 20 =-1 ENDPROC  
 4203   psup%=prnt%! 4 
 4204   new_text$=FNiconbar_string(prnt%)
 4205   IF prnt%! 44  sprite$=$prnt%! 44  ELSE sprite$=$psup%! 4 
 4206   st$="ss_"+sprite$+","+sprite$
 4207   !buff1%=-1
 4208   buff1%!4=prnt%! 20 
 4209   SYS "Wimp_GetIconState",,buff1%
 4210   icon_set%=buff1%!24 AND 1<<21
 4211   IF new_text$<>$buff1%!28 OR st$<>$buff1%!32 THEN
 4212     i%=FNiconbar_tands(new_text$,sprite$,-4,prnt%! 20 )
 4213     PROCicon_delete(-1,prnt%! 20 )
 4214     prnt%! 20 =i%
 4215     IF icon_set% PROCicon_select(-1,i%)
 4216   ENDIF
 4217 ENDPROC
 4218 DEF FNiconbar_string(prnt%)
 4219   LOCAL cnct%,queu%
 4220   IF prnt%! 24  AND  4  THEN =FNmsg_0(A%! 12 ,"QU1")
 4221   IF prnt%! 24  AND  8  THEN
 4222     queu%=prnt%! 32 
 4223     IF queu%? 11  AND 1 THEN =FNmsg_0(A%! 12 ,"QU1")ELSE =FNmsg_0(A%! 12 ,"QU2")
 4224   ENDIF
 4225   IF prnt%! 24  AND  32  THEN =FNmsg_0(A%! 12 ,"QU3")
 4226   IF prnt%! 40  THEN =$prnt%! 40 
 4227   cnct%=prnt%! 12 
 4228   CASE cnct%! 0  OF
 4229     WHEN 0,1,2,5
 4230       =FNmsg_0(A%! 12 ,"IC"+STR$cnct%! 0 )
 4231     WHEN 4
 4232       =$cnct%! 12 
 4233     WHEN 6
 4234       =$cnct%! 24 
 4235   ENDCASE
 4236 =""
 4237 DEF PROCbuild_printer_menu
 4238   LOCAL offset%,status%,list%,i%,s$,indirected_title%
 4239   B%= &5453494C 
 4240   C%=2048
 4241   list%=USR(code_entry%+ 12 )
 4242   IF list%=0 ERROR  253 ,FNmsg_1(A%! 12 ,"FA5","LIST")
 4243   SYS "XNetPrint_ListServers",1,list%,2048,500 TO offset%;i%
 4244   IF i% AND 1     i%=offset%+4:     CALL Z%,i%,s$:       ERROR  254 ,s$
 4245   PROCmenu_create(menu%,FNmsg_0(A%! 12 ,"ME6"))
 4246   indirected_title%=(menu%!28 AND &100)<>0
 4247   status%=list%
 4248   i%=0
 4249   WHILE i%<offset%
 4250     CALL Z%,status%,s$
 4251     status%+=LEN s$+1
 4252     PROCmenu_item(menu%,i%,s$,indirected_title%)
 4253     i%+=1
 4254   ENDWHILE
 4255   B%= &5453494C 
 4256   C%=list%
 4257   CALL code_entry%+ 16 
 4258 ENDPROC
 4259 DEF PROCactivate_printer
 4260   LOCAL prnt%,cnct%,icon%, err%
 4261   LOCAL rmtp%, junk%, tmplist%, thing%, othing%
 4262   REPEAT
 4263     PROCfind_only_prnt(prnt%, icon%)
 4264     IF prnt% THEN
 4265       PROCicon_deselect(prntctrl%,icon%)
 4266       IF(prnt%! 24  AND  1 )=0 PROCactivate_this_printer(prnt%)
 4267       IF (prnt%! 24  AND  (1<<16) ) THEN
 4268         PROCunshare_one_printer (prnt%)
 4269       ENDIF
 4270     ENDIF
 4271   UNTIL prnt% = 0
 4272   tmplist% = 0
 4273   SYS "Hourglass_On"
 4274   REPEAT
 4275     PROCfind_only_rmtp (rmtp%, icon%)
 4276     IF rmtp% THEN
 4277      IF rmtp%! 20  <= 0 THEN
 4278       PROCicon_deselect(prntctrl%,icon%)
 4279       thing% = FNconstruct_rmtp (rmtp%! 4 , rmtp%! 8 , rmtp%! 12 )
 4280       PROCadd_to_list (tmplist%, thing%)
 4281      ENDIF
 4282     ENDIF
 4283   UNTIL rmtp% = 0
 4284   thing% = tmplist%
 4285   WHILE thing%
 4286     junk% = FNensure_printer(thing%, 0,  0 ,  0 , err%)
 4287     PROCremove_from_list (remote_printers%, $thing%! 4 )
 4288     othing% = thing%
 4289     thing% = thing%! 0 
 4290     PROCfree ( &524D5450 , othing%)
 4291   ENDWHILE
 4292   SYS "Hourglass_Off"
 4293 ENDPROC
 4294 DEF PROCactivate_this_printer(prnt%)
 4295   prnt%! 24 =prnt%! 24  OR  1 
 4296   cnct%=prnt%! 12 
 4297   PROCcreate_printer_icon(prnt%)
 4298   PROCflush_queue(prnt%)
 4299   IF A%! 44 =1 THEN
 4300     PROCselect_printer(prnt%, -1 , 0 )
 4301   ENDIF
 4302 ENDPROC
 4303 DEF PROCcreate_printer_icon(prnt%)
 4304   LOCAL s$,i%,side%,psup%
 4305   psup%=prnt%! 4 
 4306   IF prnt%! 44  THEN
 4307    s$=$prnt%! 44 
 4308   ELSE
 4309    s$=$psup%! 4 
 4310   ENDIF
 4311   i%=FNright_of(prnt%)
 4312   side%=-4
 4313   IF i%=-1 THEN
 4314     i%=FNleft_of(prnt%)
 4315     side%=-3
 4316   ENDIF
 4317   IF i%=-1 THEN
 4318     i%=&0F000000
 4319     side%=-5
 4320   ENDIF
 4321   prnt%! 20 =FNiconbar_tands(FNiconbar_string(prnt%),s$,side%,i%)
 4322   IF got_icon% THEN
 4323     PROCicon_delete(-1,main_icon%)
 4324     got_icon%= 0 
 4325   ENDIF
 4326   A%! 44 +=1
 4327 ENDPROC
 4328 DEF FNright_of(prnt%)
 4329   LOCAL icon%,l_prnt%
 4330   IF got_icon% THEN
 4331     icon%=main_icon%
 4332   ELSE
 4333     icon%=-1
 4334     l_prnt%=A%! 48 
 4335     WHILE l_prnt%
 4336       IF NOT l_prnt%! 20  icon%=l_prnt%! 20 
 4337       IF l_prnt%=prnt% l_prnt%=0 ELSE l_prnt%=l_prnt%! 0 
 4338     ENDWHILE
 4339   ENDIF
 4340 =icon%
 4341 DEF FNleft_of(prnt%)
 4342   WHILE prnt%! 20 =-1
 4343     prnt%=prnt%! 0 
 4344     IF prnt%=0 THEN =-1
 4345   ENDWHILE
 4346 =prnt%! 20 
 4347 DEF PROCcreate_main_icon
 4348     main_icon%=FNiconbar_tands(FNmsg_0(A%! 12 ,"NNE"),        "s"+FNmsg_0(A%! 12 ,"IC"),-5,&0F000000)
 4349   got_icon%= -1 
 4350   !task_buff%=A%! 40 
 4351   PROCclose_window
 4352 ENDPROC
 4353 DEF PROCdeactivate_printer
 4354   LOCAL prnt%,icon%,doit%, name$, othing%
 4355   LOCAL rmtp%, doit%, tmplist%, thing%, prnt%
 4356   tmplist% = 0
 4357   REPEAT
 4358     PROCfind_prnt(prnt%, rmtp%, icon%)
 4359     PROCicon_deselect(prntctrl%,icon%)
 4360     IF prnt% THEN
 4361       IF prnt%! 24  AND  (1<<17)  THEN
 4362         thing% = FNconstruct_rmtp (0, 0, prnt%)
 4363         PROCadd_to_list (tmplist%, thing%)
 4364       ELSE
 4365         PROCdeactivate_this_printer(prnt%)
 4366       ENDIF
 4367     ENDIF
 4368     IF rmtp% AND rmtp%! 20  > 0 THEN
 4369       PROCremove_unavailable_printer ($rmtp%! 4 )
 4370       IF FNunavailable_count = 0 AND A%! 44  = 0 THEN
 4371         PROCcreate_main_icon
 4372       ENDIF
 4373     ENDIF
 4374   UNTIL prnt% = 0 AND rmtp% = 0
 4375   thing% = tmplist%
 4376   WHILE thing%    
 4377     prnt% = thing%! 12 
 4378     name$ = $prnt%! 40 
 4379     PROCremove_one_printer (prnt%)
 4380     PROCadd_remote_printer (name$)
 4381     othing% = thing%
 4382     thing% = thing%! 0 
 4383     PROCfree ( &524D5450 , othing%)
 4384   ENDWHILE
 4385   PROCcreate_installed_printer_icons
 4386   IF selected_prnt%=0 THEN
 4387     IF A%! 44  THEN
 4388       doit%=A%! 48 
 4389       WHILE doit%
 4390         IF NOT doit%! 20  THEN
 4391           PROCselect_printer(doit%, -1 , 0 )
 4392           doit%=0
 4393         ELSE
 4394           doit%=doit%! 0 
 4395         ENDIF
 4396       ENDWHILE
 4397     ENDIF
 4398   ENDIF
 4399 ENDPROC
 4400 DEF PROCdeactivate_this_printer(prnt%)
 4401   LOCAL was_remote%
 4402   IF prnt%! 24  AND  (1<<16)  THEN
 4403     PROCunshare_one_printer (prnt%)
 4404   ENDIF
 4405   IF prnt%! 24  AND  (1<<17)  THEN
 4406     was_remote% =  -1 
 4407   ENDIF
 4408   IF prnt%! 24  AND  1  THEN
 4409         IF prnt%! 24  AND  (1<<17)  THEN
 4410           doit% =  -1   
 4411         ELSE
 4412           IF prnt%! 32  THEN
 4413             doit%=FNquery("WA2",$prnt%! 8 )
 4414           ELSE
 4415             doit%= -1 
 4416           ENDIF
 4417         ENDIF
 4418     IF doit% THEN
 4419       PROCprinter_reason_code(prnt%! 4 ,prnt%,-10,0)
 4420       IF NOT prnt%! 20  THEN
 4421         IF A%! 44 =1 AND FNunavailable_count=0 THEN
 4422           PROCcreate_main_icon  
 4423         ENDIF
 4424         IF A%! 44 =1 AND FNunavailable_count>0 THEN
 4425           !task_buff%=A%! 40 
 4426           PROCclose_window
 4427         ENDIF
 4428         PROCicon_delete(-1,prnt%! 20 )
 4429         prnt%! 20 =-1
 4430         A%! 44 -=1
 4431       ENDIF
 4432       prnt%! 24 =prnt%! 24  AND NOT  63+65536 
 4433       IF selected_prnt%=prnt% SYS"PDriver_SelectDriver",-1:selected_prnt%=0
 4434       PROCflush_queue(prnt%)
 4435     ENDIF
 4436   ENDIF
 4437 ENDPROC
 4438 DEF PROCremove_printer
 4439   LOCAL i%,prnt%,ptr%,last_prnt%,private_buff%,doit%,type$
 4440   B%= &58585858 
 4441   C%=256
 4442   private_buff%=USR(code_entry%+ 12 )
 4443   IF private_buff%=0     ERROR  253 ,FNmsg_1(A%! 12 ,"FA5","XXXX")
 4444   SYS "Wimp_WhichIcon",prntctrl%,private_buff%,1<<21,1<<21
 4445   ptr%=private_buff%
 4446   SYS "Hourglass_On"
 4447   WHILE NOT !ptr%
 4448     i%=!ptr%
 4449     prnt%=A%! 48 
 4450     last_prnt%=0
 4451     WHILE prnt%
 4452      IF ((prnt%! 24  AND  (1<<17) ) = 0) AND prnt%! 28 =i% THEN
 4453        IF prnt%! 32  THEN
 4454           SYS "Hourglass_Off"
 4455           doit%=FNquery("WA3",$prnt%! 8 )
 4456           SYS "Hourglass_On"
 4457           IFdoit% PROCflush_queue(prnt%)
 4458        ELSE
 4459          doit%= -1 
 4460        ENDIF
 4461        IF doit% THEN
 4462         type$=$prnt%! 8 
 4463          PROCremove_this_printer(prnt%,last_prnt%)
 4464          PROCdelete_prdata_entry(type$)
 4465        ENDIF
 4466        prnt%=0
 4467      ELSE
 4468        last_prnt%=prnt%
 4469        prnt%=prnt%! 0 
 4470      ENDIF
 4471     ENDWHILE
 4472     ptr%+=4
 4473   ENDWHILE
 4474   IF selected_prnt%=0 THEN
 4475     IF A%! 44  THEN
 4476       doit%=A%! 48 
 4477       WHILE doit%
 4478         IF NOT doit%! 20  THEN
 4479           PROCselect_printer(doit%, -1 , 0 )
 4480           doit%=0
 4481         ELSE
 4482           doit%=doit%! 0 
 4483         ENDIF
 4484       ENDWHILE
 4485     ENDIF
 4486   ENDIF
 4487   IF selected_prnt%=0 PROCtell_the_world
 4488   B%= &58585858 
 4489   C%=private_buff%
 4490   CALL code_entry%+ 16 
 4491   PROCcreate_installed_printer_icons
 4492   PROCwin_open(prntctrl%)
 4493   SYS "Hourglass_Off"
 4494 ENDPROC
 4495 DEF PROCremove_this_printer(prnt%,last_prnt%)
 4496   LOCAL j%,i%,size%,psup%,prdt%
 4497   psup%=prnt%! 4 
 4498   prdt%=psup%! 12 
 4499   prdt%=prdt%! 4 
 4500   PROCprinter_reason_code(psup%,prnt%,-9,0)
 4501   PROCdeactivate_this_printer(prnt%)
 4502   WHILE prdt%
 4503     IF$prdt%! 8 =$prnt%! 8  THEN
 4504       prdt%!(prdt%! 4 *4+ 8 )-=1
 4505       prdt%=0
 4506     ELSE
 4507       prdt%=prdt%! 0 
 4508     ENDIF
 4509   ENDWHILE
 4510   IF prnt_edit%=prnt% THEN
 4511     !task_buff%=connections%
 4512     PROCclose_window
 4513   ENDIF
 4514   i%=psup%! 20 
 4515   WHILE i%
 4516    IF i%! 12 =prnt% THEN
 4517      !task_buff%=i%! 4 
 4518      PROCclose_window
 4519    ENDIF
 4520    i%=i%! 0 
 4521   ENDWHILE
 4522   IF prnt%! 48      PROCdeallocate_pause_window(prnt%! 48 )
 4523   IF selected_prnt%=prnt% selected_prnt%=0
 4524   PROCfree_structure(prnt%! 8 )  
 4525   j%=prnt%! 12 
 4526   IF (psup%! 24  AND  4 ) THEN
 4527     size% = psup%! 48 
 4528     IF 1 <= size% THEN
 4529       FOR i%=1 TO size%
 4530         PROCfree_structure(!j%)
 4531         j%+=4
 4532       NEXT
 4533     ENDIF
 4534   ELSE
 4535     PROCfree_structure(j%! 12 )  
 4536     PROCfree_structure(j%! 16 )  
 4537     PROCfree_structure(j%! 20 )  
 4538     PROCfree_structure(j%! 24 )  
 4539     PROCfree_structure(j%! 28 )  
 4540     PROCfree_structure(j%! 32 )  
 4541   ENDIF
 4542   B%= &54434E43 
 4543   C%=j%
 4544   CALL code_entry%+ 16 
 4545   j%=prnt%! 16 
 4546   IF j% THEN
 4547     size%=psup%! 36 
 4548     IF 0<=size%-1 THEN
 4549       FOR i%=0 TO size%-1
 4550         PROCfree_structure(j%!(i%*4))
 4551       NEXT
 4552     ENDIF
 4553   ENDIF
 4554   B%= &47464E43 
 4555   C%=j%
 4556   CALL code_entry%+ 16 
 4557   !task_buff%=prntctrl%
 4558   task_buff%!4=prnt%! 28 
 4559   SYS "Wimp_GetIconState",,task_buff%
 4560   task_buff%!8=1<<7 OR 1<<23
 4561   task_buff%!12=1<<7 OR 1<<23 OR 1<<21
 4562   SYS "Wimp_SetIconState",,task_buff%
 4563   j%=prnt%! 52 
 4564   WHILE j%
 4565     PROCfree_structure(j%! 4 )
 4566     PROCfree_structure(j%! 8 )
 4567     i%=j%! 0 
 4568     B%= &544E4F46 
 4569     C%=j%
 4570     CALL code_entry%+ 16 
 4571     j%=i%
 4572   ENDWHILE
 4573   j%=prnt%! 0 
 4574   B%= &544E5250 
 4575   C%=prnt%
 4576   CALL code_entry%+ 16 
 4577   IF last_prnt% THEN
 4578     last_prnt%! 0 =j%
 4579   ELSE
 4580     A%! 48 =j%
 4581   ENDIF
 4582 ENDPROC
 4583 DEF FNquery(tag$,p1$)
 4584   LOCAL x%,y%,w%,h%
 4585   PROCicon_write(query%, 0 ,FNmsg_1(A%! 12 ,tag$,p1$))
 4586   PROCicon_write(query%, 3 ,FNmsg_0(A%! 12 ,tag$+"a"))
 4587   SYS "Wimp_GetPointerInfo",,task_buff%
 4588   x%=!task_buff%
 4589   y%=task_buff%!4
 4590   !task_buff%=query%
 4591   SYS "Wimp_GetWindowState",,task_buff%
 4592   w%=task_buff%!12-task_buff%!4
 4593   h%=task_buff%!16-task_buff%!8
 4594   task_buff%!4=x%-340  
 4595   task_buff%!8=y%-120  
 4596   task_buff%!12=task_buff%!4+w%
 4597   task_buff%!16=task_buff%!8+h%
 4598   task_buff%!28=-1
 4599   SYS "Wimp_OpenWindow",,task_buff%
 4600   PROCbound_mouse(query%)
 4601   query_state%=0
 4602   REPEAT
 4603     PROCdespatch_poll(click_mask%)
 4604   UNTIL query_state%
 4605   !task_buff%=query%
 4606   PROCclose_window
 4607   PROCunbound_mouse
 4608 =(query_state%= 3 )
 4609 DEF PROCbound_mouse(h%)
 4610   !task_buff%=h%
 4611   SYS "Wimp_GetWindowOutline",,task_buff%
 4612   ?task_buff%=1
 4613   task_buff%!1=task_buff%!4
 4614   task_buff%!3=task_buff%!8
 4615   task_buff%!5=task_buff%!12
 4616   task_buff%!7=task_buff%!16
 4617   SYS "OS_Word",21,task_buff%
 4618 ENDPROC
 4619 DEF PROCunbound_mouse
 4620   LOCAL mc_sw%,mc_dx%,mc_sh%,mc_dy%,scrx%,scry%
 4621   SYS "OS_ReadModeVariable",-1,4 TO,,mc_dx%
 4622   mc_dx%=1<<mc_dx%
 4623   SYS "OS_ReadModeVariable",-1,5 TO,,mc_dy%
 4624   mc_dy%=1<<mc_dy%
 4625   SYS "OS_ReadModeVariable",-1,11 TO,,mc_sw%
 4626   mc_sw%+=1
 4627   SYS "OS_ReadModeVariable",-1,12 TO,,mc_sh%
 4628   mc_sh%+=1
 4629   scrx%=mc_sw%*mc_dx%
 4630   scry%=mc_sh%*mc_dy%
 4631   ?task_buff%=1
 4632   task_buff%!1=0
 4633   task_buff%!3=0
 4634   task_buff%!5=scrx%
 4635   task_buff%!7=scry%
 4636   SYS "OS_Word",21,task_buff%
 4637 ENDPROC
 4638 DEF PROCcreate_installed_printer_icons
 4639   LOCAL prnt%,ptr%,i%
 4640   LOCAL rmtp%
 4641   !buff1%=prntctrl%
 4642   IF printer_count% THEN
 4643     FOR i%=0 TO printer_count%-1
 4644       buff1%!4=i%+4
 4645       SYS "Wimp_DeleteIcon",,buff1%
 4646     NEXT
 4647   ENDIF
 4648   IF remote_printer_count% THEN
 4649     FOR i% = printer_count% TO printer_count%+remote_printer_count%
 4650       buff1%!4=i%+4
 4651       SYS "Wimp_DeleteIcon",,buff1%
 4652     NEXT
 4653   ENDIF
 4654   printer_count%=0
 4655   remote_printer_count% = 0
 4656   !buff1%=prntctrl%
 4657   buff1%!4=0
 4658   buff1%!8=prntctrl_icdf%(4)!4  
 4659   buff1%!12=1030
 4660   buff1%!16=prntctrl_icdf%(4)!12
 4661   buff1%!20=prntctrl_icdf%(4)!16
 4662   buff1%!24=prntctrl_icdf%(4)!20
 4663   buff1%!28=prntctrl_icdf%(4)!24
 4664   buff1%!32=prntctrl_icdf%(4)!28
 4665   prnt%=A%! 48 
 4666   WHILE prnt%
 4667     SYS "Wimp_CreateIcon",,buff1% TO i%
 4668     printer_count%+=1
 4669     buff1%!16=buff1%!8
 4670     buff1%!8-=(prntctrl_icdf%(4)!12 - prntctrl_icdf%(4)!4)
 4671     prnt%! 28 =i%
 4672     prnt%=prnt%! 0 
 4673   ENDWHILE
 4674   rmtp% = remote_printers%
 4675   WHILE rmtp%
 4676     SYS "Wimp_CreateIcon",,buff1% TO i%
 4677     remote_printer_count% += 1
 4678     buff1%!16=buff1%!8
 4679     buff1%!8-=(prntctrl_icdf%(4)!12 - prntctrl_icdf%(4)!4)
 4680     rmtp%! 16 =i%
 4681     rmtp% = rmtp%! 0 
 4682   ENDWHILE
 4683   SYS "Wimp_GetWindowInfo",,buff1% OR 1
 4684   buff1%!0=0
 4685   buff1%!4=-(printer_count%+remote_printer_count%+1)*(prntctrl_icdf%(4)!12 - prntctrl_icdf%(4)!4)
 4686   buff1%!8=buff1%!52-buff1%!44
 4687   buff1%!12=0
 4688   SYS "Wimp_SetExtent",prntctrl%,buff1%
 4689   buff1%!4=-(printer_count%+remote_printer_count%+2)*(prntctrl_icdf%(4)!12 - prntctrl_icdf%(4)!4)
 4690   SYS "Wimp_ForceRedraw",prntctrl%,buff1%!0,buff1%!4,buff1%!8,buff1%!12
 4691   IF FNwindow_open (prntctrl%) THEN
 4692     PROCwin_open(prntctrl%)
 4693   ENDIF
 4694 ENDPROC
 4695 DEF FNnfs_installed
 4696   LOCAL i%
 4697   SYS "XOS_SWINumberFromString",,"NFS_Mount" TO;i%
 4698 =((i% AND 1)=0)
 4699 DEF FNeconet_installed
 4700   LOCAL i%
 4701   SYS "XOS_SWINumberFromString",,"NetPrint_ReadPSName" TO;i%
 4702 =((i% AND 1)=0)
 4703 DEF FNevaluate(s$)
 4704   LOCAL t%,n%,f%
 4705   SYS "XOS_EvaluateExpression",s$,evaluation_buff%,256 TO,t%,n%;f%
 4706   IF t% OR(f% AND 1)ERROR  253 ,FNmsg_1(A%! 12 ,"FAD",s$)
 4707 =n%
 4708 DEF FNcanonicalise(s$)
 4709   LOCAL unused%,f%
 4710   SYS "XOS_FSControl",37,s$,evaluation_buff%,0,0,256 TO ,,,,,unused%;f%
 4711   IF (unused%<=0) OR (f% AND 1) : =s$
 4712   evaluation_buff%?(256-unused%)=13
 4713 =$evaluation_buff%
 4714 DEF PROCbroadcast_reason_code(prnt%,reason%,task_buffer%)
 4715 LOCAL p%
 4716 p%=psup_head%
 4717 WHILE p%
 4718   PROCprinter_reason_code(p%,prnt%,reason%,task_buffer%)
 4719   p%=p%! 0 
 4720 ENDWHILE
 4721 ENDPROC
 4722 DEF PROCprinter_reason_code(psup%,prnt%,reason%,extra_buffer%)
 4723   LOCAL i%
 4724   LOCAL ERROR
 4725   ON ERROR LOCAL: RESTORE ERROR: PROCprinter_reason_error(psup%,prnt%,reason%): ENDPROC
 4726   buff1%!0=reason%
 4727   buff1%!4=psup%
 4728   buff1%!8=prnt%
 4729   buff1%!12=extra_buffer%
 4730   buff1%!16=psize_head%
 4731   buff1%!20=code_entry%
 4732   buff1%!24=A%:  
 4733   IF psup%! 24  AND  1  THEN
 4734     i%=EVAL("FN"+$psup%! 4 +"_support("+STR$ buff1%+")")
 4735   ELSE
 4736     IF 0<=utility_count%-1 THEN
 4737       FOR i%=0 TO utility_count%-1
 4738         IF $psup%! 4 =utility$(i%)THEN
 4739           B%=buff1%
 4740           CALL utility%(i%)
 4741         ENDIF
 4742       NEXT
 4743     ENDIF
 4744   ENDIF
 4745 ENDPROC
 4746 DEF PROCprinter_reason_error(psup%,prnt%,reason%)
 4747   IF (prnt%! 24  AND  8 ) ERROR  254 ,REPORT$
 4748     IF ERR= 253  ERROR  253 ,REPORT$
 4749   PROCerror_warning(FNmsg_4(A%! 12 ,"WA6",$psup%! 4 ,STR$ reason%,REPORT$,STR$ ERL))
 4750 ENDPROC
 4751 DEF PROCpause_printer(prnt%)
 4752   prnt%! 24 =prnt%! 24  OR  4 
 4753   PROCprinter_status(prnt%)
 4754   PROCredraw_queue_entry(-1,prnt%,0)
 4755 ENDPROC
 4756 DEF PROCprinter_open_window(prnt%,name$)
 4757   LOCAL handle%, num_icons%, i%
 4758   IF name$="configure" THEN
 4759    IF prnt%! 24  AND  8  ERROR  254 ,FNmsg_0(A%! 12 ,"OKAI")
 4760   ENDIF
 4761   handle%=FNprinter_find_window(prnt%,name$)
 4762   PROCtell_pinboard(handle%)
 4763   PROCwin_open(handle%)
 4764   !buff1%=handle%
 4765   SYS"Wimp_GetWindowInfo",,buff1% OR 1
 4766   num_icons%=buff1%!88
 4767   FOR i%=0 TO num_icons%
 4768     !buff1%=handle%:buff1%!4=i%:SYS"Wimp_GetIconState",,buff1%
 4769     IF (buff1%!24 AND (1<<23))=0 THEN
 4770       IF (buff1%!24 AND (%1111<<12)) = (15<<12) THEN
 4771         IF (prnt%! 24  AND  (1<<16) ) OR (prnt%! 24  AND  (1<<17) ) THEN
 4772          PROCicon_shade (handle%, i%) : REM Is name always first icon?
 4773          PROCcaret_set (-1, -1)
 4774         ELSE
 4775          PROCicon_unshade (handle%, i%) : REM Is name always first icon?
 4776          PROCcaret_set(handle%,i%)
 4777         ENDIF
 4778        ENDPROC
 4779       ENDIF
 4780     ENDIF
 4781   NEXT
 4782 ENDPROC
 4783 DEF FNprinter_find_window(prnt%,name$)
 4784   LOCAL psup%
 4785   psup%=prnt%! 4 
 4786   i%=psup%! 20 
 4787   WHILE i%
 4788    IF $(i%+ 16 )=name$ THEN
 4789     i%! 8 =psup%
 4790     i%! 12 =prnt%
 4791     =i%! 4 
 4792    ENDIF
 4793    i%=i%! 0 
 4794   ENDWHILE
 4795   ERROR  253 ,FNmsg_1(A%! 12 ,"FAE",name$)
 4796 =0
 4797 DEF PROCprinter_find_handle(handle%,RETURN wind%,RETURN psup%,RETURN prnt%)
 4798   psup%=psup_head%
 4799   WHILE psup%
 4800     wind%=psup%! 20 
 4801     WHILE wind%
 4802       IF wind%! 4 =handle% THEN
 4803         prnt%=wind%! 12 
 4804         ENDPROC
 4805       ENDIF
 4806       wind%=wind%! 0 
 4807     ENDWHILE
 4808     psup%=psup%! 0 
 4809   ENDWHILE
 4810   wind%=0
 4811   psup%=0
 4812   prnt%=0
 4813 ENDPROC
 4814 DEF FNprinter_find_prdata_entry(psup%,name$)
 4815   LOCAL prdt%
 4816   IF psup%=0 THEN =0
 4817   prdt%=psup%! 12 
 4818   IF prdt%=0 THEN =0
 4819   prdt%=prdt%! 4 
 4820   IF prdt%=0 THEN =0
 4821   WHILE $prdt%! 8 <>name$
 4822     prdt%=prdt%! 0 
 4823     IF prdt%=0 THEN =0
 4824   ENDWHILE
 4825 =prdt%
 4826 DEF FNprinter_read_integer(ptr%)
 4827   IF ptr%=0 THEN =0
 4828   IF ptr%!-4<> &47544E49  AND ptr%!-4<> &52544F50  THEN
 4829     ERROR  253 ,FNmsg_0(A%! 12 ,"FA6")
 4830   ENDIF
 4831 =!ptr%
 4832 DEF FNprinter_read_string(ptr%)
 4833   LOCAL i%,s$
 4834   IF ptr%=0 THEN =""
 4835   CASE ptr%!-4 OF
 4836     WHEN  &47525453 
 4837       =$ptr%
 4838     WHEN  &30525453 
 4839       CALL Z%,ptr%,s$  
 4840       =s$
 4841     WHEN  &52545347 
 4842       CALL Y%,ptr%,s$  
 4843       =s$
 4844   ENDCASE
 4845   ERROR  253 ,FNmsg_0(A%! 12 ,"FA7")
 4846 =""
 4847 DEF FNprinter_read_integer_entry(prdt%,entry%)
 4848   IF prdt%=0 THEN =0
 4849 =FNprinter_read_integer(prdt%!(4+entry%*4))
 4850 REM wahay! write_entry? only used to set flag bit in dp/lj palette number at present
 4851 DEF PROCprinter_write_integer_entry(prdt%,entry%,value%)
 4852   LOCAL ptr%
 4853   IF prdt% <> 0 THEN
 4854     ptr% = prdt%!(4+entry%*4)
 4855     IF ptr%!-4<> &47544E49  AND ptr%!-4<> &52544F50  THEN
 4856       ERROR  253 ,FNmsg_0(A%! 12 ,"FA6")
 4857     ENDIF
 4858     !ptr%=value%
 4859   ENDIF
 4860 ENDPROC
 4861 DEF FNprinter_read_string_entry(prdt%,entry%)
 4862   IF prdt%=0 THEN =""
 4863 =FNprinter_read_string(prdt%!(4+entry%*4))
 4864 DEF FNprinter_read_boolean_string_entry(prdt%,entry%,true%)
 4865   LOCAL ptr%
 4866   IF prdt%=0 =""
 4867   ptr%=prdt%!(4+entry%*4)
 4868   IF ptr%!-4<> &4C4f4F42  ERROR  253 ,FNmsg_0(A%! 12 ,"FA8")
 4869   IF true% THEN
 4870    =FNprinter_read_string(ptr%! 4 )
 4871   ELSE
 4872    =FNprinter_read_string(ptr%! 0 )
 4873   ENDIF
 4874 DEF FNprinter_read_list_integer_entry(prdt%,entry%,list%,list_entry%)
 4875   LOCAL ptr%
 4876   IF prdt%=0 THEN =0
 4877   ptr%=prdt%!(4+entry%*4)
 4878   IF ptr%=0 =0
 4879   IF ptr%!-4<> &4454534C  ERROR  253 ,FNmsg_0(A%! 12 ,"FA9")
 4880   WHILE list%<>1 AND ptr%
 4881     ptr%=ptr%! 0 
 4882     list%-=1
 4883   ENDWHILE
 4884   IF ptr%=0 =0
 4885   ptr%+=8
 4886   WHILE list_entry%<>1
 4887     ptr%+=4
 4888     list_entry%-=1
 4889   ENDWHILE
 4890 =FNprinter_read_integer(!ptr%)
 4891 DEF FNprinter_read_list_string_entry(prdt%,entry%,list%,list_entry%)
 4892   LOCAL ptr%
 4893   IF prdt%=0 THEN =""
 4894   ptr%=prdt%!(4+entry%*4)
 4895   IF ptr%=0 =""
 4896   IF ptr%!-4<> &4454534C  ERROR  253 ,FNmsg_0(A%! 12 ,"FA9")
 4897   WHILE list%<>1 AND ptr%
 4898     ptr%=ptr%! 0 
 4899     list%-=1
 4900   ENDWHILE
 4901   IF ptr%=0 =""
 4902   ptr%+=8
 4903   WHILE list_entry%<>1
 4904     ptr%+=4
 4905     list_entry%-=1
 4906   ENDWHILE
 4907 =FNprinter_read_string(!ptr%)
 4908 DEF PROCmsg_initialise(N$,RETURN msg_desc%)
 4909   LOCAL ERROR
 4910   ON ERROR LOCAL RESTORE ERROR: ERROR 0,REPORT$
 4911   SYS "OS_Module",6,,,17+LEN N$ TO,,msg_desc%
 4912   $(msg_desc%+16)=N$
 4913   SYS "MessageTrans_OpenFile",msg_desc%,msg_desc%+16
 4914 ENDPROC
 4915 DEF FNmsg_0(msg_desc%,T$)=FNmsg_4(msg_desc%,T$,"","","","")
 4916 DEF FNmsg_1(msg_desc%,T$,S$)=FNmsg_4(msg_desc%,T$,S$,"","","")
 4917 DEF FNmsg_2(msg_desc%,T$,S0$,S1$)=FNmsg_4(msg_desc%,T$,S0$,S1$,"","")
 4918 DEF FNmsg_3(msg_desc%,T$,S0$,S1$,S2$)=FNmsg_4(msg_desc%,T$,S0$,S1$,S2$,"")
 4919 DEF FNmsg_4(msg_desc%,T$,S0$,S1$,S2$,S3$)
 4920   LOCAL F%,L%
 4921   SYS "XMessageTrans_Lookup",msg_desc%,T$,msg_text%,256,S0$,S1$,S2$,S3$ TO,,,L%;F%
 4922   IF F% AND 1 THEN =T$
 4923   msg_text%?L%=13
 4924 =$msg_text%
 4925 DEF PROCmsg_end(msg_desc%)
 4926   IF msg_desc% THEN
 4927     SYS "MessageTrans_CloseFile",msg_desc%
 4928     SYS "XOS_Module",7,,msg_desc%
 4929   ENDIF
 4930 ENDPROC
 4931 DEF PROCtask_initialise(n$)
 4932   task_id$=n$
 4933   task_buff%!0=&80152  
 4934   task_buff%!4=&80146  
 4935   task_buff%!8=&80145  
 4936   task_buff%!12=&80143  
 4937   task_buff%!16=&80142  
 4938   task_buff%!20=&80141  
 4939   task_buff%!24=&80140  
 4940   task_buff%!28=&400C9  
 4941   task_buff%!32=&502  
 4942   task_buff%!36=12  
 4943   task_buff%!40=11  
 4944   task_buff%!44=10  
 4945   task_buff%!48=8  
 4946   task_buff%!52=3  
 4947   task_buff%!56=2  
 4948   task_buff%!60=1  
 4949   task_buff%!64=5  
 4950   task_buff%!68=0  
 4951   SYS "Wimp_Initialise",300,&4B534154,n$,task_buff% TO wimp_version%,task_handle%
 4952 ENDPROC
 4953 DEF PROCtask_shutdown
 4954   SYS "Wimp_CloseDown"
 4955   END
 4956 DEF FNtask_poll(mask%)
 4957   LOCAL task_action%,time_after%,prnt%,t%
 4958   IF file_to_delete$<>"" mask%=mask% OR 1
 4959   IF(mask% AND 1)=0 OR timeout%=-1 OR mask%<>A%! 20  THEN
 4960     SYS "Wimp_Poll",mask%,task_buff%,,pollword_location% TO task_action%
 4961   ELSE
 4962     IF timeout%=0 OR file_to_delete$<>"" THEN
 4963       SYS "Wimp_Poll",mask% AND NOT 1,task_buff%,, pollword_location% TO task_action%
 4964     ELSE
 4965       SYS "Wimp_PollIdle",mask% AND NOT 1,task_buff%,time_before%+timeout%, pollword_location% TO task_action%
 4966     ENDIF
 4967   ENDIF
 4968   SYS "OS_ReadMonotonicTime" TO time_after%
 4969   elapsed_time%=time_after%-time_before%
 4970   time_before%=time_after%  
 4971   prnt%=A%! 48 
 4972   WHILE prnt%
 4973     t%=prnt%+ 56   
 4974     IF NOT !t% THEN
 4975       IF elapsed_time%<!t% !t%-=elapsed_time% ELSE !t%=0
 4976     ENDIF
 4977     prnt%=prnt%! 0 
 4978   ENDWHILE
 4979 =task_action%
 4980 DEF PROCdespatch_null
 4981   LOCAL prnt%,psup%,t%
 4982   IF file_to_delete$<>"" THEN
 4983     SYS "XOS_File",6,file_to_delete$
 4984     file_to_delete$=""
 4985   ENDIF
 4986   prnt%=A%! 48 
 4987   WHILE prnt%
 4988     t%=prnt%+ 56   
 4989     IF !t%=0 THEN
 4990       psup%=prnt%! 4 
 4991       PROCprinter_reason_code(psup%,prnt%,0,0)
 4992       !t%=10*psup%?( 24 +1)
 4993     ENDIF
 4994     prnt%=prnt%! 0 
 4995   ENDWHILE
 4996 ENDPROC
 4997 DEF FNtask_read_env(n$,buff%)
 4998   LOCAL len%,flags%
 4999   SYS "XOS_ReadVarVal",n$,buff%,256,,3 TO,,len%;flags%
 5000   IF flags% AND 1 len%=0
 5001   buff%?len%=13
 5002 =$buff%
 5003 DEF FNtask_compare(a$,b$)
 5004   LOCAL cmp%
 5005   SYS "Territory_Collate",-1,a$,b$,%11 TO cmp%
 5006 =cmp%
 5007 DEF FNtask_lower(s$)
 5008   LOCAL l$,table%,i%
 5009   SYS "Territory_LowerCaseTable",-1 TO table%
 5010   l$=""
 5011   IF 1<=LEN s$ THEN
 5012     FOR i%=1 TO LEN s$
 5013       l$+=CHR$ table%?ASC MID$(s$,i%,i%)
 5014     NEXT
 5015   ENDIF
 5016 =l$
 5017 DEF FNtask_upper(s$)
 5018   LOCAL u$,table%,i%
 5019   SYS "Territory_UpperCaseTable",-1 TO table%
 5020   u$=""
 5021   IF 1<=LEN s$ THEN
 5022     FOR i%=1 TO LEN s$
 5023       u$+=CHR$ table%?ASC MID$(s$,i%,i%)
 5024     NEXT
 5025   ENDIF
 5026 =u$
 5027 DEF PROCerror_initialise
 5028   DIM error_buff% 256
 5029 ENDPROC
 5030 DEF PROCerror
 5031   LOCAL r$,r%
 5032   r$=REPORT$
 5033     r%=INSTR(r$,"in "+CHR$34+"!")
 5034     IF r% r$=LEFT$(r$,r%-1)
 5035   CASE ERR OF
 5036     WHEN  254 
 5037       PROCerror_box(r$,1)
 5038     WHEN  253 
 5039       PROCerror_box(r$,2)
 5040     OTHERWISE
 5041       PROCerror_box(r$+" (&"+STR$~ERR+") @"+STR$ERL,3)
 5042   ENDCASE
 5043 ENDPROC
 5044 DEF PROCerror_box(r$,error_flag%)
 5045   LOCAL r%
 5046   SYS "Wimp_CreateMenu",,-1
 5047   !error_buff%=ERR
 5048     $(error_buff%+4)=r$+CHR$ 0
 5049   SYS "Wimp_ReportError",error_buff%,error_flag%,task_id$ TO,r%
 5050   IF r%=2 THEN
 5051     ON ERROR OFF
 5052     shutdown_type%=2
 5053     PROCdestroy_queue
 5054     PROChost_shutdown  
 5055   ENDIF
 5056 ENDPROC
 5057 DEF PROCerror_warning(r$)
 5058   !error_buff%=1
 5059     $(error_buff%+4)=r$+CHR$ 0
 5060   SYS "Wimp_ReportError",error_buff%,1 OR 1<<4,FNmsg_1(A%! 12 ,"ER2",task_id$)
 5061 ENDPROC
 5062 DEF PROCicon_initialise
 5063   icon_priority%=0
 5064 ENDPROC
 5065 DEF FNiconbar_tands(text$,sprite$,side%,nextto%)
 5066   LOCAL t%,s%,i%,v$,w%
 5067   IF sprite$="s"+FNmsg_0(A%! 12 ,"IC") THEN
 5068     v$="s"+sprite$
 5069     SYS "Wimp_SpriteOp",40,,sprite$ TO,,,w%
 5070   ELSE
 5071     SYS "XWimp_SpriteOp",40,,sprite$ TO,,,w%;i%
 5072     IF i% AND 1 THEN
 5073       SYS "Wimp_SpriteOp",40,,"s"+FNmsg_0(A%! 12 ,"IC") TO,,,w%
 5074      IF LEFT$(sprite$, 3) = "su_" THEN
 5075       v$ = "ssu"+FNmsg_0(A%! 12 ,"IC")
 5076      ELSE
 5077       v$="ss"+FNmsg_0(A%! 12 ,"IC")+","+FNmsg_0(A%! 12 ,"IC")
 5078      ENDIF
 5079     ELSE
 5080       IF LEFT$(sprite$, 3) = "su_" THEN
 5081        v$ = "s"+sprite$
 5082       ELSE
 5083        v$="ss_"+sprite$+","+sprite$
 5084       ENDIF
 5085     ENDIF
 5086   ENDIF
 5087   B%= &46464249 
 5088   C%=LEN text$+1
 5089   t%=USR(code_entry%+ 12 )
 5090   IF t%=0 ERROR  253 ,FNmsg_1(A%! 12 ,"FA5","IBFF")
 5091   $t%=text$
 5092   B%= &46464249 
 5093   C%=LEN v$+1
 5094   s%=USR(code_entry%+ 12 )
 5095   IF s%=0 ERROR  253 ,FNmsg_1(A%! 12 ,"FA5","IBFF")
 5096   $s%=v$
 5097   SYS "OS_ReadModeVariable",-1,4 TO,,i%
 5098   IF(w%<<i%)<LEN text$*16 w%=LEN text$*16 ELSE w%=w%<<i%
 5099   icon_buffer%!0=side%
 5100   icon_buffer%!4=0
 5101   icon_buffer%!8=-16
 5102   icon_buffer%!12=w%
 5103   icon_buffer%!16=88
 5104   icon_buffer%!20=&1700310B
 5105   icon_buffer%!24=t%
 5106   icon_buffer%!28=s%
 5107   icon_buffer%!32=LEN text$+1
 5108   SYS "Wimp_CreateIcon",nextto%,icon_buffer% TO i%
 5109 =i%
 5110 DEF PROCicon_delete(a%,b%)
 5111   !icon_buffer%=a%
 5112   icon_buffer%!4=b%
 5113   SYS "Wimp_GetIconState",,icon_buffer%
 5114   SYS "Wimp_DeleteIcon",,icon_buffer%
 5115   IF icon_buffer%!24 AND 1<<8 THEN
 5116     IF icon_buffer%!24 AND 3 THEN
 5117       B%= &46464249 
 5118       C%=icon_buffer%!28
 5119       CALL code_entry%+ 16 
 5120       IF icon_buffer%!24 AND 1 THEN
 5121         IF NOT icon_buffer%!32 THEN
 5122           B%= &46464249 
 5123           C%=icon_buffer%!32
 5124           CALL code_entry%+ 16 
 5125         ENDIF
 5126       ENDIF
 5127     ENDIF
 5128   ENDIF
 5129 ENDPROC
 5130 DEF PROCicon_write(a%,b%,s$)
 5131   LOCAL h%,i%,n%
 5132   PROCcaret_info(h%,i%,n%)
 5133   !icon_buffer%=a%
 5134   icon_buffer%!4=b%
 5135   SYS "Wimp_GetIconState",,icon_buffer%
 5136   IF LEN s$+1>icon_buffer%!36 THEN
 5137     ERROR  253 ,FNmsg_2(A%! 12 ,"FAH",s$,STR$ b%)
 5138   ENDIF
 5139   $icon_buffer%!28=s$
 5140   icon_buffer%!8=0
 5141   icon_buffer%!12=0
 5142   SYS "Wimp_SetIconState",,icon_buffer%
 5143   IF h%=a% AND i%=b% PROCcaret_set(a%,b%)
 5144 ENDPROC
 5145 DEF PROCicon_validation(a%,b%,s$)
 5146   !icon_buffer%=a%
 5147   icon_buffer%!4=b%
 5148   SYS "Wimp_GetIconState",,icon_buffer%
 5149   $icon_buffer%!32=s$
 5150   icon_buffer%!8=0
 5151   icon_buffer%!12=0
 5152   SYS "Wimp_SetIconState",,icon_buffer%
 5153 ENDPROC
 5154 DEF FNicon_read(a%,b%)
 5155   !icon_buffer%=a%
 5156   icon_buffer%!4=b%
 5157   SYS "Wimp_GetIconState",,icon_buffer%
 5158 =$icon_buffer%!28
 5159 DEF PROCicon_unshade(a%,b%)
 5160   !icon_buffer%=a%
 5161   icon_buffer%!4=b%
 5162   icon_buffer%!8=0
 5163   icon_buffer%!12=1<<22
 5164   SYS "Wimp_SetIconState",,icon_buffer%
 5165 ENDPROC
 5166 DEF PROCicon_shade(a%,b%)
 5167   !icon_buffer%=a%
 5168   icon_buffer%!4=b%
 5169   icon_buffer%!8=1<<22
 5170   icon_buffer%!12=1<<22
 5171   SYS "Wimp_SetIconState",,icon_buffer%
 5172 ENDPROC
 5173 DEF PROCicon_deselect(a%,b%)
 5174   !icon_buffer%=a%
 5175   icon_buffer%!4=b%
 5176   icon_buffer%!8=0
 5177   icon_buffer%!12=1<<21
 5178   SYS "Wimp_SetIconState",,icon_buffer%
 5179   IFa%=prntctrl% select_all%= 0 
 5180 ENDPROC
 5181 DEF PROCicon_select(a%,b%)
 5182   !icon_buffer%=a%
 5183   icon_buffer%!4=b%
 5184   icon_buffer%!8=1<<21
 5185   icon_buffer%!12=1<<21
 5186   SYS "Wimp_SetIconState",,icon_buffer%
 5187   IFa%=prntctrl% select_all%= 0 
 5188 ENDPROC
 5189 DEF FNicon_set(a%,b%)
 5190   !icon_buffer%=a%
 5191   icon_buffer%!4=b%
 5192   SYS "Wimp_GetIconState",,icon_buffer%
 5193 =(icon_buffer%!24 AND 1<<21)<>0
 5194 DEF PROCicon_info(a%,b%,RETURN x1%,RETURN y1%,RETURN x2%,RETURN y2%)
 5195   !icon_buffer%=a%
 5196   icon_buffer%!4=b%
 5197   SYS "Wimp_GetIconState",,icon_buffer%
 5198   x1%=icon_buffer%!8
 5199   y1%=icon_buffer%!12
 5200   x2%=icon_buffer%!16
 5201   y2%=icon_buffer%!20
 5202 ENDPROC
 5203 DEF PROCcaret_set(h%,i%)
 5204   LOCAL j%
 5205   j%=LEN FNicon_read(h%,i%)
 5206   SYS "Wimp_SetCaretPosition",h%,i%,-1,-1,,j%
 5207   SYS "Wimp_SetCaretPosition",h%,i%,-1,-1,-1,j%
 5208 ENDPROC
 5209 DEF PROCcaret_info(RETURN h%,RETURN i%,RETURN n%)
 5210   SYS "Wimp_GetCaretPosition",,icon_buffer%
 5211   h%=!icon_buffer%
 5212   i%=icon_buffer%!4
 5213   n%=icon_buffer%!20
 5214 ENDPROC
 5215 DEF PROCwin_initialise
 5216   win_template$=""
 5217 ENDPROC
 5218 DEF PROCwin_template_open(f2$,f3$)
 5219   LOCAL a$,a%
 5220   SYS"OS_Byte",161,&8C TO ,,a%
 5221   IF (a%AND1)=1 THEN
 5222     SYS"OS_File",17,f3$ TO a%
 5223     IFa%=1 win_template$=f3$ ELSE win_template$=f2$
 5224   ELSE
 5225    win_template$=f2$
 5226   ENDIF
 5227   SYS"Wimp_OpenTemplate",,win_template$
 5228 ENDPROC
 5229 DEF PROCwin_template_close
 5230   SYS "Wimp_CloseTemplate"
 5231 ENDPROC
 5232 DEF PROCwin_load_create(f$,n$,sprite_pool%,RETURN handle%)
 5233   LOCAL buff%
 5234   PROCwin_load(f$,n$,buff%)  
 5235   buff%!64=sprite_pool%
 5236   PROCwin_create(buff%,handle%)
 5237   B%= &444E4957 
 5238   C%=buff%
 5239   CALL code_entry%+ 16 
 5240 ENDPROC
 5241 DEF PROCwin_load(f$,n$,RETURN buf%)
 5242   LOCAL ws_buf%,size%,data%,found%,s%,f%,s$
 5243   PROCwin_sizes(f$,n$,size%,data%)
 5244   B%= &444E4957 
 5245   C%=size%+data%
 5246   buf%=USR(code_entry%+ 12 )
 5247   IF buf%=0     ERROR  253 ,FNmsg_1(A%! 12 ,"FA5","WIND")
 5248   IF f$<>"" SYS "Wimp_OpenTemplate",,f$
 5249   IF data% THEN
 5250    B%= &46465542 
 5251    C%=data%
 5252    ws_buf%=USR(code_entry%+ 12 )
 5253    IF ws_buf%=0      ERROR  253 ,FNmsg_1(A%! 12 ,"FA5","BUFF")
 5254    SYS "XWimp_LoadTemplate",,buf%,ws_buf%,ws_buf%+data%,-1,n$ TO        s%,,,,,,found%;f%
 5255   ELSE
 5256    SYS "XWimp_LoadTemplate",,buf%,,,-1,n$ TO s%,,,,,,found%;f%
 5257   ENDIF
 5258   IF f$<>"" SYS "Wimp_CloseTemplate"
 5259   IF f% AND 1     f%=s%+4:     CALL Z%,f%,s$:       ERROR  254 ,n$+": "+s$
 5260   IF found%=0     ERROR  254 ,FNmsg_1(A%! 12 ,"OKAK",n$)
 5261 ENDPROC
 5262 DEF PROCwin_create(buf%,RETURN handle%)
 5263   SYS "Wimp_CreateWindow",,buf% TO handle%
 5264 ENDPROC
 5265 DEF PROCwin_open(a%)
 5266   !win_buff%=a%
 5267   SYS "Wimp_GetWindowState",,win_buff%
 5268   win_buff%!28=-1
 5269   SYS "Wimp_OpenWindow",,win_buff%
 5270 ENDPROC
 5271 DEF PROCwin_title(a%,s$)
 5272   LOCAL wox0%,way1%,wox1%,woy1%
 5273   !win_buff%=a%
 5274   SYS "Wimp_GetWindowInfo",,win_buff% OR 1
 5275   $win_buff%!76=s$
 5276   IF win_buff%!32 AND 1<<16 THEN
 5277     way1%=win_buff%!16
 5278     SYS "Wimp_GetWindowOutline",,win_buff%
 5279     wox0%=win_buff%!4
 5280     wox1%=win_buff%!12
 5281     woy1%=win_buff%!16
 5282     SYS "Wimp_ForceRedraw",-1,wox0%,way1%,wox1%,woy1%
 5283   ENDIF
 5284 ENDPROC
 5285 DEF PROCwin_get_next_name(file$,RETURN ptr%,RETURN name$)
 5286   LOCAL f%,offset%,type%
 5287   IF f$="" AND wimp_version%>=300 THEN
 5288     SYS "Wimp_LoadTemplate",,,,,-1,"*"+STRING$(12,CHR$ 0),ptr% TO        ,,,,,name$,ptr%
 5289   ELSE
 5290     IF file$="" file$=win_template$
 5291     f%=OPENIN file$
 5292     IF ptr%=0 ptr%=16
 5293     REPEAT
 5294       PTR#f%=ptr%
 5295       offset%=FNwin_word(f%)
 5296       IF offset% THEN
 5297         PTR#f%=ptr%+8
 5298         type%=FNwin_word(f%)
 5299         name$=FNwin_string(f%)
 5300         ptr%+=24
 5301         IF type%=1 offset%=0
 5302       ELSE
 5303         ptr%=0
 5304       ENDIF
 5305     UNTIL offset%=0
 5306     SYS "XOS_Find",,f%  
 5307   ENDIF
 5308 ENDPROC
 5309 DEF PROCwin_sizes(f$,n$,RETURN size%,RETURN data%)
 5310   LOCAL i%,file%,ptr%,offset%,type%,ident$,num_icons%
 5311   IF f$="" AND wimp_version%>=300 THEN
 5312     SYS "Wimp_LoadTemplate",,,,,-1,n$ TO,size%,data%
 5313   ELSE
 5314     IF f$="" f$=win_template$
 5315     file%=OPENIN f$
 5316     size%=0
 5317     data%=0
 5318     ptr%=16
 5319     REPEAT
 5320       PTR#file%=ptr%
 5321       offset%=FNwin_word(file%)
 5322       IF offset% THEN
 5323         PTR#file%=ptr%+8
 5324         type%=FNwin_word(file%)
 5325         ident$=FNwin_string(file%)
 5326         ptr%+=24
 5327         IF type%=1 THEN
 5328           IF ident$=n$ THEN
 5329             PTR#file%=offset%+84
 5330             num_icons%=FNwin_word(file%)
 5331             data%=FNwin_title(file%,offset%)
 5332             IF num_icons% data%+=FNwin_icon(file%,num_icons%,offset%)
 5333             size%=88+(num_icons%*32)
 5334             offset%=0  
 5335           ENDIF
 5336         ENDIF
 5337       ENDIF
 5338     UNTIL offset%=0
 5339     SYS "XOS_Find",,file%  
 5340   ENDIF
 5341 ENDPROC
 5342 DEF FNwin_word(h%)
 5343 =BGET#h% OR BGET#h%<<8 OR BGET#h%<<16 OR BGET#h%<<24
 5344 DEF FNwin_string(h%)
 5345   LOCAL s$,c%
 5346   REPEAT
 5347    c%=BGET#h%
 5348    IF c%>31 s$+=CHR$ c%
 5349   UNTIL c%<32
 5350 =s$
 5351 DEF FNwin_title(file%,offset%)
 5352   LOCAL v%
 5353   PTR#file%=offset%+28
 5354   v%=FNwin_word(file%)
 5355   IF v% AND 1<<31 THEN
 5356     IF v% AND 1<<26 THEN =FNwin_isd(file%,offset%+56,offset%+72,offset%)
 5357   ELSE
 5358     IF v% AND 1 THEN =FNwin_isd(file%,offset%+56,offset%+72,offset%)
 5359   ENDIF
 5360 =0
 5361 DEF FNwin_icon(file%,num%,offset%)
 5362   LOCAL i%,j%
 5363   j%=0
 5364   IF 0<=num%-1 THEN
 5365     FOR i%=0 TO num%-1
 5366      j%+=FNwin_isd(file%,offset%+88+i%*32+16,offset%+88+i%*32+20,offset%)
 5367     NEXT
 5368   ENDIF
 5369 =j%
 5370 DEF FNwin_isd(file%,o1%,o2%,offset%)
 5371   LOCAL v%,ist%,size%,i%
 5372   PTR#file%=o1%
 5373   v%=FNwin_word(file%)
 5374   i%=v% AND %100000000
 5375   ist%=(v% AND 3)+(i% >> 6)
 5376   CASE ist% OF
 5377    WHEN 0,1,2,3,4
 5378     size%=0
 5379    WHEN 5,7
 5380     PTR#file%=o2%+4
 5381     v%=FNwin_word(file%)
 5382     IF v%=-1 THEN
 5383       size%=0
 5384     ELSE
 5385       PTR#file%=offset%+v%
 5386       size%=LEN FNwin_string(file%)+1
 5387     ENDIF
 5388     PTR#file%=o2%+8
 5389     size%+=FNwin_word(file%)
 5390    WHEN 6
 5391     PTR#file%=o2%+8
 5392     size%=FNwin_word(file%)
 5393   ENDCASE
 5394 =size%
 5395 DEF PROCsave_initialise
 5396   LOCAL f%
 5397   SYS "XOS_SWINumberFromString",,"DragASprite_Start" TO save_start%;f%
 5398   IF f% AND 1 save_start%=-1
 5399   SYS "XOS_SWINumberFromString",,"DragASprite_Stop" TO save_stop%;f%
 5400   IF f% AND 1 save_stop%=-1
 5401   SYS "OS_Byte",161,&1C TO,,f%
 5402   IF(f% AND 2)=0 THEN
 5403    save_start%=-1
 5404    save_stop%=-1
 5405   ENDIF
 5406   B%= &45564153 
 5407   C%=256
 5408   save_buff%=USR(code_entry%+ 12 )
 5409   IF save_buff%=0 ERROR  253 ,FNmsg_1(A%! 12 ,"FA5","SAVE")
 5410   save_dragging%= 0 
 5411 ENDPROC
 5412 DEF PROCsave_setup(filetype%,icon_name$)
 5413   LOCAL b$
 5414   b$=STR$~filetype%
 5415   b$=RIGHT$("000"+b$,3)
 5416   save_filetype%=filetype%
 5417   PROCicon_validation(save_wind%, 0 ,"sfile_"+b$)
 5418   PROCicon_write(save_wind%, 1 ,icon_name$)
 5419 ENDPROC
 5420 DEF PROCsave_dragicon(mousex%,mousey%)
 5421   LOCAL bx%,by%,ix0%,ix1%,iy0%,iy1%,scrx%,scry%,f$,mc_sw%,mc_dx%,mc_sh%,mc_dy%
 5422   !save_buff%=save_wind%
 5423   SYS "Wimp_GetWindowState",,save_buff%
 5424   bx%=save_buff%!4 - save_buff%!20
 5425   by%=save_buff%!16 - save_buff%!24
 5426   PROCicon_info(save_wind%, 0 ,ix0%,iy0%,ix1%,iy1%)
 5427   SYS "OS_ReadModeVariable",-1,4 TO,,mc_dx%
 5428   mc_dx%=1<<mc_dx%
 5429   SYS "OS_ReadModeVariable",-1,5 TO,,mc_dy%
 5430   mc_dy%=1<<mc_dy%
 5431   SYS "OS_ReadModeVariable",-1,11 TO,,mc_sw%
 5432   mc_sw%+=1
 5433   SYS "OS_ReadModeVariable",-1,12 TO,,mc_sh%
 5434   mc_sh%+=1
 5435   scrx%=mc_sw%*mc_dx%
 5436   scry%=mc_sh%*mc_dy%
 5437   !save_buff%=save_wind%
 5438   save_buff%!4=5
 5439   save_buff%!8=bx%+ix0%
 5440   save_buff%!12=by%+iy0%
 5441   save_buff%!16=bx%+ix1%
 5442   save_buff%!20=by%+iy1%
 5443   save_buff%!24=save_buff%!8-mousex%
 5444   save_buff%!28=save_buff%!12-mousey%
 5445   save_buff%!32=scrx%+save_buff%!16-mousex%
 5446   save_buff%!36=scry%+save_buff%!20-mousey%
 5447   IF NOT save_start% THEN
 5448    f$="file_"+RIGHT$("000"+STR$~save_filetype%,3)
 5449    SYS save_start%,%11000101,1,f$,save_buff%+8,save_buff%+24
 5450   ELSE
 5451    SYS "Wimp_DragBox",,save_buff%
 5452   ENDIF
 5453   save_dragging%= -1 
 5454 ENDPROC
 5455 DEF PROCsave_decodedrag
 5456   LOCAL h%,i%,mx%,my%,ft%
 5457   save_dragging%= 0 
 5458   IF NOT save_stop% SYS save_stop%
 5459   SYS "Wimp_GetPointerInfo",,save_buff%
 5460   mx%=!save_buff%
 5461   my%=save_buff%!4
 5462   h%=save_buff%!12
 5463   i%=save_buff%!16
 5464   IF h%=save_wind% ENDPROC  
 5465   PROCsave_dragfile(h%,i%,mx%,my%)
 5466 ENDPROC
 5467 DEF PROCsave_dragfile(h%,i%,mx%,my%)
 5468   LOCAL f1$
 5469   f1$=FNsave_leafname
 5470   !save_buff%=48+LEN f1$ AND NOT 3
 5471   save_buff%!12=0
 5472   save_buff%!16=1  
 5473   save_buff%!20=h%
 5474   save_buff%!24=i%
 5475   save_buff%!28=mx%
 5476   save_buff%!32=my%
 5477   save_buff%!36=0
 5478   save_buff%!40=save_filetype%
 5479   $(save_buff%+44)=f1$+CHR$ 0
 5480   SYS "Wimp_SendMessage",17,save_buff%,h%,i%
 5481 ENDPROC
 5482 DEF FNsave_leafname
 5483   LOCAL f$,i%
 5484   f$=FNicon_read(save_wind%, 1 )
 5485   REPEAT
 5486    i%=INSTR(f$,":")
 5487    IF i% f$=MID$(f$,i%+1)
 5488   UNTIL i%=0
 5489   REPEAT
 5490    i%=INSTR(f$,".")
 5491    IF i% f$=MID$(f$,i%+1)
 5492   UNTIL i%=0
 5493 =f$
 5494 DEF PROCmenu_initialise
 5495   menu_top%=0
 5496   menu_count%=0
 5497 ENDPROC
 5498 DEF PROCmenu_create(RETURN menu%,menu$)
 5499   LOCAL menutitle$,i%,menu1$,item$,j%,x%,t%
 5500   IF menu_top% THEN
 5501     PROCmenu_release
 5502     menu_top%=0
 5503     menu_count%=0
 5504   ENDIF
 5505   IF LEFT$(menu$,1)="#" THEN
 5506     i%=1
 5507     menutitle$=FNmenu_par(menu$,",",i%)
 5508   ELSE
 5509     menutitle$=""
 5510   ENDIF
 5511   menu1$=menu$
 5512   j%=i%
 5513   REPEAT
 5514     item$=FNmenu_par(menu$,",",i%)
 5515     IF item$<>"" menu_count%+=1
 5516   UNTIL item$=""
 5517   menu$=menu1$
 5518   i%=j%
 5519   B%= &554E454D 
 5520   C%=28+menu_count%*24
 5521   menu_top%=USR(code_entry%+ 12 )
 5522   IF menu_top%=0     ERROR  253 ,FNmsg_1(A%! 12 ,"FA5","MENU")
 5523   IF LEN menutitle$<=12 THEN
 5524     $menu_top%=menutitle$
 5525   ELSE
 5526     B%= &554E454D 
 5527     C%=LEN menutitle$+2
 5528     t%=USR(code_entry%+ 12 )
 5529     IF t%=0       ERROR  253 ,FNmsg_1(A%! 12 ,"FA5","MENU")
 5530     $t%=menutitle$+CHR$ 0
 5531     menu_top%!0=t%
 5532   ENDIF
 5533   menu_top%?12=7
 5534   menu_top%?13=2
 5535   menu_top%?14=7
 5536   menu_top%?15=0
 5537   menu_top%!16=196
 5538   menu_top%!20=44
 5539   menu_top%!24=0
 5540   x%=LEN menutitle$-3
 5541   menu_top%!16=(x%*8+6)*2
 5542   FOR j%=0 TO menu_count%-1
 5543     item$=FNmenu_par(menu$,",",i%)
 5544     PROCmenu_item(menu_top%,j%,item$,LEN menutitle$>12)
 5545   NEXT
 5546   menu%=menu_top%
 5547 ENDPROC
 5548 DEF PROCmenu_release
 5549   LOCAL i%,p%,indirected_title%
 5550   p%=menu_top%+28
 5551   indirected_title%=p%!0 AND &100
 5552   IF 0<=menu_count%-1 THEN
 5553     FOR i%=0 TO menu_count%-1
 5554       IF p%!8 AND &100 THEN
 5555         IF(!p% AND 4)=0 THEN
 5556           B%= &554E454D 
 5557           C%=p%!12
 5558           CALL code_entry%+ 16 
 5559         ENDIF
 5560       ENDIF
 5561       p%+=24
 5562     NEXT
 5563   ENDIF
 5564   IF indirected_title% THEN
 5565     B%= &554E454D 
 5566     C%=menu_top%!0
 5567     CALL code_entry%+ 16 
 5568   ENDIF
 5569   B%= &554E454D 
 5570   C%=menu_top%
 5571   CALL code_entry%+ 16 
 5572 ENDPROC
 5573 DEF PROCmenu_item(RETURN menu%,item%,item$,indirected_title%)
 5574   LOCAL F%,p%,i%,x%,m%
 5575   x%=(menu%!16/2-6)/8
 5576   IF RIGHT$(item$,1)="#" THEN
 5577     item$=LEFT$(item$)
 5578     F%=F% OR 2  
 5579   ENDIF
 5580   IF RIGHT$(item$,1)="@" THEN
 5581     item$=LEFT$(item$)
 5582     F%=F% OR 8  
 5583   ENDIF
 5584   IF item%>=menu_count% THEN
 5585     B%= &554E454D 
 5586     C%=menu_top%
 5587     D%=(item%-menu_count%+1)*24
 5588     m%=USR(code_entry%+ 20 )
 5589     IF m%=0       ERROR  253 ,FNmsg_1(A%! 12 ,"FA5","MENU")
 5590     menu_top%=m%
 5591     p%=menu_top%+28+(menu_count%-1)*24
 5592     !p%=!p% AND NOT &80  
 5593     menu_count%=item%+1
 5594   ENDIF
 5595   IF item%=menu_count%-1 F%=F% OR &80  
 5596   IF item%=0 AND indirected_title% F%=F% OR &100  
 5597   p%=menu_top%+28+item%*24
 5598   p%!0=F%
 5599   p%!4=-1
 5600   p%!8=&07000021
 5601   IF LEFT$(item$,1)="$" THEN
 5602     !p%+=4
 5603     item$=STRING$(12," ")
 5604   ELSE
 5605     IF LEN item$<12 THEN
 5606       $(p%+12)=item$
 5607     ELSE
 5608       B%= &554E454D 
 5609       C%=LEN item$+1
 5610       i%=USR(code_entry%+ 12 )
 5611       IF i%=0         ERROR  253 ,FNmsg_1(A%! 12 ,"FA5","MENU")
 5612       $i%=item$
 5613       p%!8=p%!8 OR &100
 5614       p%!12=i%
 5615       p%!16=-1
 5616       p%!20=LEN item$+1
 5617     ENDIF
 5618   ENDIF
 5619   menu%=menu_top%
 5620   IF LEN item$>x% THEN
 5621     x%=LEN item$
 5622     menu%!16=(x%*8+6)*2
 5623   ENDIF
 5624 ENDPROC
 5625 DEF PROCmenu_attach(menu%,item%,ptr%,traverse%)
 5626   menu%+=28+item%*24
 5627   IF traverse% THEN !menu%=!menu% OR 1<<4
 5628   menu%!4=ptr%
 5629 ENDPROC
 5630 DEF FNmenu_par(menu$,sep$,RETURN I%)
 5631   LOCAL L%
 5632   L%=I%+1
 5633   I%=INSTR(menu$+sep$,sep$,L%)
 5634 =MID$(menu$,L%,I%-L%)
 5635 DEF PROCmenu_shade(menuhandle%,item%,value%)
 5636   IF((menuhandle%!(28+8+24*item%)AND &400000)=&400000)<>value% THEN
 5637    menuhandle%!(28+8+24*item%)=menuhandle%!(28+8+24*item%)EOR &400000
 5638   ENDIF
 5639 ENDPROC
 5640 DEF FNmenu_shade(menuhandle%,item%)
 5641 =((menuhandle%!(28+8+24*item%)AND &400000)=&400000)
 5642 DEF PROCmenu_tick_match(menuhandle%,match$)
 5643   LOCAL item%,string$
 5644   item%=menuhandle%+28
 5645   REPEAT
 5646    IF item%!8 AND &100 string$=$item%!12 ELSE string$=$(item%+12)
 5647    IF FNtask_compare(string$,match$)=0 THEN
 5648     !item%=!item% EOR 1
 5649     ENDPROC
 5650    ENDIF
 5651    IF !item% AND &80 ENDPROC
 5652    item%+=24
 5653   UNTIL  0 
 5654 ENDPROC
 5655 DEF PROCmenu_tick(menuhandle%,item%,on%)
 5656   IF on%     menuhandle%!(28+24*item%)=menuhandle%!(28+24*item%) OR 1   ELSE     menuhandle%!(28+24*item%)=menuhandle%!(28+24*item%) AND NOT 1
 5657 ENDPROC
 5658 DEF PROCmenu_window_centre(h%)
 5659   LOCAL x%,y%,mc_sw%,mc_dx%,mc_sh%,mc_dy%
 5660   SYS "OS_ReadModeVariable",-1,4 TO,,mc_dx%
 5661   mc_dx%=1<<mc_dx%
 5662   SYS "OS_ReadModeVariable",-1,5 TO,,mc_dy%
 5663   mc_dy%=1<<mc_dy%
 5664   SYS "OS_ReadModeVariable",-1,11 TO,,mc_sw%
 5665   mc_sw%+=1
 5666   SYS "OS_ReadModeVariable",-1,12 TO,,mc_sh%
 5667   mc_sh%+=1
 5668   !task_buff%=h%
 5669   SYS "Wimp_GetWindowState",,task_buff%
 5670   x%=mc_sw%*mc_dx%
 5671   y%=mc_sh%*mc_dy%
 5672   x%=(x%-task_buff%!12+task_buff%!4)DIV 2
 5673   y%=(y%+task_buff%!16-task_buff%!8)DIV 2
 5674   SYS "Wimp_CreateMenu",,h%,x%,y%
 5675 ENDPROC
 5676 DEF PROClocale_initialise
 5677   LOCAL p%
 5678   SYS "Territory_ReadSymbols",-1,0 TO p%
 5679   CALL Z%,p%,decimal_point$
 5680 ENDPROC
 5681 DEF FNlocale_val(n$)
 5682   IF decimal_point$="." : =VALn$
 5683   LOCAL i%
 5684   i%=INSTR(n$,decimal_point$)
 5685   IF i%<>0 : =VAL(LEFT$(n$,i%-1)+"."+MID$(n$,i%+1))
 5686 =VALn$
 5687 DEF PROCopen_papersize_window(a%)
 5688   LOCAL i%
 5689   B%= &455A5350 
 5690   C%= 56 
 5691   psize_edit%=USR(code_entry%+ 12 )
 5692   IF psize_edit%=0 ERROR  253 ,FNmsg_1(A%! 12 ,"FA5","PSZE")
 5693   IF a% THEN
 5694     a%=a%! 36 
 5695     IF  0  <  52  THEN
 5696       FOR i%= 0  TO  52  STEP 4
 5697         psize_edit%!i%=a%!i%
 5698       NEXT
 5699     ENDIF
 5700   ELSE
 5701     IF  0 <= 52  THEN
 5702       FOR i%= 0  TO  52  STEP 4
 5703         psize_edit%!i%=0
 5704       NEXT
 5705     ENDIF
 5706   ENDIF
 5707   PROCinitialise_papersize_window
 5708   PROCtell_pinboard(papersize%)
 5709   PROCwin_open(papersize%)
 5710   PROCcaret_set(papersize%, 5 )
 5711 ENDPROC
 5712 DEF PROCinitialise_papersize_window
 5713   LOCAL h%,i%,n%
 5714   PROCcaret_info(h%,i%,n%)
 5715   PROCset_string(papersize%, 5 ,psize_edit%, 4 )
 5716   PROCreset_papertext( 12 , 36 )
 5717   PROCreset_papertext( 13 , 32 )
 5718   PROCreset_papertext( 14 , 40 )
 5719   PROCreset_papertext( 15 , 44 )
 5720   PROCreset_papertext( 16 , 48 )
 5721   PROCreview_papersize_units
 5722   IF psize_edit%! 52 = 1  THEN
 5723     PROCicon_unshade(papersize%, 33 )
 5724   ELSE
 5725     PROCicon_shade(papersize%, 33 )
 5726   ENDIF
 5727 ENDPROC
 5728 DEF PROCreview_papersize_units
 5729   LOCAL s$
 5730   IF NOTFNicon_set(papersize%, 23 ) AND NOTFNicon_set(papersize%, 22 ) THEN
 5731     PROCicon_select(papersize%, 23 )
 5732   ENDIF
 5733   IF FNicon_set(papersize%, 23 )THEN
 5734    s$=FNmsg_0(A%! 12 ,"mm")
 5735   ELSE
 5736    s$=FNmsg_0(A%! 12 ,"in")
 5737   ENDIF
 5738   PROCicon_write(papersize%, 26 ,s$)
 5739   PROCicon_write(papersize%, 29 ,s$)
 5740   PROCicon_write(papersize%, 27 ,s$)
 5741   PROCicon_write(papersize%, 30 ,s$)
 5742   PROCicon_write(papersize%, 28 ,s$)
 5743   PROCicon_write(papersize%, 31 ,s$)
 5744   PROCreset_papersize( 6 , 8 )
 5745   PROCreset_papersize( 7 , 12 )
 5746   PROCreset_papersize( 8 , 20 )
 5747   PROCreset_papersize( 9 , 16 )
 5748   PROCreset_papersize( 10 , 24 )
 5749   PROCreset_papersize( 11 , 28 )
 5750 ENDPROC
 5751 DEF PROCreset_papertext(icon%,offset%)
 5752   PROCicon_write(papersize%,icon%,STR$ psize_edit%!offset%)
 5753 ENDPROC
 5754 DEF PROCreset_papersize(icon%,offset%)
 5755   LOCAL v%
 5756   v%=psize_edit%!offset%
 5757   CASE icon% OF
 5758     WHEN  8 
 5759       v%=psize_edit%! 12 -v%
 5760     WHEN  11 
 5761       v%=psize_edit%! 8 -v%
 5762   ENDCASE
 5763   PROCicon_write(papersize%,icon%,FNmills(v%))
 5764 ENDPROC
 5765 DEF FNmills(v%)
 5766   LOCAL @%
 5767   IF FNicon_set(papersize%, 23 )THEN
 5768    @%="+F10"+decimal_point$+"1"
 5769    =STR$(v%/mm_to_72000)
 5770   ELSE
 5771    @%="+F10"+decimal_point$+"3"
 5772    =STR$(v%/in_to_72000)
 5773   ENDIF
 5774 DEF PROCread_paper_file(f$,flag%)
 5775   LOCAL ts%,psize%,head%,last%,t$
 5776   IF FNload_file(f$)THEN
 5777    REPEAT
 5778     ts%=FNmatch_line("pn:")
 5779     IF ts% THEN
 5780      t$=FNload_paper_size(psize%,$ts%)
 5781      IF t$<>"" PROCpaper_error(f$,t$)
 5782      psize%! 52 =flag%
 5783      head%=psize_head%
 5784      last%=0
 5785      WHILE head%>0
 5786       IF $psize%! 4 =$head%! 4  THEN
 5787        IF head%! 52  =  0  THEN
 5788          psize%! 0 =head%! 0 
 5789          PROCfree_structure(head%! 4 )
 5790          B%= &455A5350 
 5791          C%=head%
 5792          CALL code_entry%+ 16 
 5793          head%=-1
 5794        ELSE
 5795          B%= &455A5350 
 5796          C%=psize%
 5797          CALL code_entry%+ 16 
 5798          psize%=0
 5799          head%=-1
 5800        ENDIF
 5801       ELSE
 5802        IF $psize%! 4 <$head%! 4  THEN
 5803         psize%! 0 =head%
 5804         head%=-1
 5805        ELSE
 5806         last%=head%
 5807         head%=head%! 0 
 5808        ENDIF
 5809       ENDIF
 5810      ENDWHILE
 5811      IF psize% THEN
 5812        IF last% last%! 0 =psize% ELSE psize_head%=psize%
 5813      ENDIF
 5814     ENDIF
 5815    UNTIL ts%=0  
 5816    PROCrelease_file
 5817   ENDIF
 5818 ENDPROC
 5819 DEF PROCpaper_error(f$,t$)
 5820   PROCram_file_error(FNmsg_2(A%! 12 ,"OKO",f$,t$))
 5821 ENDPROC
 5822 DEF FNload_paper_size(RETURN psize%,name$)
 5823   LOCAL t$
 5824   B%= &455A5350 
 5825   C%= 56 
 5826   psize%=USR(code_entry%+ 12 )
 5827   IF psize%=0 ERROR  253 ,FNmsg_1(A%! 12 ,"FA5","PSZE")
 5828   psize%! 0 =0
 5829   $task_buff%=name$
 5830   B%=task_buff%
 5831   C%=2
 5832   psize%! 4 =USR(code_entry%+ 28 )
 5833   ts%=FNmatch_line("pw:")
 5834   IF ts% psize%! 8 =VAL $ts% ELSE ="pw:"
 5835   ts%=FNmatch_line("ph:")
 5836   IF ts% psize%! 12 =VAL $ts% ELSE ="ph:"
 5837   ts%=FNmatch_line("pb:")
 5838   IF ts% psize%! 16 =VAL $ts% ELSE ="pb:"
 5839   ts%=FNmatch_line("pt:")
 5840   IF ts% psize%! 20 =VAL $ts% ELSE ="pt:"
 5841   ts%=FNmatch_line("pl:")
 5842   IF ts% psize%! 24 =VAL $ts% ELSE ="pl:"
 5843   ts%=FNmatch_line("pr:")
 5844   IF ts% psize%! 28 =VAL $ts% ELSE ="pr:"
 5845   ts%=FNmatch_line("tb:")
 5846   IF ts% psize%! 32 =VAL $ts% ELSE ="tb:"
 5847   ts%=FNmatch_line("tt:")
 5848   IF ts% psize%! 36 =VAL $ts% ELSE ="tt:"
 5849   ts%=FNmatch_line("tl:")
 5850   IF ts% psize%! 40 =VAL $ts% ELSE ="tl:"
 5851   ts%=FNmatch_line("tr:")
 5852   IF ts% psize%! 44 =VAL $ts% ELSE ="tr:"
 5853   ts%=FNmatch_line("th:")
 5854   IF ts% psize%! 48 =VAL $ts% ELSE ="th:"
 5855 =""
 5856 DEF PROCsave_paper_size(c%,ptr%)
 5857   BPUT#c%,"pn: "+$ptr%! 4 
 5858   BPUT#c%,"pw: "+STR$ ptr%! 8 
 5859   BPUT#c%,"ph: "+STR$ ptr%! 12 
 5860   BPUT#c%,"pb: "+STR$ ptr%! 16 
 5861   BPUT#c%,"pt: "+STR$ ptr%! 20 
 5862   BPUT#c%,"pl: "+STR$ ptr%! 24 
 5863   BPUT#c%,"pr: "+STR$ ptr%! 28 
 5864   BPUT#c%,"tb: "+STR$ ptr%! 32 
 5865   BPUT#c%,"tt: "+STR$ ptr%! 36 
 5866   BPUT#c%,"tl: "+STR$ ptr%! 40 
 5867   BPUT#c%,"tr: "+STR$ ptr%! 44 
 5868   BPUT#c%,"th: "+STR$ ptr%! 48 
 5869 ENDPROC
 5870 DEF PROCsave_papersize
 5871   LOCAL psize%,s$,this_psize%,head%,last%,c%,prnt%
 5872   LOCAL width, height, left, right, top, bottom
 5873   width = FNlocale_val(FNicon_read(papersize%,  6 ))
 5874   height = FNlocale_val(FNicon_read(papersize%,  7 ))
 5875   left = FNlocale_val(FNicon_read(papersize%,  10 ))
 5876   right = FNlocale_val(FNicon_read(papersize%,  11 ))
 5877   top = FNlocale_val(FNicon_read(papersize%,  8 ))
 5878   bottom = FNlocale_val(FNicon_read(papersize%,  9 ))
 5879   s$=FNicon_read(papersize%, 5 )
 5880   IF s$="" ERROR  254 ,FNmsg_0(A%! 12 ,"OKAD")
 5881   IF FNlocale_val(FNicon_read(papersize%, 6 ))=0 ERROR  254 ,FNmsg_0(A%! 12 ,"OKAE")
 5882   IF FNlocale_val(FNicon_read(papersize%, 7 ))=0 ERROR  254 ,FNmsg_0(A%! 12 ,"OKAE")
 5883   IF (top+bottom > height) ERROR  254 ,     FNmsg_1(A%! 12 ,"OKAY",FNmsg_0(A%! 12 ,"OKAZ"))
 5884   IF (left+right > width) ERROR  254 ,     FNmsg_1(A%! 12 ,"OKAY",FNmsg_0(A%! 12 ,"OKBA"))
 5885   SYS "Hourglass_On"
 5886   psize%=psize_head%
 5887   WHILE psize%
 5888    IF $psize%! 4 =s$ THEN
 5889     this_psize%=psize%
 5890     psize%=0
 5891    ELSE
 5892     psize%=psize%! 0 
 5893    ENDIF
 5894   ENDWHILE
 5895   IFthis_psize%     IFthis_psize%! 52 = 2        ERROR  254 ,FNmsg_0(A%! 12 ,"OKAX")
 5896   IF this_psize%=0 THEN
 5897    B%= &455A5350 
 5898    C%= 56 
 5899    this_psize%=USR(code_entry%+ 12 )
 5900    IF this_psize%=0 ERROR  253 ,FNmsg_1(A%! 12 ,"FA5","PSZE")
 5901    this_psize%! 0 =0
 5902    $task_buff%=s$
 5903    B%=task_buff%
 5904    C%=2
 5905    this_psize%! 4 =USR(code_entry%+ 28 )
 5906    head%=psize_head%
 5907    last%=0
 5908    WHILE head%>0
 5909     IF $this_psize%! 4 <$head%! 4  THEN
 5910      this_psize%! 0 =head%
 5911      head%=-1
 5912     ELSE
 5913      last%=head%
 5914      head%=head%! 0 
 5915     ENDIF
 5916    ENDWHILE
 5917    IF last% last%! 0 =this_psize% ELSE psize_head%=this_psize%
 5918   ENDIF
 5919   PROCsave_value( 6 ,this_psize%, 8 , -1 ,saveit%)
 5920   PROCsave_value( 7 ,this_psize%, 12 , -1 ,saveit%)
 5921   PROCsave_value( 9 ,this_psize%, 16 , -1 ,saveit%)
 5922   PROCsave_value( 8 ,this_psize%, 20 , -1 ,saveit%)
 5923   PROCsave_value( 10 ,this_psize%, 24 , -1 ,saveit%)
 5924   PROCsave_value( 11 ,this_psize%, 28 , -1 ,saveit%)
 5925   PROCsave_value( 13 ,this_psize%, 32 , 0 ,saveit%)
 5926   PROCsave_value( 12 ,this_psize%, 36 , 0 ,saveit%)
 5927   PROCsave_value( 14 ,this_psize%, 40 , 0 ,saveit%)
 5928   PROCsave_value( 15 ,this_psize%, 44 , 0 ,saveit%)
 5929   PROCsave_value( 16 ,this_psize%, 48 , 0 ,saveit%)
 5930   this_psize%! 52 = 1 
 5931   PROCsave_user_defined_paper_sizes
 5932   prnt%=A%! 48 
 5933   WHILE prnt%
 5934    IF prnt%! 36 =this_psize% THEN
 5935     IF prnt%! 24  AND  2  THEN
 5936      PROCselect_printer(prnt%, -1 , 0 )
 5937      PROCset_page_size(prnt%)
 5938      PROCtell_the_world
 5939     ENDIF
 5940    ENDIF
 5941    prnt%=prnt%! 0 
 5942   ENDWHILE
 5943   SYS "Hourglass_Off"
 5944 ENDPROC
 5945 DEF PROCsave_user_defined_paper_sizes
 5946   LOCAL c%,psize%,count%,s$,r0%
 5947   IF multiple_choices% THEN
 5948     s$ =  "<Choices$Write>.Printers" +".Remote.ID"+unique_string$+".PaperRW"
 5949   ELSE
 5950     s$ =  "<Choices$Write>.Printers" +".PaperRW"
 5951   ENDIF
 5952   SYS "XOS_File",17,s$ TO r0%;f%
 5953   IF(f%AND1) !r0%= 254 :SYS"OS_GenerateError",r0%
 5954   IF(r0%=0) THEN
 5955     SYS "XOS_File",11,s$,&FC6,,0,0 TO r0%;f%
 5956     IF(f%AND1) PROCerror_warning(FNmsg_0(A%! 12 ,"WA14")):ENDPROC
 5957   ELSE
 5958     SYS "XOS_File",4,s$,,,,0 TO r0%;f%
 5959     IF(f%AND1)=0 SYS "XOS_File",4,s$,,,,3 TO r0%;f%
 5960     IF(f%AND1) PROCerror_warning(FNmsg_0(A%! 12 ,"WA14")):ENDPROC
 5961   ENDIF
 5962   SYS "XOS_Find",&8F,s$ TO c%;f%
 5963   IF(f%AND1) PROCerror_warning(FNmsg_0(A%! 12 ,"WA14")):ENDPROC
 5964   IF c% THEN
 5965    psize%=psize_head%
 5966    WHILE psize%
 5967     IF psize%! 52 = 1  THEN
 5968       PROCsave_paper_size(c%,psize%)
 5969       count%+=1
 5970     ENDIF
 5971     psize%=psize%! 0 
 5972    ENDWHILE
 5973    SYS "XOS_Find",,c%  
 5974    IF count% THEN
 5975     SYS "XOS_File",18,s$,&FC6
 5976     SYS "XOS_File",4,s$,,,,&13  
 5977    ELSE
 5978     SYS "XOS_File",6,s$
 5979    ENDIF
 5980   ENDIF
 5981 ENDPROC
 5982 DEF PROCsave_value(icon%,block%,offset%,convert%,RETURN flag%)
 5983   LOCAL v,v%
 5984   v=FNlocale_val(FNicon_read(papersize%,icon%))
 5985   CASE icon% OF
 5986     WHEN  8 
 5987       v=FNlocale_val(FNicon_read(papersize%, 7 ))-v
 5988     WHEN  11 
 5989       v=FNlocale_val(FNicon_read(papersize%, 6 ))-v
 5990   ENDCASE
 5991   IF convert% THEN
 5992     IF FNicon_set(papersize%, 23 )v%=v*mm_to_72000 ELSE v%=v*in_to_72000
 5993   ELSE
 5994     v%=v  
 5995   ENDIF
 5996   IF block%!offset%<>v% THEN
 5997     flag%= -1 
 5998     block%!offset%=v%
 5999     IFpsize_edit% psize_edit%!offset%=v%
 6000   ENDIF
 6001 ENDPROC
 6002 DEF PROCdelete_papersize
 6003   LOCAL s$,psize%,last%,i%,prnt%
 6004   SYS "Hourglass_On"
 6005   s$=FNicon_read(papersize%, 5 )
 6006   psize%=psize_head%
 6007   WHILE psize%>0
 6008    IF$psize%! 4 =s$ THEN
 6009     IF psize%! 52 = 1  THEN
 6010      prnt%=A%! 48 
 6011      WHILE prnt%
 6012       IF prnt%! 36 =psize% ERROR  254 ,FNmsg_0(A%! 12 ,"OKQa")
 6013       prnt%=prnt%! 0 
 6014      ENDWHILE
 6015      IF last% THEN
 6016       last%! 0 =psize%! 0 
 6017      ELSE
 6018       psize_head%=psize%! 0 
 6019      ENDIF
 6020      PROCfree_structure(psize%! 4 )
 6021      B%= &455A5350 
 6022      C%=psize%
 6023      CALL code_entry%+ 16 
 6024      PROCsave_user_defined_paper_sizes
 6025     ELSE
 6026      ERROR  254 ,FNmsg_0(A%! 12 ,"OKR")
 6027     ENDIF
 6028     FOR i%= 0  TO  52  STEP 4
 6029       psize_edit%!i%=0
 6030     NEXT
 6031     PROCinitialise_papersize_window
 6032     psize%=-1
 6033    ELSE
 6034     last%=psize%
 6035     psize%=psize%! 0 
 6036    ENDIF
 6037   ENDWHILE
 6038   IF psize%=0 ERROR  254 ,FNmsg_0(A%! 12 ,"OKQ")
 6039   SYS "Hourglass_Off"
 6040 ENDPROC
 6041 DEF PROCopen_queue_window
 6042   PROCtell_pinboard(A%! 40 )
 6043   !task_buff%=A%! 40 
 6044   SYS "Wimp_GetWindowInfo",,task_buff% OR 1
 6045   task_buff%!48=task_buff%!56-(A%! 44 *line_space%*2)-(A%! 32 *line_space%)
 6046   SYS "Wimp_SetExtent",A%! 40 ,task_buff%+44
 6047   task_buff%!28=-1  
 6048   SYS "Wimp_OpenWindow",,task_buff%
 6049 ENDPROC
 6050 DEF PROCredraw_prntctrl_entry(prnt%)
 6051   IF NOT FNwindow_open(prntctrl%) ENDPROC
 6052   !win_buff%=prntctrl%
 6053   win_buff%!4=prnt%! 28 
 6054   SYS "Wimp_GetIconState",,win_buff%
 6055   SYS "Wimp_ForceRedraw",prntctrl%,win_buff%!8,win_buff%!12,win_buff%!16,win_buff%!20
 6056 ENDPROC
 6057 DEF PROCredraw_queue_entry(y%,prnt%,queu%)
 6058   LOCAL more%
 6059   IF NOT FNwindow_open(A%! 40 )ENDPROC
 6060   IF y%=-1 THEN
 6061     B%=prnt%
 6062     C%=queu%
 6063     y%=USR(code_entry%+ 48 )
 6064   ENDIF
 6065   !win_buff%=A%! 40 
 6066   SYS "Wimp_GetWindowState",,win_buff%
 6067   win_buff%!12=win_buff%!12-win_buff%!4
 6068   win_buff%!4=0
 6069   win_buff%!8=y%-line_space%
 6070   win_buff%!16=y%
 6071   SYS "Wimp_ForceRedraw",!win_buff%,win_buff%!4,win_buff%!8,win_buff%!12,win_buff%!16
 6072 ENDPROC
 6073 DEF PROCredraw_queue_block(y%,prnt%,queu1%,queu2%)
 6074   LOCAL count%
 6075   IF NOT FNwindow_open(A%! 40 )ENDPROC
 6076   IF y%=-1 THEN
 6077     B%=prnt%
 6078     C%=queu%
 6079     y%=USR(code_entry%+ 48 )
 6080   ENDIF
 6081   !win_buff%=A%! 40 
 6082   SYS "Wimp_GetWindowState",,win_buff%
 6083   win_buff%!12=win_buff%!12-win_buff%!4
 6084   win_buff%!4=0
 6085   count%=2
 6086   WHILE queu1%<>queu2%
 6087    count%+=1
 6088    queu1%=queu1%! 0 
 6089   ENDWHILE
 6090   win_buff%!8=y%-line_space%*count%
 6091   win_buff%!16=y%
 6092   SYS "Wimp_ForceRedraw",!win_buff%,win_buff%!4,win_buff%!8,win_buff%!12,win_buff%!16
 6093 ENDPROC
 6094 DEF PROCadd_queue_entry(temp_file%,sender$,pathname$,leafname$,prnt%,type%)
 6095   B%=temp_file%
 6096   C%=task_buff%: $C%=sender$
 6097   D%=buff1%: $D%=pathname$
 6098   E%=buff1%+256: $E%=leafname$
 6099   F%=prnt%
 6100   G%=type%
 6101   CALL code_entry%+ 24 
 6102 ENDPROC
 6103 DEF PROCdelete_queue_entry(prnt%,queu%,redraw%)
 6104   LOCAL head%,p%,cnct%
 6105   IF menued_prnt%=prnt% AND menued_queu%=queu% menued_queu%=0:SYS"Wimp_CreateMenu",-1
 6106   p%=queu%! 44 
 6107   IF p% THEN
 6108     IF p%! 40  THEN
 6109       prnt%! 24 =prnt%! 24  AND NOT  36 
 6110       IF prnt%! 48  THEN
 6111         !task_buff%=prnt%! 48 
 6112         PROCclose_window
 6113       ENDIF
 6114     ENDIF
 6115   ENDIF
 6116   IF prnt%! 32 =queu% THEN
 6117     prnt%! 32 =queu%! 0 
 6118     head%=0
 6119   ELSE
 6120     head%=prnt%! 32 
 6121     WHILE head%! 0 <>queu%
 6122       head%=head%! 0 
 6123     ENDWHILE
 6124     head%! 0 =queu%! 0 
 6125   ENDIF
 6126   IF queu%! 12  THEN
 6127     SYS "XOS_Find",,queu%! 12   
 6128     queu%! 12 =0
 6129     prnt%! 24 =prnt%! 24  AND NOT  8 
 6130     PROCprinter_status(prnt%)
 6131     IF NOT prnt%! 28  THEN
 6132       buff1%!0=prntctrl%
 6133       buff1%!4=prnt%! 28 
 6134       buff1%!8=0
 6135       buff1%!12=1<<22
 6136       SYS "Wimp_SetIconState",,buff1%
 6137     ENDIF
 6138   ENDIF
 6139   p%=0
 6140   REPEAT
 6141     SYS "PDriver_EnumerateJobs",p% TO p%
 6142     IF p% IF p%=queu%! 40  OR p%=queu%! 72  SYS "PDriver_AbortJob",p%
 6143   UNTIL p%=0
 6144   IF queu%! 40  THEN
 6145     cnct%=prnt%! 12 
 6146     IF cnct%! 0 =1 OR cnct%! 0 =2 SYS "OS_Byte",21,FNbuffer(cnct%! 0 )
 6147     SYS "XOS_Find",0,queu%! 40   
 6148     queu%! 40 =0
 6149     PROCbuffer_free(cnct%! 0 )
 6150     !task_buff%=queu%
 6151     PROCprinter_reason_code(prnt%! 4 ,prnt%,-7,task_buff%)
 6152   ENDIF
 6153   IF queu%! 72  THEN
 6154     SYS "XOS_Find",,queu%! 72   
 6155     queu%! 72 =0
 6156   ENDIF
 6157   SYS "XOS_File",6,$queu%! 68   
 6158   PROCfree_structure(queu%! 68 )
 6159   IF queu%? 11  AND 2 SYS "XOS_File",6,$queu%! 20 
 6160   PROCfree_structure(queu%! 16 )
 6161   PROCfree_structure(queu%! 20 )
 6162   PROCfree_structure(queu%! 24 )
 6163   p%=queu%! 44 
 6164   IF p% THEN
 6165     PROCfree_structure(p%! 104 )  
 6166     PROCfree_structure(p%! 108 )  
 6167     PROCfree_structure(p%! 112 )  
 6168     PROCfree_structure(p%! 120 )  
 6169     B%= &42555054 
 6170     C%=p%
 6171     CALL code_entry%+ 16 
 6172   ENDIF
 6173   IF queu%! 52  THEN
 6174      B%= &46464254 
 6175      C%=queu%! 52 
 6176      CALL code_entry%+ 16 
 6177   ENDIF
 6178   B%= &55455551 
 6179   C%=queu%
 6180   CALL code_entry%+ 16 
 6181   A%! 32 -=1
 6182   IF A%! 32 <=0 A%! 20 =A%! 20  OR 1  
 6183   IF redraw% THEN
 6184     !task_buff%=A%! 40 
 6185     SYS "Wimp_GetWindowInfo",,task_buff% OR 1
 6186     IF task_buff%!32 AND 1<<16 THEN
 6187       task_buff%!48=task_buff%!56-A%! 44 *line_space%*2-A%! 32 *line_space%
 6188       SYS "Wimp_SetExtent",A%! 40 ,task_buff%+44
 6189       SYS "Wimp_OpenWindow",,task_buff%
 6190       B%=prnt%
 6191       C%=head%
 6192       CALL code_entry%+ 32 
 6193     ENDIF
 6194   ENDIF
 6195 ENDPROC
 6196 DEF PROCflush_queue(prnt%)
 6197   LOCAL queu%,next%
 6198   SYS "Hourglass_On"
 6199   REPEAT
 6200     queu%=prnt%! 32 
 6201     IF queu% PROCdelete_queue_entry(prnt%,queu%, 0 )
 6202   UNTIL queu%=0
 6203   !task_buff%=A%! 40 
 6204   SYS "Wimp_GetWindowInfo",,task_buff% OR 1
 6205   IF task_buff%!32 AND 1<<16 THEN
 6206     task_buff%!48=task_buff%!56-A%! 44 *line_space%*2-A%! 32 *line_space%
 6207     SYS "Wimp_SetExtent",A%! 40 ,task_buff%+44
 6208     SYS "Wimp_OpenWindow",,task_buff%
 6209     B%=prnt%
 6210     C%=0
 6211     CALL code_entry%+ 32 
 6212   ENDIF
 6213   SYS "Hourglass_Off"
 6214 ENDPROC
 6215 DEF PROCdestroy_queue
 6216   LOCAL prnt%
 6217   prnt%=A%! 48 
 6218   WHILE prnt%
 6219     PROCflush_queue(prnt%)
 6220     prnt%=prnt%! 0 
 6221   ENDWHILE
 6222   A%! 32 =0
 6223 ENDPROC
 6224 DEF PROCprocess_queue
 6225   LOCAL last_queu%,j%,prnt%,queu%
 6226   REPEAT
 6227     IF A%! 24        A%! 24 =          !(A%! 24 + 0 )
 6228     IF A%! 24 =0       A%! 24 =A%! 48 
 6229   UNTIL A%! 24 
 6230   prnt%=A%! 24 
 6231   IF(prnt%! 24  AND  4 )=0 THEN
 6232     A%! 28 =prnt%! 32 
 6233     last_queu%=0
 6234     WHILE A%! 28 
 6235       IF ?(A%! 28 + 11 )AND 1 THEN
 6236         A%! 28 =0
 6237       ELSE
 6238         IF ?(A%! 28 + 11 )AND 4 THEN
 6239           last_queu%=A%! 28 
 6240           A%! 28 =!(A%! 28 + 0 )
 6241         ELSE
 6242           IF !(A%! 28 + 12 )THEN
 6243             PROCprint_file(prnt%,A%! 28 )
 6244           ELSE
 6245             IF(prnt%! 24  AND  32 )=0 THEN
 6246               IF A%! 28 <>prnt%! 32  THEN
 6247                 IF last_queu% last_queu%! 0 =                    !(A%! 28 + 0 )
 6248                 !(A%! 28 + 0 )=                    prnt%! 32 
 6249                 prnt%! 32 =A%! 28 
 6250                 PROCredraw_queue_block(-1,prnt%,                    A%! 28 ,last_queu%)
 6251               ENDIF
 6252               IF prnt_edit%=prnt% THEN
 6253                 !task_buff%=connections%
 6254                 PROCclose_window
 6255               ENDIF
 6256               j%=prnt%! 4 
 6257               j%=j%! 20 
 6258               WHILE j%
 6259                 IF $(j%+ 16 )="configure" THEN
 6260                   IF j%! 12 =prnt% THEN
 6261                     !task_buff%=j%! 4 
 6262                     PROCclose_window
 6263                   ENDIF
 6264                 ENDIF
 6265                 j%=j%! 0 
 6266               ENDWHILE
 6267               PROCprint_file(prnt%,A%! 28 )
 6268             ENDIF
 6269           ENDIF
 6270           A%! 28 =0
 6271         ENDIF
 6272       ENDIF
 6273     ENDWHILE
 6274   ENDIF
 6275   A%! 32 =0
 6276   prnt%=A%! 48 
 6277   WHILE prnt%
 6278     queu%=prnt%! 32 
 6279     WHILE queu%
 6280       A%! 32 +=1
 6281       queu%=queu%! 0 
 6282     ENDWHILE
 6283     prnt%=prnt%! 0 
 6284   ENDWHILE
 6285   IF A%! 32 =0     A%! 20 =A%! 20  OR 1
 6286 ENDPROC
 6287 DEF FNcheck_type(queu%,output_type%,RETURN alias$)
 6288   LOCAL type$,i%,name$,psup%
 6289   alias$=""
 6290   type$=RIGHT$("00"+STR$~queu%! 36 ,3)
 6291   SYS "XOS_ReadVarVal","Alias$@PrintType_"+type$,,-1 TO,,i%
 6292   IF i%<0 alias$="@PrintType_"+type$: = -1 
 6293   CASE queu%! 36  OF
 6294     WHEN -1  
 6295       name$=FNmsg_0(A%! 12 ,"UNT")
 6296     WHEN &2000  
 6297       PROCerror_box(FNmsg_0(A%! 12 ,"OKT"),1)
 6298       = 0 
 6299     WHEN &1000  
 6300       PROCerror_box(FNmsg_0(A%! 12 ,"OKS"),1)
 6301       = 0 
 6302     WHEN &FFF,&AF8  
 6303       queu%! 36 =&FFF
 6304       = -1 
 6305     WHEN &FD6,&FD7,&FEA,&FEB,&FFE  
 6306       queu%! 36 =&FFE
 6307       = -1 
 6308     WHEN output_type%
 6309       queu%! 36 =output_type%
 6310       = -1 
 6311     OTHERWISE
 6312       name$=FNtask_read_env("File$Type_"+type$,task_buff%)
 6313       IF name$=""         name$=FNmsg_1(A%! 12 ,"TYP",type$)
 6314   ENDCASE
 6315   CASE FNpicktype(name$,queu%)OF
 6316     WHEN  4 
 6317       queu%! 36 =&FFE
 6318       = -1 
 6319     WHEN  2 
 6320       queu%! 36 =&FFF
 6321       = -1 
 6322   ENDCASE
 6323 = 0 
 6324 DEF FNpicktype(name$,queu%)
 6325   LOCAL x%,y%,w%,h%
 6326   PROCicon_write(howquery%, 0 ,      FNmsg_2(A%! 12 ,"WA5",name$,      $queu%! 24 ))
 6327   SYS "Wimp_GetPointerInfo",,task_buff%
 6328   x%=!task_buff%
 6329   y%=task_buff%!4
 6330   !task_buff%=howquery%
 6331   SYS "Wimp_GetWindowState",,task_buff%
 6332   w%=task_buff%!12-task_buff%!4
 6333   h%=task_buff%!16-task_buff%!8
 6334   task_buff%!4=x%-340  
 6335   task_buff%!8=y%-120  
 6336   task_buff%!12=task_buff%!4+w%
 6337   task_buff%!16=task_buff%!8+h%
 6338   task_buff%!28=-1
 6339   SYS "Wimp_OpenWindow",,task_buff%
 6340   PROCbound_mouse(howquery%)
 6341   query_state%=0
 6342   REPEAT
 6343     PROCdespatch_poll(click_mask%)
 6344   UNTIL query_state%
 6345   !task_buff%=howquery%
 6346   PROCclose_window
 6347   PROCunbound_mouse
 6348 =query_state%
 6349 DEF PROCappend_file_tidyup(in%,out%,out_size%,in$)
 6350   IFin% SYS"XOS_Find",0,in%
 6351   IFout% EXT#out%=out_size%
 6352   IFout% SYS"XOS_Find",0,out%
 6353   SYS"XOS_File",6,in$
 6354 ENDPROC
 6355 DEF PROCappend_file(out$,in$)
 6356   LOCAL in_f%,out_f%,in_size%,out_size%,i%
 6357   LOCAL ERROR
 6358   ON ERROR LOCAL RESTORE ERROR:PROCappend_file_tidyup(in_f%,out_f%,out_size%,in$):    PROCerror_box(REPORT$, 1):ENDPROC
 6359   in_f%=OPENIN in$
 6360   in_size%=EXT#in_f%
 6361   IF in_size% THEN
 6362     SYS"Hourglass_On"
 6363     out_f%=OPENUP out$
 6364     out_size%=EXT#out_f%  
 6365     PTR#out_f%=out_size%
 6366     FOR i%=1 TO in_size% DIV 512
 6367       SYS "OS_GBPB",4,in_f%,buff1%,512  
 6368       SYS "OS_GBPB",2,out_f%,buff1%,512  
 6369     NEXT
 6370     IF in_size% MOD 512       SYS "OS_GBPB",4,in_f%,buff1%,in_size% MOD 512  :       SYS "OS_GBPB",2,out_f%,buff1%,in_size% MOD 512  
 6371     CLOSE#out_f%
 6372     SYS"Hourglass_Off"
 6373   ENDIF
 6374   CLOSE#in_f%
 6375   SYS "OS_File",6,in$  
 6376 ENDPROC
 6377 DEF PROCprint_file(prnt%,queu%)
 6378   LOCAL psup%,cnct%,pr_type%,b%,t%,file$,t$,alias$,load%,size%,    finished%,s%,spooling%,ptmp$,check_type%,spool_file$
 6379   LOCAL application$, leafname$, lpsup%, l%, f%
 6380   psup%=prnt%! 4 
 6381   cnct%=prnt%! 12 
 6382   pr_type%=psup%! 28 
 6383   IF queu%! 12 =0 THEN
 6384     PROCselect_printer(prnt%, 0 , 0 )
 6385     IF (prnt%! 24  AND  4 )<>0 ENDPROC
 6386     file$=$queu%! 20 
 6387     last_application$ = $queu%! 16 
 6388     last_leafname$    = $queu%! 24 
 6389     IF cnct%! 0 =5 THEN
 6390       spooling%=(cnct%? 6  AND  2 )<>0
 6391     ELSE
 6392       spooling%=(cnct%? 6  AND  1 )<>0
 6393     ENDIF
 6394     IF spooling% THEN
 6395       printer_output$=FNtemporary_name( 0 )
 6396       IFprinter_output$="" THEN
 6397         prnt%! 24  = prnt%! 24  OR  4 
 6398         PROCprinter_status(prnt%)
 6399         PROCredraw_queue_entry(-1,prnt%,0)
 6400         ENDPROC
 6401       ENDIF
 6402       IFcnct%! 0 =5 THEN
 6403        SYS "OS_SetVarVal","PrinterType$5",printer_output$,LEN printer_output$
 6404        PROCfx5(5)
 6405       ELSE
 6406        SYS "OS_SetVarVal","PrinterType$10",printer_output$,LEN printer_output$
 6407        PROCfx5(10)
 6408       ENDIF
 6409       spool_file$=printer_output$
 6410     ENDIF
 6411     ptmp$=FNtemporary_name( 0 )
 6412     IFptmp$="" THEN
 6413       prnt%! 24  = prnt%! 24  OR  4 
 6414       PROCprinter_status(prnt%)
 6415       PROCredraw_queue_entry(-1,prnt%,0)
 6416       ENDPROC
 6417     ENDIF
 6418     SYS "OS_SetVarVal","Printer$Temp",ptmp$,LEN ptmp$
 6419     task_buff%!0=48+LEN file$ AND NOT 3
 6420     task_buff%!12=0
 6421     task_buff%!16=&80145  
 6422     task_buff%!40=queu%! 36 
 6423     $(task_buff%+44)=file$+CHR$ 0
 6424     SYS "Wimp_SendMessage",18,task_buff%
 6425     type_state%=0
 6426     REPEAT
 6427       PROCdespatch_poll(message_mask%)
 6428     UNTIL type_state%
 6429     b%= -1 
 6430     IF type_state%<>2 THEN
 6431       b%=FNcheck_type(queu%,pr_type%,alias$)
 6432       IF b% THEN
 6433         IF alias$<>"" THEN
 6434           SYS "Wimp_StartTask",alias$+" "+file$
 6435         ENDIF
 6436       ENDIF
 6437     ENDIF
 6438     IF NOTb% THEN
 6439       PROCdelete_queue_entry(prnt%,queu%, -1 )
 6440       ENDPROC
 6441     ENDIF
 6442     IF spooling% THEN
 6443       s$=FNselect_connection(prnt%, -1 )
 6444       IF s$<>"" THEN
 6445         PROCerror_warning(s$)
 6446         IF prnt%! 32  THEN
 6447           prnt%! 24  = prnt%! 24  OR  4 
 6448           PROCprinter_status(prnt%)
 6449           PROCredraw_queue_entry(-1,prnt%,0)
 6450         ENDIF
 6451       ENDIF
 6452     ENDIF
 6453     IF NOT(queu%! 36 =&FFF OR queu%! 36 =&FFE OR         queu%! 36 =pr_type%)THEN
 6454       SYS "OS_File",17,ptmp$ TO t%,,load%,,size%  
 6455       IF t% THEN
 6456         IF queu%? 11  AND 2 THEN
 6457           IF file_to_delete$<>"" SYS "XOS_File",6,file_to_delete$  
 6458           file_to_delete$=$queu%! 20 
 6459         ENDIF
 6460         PROCfree_structure(queu%! 20 )
 6461         $task_buff%=ptmp$
 6462         B%=task_buff%
 6463         C%=2
 6464         queu%! 20 =USR(code_entry%+ 28 )
 6465         queu%! 28 =size%
 6466         queu%! 36 =(load% AND &FFF00)>>8
 6467         queu%? 11 =queu%? 11  OR 2
 6468       ELSE
 6469         IF spooling% THEN
 6470           IF cnct%! 0 =5 THEN
 6471             PROCappend_file($cnct%! 16 ,spool_file$)
 6472             PROCdelete_queue_entry(prnt%,queu%, -1 )
 6473           ELSE
 6474             SYS "OS_File",17,spool_file$ TO b%,,,,size%  
 6475             IF b%=0 OR size%=0 THEN
 6476               REM nothing to print - remove the entry and the spool file
 6477               SYS"XOS_File",6,spool_file$
 6478               PROCdelete_queue_entry(prnt%,queu%, -1 )
 6479             ELSE
 6480               IF (queu%? 11  AND 2)                 SYS"XOS_File",6,$queu%! 20 
 6481               PROCfree_structure(queu%! 20 )
 6482               $task_buff%=spool_file$
 6483               B%=task_buff%
 6484               C%=2
 6485               queu%! 20 =USR(code_entry%+ 28 )
 6486               queu%! 28 =size%
 6487               queu%! 36 =pr_type%
 6488               queu%? 11 =queu%? 11  OR 2
 6489             ENDIF
 6490           ENDIF
 6491         ELSE
 6492           application$ = $queu%! 16 
 6493           leafname$    = $queu%! 24 
 6494           PROCdelete_queue_entry(prnt%,queu%, -1 )
 6495           IF cnct%! 0  = 9 AND printer_prefix$ <> "" THEN
 6496             name$ = $(prnt%! 40 )
 6497             ptr% = INSTR(name$, " ")  
 6498             WHILE ptr%
 6499               MID$(name$,ptr%,1) = CHR$160
 6500               ptr% = INSTR(name$, " ", ptr%+1)
 6501             ENDWHILE
 6502             sname$ = printer_prefix$+"RemSpool."+unique_string$+"."+name$
 6503             qname$ = printer_prefix$+"RemQueue."+unique_string$+"."+STR$(remote_jobno%)
 6504             SYS "XOS_File", 17, sname$ TO t%,,,,l% ; f%
 6505             IF (l% > 0) AND ((f% AND 1) = 0) AND (t% = 1) THEN
 6506               IF FNwrite_information_file (prnt%, application$, leafname$) THEN
 6507                 lpsup% = selected_prnt%! 4 
 6508                 SYS "XOS_FSControl", 25, sname$, qname$  
 6509               ELSE
 6510                 SYS "XOS_File", 6, sname$
 6511               ENDIF
 6512               last_application$ = ""
 6513               last_leafname$ = ""
 6514               s$=FNselect_connection(prnt%, -1 )
 6515               IF s$<>"" THEN
 6516                 PROCerror_warning(s$)
 6517               ENDIF
 6518             ENDIF
 6519           ENDIF
 6520           PROCselect_printer(0, -1 , -1 )
 6521         ENDIF
 6522       ENDIF
 6523     ELSE
 6524       CASE cnct%! 0  OF
 6525         WHEN 1
 6526           IFprnt%! 24  AND  128  THEN
 6527             printer_output$="devices#buffer"+STR$FNbuffer_ensure(1)+":$."+FNsupport_fast_parallel
 6528           ELSE
 6529             printer_output$="devices#buffer"+STR$ FNbuffer_ensure(1)+":$.Parallel"
 6530           ENDIF
 6531           SYS "OS_SetVarVal","PrinterType$1",printer_output$,LEN printer_output$
 6532         WHEN 2
 6533           printer_output$="devices#buffer"+STR$ FNbuffer_ensure(2)+              ":$.Serial"
 6534           SYS "OS_SetVarVal","PrinterType$2",printer_output$,              LEN printer_output$
 6535       ENDCASE
 6536       SYS "Hourglass_On"
 6537       IF cnct%! 0 =5 AND (cnct%? 6  AND  2 )<>0 THEN
 6538         SYS "XOS_Find",&CF,printer_output$ TO b%;t%  
 6539         IF(t% AND 1)=0 PTR#b%=EXT#b%  
 6540       ELSE
 6541         SYS "XOS_Find",&8F,printer_output$ TO b%;t%  
 6542       ENDIF
 6543       IF t% AND 1 i%=b%+4: CALL Z%,i%,t$  
 6544       SYS "Hourglass_Off"
 6545       PROCselect_printer(0, -1 , -1 )
 6546       IF t% AND 1 THEN
 6547         PROCpause_printer(prnt%)
 6548         PROCbuffer_free(cnct%! 0 )
 6549         ERROR  254 ,FNmsg_1(A%! 12 ,"OKP",t$)
 6550       ENDIF
 6551       queu%! 40 =b%
 6552       SYS"XOS_Find",&40,$queu%! 20  TO queu%! 12 ;t%
 6553       IF(t%AND1) queu%! 12  = 0
 6554       IF queu%! 12 =0 THEN
 6555         PROCdelete_queue_entry(prnt%,queu%, -1 )
 6556         ERROR  254 ,FNmsg_1(A%! 12 ,            "OKAF",$queu%! 20 )
 6557       ENDIF
 6558       t$=FNtemporary_name( 0 )
 6559       IFt$="" THEN
 6560         prnt%! 24  = prnt%! 24  OR  4 
 6561         PROCprinter_status(prnt%)
 6562         PROCredraw_queue_entry(-1,prnt%,0)
 6563         ENDPROC
 6564       ENDIF
 6565       SYS "XOS_File",11,t$,&FFD TO b%;t%  
 6566       IF(t% AND 1)=0 SYS "XOS_Find",&CF,t$ TO b%;t%  
 6567       IF t% AND 1 THEN
 6568         PROCpause_printer(prnt%)
 6569         b%+=4
 6570         CALL Z%,b%,s$  
 6571         ERROR  254 ,FNmsg_1(A%! 12 ,"OKP",s$)
 6572       ENDIF
 6573       queu%! 72 =b%
 6574       $task_buff%=t$
 6575       B%=task_buff%
 6576       C%=2
 6577       queu%! 68 =          USR(code_entry%+ 28 )
 6578       B%= &46464254 
 6579       C%= 1024 
 6580       s%=USR(code_entry%+ 12 )
 6581       IF s%=0 ERROR  253 ,          FNmsg_1(A%! 12 ,"FA5","TBFF")
 6582       queu%! 52 =s%
 6583       prnt%! 24 =prnt%! 24  OR  8 
 6584       PROCprinter_status(prnt%)
 6585       PROCredraw_queue_entry(-1,prnt%,0)
 6586       IF queu%! 36 <>pr_type% THEN
 6587         IF prnt%! 24  AND  64  THEN
 6588           PROCdelete_queue_entry(prnt%,queu%, -1 )
 6589           IF prnt%! 40 =0             s$=$prnt%! 8            ELSE             s$=$prnt%! 40 
 6590           ERROR  254 ,              FNmsg_1(A%! 12 ,"OKAC",s$)
 6591         ENDIF
 6592         PROCstart_job(queu%,pr_type%)
 6593       ENDIF
 6594     ENDIF
 6595   ELSE
 6596     IF EOF#queu%! 12  AND queu%! 56 =0 THEN
 6597       t%=EXT#queu%! 72 -          PTR#queu%! 72 
 6598       IF t% THEN
 6599         IF cnct%! 0 =1 OR cnct%! 0 =2 THEN
 6600           SYS "OS_Byte",128,NOT FNbuffer(cnct%! 0 )TO              ,size%,load%
 6601           size%=size% OR load%<<8
 6602           IF size%> 1024  size%= 1024 
 6603         ELSE
 6604           size%=  1024 /2 
 6605         ENDIF
 6606         PROCprocess_scratch_file(queu%,t%,size%)
 6607         ENDPROC
 6608       ENDIF
 6609       finished%= -1 
 6610       IF cnct%! 0 =1 OR cnct%! 0 =2 THEN
 6611         SYS "OS_Byte",152,FNbuffer(cnct%! 0 )TO;b%
 6612         IF(b% AND 2)=0 finished%= 0 
 6613       ENDIF
 6614       IF finished% THEN
 6615         PROCprinter_status(prnt%)
 6616         application$ = $queu%! 16 
 6617         leafname$    = $queu%! 24 
 6618         PROCdelete_queue_entry(prnt%,queu%, -1 )
 6619         IF cnct%! 0  = 9 AND printer_prefix$ <> "" THEN
 6620           name$ = $(prnt%! 40 )
 6621           ptr% = INSTR(name$, " ")  
 6622           WHILE ptr%
 6623             MID$(name$,ptr%,1) = CHR$160
 6624             ptr% = INSTR(name$, " ", ptr%+1)
 6625           ENDWHILE
 6626           sname$ = printer_prefix$+"RemSpool."+unique_string$+"."+name$
 6627           qname$ = printer_prefix$+"RemQueue."+unique_string$+"."+STR$(remote_jobno%)
 6628           IF FNwrite_information_file (prnt%, application$, leafname$) THEN
 6629            lpsup% = selected_prnt%! 4 
 6630            SYS "XOS_FSControl", 25, sname$, qname$
 6631           ELSE
 6632            SYS "XOS_File", 6, sname$
 6633           ENDIF
 6634           s$=FNselect_connection(prnt%, -1 )
 6635           IF s$<>"" THEN
 6636             PROCerror_warning(s$)
 6637           ENDIF
 6638         ENDIF
 6639       ENDIF
 6640     ELSE
 6641       PROCjob_chunk(prnt%,queu%,pr_type%)
 6642     ENDIF
 6643   ENDIF
 6644 ENDPROC
 6645 DEF PROCstart_job(queu%,output_type%)
 6646   LOCAL i%,p%,name$
 6647   LOCAL ERROR
 6648   ON ERROR LOCAL RESTORE ERROR: PROCjob_chunk_error(A%! 24 ,A%! 28 )
 6649   B%= &42555054 
 6650   C%= 124 
 6651   p%=USR(code_entry%+ 12 )
 6652   IF p%=0 ERROR  253 ,FNmsg_1(A%! 12 ,"FA5","TPUB")
 6653   queu%! 44 =p%
 6654   IF 0<= 124 -4
 6655     FOR i%=0 TO  124 -4 STEP 4
 6656       p%!i%=0
 6657     NEXT
 6658   ENDIF
 6659   ?buff1%=3
 6660   SYS "OS_Word",14,buff1%
 6661   SYS "OS_ConvertStandardDateAndTime",buff1%,buff1%+5,250
 6662   B%=buff1%+5
 6663   C%=2
 6664   p%! 120 =USR(code_entry%+ 28 )
 6665   IF queu%? 11  AND 2 THEN
 6666     name$=$queu%! 16 +" - "+$queu%! 24 
 6667   ELSE
 6668     name$=$queu%! 20 
 6669     IF LEN name$>40 THEN
 6670       name$=RIGHT$(name$,40)
 6671       name$=MID$(name$,1+INSTR(name$,"."))
 6672     ENDIF
 6673   ENDIF
 6674   $task_buff%=name$
 6675   B%=task_buff%
 6676   C%=2
 6677   p%! 112 =USR(code_entry%+ 28 )
 6678   p%! 16 =1  
 6679   $task_buff%=STRING$(32," ")
 6680   B%=task_buff%
 6681   C%=5
 6682   D%=32
 6683   p%! 104 =USR(code_entry%+ 28 )  
 6684   p%! 96 =&80
 6685   PROCtext_printer_code(A%! 24 ,A%! 28 ,-1)
 6686 ENDPROC
 6687 DEF PROCjob_chunk_error(prnt%,queu%)
 6688   PROCdelete_queue_entry(prnt%,queu%, -1 )
 6689   IF prnt%! 32 <>0 THEN
 6690     prnt%! 24  = prnt%! 24  OR  32 
 6691     PROCprinter_status(prnt%)
 6692   ENDIF
 6693   ERROR  254 ,FNmsg_1(A%! 12 ,"OKPa",REPORT$)
 6694 ENDPROC
 6695 DEF PROCjob_chunk(prnt%,queu%,output_type%)
 6696   LOCAL l%,t%,new_perc%,len%,b$,p%,tpub%,cnct%,text%,psup%
 6697   LOCAL ERROR
 6698   ON ERROR LOCAL RESTORE ERROR: PROCjob_chunk_error(prnt%,queu%)
 6699   cnct%=prnt%! 12 
 6700   psup%=prnt%! 4 
 6701   tpub%=queu%! 44 
 6702   IF cnct%! 0 =1 OR cnct%! 0 =2 THEN
 6703     SYS "OS_Byte",128,NOT FNbuffer(cnct%! 0 )TO,len%,l%
 6704     len%=len% OR l%<<8
 6705     IF len%> 1024  len%= 1024 
 6706   ELSE
 6707     len%=  1024 /2 
 6708   ENDIF
 6709   l%=EXT#queu%! 72 -PTR#queu%! 72 
 6710   IF queu%! 56  l%=0
 6711   IF l% PROCprocess_scratch_file(queu%,l%,len%): ENDPROC
 6712   SYS "Hourglass_On"
 6713   l%=queu%! 28 -PTR#queu%! 12 
 6714   IF queu%! 36 =output_type% THEN
 6715     IF PTR#(queu%! 12 )=0 THEN
 6716       task_buff%!8=queu%! 40 
 6717       task_buff%!12=queu%! 12 
 6718       PROCtext_printer_code(prnt%,queu%,-20)
 6719     ENDIF
 6720     IF l%>len% l%=len%
 6721     SYS "OS_GBPB",4,queu%! 12 ,task_buff%,l%  
 6722     SYS "OS_GBPB",2,queu%! 40 ,task_buff%,l%  
 6723   ELSE
 6724     IF queu%! 36 =&FFF OR (psup%! 32  AND 1)<>0 THEN
 6725       CASE tpub%! 92  OF
 6726         WHEN 0
 6727           task_buff%!8=queu%! 72 
 6728           PROCtext_printer_code(prnt%,queu%,-2)
 6729           queu%! 32 =-1
 6730           tpub%! 92 =1
 6731         WHEN 1
 6732           task_buff%!8=queu%! 72 
 6733           PROCtext_printer_code(prnt%,queu%,-3)
 6734           queu%! 32 =0
 6735           tpub%! 92 =2
 6736         WHEN 2
 6737           IF psup%! 32  AND 2 THEN
 6738             IF queu%! 56 =0 THEN
 6739               PROCtext_trans(0)
 6740               task_buff%!8=queu%! 56 
 6741               PROCprinter_buffer(queu%,FNtext_printer_string(prnt%,queu%,-4))
 6742               PROCoutput_buffer(prnt%,queu%,len%)
 6743               IF tpub%! 92 =3 THEN
 6744                 task_buff%!8=queu%! 72 
 6745                 PROCtext_printer_code(prnt%,queu%,-14)
 6746                 tpub%! 92 =1
 6747               ENDIF
 6748             ELSE
 6749               PROCoutput_buffer(prnt%,queu%,len%)
 6750             ENDIF
 6751           ELSE
 6752             IF queu%! 56 =0 THEN
 6753               t%=  1024 /4 
 6754               IF t%>len% t%=len%
 6755               queu%! 60 =0
 6756               PROCtext_trans(t%)
 6757               IF tpub%! 40  THEN
 6758                 PROCpause_printer(prnt%)
 6759                 PROCopen_pause_window(prnt%)
 6760                 p%=tpub%! 40 
 6761               ENDIF
 6762             ENDIF
 6763             IF len%>queu%! 56  len%=queu%! 56 
 6764             IF tpub%! 40 <>0 AND len%>p% len%=p%
 6765             IF len%               SYS "OS_GBPB",2,queu%! 40 ,                  queu%! 52 +queu%! 60 ,len%
 6766             queu%! 56 -=len%
 6767             queu%! 60 +=len%
 6768           ENDIF
 6769       ENDCASE
 6770     ELSE
 6771       t%=LEN FNprinter_read_string(tpub%! 108 )
 6772       WHILE l% AND len%>t%
 6773         b$=FNtext_plain(BGET#queu%! 12 ,tpub%)
 6774         l%-=1
 6775         IF b$<>"" BPUT#queu%! 40 ,b$;
 6776         len%-=LEN b$
 6777       ENDWHILE
 6778     ENDIF
 6779   ENDIF
 6780   IF EOF#queu%! 12  AND queu%! 56 =0 THEN
 6781     task_buff%!8=queu%! 72 
 6782     PROCtext_printer_code(A%! 24 ,        A%! 28 ,-15)
 6783   ENDIF
 6784   IF queu%! 28 =0     new_perc%=0   ELSE     new_perc%=PTR#queu%! 12 *100/queu%! 28 
 6785   IF new_perc%<>queu%! 32  THEN
 6786     queu%! 32 =new_perc%
 6787     PROCredraw_queue_entry(-1,prnt%,queu%)
 6788   ENDIF
 6789   PTR#queu%! 72 =0
 6790   SYS "Hourglass_Off"
 6791 ENDPROC
 6792 DEF PROCprocess_scratch_file(queu%,to_do%,len%)
 6793   IF to_do%>len% to_do%=len%
 6794   SYS "OS_GBPB",4,queu%! 72 ,task_buff%,to_do%  
 6795   SYS "OS_GBPB",2,queu%! 40 ,task_buff%,to_do%  
 6796   IF EXT#queu%! 72 -PTR#queu%! 72 =0 THEN
 6797     PTR#queu%! 72 =0
 6798     EXT#queu%! 72 =0
 6799   ENDIF
 6800 ENDPROC
 6801 DEF FNtext_plain(C%,tpub%)
 6802   LOCAL r$
 6803   IF C%=10 OR C%=13 THEN
 6804     IF tpub%! 16 =1 OR tpub%! 16 =C%       r$=FNprinter_read_string(tpub%! 108 )
 6805     tpub%! 16 =C%
 6806   ELSE
 6807     IF tpub%! 16  r$=FNprinter_read_string(tpub%! 108 )
 6808     r$+=CHR$ C%
 6809     tpub%! 16 =0
 6810   ENDIF
 6811 =r$
 6812 DEF PROCprinter_buffer(queu%,s$)
 6813   LOCAL prbff_ptr%,prbff%
 6814   prbff%=queu%! 52 
 6815   prbff_ptr%=queu%! 56 
 6816   IF s$<>"" THEN
 6817     $(prbff%+prbff_ptr%)=s$
 6818     queu%! 56 +=LEN s$
 6819   ENDIF
 6820 ENDPROC
 6821 DEF PROCoutput_buffer(prnt%,queu%,len%)
 6822   LOCAL prbff_ptr%,prbff%
 6823   prbff%=queu%! 52 
 6824   prbff_ptr%=queu%! 56 
 6825   IF prbff_ptr% THEN
 6826     IF cnct%! 0 =1 OR cnct%! 0 =2 THEN
 6827       IF prbff_ptr%>=len% ENDPROC
 6828     ENDIF
 6829     prbff%?prbff_ptr%=10
 6830     prbff_ptr%+=1
 6831     prbff%?prbff_ptr%=13
 6832     SYS "OS_GBPB",2,queu%! 40 ,prbff%,prbff_ptr%  
 6833     queu%! 56 =0
 6834   ENDIF
 6835 ENDPROC
 6836 DEF PROCtext_printer_code(prnt%,queu%,code%)
 6837   task_buff%!0=code%
 6838   task_buff%!4=queu%
 6839   PROCprinter_reason_code(prnt%! 4 ,prnt%,-8,task_buff%)
 6840 ENDPROC
 6841 DEF FNtext_printer_string(prnt%,queu%,code%)
 6842   LOCAL s$,i%
 6843   task_buff%!0=code%
 6844   task_buff%!4=queu%
 6845   PROCprinter_reason_code(prnt%! 4 ,prnt%,-8,task_buff%)
 6846   i%=task_buff%+8
 6847   CALL Y%,i%,s$  
 6848 =s$
 6849 DEF PROCtext_trans(F%)
 6850   LOCAL psup%
 6851   psup%=prnt%! 4 
 6852   B%=psup%
 6853   C%=queu%
 6854   D%=tpub%
 6855   E%=buff1%+128
 6856   E%!0=psup%
 6857   E%!4=prnt%
 6858   E%!8=queu%
 6859   E%!12=tpub%
 6860   E%!16=task_buff%
 6861   E%!20=buff1%+356
 6862   $(buff1%+356)=CHR$ &A4+$psup%! 4 +"_support("+STR$ buff1%+")"
 6863   buff1%!0=-8
 6864   buff1%!4=psup%
 6865   buff1%!8=prnt%
 6866   buff1%!12=task_buff%
 6867   buff1%!16=psize_head%
 6868   buff1%!20=code_entry%
 6869   buff1%!24=F%
 6870   IF F%=0 CALL code_entry%+ 4  ELSE CALL code_entry%+ 0 
 6871 ENDPROC
 6872 DEF FNbuffer_ensure(t%)
 6873   CASE t% OF
 6874     WHEN 1
 6875       IF A%! 80 =0 THEN
 6876         IF A%! 76 <>3 THEN
 6877           A%! 80 =3
 6878         ELSE
 6879           A%! 80 =10
 6880         ENDIF
 6881       ENDIF
 6882       =A%! 80 
 6883     WHEN 2
 6884       IF A%! 76 =0 THEN
 6885         IF A%! 80 <>3 THEN
 6886           A%! 76 =3
 6887         ELSE
 6888           A%! 76 =2
 6889         ENDIF
 6890       ENDIF
 6891       =A%! 76 
 6892   ENDCASE
 6893 =0
 6894 DEF PROCbuffer_free(t%)
 6895   CASE t% OF
 6896     WHEN 1
 6897       A%! 80 =0
 6898     WHEN 2
 6899       A%! 76 =0
 6900   ENDCASE
 6901 ENDPROC
 6902 DEF FNbuffer(t%)
 6903   CASE t% OF
 6904     WHEN 1
 6905       =A%! 80 
 6906     WHEN 2
 6907       =A%! 76 
 6908   ENDCASE
 6909 =0
 6910 DEF FNsupport_higher_baudrates
 6911 LOCAL r0%,r1%
 6912 SYS"OS_ReadSysInfo",3 TO r0%,r1%
 6913 REM if bits 12-15 of R0 = 1 and bits 12-15 of R1 = 1 then yes we do
 6914 IF(r0%AND61440)=4096 AND (r1%AND61440)=4096 := -1 
 6915 = 0 
 6916 DEF FNsupport_fast_parallel
 6917 LOCAL r0%
 6918 SYS"OS_File",5,"Devices:FastParallel" TO r0%
 6919 IFr0%<>0 THEN
 6920  := "FastParallel"
 6921 ELSE
 6922  := "Parallel"
 6923 ENDIF
 6924 DEF FNrmload_latest_module(name$, path$)
 6925 LOCAL ram_version%, rom_version%, disc_version%
 6926 LOCAL ptr%,f%,r1%,r2%,r6%,s$,rom_state%
 6927 ram_version%=-1
 6928 SYS"XOS_Module",18,name$ TO ,,,ptr%;f%
 6929 IF(f%AND1)=0 AND ptr%!&14<>0 THEN
 6930  ptr%+=(ptr%!&14)
 6931  WHILE ?ptr%<>9 AND ?ptr%<>0
 6932   ptr%+=1
 6933  ENDWHILE
 6934  IF?ptr%<>0 THEN
 6935   ram_version%=0:ptr%+=1
 6936   WHILE ?ptr%<>32
 6937    IF?ptr%>=ASC"0" AND ?ptr%<=ASC"9" THEN
 6938     ram_version%=ram_version%*10+?ptr%-ASC"0"
 6939    ENDIF
 6940    ptr%+=1
 6941   ENDWHILE
 6942  ENDIF
 6943 ENDIF
 6944 rom_version%=-1
 6945 r1%=0:r2%=-1
 6946 REPEAT
 6947  SYS"XOS_Module",20,r1%,r2% TO ,r1%,r2%,ptr%,rom_state%,,r6%;f%
 6948  IF(f%AND1)=0 THEN
 6949   CALL Z%,ptr%,s$
 6950   IFs$=name$ rom_version%=VAL(STR$~(r6%))/100
 6951  ENDIF
 6952 UNTIL (rom_version%<>-1) OR (f%AND1)<>0
 6953 disc_version%=-1
 6954 SYS"XOS_Find",&43,path$ TO f%;ptr%
 6955 IF(ptr%AND1) f%=0
 6956 IFf%<>0 THEN
 6957  PTR#f%=&14:ptr%=BGET#f%+((BGET#f%)<<8)+((BGET#f%)<<16)+((BGET#f%)<<24)
 6958  IFptr%<>0 THEN
 6959   PTR#f%=ptr%
 6960   REM find the start of the version number
 6961   REPEAT
 6962    r1%=BGET#f%
 6963   UNTIL r1%=0 OR r1%=9
 6964   IFr1%<>0 THEN
 6965    disc_version%=0
 6966    REPEAT
 6967     r1%=BGET#f%
 6968     IFr1%>=ASC"0" AND r1%<=ASC"9" THEN
 6969      disc_version%=disc_version%*10+r1%-ASC"0"
 6970     ENDIF
 6971    UNTIL r1%=32
 6972   ENDIF
 6973  ENDIF
 6974  CLOSE#f%
 6975 ENDIF
 6976 IFram_version%>rom_version% r1%=ram_version% ELSE r1%=rom_version%
 6977 IFr1%>disc_version% f%=r1% ELSE f%=disc_version%
 6978 r1%=0
 6979 IFrom_version%=f% THEN
 6980  IFrom_state%<1 THEN
 6981   SYS"XOS_Module",4  , name$
 6982   SYS"XOS_Module",3  , name$ TO ptr%;r1%
 6983  ENDIF
 6984 ENDIF
 6985 IFdisc_version%=f% AND disc_version%>rom_version% AND disc_version%>ram_version%THEN
 6986  SYS"XOS_Module",1  , path$ TO ptr%;r1%
 6987 ENDIF
 6988 IF(r1%AND1)=0 SYS"XOS_Module",18,name$ TO ptr%;r1%
 6989 IF(r1%AND1) !ptr%= 253 :SYS"OS_GenerateError",ptr%
 6990 =f%
 6991 DEF PROCinitialise_sparrow (startup%)
 6992   LOCAL f%, g%, fs%, rps%, s$
 6993   multiple_choices% =  0 
 6994   IFFNrmload_latest_module("PDriver","Printers:Modules.PDriver")
 6995   IFFNrmload_latest_module("RemotePrinterSupport","Printers:Modules.RemPrnSpt")
 6996   fs%=0
 6997   SYS "XOS_Module", 18, "Freeway" TO ;f%
 6998   IF (f% AND 1) = 0 THEN
 6999     SYS "XOS_SWINumberFromString",,"Freeway_Status" TO ;g%
 7000     IF (g% AND 1) = 0 THEN SYS "XFreeway_Status",0 TO ,fs% ELSE fs% = 1
 7001   ENDIF
 7002   SYS "XOS_Module", 18, "RemotePrinterSupport" TO ;rps%
 7003   SYS "XOS_Module", 18, "ShareFS" TO ;g%
 7004   IF (f% AND 1) OR (fs% = 0) OR (g% AND 1) OR (rps% AND 1) THEN
 7005     sparrow_present% =  0 
 7006   ELSE
 7007     SYS "XOS_CLI", "RMEnsure ShareFS 2.00 ERROR Foo" TO ;f%
 7008     IF (f% AND 1) THEN
 7009       sparrow_present% =  0 
 7010     ELSE
 7011       unique_string$ = FNtask_read_env("Inet$LocalAddr", task_buff%)
 7012       sparrow_present% =  -1 
 7013       PROCfreeway_register
 7014       PROCenumerate_remote_printers
 7015       SYS "XRemotePrinterSupport_Enable", 2  
 7016       printer_scrap$ = "<Wimp$ScrapDir>.Printers"
 7017       s$ = FNtask_read_env ("Printers$Dir", task_buff%)
 7018       IF INSTR(s$, "Share:") THEN
 7019         multiple_choices% =  -1 
 7020       ELSE
 7021         multiple_choices% =  0 
 7022       ENDIF
 7023     ENDIF
 7024   ENDIF
 7025   IF (rps% AND 1) = 0 THEN
 7026     SYS "XRemotePrinterSupport_ReadPollwordLocation" TO pollword_location%
 7027   ENDIF
 7028   IF multiple_choices% THEN
 7029     SYS "XOS_File", 8, "<Printers$Path>Remote" TO ; f%
 7030     s$ = "<Printers$Path>Remote.ID"+unique_string$
 7031     SYS "XOS_File", 8, s$ TO ; f%
 7032   ENDIF
 7033 ENDPROC
 7034 DEF PROCfreeway_register
 7035   SYS "Freeway_Register",  0 ,  2 
 7036 ENDPROC
 7037 DEF FNconvert_null(nullstr%)
 7038   LOCAL thing$
 7039   CALL Z%, nullstr%, thing$
 7040 = thing$
 7041 DEF PROCenumerate_queue_directory
 7042   ENDPROC
 7043 DEF PROCenumerate_remote_printers
 7044   LOCAL here%, enum_ref%, new_enum_ref%, nlen%, dlen%, ip%, name$, err%
 7045   LOCAL printer_name%, printer_descriptor%, name$, descriptor$, rmtp%, doit%
 7046   enum_ref% = 0
 7047   new_enum_ref% = 0
 7048   remote_printer_count% = 0
 7049   REPEAT
 7050     enum_ref% = new_enum_ref%
 7051     SYS "Freeway_Enumerate", 0,  2 , 0, 0, 0, 0, 0, enum_ref%                              TO ,,nlen%,,dlen%,,,new_enum_ref%
 7052     IF (new_enum_ref% > 0) THEN
 7053       printer_name%        = FNmalloc ( &47525453 , nlen%)
 7054       printer_descriptor%  = FNmalloc ( &47525453 , dlen%+1)
 7055       printer_name1%        = FNmalloc ( &30525453 , nlen%)
 7056       printer_descriptor1%  = FNmalloc ( &30525453 , dlen%+1)
 7057       SYS "Freeway_Enumerate", 0,  2 , nlen% , printer_name1%,                                dlen%+1, printer_descriptor1%, 0, enum_ref%                                TO ,,,,,,ip%
 7058       printer_descriptor1%?dlen% = 0
 7059       $printer_name% = FNconvert_null (printer_name1%)
 7060       $printer_descriptor% = FNconvert_null (printer_descriptor1%)
 7061       PROCfree ( &30525453 , printer_name1%)
 7062       PROCfree ( &30525453 , printer_descriptor1%)
 7063       rmtp% = FNconstruct_rmtp (printer_name%, printer_descriptor%, ip%)
 7064       PROCadd_to_list (remote_printers%, rmtp%)
 7065       name$ = $printer_name%  
 7066       IF FNprinter_wanted (name$) THEN
 7067         junk% = FNensure_printer (rmtp%, 0,  0 ,  -1 , err%)
 7068         IF NOT err% THEN
 7069           PROCremove_unavailable_printer (name$)
 7070           PROCremove_remote_printer (name$)
 7071           IF selected_prnt%=0 THEN
 7072             IF A%! 44  THEN
 7073               doit%=A%! 48 
 7074               WHILE doit%
 7075                 IF NOT doit%! 20  THEN
 7076                   PROCselect_printer(doit%, -1 , 0 )
 7077                   doit%=0
 7078                 ELSE
 7079                   doit%=doit%! 0 
 7080                 ENDIF
 7081               ENDWHILE
 7082             ENDIF
 7083           ENDIF
 7084         ENDIF
 7085       ENDIF
 7086       remote_printer_count% += 1
 7087     ENDIF  
 7088   UNTIL (new_enum_ref% < 0)
 7089 ENDPROC
 7090 DEF PROCadd_remote_printer (name$)
 7091   LOCAL printer_name%, printer_descriptor%, dlen%, ip%, descriptor$, flags%, rmtp%, junk$, doit%, err%, found%
 7092   SYS "XFreeway_Read", 0,  2 , name$, 0, 0 TO ,,,dlen%,,ip% ; flags%
 7093   IF (flags% AND 1) THEN
 7094     ENDPROC
 7095   ENDIF
 7096   found% =  0 
 7097   rmtp% = remote_printers%
 7098   WHILE rmtp%
 7099     IF ($rmtp%! 4  = name$) AND ((rmtp%! 20 ) <= 0) THEN
 7100       ENDPROC
 7101     ENDIF
 7102     rmtp% = rmtp%! 0 
 7103   ENDWHILE
 7104   printer_name% = FNmalloc ( &47525453 , LENname$ + 1)
 7105   printer_descriptor% = FNmalloc ( &47525453 , dlen% + 1)
 7106   printer_descriptor1% = FNmalloc ( &30525453 , dlen% + 1)
 7107   $printer_name% = name$
 7108   SYS "XFreeway_Read", 0,  2 , name$, dlen% + 1, printer_descriptor1% TO ; flags%
 7109   IF (flags% AND 1) THEN
 7110     ENDPROC
 7111   ENDIF
 7112   printer_descriptor1%?dlen% = 0
 7113   $printer_descriptor% = FNconvert_null (printer_descriptor1%)
 7114   PROCfree ( &30525453 , printer_descriptor1%)
 7115   rmtp% = FNconstruct_rmtp (printer_name%, printer_descriptor%, ip%)
 7116   PROCadd_to_list (remote_printers%, rmtp%)
 7117   remote_printer_count% += 1
 7118   IF FNprinter_wanted (name$) THEN
 7119     junk% = FNensure_printer (rmtp%, 0,  0 ,  -1 , err%)
 7120     IF NOT err% THEN 
 7121       PROCremove_unavailable_printer (name$)
 7122       PROCremove_remote_printer (name$)
 7123       IF selected_prnt%=0 THEN
 7124         IF A%! 44  THEN
 7125           doit%=A%! 48 
 7126           WHILE doit%
 7127             IF NOT doit%! 20  THEN
 7128               PROCselect_remote_printer(doit%, -1 , 0 , -1 ,err%)
 7129               doit%=0
 7130             ELSE
 7131               doit%=doit%! 0 
 7132             ENDIF
 7133           ENDWHILE
 7134         ENDIF
 7135       ENDIF
 7136     ENDIF
 7137   ENDIF
 7138   PROCcreate_installed_printer_icons
 7139 ENDPROC
 7140 DEF PROCremove_unavailable_printer (name$)
 7141   LOCAL last%, here%, found%, iter%
 7142   here%  = remote_printers%
 7143   last%  = 0
 7144   found% =  0 
 7145   IF here% THEN
 7146     REPEAT
 7147       IF ($here%! 4 ) = name$ AND here%! 20  > 0 THEN
 7148         found% =  -1 
 7149       ELSE
 7150         last% = here%
 7151         here% = here%! 0 
 7152       ENDIF
 7153     UNTIL found% OR (here% = 0)
 7154     IF (last% = 0) AND (here% <> 0) THEN   
 7155       remote_printers% = here%! 0 
 7156       PROCicon_delete (-2, here%! 20 )
 7157       PROCfree ( &47525453 , here%! 4 )
 7158         PROCfree ( &47525453 , here%! 8 )
 7159       PROCfree ( &524D5450 , here%)
 7160     ELSE
 7161       IF here% THEN  
 7162         last%! 0  = here%! 0 
 7163         PROCicon_delete (-2, here%! 20 )
 7164         PROCfree ( &47525453 , here%! 4 )
 7165         PROCfree ( &47525453 , here%! 8 )
 7166         PROCfree ( &524D5450 , here%)
 7167       ENDIF
 7168     ENDIF
 7169   ENDIF
 7170 ENDPROC
 7171 DEF FNprinter_wanted (name$)
 7172   LOCAL here%, wanted%
 7173   here% = remote_printers%
 7174   wanted% =  0 
 7175   WHILE here% AND NOT wanted%
 7176     IF $here%! 4  = name$ AND here%! 20  > 0 THEN
 7177       wanted% =  -1 
 7178     ELSE
 7179       here% = here%! 0 
 7180     ENDIF
 7181   ENDWHILE
 7182 = wanted%
 7183 DEF PROCremove_remote_printer (name$)
 7184   LOCAL prnt%, last_prnt%, ptr%, cnct%, doit%, type$, psup%, class$
 7185   IF FNmember_of_list (remote_printers%, name$) THEN
 7186     PROCremove_from_list (remote_printers%, name$)
 7187   ELSE
 7188     last_prnt% = 0
 7189     prnt% = A%! 48 
 7190     ptr% = prnt%
 7191     cnct% = prnt%! 12 
 7192     WHILE ptr%
 7193       IF $ptr%! 40  = name$ AND cnct%! 0  = 9 THEN
 7194         ptr% = 0
 7195       ELSE
 7196         last_prnt% = prnt%
 7197         prnt% = prnt%! 0 
 7198         ptr% = prnt%
 7199         cnct% = prnt%! 12 
 7200       ENDIF
 7201     ENDWHILE
 7202     IF prnt% THEN
 7203       psup% = prnt%! 4 
 7204       class$ = $psup%! 4 
 7205       type$ = $prnt%! 8 
 7206       PROCadd_unavailable_printer (name$, class$, type$)
 7207       PROCremove_this_printer (prnt%,last_prnt%)
 7208       PROCdelete_prdata_entry (type$)
 7209     ENDIF
 7210   ENDIF
 7211   IF FNwindow_open (prntctrl%) THEN
 7212     PROCcreate_installed_printer_icons
 7213     PROCwin_open (prntctrl%)
 7214   ENDIF
 7215 ENDPROC
 7216 DEF FNip_string(ip%)
 7217 = STR$~ip%
 7218 DEF FNmalloc (ident%, size%)
 7219   LOCAL ret%
 7220   B% = ident%
 7221   C% = size%
 7222   ret% = USR (code_entry% +  12 )
 7223   IF (ret% = 0) THEN
 7224     ERROR  253 , FNmsg_1 (A%! 12 , "FA5",         CHR$((B% AND &FF000000) >> 24)+CHR$((B% AND &00FF0000) >> 16)+CHR$((B% AND &0000FF00) >> 8)+CHR$(B% AND &000000ff))
 7225   ENDIF
 7226 = ret%
 7227 DEF PROCfree (ident%, block%)
 7228   B% = ident%
 7229   C% = block%
 7230   CALL code_entry% +  16 
 7231 ENDPROC
 7232 DEF PROCstrcpy (RETURN dest%, str$)
 7233   $task_buff% = str$
 7234   B% = task_buff%
 7235   C% = 2
 7236   dest% = USR(code_entry%+ 28 )
 7237 ENDPROC
 7238 DEF FNconstruct_rmtp (printer_name%, printer_descriptor%, printer_ip_address%)
 7239   LOCAL ret%
 7240   ret% = FNmalloc ( &524D5450 ,  24 )
 7241   ret%! 0  = 0
 7242   ret%! 4  = printer_name%
 7243   ret%! 8  = printer_descriptor%
 7244   ret%! 12  = printer_ip_address%
 7245   ret%! 16  = -1
 7246   ret%! 20  = -1
 7247 = ret%
 7248 DEF FNconstruct_unavailable (name$, icon%, desc$)
 7249   LOCAL ret%, str%, desc%
 7250   ret% = FNmalloc ( &524D5450 ,  24 )
 7251   PROCstrcpy (str%, name$)
 7252   PROCstrcpy (desc%, desc$)
 7253   ret%! 0  = 0
 7254   ret%! 4  = str%
 7255   ret%! 8  = desc%
 7256   ret%! 12  = -1
 7257   ret%! 16  = -1
 7258   ret%! 20  = icon%
 7259 = ret%
 7260 DEF PROCadd_to_list (RETURN list%, item%)
 7261   LOCAL here%
 7262   IF list% = 0 THEN
 7263     list% = item%
 7264   ELSE
 7265     here% = list%
 7266     WHILE (here%! 0  <> 0)
 7267       here% = here%! 0 
 7268     ENDWHILE
 7269     here%! 0  = item%
 7270   ENDIF
 7271 ENDPROC
 7272 DEF FNmember_of_list (RETURN list%, name$)
 7273   LOCAL here%
 7274   IF list% = 0 THEN
 7275     =  0 
 7276   ELSE
 7277     here% = list%
 7278     WHILE here%
 7279       IF $here%! 4  = name$ THEN
 7280         = -1 
 7281       ELSE
 7282         here% = here%! 0 
 7283       ENDIF
 7284     ENDWHILE
 7285   ENDIF
 7286 = 0 
 7287 DEF PROCremove_from_list (RETURN list%, name$)
 7288   LOCAL last%, here%, found%, iter%
 7289   IF list% THEN
 7290     here%  = list%
 7291     last%  = 0
 7292     found% =  0 
 7293     REPEAT
 7294       IF ($here%! 4 ) = name$ THEN
 7295         found% =  -1 
 7296       ELSE
 7297         last% = here%
 7298         here% = here%! 0 
 7299       ENDIF
 7300     UNTIL found% OR (here% = 0)
 7301     IF (last% = 0) AND (here% <> 0) THEN   
 7302       list% = here%! 0 
 7303       PROCfree ( &47525453 , here%! 4 )
 7304       PROCfree ( &47525453 , here%! 8 )
 7305       PROCfree ( &524D5450 , here%)
 7306     ELSE 
 7307      IF here% THEN  
 7308       last%! 0  = here%! 0 
 7309       PROCfree ( &47525453 , here%! 4 )
 7310       PROCfree ( &47525453 , here%! 8 )
 7311       PROCfree ( &524D5450 , here%)
 7312      ENDIF
 7313     ENDIF
 7314   ENDIF
 7315 ENDPROC
 7316 DEF PROCpollword_changed
 7317   LOCAL reason%, prnt%, cnct%, doit%
 7318   LOCAL name%, bufsize%, s$, psup%, s%, t%, l%, t$, ptr%
 7319   REPEAT
 7320     SYS "XRemotePrinterSupport_GetNextEvent",,,-1 TO reason%,,bufsize%
 7321     IF reason% > 0 THEN  
 7322       IF bufsize% > 0 THEN  
 7323         name% = FNmalloc ( &47525453 , bufsize%)
 7324         SYS "XRemotePrinterSupport_GetNextEvent",,name%, bufsize%
 7325       ELSE
 7326         SYS "XRemotePrinterSupport_GetNextEvent",,0, 0
 7327       ENDIF
 7328       CASE reason% OF
 7329         WHEN  1 
 7330           IF selected_prnt% THEN
 7331             cnct% = selected_prnt%! 12 
 7332             IF cnct%! 0  = 9 AND printer_prefix$ <> "" THEN
 7333               t$ = $(selected_prnt%! 40 )
 7334               ptr% = INSTR(t$, " ")
 7335               WHILE ptr%
 7336                 MID$(t$,ptr%,1) = CHR$160
 7337                 ptr% = INSTR(t$, " ", ptr%+1)
 7338               ENDWHILE
 7339               sname$ = printer_prefix$+"RemSpool."+unique_string$+"."+t$
 7340               qname$ = printer_prefix$+"RemQueue."+unique_string$+"."+STR$(remote_jobno%)
 7341               SYS "XOS_File", 17, sname$ TO t%,,,,l% ; f%
 7342               IF (l% > 0) AND ((f% AND 1) = 0) AND (t% = 1)THEN
 7343                 IF last_application$ = "" THEN
 7344                   last_application$ = FNmsg_0(A%! 12 , "UNKN")
 7345                 ENDIF
 7346                 IF last_leafname$ = "" THEN
 7347                   last_leafname$ = FNmsg_0(A%! 12 , "UNKN")
 7348                 ENDIF
 7349                 IF FNwrite_information_file (selected_prnt%, last_application$, last_leafname$) THEN
 7350                  psup% = selected_prnt%! 4 
 7351                  SYS "XOS_FSControl", 25, sname$, qname$  
 7352                 ELSE
 7353                  SYS "XOS_File", 6, sname$
 7354                 ENDIF
 7355                 last_application$ = ""
 7356                 last_leafname$ = ""
 7357                 s$=FNselect_connection(selected_prnt%, -1 )
 7358                 IF s$<>"" THEN 
 7359                    PROCerror_warning(s$)
 7360                 ENDIF
 7361               ENDIF
 7362             ENDIF
 7363           ENDIF
 7364         WHEN  2 
 7365           PROCadd_to_queue (FNconvert_null (name%))
 7366         WHEN  3 
 7367           IF sparrow_present% THEN
 7368             PROCadd_remote_printer (FNconvert_null (name%))
 7369           ENDIF
 7370         WHEN  4 
 7371           PROCremove_remote_printer (FNconvert_null (name%))
 7372         WHEN  5 
 7373         WHEN  6 
 7374           PROClocalprinter_deleted (FNconvert_null (name%))
 7375         WHEN  7 
 7376           PROCremove_remote_available_printers
 7377           PROCinitialise_sparrow ( 0 )
 7378 REM          freeway_just_started% = 1
 7379         WHEN  8 
 7380           PROCfreeway_terminating
 7381       ENDCASE
 7382       IF (bufsize% > 0) THEN
 7383         PROCfree ( &47525453 , name%)
 7384       ENDIF
 7385     ENDIF
 7386   UNTIL reason% < 0
 7387   IF selected_prnt%=0 THEN
 7388     IF A%! 44  THEN
 7389       doit%=A%! 48 
 7390       WHILE doit%
 7391         IF NOT doit%! 20  THEN
 7392           PROCselect_printer(doit%, -1 , 0 )
 7393           doit%=0
 7394         ELSE
 7395           doit%=doit%! 0 
 7396         ENDIF
 7397       ENDWHILE
 7398     ENDIF
 7399   ENDIF
 7400 ENDPROC
 7401 DEF PROCfreeway_starting
 7402   PROCremove_remote_available_printers
 7403   PROCinitialise_sparrow ( 0 )
 7404   freeway_just_started% = 0
 7405 ENDPROC
 7406 DEF PROClocalprinter_deleted (name$)
 7407 ENDPROC
 7408 DEF FNset_jobno
 7409   LOCAL qname$, f%, v%, w%, e$, num%, first%
 7410   REPEAT 
 7411     qname$ = printer_prefix$+"RemQueue."+unique_string$+"."+STR$remote_jobno%
 7412     SYS "XRemotePrinterSupport_DisableUpcalls"
 7413     SYS "XOS_File", 5, qname$ TO v%; f%
 7414     SYS "XRemotePrinterSupport_EnableUpcalls"
 7415     IF f% AND 1 THEN
 7416       remote_jobno% = -1
 7417       = FNmsg_0 (A%! 12 , "OKAS", FNconvert_null(v%+4))
 7418     ENDIF
 7419     IF (v%<>0) THEN  
 7420       remote_jobno% += 1
 7421     ENDIF
 7422   UNTIL v%=0
 7423 =""
 7424 DEF PROCadd_to_queue (filename$)
 7425   LOCAL fullpath$, infopath$, handle%, printer$, leafname$, c%, prnt%
 7426   LOCAL ptr%, name$, psup%, type%, sender_id$, application$
 7427   leafname$ = MID$(filename$, INSTR(filename$, ".") + 1)
 7428   fullpath$ = printer_scrap$+"."+filename$
 7429   infopath$ = printer_scrap$+".RemQueue."+leafname$+"I"
 7430   printer$ = ""
 7431   sender$ = ""
 7432   h% = OPENIN infopath$
 7433   IF h% = 0 THEN
 7434     ENDPROC
 7435   ENDIF
 7436   c% = BGET#h%
 7437   WHILE (NOT EOF#h%) AND (c% <> 0)
 7438     printer$ += CHR$c%
 7439     c% = BGET#h%
 7440   ENDWHILE
 7441   c% = BGET#h%
 7442   WHILE (NOT EOF#h%) AND (c% <> 0)
 7443     sender_id$ += CHR$c%
 7444     c% = BGET#h%
 7445   ENDWHILE
 7446   c% = BGET#h%
 7447   WHILE (NOT EOF#h%) AND (c% <> 0)
 7448     application$ += CHR$c%
 7449     c% = BGET#h%
 7450   ENDWHILE
 7451   leafname$ = ""
 7452   c% = BGET#h%
 7453   WHILE (NOT EOF#h%) AND (c% > 31)
 7454     leafname$ += CHR$c%
 7455     c% = BGET#h%
 7456   ENDWHILE
 7457   CLOSE# h%
 7458   SYS "XOS_File", 6, infopath$  
 7459   ptr% = A%! 48   
 7460   prnt% = 0
 7461   WHILE (ptr%)
 7462     IF (ptr%! 40  = 0) THEN
 7463       psup% = ptr%! 4 
 7464       name$ = $(psup%! 4 )
 7465     ELSE
 7466       name$ = $(ptr%! 40 )
 7467     ENDIF
 7468     IF name$ = printer$ THEN 
 7469       prnt% = ptr%
 7470       ptr% = 0
 7471     ELSE
 7472       ptr% = ptr%! 0 
 7473     ENDIF
 7474   ENDWHILE
 7475   IF (prnt% <> 0) THEN
 7476     psup% = prnt%! 4 
 7477     SYS "XOS_File", 23, fullpath$ TO ,,,,,,type%
 7478     PROCadd_queue_entry ( -1 , "("+FNmsg_0 (A%! 12 , "IC9")+") "+application$, fullpath$, leafname$, prnt%, type%)
 7479   ENDIF
 7480 ENDPROC
 7481 DEF PROCsave_sender_info (receiver_handle%, leaf$)
 7482   LOCAL e%, f%
 7483   SYS "XTaskManager_TaskNameFromHandle",receiver_handle% TO e% ; f%
 7484   IF (f% AND 1) THEN
 7485     last_application$ = FNmsg_0(A%! 12 , "UNKN")
 7486     last_leafname$ = FNmsg_0(A%! 12 , "UNKN")
 7487   ELSE
 7488     last_application$ = FNconvert_null (e%)
 7489     last_leafname$ = leaf$
 7490   ENDIF
 7491 ENDPROC
 7492 DEF FNwrite_information_file (prnt%, application$, leaf$)
 7493   REM returns  -1  if successful, else  0 
 7494   LOCAL filename$, h%, f%, name$, ptr%
 7495   filename$ = printer_prefix$+"RemQueue."+unique_string$+"."+STR$(remote_jobno%)+"I"
 7496   name$ = $prnt%! 40 
 7497   SYS "XOS_Find", &83, filename$ TO h%;f%
 7498   IF (f%AND1) h%=0
 7499   IF h% <> 0 THEN
 7500     BPUT#h%, name$+CHR$0+unique_string$+CHR$0+application$+CHR$0+leaf$
 7501     SYS "XOS_Find", 0, h% TO ;f%
 7502   ENDIF
 7503   IF (f%AND1) OR h%=0 := 0 
 7504 = -1 
 7505 DEF PROCshare_printer
 7506   LOCAL prnt%, icon%, rmtp%
 7507   IF NOTFNinitialise_scrap THEN
 7508     PROCerror_box(FNmsg_0(A%! 12 , "OKAV"),1)
 7509     ENDPROC
 7510   ENDIF
 7511   IF INSTR(FNscrap_location, "Share:") > 0 THEN
 7512     PROCerror_warning (FNmsg_0 (A%! 12 , "OKAT"))
 7513     ENDPROC
 7514   ENDIF
 7515   REPEAT
 7516     PROCfind_prnt (prnt%, rmtp%, icon%)
 7517     PROCicon_deselect (prntctrl%, icon%)
 7518     IF prnt% AND ((prnt%! 24  AND  (1<<17) ) = 0) THEN
 7519       PROCshare_one_printer (prnt%)
 7520     ENDIF
 7521   UNTIL (prnt% = 0) AND (rmtp% = 0)
 7522 ENDPROC
 7523 DEF PROCshare_one_printer (prnt%)
 7524   LOCAL name$, vptr%, buf%, vlen%, thing$, f%, r0%, f$, xprnt%, xname$, psup%
 7525     IF (prnt%! 24  AND  (1<<17) ) > 0 THEN
 7526       ENDPROC
 7527     ENDIF
 7528     IF (prnt%! 40  = 0) THEN
 7529       psup% = prnt%! 4 
 7530       name$ = $(psup%! 4 )
 7531     ELSE
 7532       name$ = $(prnt%! 40 )
 7533     ENDIF
 7534     IF NOTFNinitialise_scrap THEN
 7535       PROCerror_box(FNmsg_1(A%! 12 , "OKAW",name$),1)
 7536       prnt%! 24  = prnt%! 24  AND (NOT  (1<<16) )
 7537       ENDPROC
 7538     ENDIF
 7539     IF INSTR(FNscrap_location, "Share:") > 0 THEN
 7540       PROCerror_warning (FNmsg_1 (A%! 12 , "OKAU", name$))
 7541       prnt%! 24  = prnt%! 24  AND (NOT  (1<<16) )
 7542       ENDPROC
 7543     ENDIF
 7544     desc$ = $(prnt%! 8 )
 7545     IF (prnt%! 24  AND  1 ) = 0 THEN
 7546       PROCactivate_this_printer (prnt%)
 7547     ENDIF
 7548     vptr% = 0
 7549     REPEAT
 7550       SYS "XOS_ReadVarVal", "Inet$LocalAddr*", 0, 1<<31, vptr%, 0 TO ,,vlen%
 7551       IF vlen% < 0 THEN
 7552         buf% = FNmalloc ( &47525453 , NOT(vlen%) + 1)
 7553         IF (buf% > 0) THEN
 7554           SYS "OS_ReadVarVal", "Inet$LocalAddr*", buf%, NOT(vlen%), vptr%, 0 TO ,,,vptr%
 7555           buf%?(NOT(vlen%)) = 0  
 7556           thing$ = FNconvert_null (buf%)
 7557           PROCfree ( &47525453 , buf%)
 7558           f$ = "unshare _S"+thing$
 7559           SYS "XOS_CLI", f$
 7560           f$ = "share <Wimp$ScrapDir>.Printers _S"+thing$+" -noicon"
 7561           SYS "XOS_CLI", f$
 7562         ENDIF
 7563       ENDIF
 7564     UNTIL vlen% >= 0
 7565     PROCshare_one_prdata (prnt%, name$)
 7566     SYS "XFreeway_Read", 0,  2 , name$, 0, 0 TO ,,,,,ip% ; f%
 7567     IF (f% AND 1) = 0 THEN
 7568       PROCerror_warning (FNmsg_1 (A%! 12 , "OKAQ", name$))
 7569       ENDPROC
 7570     ENDIF
 7571     xprnt% = A%! 48 
 7572     WHILE xprnt%
 7573       IF (xprnt%! 40  = 0) THEN
 7574         psup% = xprnt%! 4 
 7575         xname$ = $(psup%! 4 )
 7576       ELSE
 7577         xname$ = $(xprnt%! 40 )
 7578       ENDIF
 7579       IF (xname$ = name$) AND ((xprnt%! 24  AND  (1<<16) ) > 0) THEN
 7580         PROCerror_warning (FNmsg_1 (A%! 12 , "OKAQa", name$))
 7581         ENDPROC
 7582       ENDIF
 7583       xprnt% = xprnt%! 0 
 7584     ENDWHILE
 7585     SYS "XFreeway_Write", 0,  2 , name$, LENdesc$, desc$ TO r0% ; f%
 7586     IF (f% AND 1) THEN
 7587       PROCerror_warning (FNmsg_1 (A%! 12 , "OKAQ", name$))
 7588       ENDPROC
 7589     ENDIF
 7590     prnt%! 24  = prnt%! 24  OR  (1<<16) 
 7591 ENDPROC
 7592 DEF PROCunshare_one_printer (prnt%)
 7593   LOCAL name$, vlen%, buf%, lptr%, desc$, thing$, psup%
 7594   IF (prnt%! 40  = 0) THEN
 7595     psup% = prnt%! 4 
 7596     name$ = $(psup%! 4 )
 7597   ELSE
 7598     name$ = $(prnt%! 40 )
 7599   ENDIF
 7600   IF (prnt%! 24  AND  (1<<16) ) THEN
 7601     prnt%! 24  = prnt%! 24  AND  (&FFFFFFFF - (1<<16)) 
 7602   ENDIF
 7603   IF sparrow_present% THEN
 7604     SYS "Freeway_Write", 1,  2 , name$, 0, 0
 7605   ENDIF
 7606 ENDPROC
 7607 DEF PROCunshare_directories
 7608 ENDPROC
 7609 DEF PROCsparrow_local_file
 7610   sparrow_saved_data_block%=data_block%
 7611   sparrow_saved_data_ptr%=data_ptr%
 7612   sparrow_saved_data_ptrc%=!data_ptr%
 7613   sparrow_saved_data_size%=data_size%
 7614   sparrow_saved_data_line%=data_line%
 7615   sparrow_saved_data_file$=data_file$
 7616 ENDPROC
 7617 DEF PROCsparrow_restore_file
 7618   data_block%=sparrow_saved_data_block%
 7619   data_ptr%=sparrow_saved_data_ptr%
 7620   !data_ptr%=sparrow_saved_data_ptrc%
 7621   data_size%=sparrow_saved_data_size%
 7622   data_line%=sparrow_saved_data_line%
 7623   data_file$=sparrow_saved_data_file$
 7624 ENDPROC
 7625 DEF PROCsparrow_local_file_2
 7626   sparrow_saved_data_block2%=data_block%
 7627   sparrow_saved_data_ptr2%=data_ptr%
 7628   sparrow_saved_data_ptrc2%=!data_ptr%
 7629   sparrow_saved_data_size2%=data_size%
 7630   sparrow_saved_data_line2%=data_line%
 7631   sparrow_saved_data_file2$=data_file$
 7632 ENDPROC
 7633 DEF PROCsparrow_restore_file_2
 7634   data_block%=sparrow_saved_data_block2%
 7635   data_ptr%=sparrow_saved_data_ptr2%
 7636   !data_ptr%=sparrow_saved_data_ptrc2%
 7637   data_size%=sparrow_saved_data_size2%
 7638   data_line%=sparrow_saved_data_line2%
 7639   data_file$=sparrow_saved_data_file2$
 7640 ENDPROC
 7641 DEF FNensure_printer(rmtp%, settings_flags%, in_settings%, ret_error%, RETURN error%)
 7642   LOCAL scrap$, settings$, class$
 7643   LOCAL printer$, s$, rempath$, name$, raise_error%
 7644   LOCAL flags%, fileptr%, cl%, sn%, found%, p%, prnt%
 7645   LOCAL ERROR
 7646   error% =  0 
 7647   SYS "Hourglass_On"
 7648   scrap$  = "Share::_S"+FNip_string (rmtp%! 12 )+".$"
 7649   flags% = 0 
 7650   SYS "XRemotePrinterSupport_DisableUpcalls"
 7651   SYS "XOS_File", 17, scrap$ TO ; flags%
 7652   SYS "XRemotePrinterSupport_EnableUpcalls"
 7653   IF (flags% AND 1) THEN
 7654     IF ret_error% THEN
 7655       error% =  -1 
 7656     ELSE
 7657       PROCerror_warning(FNmsg_1 (A%! 12 ,"OKAOs", $rmtp%! 4 ))
 7658     ENDIF
 7659     SYS "Hourglass_Off"
 7660     = 0
 7661   ENDIF
 7662   name$ = $rmtp%! 4 
 7663   p% = INSTR(name$, " ")  
 7664   WHILE p%
 7665     MID$(name$,p%,1) = CHR$160  
 7666     p% = INSTR(name$, " ", p%+1)  
 7667   ENDWHILE
 7668   rempath$ = scrap$+"."+name$
 7669   prnt% = FNadd_remote_to_prdata(rmtp%, rempath$, settings_flags%, in_settings%, ret_error%, error%)
 7670   SYS "Hourglass_Off"
 7671 = prnt%
 7672 DEF FNadd_remote_to_prdata (rmtp%, prpath$, flags%, in_settings%, ret_error%, RETURN error%)
 7673   LOCAL name%,psup%,ptr%,s$,ntry%,prdata%,last_prdata%,this_prhead%,matched%,fix_up%, last_prhead%
 7674   LOCAL prnt%, cnct%, junk$, class$, cl%, i%, last_prdata1%, tmpt%, saved_prhead%, odb%, ods%, prd%
 7675   LOCAL new_prhead%, error%, raise_error%
 7676   error% =  0 
 7677   IF NOT FNload_file (prpath$) THEN
 7678     SYS "Hourglass_Off"
 7679     IF ret_error% THEN
 7680       error% =  -1 
 7681       = 0
 7682     ELSE
 7683       PROCerror_warning (FNmsg_1(A%! 12 ,"OKAOs",$rmtp%! 4 ))
 7684     ENDIF
 7685   ENDIF
 7686   SYS "Hourglass_On"
 7687   PROCvalidate_prdata_file(psup%)
 7688   this_prhead%=psup%! 12 
 7689   IF this_prhead% THEN
 7690     prdata%=this_prhead%! 4 
 7691     IF prdata% THEN
 7692       ptr%=!data_ptr%
 7693       ntry%=psup%! 8 
 7694       ntry%=ntry%! 4 
 7695       ts%=FNmatch_line($(ntry%+ 16 ))
 7696       IF ts% THEN
 7697         WHILE prdata%
 7698           IF $prdata%! 8 =$ts% THEN
 7699             PROCrelease_file
 7700             SYS "Hourglass_Off"
 7701             prnt% = FNinstall_remote_printer($rmtp%! 4 , $rmtp%! 8 ,psup%,prdata%,in_settings%, ret_error%, error%)
 7702             = prnt%
 7703           ENDIF
 7704           last_prdata%=prdata%
 7705           prdata%=prdata%! 0 
 7706         ENDWHILE
 7707       ELSE
 7708         PROCvalidate_error(FNmsg_1(A%! 12 ,"OKZc",            $(ntry%+ 16 )))
 7709       ENDIF
 7710       !data_ptr%=ptr%
 7711     ELSE
 7712       last_prdata%=0
 7713     ENDIF
 7714   ELSE
 7715     last_prdata%=0
 7716   ENDIF
 7717   PROCprocess_one_entry(psup%! 8 ,last_prdata%,this_prhead%,0,      matched%,fix_up%,psup%)
 7718   PROCrelease_file
 7719   psup%! 24 =psup%! 24  OR 2
 7720   prnt% = FNinstall_remote_printer($rmtp%! 4 , $rmtp%! 8 ,psup%,last_prdata%,in_settings%, ret_error%, error%)
 7721   SYS "Hourglass_Off"
 7722 = prnt%
 7723 DEF PROCremove_one_printer (prnt%)
 7724   LOCAL i%,ptr%,last_prnt%,private_buff%,doit%,type$, icon%, rmtp%, dontcare%
 7725   PROCfind_prnt (dontcare%, rmtp%, icon%)
 7726   IF (NOT dontcare%) AND rmtp% THEN
 7727     ENDPROC
 7728   ENDIF
 7729   SYS "Hourglass_On"
 7730   ptr% = A%! 48 
 7731   WHILE ptr%
 7732     IF ptr%! 0  = prnt% THEN
 7733       last_prnt% = ptr%
 7734       ptr% = 0
 7735     ELSE
 7736       ptr% = ptr%! 0 
 7737     ENDIF
 7738   ENDWHILE
 7739   type$=$prnt%! 8 
 7740   PROCremove_this_printer(prnt%,last_prnt%)
 7741   PROCdelete_prdata_entry(type$)
 7742   IF selected_prnt%=0 THEN
 7743     IF A%! 44  THEN
 7744       doit%=A%! 48 
 7745       WHILE doit%
 7746         IF NOT doit%! 20  THEN
 7747           PROCselect_printer(doit%, -1 , 0 )
 7748           doit%=0
 7749         ELSE
 7750           doit%=doit%! 0 
 7751         ENDIF
 7752       ENDWHILE
 7753     ENDIF
 7754   ENDIF
 7755   IF selected_prnt%=0 PROCtell_the_world
 7756   B%= &58585858 
 7757   C%=private_buff%
 7758   CALL code_entry%+ 16 
 7759   PROCcreate_installed_printer_icons
 7760   IF FNwindow_open(prntctrl%) THEN 
 7761     PROCwin_open(prntctrl%)
 7762   ENDIF
 7763   SYS "Hourglass_Off"
 7764 ENDPROC
 7765 DEF FNpsup_used (psup%)
 7766   LOCAL prnt%, ret%
 7767   prnt% = A%! 48 
 7768   ret% =  0 
 7769   WHILE prnt%
 7770     IF prnt%! 4  = psup% THEN
 7771       ret% =  -1 
 7772       prnt% = 0
 7773     ELSE
 7774       prnt% = prnt%! 0 
 7775     ENDIF
 7776   ENDWHILE
 7777 = ret%
 7778 DEF FNunavailable_count
 7779   LOCAL here%, ret%
 7780   ret% = 0
 7781   here% = remote_printers%
 7782   WHILE here%
 7783     IF here%! 20  > 0 THEN
 7784       ret% += 1
 7785     ENDIF
 7786     here% = here%! 0 
 7787   ENDWHILE
 7788 = ret%
 7789 DEF PROCfreeway_terminating
 7790   LOCAL prnt%, doit%
 7791   IF NOT sparrow_present% THEN
 7792     ENDPROC
 7793   ENDIF
 7794   prnt% = A%! 48 
 7795   WHILE prnt%
 7796     IF prnt%! 24  AND  (1<<17)  THEN
 7797       PROCremove_remote_printer ($prnt%! 40 )
 7798     ENDIF
 7799     prnt% = prnt%! 0 
 7800   ENDWHILE
 7801   PROCremove_remote_available_printers
 7802   PROCcreate_installed_printer_icons
 7803   IF selected_prnt%=0 THEN
 7804     IF A%! 44  THEN
 7805       doit%=A%! 48 
 7806       WHILE doit%
 7807         IF NOT doit%! 20  THEN
 7808           PROCselect_printer(doit%, -1 , 0 )
 7809           doit%=0
 7810         ELSE
 7811           doit%=doit%! 0 
 7812         ENDIF
 7813       ENDWHILE
 7814     ENDIF
 7815   ENDIF
 7816   sparrow_present% =  0 
 7817 ENDPROC
 7818 DEF PROCremove_remote_available_printers
 7819   LOCAL here%, next%, doit%
 7820   here% = remote_printers%
 7821   WHILE here%  
 7822     next% = here%! 0 
 7823     IF here%! 20  <= 0 THEN
 7824       PROCremove_remote_printer ($here%! 4 )
 7825     ENDIF
 7826     here% = next%
 7827   ENDWHILE
 7828   IF selected_prnt%=0 THEN
 7829     IF A%! 44  THEN
 7830       doit%=A%! 48 
 7831       WHILE doit%
 7832         IF NOT doit%! 20  THEN
 7833           PROCselect_printer(doit%, -1 , 0 )
 7834           doit%=0
 7835         ELSE
 7836           doit%=doit%! 0 
 7837         ENDIF
 7838       ENDWHILE
 7839     ENDIF
 7840   ENDIF
 7841 ENDPROC
 7842 DEF FNpsup_multiple_res(psup%,id$,s$)
 7843 ="Printers:Remote.ID"+id$+"."+$psup%! 4 +"."+s$
 7844 DEF PROCadd_config (prnt%)
 7845 ENDPROC
 7846 DEF FNinstall_remote_printer(name$,desc$,psup%,prdt%,in_settings%, ret_error%, RETURN error%)
 7847   LOCAL s%,t%,s$,prnt%,cnct%
 7848   error% =  0 
 7849   prdt%!(prdt%! 4 *4+ 8 )+=1
 7850   B%= &544E5250 
 7851   C%= 68 
 7852   prnt%=USR(code_entry%+ 12 )
 7853   IF prnt%=0     ERROR  254 ,FNmsg_1(A%! 12 ,"FA5","PRNT")
 7854   IF A%! 48  THEN
 7855     s%=A%! 48 
 7856     WHILE s%! 0 
 7857       s%=s%! 0 
 7858     ENDWHILE
 7859     s%! 0 =prnt%
 7860   ELSE
 7861     A%! 48 =prnt%
 7862   ENDIF
 7863   prnt%! 0 =0
 7864   prnt%! 4 =psup%
 7865   B%=prdt%! 8 
 7866   C%=2
 7867   prnt%! 8 =USR(code_entry%+ 28 )
 7868   B%= &54434E43 
 7869   C%= 36 
 7870   cnct%=USR(code_entry%+ 12 )
 7871   IF cnct%=0     ERROR  254 ,FNmsg_1(A%! 12 ,"FA5","CNCT")
 7872   cnct%! 0  = 9  
 7873   cnct%? 4 =1+((s% AND %11100)>>2)
 7874   cnct%? 5 =0
 7875   SYS "OS_Byte",161,16 TO,,s%
 7876   cnct%! 8 =(s% AND %11100000)>>5
 7877   IF NOT FNeconet_installed THEN
 7878     cnct%! 12 =0
 7879   ELSE
 7880     SYS "OS_Byte",161,3 TO,,s%
 7881     SYS "OS_Byte",161,4 TO,,t%
 7882     IF s% THEN
 7883       $task_buff%=STR$ t%+"."+STR$ s%
 7884       B%=task_buff%
 7885       C%=2
 7886       cnct%! 12 =USR(code_entry%+ 28 )
 7887     ELSE
 7888       s$=CHR$ t%
 7889       FOR s%=1 TO 5
 7890         SYS "OS_Byte",161,152+s% TO,,t%
 7891         IF t% s$+=CHR$ t% ELSE s%=5
 7892       NEXT
 7893       $task_buff%=s$
 7894       B%=task_buff%
 7895       C%=2
 7896       cnct%! 12 =USR(code_entry%+ 28 )
 7897     ENDIF
 7898   ENDIF
 7899   SYS "XOS_ReadVarVal","PrinterType$5",buff1%,256,,3 TO,,t%
 7900   buff1%?t%=13
 7901   B%=buff1%
 7902   C%=2
 7903   cnct%! 16 =USR(code_entry%+ 28 )
 7904   cnct%! 20 =0
 7905   cnct%! 24 =0
 7906   cnct%! 28 =0
 7907   cnct%! 32 =0
 7908   cnct%? 6 =0
 7909   prnt%! 12 =cnct%
 7910   B%= &47464E43 
 7911   C%=4*psup%! 36 
 7912   s%=USR(code_entry%+ 12 )
 7913   IF s%=0 ERROR  254 ,FNmsg_1(A%! 12 ,"FA5","CNFG")
 7914   IF 0<=psup%! 36 -1 THEN
 7915     FOR t%=0 TO psup%! 36 -1
 7916       s%!(t%*4)=0
 7917     NEXT
 7918   ENDIF
 7919   prnt%! 16 =s%
 7920   prnt%! 20 =-1  
 7921   prnt%! 24 =0  
 7922   prnt%! 28 =-1  
 7923   prnt%! 32 =0  
 7924   prnt%! 36 =0  
 7925   prnt%! 40 =0  
 7926   prnt%! 44 =0  
 7927   IF psup%! 32  AND %100 THEN
 7928     prnt%! 48 =FNallocate_pause_window
 7929   ELSE
 7930     prnt%! 48 =0
 7931   ENDIF
 7932   prnt%! 52 =0
 7933   PROCprinter_reason_code(psup%,prnt%,-4,0)
 7934   IF psup%! 24  AND %100 PROCprinter_reason_code(psup%,prnt%,-12,0)
 7935   PROCstrcpy (prnt%! 40 , $rmtp%! 4 )
 7936   PROCcreate_installed_printer_icons  
 7937   IF psup%! 24  AND %1000 THEN
 7938     prnt%! 56 =10*psup%?( 24 +1)
 7939   ELSE
 7940     prnt%! 56 =-1
 7941   ENDIF
 7942   prnt%! 24  = prnt%! 24  OR  (1<<17) 
 7943   IF NOT in_settings% THEN
 7944     PROCactivate_this_remote_printer(prnt%, ret_error%, error%)
 7945   ENDIF
 7946 = prnt%
 7947 DEF PROCadd_unavailable_printer (name$, class$, desc$)
 7948   LOCAL prnt%, icon%, side%, p%, ih%, here%
 7949   prnt% = A%! 48 
 7950   IF NOT prnt% THEN
 7951       icon% = &0F000000
 7952       side% = -5
 7953   ELSE
 7954       icon% = FNleft_of (prnt%)
 7955       side% = -3
 7956   ENDIF
 7957   spr$ = "su_"+class$
 7958   ih% = FNiconbar_tands (name$, spr$, side%, icon%)
 7959   PROCadd_to_list (remote_printers%, FNconstruct_unavailable (name$, ih%, desc$))
 7960   IF A%! 48  = 0 AND main_icon% > 0 THEN
 7961     PROCicon_delete (-1, main_icon%)
 7962     main_icon% = -1
 7963   ENDIF
 7964 ENDPROC
 7965 DEF PROCinitialise_one_remote_printer(prnt%)
 7966   LOCAL ts%,prdt%,d%,cnct%,h%,nm$,head%, psup%
 7967   cnfg% = prnt%! 16 
 7968   psup% = prnt%! 4 
 7969   h%=FNevaluate($FNmatch_line_or_error("cs:"))
 7970   IF 0<=h%-1 THEN
 7971     FOR d%=0 TO h%-1
 7972       ts%=FNmatch_any_line
 7973       IF ts% THEN
 7974         ss%=FNmatch_string(ts%,"nl:")
 7975         IF ss% THEN
 7976           cnfg%!(d%*4)=0
 7977         ELSE
 7978           ss%=FNmatch_string(ts%,"in:")
 7979           IF ss% THEN
 7980             cnfg%!(d%*4)=FNstore_integer(FNevaluate($ss%))
 7981           ELSE
 7982             ss%=FNmatch_string(ts%,"st:")
 7983             IF ss% THEN
 7984               B%=ss%
 7985               C%=2
 7986               cnfg%!(d%*4)=USR(code_entry%+ 28 )
 7987             ELSE
 7988               ss%=FNmatch_string(ts%,"s0:")
 7989               IF ss% THEN
 7990                 B%=ss%
 7991                 C%=3
 7992                 cnfg%!(d%*4)=USR(code_entry%+ 28 )
 7993               ELSE
 7994                 ss%=FNmatch_string(ts%,"gs:")
 7995                 IF ss% THEN
 7996                   B%=ss%
 7997                   C%=4
 7998                   cnfg%!(d%*4)=USR(code_entry%+ 28 )
 7999                 ELSE
 8000                   ss%=FNmatch_string(ts%,"pt:")
 8001                   IF ss% THEN
 8002                     B%= &52544F50 
 8003                     C%=4
 8004                     cnfg%!(d%*4)=USR(code_entry%+ 12 )
 8005                     IF cnfg%!(d%*4)=0                       ERROR  253 ,FNmsg_1(A%! 12 ,"FA5","POTR")
 8006                     !cnfg%!(d%*4)=FNfix_up_prdata_pointer($ss%)  
 8007                   ELSE
 8008                     PROCsettings_error(FNmsg_1(A%! 12 ,"OKH",$ts%))
 8009                   ENDIF
 8010                 ENDIF
 8011               ENDIF
 8012             ENDIF
 8013           ENDIF
 8014         ENDIF
 8015       ENDIF
 8016     NEXT
 8017   ENDIF
 8018   PROCactivate_this_printer (prnt%)
 8019 ENDPROC
 8020 DEF FNscrap_location
 8021 = FNtask_read_env ("Wimp$ScrapDir", msg_text%)
 8022 DEF PROCshare_one_prdata (prnt%, name$)
 8023   LOCAL psup%,head%,prdt%,c%,tmpt%,ntry%,list%,i%,j%,k%,l%,s$,p%,oname$, tmp%, gotit%, level%
 8024   SYS "Hourglass_On"
 8025   psup%=prnt%! 4 
 8026   oname$ = $prnt%! 8 
 8027   IF psup% THEN
 8028    IF psup%! 8  THEN
 8029     p% = INSTR(name$, " ")  
 8030     WHILE p%
 8031       MID$(name$,p%,1) = CHR$160  
 8032       p% = INSTR(name$, " ", p%+1)  
 8033     ENDWHILE
 8034     c% = OPENOUT("<Wimp$ScrapDir>.Printers."+name$)
 8035     BPUT#c%, "cl: "+$psup%! 4 
 8036     tmpt%=psup%! 8 
 8037     head%=psup%! 12 
 8038      IF $(tmpt%+ 12 ) <> "printers" THEN
 8039        BPUT#c%,$(tmpt%+ 12 )+":"
 8040        BPUT#c%,"#"
 8041      ENDIF
 8042      prdt%=head%! 4 
 8043      WHILE prdt%
 8044       IF prdt%!(prdt%! 4 *4+ 8 )THEN
 8045        ntry%=tmpt%! 4 
 8046        i%=prdt%+ 8 
 8047        IF LEFT$($(ntry%+ 16 ), 6) = "pr_nme" THEN
 8048          IF FNprinter_read_string(!i%) = oname$ THEN
 8049            gotit% =  -1  
 8050          ELSE
 8051            gotit% =  0 
 8052          ENDIF
 8053        ELSE
 8054          gotit% =  -1 
 8055        ENDIF
 8056          WHILE ntry%
 8057           IF gotit% THEN BPUT#c%,$(ntry%+ 16 )+" ";
 8058           IF !i%=0 THEN
 8059            IF ntry%! 4 =6 THEN
 8060              IF gotit% THEN BPUT#c%,48  
 8061            ELSE
 8062              IF ntry%! 4 =1 THEN
 8063                IF gotit% THEN BPUT#c%,48  
 8064              ENDIF
 8065            ENDIF
 8066            IF gotit% THEN BPUT#c%,10
 8067           ELSE
 8068            j%=!i%  
 8069            CASE ntry%! 4  OF
 8070             WHEN 1
 8071              IF gotit% THEN BPUT#c%,STR$ !j%
 8072             WHEN 2
 8073              IF gotit% THEN BPUT#c%,FNprinter_read_string(j%)
 8074             WHEN 3
 8075              IF gotit% THEN BPUT#c%,FNprinter_read_string(j%)
 8076             WHEN 4
 8077              IF gotit% THEN BPUT#c%,FNungstrans(FNprinter_read_string(j%))
 8078             WHEN 5
 8079              IF gotit% THEN BPUT#c%,10
 8080              CASE ntry%! 8  OF
 8081               WHEN 1
 8082                IF gotit% THEN BPUT#c%," "+STR$ !j%! 0 +", "+STR$ !j%! 4 
 8083               WHEN 2
 8084                IF gotit% THEN BPUT#c%," "+FNprinter_read_string(j%! 0 )
 8085                IF gotit% THEN BPUT#c%," "+FNprinter_read_string(j%! 4 )
 8086               WHEN 3
 8087                IF gotit% THEN BPUT#c%," "+FNprinter_read_string(j%! 0 )
 8088                IF gotit% THEN BPUT#c%," "+FNprinter_read_string(j%! 4 )
 8089               WHEN 4
 8090                IF gotit% THEN BPUT#c%," "+FNungstrans(FNprinter_read_string(j%! 0 ))
 8091                IF gotit% THEN BPUT#c%," "+FNungstrans(FNprinter_read_string(j%! 4 ))
 8092               WHEN 7
 8093                IF gotit% THEN BPUT#c%," ";
 8094                IF gotit% THEN PROCfollow_pointer(!j%! 0 ,psup%,c%,level%)
 8095                IF gotit% THEN BPUT#c%,", ";
 8096                IF gotit% THEN PROCfollow_pointer(!j%! 4 ,psup%,c%,level%)
 8097              ENDCASE
 8098             WHEN 6
 8099              k%=j%
 8100              l%=0
 8101              WHILE k%
 8102               l%+=1
 8103               k%=!k%
 8104              ENDWHILE
 8105              IF gotit% THEN BPUT#c%,STR$ l%
 8106              WHILE j%
 8107               IF 0<=j%! 4 -1 THEN
 8108                 FOR k%=0 TO j%! 4 -1
 8109                  l%=j%!(k%*4+ 8 )
 8110                  CASE l%!-4 OF
 8111                   WHEN  &47544E49 
 8112                    IF gotit% THEN BPUT#c%," "+STR$ !l%+", ";
 8113                   WHEN  &47525453 
 8114                    IF gotit% THEN BPUT#c%," "+$l%+", ";
 8115                   WHEN  &30525453 
 8116                    CALL Z%,l%,s$  
 8117                    IF gotit% THEN BPUT#c%," "+s$+", ";
 8118                   WHEN  &52545347 
 8119                    CALL Y%,l%,s$  
 8120                    IF gotit% THEN BPUT#c%," "+FNungstrans(s$)+", ";
 8121                   WHEN  &52544F50 
 8122                    IF gotit% THEN PROCfollow_pointer (!l%, psup%, c%, level%)
 8123                    IF gotit% THEN BPUT#c%, "##"
 8124                  ENDCASE
 8125                 NEXT
 8126               ENDIF
 8127               IF gotit% THEN PTR#c%=PTR#c%-2
 8128               IF gotit% THEN BPUT#c%,10
 8129               j%=!j%
 8130              ENDWHILE
 8131             WHEN 7
 8132              IF gotit% THEN PROCfollow_pointer (!j%, psup%, c%, level%)
 8133             WHEN 8
 8134              k%=j%
 8135              l%=0
 8136              WHILE k%
 8137               l%+=1
 8138               k%=!k%
 8139              ENDWHILE
 8140              IF gotit% THEN BPUT#c%,STR$ l%
 8141              WHILE j%
 8142               s$=CHR$ j%?4
 8143               IF 1<=j%?5 THEN
 8144                FOR k%=1 TO j%?5
 8145                 s$+=CHR$ j%?(k%+5)
 8146                NEXT
 8147               ENDIF
 8148               IF gotit% THEN BPUT#c%," "+FNungstrans(s$)
 8149               j%=!j%
 8150              ENDWHILE
 8151            ENDCASE
 8152           ENDIF
 8153           ntry%=ntry%! 0 
 8154           i%+=4
 8155          ENDWHILE
 8156          IF gotit% THEN BPUT#c%,"#"
 8157       ENDIF
 8158       prdt%=prdt%! 0 
 8159      ENDWHILE
 8160     CLOSE#c%
 8161     SYS "XOS_File",18,"<Wimp$ScrapDir>.Printers."+name$,&FC6  
 8162     SYS "XOS_File", 4, "<Wimp$ScrapDir>.Printers."+name$,,,,3  
 8163    ENDIF
 8164   ENDIF
 8165   SYS "Hourglass_Off"
 8166 ENDPROC
 8167 DEF PROCfollow_pointer (ptr%, psup%, c%, level%)
 8168   LOCAL template$, tmpt%, ntry%, found%, i%, j%, ptr$, tmp%, k%, l%, p%, s$
 8169   level% += 1
 8170   ptr$ = FNdiscover_ptr (ptr%, psup%)
 8171   ntry% = INSTR(ptr$, ":")
 8172   template$ = MID$(ptr$, 1, ntry% - 1)
 8173   tmpt% = psup%! 8 
 8174   found% =  0 
 8175   WHILE tmpt% AND NOT found%
 8176     IF $(tmpt%+ 12 ) = template$ THEN
 8177       found% =  -1 
 8178     ELSE
 8179       tmpt% = tmpt%! 0 
 8180     ENDIF
 8181   ENDWHILE
 8182   IF NOT found% AND NOT tmpt% THEN
 8183     ENDPROC
 8184   ENDIF
 8185   BPUT#c%, " "+template$+":"
 8186   ntry%=tmpt%! 4 
 8187   i% = FNfix_up_prdata_pointer (ptr$)
 8188 REM  WHILE (i%!(i%! 4 *4+ 8 ) = 0) AND (i% > 0)
 8189 REMFtracef ("Zero usage prdt, skipping")
 8190 REM    i% = i%! 0 
 8191 REM  ENDWHILE
 8192   IF i% = 0 THEN
 8193     ENDPROC
 8194   ENDIF
 8195   i% = i%+ 8 
 8196   WHILE ntry%
 8197    BPUT#c%,$(ntry%+ 16 )+" ";
 8198    IF !i%=0 THEN
 8199     IF ntry%! 4 =6 THEN
 8200       BPUT#c%,48  
 8201     ELSE
 8202       IF ntry%! 4 =1 THEN
 8203         BPUT#c%,48  
 8204       ENDIF
 8205     ENDIF
 8206     BPUT#c%,10
 8207    ELSE
 8208     j%=!i%  
 8209     CASE ntry%! 4  OF
 8210      WHEN 1
 8211       BPUT#c%,STR$ !j%
 8212      WHEN 2
 8213       BPUT#c%,FNprinter_read_string(j%)
 8214      WHEN 3
 8215       BPUT#c%,FNprinter_read_string(j%)
 8216      WHEN 4
 8217       BPUT#c%,FNungstrans(FNprinter_read_string(j%))
 8218      WHEN 5
 8219       BPUT#c%,10
 8220       CASE ntry%! 8  OF
 8221        WHEN 1
 8222         BPUT#c%," "+STR$ !j%! 0 +", "+STR$ !j%! 4 
 8223        WHEN 2
 8224         BPUT#c%," "+FNprinter_read_string(j%! 0 )
 8225         BPUT#c%," "+FNprinter_read_string(j%! 4 )
 8226        WHEN 3
 8227         BPUT#c%," "+FNprinter_read_string(j%! 0 )
 8228         BPUT#c%," "+FNprinter_read_string(j%! 4 )
 8229        WHEN 4
 8230         BPUT#c%," "+FNungstrans(FNprinter_read_string(j%! 0 ))
 8231         BPUT#c%," "+FNungstrans(FNprinter_read_string(j%! 4 ))
 8232        WHEN 7
 8233         BPUT#c%," ";
 8234         PROCfollow_pointer(!j%! 0 ,psup%,c%,level%)
 8235         BPUT#c%,", ";
 8236         PROCfollow_pointer(!j%! 4 ,psup%,c%,level%)
 8237       ENDCASE
 8238      WHEN 6
 8239       k%=j%
 8240       l%=0
 8241       WHILE k%  
 8242        l%+=1
 8243        k%=!k%
 8244       ENDWHILE
 8245       BPUT#c%,STR$ l%
 8246       WHILE j%
 8247        IF 0<=j%! 4 -1 THEN
 8248          FOR k%=0 TO j%! 4 -1
 8249           l%=j%!(k%*4+ 8 )
 8250           CASE l%!-4 OF
 8251            WHEN  &47544E49 
 8252             BPUT#c%," "+STR$ !l%+", ";
 8253            WHEN  &47525453 
 8254             BPUT#c%," "+$l%+", ";
 8255            WHEN  &30525453 
 8256             CALL Z%,l%,s$  
 8257             BPUT#c%," "+s$+", ";
 8258            WHEN  &52545347 
 8259             CALL Y%,l%,s$  
 8260             BPUT#c%," "+FNungstrans(s$)+", ";
 8261            WHEN  &52544F50 
 8262             PROCfollow_pointer (!l%, psup%, c%,level%)
 8263             BPUT#c%, "##"  
 8264           ENDCASE
 8265          NEXT
 8266        ENDIF
 8267        PTR#c%=PTR#c%-2
 8268        BPUT#c%,10
 8269        j%=!j%
 8270       ENDWHILE
 8271      WHEN 7
 8272       PROCfollow_pointer (!j%, psup%, c%,level%)
 8273      WHEN 8
 8274       k%=j%
 8275       l%=0
 8276       WHILE k%
 8277        l%+=1
 8278        k%=!k%
 8279       ENDWHILE
 8280       BPUT#c%,STR$ l%
 8281       WHILE j%
 8282        s$=CHR$ j%?4
 8283        IF 1<=j%?5 THEN
 8284         FOR k%=1 TO j%?5
 8285          s$+=CHR$ j%?(k%+5)
 8286         NEXT
 8287        ENDIF
 8288        BPUT#c%," "+FNungstrans(s$)
 8289        j%=!j%
 8290       ENDWHILE
 8291     ENDCASE
 8292    ENDIF
 8293    ntry%=ntry%! 0 
 8294    i%+=4
 8295   ENDWHILE
 8296   BPUT#c%,"#"
 8297 ENDPROC
 8298 DEF FNfix_up_prdata_pointer(s$)
 8299   LOCAL j%,k%,t$
 8300   j%=INSTR(s$,":")
 8301   t$=MID$(s$,j%+1)
 8302   s$=LEFT$(s$,j%-1)
 8303   j%=psup%! 8 
 8304   k%=0
 8305   WHILE j%
 8306    IF$(j%+ 12 )=s$ THEN
 8307     j%=psup%! 12 
 8308     WHILE k%
 8309      j%=j%! 0 
 8310      k%-=1
 8311     ENDWHILE
 8312     k%=VAL t$-1
 8313     j%=j%! 4 
 8314     WHILE (j%!(j%! 4 *4+ 8 ) = 0) AND (j% > 0)  
 8315      j% = j%! 0 
 8316     ENDWHILE
 8317     WHILE k%
 8318      j%=j%! 0 
 8319      IF j%!(j%! 4 *4+ 8 ) THEN
 8320       k%-=1
 8321      ENDIF
 8322     ENDWHILE
 8323     =j%
 8324    ELSE
 8325     j%=j%! 0 
 8326     k%+=1
 8327    ENDIF
 8328   ENDWHILE
 8329   PROCerror_warning(FNmsg_2(A%! 12 ,"FAG",s$,t$))
 8330 =0
 8331 DEF PROCactivate_this_remote_printer(prnt%, ret_error%, RETURN error%)
 8332   error% =  0 
 8333   prnt%! 24 =prnt%! 24  OR  1 
 8334   cnct%=prnt%! 12 
 8335   PROCcreate_printer_icon(prnt%)
 8336   PROCflush_queue(prnt%)
 8337   IF A%! 44 =1 THEN
 8338     PROCselect_remote_printer(prnt%, -1 , 0 , ret_error%, error%)
 8339   ENDIF
 8340 ENDPROC
 8341 DEF PROCselect_remote_printer(prnt%,permanent%,restore%, ret_error%, RETURN error%)
 8342   LOCAL old_prnt%,i%,s$
 8343   error% =  0 
 8344   old_prnt%=selected_prnt%
 8345   IF NOT restore% selected_prnt%=prnt%  
 8346   IF selected_prnt%=0 ENDPROC  
 8347   s$=FNselect_connection(selected_prnt%, 0 )
 8348   IF s$<>"" THEN
 8349     IF permanent% THEN
 8350      selected_prnt%! 24  = selected_prnt%! 24  AND NOT  2 
 8351     ENDIF
 8352     selected_prnt%! 24  = selected_prnt%! 24  OR  4 
 8353     PROCprinter_status(selected_prnt%)
 8354     PROCredraw_queue_entry(-1,selected_prnt%,0)
 8355     IF selected_prnt%=old_prnt% THEN
 8356       PROCicon_deselect(-1,old_prnt%! 20 )
 8357       old_prnt%=0
 8358     ENDIF
 8359     selected_prnt%=old_prnt%
 8360     IF ret_error% THEN
 8361       error% =  -1 
 8362     ELSE
 8363       PROCerror_warning(s$)
 8364     ENDIF
 8365     ENDPROC
 8366   ENDIF
 8367   PROCprinter_reason_code(selected_prnt%! 4 ,selected_prnt%,-6,0)
 8368   PROCset_page_size(selected_prnt%)
 8369   PROCtell_the_world
 8370   IF permanent% THEN
 8371     IF old_prnt% THEN
 8372       PROCicon_deselect(-1,old_prnt%! 20 )
 8373       old_prnt%! 24 =old_prnt%! 24  AND NOT  2 
 8374     ENDIF
 8375     selected_prnt%! 24 =selected_prnt%! 24  OR  2 
 8376     PROCicon_select(-1,selected_prnt%! 20 )
 8377     SYS "PDriver_Info" TO,,,,i%
 8378     IF ?i%       CALL Z%,i%,s$:         SYS "OS_SetVarVal","Printer$",i%,LEN s$
 8379   ELSE
 8380     selected_prnt%=old_prnt%
 8381   ENDIF
 8382 ENDPROC
 8383 REM > Support - for dot matrix printers
 8384 DEF FNdp_support(buff%)
 8385   LOCAL reason%,psup%,prnt%,prdt%,cnfg%,xbuff%,psize_head%,code_entry%
 8386   VDU: PROCftracef("FNdp_support")
 8387   reason%=buff%!0
 8388   psup%=buff%!4
 8389   prnt%=buff%!8
 8390   xbuff%=buff%!12
 8391   psize_head%=buff%!16
 8392   code_entry%=buff%!20
 8393   IF prnt% THEN
 8394     prdt%=FNprinter_find_prdata_entry(psup%,$prnt%! 8 )
 8395     cnfg%=prnt%! 16 
 8396   ENDIF
 8397   CASE reason% OF
 8398     WHEN -1: PROCdp_m1
 8399     WHEN -2: PROCdp_m2
 8400     WHEN -3: PROCdp_m3
 8401     WHEN -4: PROCdp_m4
 8402     WHEN -5: PROCdp_m5
 8403     WHEN -6: PROCdp_m6
 8404     WHEN -7: PROCdp_m7
 8405     WHEN -8: PROCdp_m8
 8406     WHEN 3: PROCdp_p3
 8407     WHEN 6: PROCdp_p6
 8408     WHEN 8: PROCdp_p8
 8409     WHEN 9: PROCdp_p9
 8410     WHEN 17,18: PROCdp_p17
 8411   ENDCASE
 8412 = 0 
 8413 DEF PROCdp_m1
 8414   LOCAL colours%, pdriverdp%, exists%
 8415   VDU: PROCftracef("PROCdp_m1")
 8416   REM psup%! 24  OR= 0
 8417   psup%! 28 =&FF4
 8418   psup%! 32 =%0100
 8419   psup%! 36 = 16 /4
 8420   psup%! 40 =2
 8421   REM note that the version number really only reflects
 8422   REM the status of the files being read, ie only change
 8423   REM this number if the file contents change.
 8424   psup%! 44 =100
 8425   psup%! 52 =0
 8426   colours%=FNrmload_latest_module("ColourTrans","System:Modules.Colours")
 8427   IFFNrmload_latest_module("PDriver","Printers:Modules.PDriver")
 8428   IFFNrmload_latest_module("PDumperSupport","Printers:Modules.PDumperSpt")
 8429   pdriverdp%=FNrmload_latest_module("PDriverDP","Printers:Modules.PDriverDP")
 8430   REM ***** WARNING!
 8431   REM ***** THESE VERSION NUMBERS ARE HARD CODED!
 8432   IFpdriverdp%>400 AND colours%<150 THEN
 8433     SYS"Wimp_ReportError",FNmsg_0(FNdp_host_desc,"WA12"), 1 OR 1<<4,FNmsg_1(FNdp_host_desc,"ER2",FNmsg_0(FNdp_host_desc,"ID"))
 8434   ENDIF
 8435 DPQ$="S"
 8436 ENDPROC
 8437 DEF PROCdp_m2
 8438   VDU: PROCftracef("PROCdp_m2")
 8439 ENDPROC
 8440 DEF PROCdp_m3
 8441   REM initialise the configuration window
 8442   LOCAL config%,dp_i%,dp_j%
 8443   VDU: PROCftracef("PROCdp_m3")
 8444   config%=FNprinter_find_window(prnt%,"configure")
 8445   PROCicon_write(config%,30,FNprinter_read_string(prnt%! 40 ))
 8446   PROCicon_write(config%,6,$prnt%! 8 )
 8447   PROCicon_write(config%,3,FNdp_res(cnfg%))
 8448   PROCicon_write(config%,15,FNdp_qual(cnfg%))
 8449   dp_i%=!cnfg%! 0 
 8450   dp_j%=dp_i%>> 16  AND  15 
 8451   PROCicon_write(config%,17,FNmsg_0(psup%! 16 ,"PF"+STR$ dp_j%))
 8452   IF prnt%! 24  AND 1<<6 THEN
 8453     PROCicon_shade(config%,8)
 8454     PROCicon_shade(config%,11)
 8455     PROCicon_shade(config%,12)
 8456     PROCicon_shade(config%,14)
 8457     PROCicon_shade(config%,19)
 8458     PROCicon_shade(config%,23)
 8459     PROCicon_shade(config%,24)
 8460   ELSE
 8461     dp_j%=dp_i% AND %000010
 8462     IF dp_j% PROCicon_select(config%,8)ELSE PROCicon_deselect(config%,8)
 8463     dp_j%=dp_i% AND %000100
 8464     IF dp_j% PROCicon_select(config%,11)ELSE PROCicon_deselect(config%,11)
 8465     dp_j%=dp_i% AND %001000
 8466     IF dp_j% PROCicon_select(config%,12)ELSE PROCicon_deselect(config%,12)
 8467     dp_j%=(dp_i% AND %110000)>>4
 8468     PROCicon_write(config%,14,FNmsg_0(psup%! 16 ,"TQ"+STR$ dp_j%))
 8469     dp_j%=(dp_i% AND &F00)>>8
 8470     PROCicon_write(config%,23,FNmsg_0(psup%! 16 ,"CC"+STR$ dp_j%))
 8471   ENDIF
 8472   dp_i%=prnt%! 36 
 8473   PROCicon_write(config%,27,$dp_i%! 4 )
 8474 ENDPROC
 8475 DEF PROCdp_m4
 8476   REM create a CNFG block with suitable defaults
 8477   LOCAL dp_s$,dp_nm$,dp_nm2$,dp_i%,dp_s%,dp_t%,dp_co%,dp_ht%,B%,C%,dp_inf%,dp_x%,dp_y%
 8478   VDU: PROCftracef("PROCdp_m4")
 8479   REM OSS set the text options to be no highlights, Print linefeeds.
 8480   REM PJC: default changed to be draft with linefeeds.
 8481   cnfg%! 0 =FNstore_integer(%011000)
 8482   dp_i%=FNprinter_read_list_integer_entry(prdt%,5,2,1)
 8483   IF dp_i%=0 THEN
 8484     REM no draft - fall back to no highlights
 8485     !cnfg%! 0 =%001000
 8486     dp_i%=FNprinter_read_list_integer_entry(prdt%,5,1,1)
 8487   ENDIF
 8488   IF dp_i% THEN
 8489     B%= &52544F50 
 8490     C%=4
 8491     cnfg%! 4 =USR(code_entry%+ 12 )
 8492     IFcnfg%! 4 =0 ERROR  253 , FNmsg_0(FNdp_host_desc,"FA5")
 8493     !cnfg%! 4 =dp_i%
 8494   ELSE
 8495     prnt%! 24 =prnt%! 24  OR 1<<6
 8496   ENDIF
 8497   REM try to read the default x and y resolutions and name from the PRDT block
 8498   dp_x%=FNprinter_read_integer_entry(prdt%,8)
 8499   dp_y%=FNprinter_read_integer_entry(prdt%,9)
 8500   dp_nm$=FNprinter_read_string_entry(prdt%,12)
 8501   IF dp_nm$<>"" THEN
 8502     REM try to find the graphics mode which matches this name
 8503     C%=1
 8504     REPEAT
 8505       B%=FNprinter_read_list_integer_entry(prdt%,4,C%,1)
 8506       IF B%=0 THEN
 8507         C%=-1
 8508       ELSE
 8509         dp_nm2$=FNprinter_read_string_entry(B%,8)
 8510         REM if no match, try the next mode
 8511         IFdp_nm$<>dp_nm2$ C%+=1
 8512       ENDIF
 8513     UNTIL C%=-1 OR dp_nm$=dp_nm2$
 8514     REM if we found it, remember where it was
 8515     IF C%<>-1 dp_i%=C%
 8516   ELSE
 8517     IF (dp_x%<>0 AND dp_y%<>0) THEN
 8518       REM try to find the graphics mode which matches this resolution
 8519       C%=1
 8520       REPEAT
 8521         B%=FNprinter_read_list_integer_entry(prdt%,4,C%,1)
 8522         IF B%=0 THEN
 8523           C%=-1
 8524         ELSE
 8525           dp_s%=FNprinter_read_integer_entry(B%,4)
 8526           dp_t%=FNprinter_read_integer_entry(B%,5)
 8527           REM if no match, try the next mode
 8528           IFdp_s%<>dp_x% OR dp_t%<>dp_y% C%+=1
 8529         ENDIF
 8530       UNTIL C%=-1 OR (dp_s%=dp_x% AND dp_t%=dp_y%)
 8531       REM if we found it, remember where it was
 8532       IF C%<>-1 dp_i%=C%
 8533     ELSE
 8534       REM show we didn't match - which we couldn't 'cos we didn't have the values
 8535       C%=-1
 8536     ENDIF
 8537   ENDIF
 8538   IF C%=-1 THEN
 8539     REM OSS set the graphics options to be the highest non-interlaced resolution
 8540     B%= &46424450 
 8541     C%=256
 8542     dp_inf%=USR(code_entry%+ 12 )
 8543     IFdp_inf%=0 ERROR  253 , FNmsg_0(FNdp_host_desc,"FA5")
 8544     C%=1
 8545     dp_i%= 0 
 8546     REPEAT
 8547       B%=FNprinter_read_list_integer_entry(prdt%,4,C%,1)
 8548       IF B%=0 THEN
 8549         REM run out of parameters, go back to the last one
 8550         C%-=1
 8551         dp_i%= -1 
 8552       ELSE
 8553         $dp_inf%=FNprinter_read_string_entry(B%,6)
 8554         IF dp_inf%? 1 =0 AND dp_inf%? 2 =0 THEN
 8555           C%+=1
 8556         ELSE
 8557           C%-=1
 8558           dp_i%= -1 
 8559         ENDIF
 8560       ENDIF
 8561     UNTIL dp_i%
 8562     dp_i%=C%
 8563     B%= &46424450 
 8564     C%=dp_inf%
 8565     CALL code_entry%+ 16 
 8566   ENDIF
 8567   B%= &52544F50 
 8568   C%=4
 8569   cnfg%! 8 =USR(code_entry%+ 12 )
 8570   IFcnfg%! 8 =0 ERROR  253 , FNmsg_0(FNdp_host_desc,"FA5")
 8571   !cnfg%! 8 =FNprinter_read_list_integer_entry(prdt%,4,dp_i%,1)
 8572   REM ensure that the module is present in memory
 8573   dp_s$=FNprinter_read_string_entry(FNprinter_read_integer_entry(!cnfg%! 8 ,1),2)
 8574   IFFNrmload_latest_module(dp_s$,"Printers:PDumpers."+dp_s$)
 8575   REM ensure that the palette file needed at the resolution is cached
 8576   REM bit 23 of palette no. flags whether already ensured or not
 8577   dp_s$=STR$(FNprinter_read_integer_entry(!cnfg%! 8 ,2) AND &7FFFFF)
 8578   PROCdp_ensure_resource_file("Resources.Printers.Palettes."+dp_s$,"Printers:Palettes."+dp_s$,!cnfg%! 8 )
 8579   REM initialise the quality
 8580   REM see if a quality was provided in the PDF
 8581   dp_i%=FNprinter_read_integer_entry(prdt%,10)
 8582   REM get the qualities available at the configured resolution
 8583   dp_s%=FNdp_get_quality_options(!cnfg%! 8 )
 8584   IF dp_i%<>0 THEN
 8585     dp_co%=dp_i% AND &FF
 8586     dp_ht%=(dp_i% AND &FF00)>>8
 8587     CASE dp_co% OF
 8588       WHEN 0: REM mono
 8589         IF (dp_s% AND 7) THEN
 8590           IF dp_ht%=4 AND (dp_s% AND 1)=0 dp_i%=0
 8591           IF dp_ht%=8 AND (dp_s% AND 2)=0 dp_i%=0
 8592           IF dp_ht%=1 AND (dp_s% AND 4)=0 dp_i%=0
 8593         ELSE
 8594           dp_i%=0
 8595         ENDIF
 8596       WHEN 1: REM greyscale
 8597         IF (dp_s% AND &70) THEN
 8598           IF dp_ht%=4 AND ((dp_s%>>4) AND 1)=0 dp_i%=0
 8599           IF dp_ht%=8 AND ((dp_s%>>4) AND 2)=0 dp_i%=0
 8600           IF dp_ht%=1 AND ((dp_s%>>4) AND 4)=0 dp_i%=0
 8601         ELSE
 8602           dp_i%=0
 8603         ENDIF
 8604       WHEN 2: REM colour
 8605         IF (dp_s% AND &700) THEN
 8606           IF dp_ht%=4 AND ((dp_s%>>8) AND 1)=0 dp_i%=0
 8607           IF dp_ht%=8 AND ((dp_s%>>8) AND 2)=0 dp_i%=0
 8608           IF dp_ht%=1 AND ((dp_s%>>8) AND 4)=0 dp_i%=0
 8609         ELSE
 8610           dp_i%=0
 8611         ENDIF
 8612     ENDCASE
 8613   ENDIF
 8614   IF dp_i%<>0 THEN
 8615     cnfg%! 12 =FNstore_integer(dp_i%)
 8616   ELSE
 8617     PROCdp_decode_options(dp_s%,dp_co%,dp_ht%)
 8618     cnfg%! 12 =FNstore_integer(dp_ht%<<8 OR dp_co%)
 8619   ENDIF
 8620   $buff%=FNprinter_read_string_entry(prdt%,2)
 8621   B%=buff%
 8622   C%=2
 8623   prnt%! 40 =USR(code_entry%+ 28 )
 8624   dp_s$=FNprinter_read_string_entry(prdt%,3)
 8625   IF dp_s$<>"dp" $buff%=dp_s$:B%=buff%:C%=2:prnt%! 44 =USR(code_entry%+ 28 )
 8626   REM initialise the best paper size we can find ...
 8627   REM start by trying to read the 'default_paper_size' entry
 8628   REM from the PRDT block (entry 7)
 8629   dp_s$=FNprinter_read_string_entry(prdt%,7)
 8630   REM fall back to going for the default
 8631   IF dp_s$="" dp_s$=FNmsg_0(psup%! 16 ,"PAP")
 8632   dp_i%=psize_head%
 8633   WHILE dp_s$<>FNprinter_read_string(dp_i%! 4 )
 8634     dp_i%=dp_i%! 0 
 8635     REM if we run out of paper entries, go for the first one
 8636     IF dp_i%=0 dp_i%=psize_head%: dp_s$=FNprinter_read_string(dp_i%! 4 )
 8637   ENDWHILE
 8638   prnt%! 36 =dp_i%
 8639   REM if this printer supports fast parallel, set the appropriate flag
 8640   dp_i%=FNprinter_read_integer_entry(prdt%,11)
 8641   IFdp_i%<>0 prnt%! 24  = prnt%! 24  OR (1<<7)
 8642 ENDPROC
 8643 DEF PROCdp_ensure_resource_file(resource$,disc$,gprdt%)
 8644   LOCAL obj_type%,load_addr%,exec_addr%,file_size%,obj_attr%,rma_size%,rma_block%
 8645   LOCAL found_type%,found_load%,found_exec%,found_size%,c%,a%,w%,pnum%,reload_if_outofdate%
 8646   VDU: PROCftracef("dp_ensure_resource_file")
 8647   REM We use this to load palette files for the printers in order to reduce
 8648   REM the probability of having to ask for the printers disc again later.
 8649   REM check for out of date palette if we have not ensured this one before (bit 23 of palette number)
 8650   pnum% = FNprinter_read_integer_entry(gprdt%,2)
 8651   reload_if_outofdate% = ((pnum% AND &800000) = 0)
 8652   PROCprinter_write_integer_entry(gprdt%,2,pnum% OR &800000):REM we (will) have ensured it
 8653   REM First of all, check if the file exists already
 8654   SYS "OS_File",17,"Resources:"+resource$ TO found_type%,,found_load%,found_exec%,found_size%: REM OS_FileReadNoPath
 8655   IF found_type% AND reload_if_outofdate%= 0  ENDPROC
 8656   SYS "OS_File",17,disc$ TO obj_type%,,load_addr%,exec_addr%,file_size%,obj_attr%: REM OS_FileReadNoPath
 8657   IF obj_type%<>1 SYS "OS_File",19,disc$,obj_type%: REM OS_FileMakeError
 8658   IF found_type% THEN
 8659     IFfound_load%=load_addr% AND found_exec%=exec_addr% AND found_size%=file_size% ENDPROC
 8660     REM cached palette is not the same as the one on disc
 8661     REM try to remove the cached palette
 8662     c%=OPENIN("Resources:"+resource$)
 8663     IFc%=0 ERROR  254 , FNmsg_1(FNdp_host_desc,"OKBB",resource$)
 8664     SYS"OS_FSControl",21,c% TO ,a%,w%
 8665     CLOSE#c%
 8666     IF(w%AND&FF)<>46 ERROR  254 , FNmsg_1(FNdp_host_desc,"OKBC",resource$)
 8667     a%-=(LENresource$+4ANDNOT3)+4
 8668     a%-=20
 8669     IFa%!-4 = &48434143 THEN
 8670       SYS"ResourceFS_DeregisterFiles",a%
 8671       SYS"OS_Module",7,,a%-4
 8672     ENDIF
 8673   ENDIF
 8674   rma_size%=20+(LEN resource$+4 AND NOT 3)+4+(file_size%+3 AND NOT 3): REM Size needed for this file only
 8675   VDU: PROCftracef("File "+disc$+", size "+STR$ file_size%)
 8676   REM claim some RMA for the file
 8677   SYS "OS_Module",6,,,rma_size%+8 TO,,rma_block%: REM OSModule_Alloc
 8678   REM Put a check tag at the beginning of the block
 8679   !rma_block%=&48434143:REM CACH
 8680   rma_block%+=4
 8681   rma_block%!0=rma_size%
 8682   rma_block%!4=load_addr%
 8683   rma_block%!8=exec_addr%
 8684   rma_block%!12=file_size%
 8685   rma_block%!16=obj_attr%
 8686   $(rma_block%+20)=resource$
 8687   rma_block%!(20+LEN resource$)=0  
 8688   rma_block%!(20+(LEN resource$+4 AND NOT 3))=file_size%+4
 8689   SYS "OS_File",16,disc$,rma_block%+20+(LEN resource$+4 AND NOT 3)+4: REM OS_FileLoadNoPath
 8690   rma_block%!rma_size%=0: REM Terminator
 8691   SYS "ResourceFS_RegisterFiles",rma_block%
 8692 ENDPROC
 8693 DEF PROCdp_m5
 8694   REM cache any palette files that are used by dp printers and ensure
 8695   REM that the relevant PDumper modules are loaded
 8696   LOCAL dp_prnt%,dp_cnfg%,dp_graphics_prdt%,dp_pal$
 8697   VDU: PROCftracef("PROCdp_m5")
 8698   dp_prnt%=prnt%
 8699   WHILE dp_prnt%>0
 8700     IF dp_prnt%! 4 =psup% THEN
 8701       REM got a printer in our class - cache the palette file
 8702       dp_cnfg%=dp_prnt%! 16 
 8703       dp_graphics_prdt%=!dp_cnfg%! 8 
 8704       REM bit 23 of palette no. flags whether already ensured or not
 8705       dp_pal$=STR$(FNprinter_read_integer_entry(dp_graphics_prdt%,2) AND &7FFFFF)
 8706       PROCdp_ensure_resource_file("Resources.Printers.Palettes."+dp_pal$,"Printers:Palettes."+dp_pal$,dp_graphics_prdt%)
 8707       REM and ensure the pdumper module
 8708       dp_pal$=FNprinter_read_string_entry(FNprinter_read_integer_entry(dp_graphics_prdt%,1),2)
 8709       IFFNrmload_latest_module(dp_pal$, "Printers:PDumpers."+dp_pal$)
 8710     ENDIF
 8711     dp_prnt%=dp_prnt%! 0 
 8712   ENDWHILE
 8713 ENDPROC
 8714 DEF PROCdp_m6
 8715   REM do whatever is necessary to prime the specified printer
 8716   LOCAL dp_s$,dp_t$,dp_i%,xres%,yres%,halftone%,ptr%,flags%,pal%,dmp$,inf%,strip%,graphics_prdt%,text_prdt%,B%,C%
 8717   VDU: PROCftracef("PROCdp_m6")
 8718   REM 7 is the magic number for the dumper driver
 8719   SYS "XPDriver_SelectDriver",7
 8720   dp_s$=FNprinter_read_string(prnt%! 40 )
 8721   IF dp_s$="" THEN
 8722     dp_s$=$prnt%! 8 
 8723     IF LEN dp_s$>20 THEN
 8724       dp_i%=LEN dp_s$
 8725       WHILE MID$(dp_s$,dp_i%,1)<>" " AND dp_i%>0
 8726         dp_i%-=1
 8727       ENDWHILE
 8728       IF dp_i% dp_s$=LEFT$(dp_s$,dp_i%-1)ELSE dp_s$=LEFT$(dp_s$,20)
 8729     ENDIF
 8730   ENDIF
 8731   graphics_prdt%=!cnfg%! 8 
 8732   xres%=FNprinter_read_integer_entry(graphics_prdt%,4)
 8733   yres%=FNprinter_read_integer_entry(graphics_prdt%,5)
 8734   halftone%=(!cnfg%! 12  AND &FF00)>>8
 8735   strip%=!cnfg%! 12  AND &FF
 8736   REM WARNING!
 8737   REM The comparison is made against strip type 2 (colour) or greater
 8738   REM This assumes, therefore, that any strip types that are 2 or greater
 8739   REM are colour which is currently true
 8740   IF (strip% >= 2) THEN
 8741    SYS"XPDriver_SetInfo",,xres%,yres%,1,dp_s$,xres%/halftone%,yres%/halftone% TO ptr%;dp_i%
 8742   ELSE
 8743    SYS"XPDriver_SetInfo",,xres%,yres%,0,dp_s$,xres%/halftone%,yres%/halftone% TO ptr%;dp_i%
 8744   ENDIF
 8745   IF (dp_i% AND 1) AND (ptr%<>0) THEN
 8746     dp_s$="": ptr%+=4
 8747     WHILE ?ptr%: dp_s$+=CHR$ ?ptr%: ptr%+=1: ENDWHILE
 8748     ERROR  254 ,dp_s$
 8749     ENDPROC
 8750   ENDIF
 8751   REM bit 23 of palette no. flags whether already ensured or not
 8752   dp_s$=STR$(FNprinter_read_integer_entry(graphics_prdt%,2) AND &7FFFFF)
 8753   B%= &46424450 
 8754   C%=256
 8755   pal%=USR(code_entry%+ 12 )
 8756   IFpal%=0 ERROR  253 , FNmsg_0(FNdp_host_desc,"FA5")
 8757   $pal%="Resources:$.Resources.Printers.Palettes."+dp_s$
 8758   inf%=USR(code_entry%+ 12 )
 8759   IFinf%=0 ERROR  253 , FNmsg_0(FNdp_host_desc,"FA5")
 8760   $inf%=FNprinter_read_string_entry(graphics_prdt%,6)
 8761   strip%=!cnfg%! 12  AND &FF
 8762   IF strip%=5 THEN
 8763    dp_i%=FNprinter_read_integer_entry(graphics_prdt%,1)
 8764    dp_i%=FNprinter_read_integer_entry(dp_i%,1)
 8765    SYS"XPDriver_MiscOp",&80000002,dp_i% TO ptr%;dp_i%
 8766    IF(dp_i%AND1)=0 IFptr%<>&80000002 IF(ptr% AND (1<<5))=0 strip%=3
 8767   ENDIF
 8768   PROCdp_ensure_resource_file("Resources.Printers.Palettes."+dp_s$,"Printers:Palettes."+dp_s$,graphics_prdt%)
 8769   REM Module name:
 8770   dp_s$=FNprinter_read_string_entry(FNprinter_read_integer_entry(graphics_prdt%,1),2)
 8771   dmp$="RMLoad Printers:PDumpers."+dp_s$+CHR$ 13
 8772   REM set passes per line entry
 8773   REM WARNING!
 8774   REM The comparison is made against strip type 2 (colour) or greater
 8775   REM This assumes, therefore, that any strip types that are 2 or greater
 8776   REM are colour which is currently true
 8777   IF strip%>=2 inf%? 3 =4 ELSE inf%? 3 =1
 8778   REM set strip type field
 8779   inf%? 4 =strip%
 8780   REM set output bpp field
 8781   IF strip%=0 inf%? 5 =1 ELSE inf%? 5 =8
 8782   REM set num passes field
 8783   IF strip%=3 inf%? 6 =3 ELSE inf%? 6 =1
 8784   REM OSS Set the NoPageAdvance bit in the flags if paper feed is "Roll"
 8785   flags%=FNprinter_read_integer_entry(graphics_prdt%,7)
 8786   IF(!cnfg%! 0 >> 16  AND  15 )= 2  flags%+=2
 8787   REM OSS Fixup old version numbers by moving it to the new location.
 8788   IF(flags%>>>24)=0 flags%=flags% OR inf%? 8 <<24
 8789   REM OSS Set lines per page if version>0. We only need to check the new
 8790   REM version field as the fixup has already been done.
 8791   IF(flags%>>>24)>0 THEN
 8792     dp_i%=prnt%! 36 
 8793     inf%? 34 =dp_i%! 48 
 8794   ENDIF
 8795   SYS "XPDriver_SetDriver",,FNprinter_read_integer_entry(FNprinter_read_integer_entry(graphics_prdt%,1),1),dmp$,pal%,inf%,flags%
 8796   B%= &46424450 
 8797   C%=pal%
 8798   CALL code_entry%+ 16 
 8799   C%=inf%
 8800   CALL code_entry%+ 16 
 8801   SYS "OS_CLI","Unset PDriver$TextChars1"
 8802   REM point to the chars PRDT block
 8803   dp_i%=FNprinter_read_integer_entry(prdt%,6)
 8804   IF dp_i% THEN
 8805     dp_i%=dp_i%! 8 
 8806     WHILE dp_i%
 8807       IF dp_i%? 4 =ASC"" THEN
 8808         dp_s$=FNdp_hex2(ASC "")+FNdp_hex2(dp_i%? 5 )
 8809         ptr%=dp_i%+ 6 : dp_i%=dp_i%? 5 
 8810         WHILE dp_i%
 8811           dp_s$+=FNdp_hex2(?ptr%)
 8812           ptr%+=1
 8813           dp_i%-=1
 8814         ENDWHILE
 8815         SYS"OS_CLI","Set PDriver$TextChars1 "+dp_s$
 8816       ELSE
 8817         dp_i%=dp_i%! 0 
 8818       ENDIF
 8819     ENDWHILE
 8820   ENDIF
 8821   IF cnfg%! 4 =0 THEN
 8822     SYS"OS_CLI","Unset PDriver$TextPage"
 8823   ELSE
 8824     text_prdt%=!cnfg%! 4 
 8825     dp_i%=prnt%! 36 
 8826     dp_s$="-Ph "+STR$ dp_i%! 48 +" -Mt "+STR$ dp_i%! 36 +" -Mb "
 8827     dp_s$+=STR$ dp_i%! 32 +" -Ml "+STR$ dp_i%! 40 +" -Th "
 8828     IF cnfg%! 0  AND 2 dp_s$+="2" ELSE dp_s$+="0"
 8829     dp_s$+=" -Nl "
 8830     IF cnfg%! 0  AND 8 THEN
 8831       dp_s$+=FNungstrans(FNungstrans(FNprinter_read_string_entry(text_prdt%,6)))
 8832     ELSE
 8833       dp_s$+=FNungstrans(FNungstrans(FNprinter_read_string_entry(text_prdt%,5)))
 8834     ENDIF
 8835     dp_t$=FNprinter_read_string_entry(text_prdt%,7)
 8836     IF dp_t$<>"" dp_s$+=" -Rs "+FNungstrans(FNungstrans(dp_t$))
 8837     dp_t$=FNprinter_read_string_entry(text_prdt%,11)
 8838     IF dp_t$<>"" dp_s$+=" -Cd "+FNungstrans(FNungstrans(dp_t$))
 8839     SYS"OS_CLI","Set PDriver$TextPage "+dp_s$
 8840   ENDIF
 8841 ENDPROC
 8842 DEF PROCdp_m7
 8843   LOCAL queu%,dp_p%,B%,C%
 8844   VDU: PROCftracef("PROCdp_m7")
 8845   queu%=!xbuff%
 8846   dp_p%=queu%! 48 
 8847   IF dp_p% THEN
 8848     PROCfree_structure(dp_p%! 4 )
 8849     B%= &56525054 
 8850     C%=dp_p%
 8851     CALL code_entry%+ 16 
 8852     queu%! 48 =0
 8853   ENDIF
 8854 ENDPROC
 8855 DEF PROCdp_p3
 8856   VDU: PROCftracef("PROCdp_p3")
 8857   SYS"Wimp_CloseWindow",,xbuff%
 8858 ENDPROC
 8859 DEF PROCdp_p6
 8860   LOCAL wind%
 8861   VDU: PROCftracef("PROCdp_p6")
 8862   REM mouseclick on the configure window
 8863   CASE xbuff%!8 OF
 8864     WHEN 2: REM menu
 8865       CASE xbuff%!16 OF
 8866         WHEN 20: PROCdp_menu("ME1", -1 , -1 )
 8867         WHEN 18: PROCdp_menu("ME2", -1 , -1 )
 8868         WHEN  4: PROCdp_menu("ME3", -1 , -1 )
 8869         WHEN 19: PROCdp_menu("ME4", -1 , -1 )
 8870         WHEN 24: PROCdp_menu("ME5", -1 , -1 )
 8871         WHEN 26: PROCdp_menu("MP1", -1 , -1 )
 8872       ENDCASE
 8873     WHEN 4: REM select
 8874       CASE xbuff%!16 OF
 8875         WHEN 25
 8876           wind%=xbuff%!12
 8877           PROCdp_save_configuration(wind%)
 8878           !xbuff%=wind%:SYS"Wimp_CloseWindow",,xbuff%
 8879         WHEN 20
 8880           PROCdp_menu("ME1", -1 , -1 )
 8881         WHEN 18
 8882           PROCdp_menu("ME2", -1 , -1 )
 8883         WHEN  4
 8884           PROCdp_menu("ME3", -1 , -1 )
 8885         WHEN 19
 8886           PROCdp_menu("ME4", -1 , -1 )
 8887         WHEN 24
 8888           PROCdp_menu("ME5", -1 , -1 )
 8889         WHEN 26
 8890           PROCdp_menu("MP1", -1 , -1 )
 8891         WHEN 31
 8892           !xbuff%=xbuff%!12
 8893           SYS"Wimp_CloseWindow",,xbuff%
 8894       ENDCASE
 8895     WHEN 1: REM adjust
 8896       CASE xbuff%!16 OF
 8897         WHEN 25
 8898           wind%=xbuff%!12
 8899           PROCdp_save_configuration(wind%)
 8900       ENDCASE
 8901   ENDCASE
 8902 ENDPROC
 8903 DEF PROCdp_p8
 8904   REM a key press!
 8905   LOCAL dp_i%
 8906   VDU: PROCftracef("PROCdp_p8")
 8907   dp_i%=psup%! 20 
 8908   WHILE dp_i%
 8909     IF dp_i%! 4 =!xbuff% THEN
 8910       IF xbuff%!24=13 THEN
 8911         CASE $(dp_i%+ 16 )OF
 8912           WHEN "configure"
 8913             SYS "Wimp_CloseWindow",,xbuff%
 8914             PROCdp_save_configuration(!xbuff%)
 8915         ENDCASE
 8916       ELSE
 8917         SYS "Wimp_ProcessKey",xbuff%!24
 8918       ENDIF
 8919       ENDPROC
 8920     ENDIF
 8921     dp_i%=dp_i%! 0 
 8922   ENDWHILE
 8923 ENDPROC
 8924 DEF PROCdp_p9
 8925   LOCAL adjust%,wind%,icon%,ptr%,xres%,yres%,dp_s$,dp_i%,dp_j%,dp_k%
 8926   VDU: PROCftracef("PROCdp_p9")
 8927   wind%=FNprinter_find_window(prnt%,"configure")
 8928   adjust%=FNwas_adjust_used
 8929   CASE dp_menu_chsn$ OF
 8930     WHEN "ME1": icon%=3
 8931     WHEN "ME2": icon%=17
 8932     WHEN "ME3": icon%=15
 8933     WHEN "ME4": icon%=14
 8934     WHEN "ME5": icon%=23
 8935     WHEN "MP1": icon%=27
 8936   ENDCASE
 8937   ptr%=dp_menu%+28+!xbuff%*24
 8938   IF ptr%!8 AND &100 THEN
 8939     PROCicon_write(wind%,icon%,$ptr%!12)
 8940   ELSE
 8941     PROCicon_write(wind%,icon%,$(ptr%+12))
 8942   ENDIF
 8943   IF dp_menu_chsn$="ME1" THEN
 8944     REM if the resolution changes, we may have to change the quality as well
 8945     dp_j%=prdt%!20
 8946     dp_s$=FNicon_read(wind%,3)
 8947     WHILE dp_j%
 8948       dp_k%=!dp_j%! 8 
 8949       IF (dp_s$=FNmsg_2(psup%! 16 ,"RES",STR$ !dp_k%!20,STR$ !dp_k%!24)) OR          (dp_s$=$(dp_k%!36)) THEN
 8950         dp_s$=FNicon_read(wind%,15): dp_i%=INSTR(dp_s$,",")
 8951         CASE LEFT$(dp_s$,dp_i%-1)OF
 8952           WHEN FNmsg_0(psup%! 16 ,"CO1"):  dp_j%=1
 8953           WHEN FNmsg_0(psup%! 16 ,"CO1s"): dp_j%=1
 8954           WHEN FNmsg_0(psup%! 16 ,"CO2"):  dp_j%=2
 8955           WHEN FNmsg_0(psup%! 16 ,"CO4"):  dp_j%=4
 8956           WHEN FNmsg_0(psup%! 16 ,"CO5"):  dp_j%=5
 8957           WHEN FNmsg_0(psup%! 16 ,"CO5s"): dp_j%=5
 8958           OTHERWISE:                                 dp_j%=0
 8959         ENDCASE
 8960         dp_s$=MID$(dp_s$,dp_i%+2)
 8961         CASE dp_s$ OF
 8962           WHEN FNmsg_0(psup%! 16 ,"HT8"):  dp_i%=8
 8963           WHEN FNmsg_0(psup%! 16 ,"HT8s"): dp_i%=8
 8964           WHEN FNmsg_0(psup%! 16 ,"HT1"):  dp_i%=1
 8965           WHEN FNmsg_0(psup%! 16 ,"HT1s"): dp_i%=1
 8966           OTHERWISE:                                 dp_i%=4
 8967         ENDCASE
 8968         dp_k%=FNdp_get_quality_options(dp_k%)
 8969         IF(dp_k% AND (7<<(dp_j%*4)))=0 dp_j%=-1
 8970         IF dp_j%<>-1 THEN
 8971           dp_j%=dp_k%>>(dp_j%*4)
 8972           CASE dp_i% OF
 8973             WHEN 4: IF(dp_j% AND 1)=0 dp_i%=-1
 8974             WHEN 8: IF(dp_j% AND 2)=0 dp_i%=-1
 8975             WHEN 1: IF(dp_j% AND 4)=0 dp_i%=-1
 8976           ENDCASE
 8977         ENDIF
 8978         IF dp_j%=-1 OR dp_i%=-1 THEN
 8979           PROCdp_decode_options(dp_k%,dp_j%,dp_i%)
 8980           PROCicon_write(wind%,15,FNdp_qual_name(dp_j% + (dp_i% << 8)))
 8981         ENDIF
 8982         dp_j%=0
 8983       ELSE
 8984         dp_j%=!dp_j%
 8985       ENDIF
 8986     ENDWHILE
 8987   ENDIF
 8988   IF adjust% THEN
 8989     SYS"Wimp_GetPointerInfo",,xbuff%
 8990     PROCdp_menu(dp_menu_chsn$, 0 , 0 )
 8991   ENDIF
 8992 ENDPROC
 8993 DEF PROCdp_p17
 8994   LOCAL wind%,dp_s$,dp_t$
 8995   VDU: PROCftracef("PROCdp_p17")
 8996   CASE xbuff%!16 OF
 8997     WHEN &502: REM HelpRequest
 8998       wind%=psup%! 20 
 8999       WHILE wind%
 9000         IF wind%! 4 =xbuff%!32 THEN
 9001           CASE $(wind%+ 16 )OF
 9002             WHEN "configure"
 9003               dp_s$=STR$ xbuff%!36
 9004               CASE xbuff%!36 OF
 9005                 WHEN 8,11,12: IF FNicon_set(xbuff%!32,xbuff%!36)dp_s$+="b" ELSE dp_s$+="a"
 9006               ENDCASE
 9007               dp_t$=FNmsg_0(psup%! 16 ,"CON"+dp_s$)
 9008               IFdp_t$="CON"+dp_s$ dp_t$=FNmsg_0(psup%! 16 ,"CON")
 9009               PROCinteractive_help(dp_t$)
 9010           ENDCASE
 9011           wind%=0
 9012         ELSE
 9013           wind%=wind%! 0 
 9014           IF wind%=0 PROCinteractive_help(FNmsg_0(psup%! 16 ,"H"+dp_menu_chsn$))
 9015         ENDIF
 9016       ENDWHILE
 9017   ENDCASE
 9018 ENDPROC
 9019 DEF PROCdp_save_configuration(window%)
 9020   LOCAL dp_i%,dp_j%,dp_k%,dp_s$,B%,C%
 9021   VDU: PROCftracef("PROCdp_save_configuration")
 9022   prdt%=FNprinter_find_prdata_entry(psup%,FNicon_read(window%,6))
 9023   PROCfree_structure(prnt%! 40 )
 9024   $buff%=FNicon_read(window%,30)
 9025   B%=buff%
 9026   C%=2
 9027   prnt%! 40 =USR(code_entry%+ 28 )
 9028   dp_i%=cnfg%
 9029   FOR dp_j%=1 TO  16 /4
 9030     PROCfree_structure(!dp_i%)
 9031    !dp_i%=0: dp_i%+=4
 9032   NEXT
 9033   dp_j%=0
 9034   IF FNicon_read(window%,17)=FNmsg_0(psup%! 16 ,"PF1")dp_j%+= 1 << 16 
 9035   IF FNicon_read(window%,17)=FNmsg_0(psup%! 16 ,"PF2")dp_j%+= 2 << 16 
 9036   IF FNicon_set(window%,8)dp_j%+=2
 9037   IF FNicon_set(window%,11)dp_j%+=4
 9038   IF FNicon_set(window%,12)dp_j%+=8
 9039   CASE FNicon_read(window%,14)OF
 9040     WHEN FNmsg_0(psup%! 16 ,"TQ1"): dp_j%+=1<<4: dp_i%=2
 9041     WHEN FNmsg_0(psup%! 16 ,"TQ2"): dp_j%+=1<<5: dp_i%=3
 9042     OTHERWISE: dp_i%=1
 9043   ENDCASE
 9044   CASE FNicon_read(window%,23)OF
 9045     WHEN FNmsg_0(psup%! 16 ,"CC1"): dp_j%+=1<<8
 9046     WHEN FNmsg_0(psup%! 16 ,"CC2"): dp_j%+=1<<9
 9047   ENDCASE
 9048   cnfg%! 0 =FNstore_integer(dp_j%)
 9049   dp_j%=FNprinter_read_list_integer_entry(prdt%,5,dp_i%,1)
 9050   IF dp_j% THEN
 9051     B%= &52544F50 
 9052     C%=4
 9053     cnfg%! 4 =USR(code_entry%+ 12 )
 9054     IFcnfg%! 4 =0 ERROR  253 , FNmsg_0(FNdp_host_desc,"FA5")
 9055     !cnfg%! 4 =dp_j%
 9056     prnt%! 24 =prnt%! 24  AND NOT(1<<6)
 9057   ELSE
 9058     prnt%! 24 =prnt%! 24  OR 1<<6
 9059   ENDIF
 9060   REM point to the resolution possibilities
 9061   dp_j%=prdt%!20: REM printer name is 8, short name is 12, sprite name is 16, resolution is 20
 9062   dp_s$=FNicon_read(window%,3)
 9063   WHILE dp_j%
 9064     dp_k%=!dp_j%! 8 : REM get the pointer
 9065     REM module is 8, palette is 12, options is 16, pxres is 20, pyres is 24
 9066     IF (dp_s$=FNmsg_2(psup%! 16 ,"RES",STR$ !dp_k%!20,STR$ !dp_k%!24)) OR        (dp_s$=$(dp_k%!36)) THEN
 9067       dp_j%=0
 9068     ELSE
 9069       dp_j%=!dp_j%
 9070     ENDIF
 9071   ENDWHILE
 9072   B%= &52544F50 :C%=4
 9073   cnfg%! 8 =USR(code_entry%+ 12 )
 9074   IFcnfg%! 8 =0 ERROR  253 , FNmsg_0(FNdp_host_desc,"FA5")
 9075   !cnfg%! 8 =dp_k%
 9076   dp_s$=FNicon_read(window%,15)
 9077   dp_i%=INSTR(dp_s$,",")
 9078   CASE LEFT$(dp_s$,dp_i%-1)OF
 9079     WHEN FNmsg_0(psup%! 16 ,"CO1"):  dp_j%=1
 9080     WHEN FNmsg_0(psup%! 16 ,"CO1s"): dp_j%=1
 9081     WHEN FNmsg_0(psup%! 16 ,"CO2"):  dp_j%=2
 9082     WHEN FNmsg_0(psup%! 16 ,"CO4"):  dp_j%=4
 9083     WHEN FNmsg_0(psup%! 16 ,"CO5"):  dp_j%=5
 9084     WHEN FNmsg_0(psup%! 16 ,"CO5s"): dp_j%=5
 9085     OTHERWISE: dp_j%=0
 9086   ENDCASE
 9087   dp_s$=MID$(dp_s$,dp_i%+2)
 9088   CASE dp_s$ OF
 9089     WHEN FNmsg_0(psup%! 16 ,"HT8"):  dp_i%=8
 9090     WHEN FNmsg_0(psup%! 16 ,"HT8s"): dp_i%=8
 9091     WHEN FNmsg_0(psup%! 16 ,"HT1"):  dp_i%=1
 9092     WHEN FNmsg_0(psup%! 16 ,"HT1s"): dp_i%=1
 9093     OTHERWISE: dp_i%=4
 9094   ENDCASE
 9095   cnfg%! 12 =FNstore_integer((dp_i%<<8)+dp_j%)
 9096   dp_j%=prnt%! 36 
 9097   dp_s$=FNicon_read(window%,27)
 9098   IF $dp_j%! 4 <>dp_s$ THEN
 9099     dp_i%=psize_head%
 9100     WHILE dp_i%
 9101       IF $dp_i%! 4 =dp_s$ THEN
 9102         prnt%! 36 =dp_i%
 9103         dp_i%=0
 9104       ELSE
 9105         dp_i%=!dp_i%
 9106       ENDIF
 9107     ENDWHILE
 9108   ENDIF
 9109   IF prnt%! 20 <>-1 THEN
 9110     PROCselect_printer(prnt%, -1 , 0 )
 9111   ENDIF
 9112 ENDPROC
 9113 DEF FNdp_res(cnfg%)
 9114   LOCAL xres%,yres%,graphics_prdt%,nm$
 9115   VDU: PROCftracef("FNdp_res")
 9116   graphics_prdt%=!cnfg%! 8 
 9117   xres%=FNprinter_read_integer_entry(graphics_prdt%,4)
 9118   yres%=FNprinter_read_integer_entry(graphics_prdt%,5)
 9119   nm$=FNprinter_read_string_entry(graphics_prdt%,8)
 9120   IF nm$="" THEN  nm$=FNmsg_2(psup%! 16 ,"RES",STR$ xres%,STR$ yres%)
 9121 =nm$
 9122 DEF FNdp_qual_name(dp_i%)
 9123   LOCAL dp_s$,dp_t$
 9124   IF DPQ$ = "S" THEN
 9125     dp_s$=FNmsg_0(psup%! 16 ,"CO"+STR$(dp_i% AND &FF)+"s")
 9126     dp_t$=FNmsg_0(psup%! 16 ,"HT"+STR$((dp_i% AND &FF00)>>8)+"s")
 9127   ELSE
 9128     dp_s$=FNmsg_0(psup%! 16 ,"CO"+STR$(dp_i% AND &FF))
 9129     dp_t$=FNmsg_0(psup%! 16 ,"HT"+STR$((dp_i% AND &FF00)>>8))
 9130   ENDIF
 9131 =dp_s$+", "+dp_t$
 9132 DEF FNdp_qual(cnfg%)
 9133   LOCAL dp_i%
 9134   VDU: PROCftracef("FNdp_qual")
 9135   dp_i%=!cnfg%! 12 
 9136 =FNdp_qual_name(dp_i%)
 9137 DEF FNdp_get_quality_options(graphics_definition%)
 9138 LOCAL s%,c%,t%
 9139 s%=FNprinter_read_integer_entry(graphics_definition%,3)
 9140 REM if colour small halftone present, add colour large halftone
 9141 IF (s% AND &100) s% = s% OR &200
 9142 REM if colour available, add new colour options
 9143 IF (s% AND &700) THEN
 9144  t%=FNprinter_read_integer_entry(graphics_definition%,1):REM ptr to module defn
 9145  t%=FNprinter_read_integer_entry(t%,1):REM module number
 9146  REM need to pass the MiscOp through to the dumper driver
 9147  SYS"XPDriver_MiscOpForDriver",&80000002,t%,,,,,,,7 TO t%;c%:REM strip type mask
 9148  IF(c%AND1)=0 AND t%<>&80000002 THEN
 9149   IF (t% AND (1<<3)) THEN
 9150    REM add strip type 3 based on the greyscale options (or colour, if no grey)
 9151    c%=s% AND &70
 9152    IF c%=0 THEN c%=(s% AND &700)>>4
 9153    s%=s% OR (c%<<16)
 9154   ENDIF
 9155   IF (t% AND (1<<4)) THEN
 9156    c%=s% AND &700
 9157    s%=s% OR (c%<<8)
 9158   ENDIF
 9159   IF (t% AND (1<<5)) THEN
 9160    REM add strip type 5 based on the colour options
 9161    c%=s% AND &700
 9162    s%=s% OR (c%<<12)
 9163   ENDIF
 9164  ENDIF
 9165 ENDIF
 9166 REM If simple qualities, knock out Mono,256 colours,32k colours
 9167 IF DPQ$ = "S" s%=s% AND &700070
 9168 =s%
 9169 REM If DPQ$ = "S" then the following qualities are
 9170 REM actually deemed not to exist:
 9171 REM - Any 'Mono'; '256 colours'; '32k colours'
 9172 REM This procedure tries to find a good default quality to pick.
 9173 REM Modified on 22-Jul-93/3-Dec-93 to pick in this order:
 9174 REM Modified on 02-Aug-95 to favour error diff instead of halftone
 9175 REM * 16 million, diffused
 9176 REM * colour, diffused
 9177 REM * grey, diffused
 9178 REM * mono, diffused
 9179 REM
 9180 REM The option value is split into 3 nibbles:
 9181 REM &7xxxxx = 24bpp colour, either strip type 3 or 5 depending on
 9182 REM                         whether or not it is a full colour system
 9183 REM &x7xxxx = 16bpp colour, strip type 4
 9184 REM &xxx7xx = colour, strip type 2
 9185 REM &xxxx7x = greyscale, strip type 1
 9186 REM &xxxxx7 = monochrome, strip type 0
 9187 REM
 9188 REM Within the 3 nibbles, the following values are valid:
 9189 REM 1 = small halftone, tone type 4
 9190 REM 2 = large halftone, tone type 8
 9191 REM 4 = dithered, tone type 1
 9192 DEF PROCdp_decode_options(option%,RETURN strip%,RETURN tone%)
 9193   VDU: PROCftracef("PROCdp_decode_options")
 9194   REM try to pick colour, then grey, then mono
 9195   IF option% AND &700000 THEN
 9196    strip%=5
 9197   ELSE 
 9198    IF option% AND &700 THEN
 9199     strip%=2
 9200    ELSE
 9201     IF option% AND &70 THEN
 9202      strip%=1
 9203     ELSE
 9204      REM force grey if Simple (Mono not allowed)
 9205      IF DPQ$ = "S" THEN strip%=1 ELSE strip%=0
 9206     ENDIF
 9207    ENDIF
 9208   ENDIF
 9209   option%=option%>>(strip%*4)
 9210   tone%=-1
 9211   IF (strip%=5 AND (option% AND 4)<>0) tone%=1
 9212   IF (strip%=2 AND (option% AND 4)<>0) tone%=1
 9213   IF (strip%=1 AND (option% AND 4)<>0) tone%=1
 9214   IF (strip%=0 AND (option% AND 4)<>0) tone%=1
 9215   IF tone%=-1 THEN
 9216     IF option% AND 4 THEN
 9217       tone%=1
 9218     ELSE
 9219       IF option% AND 2 THEN
 9220         tone%=8
 9221       ELSE
 9222         tone%=4
 9223       ENDIF
 9224     ENDIF
 9225   ENDIF
 9226 ENDPROC
 9227 DEF PROCdp_menu(top$,rebuild%,iconpos%)
 9228   LOCAL wind%,dp_ix%,dp_iy%,dp_i%,dp_x%,dp_j%,dp_k%,xres%,yres%,indt%
 9229   VDU: PROCftracef("PROCdp_menu")
 9230   IF rebuild% dp_menu_xpos%=xbuff%!0-64: dp_menu_ypos%=xbuff%!4
 9231   IF iconpos% THEN
 9232     !buff%=xbuff%!12:buff%!4=xbuff%!16:SYS"Wimp_GetIconState",,buff%
 9233     dp_ix%=buff%!16:dp_iy%=buff%!20
 9234     SYS"Wimp_GetWindowState",,buff%
 9235     dp_menu_xpos%=buff%!20+buff%!4+dp_ix%+2
 9236     dp_menu_ypos%=buff%!24+buff%!16+dp_iy%-2
 9237   ENDIF
 9238   wind%=FNprinter_find_window(prnt%,"configure")
 9239   dp_menu_chsn$=top$
 9240   REM because of the way the configuration window works,
 9241   REM we have to adjust prdt% to point to the printer data
 9242   REM record for the printer specified in the window, NOT
 9243   REM the current printer.
 9244   prdt%=FNprinter_find_prdata_entry(psup%,FNicon_read(wind%,6))
 9245   CASE top$ OF
 9246     WHEN "ME1"
 9247       PROCmenu_create(dp_menu%,FNmsg_0(psup%! 16 ,"ME1"))
 9248       indt%=(dp_menu%!28 AND &100)<>0
 9249       REM get the resolution strings for this printer
 9250       dp_j%=prdt%!20: dp_i%=0: dp_x%=0
 9251       WHILE dp_j%
 9252         dp_k%=!dp_j%! 8 
 9253         xres%=FNprinter_read_integer_entry(dp_k%,4)
 9254         yres%=FNprinter_read_integer_entry(dp_k%,5)
 9255         nm$=FNprinter_read_string_entry(dp_k%,8)
 9256         IF nm$<>"" THEN
 9257           PROCmenu_item(dp_menu%,dp_i%,nm$,indt%)
 9258         ELSE
 9259           PROCmenu_item(dp_menu%,dp_i%,FNmsg_2(psup%! 16 ,"RES",STR$ xres%,STR$ yres%),indt%)
 9260         ENDIF
 9261         dp_i%+=1
 9262         dp_j%=!dp_j%
 9263       ENDWHILE
 9264       PROCmenu_tick_match(dp_menu%,FNicon_read(wind%,3))
 9265     WHEN "ME2"
 9266       PROCmenu_create(dp_menu%,FNmsg_0(psup%! 16 ,"ME2"))
 9267       PROCmenu_tick_match(dp_menu%,FNicon_read(wind%,17))
 9268     WHEN "ME3"
 9269       PROCmenu_create(dp_menu%,FNmsg_0(psup%! 16 ,"ME3"))
 9270       REM need to find the right graphics entry for the current resolution
 9271       dp_j%=prdt%!20: REM point to first record for this list
 9272       WHILE dp_j%
 9273         dp_k%=!dp_j%! 8 
 9274         IF (FNicon_read(wind%,3)=FNmsg_2(psup%! 16 ,"RES",STR$ !dp_k%!20,STR$ !dp_k%!24)) OR            (FNicon_read(wind%,3)=$(dp_k%!36)) THEN
 9275           REM ok - found the graphics entry, now get the options word
 9276           dp_j%=FNdp_get_quality_options(dp_k%): dp_i%=0: dp_x%=0
 9277           IF dp_j% AND &000007 PROCdp_menu_quality(dp_menu%,dp_i%,FNmsg_0(psup%! 16 ,"CO0"),dp_j%)
 9278           IF dp_j% AND &000070 THEN
 9279             IF DPQ$="S" THEN
 9280               PROCdp_menu_quality(dp_menu%,dp_i%,FNmsg_0(psup%! 16 ,"CO1s"),dp_j%>>4)
 9281             ELSE
 9282               PROCdp_menu_quality(dp_menu%,dp_i%,FNmsg_0(psup%! 16 ,"CO1"),dp_j%>>4)
 9283             ENDIF
 9284           ENDIF
 9285           IF dp_j% AND &000700 PROCdp_menu_quality(dp_menu%,dp_i%,FNmsg_0(psup%! 16 ,"CO2"),dp_j%>>8)
 9286           IF dp_j% AND &070000 PROCdp_menu_quality(dp_menu%,dp_i%,FNmsg_0(psup%! 16 ,"CO4"),dp_j%>>16)
 9287           IF dp_j% AND &700000 THEN
 9288             IF DPQ$="S" THEN
 9289               PROCdp_menu_quality(dp_menu%,dp_i%,FNmsg_0(psup%! 16 ,"CO5s"),dp_j%>>20)
 9290             ELSE
 9291               PROCdp_menu_quality(dp_menu%,dp_i%,FNmsg_0(psup%! 16 ,"CO5"),dp_j%>>20)
 9292             ENDIF
 9293           ENDIF
 9294           dp_j%=0
 9295         ELSE
 9296           dp_j%=!dp_j%
 9297         ENDIF
 9298       ENDWHILE
 9299       PROCmenu_tick_match(dp_menu%,FNicon_read(wind%,15))
 9300     WHEN "ME4"
 9301       PROCmenu_create(dp_menu%,FNmsg_0(psup%! 16 ,"ME4"))
 9302       indt%=(dp_menu%!28 AND &100)<>0
 9303       IF FNprinter_read_list_integer_entry(prdt%,5,2,1)THEN
 9304         REM we have draft highlights
 9305         PROCmenu_item(dp_menu%,1,FNmsg_0(psup%! 16 ,"TQ1"),indt%)
 9306         IF FNprinter_read_list_integer_entry(prdt%,5,3,1)PROCmenu_item(dp_menu%,2,FNmsg_0(psup%! 16 ,"TQ2"),indt%)
 9307       ENDIF
 9308       PROCmenu_tick_match(dp_menu%,FNicon_read(wind%,14))
 9309     WHEN "ME5"
 9310       PROCmenu_create(dp_menu%,FNmsg_0(psup%! 16 ,"ME5"))
 9311       PROCmenu_tick_match(dp_menu%,FNicon_read(wind%,23))
 9312     WHEN "MP1"
 9313       PROCcreate_paper_menu(dp_menu%,wind%,27)
 9314   ENDCASE
 9315   PROCdisplay_menu(prnt%,dp_menu%,dp_menu_xpos%,dp_menu_ypos%)
 9316 ENDPROC
 9317 DEF PROCdp_menu_quality(RETURN dp_menu%,RETURN dp_i%,strip$,tone%)
 9318   LOCAL indt%
 9319   VDU: PROCftracef("PROCdp_menu_quality")
 9320   indt%=(dp_menu%!28 AND &100)<>0
 9321   IF tone% AND 1 THEN
 9322     IF DPQ$="S" THEN
 9323       PROCmenu_item(dp_menu%,dp_i%,strip$+", "+FNmsg_0(psup%! 16 ,"HT4s"),indt%)
 9324     ELSE
 9325       PROCmenu_item(dp_menu%,dp_i%,strip$+", "+FNmsg_0(psup%! 16 ,"HT4"),indt%)
 9326     ENDIF
 9327     dp_i%+=1
 9328   ENDIF
 9329   IF tone% AND 2 THEN
 9330     IF DPQ$="S" THEN
 9331       PROCmenu_item(dp_menu%,dp_i%,strip$+", "+FNmsg_0(psup%! 16 ,"HT8s"),indt%)
 9332     ELSE
 9333       PROCmenu_item(dp_menu%,dp_i%,strip$+", "+FNmsg_0(psup%! 16 ,"HT8"),indt%)
 9334     ENDIF
 9335     dp_i%+=1
 9336   ENDIF
 9337   IF tone% AND 4 THEN
 9338     IF DPQ$="S" THEN
 9339       PROCmenu_item(dp_menu%,dp_i%,strip$+", "+FNmsg_0(psup%! 16 ,"HT1s"),indt%)
 9340     ELSE
 9341       PROCmenu_item(dp_menu%,dp_i%,strip$+", "+FNmsg_0(psup%! 16 ,"HT1"),indt%)
 9342     ENDIF
 9343     dp_i%+=1
 9344   ENDIF
 9345 ENDPROC
 9346 DEF FNdp_hex2(v%)
 9347   VDU: PROCftracef("FNdp_hex2")
 9348 =RIGHT$("0"+STR$~v%,2)
 9349 REM text printing code
 9350 DEF PROCdp_m8
 9351   LOCAL dp_r%,queu%,tpub%,tprv%,text_prdt%
 9352   VDU: PROCftracef("PROCdp_m8, reason "+STR$!xbuff%)
 9353   VDU: PROCftracef(STR$~cnfg%)
 9354   VDU: PROCftracef(STR$~cnfg%! 4 )
 9355   VDU: PROCftracef(STR$~!cnfg%! 4 )
 9356   text_prdt%=!cnfg%! 4 
 9357   dp_r%=!xbuff%
 9358   queu%=xbuff%!4
 9359   tpub%=queu%! 44 
 9360   tprv%=queu%! 48 
 9361   CASE dp_r% OF
 9362     WHEN  -1: PROCdp_1
 9363     WHEN  -2: PROCdp_2
 9364     WHEN  -4: PROCdp_4
 9365     WHEN  -6: PROCdp_6
 9366     WHEN  -7: PROCdp_7
 9367     WHEN  -9: PROCdp_9
 9368     WHEN -10: PROCdp_10
 9369     WHEN -11: PROCdp_11
 9370     WHEN -12: PROCdp_12
 9371     WHEN -13: PROCdp_13
 9372     WHEN -15: PROCdp_15
 9373     WHEN -16: PROCdp_16
 9374     WHEN -17: PROCdp_17
 9375     WHEN -18: PROCdp_18
 9376     WHEN -19: PROCdp_19
 9377   ENDCASE
 9378   VDU: PROCftracef("Afterwards ...")
 9379   VDU: PROCftracef(STR$~cnfg%)
 9380   VDU: PROCftracef(STR$~cnfg%! 4 )
 9381   VDU: PROCftracef(STR$~!cnfg%! 4 )
 9382 ENDPROC
 9383 DEF PROCdp_1
 9384   LOCAL dp_i%,dp_i$,psze%,dp_j%,B%,C%,D%
 9385   VDU: PROCftracef("PROCdp_1")
 9386   B%= &56525054 :C%= 20 
 9387   tprv%=USR(code_entry%+ 12 )
 9388   IFtprv%=0 ERROR  253 , FNmsg_0(FNdp_host_desc,"FA5")
 9389   queu%! 48 =tprv%
 9390   FOR dp_i%=0 TO  20 -4
 9391     tprv%!dp_i%=0
 9392   NEXT
 9393   psze%=prnt%! 36 
 9394   tprv%! 8 =psze%! 40 
 9395   dp_j%=!cnfg%! 0 
 9396   tpub%! 44 =(dp_j% AND &FF00)>>8
 9397   IF dp_j% AND 4 tpub%! 48 = -1 
 9398   IF dp_j% AND 2 tpub%! 52 = -1 
 9399   IF(dp_j%>> 16  AND  15 )= 1  tpub%! 20 = -1 
 9400   REM set the line epilogue string
 9401   IF dp_j% AND 8 THEN
 9402     dp_i$=FNprinter_read_string_entry(text_prdt%,6)
 9403   ELSE
 9404     dp_i$=FNprinter_read_string_entry(text_prdt%,5)
 9405   ENDIF
 9406   B%=A%! 16 
 9407   $B%=dp_i$
 9408   C%=5
 9409   D%=LEN dp_i$
 9410   tpub%! 108 =USR(code_entry%+ 28 )
 9411   dp_i$=STRING$(psze%! 36 ,dp_i$)
 9412   $B%=dp_i$
 9413   C%=5
 9414   D%=LEN dp_i$
 9415   tprv%! 4 =USR(code_entry%+ 28 )
 9416   tprv%! 0 =psze%! 48 
 9417   tpub%! 76 =psze%! 48 -psze%! 36 -psze%! 32 
 9418   REM set the pointer to the char translation list
 9419   dp_j%=FNprinter_read_integer_entry(prdt%,6): REM point to the PRDT block
 9420   IF dp_j% dp_j%=dp_j%! 8 
 9421   queu%! 64 =dp_j%
 9422 ENDPROC
 9423 DEF PROCdp_2
 9424   LOCAL dp_s$,pheight%,graphics_prdt%
 9425   VDU: PROCftracef("PROCdp_2")
 9426   REM output job start string
 9427   dp_s$=FNprinter_read_string_entry(text_prdt%,7)
 9428   IF dp_s$<>"" BPUT#xbuff%!8,dp_s$;
 9429   dp_s$=FNprinter_read_string_entry(text_prdt%,1)
 9430   pheight%=prnt%! 36 
 9431   pheight%=pheight%! 48 
 9432   REM Ouput set lines if both string exists and page length is not zero.
 9433   REM OSS Kludge - if dumper name = "PDumperIW" then output as 144ths of
 9434   REM an inch as a four digit decimal number with leading zeros. Assume
 9435  REM 6 lines per inch, 144/6 = 24.
 9436   IF dp_s$<>"" AND pheight%<>0 THEN
 9437     graphics_prdt%=!cnfg%! 8 
 9438     IF FNprinter_read_string_entry(FNprinter_read_integer_entry(graphics_prdt%,1),2)="PDumperIW" THEN
 9439       dp_s$+="0000"
 9440       RIGHT$(dp_s$,4)=STR$(pheight%*24)
 9441       BPUT#xbuff%!8,dp_s$;
 9442     ELSE
 9443       BPUT#xbuff%!8,dp_s$+CHR$(pheight%);
 9444     ENDIF
 9445   ENDIF
 9446 ENDPROC
 9447 DEF PROCdp_4
 9448   REM no data to output
 9449   VDU: PROCftracef("PROCdp_4")
 9450   xbuff%?8=0
 9451 ENDPROC
 9452 DEF PROCdp_6
 9453   REM do control code processing
 9454   LOCAL dp_b$
 9455   VDU: PROCftracef("PROCdp_6")
 9456   dp_b$=FNdp_display(xbuff%!8)
 9457   xbuff%?8=LEN dp_b$
 9458   $(xbuff%+9)=dp_b$
 9459 ENDPROC
 9460 DEF PROCdp_7
 9461   REM process a backspace
 9462   LOCAL dp_b$
 9463   VDU: PROCftracef("PROCdp_7")
 9464   dp_b$=FNprinter_read_string_entry(text_prdt%,2)
 9465   xbuff%?8=LEN dp_b$
 9466   $(xbuff%+9)=dp_b$
 9467 ENDPROC
 9468 DEF PROCdp_9
 9469   LOCAL changed_bits%,clr_bits%,set_bits%,bit%,dp_b$
 9470   VDU: PROCftracef("PROCdp_9")
 9471   changed_bits%=tpub%! 96  EOR xbuff%!8
 9472   clr_bits%=tpub%! 96  AND changed_bits%
 9473   set_bits%=changed_bits% AND NOTclr_bits%
 9474   IF clr_bits% OR set_bits% THEN
 9475     FOR bit%=0 TO 5
 9476       IF clr_bits% AND 1<<bit% THEN dp_b$+=FNdp_style_off(bit%)
 9477       IF set_bits% AND 1<<bit% THEN dp_b$+=FNdp_style_on(bit%)
 9478     NEXT
 9479   ENDIF
 9480   xbuff%?8=LEN dp_b$
 9481   $(xbuff%+9)=dp_b$
 9482 ENDPROC
 9483 DEF PROCdp_10
 9484   REM start a new line
 9485   LOCAL dp_s$,dp_b$
 9486   VDU: PROCftracef("PROCdp_10")
 9487   tpub%! 80 +=1
 9488   tpub%! 72 +=1
 9489   IF tpub%! 48 <>0 OR tprv%! 8 >0 THEN
 9490     dp_b$=FNdp_font(0): REM pica
 9491     FOR bit%=0 TO 5
 9492      IF tpub%! 96  AND 1<<bit% dp_b$+=FNdp_style_off(bit%)
 9493     NEXT
 9494     dp_b$+=STRING$(tprv%! 8 ," ")
 9495     IF tpub%! 48  THEN
 9496       dp_s$=STR$ tpub%! 72 
 9497       dp_b$+=STRING$(5-LEN dp_s$," ")+dp_s$+" "
 9498     ENDIF
 9499     FOR bit%=0 TO 5
 9500       IF tpub%! 96  AND 1<<bit% dp_b$+=FNdp_style_on(bit%)
 9501     NEXT
 9502   ENDIF
 9503   dp_b$+=FNdp_font(tpub%! 64 )+STRING$(tprv%! 12 ," ")
 9504   xbuff%?8=LEN dp_b$
 9505   $(xbuff%+9)=dp_b$
 9506 ENDPROC
 9507 DEF PROCdp_11
 9508   LOCAL dp_b$,dp_i%
 9509   VDU: PROCftracef("PROCdp_11")
 9510   PROCdp_10:dp_b$=FNprinter_read_string(tpub%! 108 )+$(xbuff%+9)
 9511   PROCdp_10:dp_b$+=FNprinter_read_string(tpub%! 108 )+$(xbuff%+9)
 9512   dp_b$+=FNdp_style_on(4): REM superscript
 9513   dp_b$+=FNdp_trans(RIGHT$("  "+STR$ tpub%! 60 ,3)+STRING$(3,FNprinter_read_string_entry(text_prdt%,2)))
 9514   dp_b$+=FNdp_style_off(4)
 9515   xbuff%?8=LEN dp_b$
 9516   $(xbuff%+9)=dp_b$
 9517 ENDPROC
 9518 DEF PROCdp_12
 9519   LOCAL dp_b$
 9520   VDU: PROCftracef("PROCdp_12")
 9521   dp_b$=FNdp_trans($(xbuff%+8))
 9522   xbuff%?8=LEN dp_b$
 9523   $(xbuff%+9)=dp_b$
 9524 ENDPROC
 9525 DEF PROCdp_13
 9526   VDU: PROCftracef("PROCdp_13")
 9527   tpub%! 64 =xbuff%!8
 9528   xbuff%?8=0
 9529 ENDPROC
 9530 DEF PROCdp_15
 9531   LOCAL text_prdt%,tpub%,dp_epilogue$,dp_formfeed$,dp_lineepi$
 9532   VDU: PROCftracef("PROCdp_15")
 9533   IF queu%! 36 <>&FF4 THEN
 9534     text_prdt%=!cnfg%! 4 
 9535     tpub%=queu%! 44 
 9536     dp_lineepi$=FNprinter_read_string(tpub%! 108 )
 9537     IF queu%! 36 =&FFF THEN
 9538       IF(tpub%! 40 )=0 THEN
 9539         dp_epilogue$=FNprinter_read_string_entry(text_prdt%,8)
 9540         dp_formfeed$=FNprinter_read_string_entry(text_prdt%,4)
 9541         IF INSTR(dp_epilogue$,dp_lineepi$)<>1 THEN
 9542           IF dp_lineepi$<>"" BPUT#xbuff%!8,dp_lineepi$;
 9543         ENDIF
 9544         IF dp_epilogue$<>"" BPUT#xbuff%!8,dp_epilogue$;
 9545       ENDIF
 9546     ELSE
 9547       REM output a blank line between files
 9548       IF dp_lineepi$<>"" BPUT#xbuff%!8,dp_lineepi$;
 9549     ENDIF
 9550   ENDIF
 9551 ENDPROC
 9552 DEF PROCdp_16
 9553   REM process a tab
 9554   LOCAL dp_b$
 9555   VDU: PROCftracef("PROCdp_16")
 9556   dp_b$=FNprinter_read_string_entry(text_prdt%,3)
 9557   xbuff%?8=LEN dp_b$
 9558   $(xbuff%+9)=dp_b$
 9559 ENDPROC
 9560 DEF PROCdp_17
 9561   REM do a formfeed
 9562   LOCAL dp_b$
 9563   VDU: PROCftracef("PROCdp_17")
 9564   dp_b$=FNprinter_read_string_entry(text_prdt%,4)
 9565   xbuff%?8=LEN dp_b$
 9566   $(xbuff%+9)=dp_b$
 9567 ENDPROC
 9568 DEF PROCdp_18
 9569   REM change layout
 9570   LOCAL layout_height%,layout_top%,layout_bottom%,dp_b$,dp_i%,dp_i$,B%,C%,D%,graphics_prdt%
 9571   VDU: PROCftracef("PROCdp_18")
 9572   layout_height%=xbuff%!8
 9573   layout_top%=xbuff%!12
 9574   layout_bottom%=xbuff%!16
 9575   IF layout_height%<=tprv%! 0  AND layout_top%<=layout_height%*0.33 AND layout_bottom%<=layout_height%*0.33 THEN
 9576     tpub%! 76 =layout_height%-layout_top%-layout_bottom%
 9577     IF tprv%! 4  THEN
 9578       VDU: PROCftracef("Calling heap free with ptr "+STR$~tprv%! 4 )
 9579       B%= &52545347 
 9580       C%=tprv%! 4 
 9581       CALL code_entry%+ 16 
 9582     ENDIF
 9583     dp_i$=STRING$(layout_top%,FNprinter_read_string(tpub%! 108 ))
 9584     B%=A%! 16 
 9585     $B%=dp_i$
 9586     C%=5
 9587     D%=LEN dp_i$
 9588     tprv%! 4 =USR(code_entry%+ 28 )
 9589     dp_b$=FNprinter_read_string_entry(text_prdt%,1): REM text_page_line
 9590     REM OSS Kludge - if dumper name = "PDumperIW" then output as 144ths of
 9591     REM an inch as a four digit decimal number with leading zeros. Assume
 9592     REM 6 lines per inch, 144/6 = 24.
 9593     IF dp_b$<>"" AND layout_height%<>0 THEN
 9594       graphics_prdt%=!(cnfg%! 8 )
 9595       IF FNprinter_read_string_entry(FNprinter_read_integer_entry(graphics_prdt%,1),2)="PDumperIW" THEN
 9596         dp_b$+="0000"
 9597         RIGHT$(dp_b$,4)=STR$(layout_height%*24)
 9598       ELSE
 9599         dp_b$+=CHR$ layout_height%
 9600       ENDIF
 9601     ENDIF
 9602   ENDIF
 9603   xbuff%?8=LEN dp_b$
 9604   $(xbuff%+9)=dp_b$
 9605 ENDPROC
 9606 DEF PROCdp_19
 9607   VDU: PROCftracef("PROCdp_19")
 9608   LOCAL dp_b$,dp_i%,dp_s$,bit%
 9609   dp_b$=FNprinter_read_string(tprv%! 4 )
 9610   tpub%! 80 =0
 9611   tpub%! 84 +=1
 9612   IF tpub%! 52  THEN
 9613     tpub%! 80 +=2
 9614     dp_b$+=FNdp_font(0): REM pica
 9615     FOR bit%=0 TO 5
 9616      IF tpub%! 96  AND 1<<bit% dp_b$+=FNdp_style_off(bit%)
 9617     NEXT
 9618     dp_b$+=STRING$(tprv%! 8 +tprv%! 12 ," ")
 9619     dp_s$=FNprinter_read_string(tpub%! 112 )+"   "+FNprinter_read_string(tpub%! 120 )
 9620     dp_s$+="   "+FNmsg_1(psup%! 16 ,"PAG",STR$ tpub%! 84 )
 9621     dp_b$+=FNdp_trans(dp_s$)
 9622     FOR bit%=0 TO 5
 9623       IF tpub%! 96  AND 1<<bit% dp_b$+=FNdp_style_on(bit%)
 9624     NEXT
 9625     dp_b$+=STRING$(2,FNprinter_read_string(tpub%! 108 ))
 9626   ENDIF
 9627   xbuff%?8=LEN dp_b$
 9628   $(xbuff%+9)=dp_b$
 9629 ENDPROC
 9630 DEF FNdp_trans(dp_s$)
 9631   LOCAL dp_i%,byte%,out$,str$
 9632   VDU: PROCftracef("FNdp_trans")
 9633   IF dp_s$="" THEN =""
 9634   FOR dp_i%=1 TO LEN dp_s$
 9635     byte%=ASC MID$(dp_s$,dp_i%,1)
 9636     str$=""
 9637     CASE  -1  OF
 9638       WHEN byte%<32 OR byte%=127
 9639         IF tpub%! 44 =1 str$=FNdp_display(byte%)
 9640       WHEN byte%>127 AND tpub%! 44 <>0
 9641         IF tpub%! 44 =1 str$=FNdp_display(byte%)
 9642       WHEN tpub%! 44 <>0
 9643         str$=CHR$ byte%
 9644       OTHERWISE
 9645         str$=FNdp_text_char(byte%)
 9646         IF str$="" str$=CHR$ byte%
 9647     ENDCASE
 9648     out$+=str$
 9649   NEXT
 9650 =out$
 9651 DEF FNdp_text_char(byte%)
 9652   LOCAL dp_p%,dp_s$,dp_i%
 9653   VDU: PROCftracef("FNdp_text_char")
 9654   dp_p%=queu%! 64 
 9655   WHILE dp_p%
 9656     CASE  -1  OF
 9657       WHEN dp_p%?4=byte%
 9658         dp_i%=dp_p%?5:dp_p%=dp_p%+6
 9659         WHILE dp_i%
 9660           dp_s$+=CHR$ ?dp_p%
 9661           dp_p%+=1
 9662           dp_i%-=1
 9663         ENDWHILE
 9664         =dp_s$
 9665       WHEN dp_p%?4>byte%
 9666         dp_p%=0
 9667       OTHERWISE
 9668         dp_p%=!dp_p%
 9669     ENDCASE
 9670   ENDWHILE
 9671 =""
 9672 DEF FNdp_display(byte%)
 9673   VDU: PROCftracef("FNdp_display")
 9674 ="["+RIGHT$("0"+FNtask_lower(STR$~byte%),2)+"]"
 9675 DEF FNdp_style_on(bit%)
 9676   VDU: PROCftracef("FNdp_style_on")
 9677   CASE bit% OF
 9678     WHEN 0: =FNprinter_read_string_entry(text_prdt%,13): REM bold on
 9679     WHEN 1: =FNprinter_read_string_entry(text_prdt%,17): REM light on
 9680     WHEN 2: =FNprinter_read_string_entry(text_prdt%,15): REM italic on
 9681     WHEN 3: =FNprinter_read_string_entry(text_prdt%,23): REM underline on
 9682     WHEN 4: =FNprinter_read_string_entry(text_prdt%,19): REM superscript on
 9683     WHEN 5: =FNprinter_read_string_entry(text_prdt%,21): REM subscript on
 9684   ENDCASE
 9685 =""
 9686 :
 9687 DEF FNdp_style_off(bit%)
 9688   VDU: PROCftracef("FNdp_style_off")
 9689   CASE bit% OF
 9690     WHEN 0: =FNprinter_read_string_entry(text_prdt%,14): REM bold off
 9691     WHEN 1: =FNprinter_read_string_entry(text_prdt%,18): REM light off
 9692     WHEN 2: =FNprinter_read_string_entry(text_prdt%,16): REM italic off
 9693     WHEN 3: =FNprinter_read_string_entry(text_prdt%,24): REM underline off
 9694     WHEN 4: =FNprinter_read_string_entry(text_prdt%,20): REM superscript off
 9695     WHEN 5: =FNprinter_read_string_entry(text_prdt%,22): REM subscript off
 9696   ENDCASE
 9697 =""
 9698 DEF FNdp_font(font%)
 9699   VDU: PROCftracef("FNdp_font")
 9700   CASE font% OF
 9701     WHEN 0: =FNprinter_read_string_entry(text_prdt%,9):REM pica
 9702     WHEN 1: =FNprinter_read_string_entry(text_prdt%,10):REM elite
 9703     WHEN 2: =FNprinter_read_string_entry(text_prdt%,11):REM condensed
 9704     WHEN 3: =FNprinter_read_string_entry(text_prdt%,12):REM expanded
 9705   ENDCASE
 9706 =""
 9707 DEF FNdp_host_desc
 9708 LOCAL a%
 9709 a%=buff%!24
 9710 =a%! 12 
 9711 REM > Support - for Laser/Desk Jet printers
 9712 DEF FNlj_support(buff%)
 9713   LOCAL reason%,psup%,prnt%,prdt%,cnfg%,xbuff%,psize_head%,code_entry%
 9714   VDU: PROCftracef("PROClj_support")
 9715   reason%=buff%!0
 9716   psup%=buff%!4
 9717   prnt%=buff%!8
 9718   xbuff%=buff%!12
 9719   psize_head%=buff%!16
 9720   code_entry%=buff%!20
 9721   IF prnt% THEN
 9722     prdt%=FNprinter_find_prdata_entry(psup%,$prnt%! 8 )
 9723     cnfg%=prnt%! 16 
 9724   ENDIF
 9725   CASE reason% OF
 9726     WHEN -1: PROClj_m1
 9727     WHEN -2: PROClj_m2
 9728     WHEN -3: PROClj_m3
 9729     WHEN -4: PROClj_m4
 9730     WHEN -5: PROClj_m5
 9731     WHEN -6: PROClj_m6
 9732     WHEN -7: PROClj_m7
 9733     WHEN -8: PROClj_m8
 9734     WHEN 3: PROClj_p3
 9735     WHEN 6: PROClj_p6
 9736     WHEN 8: PROClj_p8
 9737     WHEN 9: PROClj_p9
 9738     WHEN 17,18: PROClj_p17
 9739   ENDCASE
 9740 = 0 
 9741 DEF PROClj_m1
 9742   LOCAL colours%, pdriverdp%, exists%
 9743   REM psup%! 24  OR= 0
 9744   VDU: PROCftracef("PROClj_m1")
 9745   psup%! 28 =&FF4
 9746   psup%! 32 =%1001
 9747   psup%! 36 = 16 /4
 9748   psup%! 40 =2
 9749   REM note that the version number really only reflects
 9750   REM the status of the files being read, ie only change
 9751   REM this number if the file contents change.
 9752   psup%! 44 =100
 9753   psup%! 52 =0
 9754   colours%=FNrmload_latest_module("ColourTrans","System:Modules.Colours")
 9755   IFFNrmload_latest_module("PDriver","Printers:Modules.PDriver")
 9756   IFFNrmload_latest_module("PDumperSupport","Printers:Modules.PDumperSpt")
 9757   pdriverdp%=FNrmload_latest_module("PDriverDP","Printers:Modules.PDriverDP")
 9758   REM ***** WARNING!
 9759   REM ***** THESE VERSION NUMBERS ARE HARD CODED!
 9760   IFpdriverdp%>400 AND colours%<150 THEN
 9761     SYS"Wimp_ReportError",FNmsg_0(FNlj_host_desc,"WA12"), 1 OR 1<<4,FNmsg_1(FNlj_host_desc,"ER2",FNmsg_0(FNlj_host_desc,"ID"))
 9762   ENDIF
 9763 LJQ$="S"
 9764 ENDPROC
 9765 DEF PROClj_m2
 9766   VDU: PROCftracef("PROClj_m2")
 9767 ENDPROC
 9768 DEF PROClj_m3
 9769   REM initialise the configuration window
 9770   LOCAL config%,lj_i%,lj_j%
 9771   VDU: PROCftracef("PROClj_m3")
 9772   config%=FNprinter_find_window(prnt%,"configure")
 9773   PROCicon_write(config%,27,FNprinter_read_string(prnt%! 40 ))
 9774   PROCicon_write(config%,6,$prnt%! 8 )
 9775   PROCicon_write(config%,3,FNlj_res(cnfg%))
 9776   PROCicon_write(config%,15,FNlj_qual(cnfg%))
 9777   lj_i%=!cnfg%! 0 
 9778   lj_j%=lj_i% AND 1
 9779   PROCicon_write(config%,17,FNmsg_0(psup%! 16 ,"PF"+STR$ lj_j%))
 9780   IF prnt%! 24  AND 1<<6 THEN
 9781     PROCicon_shade(config%,8)
 9782     PROCicon_shade(config%,11)
 9783     PROCicon_shade(config%,13)
 9784     PROCicon_shade(config%,14)
 9785     PROCicon_shade(config%,22)
 9786     PROCicon_shade(config%,23)
 9787   ELSE
 9788     PROCicon_unshade(config%,8)
 9789     PROCicon_unshade(config%,11)
 9790     PROCicon_unshade(config%,13)
 9791     PROCicon_unshade(config%,14)
 9792     PROCicon_unshade(config%,22)
 9793     PROCicon_unshade(config%,23)
 9794     lj_j%=lj_i% AND %000010
 9795     IF lj_j% PROCicon_select(config%,8)ELSE PROCicon_deselect(config%,8)
 9796     lj_j%=lj_i% AND %000100
 9797     IF lj_j% PROCicon_select(config%,11)ELSE PROCicon_deselect(config%,11)
 9798     lj_j%=lj_i% AND %001000
 9799     PROCicon_write(config%,13,FNmsg_0(psup%! 16 ,"PO"+STR$(lj_j%>>3)))
 9800     lj_j%=(lj_i% AND &F00)>>8
 9801     PROCicon_write(config%,22,FNmsg_0(psup%! 16 ,"CC"+STR$ lj_j%))
 9802   ENDIF
 9803   lj_i%=prnt%! 36 
 9804   PROCicon_write(config%,25,$lj_i%! 4 )
 9805 ENDPROC
 9806 DEF PROClj_m4
 9807   REM create a CNFG block with suitable defaults
 9808   LOCAL lj_s$,lj_nm$,lj_nm2$,lj_i%,lj_s%,lj_t%,lj_x%,lj_y%,lj_co%,lj_ht%,B%,C%
 9809   VDU: PROCftracef("PROClj_m4")
 9810   REM PJC: set the text options to be draft
 9811   cnfg%! 0 =FNstore_integer(%010000)
 9812   REM portrait mode is no-highlights entry
 9813   lj_i%=FNprinter_read_list_integer_entry(prdt%,5,1,1)
 9814   IF lj_i% THEN
 9815     B%= &52544F50 
 9816     C%=4
 9817     cnfg%! 4 =USR(code_entry%+ 12 )
 9818     IF cnfg%! 4 =0 ERROR  253 , FNmsg_0(FNlj_host_desc,"FA5")
 9819     !cnfg%! 4 =lj_i%
 9820   ELSE
 9821     prnt%! 24 =prnt%! 24  OR 1<<6
 9822   ENDIF
 9823   REM try to read the default x and y resolutions and name from the PRDT block
 9824   lj_x%=FNprinter_read_integer_entry(prdt%,8)
 9825   lj_y%=FNprinter_read_integer_entry(prdt%,9)
 9826   lj_nm$=FNprinter_read_string_entry(prdt%,12)
 9827   IF lj_nm$<>"" THEN
 9828     REM try to find the graphics mode which matches this name
 9829     C%=1
 9830     REPEAT
 9831       B%=FNprinter_read_list_integer_entry(prdt%,4,C%,1)
 9832       IF B%=0 THEN
 9833         C%=-1
 9834       ELSE
 9835         lj_nm2$=FNprinter_read_string_entry(B%,8)
 9836         REM if no match, try the next mode
 9837         IFlj_nm$<>lj_nm2$ C%+=1
 9838       ENDIF
 9839     UNTIL C%=-1 OR lj_nm$=lj_nm2$
 9840     REM if we found it, remember where it was
 9841     IF C%<>-1 lj_i%=C%
 9842   ELSE
 9843     IF (lj_x%<>0 AND lj_y%<>0) THEN
 9844       REM try to find the graphics mode which matches this resolution
 9845       C%=1
 9846       REPEAT
 9847         B%=FNprinter_read_list_integer_entry(prdt%,4,C%,1)
 9848         IF B%=0 THEN
 9849           C%=-1
 9850         ELSE
 9851           lj_s%=FNprinter_read_integer_entry(B%,4)
 9852           lj_t%=FNprinter_read_integer_entry(B%,5)
 9853           REM if no match, try the next mode
 9854           IFlj_s%<>lj_x% OR lj_t%<>lj_y% C%+=1
 9855         ENDIF
 9856       UNTIL C%=-1 OR (lj_s%=lj_x% AND lj_t%=lj_y%)
 9857       REM if we found it, remember where it was
 9858       IF C%<>-1 lj_i%=C%
 9859     ELSE
 9860       REM show we didn't match - which we couldn't 'cos we didn't have the values
 9861       C%=-1
 9862     ENDIF
 9863   ENDIF
 9864   IF C%=-1 THEN
 9865     C%=1
 9866     lj_i%= 0 
 9867     REPEAT
 9868       B%=FNprinter_read_list_integer_entry(prdt%,4,C%,1)
 9869       IF B%=0 THEN
 9870         REM run out of parameters, go back to the last one
 9871         C%-=1: lj_i%= -1 
 9872       ELSE
 9873         lj_x%=FNprinter_read_integer_entry(B%,4)
 9874         lj_y%=FNprinter_read_integer_entry(B%,5)
 9875         IF lj_x%<300 OR lj_y%<300 C%+=1 ELSE lj_i%= -1 
 9876       ENDIF
 9877     UNTIL lj_i%
 9878     lj_i%=C%
 9879   ENDIF
 9880   B%= &52544F50 
 9881   C%=4
 9882   cnfg%! 8 =USR(code_entry%+ 12 )
 9883   IF cnfg%! 8 =0 ERROR  253 , FNmsg_0(FNlj_host_desc,"FA5")
 9884   !cnfg%! 8 =FNprinter_read_list_integer_entry(prdt%,4,lj_i%,1)
 9885   REM ensure that the module is present in memory
 9886   lj_s$=FNprinter_read_string_entry(FNprinter_read_integer_entry(!cnfg%! 8 ,1),2)
 9887   IFFNrmload_latest_module(lj_s$, "Printers:PDumpers."+lj_s$)
 9888   REM ensure that the palette file needed at the resolution is cached
 9889   REM bit 23 of palette no. flags whether already ensured or not
 9890   lj_s$=STR$(FNprinter_read_integer_entry(!cnfg%! 8 ,2) AND &7FFFFF)
 9891   PROClj_ensure_resource_file("Resources.Printers.Palettes."+lj_s$,"Printers:Palettes."+lj_s$,!cnfg%! 8 )
 9892   REM initialise the quality
 9893   REM see if a quality was provided in the PDF
 9894   lj_i%=FNprinter_read_integer_entry(prdt%,10)
 9895   REM get the qualities available at the configured resolution
 9896   lj_s%=FNlj_get_quality_options(!cnfg%! 8 )
 9897   IF lj_i%<>0 THEN
 9898     lj_co%=lj_i% AND &FF
 9899     lj_ht%=(lj_i% AND &FF00)>>8
 9900     CASE lj_co% OF
 9901       WHEN 0: REM mono
 9902         IF (lj_s% AND 7) THEN
 9903           IF lj_ht%=4 AND (lj_s% AND 1)=0 lj_i%=0
 9904           IF lj_ht%=8 AND (lj_s% AND 2)=0 lj_i%=0
 9905           IF lj_ht%=1 AND (lj_s% AND 4)=0 lj_i%=0
 9906         ELSE
 9907           lj_i%=0
 9908         ENDIF
 9909       WHEN 1: REM greyscale
 9910         IF (lj_s% AND &70) THEN
 9911           IF lj_ht%=4 AND ((lj_s%>>4) AND 1)=0 lj_i%=0
 9912           IF lj_ht%=8 AND ((lj_s%>>4) AND 2)=0 lj_i%=0
 9913           IF lj_ht%=1 AND ((lj_s%>>4) AND 4)=0 lj_i%=0
 9914         ELSE
 9915           lj_i%=0
 9916         ENDIF
 9917       WHEN 2: REM colour
 9918         IF (lj_s% AND &700) THEN
 9919           IF lj_ht%=4 AND ((lj_s%>>8) AND 1)=0 lj_i%=0
 9920           IF lj_ht%=8 AND ((lj_s%>>8) AND 2)=0 lj_i%=0
 9921           IF lj_ht%=1 AND ((lj_s%>>8) AND 4)=0 lj_i%=0
 9922         ELSE
 9923           lj_i%=0
 9924         ENDIF
 9925     ENDCASE
 9926   ENDIF
 9927   IF lj_i%<>0 THEN
 9928     cnfg%! 12 =FNstore_integer(lj_i%)
 9929   ELSE
 9930     PROClj_decode_options(lj_s%,lj_co%,lj_ht%)
 9931     cnfg%! 12 =FNstore_integer(lj_ht%<<8 OR lj_co%)
 9932   ENDIF
 9933   $buff%=FNprinter_read_string_entry(prdt%,2)
 9934   B%=buff%
 9935   C%=2
 9936   prnt%! 40 =USR(code_entry%+ 28 )
 9937   lj_s$=FNprinter_read_string_entry(prdt%,3)
 9938   IF lj_s$<>"lj" $buff%=lj_s$:B%=buff%:C%=2:prnt%! 44 =USR(code_entry%+ 28 )
 9939   lj_s$=FNprinter_read_string_entry(prdt%,7)
 9940   REM fall back to going for the default
 9941   IF lj_s$="" lj_s$=FNmsg_0(psup%! 16 ,"PAP")
 9942   VDU: PROCftracef("initialise the best paper size we can find")
 9943   lj_i%=psize_head%
 9944   WHILE lj_s$<>FNprinter_read_string(lj_i%! 4 )
 9945     lj_i%=lj_i%! 0 
 9946     REM if we run out of paper entries, go for the first one
 9947     IF lj_i%=0 lj_i%=psize_head%: lj_s$=FNprinter_read_string(lj_i%! 4 )
 9948   ENDWHILE
 9949   prnt%! 36 =lj_i%
 9950   REM if this printer supports fast parallel, set the appropriate flag
 9951   lj_i%=FNprinter_read_integer_entry(prdt%,11)
 9952   IFlj_i%<>0 prnt%! 24  = prnt%! 24  OR (1<<7)
 9953   VDU: PROCftracef("PROClj_m4 done")
 9954 ENDPROC
 9955 DEF PROClj_ensure_resource_file(resource$,disc$,gprdt%)
 9956   LOCAL obj_type%,load_addr%,exec_addr%,file_size%,obj_attr%,rma_size%,rma_block%
 9957   LOCAL found_type%,found_load%,found_exec%,found_size%,c%,a%,w%,pnum%,reload_if_outofdate%
 9958   VDU: PROCftracef("lj_ensure_resource_file("+resource$+disc$+")")
 9959   REM We use this to load palette files for the printers in order to reduce
 9960   REM the probability of having to ask for the printers disc again later.
 9961   REM check for out of date palette if we have not ensured this one before (bit 23 of palette number)
 9962   pnum% = FNprinter_read_integer_entry(gprdt%,2)
 9963   reload_if_outofdate% = ((pnum% AND &800000) = 0)
 9964   PROCprinter_write_integer_entry(gprdt%,2,pnum% OR &800000):REM we (will) have ensured it
 9965   REM First of all, check if the file exists already
 9966   SYS "OS_File",17,"Resources:"+resource$ TO found_type%,,found_load%,found_exec%,found_size%: REM OS_FileReadNoPath
 9967   IF found_type% AND reload_if_outofdate%= 0  ENDPROC
 9968   SYS "OS_File",17,disc$ TO obj_type%,,load_addr%,exec_addr%,file_size%,obj_attr%: REM OS_FileReadNoPath
 9969   IF obj_type%<>1 SYS "OS_File",19,disc$,obj_type%: REM OS_FileMakeError
 9970   IF found_type% THEN
 9971     IFfound_load%=load_addr% AND found_exec%=exec_addr% AND found_size%=file_size% ENDPROC
 9972     REM cached palette is not the same as the one on disc
 9973     REM try to remove the cached palette
 9974     c%=OPENIN("Resources:"+resource$)
 9975     IFc%=0 ERROR  254 , FNmsg_1(FNlj_host_desc,"OKBB",resource$)
 9976     SYS"OS_FSControl",21,c% TO ,a%,w%
 9977     CLOSE#c%
 9978     IF(w%AND&FF)<>46 ERROR  254 , FNmsg_1(FNlj_host_desc,"OKBC",resource$)
 9979     a%-=(LENresource$+4ANDNOT3)+4
 9980     a%-=20
 9981     IFa%!-4 = &48434143 THEN
 9982       SYS"ResourceFS_DeregisterFiles",a%
 9983       SYS"OS_Module",7,,a%-4
 9984     ENDIF
 9985   ENDIF
 9986   rma_size%=20+(LEN resource$+4 AND NOT 3)+4+(file_size%+3 AND NOT 3): REM Size needed for this file only
 9987   VDU: PROCftracef("File "+disc$+", size "+STR$ file_size%)
 9988   REM claim some RMA for the file
 9989   SYS "OS_Module",6,,,rma_size%+8 TO,,rma_block%: REM OSModule_Alloc
 9990   REM Put a check tag at the beginning of the block
 9991   !rma_block%=&48434143:REM CACH
 9992   rma_block%+=4
 9993   REM Fill in the block
 9994   rma_block%!0=rma_size%
 9995   rma_block%!4=load_addr%
 9996   rma_block%!8=exec_addr%
 9997   rma_block%!12=file_size%
 9998   rma_block%!16=obj_attr%
 9999   $(rma_block%+20)=resource$
10000   rma_block%!(20+LEN resource$)=0  
10001   rma_block%!(20+(LEN resource$+4 AND NOT 3))=file_size%+4
10002   SYS "OS_File",16,disc$,rma_block%+20+(LEN resource$+4 AND NOT 3)+4: REM OS_FileLoadNoPath
10003   rma_block%!rma_size%=0: REM Terminator
10004   SYS "ResourceFS_RegisterFiles",rma_block%
10005 ENDPROC
10006 DEF PROClj_m5
10007   REM cache any palette files that are used by lj printers and ensure
10008   REM that the relevant PDumper modules are loaded
10009   LOCAL lj_prnt%,lj_cnfg%,lj_graphics_prdt%,lj_pal$
10010   VDU: PROCftracef("PROClj_m5")
10011   lj_prnt%=prnt%
10012   WHILE lj_prnt%>0
10013     IF lj_prnt%! 4 =psup% THEN
10014       REM got a printer in our class - cache the palette file
10015       lj_cnfg%=lj_prnt%! 16 
10016       lj_graphics_prdt%=!lj_cnfg%! 8 
10017       REM bit 23 of palette no. flags whether already ensured or not
10018       lj_pal$=STR$(FNprinter_read_integer_entry(lj_graphics_prdt%,2) AND &7FFFFF)
10019       PROClj_ensure_resource_file("Resources.Printers.Palettes."+lj_pal$,"Printers:Palettes."+lj_pal$,lj_graphics_prdt%)
10020       REM and ensure the pdumper module
10021       lj_pal$=FNprinter_read_string_entry(FNprinter_read_integer_entry(lj_graphics_prdt%,1),2)
10022       IFFNrmload_latest_module(lj_pal$, "Printers:PDumpers."+lj_pal$)
10023     ENDIF
10024     lj_prnt%=lj_prnt%! 0 
10025   ENDWHILE
10026 ENDPROC
10027 DEF PROClj_m6
10028   REM do whatever is necessary to prime the specified printer
10029   LOCAL lj_s$,lj_t$,lj_i%,lj_j%,xres%,yres%,halftone%,ptr%,pal%,dmp$,inf%,strip%,graphics_prdt%,text_prdt%
10030   LOCAL format_print%,local_pl%,local_pr%,local_pb%,local_pt%,local_ph%,local_A%,local_B%,local_G%,local_B$,B%,C%
10031   VDU: PROCftracef("PROClj_m6")
10032   REM 7 is the magic number for the dumper driver
10033   IF(lj_i% AND 1)=0 SYS"XPDriver_SelectDriver",7
10034   lj_s$=FNprinter_read_string(prnt%! 40 )
10035   IF lj_s$="" THEN
10036     lj_s$=$prnt%! 8 
10037     IF LEN lj_s$>20 THEN
10038       lj_i%=LEN lj_s$
10039       WHILE MID$(lj_s$,lj_i%,1)<>" " AND lj_i%>0
10040         lj_i%-=1
10041       ENDWHILE
10042       IF lj_i% lj_s$=LEFT$(lj_s$,lj_i%-1)ELSE lj_s$=LEFT$(lj_s$,20)
10043     ENDIF
10044   ENDIF
10045   graphics_prdt%=!cnfg%! 8 
10046   xres%=FNprinter_read_integer_entry(graphics_prdt%,4)
10047   yres%=FNprinter_read_integer_entry(graphics_prdt%,5)
10048   halftone%=(!cnfg%! 12  AND &FF00)>>8
10049   strip%=!cnfg%! 12  AND &FF
10050   REM WARNING!
10051   REM The comparison is made against strip type 2 (colour) or greater
10052   REM This assumes, therefore, that any strip types that are 2 or greater
10053   REM are colour which is currently true
10054   IF (strip% >= 2) THEN
10055    SYS"XPDriver_SetInfo",,xres%,yres%,1,lj_s$,xres%/halftone%,yres%/halftone% TO ptr%;lj_i%
10056   ELSE
10057    SYS"XPDriver_SetInfo",,xres%,yres%,0,lj_s$,xres%/halftone%,yres%/halftone% TO ptr%;lj_i%
10058   ENDIF
10059   IF (lj_i% AND 1) AND (ptr%<>0) THEN
10060     lj_s$="": ptr%+=4
10061     WHILE ?ptr%: lj_s$+=CHR$ ?ptr%: ptr%+=1: ENDWHILE
10062     ERROR  254 ,lj_s$
10063     ENDPROC
10064   ENDIF
10065   REM bit 23 of palette no. flags whether already ensured or not
10066   lj_s$=STR$(FNprinter_read_integer_entry(graphics_prdt%,2) AND &7FFFFF)
10067   B%= &46424450 
10068   C%=256
10069   pal%=USR(code_entry%+ 12 )
10070   IFpal%=0 ERROR  253 , FNmsg_0(FNlj_host_desc,"FA5")
10071   $pal%="Resources:$.Resources.Printers.Palettes."+lj_s$
10072   inf%=USR(code_entry%+ 12 )
10073   IFinf%=0 ERROR  253 , FNmsg_0(FNlj_host_desc,"FA5")
10074   $inf%=FNprinter_read_string_entry(graphics_prdt%,6)
10075   strip%=!cnfg%! 12  AND &FF
10076   IF strip%=5 THEN
10077    lj_i%=FNprinter_read_integer_entry(graphics_prdt%,1)
10078    lj_i%=FNprinter_read_integer_entry(lj_i%,1)
10079    SYS"XPDriver_MiscOp",&80000002,lj_i% TO ptr%;lj_i%
10080    IF(lj_i%AND1)=0 IF ptr%<>&80000002 IF(ptr% AND (1<<5))=0 strip%=3
10081   ENDIF
10082   PROClj_ensure_resource_file("Resources.Printers.Palettes."+lj_s$,"Printers:Palettes."+lj_s$,graphics_prdt%)
10083   REM Module name:
10084   lj_s$=FNprinter_read_string_entry(FNprinter_read_integer_entry(graphics_prdt%,1),2)
10085   dmp$="RMLoad Printers:PDumpers."+lj_s$+CHR$ 13
10086   REM set passes per line entry
10087   REM WARNING!
10088   REM The comparison is made against strip type 2 (colour) or greater
10089   REM This assumes, therefore, that any strip types that are 2 or greater
10090   REM are colour which is currently true
10091   IF strip%>=2 inf%? 3 =4 ELSE inf%? 3 =1
10092   REM set strip type field
10093   inf%? 4 =strip%
10094   REM set output bpp field
10095   IF strip%=0 inf%? 5 =1 ELSE inf%? 5 =8
10096   REM set num passes field
10097   IF strip%=3 inf%? 6 =3 ELSE inf%? 6 =1
10098   SYS "XPDriver_SetDriver",,FNprinter_read_integer_entry(FNprinter_read_integer_entry(graphics_prdt%,1),1),dmp$,pal%,inf%,FNprinter_read_integer_entry(graphics_prdt%,7)
10099   B%= &46424450 
10100   C%=pal%
10101   CALL code_entry%+ 16 
10102   C%=inf%
10103   CALL code_entry%+ 16 
10104   SYS"OS_CLI","Unset PDriver$TextChars1"
10105   lj_i%=FNprinter_read_integer_entry(prdt%,6): REM point to the chars PRDT block
10106   IF lj_i% THEN
10107     lj_i%=lj_i%! 8 
10108     WHILE lj_i%
10109       IF lj_i%? 4 =ASC"" THEN
10110         lj_s$=FNlj_hex2(ASC"")+FNlj_hex2(lj_i%? 5 )
10111         ptr%=lj_i%+ 6 
10112         lj_i%=lj_i%? 5 
10113         WHILE lj_i%
10114           lj_s$+=FNlj_hex2(?ptr%)
10115           ptr%+=1
10116           lj_i%-=1
10117         ENDWHILE
10118         SYS"OS_CLI","Set PDriver$TextChars1 "+lj_s$
10119       ELSE
10120         lj_i%=lj_i%! 0 
10121       ENDIF
10122     ENDWHILE
10123   ENDIF
10124   text_prdt%=!cnfg%! 4 
10125   lj_i%=prnt%! 36 
10126   lj_s$=$lj_i%! 4 
10127   lj_j%=0
10128   WHILE MID$(lj_s$,lj_j%,1)<>" " AND lj_j%<=LEN lj_s$
10129     lj_j%+=1
10130   ENDWHILE
10131   lj_t$="PT_"+LEFT$(lj_s$,lj_j%-1)
10132   lj_s$=FNmsg_0(psup%! 16 ,lj_t$)
10133   IF lj_s$=lj_t$ lj_s$=FNmsg_0(psup%! 16 ,"PT_A4")
10134   IF !cnfg%! 0  AND 1 THEN
10135     lj_t$=FNmsg_0(psup%! 16 ,"MANUAL_FEED")
10136   ELSE
10137     lj_t$=FNmsg_0(psup%! 16 ,"AUTO_FEED")
10138   ENDIF
10139   SYS"OS_CLI","Set PDumperLJ$Extra "+FNungstrans(lj_t$+lj_s$)
10140   format_print%=(!cnfg%! 0  AND 8)>>3
10141   local_pl%=lj_i%! 24 
10142   local_pr%=lj_i%! 28 
10143   local_pb%=lj_i%! 16 
10144   local_pt%=lj_i%! 20 
10145   local_ph%=lj_i%! 12 
10146   IF format_print%=0 THEN
10147     local_yt%=0
10148     WHILE local_yt%*12000<local_ph%-local_pt%
10149       local_yt%+=1
10150     ENDWHILE
10151     local_pt%=local_ph%-local_yt%*12000: REM 72000 DIV 6
10152     local_B%=(local_pr%-local_pl%)*10 DIV 72000
10153     local_A%=(local_pt%-local_pb%)*6 DIV 72000
10154   ELSE
10155     local_yt%=0
10156     WHILE local_yt%*9000<local_pl%
10157       local_yt%+=1
10158     ENDWHILE
10159     local_pl%=local_yt%*9000: REM 72000 DIV 8
10160     local_B%=((local_pt%-local_pb%)*16.66 DIV 72000 - 1)DIV 2
10161     local_A%=(local_pr%-local_pl%)*8 DIV 72000
10162   ENDIF
10163   IF !cnfg%! 0  AND %1000 local_G%=2 ELSE local_G%=0
10164   lj_t$="-Ph "+STR$ local_A%+" -Pw "+STR$ local_B%+" -Mt "+STR$ lj_i%! 36 
10165   lj_t$+=" -Mb "+STR$ lj_i%! 32 +" -Ml "+STR$ lj_i%! 40 
10166   lj_t$+=" -Mr "+STR$ lj_i%! 44 +" -Th "+STR$ local_G%+" -Nl |<10>|<13>"
10167   local_B$=FNungstrans(FNungstrans(FNlj_font(0)))
10168   IF local_B$<>"" lj_t$+=" -Rs "+local_B$
10169   local_B$=FNungstrans(FNungstrans(FNlj_font(2)))
10170   IF local_B$<>"" lj_t$+=" -Cd "+local_B$
10171   SYS"OS_CLI","Set PDriver$TextPage "+lj_t$
10172   VDU: PROCftracef("PROClj_m6 done")
10173 ENDPROC
10174 DEF PROClj_m7
10175   LOCAL queu%,lj_p%,B%,C%
10176   VDU: PROCftracef("PROClj_m7")
10177   queu%=!xbuff%
10178   lj_p%=queu%! 48 
10179   IF lj_p% THEN
10180     B%= &56525054 
10181     C%=lj_p%
10182     CALL code_entry%+ 16 
10183     queu%! 48 =0
10184   ENDIF
10185 ENDPROC
10186 DEF PROClj_p3
10187   VDU: PROCftracef("PROClj_p3")
10188   SYS"Wimp_CloseWindow",,xbuff%
10189 ENDPROC
10190 DEF PROClj_p6
10191   LOCAL wind%
10192   REM mouseclick on the configure window
10193   VDU: PROCftracef("PROClj_p6")
10194   CASE xbuff%!8 OF
10195     WHEN 2: REM menu
10196       CASE xbuff%!16 OF
10197         WHEN 20: PROClj_menu("ME1", -1 , -1 )
10198         WHEN 18: PROClj_menu("ME2", -1 , -1 )
10199         WHEN  4: PROClj_menu("ME3", -1 , -1 )
10200         WHEN 14: PROClj_menu("ME4", -1 , -1 )
10201         WHEN 23: PROClj_menu("ME5", -1 , -1 )
10202         WHEN 26: PROClj_menu("MP1", -1 , -1 )
10203       ENDCASE
10204     WHEN 4: REM select
10205       CASE xbuff%!16 OF
10206         WHEN 24
10207           wind%=xbuff%!12
10208           PROClj_save_configuration(wind%)
10209           !xbuff%=wind%
10210           SYS"Wimp_CloseWindow",,xbuff%
10211         WHEN 20: PROClj_menu("ME1", -1 , -1 )
10212         WHEN 18: PROClj_menu("ME2", -1 , -1 )
10213         WHEN  4: PROClj_menu("ME3", -1 , -1 )
10214         WHEN 14: PROClj_menu("ME4", -1 , -1 )
10215         WHEN 23: PROClj_menu("ME5", -1 , -1 )
10216         WHEN 26: PROClj_menu("MP1", -1 , -1 )
10217         WHEN 30
10218           !xbuff%=xbuff%!12
10219           SYS"Wimp_CloseWindow",,xbuff%
10220       ENDCASE
10221     WHEN 1: REM adjust
10222       IF xbuff%!16=24 THEN
10223         wind%=xbuff%!12
10224         PROClj_save_configuration(wind%)
10225       ENDIF
10226   ENDCASE
10227 ENDPROC
10228 DEF PROClj_p8
10229   REM a key press!
10230   LOCAL lj_i%
10231   VDU: PROCftracef("PROClj_p8")
10232   lj_i%=psup%! 20 
10233   WHILE lj_i%
10234     IF lj_i%! 4 =!xbuff% THEN
10235       IF xbuff%!24=13 THEN
10236         CASE $(lj_i%+ 16 )OF
10237           WHEN "configure"
10238             SYS "Wimp_CloseWindow",,xbuff%
10239             PROClj_save_configuration(!xbuff%)
10240         ENDCASE
10241       ELSE
10242         SYS "Wimp_ProcessKey",xbuff%!24
10243       ENDIF
10244       ENDPROC
10245     ENDIF
10246     lj_i%=lj_i%! 0 
10247   ENDWHILE
10248 ENDPROC
10249 DEF PROClj_p9
10250   LOCAL adjust%,wind%,icon%,ptr%,xres%,yres%
10251   VDU: PROCftracef("PROClj_p9")
10252   wind%=FNprinter_find_window(prnt%,"configure")
10253   adjust%=FNwas_adjust_used
10254   CASE lj_menu_chsn$ OF
10255     WHEN "ME1": icon%=3
10256     WHEN "ME2": icon%=17
10257     WHEN "ME3": icon%=15
10258     WHEN "ME4": icon%=13
10259     WHEN "ME5": icon%=22
10260     WHEN "MP1": icon%=25
10261   ENDCASE
10262   ptr%=lj_menu%+28+!xbuff%*24
10263   IF ptr%!8 AND &100 THEN
10264     PROCicon_write(wind%,icon%,$ptr%!12)
10265   ELSE
10266     PROCicon_write(wind%,icon%,$(ptr%+12))
10267   ENDIF
10268   IF lj_menu_chsn$="ME1" THEN
10269     REM if the resolution changes, we may have to change the quality as well
10270     lj_j%=prdt%!20
10271     lj_s$=FNicon_read(wind%,3)
10272     WHILE lj_j%
10273       lj_k%=!lj_j%! 8 
10274       IF (lj_s$=FNmsg_2(psup%! 16 ,"RES",STR$ !lj_k%!20,STR$ !lj_k%!24)) OR          (lj_s$=$(lj_k%!36)) THEN
10275         lj_s$=FNicon_read(wind%,15): lj_i%=INSTR(lj_s$,",")
10276         CASE LEFT$(lj_s$,lj_i%-1)OF
10277           WHEN FNmsg_0(psup%! 16 ,"CO1"):  lj_j%=1
10278           WHEN FNmsg_0(psup%! 16 ,"CO1s"): lj_j%=1
10279           WHEN FNmsg_0(psup%! 16 ,"CO2"):  lj_j%=2
10280           WHEN FNmsg_0(psup%! 16 ,"CO4"):  lj_j%=4
10281           WHEN FNmsg_0(psup%! 16 ,"CO5"):  lj_j%=5
10282           WHEN FNmsg_0(psup%! 16 ,"CO5s"): lj_j%=5
10283           OTHERWISE:                                 lj_j%=0
10284         ENDCASE
10285         lj_s$=MID$(lj_s$,lj_i%+2)
10286         CASE lj_s$ OF
10287           WHEN FNmsg_0(psup%! 16 ,"HT8"):  lj_i%=8
10288           WHEN FNmsg_0(psup%! 16 ,"HT8s"): lj_i%=8
10289           WHEN FNmsg_0(psup%! 16 ,"HT1"):  lj_i%=1
10290           WHEN FNmsg_0(psup%! 16 ,"HT1s"): lj_i%=1
10291           OTHERWISE:                                 lj_i%=4
10292         ENDCASE
10293         lj_k%=FNlj_get_quality_options(lj_k%)
10294         IF(lj_k% AND (7<<(lj_j%*4)))=0 lj_j%=-1
10295         IF lj_j%<>-1 THEN
10296           lj_j%=lj_k%>>lj_j%*4
10297           CASE lj_i% OF
10298             WHEN 4: IF(lj_j% AND 1)=0 lj_i%=-1
10299             WHEN 8: IF(lj_j% AND 2)=0 lj_i%=-1
10300             WHEN 1: IF(lj_j% AND 4)=0 lj_i%=-1
10301           ENDCASE
10302         ENDIF
10303         IF lj_j%=-1 OR lj_i%=-1 THEN
10304           PROClj_decode_options(lj_k%,lj_j%,lj_i%)
10305           PROCicon_write(wind%,15,FNlj_qual_name(lj_j% + (lj_i% << 8)))
10306         ENDIF
10307         lj_j%=0
10308       ELSE
10309         lj_j%=!lj_j%
10310       ENDIF
10311     ENDWHILE
10312   ENDIF
10313   IF adjust% THEN
10314     SYS"Wimp_GetPointerInfo",,xbuff%
10315     PROClj_menu(lj_menu_chsn$, 0 , 0 )
10316   ENDIF
10317 ENDPROC
10318 DEF PROClj_p17
10319   LOCAL wind%,lj_s$,lj_t$
10320   VDU: PROCftracef("PROClj_p17")
10321   CASE xbuff%!16 OF
10322     WHEN &502
10323       wind%=psup%! 20 
10324       WHILE wind%
10325         IF wind%! 4 =xbuff%!32 THEN
10326           CASE $(wind%+ 16 ) OF
10327             WHEN "configure"
10328               lj_s$=STR$ xbuff%!36
10329               CASE xbuff%!36 OF
10330                 WHEN 8,11,12
10331                   IF FNicon_set(xbuff%!32,xbuff%!36)lj_s$+="b" ELSE lj_s$+="a"
10332               ENDCASE
10333               lj_t$=FNmsg_0(psup%! 16 ,"CON"+lj_s$)
10334               IF lj_t$="CON"+lj_s$ lj_t$=FNmsg_0(psup%! 16 ,"CON")
10335               PROCinteractive_help(lj_t$)
10336           ENDCASE
10337           wind%=0
10338         ELSE
10339           wind%=wind%! 0 
10340           IF wind%=0 PROCinteractive_help(FNmsg_0(psup%! 16 ,"H"+lj_menu_chsn$))
10341         ENDIF
10342       ENDWHILE
10343   ENDCASE
10344 ENDPROC
10345 DEF PROClj_save_configuration(window%)
10346   LOCAL lj_i%,lj_j%,lj_k%,lj_s$,B%,C%
10347   VDU: PROCftracef("PROClj_save_configuration_window")
10348   prdt%=FNprinter_find_prdata_entry(psup%,FNicon_read(window%,6))
10349   PROCfree_structure(prnt%! 40 )
10350   $buff%=FNicon_read(window%,27)
10351   B%=buff%
10352   C%=2
10353   prnt%! 40 =USR(code_entry%+ 28 )
10354   lj_i%=cnfg%
10355   FOR lj_j%=1 TO  16 /4
10356     PROCfree_structure(!lj_i%)
10357     !lj_i%=0
10358     lj_i%+=4
10359   NEXT
10360   lj_j%=0
10361   IF FNicon_read(window%,17)=FNmsg_0(psup%! 16 ,"PF1")lj_j%+=1
10362   IF FNicon_set(window%,8)lj_j%+=2
10363   IF FNicon_set(window%,11)lj_j%+=4
10364   IF FNicon_read(window%,13)=FNmsg_0(psup%! 16 ,"PO1")lj_j%+=8
10365   CASE FNicon_read(window%,22)OF
10366     WHEN FNmsg_0(psup%! 16 ,"CC1"): lj_j%+=1<<8
10367     WHEN FNmsg_0(psup%! 16 ,"CC2"): lj_j%+=1<<9
10368   ENDCASE
10369   cnfg%! 0 =FNstore_integer(lj_j%)
10370   REM portrait mode is no-highlights entry
10371   REM landscape mode is drafts entry
10372   IF lj_j% AND 8 THEN
10373     lj_j%=FNprinter_read_list_integer_entry(prdt%,5,2,1)
10374   ELSE
10375     lj_j%=FNprinter_read_list_integer_entry(prdt%,5,1,1)
10376   ENDIF
10377   IF lj_j% THEN
10378     B%= &52544F50 
10379     C%=4
10380     cnfg%! 4 =USR(code_entry%+ 12 )
10381     IF cnfg%! 4 =0 ERROR  253 , FNmsg_0(FNlj_host_desc,"FA5")
10382     !cnfg%! 4 =lj_j%
10383     prnt%! 24 =prnt%! 24  AND NOT(1<<6)
10384   ELSE
10385     prnt%! 24 =prnt%! 24  OR 1<<6
10386   ENDIF
10387   REM point to the resolution possibilities
10388   lj_j%=prdt%!20: REM printer name is 8, short name is 12, sprite name is 16, resolution is 20
10389   lj_s$=FNicon_read(window%,3)
10390   WHILE lj_j%
10391     lj_k%=!lj_j%! 8 : REM get the pointer
10392     REM module is 8, palette is 12, options is 16, pxres is 20, pyres is 24
10393     IF (lj_s$=FNmsg_2(psup%! 16 ,"RES",STR$ !lj_k%!20,STR$ !lj_k%!24)) OR        (lj_s$=$(lj_k%!36)) THEN
10394       lj_j%=0
10395     ELSE
10396       lj_j%=!lj_j%
10397     ENDIF
10398   ENDWHILE
10399   B%= &52544F50 
10400   C%=4
10401   cnfg%! 8 =USR(code_entry%+ 12 )
10402   IF cnfg%! 8 =0 ERROR  253 , FNmsg_0(FNlj_host_desc,"FA5")
10403   !cnfg%! 8 =lj_k%
10404   lj_s$=FNicon_read(window%,15)
10405   lj_i%=INSTR(lj_s$,",")
10406   CASE LEFT$(lj_s$,lj_i%-1)OF
10407     WHEN FNmsg_0(psup%! 16 ,"CO1"):  lj_j%=1
10408     WHEN FNmsg_0(psup%! 16 ,"CO1s"): lj_j%=1
10409     WHEN FNmsg_0(psup%! 16 ,"CO2"):  lj_j%=2
10410     WHEN FNmsg_0(psup%! 16 ,"CO4"):  lj_j%=4
10411     WHEN FNmsg_0(psup%! 16 ,"CO5"):  lj_j%=5
10412     WHEN FNmsg_0(psup%! 16 ,"CO5s"): lj_j%=5
10413     OTHERWISE: lj_j%=0
10414   ENDCASE
10415   lj_s$=MID$(lj_s$,lj_i%+2)
10416   CASE lj_s$ OF
10417     WHEN FNmsg_0(psup%! 16 ,"HT8"):  lj_i%=8
10418     WHEN FNmsg_0(psup%! 16 ,"HT8s"): lj_i%=8
10419     WHEN FNmsg_0(psup%! 16 ,"HT1"):  lj_i%=1
10420     WHEN FNmsg_0(psup%! 16 ,"HT1s"): lj_i%=1
10421     OTHERWISE:                                 lj_i%=4
10422   ENDCASE
10423   cnfg%! 12 =FNstore_integer((lj_i%<<8)+lj_j%)
10424   lj_j%=prnt%! 36 
10425   lj_s$=FNicon_read(window%,25)
10426   IF $lj_j%! 4 <>lj_s$ THEN
10427     lj_i%=psize_head%
10428     WHILE lj_i%
10429       IF $lj_i%! 4 =lj_s$ THEN
10430         prnt%! 36 =lj_i%
10431         lj_i%=0
10432       ELSE
10433         lj_i%=!lj_i%
10434       ENDIF
10435     ENDWHILE
10436   ENDIF
10437   IF prnt%! 20 <>-1 THEN
10438     REM this printer is ACTIVE!
10439     REM ensure that its details are correct
10440     PROCselect_printer(prnt%, -1 , 0 )
10441     REM The front end code will spot that the selected printer has
10442     REM changed and put everything back the way it was
10443     REM PROCselect_printer(0, -1 , -1 ): REM don't do this (calls into overlay). JRC 12 Feb '92
10444   ENDIF
10445 ENDPROC
10446 DEF FNlj_res(cnfg%)
10447   LOCAL xres%,yres%,graphics_prdt%,nm$
10448   VDU: PROCftracef("FNlj_res")
10449   graphics_prdt%=!cnfg%! 8 
10450   xres%=FNprinter_read_integer_entry(graphics_prdt%,4)
10451   yres%=FNprinter_read_integer_entry(graphics_prdt%,5)
10452   nm$=FNprinter_read_string_entry(graphics_prdt%,8)
10453   IF nm$="" THEN  nm$=FNmsg_2(psup%! 16 ,"RES",STR$ xres%,STR$ yres%)
10454 =nm$
10455 DEF FNlj_qual_name(lj_i%)
10456   LOCAL lj_s$,lj_t$
10457   IF LJQ$ = "S" THEN
10458     lj_s$=FNmsg_0(psup%! 16 ,"CO"+STR$(lj_i% AND &FF)+"s")
10459     lj_t$=FNmsg_0(psup%! 16 ,"HT"+STR$((lj_i% AND &FF00)>>8)+"s")
10460   ELSE
10461     lj_s$=FNmsg_0(psup%! 16 ,"CO"+STR$(lj_i% AND &FF))
10462     lj_t$=FNmsg_0(psup%! 16 ,"HT"+STR$((lj_i% AND &FF00)>>8))
10463   ENDIF
10464 =lj_s$+", "+lj_t$
10465 DEF FNlj_qual(cnfg%)
10466   LOCAL lj_i%
10467   VDU: PROCftracef("FNlj_qual")
10468   lj_i%=!cnfg%! 12 
10469 =FNlj_qual_name(lj_i%)
10470 DEF FNlj_get_quality_options(graphics_definition%)
10471 LOCAL s%,c%,t%
10472 s%=FNprinter_read_integer_entry(graphics_definition%,3)
10473 REM if colour small halftone present, add colour large halftone
10474 IF (s% AND &100) s% = s% OR &200
10475 REM if colour available, add new colour options
10476 IF (s% AND &700) THEN
10477  t%=FNprinter_read_integer_entry(graphics_definition%,1):REM ptr to module defn
10478  t%=FNprinter_read_integer_entry(t%,1):REM module number
10479  REM pass the MiscOp through to the dumper driver
10480  SYS"XPDriver_MiscOpForDriver",&80000002,t%,,,,,,,7 TO t%;c%:REM strip type mask
10481  IF(c%AND1)=0 AND t%<>&80000002 THEN
10482   IF (t% AND (1<<3)) THEN
10483    REM add strip type 3 based on the greyscale options (or colour, if no grey)
10484    c%=s% AND &70
10485    IF c%=0 THEN c%=(s% AND &700)>>4
10486    s%=s% OR (c%<<16)
10487   ENDIF
10488   IF (t% AND (1<<4)) THEN
10489    REM add strip type 4 based on the colour options
10490    c%=s% AND &700
10491    s%=s% OR (c%<<8)
10492   ENDIF
10493   IF (t% AND (1<<5)) THEN
10494    REM add strip type 5 based on the colour options
10495    c%=s% AND &700
10496    s%=s% OR (c%<<12)
10497   ENDIF
10498  ENDIF
10499 ENDIF
10500 REM If simple qualities, knock out Mono,256 colours,32k colours
10501 IF LJQ$ = "S" s%=s% AND &700070
10502 =s%
10503 REM If LJQ$ = "S" then the following qualities are
10504 REM actually deemed not to exist:
10505 REM - Any 'Mono'; '256 colours'; '32k colours'
10506 REM This procedure tries to find a good default quality to pick.
10507 REM Modified on 22-Jul-93/3-Dec-93 to pick in this order:
10508 REM Modified on 02-Aug-95 to favour error diff instead of halftone
10509 REM * 16 million, diffused
10510 REM * colour, diffused
10511 REM * grey, diffused
10512 REM * mono, diffused
10513 REM
10514 REM The option value is split into 3 nibbles:
10515 REM &7xxxxx = 24bpp colour, either strip type 3 or 5 depending on
10516 REM                        whether or not it is a full colour system
10517 REM &x7xxxx = 16bpp colour, strip type 4
10518 REM &xxx7xx = colour, strip type 2
10519 REM &xxxx7x = greyscale, strip type 1
10520 REM &xxxxx7 = monochrome, strip type 0
10521 REM
10522 REM Within the 3 nibbles, the following values are valid:
10523 REM 1 = small halftone, tone type 4
10524 REM 2 = large halftone, tone type 8
10525 REM 4 = dithered, tone type 1
10526 DEF PROClj_decode_options(option%,RETURN strip%,RETURN tone%)
10527   VDU: PROCftracef("PROClj_decode_options")
10528   REM try to pick colour, then grey, then mono
10529   IF option% AND &700000 THEN
10530    strip%=5
10531   ELSE
10532    IF option% AND &700 THEN
10533     strip%=2
10534    ELSE
10535     IF option% AND &70 THEN
10536      strip%=1
10537     ELSE
10538      REM force grey if "Simple" (Mono not allowed)
10539      IF LJQ$ = "S" THEN strip%=1 ELSE strip%=0
10540     ENDIF
10541    ENDIF
10542   ENDIF
10543   REM find out what is available now
10544   option%=option%>>(strip%*4)
10545   tone%=-1
10546   IF (strip%=5 AND (option% AND 4)<>0) tone%=1
10547   IF (strip%=2 AND (option% AND 4)<>0) tone%=1
10548   IF (strip%=1 AND (option% AND 4)<>0) tone%=1
10549   IF (strip%=0 AND (option% AND 4)<>0) tone%=1
10550   IF tone%=-1 THEN
10551     IF option% AND 4 THEN
10552       tone%=1
10553     ELSE
10554       IF option% AND 2 THEN
10555         tone%=8
10556       ELSE
10557         tone%=4
10558       ENDIF
10559     ENDIF
10560   ENDIF
10561 ENDPROC
10562 DEF PROClj_menu(top$,rebuild%,iconpos%)
10563   LOCAL wind%,lj_ix%,lj_iy%,lj_i%,lj_x%,lj_j%,lj_k%,xres%,yres%,indt%,nm$
10564   VDU: PROCftracef("PROClj_menu")
10565   IF rebuild% THEN
10566     lj_menu_xpos%=xbuff%!0-64
10567     lj_menu_ypos%=xbuff%!4
10568   ENDIF
10569   IF iconpos% THEN
10570     !buff%=xbuff%!12
10571     buff%!4=xbuff%!16
10572     SYS"Wimp_GetIconState",,buff%
10573     lj_ix%=buff%!16
10574     lj_iy%=buff%!20
10575     SYS"Wimp_GetWindowState",,buff%
10576     lj_menu_xpos%=buff%!20+buff%!4+lj_ix%+2
10577     lj_menu_ypos%=buff%!24+buff%!16+lj_iy%-2
10578   ENDIF
10579   wind%=FNprinter_find_window(prnt%,"configure")
10580   lj_menu_chsn$=top$
10581   REM because of the way the configuration window works,
10582   REM we have to adjust prdt% to point to the printer data
10583   REM record for the printer specified in the window, NOT
10584   REM the current printer.
10585   prdt%=FNprinter_find_prdata_entry(psup%,FNicon_read(wind%,6))
10586   CASE top$ OF
10587     WHEN "ME1"
10588       PROCmenu_create(lj_menu%,FNmsg_0(psup%! 16 ,"ME1"))
10589       indt%=(lj_menu%!28 AND &100)<>0
10590       REM get the resolution strings for this printer
10591       lj_j%=prdt%!20
10592       lj_i%=0
10593       lj_x%=0
10594       WHILE lj_j%
10595         lj_k%=!lj_j%! 8 
10596         xres%=FNprinter_read_integer_entry(lj_k%,4)
10597         yres%=FNprinter_read_integer_entry(lj_k%,5)
10598         nm$=FNprinter_read_string_entry(lj_k%,8)
10599         IF nm$<>"" THEN
10600           PROCmenu_item(lj_menu%,lj_i%,nm$,indt%)
10601         ELSE
10602           PROCmenu_item(lj_menu%,lj_i%,FNmsg_2(psup%! 16 ,"RES",STR$ xres%,STR$ yres%),indt%)
10603         ENDIF
10604         lj_i%+=1
10605         lj_j%=!lj_j%
10606       ENDWHILE
10607       PROCmenu_tick_match(lj_menu%,FNicon_read(wind%,3))
10608     WHEN "ME2"
10609       PROCmenu_create(lj_menu%,FNmsg_0(psup%! 16 ,"ME2"))
10610       PROCmenu_tick_match(lj_menu%,FNicon_read(wind%,17))
10611     WHEN "ME3"
10612       PROCmenu_create(lj_menu%,FNmsg_0(psup%! 16 ,"ME3"))
10613       REM need to find the right graphics entry for the current resolution
10614       lj_j%=prdt%!20: REM point to first record for this list
10615       WHILE lj_j%
10616         lj_k%=!lj_j%! 8 
10617         IF (FNicon_read(wind%,3)=FNmsg_2(psup%! 16 ,"RES",STR$ !lj_k%!20,STR$ !lj_k%!24)) OR            (FNicon_read(wind%,3)=$(lj_k%!36)) THEN
10618           REM ok - found the graphics entry, now get the options word
10619           lj_j%=FNlj_get_quality_options(lj_k%)
10620           lj_i%=0
10621           lj_x%=0
10622           IF lj_j% AND &000007 PROClj_menu_quality(lj_menu%,lj_i%,FNmsg_0(psup%! 16 ,"CO0"),lj_j%)
10623           IF lj_j% AND &000070 THEN
10624             IF LJQ$="S" THEN
10625               PROClj_menu_quality(lj_menu%,lj_i%,FNmsg_0(psup%! 16 ,"CO1s"),lj_j%>>4)
10626             ELSE
10627               PROClj_menu_quality(lj_menu%,lj_i%,FNmsg_0(psup%! 16 ,"CO1"),lj_j%>>4)
10628             ENDIF
10629           ENDIF
10630           IF lj_j% AND &000700 PROClj_menu_quality(lj_menu%,lj_i%,FNmsg_0(psup%! 16 ,"CO2"),lj_j%>>8)
10631           IF lj_j% AND &070000 PROClj_menu_quality(lj_menu%,lj_i%,FNmsg_0(psup%! 16 ,"CO4"),lj_j%>>16)
10632           IF lj_j% AND &700000 THEN
10633             IF LJQ$="S" THEN
10634               PROClj_menu_quality(lj_menu%,lj_i%,FNmsg_0(psup%! 16 ,"CO5s"),lj_j%>>20)
10635             ELSE
10636               PROClj_menu_quality(lj_menu%,lj_i%,FNmsg_0(psup%! 16 ,"CO5"),lj_j%>>20)
10637             ENDIF
10638           ENDIF
10639           lj_j%=0
10640         ELSE
10641           lj_j%=!lj_j%
10642         ENDIF
10643       ENDWHILE
10644       PROCmenu_tick_match(lj_menu%,FNicon_read(wind%,15))
10645     WHEN "ME4"
10646       IFFNprinter_read_list_integer_entry(prdt%,5,2,1)<>0 THEN
10647         PROCmenu_create(lj_menu%,FNmsg_0(psup%! 16 ,"ME4a"))
10648       ELSE
10649         PROCmenu_create(lj_menu%,FNmsg_0(psup%! 16 ,"ME4b"))
10650       ENDIF
10651       PROCmenu_tick_match(lj_menu%,FNicon_read(wind%,13))
10652     WHEN "ME5"
10653       PROCmenu_create(lj_menu%,FNmsg_0(psup%! 16 ,"ME5"))
10654       PROCmenu_tick_match(lj_menu%,FNicon_read(wind%,22))
10655     WHEN "MP1"
10656       PROCcreate_paper_menu(lj_menu%,wind%,25)
10657   ENDCASE
10658   PROCdisplay_menu(prnt%,lj_menu%,lj_menu_xpos%,lj_menu_ypos%)
10659 ENDPROC
10660 DEF PROClj_menu_quality(RETURN lj_menu%,RETURN lj_i%,strip$,tone%)
10661   LOCAL indt%
10662   VDU: PROCftracef("PROClj_menu")
10663   indt%=(lj_menu%!28 AND &100)<>0
10664   IF tone% AND 1 THEN
10665     IF LJQ$="S" THEN
10666       PROCmenu_item(lj_menu%,lj_i%,strip$+", "+FNmsg_0(psup%! 16 ,"HT4s"),indt%)
10667     ELSE
10668       PROCmenu_item(lj_menu%,lj_i%,strip$+", "+FNmsg_0(psup%! 16 ,"HT4"),indt%)
10669     ENDIF
10670     lj_i%+=1
10671   ENDIF
10672   IF tone% AND 2 THEN
10673     IF LJQ$="S" THEN
10674       PROCmenu_item(lj_menu%,lj_i%,strip$+", "+FNmsg_0(psup%! 16 ,"HT8s"),indt%)
10675     ELSE
10676       PROCmenu_item(lj_menu%,lj_i%,strip$+", "+FNmsg_0(psup%! 16 ,"HT8"),indt%)
10677     ENDIF
10678     lj_i%+=1
10679   ENDIF
10680   IF tone% AND 4 THEN
10681     IF LJQ$="S" THEN
10682       PROCmenu_item(lj_menu%,lj_i%,strip$+", "+FNmsg_0(psup%! 16 ,"HT1s"),indt%)
10683     ELSE
10684       PROCmenu_item(lj_menu%,lj_i%,strip$+", "+FNmsg_0(psup%! 16 ,"HT1"),indt%)
10685     ENDIF
10686     lj_i%+=1
10687   ENDIF
10688 ENDPROC
10689 DEF FNlj_hex2(v%)
10690   VDU: PROCftracef("PROClj_hex2")
10691 =RIGHT$("00"+STR$~v%,2)
10692 REM text printing code
10693 DEF PROClj_m8
10694   LOCAL lj_r%,queu%,tpub%,tprv%,text_prdt%
10695   VDU: PROCftracef("PROClj_m8")
10696   text_prdt%=!cnfg%! 4 
10697   lj_r%=!xbuff%
10698   queu%=xbuff%!4
10699   tpub%=queu%! 44 
10700   tprv%=queu%! 48 
10701   CASE lj_r% OF
10702     WHEN  -1: PROClj_1
10703     WHEN  -2: PROClj_2
10704     WHEN  -4: PROClj_4
10705     WHEN  -6: PROClj_6
10706     WHEN  -7: PROClj_7
10707     WHEN  -9: PROClj_9
10708     WHEN -10: PROClj_10
10709     WHEN -11: PROClj_11
10710     WHEN -12: PROClj_12
10711     WHEN -13: PROClj_13
10712     WHEN -15: PROClj_15
10713     WHEN -16: PROClj_16
10714     WHEN -17: PROClj_17
10715     WHEN -18: PROClj_18
10716     WHEN -19: PROClj_19
10717   ENDCASE
10718 ENDPROC
10719 DEF PROClj_1
10720   LOCAL lj_i%,lj_i$,lj_j%,B%,C%
10721   VDU: PROCftracef("PROClj_1")
10722   B%= &56525054 
10723   C%= 36 
10724   tprv%=USR(code_entry%+ 12 )
10725   IF tprv%=0 ERROR  253 , FNmsg_0(FNlj_host_desc,"FA5")
10726   queu%! 48 =tprv%
10727   FOR lj_i%=0 TO  36 -4
10728     tprv%!lj_i%=0
10729   NEXT
10730   lj_j%=!cnfg%! 0 
10731   tpub%! 44 =(lj_j% AND &FF00)>>8
10732   IF lj_j% AND 4 THEN
10733     tpub%! 48 = -1 
10734     tprv%! 8 =6
10735   ELSE
10736     tprv%! 8 =0
10737   ENDIF
10738   IF lj_j% AND 2 tpub%! 52 = -1 
10739   lj_i$=FNprinter_read_string_entry(text_prdt%,6)
10740   B%=A%! 16 
10741   $B%=lj_i$
10742   C%=5
10743   D%=LEN lj_i$
10744   tpub%! 108 =USR(code_entry%+ 28 )
10745   REM set the pointer to the char translation list
10746   lj_j%=FNprinter_read_integer_entry(prdt%,6): REM point to the PRDT block
10747   IF lj_j% lj_j%=lj_j%! 8 
10748   queu%! 64 =lj_j%
10749 ENDPROC
10750 DEF PROClj_2
10751   REM output job start strings
10752   LOCAL format_print%,lj_pl%,lj_pr%,lj_pb%,lj_pt%,lj_ph%,psze%,lj_yt%
10753   LOCAL lj_i%, lj_j%, lj_s$, lj_t$
10754   VDU: PROCftracef("PROClj_2")
10755   REM first reset the printer
10756   BPUT#xbuff%!8,CHR$ 27+"E";
10757   REM set paper feed ...
10758   IF !cnfg%! 0  AND 1 THEN
10759     lj_s$=FNmsg_0(psup%! 16 ,"MANUAL_FEED")
10760   ELSE
10761     lj_s$=FNmsg_0(psup%! 16 ,"AUTO_FEED")
10762   ENDIF
10763   IF lj_s$<>"" THEN
10764     SYS "OS_GSTrans",lj_s$,buff%,256 TO ,,lj_j%
10765     lj_i%=0
10766     WHILE lj_j%: BPUT#xbuff%!8,buff%?lj_i%: lj_i%+=1: lj_j%-=1: ENDWHILE
10767   ENDIF
10768   REM set paper size ...
10769   lj_i%=prnt%! 36 
10770   lj_s$=$lj_i%! 4 
10771   lj_j%=0
10772   WHILE MID$(lj_s$,lj_j%,1)<>" " AND lj_j%<=LEN lj_s$
10773     lj_j%+=1
10774   ENDWHILE
10775   lj_t$="PT_"+LEFT$(lj_s$,lj_j%-1)
10776   lj_s$=FNmsg_0(psup%! 16 ,lj_t$)
10777   IF lj_s$=lj_t$ lj_s$=FNmsg_0(psup%! 16 ,"PT_A4")
10778   IF lj_s$<>"" THEN
10779     SYS "OS_GSTrans",lj_s$,buff%,256 TO ,,lj_j%
10780     lj_i%=0
10781     WHILE lj_j%: BPUT#xbuff%!8,buff%?lj_i%: lj_i%+=1: lj_j%-=1: ENDWHILE
10782   ENDIF
10783   format_print%=(!cnfg%! 0  AND 8)>>3
10784   psze%=prnt%! 36 
10785   lj_pl%=psze%! 24 
10786   lj_pr%=psze%! 28 
10787   lj_pb%=psze%! 16 
10788   lj_pt%=psze%! 20 
10789   lj_ph%=psze%! 12 
10790   IF format_print%=0 THEN
10791     REM portrait
10792     lj_yt%=0
10793     WHILE lj_yt%*12000<lj_ph%-lj_pt%
10794       lj_yt%+=1
10795     ENDWHILE
10796     lj_pt%=lj_ph%-lj_yt%*12000: REM 72000 DIV 6
10797     lj_yt%+=psze%! 36 
10798     tpub%! 100 =(lj_pr%-lj_pl%)*10 DIV 72000
10799     tprv%! 16 =(lj_pt%-lj_pb%)*6 DIV 72000
10800   ELSE
10801     lj_yt%=0
10802     WHILE lj_yt%*9000<lj_pl%
10803       lj_yt%+=1
10804     ENDWHILE
10805     lj_pl%=lj_yt%*9000: REM 72000 DIV 8
10806     lj_yt%+=psze%! 36 
10807     tpub%! 100 =((lj_pt%-lj_pb%)*16.66 DIV 72000 -1) DIV 2
10808     tprv%! 16 =(lj_pr%-lj_pl%)*8 DIV 72000
10809   ENDIF
10810   tprv%! 28 =psze%! 44 
10811   tpub%! 100 -=tprv%! 28 
10812   tprv%! 16 -=psze%! 36 +psze%! 32 
10813   lj_s$=FNprinter_read_string_entry(text_prdt%,7)
10814   IFlj_s$<>"" BPUT#xbuff%!8,lj_s$;
10815   REM finally, set the number of lines per page
10816   BPUT#xbuff%!8,CHR$ 27+"&l"+STR$(tprv%! 16 +lj_yt%)+"F";
10817   tprv%! 12 =tpub%! 100 
10818   tprv%! 24 =psze%! 40 
10819   tprv%! 32 =0
10820   tprv%! 20 =lj_yt%
10821   tpub%! 76 =tprv%! 16 
10822   tprv%! 4 =tprv%! 24 
10823   IF tpub%! 48  tprv%! 4 +=6
10824 ENDPROC
10825 DEF PROClj_4
10826   REM no data to output
10827   VDU: PROCftracef("PROClj_4")
10828   xbuff%?8=0
10829 ENDPROC
10830 DEF PROClj_6
10831   REM do control code processing
10832   LOCAL lj_b$
10833   VDU: PROCftracef("PROClj_6")
10834   lj_b$=FNlj_display(xbuff%!8)
10835   xbuff%?8=LEN lj_b$
10836   $(xbuff%+9)=lj_b$
10837 ENDPROC
10838 DEF PROClj_7
10839   REM process a backspace
10840   LOCAL lj_b$
10841   VDU: PROCftracef("PROClj_7")
10842   lj_b$=FNprinter_read_string_entry(text_prdt%,2)
10843   xbuff%?8=LEN(lj_b$)
10844   $(xbuff%+9)=lj_b$
10845 ENDPROC
10846 DEF PROClj_9
10847   LOCAL changed_bits%,clr_bits%,set_bits%,bit%,lj_b$
10848   VDU: PROCftracef("PROClj_9")
10849   changed_bits%=tpub%! 96  EOR xbuff%!8
10850   clr_bits%=tpub%! 96  AND changed_bits%
10851   set_bits%=changed_bits% AND NOTclr_bits%
10852   IF clr_bits% OR set_bits% THEN
10853     FOR bit%=0 TO 5
10854       IF clr_bits% AND 1<<bit% lj_b$+=FNlj_style_off(bit%)
10855       IF set_bits% AND 1<<bit% lj_b$+=FNlj_style_on(bit%)
10856     NEXT
10857   ENDIF
10858   xbuff%?8=LEN lj_b$
10859   $(xbuff%+9)=lj_b$
10860 ENDPROC
10861 DEF PROClj_10
10862   REM end the previous line and start a new line
10863   LOCAL lj_b$,wrap%,line_num$,lj_bit%
10864   VDU: PROCftracef("PROClj_10")
10865   tpub%! 80 +=1
10866   tpub%! 72 +=1
10867   FOR lj_bit%=0 TO 5
10868     IF tpub%! 96  AND 1<<lj_bit% lj_b$+=FNlj_style_off(lj_bit%)
10869   NEXT
10870   REM lj_b$+=FNprinter_read_string_entry(text_prdt%,6)
10871   lj_b$+=CHR$ 27+"&a"
10872   lj_b$+=STR$(tprv%! 24 +tprv%! 32 +tprv%! 0 *(tprv%! 12 +1))+"C"
10873   wrap%=(tpub%! 56 >=tpub%! 100 )
10874   IF tpub%! 48  THEN
10875     REM print line number unless wrapped line
10876     lj_b$+=FNlj_font(0)
10877     IF wrap% THEN
10878       tpub%! 72 -=1
10879       lj_b$+=STRING$(6," ")
10880     ELSE
10881       line_num$=STR$ tpub%! 72 
10882       lj_b$+=STRING$(5-LEN line_num$," ")+line_num$+" "
10883     ENDIF
10884     lj_b$+=FNlj_font(tpub%! 64 )
10885     tpub%! 56 =6
10886   ELSE
10887     tpub%! 56 =0
10888   ENDIF
10889   IF wrap% THEN
10890     tpub%! 56 +=1
10891     lj_b$+=FNlj_style_on(0)+"|"+FNlj_style_off(0)
10892   ENDIF
10893   FOR lj_bit%=0 TO 5
10894     IF tpub%! 96  AND 1<<lj_bit% lj_b$+=FNlj_style_on(lj_bit%)
10895   NEXT
10896   tpub%! 56 +=tprv%! 24 +tprv%! 32 
10897   xbuff%?8=LEN lj_b$
10898   $(xbuff%+9)=lj_b$
10899 ENDPROC
10900 DEF PROClj_11
10901   REM print a footnote number
10902   LOCAL lj_b$,lj_i%
10903   VDU: PROCftracef("PROClj_11")
10904   PROClj_10: lj_b$=FNprinter_read_string(tpub%! 108 )+$(xbuff%+9)
10905   PROClj_10: lj_b$+=FNprinter_read_string(tpub%! 108 )+$(xbuff%+9)
10906   lj_b$+=FNlj_style_on(4): REM superscript
10907   lj_b$+=FNlj_trans(RIGHT$("  "+STR$ tpub%! 60 ,3)+STRING$(3,FNprinter_read_string_entry(text_prdt%,2)))
10908   lj_b$+=FNlj_style_off(4)
10909   xbuff%?8=LEN lj_b$
10910   $(xbuff%+9)=lj_b$
10911 ENDPROC
10912 DEF PROClj_12
10913   REM do bulk string translation
10914   LOCAL lj_b$
10915   VDU: PROCftracef("PROClj_12")
10916   lj_b$=FNlj_trans($(xbuff%+8))
10917   xbuff%?8=LEN lj_b$
10918   $(xbuff%+9)=lj_b$
10919 ENDPROC
10920 DEF PROClj_13
10921   REM do font change
10922   LOCAL lj_b$,lj_i%
10923   VDU: PROCftracef("PROClj_13")
10924   tpub%! 64 =xbuff%!8
10925   lj_i%=tprv%! 4 
10926   lj_i%+=INT((tprv%! 12 -tprv%! 4 -tprv%! 28 )*FNlj_fontsize(xbuff%!8)/FNlj_fontsize(0))
10927   tpub%! 100 =lj_i%
10928   IF tpub%! 68 <tpub%! 100 -tprv%! 4  THEN
10929     tprv%! 32 =tpub%! 68 
10930   ELSE
10931     tprv%! 32 =0
10932   ENDIF
10933   IF tpub%! 88 <tpub%! 100 -tprv%! 4  AND tpub%! 88 >tprv%! 32  THEN
10934     tpub%! 100 =tprv%! 4 +tpub%! 88 
10935   ENDIF
10936   lj_b$=FNlj_font(xbuff%!8)
10937   xbuff%?8=LEN lj_b$
10938   $(xbuff%+9)=lj_b$
10939 ENDPROC
10940 DEF PROClj_15
10941   REM end of job
10942   LOCAL text_prdt%,tpub%,lj_s$
10943   VDU: PROCftracef("PROClj_15")
10944   IF queu%! 36 <>&FF4 THEN
10945     text_prdt%=!cnfg%! 4 
10946     tpub%=queu%! 44 
10947     REM finish off the text printing
10948     lj_s$=FNprinter_read_string_entry(text_prdt%,8)
10949     IF lj_s$<>"" BPUT#xbuff%!8,lj_s$;
10950   ENDIF
10951 ENDPROC
10952 DEF PROClj_16
10953   REM process a tab
10954   LOCAL lj_b$
10955   VDU: PROCftracef("PROClj_16")
10956   lj_b$=CHR$ 27+"&a+"
10957   lj_b$+=STR$(8-((tpub%! 56 -tprv%! 24 -tprv%! 32 +1-tprv%! 8 )MOD 8))+"C"
10958   tpub%! 100 +=8-((tpub%! 56 -tprv%! 24 -tprv%! 32 +1-tprv%! 8 )MOD 8)
10959   xbuff%?8=LEN lj_b$
10960   $(xbuff%+9)=lj_b$
10961 ENDPROC
10962 DEF PROClj_17
10963   REM do a formfeed
10964   VDU: PROCftracef("PROClj_17")
10965   xbuff%?8=0
10966 ENDPROC
10967 DEF PROClj_18
10968   REM change layout
10969   LOCAL layout_height%,layout_top%,layout_bottom%
10970   VDU: PROCftracef("PROClj_18")
10971   layout_height%=xbuff%!8
10972   layout_top%=xbuff%!12
10973   layout_bottom%=xbuff%!16
10974   IF layout_height%-layout_top%-layout_bottom%>3 AND layout_height%<=tprv%! 16  THEN
10975     tpub%! 76 =layout_height%-layout_top%-layout_bottom%
10976     tprv%! 20 =layout_top%
10977   ENDIF
10978   xbuff%?8=0
10979 ENDPROC
10980 DEF PROClj_19
10981   REM start a new page
10982   LOCAL lj_b$,lj_bit%,lj_p%,lj_t$
10983   VDU: PROCftracef("PROClj_19")
10984   tpub%! 80 =0
10985   tpub%! 84 +=1
10986   IF((!cnfg%! 0  AND 8)>>3)=0 OR (tpub%! 84  MOD 2)<>0 THEN
10987     tprv%! 0 =0
10988   ELSE
10989     tprv%! 0 =1
10990   ENDIF
10991   IF tpub%! 84 >1 THEN
10992     REM turn off the highlights from the previous page
10993     FOR lj_bit%=0 TO 5
10994       IF tpub%! 96  AND 1<<lj_bit% lj_b$+=FNlj_style_off(lj_bit%)
10995     NEXT
10996   ENDIF
10997   REM physical formfeed only if not staying on same piece of paper
10998   IF tprv%! 0 =0 AND tpub%! 84 >1 THEN
10999     lj_b$+=FNprinter_read_string_entry(text_prdt%,4)
11000   ENDIF
11001   lj_b$+=CHR$ 27+"&a"+STR$ tprv%! 20 +"R"
11002   IF tpub%! 52  THEN
11003     lj_p%=tpub%! 84 
11004     IF(!cnfg%! 0  AND 8)>>3 THEN
11005       REM if landscape mode, we fit two pages per physical page
11006       lj_p%=(lj_p%+1)DIV 2
11007     ENDIF
11008     tpub%! 80 +=2
11009     IF tprv%! 0 =0 THEN
11010       lj_b$+=CHR$ 27+"&a"+STR$(tprv%! 24 +tprv%! 32 )+"C"+CHR$ 14
11011       lj_t$=FNprinter_read_string(tpub%! 112 )+"   "+FNprinter_read_string(tpub%! 120 )
11012       lj_t$+="   "+FNmsg_1(psup%! 16 ,"PAG",STR$ lj_p%)
11013       lj_b$+=FNlj_trans(lj_t$)+CHR$ 15
11014     ENDIF
11015     lj_b$+=FNprinter_read_string_entry(text_prdt%,6)+FNprinter_read_string_entry(text_prdt%,6)
11016   ENDIF
11017   xbuff%?8=LEN lj_b$
11018   $(xbuff%+9)=lj_b$
11019 ENDPROC
11020 DEF FNlj_trans(lj_s$)
11021   LOCAL lj_i%,byte%,out$,str$
11022   VDU: PROCftracef("FNlj_trans")
11023   IF lj_s$="" THEN =""
11024   FOR lj_i%=1 TO LEN lj_s$
11025     byte%=ASC MID$(lj_s$,lj_i%,1): str$=""
11026     CASE  -1  OF
11027       WHEN byte%<32 OR byte%=127
11028         IF tpub%! 44 =1 str$=FNlj_display(byte%)
11029       WHEN byte%>127 AND tpub%! 44 <>0
11030         IF tpub%! 44 =1 str$=FNlj_display(byte%)
11031       WHEN tpub%! 44 <>0
11032         str$=CHR$ byte%
11033       OTHERWISE
11034         str$=FNlj_text_char(byte%)
11035         IF str$="" str$=CHR$ byte%
11036     ENDCASE
11037     out$+=str$
11038   NEXT
11039 =out$
11040 DEF FNlj_text_char(byte%)
11041   LOCAL lj_p%,lj_s$,lj_i%
11042   VDU: PROCftracef("FNlj_text_char")
11043   lj_p%=queu%! 64 
11044   WHILE lj_p%
11045     CASE  -1  OF
11046       WHEN lj_p%?4=byte%
11047         lj_i%=lj_p%?5
11048         lj_p%=lj_p%+6
11049         WHILE lj_i%
11050           lj_s$+=CHR$ ?lj_p%
11051           lj_p%+=1
11052           lj_i%-=1
11053         ENDWHILE
11054         =lj_s$
11055       WHEN lj_p%?4>byte%
11056         lj_p%=0
11057       OTHERWISE
11058         lj_p%=!lj_p%
11059     ENDCASE
11060   ENDWHILE
11061 =""
11062 DEF FNlj_display(byte%)
11063   VDU: PROCftracef("FNlj_display")
11064 ="["+RIGHT$("0"+STR$~byte%,2)+"]"
11065 DEF FNlj_style_on(bit%)
11066   VDU: PROCftracef("FNlj_style_on")
11067   CASE bit% OF
11068     WHEN 0: =FNprinter_read_string_entry(text_prdt%,13): REM bold on
11069     WHEN 1: =FNprinter_read_string_entry(text_prdt%,17): REM light on
11070     WHEN 2: =FNprinter_read_string_entry(text_prdt%,15): REM italic on
11071     WHEN 3: =FNprinter_read_string_entry(text_prdt%,23): REM underline on
11072     WHEN 4: =FNprinter_read_string_entry(text_prdt%,19): REM superscript on
11073     WHEN 5: =FNprinter_read_string_entry(text_prdt%,21): REM subscript on
11074   ENDCASE
11075 =""
11076 DEF FNlj_style_off(bit%)
11077   VDU: PROCftracef("FNlj_style_off")
11078   CASE bit% OF
11079     WHEN 0: =FNprinter_read_string_entry(text_prdt%,14): REM bold off
11080     WHEN 1: =FNprinter_read_string_entry(text_prdt%,18): REM light off
11081     WHEN 2: =FNprinter_read_string_entry(text_prdt%,16): REM italic off
11082     WHEN 3: =FNprinter_read_string_entry(text_prdt%,24): REM underline off
11083     WHEN 4: =FNprinter_read_string_entry(text_prdt%,20): REM superscript off
11084     WHEN 5: =FNprinter_read_string_entry(text_prdt%,22): REM subscript off
11085   ENDCASE
11086 =""
11087 DEF FNlj_font(font%)
11088   VDU: PROCftracef("FNlj_font")
11089   CASE font% OF
11090     WHEN 0: =FNprinter_read_string_entry(text_prdt%,9): REM pica
11091     WHEN 1: =FNprinter_read_string_entry(text_prdt%,10): REM elite
11092     WHEN 2: =FNprinter_read_string_entry(text_prdt%,11): REM condensed
11093     WHEN 3: =FNprinter_read_string_entry(text_prdt%,12): REM expanded
11094   ENDCASE
11095   VDU: PROCftracef("FNlj_font done")
11096 =""
11097 DEF FNlj_fontsize(num%)
11098   REM provide notional cpi sizes
11099   VDU: PROCftracef("FNlj_fontsize")
11100   CASE num% OF
11101     WHEN 0: =10: REM pica
11102     WHEN 1: =12: REM elite
11103     WHEN 2: =17: REM condensed
11104     WHEN 3: = 6: REM expanded
11105   ENDCASE
11106 =10
11107 DEF FNlj_host_desc
11108 LOCAL a%
11109 a%=buff%!24
11110 =a%! 12 
11111 REM > Support - for PostScript printers
11112 DEF FNps_support(buff%)
11113   LOCAL reason%,psup%,prnt%,prdt%,cnfg%,xbuff%,psize_head%,code_entry%
11114   REM On entry, A%=interface pointer. This must be preserved.
11115   reason%=buff%!0
11116   psup%=buff%!4
11117   prnt%=buff%!8
11118   xbuff%=buff%!12
11119   psize_head%=buff%!16
11120   code_entry%=buff%!20
11121   IF prnt% THEN
11122     prdt%=FNprinter_find_prdata_entry(psup%,$prnt%! 8 )
11123     cnfg%=prnt%! 16 
11124   ENDIF
11125   CASE reason% OF
11126   WHEN -1: PROCps_m1
11127   WHEN -3: PROCps_m3
11128   WHEN -4: PROCps_m4
11129   WHEN -5: PROCps_m5
11130   WHEN -6: PROCps_m6
11131   WHEN -7: PROCps_m7
11132   WHEN -8: PROCps_m8
11133   WHEN -9: PROCps_m9
11134   WHEN-10: PROCps_m10
11135   WHEN 3: PROCps_p3
11136   WHEN 6: PROCps_p6
11137   WHEN 8: PROCps_p8
11138   WHEN 9: PROCps_p9
11139   WHEN 17,18: PROCps_p17
11140   ENDCASE
11141 = 0 
11142 DEF PROCps_m1
11143   VDU: PROCftracef("PROCps_m1")
11144   VDU: psup%! 24 =psup%! 24  OR 200<<8 OR %11000
11145   psup%! 24  = psup%! 24  OR (1<<5):REM need to be able to write
11146   psup%! 28 =&FF5
11147   psup%! 32 =%1011
11148   psup%! 36 = 12 /4
11149   psup%! 40 =1
11150   REM note that the version number really only reflects
11151   REM the status of the files being read, ie only change
11152   REM this number if the file contents change.
11153   psup%! 44 =100
11154   buff%!0 =&80151
11155   buff%!4 =&80150
11156   buff%!8 =&8014F
11157   buff%!12=&8014E
11158   buff%!16=&8014D
11159   buff%!20=&8014C
11160   buff%!24=0
11161   SYS"Wimp_AddMessages",buff%
11162   IFFNrmload_latest_module("PDriver","Printers:Modules.PDriver")
11163   IFFNrmload_latest_module("PDriverPS","Printers:Modules.PDriverPS")
11164   IFFNrmload_latest_module("MakePSFont","Printers:Modules.MakePSFont")
11165 ENDPROC
11166 DEF PROCps_m3
11167   REM initialise the configuration window
11168   LOCAL config%,ps_i%
11169   VDU: PROCftracef("PROCps_m3")
11170   config%=FNprinter_find_window(prnt%,"configure")
11171   PROCicon_write(config%,13,FNprinter_read_string(prnt%! 40 ))
11172   PROCicon_write(config%,6,$prnt%! 8 )
11173   ps_i%=!cnfg%! 0 
11174   IF ps_i% AND 1 PROCicon_select(config%,8)ELSE PROCicon_deselect(config%,8)
11175   IF ps_i% AND 2 PROCicon_select(config%,11)ELSE PROCicon_deselect(config%,11)
11176   PROCicon_write(config%,18,FNmsg_0(psup%! 16 ,"PO"+STR$((ps_i% AND 4)>>2)))
11177   IF FNprinter_read_string_entry(prdt%, 14 )="" THEN
11178     REM no feed information - choose between manual or automatic
11179     PROCicon_write(config%,3,FNmsg_0(psup%! 16 ,"PF"+STR$((ps_i% AND 8)>>3)))
11180   ELSE
11181     IF cnfg%! 8  = 0 THEN
11182       REM using default settings in printer
11183       PROCicon_write(config%,3,FNmsg_0(psup%! 16 ,"ME1b"))
11184     ELSE
11185       PROCicon_write(config%,3,FNps_get_feed_name(FNprinter_read_string(cnfg%! 8 )))
11186     ENDIF
11187   ENDIF
11188   IF FNprinter_read_integer_entry(prdt%, 10 )=1 THEN
11189     PROCicon_unshade(config%,7)
11190     IF ps_i% AND 16 PROCicon_select(config%,7)ELSE PROCicon_deselect(config%,7)
11191   ELSE
11192     PROCicon_deselect(config%,7)
11193     PROCicon_shade(config%,7)
11194   ENDIF
11195   IF ps_i% AND 32 PROCicon_select(config%,31)ELSE PROCicon_deselect(config%,31)
11196   IF ps_i% AND 64 PROCicon_select(config%,32)ELSE PROCicon_deselect(config%,32)
11197   PROCicon_write(config%,30,STR$((ps_i% AND &FF00)>>8))
11198   PROCicon_write(config%,16,FNmsg_0(psup%! 16 ,"TC"+STR$((ps_i% AND &FF0000)>>16)))
11199   PROCicon_write(config%,23,FNmsg_0(psup%! 16 ,"CC"+STR$((ps_i% AND &FF000000)>>24)))
11200   ps_i%=prnt%! 36 
11201   PROCicon_write(config%,27,$ps_i%! 4 )
11202 ENDPROC
11203 DEF PROCps_m4
11204   REM create a CNFG block with suitable defaults
11205   LOCAL ps_s$,ps_i%,ps_t%,B%,C%,ps_n$
11206   VDU: PROCftracef("PROCps_m4")
11207   cnfg%! 0 =FNstore_integer(100<<8)
11208   $buff%=FNprinter_read_string_entry(prdt%, 2 ): B%=buff%: C%=2: prnt%! 40 =USR(code_entry%+ 28 )
11209   ps_s$=FNprinter_read_string_entry(prdt%, 3 )
11210   IF ps_s$<>"ps" $buff%=ps_s$: B%=buff%: C%=2: prnt%! 44 =USR(code_entry%+ 28 )
11211   REM initialise the best paper size we can find ...
11212   ps_i%=psize_head%
11213   ps_s$=FNmsg_0(psup%! 16 ,"PAP")
11214   WHILE ps_s$<>FNprinter_read_string(ps_i%! 4 )
11215    ps_i%=ps_i%! 0 
11216    IF ps_i%=0 ps_i%=psize_head%: ps_s$=FNprinter_read_string(ps_i%! 4 )
11217   ENDWHILE
11218   prnt%! 36 =ps_i%
11219   ps_i%=0
11220   PROCps_ensure_dir
11221   REPEAT
11222    SYS"OS_File",5,"PrinterChoices:ps.Printers."+STR$ ps_i% TO ps_t%
11223    IF ps_t% ps_i%+=1
11224   UNTIL ps_t%=0
11225   cnfg%! 4 =FNstore_integer(ps_i%)
11226   PROCps_create_default_font_file
11227   PROCps_ensure_fonts(prnt%, 0 )
11228   REM if this printer supports fast parallel, set the appropriate flag
11229   ps_i%=FNprinter_read_integer_entry(prdt%, 12 )
11230   IFps_i%<>0 prnt%! 24  = prnt%! 24  OR (1<<7)
11231   REM if we have some paper feeds, pick the first file as the default, otherwise
11232   REM we will assume automatic paper feed.
11233   ps_s$=FNprinter_read_string_entry(prdt%, 14 )
11234   IFps_s$="" THEN
11235     cnfg%! 8  = 0
11236   ELSE
11237     SYS"OS_GBPB",9,ps_s$,buff%,1,0,256,"*" TO ,,,ps_i%
11238     IFps_i%=1 THEN
11239       CALL Z%,buff%,ps_n$
11240       $buff%=ps_s$+"."+ps_n$
11241       IFFNps_get_feed_name($buff%)<>"" THEN
11242         B%=buff%:C%=2:cnfg%! 8 =USR(code_entry%+ 28 )
11243       ELSE
11244         cnfg%! 8  = 0
11245       ENDIF
11246     ENDIF
11247   ENDIF
11248 ENDPROC
11249 DEF PROCps_m5
11250   REM check to see if there are any unused font files
11251   LOCAL ps_i%,ps_j%
11252   VDU: PROCftracef("PROCps_m5")
11253   PROCps_ensure_dir
11254   REPEAT
11255    SYS"OS_GBPB",9,"PrinterChoices:ps.Printers"+CHR$0,buff%,1,ps_i%,128,"*" TO ,,,ps_j%,ps_i%
11256    IF ps_j%=1 THEN
11257     ps_j%=buff%: WHILE ?ps_j%: ps_j%+=1: ENDWHILE: ?ps_j%=13
11258     ps_j%=prnt%
11259     WHILE ps_j%>0
11260      IF ps_j%! 4 =psup% THEN
11261       REM got a printer in our class - does the name of the font file match?
11262       cnfg%=ps_j%! 16 
11263       IF $buff%=STR$ !cnfg%! 4  THEN
11264        REM yes - leave it alone
11265        ps_j%=-1
11266       ELSE
11267        REM no - try the next printer
11268        ps_j%=ps_j%! 0 
11269       ENDIF
11270      ELSE
11271       REM not our class - try the next printer
11272       ps_j%=ps_j%! 0 
11273      ENDIF
11274     ENDWHILE
11275     IF ps_j%=0 THEN
11276      REM failed to match - delete the file
11277      VDU: PROCftracef("PROCps_m5: deleting PrinterChoices:ps.Printers."+$buff%)
11278      SYS"OS_File",6,"PrinterChoices:ps.Printers."+$buff%
11279      VDU: PROCftracef("PROCps_m5: deleted")
11280      REM need to reset the offset now
11281      ps_i%=0
11282     ENDIF
11283    ENDIF
11284   UNTIL ps_i%=-1
11285   REM now see if there are any printers that need fonts downloading
11286   PROCps_find_fonts_to_do(prnt%)
11287   VDU: PROCftracef("PROCps_m5 done")
11288 ENDPROC
11289 DEF PROCps_m6
11290   REM do whatever is necessary to prime the specified printer
11291   REM 0 is the magic number for the PostScript driver
11292   LOCAL ps_i%,ps_s$,ps_f$,ps_t$,cnct%,ptr%,ps_extra$
11293   LOCAL pxres%,pyres%,pxres_halftone%,pyres_halftone%,colour%,pslevel%
11294   LOCAL local_margin%,local_pl%,local_pr%,local_pb%,local_pt%
11295   LOCAL local_psze%,local_pw%,local_ph%,local_fsize%,local_w%
11296   LOCAL local_h%,local_A%,local_B%,local_G%
11297   VDU: PROCftracef("PROCps_m6")
11298   SYS"PDriver_SelectDriver",0
11299   ps_s$=FNprinter_read_string(prnt%! 40 )
11300   IF ps_s$="" THEN
11301    ps_s$=$prnt%! 8 
11302    IF LEN ps_s$>20 THEN
11303     ps_i%=LEN ps_s$
11304     WHILE MID$(ps_s$,ps_i%,1)<>" " AND ps_i%>0
11305      ps_i%-=1
11306     ENDWHILE
11307     IF ps_i% THEN
11308      ps_s$=LEFT$(ps_s$,ps_i%-1)
11309     ELSE
11310      ps_s$=LEFT$(ps_s$,20)
11311     ENDIF
11312    ENDIF
11313   ENDIF
11314   pxres%=FNprinter_read_integer_entry(prdt%, 4 )
11315   pyres%=FNprinter_read_integer_entry(prdt%, 5 )
11316   pxres_halftone%=FNprinter_read_integer_entry(prdt%, 6 )
11317   pyres_halftone%=FNprinter_read_integer_entry(prdt%, 7 )
11318   pslevel%=FNprinter_read_integer_entry(prdt%, 13 )
11319   IF pslevel%<1 OR pslevel%>32 THEN pslevel%=1
11320   IF !cnfg%! 0  AND 16 colour%=&2000001 ELSE colour%=&2000000
11321   SYS"XPDriver_SetInfo",,pxres%,pyres%,colour%,ps_s$,pxres_halftone%,pyres_halftone%,0 TO ptr%;ps_i%
11322   IF ps_i% AND 1 THEN
11323    ps_s$="": ptr%+=4
11324    WHILE ?ptr%: ps_s$+=CHR$ ?ptr%: ptr%+=1: ENDWHILE
11325    ERROR  254 ,ps_s$
11326    ENDPROC
11327   ENDIF
11328   cnct%=prnt%! 12 
11329   CASE cnct%! 0  OF
11330   WHEN 1,2: ps_i%=1: REM enable control D output
11331   OTHERWISE: ps_i%=0: REM disable control D output
11332   ENDCASE
11333   IF !cnfg%! 0  AND 32 ps_i%+=2: REM verbose prologue
11334   IF !cnfg%! 0  AND 64 ps_i%+=4: REM accented chars
11335   ps_i%+=(pslevel%-1)*8: REM PostScript level, in bits 3-7
11336   SYS"PDriver_SetDriver",ps_i%
11337   SYS"OS_CLI","Set PDriver$PSprologue Printers:ps.PSfiles.PSprolog"
11338   SYS"OS_CLI","Set PDriver$PSprologue2 Printers:ps.PSfiles.Level"+     STR$(pslevel%)+"."+FNprinter_read_string_entry(prdt%, 8 )
11339   local_psze%=prnt%! 36 
11340   VDU: PROCftracef("Ptr to paper size block = &"+STR$~(local_psze%))
11341   ps_s$=$local_psze%! 4 
11342   VDU: PROCftracef("Paper size name = "+ps_s$)
11343   ps_i%=0
11344   WHILE MID$(ps_s$,ps_i%,1)<>" " AND ps_i%<=LEN ps_s$
11345     ps_i%+=1
11346   ENDWHILE
11347   ps_s$=LEFT$(ps_s$,ps_i%-1)
11348   ps_extra$=""
11349   SYS"OS_CLI","Unset PDriver$PSextra"
11350   SYS"OS_CLI","Unset PDriver$PSpaper"
11351   SYS"OS_CLI","Unset PDriver$PSfeed"
11352   SYS"OS_File",17,"Printers:ps.Paper."+FNtask_lower(ps_s$) TO ps_i%
11353   IFps_i%<>1 THEN
11354     ps_extra$=FNmsg_2(psup%! 16 ,"PT",ps_s$,FNtask_lower(ps_s$))
11355   ELSE
11356     SYS"OS_CLI","Set PDriver$PSPaper Printers:ps.Paper."+FNtask_lower(ps_s$)
11357   ENDIF
11358   IF cnfg%! 8  <> 0 THEN
11359     SYS"OS_CLI","Set PDriver$PSFeed "+FNprinter_read_string(cnfg%! 8 )
11360   ELSE
11361     REM only do auto/manual code if we do not have any feed information otherwise this
11362     REM means that the user wants to use the default printer setting
11363     IF FNprinter_read_string_entry(prdt%, 14 )="" THEN
11364       IF !cnfg%! 0  AND 8 THEN
11365        ps_f$=FNungstrans(FNprinter_read_boolean_string_entry(prdt%, 9 , -1 ))
11366       ELSE
11367        ps_f$=FNungstrans(FNprinter_read_boolean_string_entry(prdt%, 9 , 0 ))
11368       ENDIF
11369       IF ps_extra$<>"" ps_extra$=ps_f$+"|J"+ps_extra$ ELSE ps_extra$=ps_f$
11370     ENDIF
11371   ENDIF
11372   IF ps_extra$<>"" SYS"OS_CLI","Set PDriver$PSextra "+ps_extra$
11373   SYS"OS_CLI","Unset PDriver$TextChars1": REM no character translation to speak of
11374   local_margin%=50
11375   local_pl% = local_psze%! 24  DIV 100 + 1 + local_margin%
11376   local_pr% = local_psze%! 28  DIV 100 - local_margin%
11377   local_pb% = local_psze%! 16  DIV 100 + 1 + local_margin%
11378   local_pt% = local_psze%! 20  DIV 100 - local_margin%
11379   IF(!cnfg%! 0  AND 4)=0 THEN
11380    IF !cnfg%! 0  AND 1 local_pt%-=150
11381    local_pw% = local_pr%-local_pl%
11382    local_ph% = local_pt%-local_pb%
11383   ELSE
11384    IF !cnfg%! 0  AND 1 local_pl%+=150
11385    local_pw% = local_pt%-local_pb%
11386    local_ph% = local_pr%-local_pl%
11387   ENDIF
11388   local_fsize%=(!cnfg%! 0  AND &FF00)>>8
11389   VDU: PROCftracef("Local font size is "+STR$ local_fsize%)
11390   local_w%=0.72*local_fsize%
11391   local_h%=1.2*local_fsize%
11392   VDU: PROCftracef("=> (w, h) = ("+STR$ local_w%+", "+STR$ local_h%+")")
11393   local_pw%=local_pw% DIV local_w%
11394   local_ph%=local_ph% DIV local_h%
11395   IF !cnfg%! 0  AND 1 THEN
11396    local_G%=2
11397    local_A%=local_ph%+2
11398   ELSE
11399    local_G%=0
11400    local_A%=local_ph%
11401   ENDIF
11402   local_B%=(local_pw%+2)DIV(1+((!cnfg%! 0  AND &FF0000)>>16))-2
11403   ps_t$="-Ph "+STR$ local_A%+" -Pw "+STR$ local_B%+" -Mt "+STR$ local_psze%! 36 
11404   ps_t$+=" -Mb "+STR$ local_psze%! 32 +" -Ml "+STR$ local_psze%! 40 
11405   ps_t$+=" -Mr "+STR$ local_psze%! 44 +" -Th "+STR$ local_G%
11406   SYS"OS_CLI","Set PDriver$TextPage "+ps_t$
11407   PROCps_add_fonts( 0 )
11408   VDU: PROCftracef("PROCps_m6 done")
11409 ENDPROC
11410 DEF PROCps_m7
11411   LOCAL queu%,ps_p%,ps_i%,B%,C%
11412   VDU: PROCftracef("PROCps_m7")
11413   queu%=!xbuff%
11414   ps_p%=queu%! 48 
11415   IF ps_p% THEN
11416    REM free the two strings we hold
11417    PROCfree_structure(ps_p%! 0 )
11418    PROCfree_structure(ps_p%! 32 )
11419    B%= &56525054 : C%=ps_p%: CALL code_entry%+ 16 
11420    queu%! 48 =0
11421   ENDIF
11422   REM now free the character translation list
11423   ps_p%=queu%! 64 
11424   WHILE ps_p%
11425    ps_i%=!ps_p%
11426    B%= &52414843 : C%=ps_p%: CALL code_entry%+ 16 
11427    ps_p%=ps_i%
11428   ENDWHILE
11429   queu%! 64 =0
11430 ENDPROC
11431 DEF PROCps_m9
11432   REM printer being removed
11433   REM delete the printer font file
11434   SYS"XOS_File",6,"PrinterChoices:ps.Printers."+STR$(!cnfg%! 4 )
11435   REM then check the download window
11436   PROCps_m10
11437 ENDPROC
11438 DEF PROCps_m10
11439   REM printer being deactivated
11440   REM if the font download window is open for this printer, move on
11441   REM to the next one
11442   LOCAL ps_i%
11443   VDU: PROCftracef("PROCps_m9")
11444   ps_i%=psup%! 20 
11445   WHILE ps_i%
11446    IF $(ps_i%+ 16 )="download" THEN
11447     REM is the window open?
11448     !buff%=ps_i%! 4 : SYS"Wimp_GetWindowState",,buff%
11449     IF buff%!32 AND 1<<16 THEN
11450      REM yes - it is for this printer? If so, move to next printer
11451      IF ps_i%! 12 =prnt% THEN
11452       SYS"Wimp_CloseWindow",,buff%
11453       PROCps_find_fonts_to_do(prnt%! 0 )
11454      ENDIF
11455     ENDIF
11456     ps_i%=0
11457    ELSE
11458     ps_i%=ps_i%! 0 
11459    ENDIF
11460   ENDWHILE
11461 ENDPROC
11462 DEF PROCps_p3
11463   REM a window closing
11464   LOCAL ps_i%
11465   VDU: PROCftracef("PROCps_p3")
11466   SYS"Wimp_CloseWindow",,xbuff%
11467   ps_i%=psup%! 20 
11468   WHILE ps_i%
11469     IF ps_i%! 4 =!xbuff% THEN
11470       IF $(ps_i%+ 16 )="download" THEN
11471         REM if currently selected printer - reselect it so the mappings are good
11472         IF prnt%! 24  AND 2 !buff%=20: buff%!12=0: buff%!16=&80152: SYS"Wimp_SendMessage",17,buff%,0
11473         REM since the user has decided not to download the fonts, cancel the flag bit
11474         ps_i%=prnt%! 52 
11475         WHILE ps_i%
11476           ps_i%! 12 =ps_i%! 12  AND NOT(1<<31)
11477           ps_i%=ps_i%! 0 
11478         ENDWHILE
11479         PROCps_find_fonts_to_do(prnt%! 0 )
11480       ENDIF
11481       ps_i%=0
11482     ELSE
11483       ps_i%=ps_i%! 0 
11484     ENDIF
11485   ENDWHILE
11486 ENDPROC
11487 DEF PROCps_p6
11488   REM mouseclick on the configure window
11489   LOCAL wind%
11490   VDU: PROCftracef("PROCps_p6")
11491   CASE xbuff%!8 OF
11492     WHEN 2: REM Menu
11493       CASE xbuff%!16 OF
11494         WHEN  4: PROCps_menu("ME1", -1 , -1 )
11495         WHEN 20: PROCps_menu("ME2", -1 , -1 )
11496         WHEN 19: PROCps_menu("ME3", -1 , -1 )
11497         WHEN 24: PROCps_menu("ME4", -1 , -1 )
11498         WHEN 26: PROCps_menu("MP1", -1 , -1 )
11499       ENDCASE
11500     WHEN 4: REM Select
11501       CASE xbuff%!16 OF
11502         WHEN 25
11503           VDU: PROCftracef("saving and closing configuration (click SELECT)")
11504           wind%=xbuff%!12
11505           PROCps_save_configuration(wind%)
11506           !xbuff%=wind%
11507           SYS"Wimp_CloseWindow",,xbuff%
11508         WHEN  4: PROCps_menu("ME1", -1 , -1 )
11509         WHEN 20: PROCps_menu("ME2", -1 , -1 )
11510         WHEN 19: PROCps_menu("ME3", -1 , -1 )
11511         WHEN 24: PROCps_menu("ME4", -1 , -1 )
11512         WHEN 26: PROCps_menu("MP1", -1 , -1 )
11513         WHEN 33
11514           !xbuff%=xbuff%!12
11515           SYS"Wimp_CloseWindow",,xbuff%
11516       ENDCASE
11517     WHEN 1: REM Adjust
11518       IF xbuff%!16=25 THEN
11519         wind%=xbuff%!12
11520         PROCps_save_configuration(wind%)
11521       ENDIF
11522   ENDCASE
11523 ENDPROC
11524 DEF PROCps_p8
11525   REM a key press!
11526   LOCAL ps_i%
11527   VDU: PROCftracef("PROCps_p8")
11528   ps_i%=psup%! 20 
11529   WHILE ps_i%
11530     IF ps_i%! 4 =!xbuff% THEN
11531       IF xbuff%!24=13 THEN
11532         CASE $(ps_i%+ 16 )OF
11533           WHEN "configure"
11534             VDU: PROCftracef("saving and closing configuration (press RETURN)")
11535             SYS "Wimp_CloseWindow",,xbuff%
11536             PROCps_save_configuration(!xbuff%)
11537           WHEN "download"
11538             SYS "Wimp_CloseWindow",,xbuff%
11539             PROCps_download_fonts(!xbuff%)
11540         ENDCASE
11541       ELSE
11542         SYS "Wimp_ProcessKey",xbuff%!24
11543       ENDIF
11544       ENDPROC
11545     ENDIF
11546     ps_i%=ps_i%! 0 
11547   ENDWHILE
11548 ENDPROC
11549 DEF PROCps_p9
11550   LOCAL adjust%,wind%,icon%,ptr%
11551   VDU: PROCftracef("PROCps_p9")
11552   wind%=FNprinter_find_window(prnt%,"configure")
11553   adjust%=FNwas_adjust_used
11554   CASE ps_menu_chsn$ OF
11555   WHEN "ME1": icon%=3
11556   WHEN "ME2": icon%=16
11557   WHEN "ME3": icon%=18
11558   WHEN "ME4": icon%=23
11559   WHEN "MP1": icon%=27
11560   ENDCASE
11561   ptr%=ps_menu%+28+!xbuff%*24
11562   IF ptr%!8 AND &100 THEN
11563    PROCicon_write(wind%,icon%,$ptr%!12)
11564   ELSE
11565    PROCicon_write(wind%,icon%,$(ptr%+12))
11566   ENDIF
11567   IF ps_menu_chsn$="ME3" THEN
11568    IF FNicon_read(wind%,18)=FNmsg_0(psup%! 16 ,"PO0")THEN
11569     PROCicon_write(wind%,16,FNmsg_0(psup%! 16 ,"PC"))
11570     PROCicon_write(wind%,30,FNmsg_0(psup%! 16 ,"PS"))
11571    ELSE
11572     PROCicon_write(wind%,16,FNmsg_0(psup%! 16 ,"LC"))
11573     PROCicon_write(wind%,30,FNmsg_0(psup%! 16 ,"LS"))
11574    ENDIF
11575   ENDIF
11576   IF adjust% THEN
11577    SYS"Wimp_GetPointerInfo",,xbuff%
11578    PROCps_menu(ps_menu_chsn$, 0 , 0 )
11579   ENDIF
11580 ENDPROC
11581 DEF PROCps_p17
11582   LOCAL wind%,ps_s$,ps_t$,ps_f$,size%,dest%,recv%
11583   VDU: PROCftracef("PROCps_p17")
11584   CASE xbuff%!16 OF
11585   WHEN &502:
11586     wind%=psup%! 20 
11587     WHILE wind%
11588       IF wind%! 4 =xbuff%!32 THEN
11589         CASE $(wind%+ 16 )OF
11590           WHEN "configure": ps_s$=STR$ xbuff%!36
11591             CASE xbuff%!36 OF
11592               WHEN 7,31,32,8,11: IF FNicon_set(xbuff%!32,xbuff%!36)ps_s$+="b" ELSE ps_s$+="a"
11593             ENDCASE
11594             ps_t$=FNmsg_0(psup%! 16 ,"CON"+ps_s$)
11595             IF ps_t$="CON"+ps_s$ ps_t$=FNmsg_0(psup%! 16 ,"CON")
11596             PROCinteractive_help(ps_t$)
11597         ENDCASE
11598         wind%=0
11599       ELSE
11600         wind%=wind%! 0 
11601         IF wind%=0 THEN
11602           REM must be a menu
11603           PROCinteractive_help(FNmsg_0(psup%! 16 ,"H"+ps_menu_chsn$))
11604         ENDIF
11605       ENDIF
11606     ENDWHILE
11607   WHEN &8014C: IF prnt%=0 THEN
11608       xbuff%!12=xbuff%!8
11609       xbuff%!16=&80151: REM PSPrinterNotPS
11610       SYS"Wimp_SendMessage",17,xbuff%,xbuff%!4
11611     ELSE
11612       IF prnt%! 4 <>psup% THEN
11613         xbuff%!12=xbuff%!8
11614         xbuff%!16=&80151: REM PSPrinterNotPS
11615         SYS"Wimp_SendMessage",17,xbuff%,xbuff%!4
11616       ELSE
11617         REM everything checks out. Calculate the size required then send
11618         REM the acknowledgement BEFORE doing the transfer block as this
11619         REM then gives us our task handle!
11620         ps_s$="": IF prnt%! 40  ps_s$=$prnt%! 40 
11621         ps_t$="": IF prnt%! 8  ps_t$=$prnt%! 8 
11622         ps_f$="PrinterChoices:ps.Printers."+STR$ !cnfg%! 4 
11623         PROCps_ensure_dir
11624         size%=LEN ps_s$+LEN ps_t$+LEN ps_f$+3
11625         recv%=xbuff%!4
11626         xbuff%!24=size%
11627         xbuff%!12=xbuff%!8
11628         xbuff%!16=&8014D: REM PSPrinterAck
11629         SYS"Wimp_SendMessage",17,xbuff%,recv%
11630         IF xbuff%!20 THEN
11631           dest%=xbuff%!20
11632           $buff%=ps_s$+CHR$ 0
11633           SYS"Wimp_TransferBlock",xbuff%!4,buff%,recv%,dest%,LEN ps_s$+1
11634           dest%+=LEN ps_s$+1
11635           $buff%=ps_t$+CHR$ 0
11636           SYS"Wimp_TransferBlock",xbuff%!4,buff%,recv%,dest%,LENps_t$+1
11637           dest%+=LEN ps_t$+1
11638           $buff%=ps_f$+CHR$ 0
11639           SYS"Wimp_TransferBlock",xbuff%!4,buff%,recv%,dest%,LENps_f$+1
11640         ENDIF
11641       ENDIF
11642     ENDIF
11643   WHEN &8014E: PROCps_try_to_find_fonts(prnt%)
11644   WHEN &8014F: PROCps_create_default_font_file
11645     PROCps_ensure_fonts(prnt%, 0 )
11646     PROCps_add_fonts( 0 )
11647     xbuff%!12=xbuff%!8
11648     xbuff%!16=&80150: REM PSPrinterDefaulted
11649     SYS"Wimp_SendMessage",17,xbuff%,xbuff%!4
11650   ENDCASE
11651   VDU: PROCftracef("PROCps_p17 done")
11652 ENDPROC
11653 DEF FNps_get_feed_name(f$)
11654   LOCAL ps_c%, ps_s$
11655   ps_c%=OPENIN(f$):IFps_c%=0 :=""
11656   ps_s$=GET$#ps_c%:CLOSE#ps_c%
11657   IFLEFT$(ps_s$,19)="%%RISCOS_FeedName: " THEN :=MID$(ps_s$,20)
11658   =""
11659 DEF PROCps_create_default_font_file
11660   LOCAL ps_c%,ps_d%,ps_t%,ps_i%,prdt%
11661   VDU: PROCftracef("PROCps_create_default_font_file")
11662   ps_i%=A%! 16 
11663   PROCps_ensure_dir
11664   SYS"OS_FSControl",37,"PrinterChoices:ps.Printers",ps_i%,,,128
11665   ps_t%=ps_i%: WHILE ?ps_t%: ps_t%+=1: ENDWHILE
11666   REM add the name of the font file onto the end of the path string
11667   $ps_t%="."+STR$ !cnfg%! 4 
11668   REM and create the file
11669   ps_c%=OPENOUT $ps_i%
11670   IF ps_c% THEN
11671    REM point ps_d% at the font list PRDT block
11672    prdt%=FNprinter_find_prdata_entry(psup%,$prnt%! 8 )
11673    ps_d%=FNprinter_read_integer_entry(prdt%, 11 )
11674    REM now point at the head of the LSTD list
11675    ps_d%=ps_d%! 8 
11676    WHILE ps_d%
11677     BPUT#ps_c%,$ps_d%!8+" "+$ps_d%!12+" "+$ps_d%!16
11678     ps_d%=ps_d%! 0 
11679    ENDWHILE
11680    CLOSE#ps_c%
11681    SYS "XOS_File",4,$ps_i%,,,,&13  
11682   ENDIF
11683 ENDPROC
11684 DEF PROCps_try_to_find_fonts(prnt%)
11685   LOCAL ps_i%,ps_j%
11686   VDU: PROCftracef("PROCps_try_to_find")
11687   REM is the download window open?
11688   ps_i%=psup%! 20 
11689   WHILE ps_i%
11690    IF $(ps_i%+ 16 )="download" THEN
11691     REM is the window open?
11692     !buff%=ps_i%! 4 : SYS"Wimp_GetWindowState",,buff%
11693     IF buff%!32 AND 1<<16 THEN
11694      REM try to find this prnt either from the window
11695      REM or from later on in the linked list
11696      ps_j%=ps_i%! 12 
11697      WHILE ps_j%
11698       IF ps_j%=prnt% ENDPROC: REM found - will be dealt with in due course
11699       ps_j%=ps_j%! 0 
11700      ENDWHILE
11701     ENDIF
11702     REM not found or window closed ... change the window to point
11703     REM to THIS prnt since it must be earlier in the linked list
11704     PROCps_find_fonts_to_do(prnt%)
11705     ENDPROC
11706    ELSE
11707     ps_i%=ps_i%! 0 
11708    ENDIF
11709   ENDWHILE
11710 ENDPROC
11711 DEF PROCps_find_fonts_to_do(prnt%)
11712   VDU: PROCftracef("PROCps_find_fonts_to_do")
11713   WHILE prnt%
11714    IF prnt%! 4 =psup% PROCps_ensure_fonts(prnt%, -1 )
11715    prnt%=prnt%! 0 
11716   ENDWHILE
11717 ENDPROC
11718 DEF PROCps_ensure_fonts(prnt%,take_action%)
11719   LOCAL ps_i%,ps_j%,ps_k%,ps_s$,ps_t$,ps_e$,ps_download%,ps_changed%
11720   VDU: PROCftracef("PROCps_ensure_fonts")
11721   cnfg%=prnt%! 16 
11722   ps_download%= 0 : REM nothing to download yet
11723   ps_changed%= 0 
11724   REM set all the flags to show no matches against the file
11725   ps_j%=prnt%! 52 
11726   PROCps_ensure_dir
11727   WHILE ps_j%
11728    ps_j%! 12 =ps_j%! 12  OR 1<<30
11729    IF ps_j%! 12  AND 1<<31 THEN
11730     ps_download%= -1 
11731     ps_changed%= -1 
11732    ENDIF
11733    ps_j%=ps_j%! 0 
11734   ENDWHILE
11735   ps_i%=OPENIN("PrinterChoices:ps.Printers."+STR$ !cnfg%! 4 )
11736   IF ps_i%=0 THEN
11737    PROCps_create_default_font_file
11738    ps_i%=OPENIN("PrinterChoices:ps.Printers."+STR$ !cnfg%! 4 )
11739   ENDIF
11740   IF ps_i% THEN
11741    WHILE NOTEOF#ps_i%
11742     REM marry up the contents of the file against the current list
11743     ps_s$=GET$#ps_i%: ps_t$="": ps_e$=""
11744     ps_j%=INSTR(ps_s$," ")
11745     IF ps_j%<>0 THEN
11746      ps_t$=MID$(ps_s$,ps_j%+1)
11747      ps_s$=LEFT$(ps_s$,ps_j%-1)
11748      ps_k%=INSTR(ps_t$," ")
11749      IF ps_k%<>0 THEN
11750       ps_e$=MID$(ps_t$,ps_k%+1)
11751       ps_t$=LEFT$(ps_t$,ps_k%-1)
11752      ENDIF
11753     ENDIF
11754     ps_s$="\F"+ps_s$: IF ps_e$<>"" ps_s$+="\E"+ps_e$
11755     ps_k%=prnt%! 52 
11756     WHILE ps_k%>0
11757      IF ps_k%! 8  ps_e$=$ps_k%! 8  ELSE ps_e$=""
11758      IF $ps_k%! 4 =ps_s$ AND ps_e$=ps_t$ THEN
11759       REM matched this entry in the file
11760       ps_k%! 12 =ps_k%! 12  AND NOT(1<<30)
11761       ps_k%=-1
11762      ELSE
11763       ps_k%=ps_k%! 0 
11764      ENDIF
11765     ENDWHILE
11766     IF ps_k%=0 THEN
11767      REM got to add font to list
11768      ps_changed%= -1 
11769      B%= &544E4F46 
11770      C%= 16 
11771      ps_k%=USR(code_entry%+ 12 )
11772      IFps_k%=0 ERROR  253 , FNmsg_0(FNps_host_desc,"FA5")
11773      ps_k%! 0 =prnt%! 52 : prnt%! 52 =ps_k%
11774      $buff%=ps_s$: B%=buff%: C%=2: ps_k%! 4 =USR(code_entry%+ 28 )
11775      VDU: PROCftracef("Length of block for '"+$buff%+"' is &"+STR$~(!((ps_k%! 4 )-8)))
11776      $buff%=ps_t$: B%=buff%: C%=2: ps_k%! 8 =USR(code_entry%+ 28 )
11777      VDU: PROCftracef("Length of block for '"+$buff%+"' is &"+STR$~(!((ps_k%! 8 )-8)))
11778      ps_k%! 12 =1
11779      IF ps_j%=0 THEN
11780       ps_download%= -1 : REM got SOMETHING to download
11781       ps_k%! 12 =ps_k%! 12  OR 1<<31
11782      ENDIF
11783     ENDIF
11784    ENDWHILE
11785    CLOSE#ps_i%
11786    PROCps_lose_fonts
11787    IF ps_changed% AND take_action% THEN
11788     IF ps_download% THEN
11789      ps_i%=FNprinter_find_window(prnt%,"download")
11790      PROCicon_write(ps_i%,3,FNprinter_read_string(prnt%! 40 ))
11791      PROCicon_write(ps_i%,4,$prnt%! 8 )
11792      PROCicon_write(ps_i%,5,"0"): REM The default password for PostScript
11793      !buff%=ps_i%: SYS"Wimp_GetWindowState",,buff%
11794      SYS"Wimp_OpenWindow",,buff%
11795      PROCcaret_set(ps_i%,5): REM get caret at end of string
11796      REM was SYS"Wimp_SetCaretPosition",ps_i%,5,-1,-1,-1,0
11797      ENDPROC
11798     ELSE
11799      IF prnt%! 24  AND 2 THEN
11800       !buff%=20: buff%!12=0: buff%!16=&80152: SYS"Wimp_SendMessage",17,buff%,0
11801      ENDIF
11802     ENDIF
11803    ENDIF
11804   ELSE
11805    PROCps_lose_fonts
11806   ENDIF
11807 ENDPROC
11808 DEF PROCps_download_fonts(wind%)
11809   LOCAL ps_i%,ps_c%,ps_j%,ps_k%,ps_l%,ps_s$,B%,C%,D%,E%,F%,G%,ptr%
11810   LOCAL ERROR
11811   VDU: PROCftracef("PROCps_download_fonts")
11812   REM Check that there is a password.
11813   IF FNicon_read(wind%,5)="" ERROR  254 ,FNmsg_0(psup%! 16 ,"OK0")
11814   SYS"Hourglass_On"
11815   REM need to find a file to spit the data into
11816   ps_i%=0
11817   REPEAT
11818    SYS"OS_File",17,"<Wimp$ScrapDir>.Printers."+STR$ ps_i% TO ps_c%
11819    IF ps_c% ps_i%+=1
11820   UNTIL ps_c%=0
11821   REM now select the PostScript driver module
11822   SYS"PDriver_SelectDriver",0
11823   PROCps_add_fonts( -1 ): REM declare the MAPPED fonts
11824   ps_c%=OPENOUT("<Wimp$ScrapDir>.Printers."+STR$ ps_i%)
11825   ON ERROR LOCAL RESTORE ERROR: CLOSE#ps_c%: ERROR ERR,REPORT$
11826   BPUT#ps_c%,"%!PS-Adobe-2.0 ExitServer"
11827   BPUT#ps_c%,"%%Creator: "+FNmsg_0(psup%! 16 ,"ID")
11828   BPUT#ps_c%,"%%CreationDate: ";
11829   ?buff%=3: SYS"OS_Word",14,buff%
11830   SYS"OS_ConvertStandardDateAndTime",buff%,buff%+5,250: ps_k%=buff%+5
11831   WHILE ?ps_k% BPUT#ps_c%,?ps_k%: ps_k%+=1: ENDWHILE: BPUT#ps_c%,10
11832   BPUT#ps_c%,"%%DocumentSuppliedFonts: ";
11833   ps_j%=prnt%! 52 : ps_l%= 0 
11834   WHILE ps_j%
11835    IF ps_j%! 12  AND 1<<31 THEN
11836     SYS "MakePSFont_MakeFont",-2,$ps_j%! 4 +CHR$ 0,buff%,256,0
11837     IF ps_l% BPUT#ps_c%,"%%+ ";
11838     ps_k%=buff%: ps_l%= -1 
11839     WHILE ?ps_k% BPUT#ps_c%,?ps_k%: ps_k%+=1: ENDWHILE
11840     BPUT#ps_c%,10
11841    ENDIF
11842    ps_j%=ps_j%! 0 
11843   ENDWHILE
11844   BPUT#ps_c%,"%%Pages: 0"
11845   BPUT#ps_c%,"%%BoundingBox: 0 0 0 0"
11846   BPUT#ps_c%,"%%EndComments"
11847   BPUT#ps_c%,"%%BeginSetup"
11848   BPUT#ps_c%,"%%BeginExitServer: "+FNicon_read(wind%,5)
11849   BPUT#ps_c%,"serverdict begin "+FNicon_read(wind%,5)+" exitserver"
11850   BPUT#ps_c%,"%%EndExitServer"
11851   BPUT#ps_c%,"%%EndSetup"
11852   ps_j%=prnt%! 52 
11853   WHILE ps_j%
11854    IF ps_j%! 12  AND 1<<31 THEN
11855     SYS "MakePSFont_MakeFont",ps_c%,$ps_j%! 4 +CHR$0,buff%,256,0
11856     ps_j%! 12 =ps_j%! 12  AND NOT(1<<31)
11857    ENDIF
11858    ps_j%=ps_j%! 0 
11859   ENDWHILE
11860   BPUT#ps_c%,"%%EOF"
11861   CLOSE#ps_c%
11862   RESTORE ERROR
11863   SYS"OS_File",18,"<Wimp$ScrapDir>.Printers."+STR$ ps_i%,&FF5
11864   REM re-select the default printer so that the font settings are true
11865   !buff%=20: buff%!12=0: buff%!16=&80152: SYS"Wimp_SendMessage",17,buff%,0
11866   B%= -1 
11867   C%=xbuff%: $C%=FNmsg_0(psup%! 16 ,"PR")
11868   D%=C%+LEN $C%+1: $D%="<Wimp$ScrapDir>.Printers."+STR$ ps_i%
11869   E%=D%+LEN $D%+1: $E%=FNmsg_0(psup%! 16 ,"DF")
11870   F%=prnt%
11871   G%=&FF5
11872   CALL code_entry%+ 24 
11873   PROCps_find_fonts_to_do(prnt%! 0 )
11874   SYS"Hourglass_Off"
11875   VDU: PROCftracef("PROCps_download_fonts done")
11876 ENDPROC
11877 DEF PROCps_lose_fonts
11878   LOCAL ps_i%,ps_old_i%
11879   VDU: PROCftracef("PROCps_lose_fonts")
11880   ps_i%=prnt%! 52 
11881   WHILE ps_i%
11882    IF ps_i%! 12  AND 1<<30 THEN
11883     REM make the link
11884     IF ps_old_i% THEN
11885      ps_old_i%! 0 =ps_i%! 0 
11886     ELSE
11887      prnt%! 52 =ps_i%! 0 
11888     ENDIF
11889     B%= &47525453 : C%=ps_i%! 4 : CALL code_entry%+ 16 
11890     B%= &47525453 : C%=ps_i%! 8 : CALL code_entry%+ 16 
11891     B%= &544E4F46 : C%=ps_i%: ps_i%=ps_i%! 0 : CALL code_entry%+ 16 
11892    ELSE
11893     ps_old_i%=ps_i%
11894     ps_i%=ps_i%! 0 
11895    ENDIF
11896   ENDWHILE
11897 ENDPROC
11898 DEF PROCps_add_fonts(only_mapped%)
11899   LOCAL ps_i%,ps_j%,ps_old_driver%
11900   VDU: PROCftracef("PROCps_add_fonts")
11901   SYS"PDriver_SelectDriver",0 TO ps_old_driver%
11902   SYS"PDriver_MiscOp",1: REM clear all fonts
11903   ps_i%=prnt%! 52 
11904   WHILE ps_i%
11905    ps_j%=ps_i%! 12  AND NOT(3<<30): REM lose our private bits
11906    IF ps_i%! 8 =0 THEN
11907     IF only_mapped%= 0  THEN
11908      REM a downloaded font - need to call MakePSFont in case derived fonts are needed
11909      REM note that -1 means no output generated
11910      SYS "MakePSFont_MakeFont",-1,$ps_i%! 4 +CHR$ 0,buff%,256,0
11911     ENDIF
11912    ELSE
11913     REM a remap - just declare it
11914     SYS"PDriver_MiscOp",0,$ps_i%! 4 ,$ps_i%! 8 ,ps_j%
11915    ENDIF
11916    ps_i%=ps_i%! 0 
11917   ENDWHILE
11918   SYS"PDriver_SelectDriver",ps_old_driver%
11919   VDU: PROCftracef("PROCps_add_fonts done")
11920 ENDPROC
11921 DEF PROCps_save_configuration(window%)
11922   LOCAL ps_i%,ps_j%,ps_k%,ps_s$,B%,C%,ps_t$
11923   VDU: PROCftracef("PROCps_save_configuration_window")
11924   prdt%=FNprinter_find_prdata_entry(psup%,FNicon_read(window%,6))
11925   PROCfree_structure(prnt%! 40 )
11926   $buff%=FNicon_read(window%,13)
11927   B%=buff%
11928   C%=2
11929   prnt%! 40 =USR(code_entry%+ 28 )
11930   IF cnfg%! 8  <> 0 THEN
11931     PROCfree_structure(cnfg%! 8 ):cnfg%! 8 =0
11932     ps_i%=0
11933     ps_t$=FNprinter_read_string_entry(prdt%, 14 )
11934     REM if the default setting has been chosen, do not save anything away
11935     IFps_t$<>FNmsg_0(psup%! 16 ,"ME1b") THEN
11936       REM otherwise match up on the feed name
11937       REPEAT
11938         SYS"OS_GBPB",9,ps_t$,buff%,1,ps_i%,256,"*" TO ,,,ps_j%
11939         IFps_j%=1 THEN
11940           CALL Z%,buff%,ps_s$
11941           $buff%=ps_t$+"."+ps_s$
11942           IFFNps_get_feed_name($buff%)=FNicon_read(window%,3) THEN
11943             B%=buff%
11944             C%=2
11945             cnfg%! 8 =USR(code_entry%+ 28 )
11946             ps_i%=-1
11947           ELSE
11948             ps_i%+=1
11949           ENDIF
11950         ENDIF
11951       UNTIL ps_j%<>1 OR ps_i%<0
11952     ENDIF
11953   ENDIF
11954   ps_j%=0
11955   IF FNicon_set(window%,8)                                                                       ps_j%+=1
11956   IF FNicon_set(window%,11)                                                                      ps_j%+=2
11957   IF FNicon_read(window%,18)=FNmsg_0(psup%! 16 ,"PO1")                                 ps_j%+=4
11958   IF cnfg%! 8  = 0 AND FNicon_read(window%,3)=FNmsg_0(psup%! 16 ,"PF1") ps_j%+=8
11959   IF FNicon_set(window%,7)                                                                       ps_j%+=16
11960   IF FNicon_set(window%,31)                                                                      ps_j%+=32
11961   IF FNicon_set(window%,32)                                                                      ps_j%+=64
11962   ps_i%=VAL FNicon_read(window%,30)
11963   IF ps_i%>200 ps_i%=100
11964   IF ps_i%<20  ps_i%=100
11965   ps_j%+=ps_i%<<8
11966   ps_j%+=VAL FNicon_read(window%,16)-1<<16
11967   CASE FNicon_read(window%,23)OF
11968     WHEN FNmsg_0(psup%! 16 ,"CC1"): ps_j%+=1<<24
11969     WHEN FNmsg_0(psup%! 16 ,"CC2"): ps_j%+=1<<25
11970   ENDCASE
11971   !cnfg%! 0 =ps_j%
11972   ps_j%=prnt%! 36 : ps_s$=FNicon_read(window%,27)
11973   IF $ps_j%! 4 <>ps_s$ THEN
11974    ps_i%=psize_head%
11975    WHILE ps_i%
11976     IF $ps_i%! 4 =ps_s$ THEN
11977      prnt%! 36 =ps_i%
11978      ps_i%=0
11979     ELSE
11980      ps_i%=ps_i%! 0 
11981     ENDIF
11982    ENDWHILE
11983   ENDIF
11984   IF prnt%! 20 <>-1 THEN
11985     REM this printer is ACTIVE!
11986     REM ensure that its details are correct
11987     PROCselect_printer(prnt%, -1 , 0 )
11988     REM The front end code will spot that the selected printer has
11989     REM changed and put everything back the way it was
11990     REM PROCselect_printer(0, -1 , -1 ): REM don't do this (calls into overlay). JRC 12 Feb '92
11991   ENDIF
11992 ENDPROC
11993 DEF PROCps_menu(top$,rebuild%,iconpos%)
11994   LOCAL wind%,ps_i%,ps_ix%,ps_iy%,ind_title%,list_index%,menu_index%,s$,t$
11995   VDU: PROCftracef("PROCps_menu")
11996   IF rebuild% THEN
11997    ps_menu_xpos%=xbuff%!0-64
11998    ps_menu_ypos%=xbuff%!4
11999   ENDIF
12000   IF iconpos% THEN
12001    !buff%=xbuff%!12: buff%!4=xbuff%!16: SYS"Wimp_GetIconState",,buff%
12002    ps_ix%=buff%!16: ps_iy%=buff%!20
12003    SYS"Wimp_GetWindowState",,buff%
12004    ps_menu_xpos%=buff%!20+buff%!4+ps_ix%+2
12005    ps_menu_ypos%=buff%!24+buff%!16+ps_iy%-2
12006   ENDIF
12007   wind%=FNprinter_find_window(prnt%,"configure")
12008   ps_menu_chsn$=top$
12009   CASE top$ OF
12010   WHEN "ME1": IF FNprinter_read_string_entry(prdt%, 14 )="" THEN
12011                 PROCmenu_create(ps_menu%,FNmsg_0(psup%! 16 ,"ME1a"))
12012               ELSE
12013                 PROCmenu_create(ps_menu%,FNmsg_0(psup%! 16 ,"ME1")+","+FNmsg_0(psup%! 16 ,"ME1b")+"#")
12014                 ind_title%=(ps_menu%!28 AND &100)<>0
12015                 list_index%=0
12016                 menu_index%=1:REM add items after default entry
12017                 t$=FNprinter_read_string_entry(prdt%, 14 )
12018                 SYS"Hourglass_On"
12019                 REPEAT
12020                   SYS"OS_GBPB",9,t$,buff%,1,list_index%,256,"*" TO ,,,ps_i%
12021                   IFps_i%=1 THEN
12022                     CALL Z%,buff%,s$
12023                     s$=FNps_get_feed_name(t$+"."+s$)
12024                     IFs$<>"" PROCmenu_item(ps_menu%,menu_index%,s$,ind_title%):menu_index%+=1
12025                     list_index%+=1
12026                   ENDIF
12027                 UNTIL ps_i%<>1
12028                 SYS"Hourglass_Off"
12029               ENDIF
12030               PROCmenu_tick_match(ps_menu%,FNicon_read(wind%,3))
12031   WHEN "ME2": PROCmenu_create(ps_menu%,FNmsg_0(psup%! 16 ,"ME2"))
12032               PROCmenu_tick_match(ps_menu%,FNicon_read(wind%,16))
12033   WHEN "ME3": PROCmenu_create(ps_menu%,FNmsg_0(psup%! 16 ,"ME3"))
12034               PROCmenu_tick_match(ps_menu%,FNicon_read(wind%,18))
12035   WHEN "ME4": PROCmenu_create(ps_menu%,FNmsg_0(psup%! 16 ,"ME4"))
12036               PROCmenu_tick_match(ps_menu%,FNicon_read(wind%,23))
12037   WHEN "MP1": PROCcreate_paper_menu(ps_menu%,wind%,27)
12038   ENDCASE
12039   PROCdisplay_menu(prnt%,ps_menu%,ps_menu_xpos%,ps_menu_ypos%)
12040 ENDPROC
12041   REM Text printing code
12042 DEF PROCps_m8
12043   LOCAL ps_r%,queu%,tpub%,tprv%
12044   VDU: PROCftracef("PROCps_m8")
12045   ps_r%=!xbuff%
12046   queu%=xbuff%!4
12047   tpub%=queu%! 44 
12048   tprv%=queu%! 48 
12049   CASE ps_r% OF
12050   WHEN -1: PROCps_1
12051   WHEN -2: PROCps_2
12052   WHEN -3: PROCps_3
12053   WHEN -4: PROCps_4
12054   WHEN -6: PROCps_6
12055   WHEN -7: PROCps_7
12056   WHEN -8: PROCps_8
12057   WHEN -9: PROCps_9
12058   WHEN-10: PROCps_10
12059   WHEN-11: PROCps_11
12060   WHEN-12: PROCps_12
12061   WHEN-13: PROCps_13
12062   WHEN-14: PROCps_14
12063   WHEN-15: PROCps_15
12064   WHEN-16: PROCps_16
12065   WHEN-17: PROCps_17
12066   WHEN-18: PROCps_18
12067   WHEN-19: PROCps_19
12068   WHEN-20: PROCps_20
12069   ENDCASE
12070 ENDPROC
12071 DEF PROCps_1
12072   LOCAL local_pl%,local_pr%,local_pb%,local_pt%,local_margin%
12073   LOCAL local_psze%,local_format_print%,local_pw%
12074   LOCAL last_char%
12075   LOCAL ps_i%,ps_s$,ps_h,ps_w,B%,C%
12076   VDU: PROCftracef("PROCps_1")
12077   B%= &56525054 : C%= 56 
12078   tprv%=USR(code_entry%+ 12 )
12079   IFtprv%=0 ERROR  253 , FNmsg_0(FNps_host_desc,"FA5")
12080   queu%! 48 =tprv%
12081   FORps_i%= 0  TO  52  STEP 4: tprv%!ps_i%=0: NEXT
12082   REM
12083   local_format_print%=(!cnfg%! 0  AND 4)>>2
12084   tprv%! 8 =1+((!cnfg%! 0  AND &FF0000)>>16)
12085   tpub%! 48 =(!cnfg%! 0  AND 2)>>1
12086   tpub%! 52 =!cnfg%! 0  AND 1
12087   IF queu%! 36 =&FFF THEN
12088    tpub%! 44 =(!cnfg%! 0  AND &FF000000)>>24
12089   ELSE
12090    tpub%! 44 =(!cnfg%! 0  AND &FF000000)>>24: REM was 1 JRC
12091   ENDIF
12092   local_margin%=50
12093   local_psze%=prnt%! 36 
12094   local_pl%=local_psze%! 24  DIV 100 + 1 + local_margin%
12095   local_pr%=local_psze%! 28  DIV 100 - local_margin%
12096   local_pb%=local_psze%! 16  DIV 100 + 1 + local_margin%
12097   local_pt%=local_psze%! 20  DIV 100 - local_margin%
12098   ps_s$=STR$(local_pl% DIV 10)+" "+STR$(local_pb% DIV 10)
12099   ps_s$+=" "+STR$((local_pr%+9)DIV 10)+" "+STR$((local_pt%+9)DIV 10)
12100   $buff%=ps_s$: B%=buff%: C%=2: tprv%! 0 =USR(code_entry%+ 28 )
12101   IF local_format_print%=0 THEN
12102    REM portrait
12103    IF tpub%! 52  local_pt%-=150
12104    local_pw%=local_pr%-local_pl%
12105    tprv%! 28 =local_pt%-local_pb%
12106    $buff%=STR$ local_pl%+" "+STR$ local_pt%+" 0"
12107   ELSE
12108    REM landscape
12109    IF tpub%! 52  local_pl%+=150
12110    local_pw%=local_pt%-local_pb%
12111    tprv%! 28 =local_pr%-local_pl%
12112    $buff%=STR$ local_pb%+" "+STR$ -local_pl%+" 90"
12113   ENDIF
12114   B%=buff%: C%=2: tprv%! 32 =USR(code_entry%+ 28 )
12115   tprv%! 16 =(!cnfg%! 0  AND &FF00)>>8
12116   VDU: PROCftracef("Local font size is "+STR$ tprv%! 16 )
12117   ps_w=0.72*tprv%! 16   
12118   ps_h=1.2*tprv%! 16 : REM allow 10% leading
12119   VDU: PROCftracef("=> (w, h) = ("+STR$ ps_w+", "+STR$ ps_h+")")
12120   local_pw%=local_pw% DIV ps_w: REM size of page in characters
12121   tprv%! 28 =tprv%! 28  DIV ps_h
12122   tprv%! 12 =(local_pw%+2)DIV tprv%! 8 -2: REM width of column in characters
12123   IF tprv%! 12 <10+local_psze%! 40 +local_psze%! 44  THEN
12124     ERROR  254 ,FNmsg_0(psup%! 16 ,"ErrNarr")
12125   ENDIF
12126   tprv%! 24 =local_psze%! 36 
12127   tpub%! 76 =tprv%! 28 -local_psze%! 32 
12128   tprv%! 44 =local_psze%! 40 
12129   tprv%! 52 =local_psze%! 44 
12130   tpub%! 100 =tprv%! 12 -tprv%! 52 
12131   tprv%! 40 =tprv%! 44 
12132   IF tpub%! 48  tprv%! 40 +=6
12133   REM build a character translation table
12134   PROCps_add_char(last_char%,40,"\(")
12135   PROCps_add_char(last_char%,41,"\)")
12136   PROCps_add_char(last_char%,92,"\\")
12137   FORps_i%=128 TO 255
12138    PROCps_add_char(last_char%,ps_i%,FNps_oct(ps_i%))
12139   NEXT
12140 ENDPROC
12141 DEF PROCps_add_char(RETURN last%,char%,trans$)
12142   LOCAL ps_p%,B%,C%
12143   VDU: PROCftracef("PROCps_add_char")
12144   B%= &52414843 : C%=7+LEN trans$
12145   ps_p%=USR(code_entry%+ 12 )
12146   IFps_p%=0 ERROR  253 , FNmsg_0(FNps_host_desc,"FA5")
12147   !ps_p%=0
12148   ps_p%?4=char%
12149   ps_p%?5=LEN trans$
12150   $(ps_p%+6)=trans$
12151   IF last% THEN
12152    !last%=ps_p%
12153   ELSE
12154    queu%! 64 =ps_p%
12155   ENDIF
12156   last%=ps_p%
12157 ENDPROC
12158 DEF PROCps_2
12159   REM Produce any required job initialisation output
12160   LOCAL ps_c%
12161   VDU: PROCftracef("PROCps_2")
12162   ps_c%=xbuff%!8
12163   PROCps_header(ps_c%)
12164   PROCps_prolog(ps_c%)
12165   PROCps_encoding(ps_c%)
12166   PROCps_setupline(ps_c%)
12167 ENDPROC
12168 DEF PROCps_header(ps_c%)
12169   LOCAL ps_old_job%,ps_old_driver%,ps_s$,ps_i%
12170   VDU: PROCftracef("PROCps_header")
12171   REM need to ensure that PDriverPS is the selected driver
12172   SYS"PDriver_SelectDriver",0 TO ps_old_driver%
12173   REM get PDriverPS to output the job header and start a job
12174   SYS"PDriver_SelectJob",ps_c%,FNprinter_read_string(tpub%! 112 )TO ps_old_job%
12175   REM now restore the old job
12176   SYS"PDriver_SelectJob",ps_old_job%
12177   REM and the old driver
12178   SYS"PDriver_SelectDriver",ps_old_driver%
12179   IF cnfg%! 8  <> 0 THEN
12180     ps_i%=OPENIN(FNprinter_read_string(cnfg%! 8 ))
12181     IFps_i%<>0 THEN WHILE NOT EOF#ps_i%:BPUT#ps_c%,BGET#ps_i%:ENDWHILE:CLOSE#ps_i%
12182   ENDIF
12183   BPUT#ps_c%,"/PDdict 50 dict def"
12184   BPUT#ps_c%,"PDdict begin"
12185 ENDPROC
12186 DEF PROCps_encoding(ps_c%)
12187   LOCAL ps_f%,ps_h%,ps_old_driver%,ps_b$,ps_bo$,ps_m$,ps_mo$
12188   LOCAL ps_acc%
12189   LOCAL ERROR
12190   VDU: PROCftracef("PROCps_encoding")
12191   REM SYS"XOS_Find",&40,"Printers:ps.PSfiles.PSencoding" TO ps_h%;ps_f%
12192   REM IF ps_f% AND 1 ps_h%=0
12193   REM IF ps_h%=0 ERROR  254 ,FNmsg_0(psup%! 16 ,"ErrEnc"): REM Error opening PSencoding file
12194   REM PROCps_outputfile(ps_h%,ps_c%)
12195   SYS"PDriver_SelectDriver",0 TO ps_old_driver%
12196   SYS"PDriver_SelectJob",ps_c% TO ps_h%
12197   ON ERROR LOCAL RESTORE ERROR: SYS"PDriver_SelectJob",ps_h%: ERROR ERR,REPORT$
12198   VDU: ON ERROR LOCAL RESTORE ERROR: SYS"PDriver_SelectJob",ps_h%: ERROR ERR,REPORT$+" ("+STR$ ERL+")"
12199   REM if accented chars button checked, then use RF/RFE proc for remapping.  Otherwise send
12200   REM inline code, which does not do PostScript runtime accent generation.
12201   REM R4=16+4+1 means use RF and RFE procs to do the remap (supplied in prolog), that this is a
12202   REM non-permanent print job, and to make the extra declarations for DocumentFonts and DocumentSuppliedFonts
12203   IF !cnfg%! 0  AND 64 ps_acc%=16+4+1 ELSE ps_acc%=4+1
12204   SYS "MakePSFont_MakeFont",ps_c%,"\FCorpus.Bold"+CHR$ 0,buff%,256,ps_acc%: ps_f%=buff%
12205   WHILE ?ps_f%: ps_b$+=CHR$ ?ps_f%: ps_f%+=1: ENDWHILE
12206   SYS "MakePSFont_MakeFont",ps_c%,"\FCorpus.Bold.Oblique"+CHR$ 0,buff%,256,ps_acc%: ps_f%=buff%
12207   WHILE ?ps_f%: ps_bo$+=CHR$ ?ps_f%: ps_f%+=1: ENDWHILE
12208   SYS "MakePSFont_MakeFont",ps_c%,"\FCorpus.Medium"+CHR$0,buff%,256,ps_acc%: ps_f%=buff%
12209   WHILE ?ps_f%: ps_m$+=CHR$ ?ps_f%: ps_f%+=1: ENDWHILE
12210   SYS "MakePSFont_MakeFont",ps_c%,"\FCorpus.Medium.Oblique"+CHR$ 0,buff%,256,ps_acc%: ps_f%=buff%
12211   WHILE ?ps_f%: ps_mo$+=CHR$ ?ps_f%: ps_f%+=1: ENDWHILE
12212   REM now add these names to the DocumentFont list (within the job)
12213   SYS"XPDriver_MiscOp",0,ps_m$,"X",40,0
12214   SYS"XPDriver_MiscOp",0,ps_b$,"X",40,0
12215   SYS"XPDriver_MiscOp",0,ps_mo$,"X",40,0
12216   SYS"XPDriver_MiscOp",0,ps_bo$,"X",40,0
12217   SYS"PDriver_SelectJob",ps_h%
12218   SYS"PDriver_SelectDriver",ps_old_driver%
12219   BPUT#ps_c%,"/TF /"+ps_b$+" def"
12220   BPUT#ps_c%,"/NF /"+ps_m$+" def"
12221   BPUT#ps_c%,"/BF /"+ps_b$+" def"
12222   BPUT#ps_c%,"/IF /"+ps_mo$+" def"
12223   BPUT#ps_c%,"/BIF /"+ps_bo$+" def"
12224   BPUT#ps_c%,10
12225 ENDPROC
12226 DEF PROCps_prolog(ps_c%)
12227   LOCAL ps_f%,ps_h%
12228   VDU: PROCftracef("PROCps_prologue")
12229   SYS"XOS_Find",&4F,"Printers:ps.PSfiles.PStprolog" TO ps_h%;ps_f%
12230   IF ps_f% AND 1 ps_h%=0
12231   IF ps_h%=0 ERROR  254 ,$(ps_h%+4)
12232   PROCps_outputfile(ps_h%,ps_c%)
12233 ENDPROC
12234 DEF PROCps_outputfile(ps_h%,ps_c%)
12235   VDU: PROCftracef("PROCps_output")
12236   WHILE NOT EOF#ps_h%
12237     BPUT#ps_c%,GET$#ps_h%
12238   ENDWHILE
12239   SYS"XOS_Find",0,ps_h%
12240 ENDPROC
12241 DEF PROCps_setupline(ps_c%)
12242   LOCAL ps_s$, ps_i%, local_psze%, ps_extra$
12243   VDU: PROCftracef("PROCps_setupline")
12244   BPUT#ps_c%,"%%EndProlog"
12245   BPUT#ps_c%,"%%BeginSetup"
12246   local_psze%=prnt%! 36 
12247   ps_s$=$local_psze%! 4 
12248   ps_i%=0
12249   WHILE MID$(ps_s$,ps_i%,1)<>" " AND ps_i%<=LEN ps_s$
12250     ps_i%+=1
12251   ENDWHILE
12252   ps_s$=LEFT$(ps_s$,ps_i%-1)
12253   SYS"OS_File",17,"Printers:ps.Paper."+FNtask_lower(ps_s$) TO ps_i%
12254   IF ps_i%=1 THEN
12255     ps_i%=OPENIN("Printers:ps.Paper."+FNtask_lower(ps_s$))
12256     IFps_i%<>0 THEN WHILE NOT EOF#ps_i%:BPUT#ps_c%,BGET#ps_i%:ENDWHILE:CLOSE#ps_i%
12257   ELSE
12258     ps_extra$=FNmsg_2(psup%! 16 ,"PT",ps_s$,FNtask_lower(ps_s$))
12259   ENDIF
12260   BPUT#ps_c%, STR$(FNps_fontsize(tpub%! 64 ))+" FI"
12261   IF FNprinter_read_string_entry(prdt%, 14 )="" AND cnfg%! 8  = 0 THEN
12262     IF !cnfg%! 0  AND 8 THEN
12263       ps_s$=FNungstrans(FNprinter_read_boolean_string_entry(prdt%, 9 , -1 ))
12264     ELSE
12265       ps_s$=FNungstrans(FNprinter_read_boolean_string_entry(prdt%, 9 , 0 ))
12266     ENDIF
12267     IF ps_extra$<>"" ps_extra$=ps_s$+"|J"+ps_extra$ ELSE ps_extra$=ps_s$
12268   ENDIF
12269   IF ps_extra$<>"" THEN
12270     BPUT#ps_c%,ps_extra$
12271   ENDIF
12272   BPUT#ps_c%,"%%EndSetup"
12273 ENDPROC
12274 DEF PROCps_3
12275   REM Produce page header
12276   LOCAL ps_s$,old_pos%,local_psze%,local_style_bits%,ps_c%,ps_t$,ps_w,ps_h,@%
12277   VDU: PROCftracef("PROCps_3")
12278   local_style_bits%=tpub%! 96 
12279   tpub%! 96 =64: REM title bit
12280   ps_c%=xbuff%!8
12281   ps_s$="%%Page: "
12282   IF tprv%! 8 >1 ps_s$+=STR$(tprv%! 8 *tpub%! 84 +1)+"-"
12283   tpub%! 84 +=1
12284   ps_s$+=STR$(tprv%! 8 *tpub%! 84 )+" "+STR$tpub%! 84 
12285   BPUT#ps_c%,ps_s$
12286   BPUT#ps_c%,"%%PageBoundingBox: "+FNprinter_read_string(tprv%! 0 )
12287   BPUT#ps_c%,FNprinter_read_string(tprv%! 32 );
12288   BPUT#ps_c%," "+STR$(1.2*tprv%! 16 );
12289   VDU: PROCftracef("Local font size is "+STR$(1.2*tprv%! 16 ))
12290   ps_w=0.72*tprv%! 16 : REM courier character width is 60% of size
12291   ps_h=1.2*tprv%! 16 
12292   VDU: PROCftracef("=> (w, h) = ("+STR$ ps_w+", "+STR$ ps_h+")")
12293   @%="+g10.9"
12294   BPUT#ps_c%," "+STR$ ps_w+" "+STR$ ps_h+" StartPage"
12295   IF tpub%! 52  THEN
12296     local_psze%=prnt%! 36 
12297     old_pos%=tpub%! 56 
12298     ps_s$=STR$(local_psze%! 36 -0.5)+" "+STR$ tprv%! 44 +" MT "+STR$ 64+" ("
12299     ps_t$=FNprinter_read_string(tpub%! 112 )+"   "+FNprinter_read_string(tpub%! 120 )
12300     ps_t$+="   "+FNmsg_1(psup%! 16 ,"PAG",STR$ tpub%! 84 )
12301     ps_s$+=FNps_trans(ps_t$)+") SS"
12302     BPUT#ps_c%,ps_s$
12303     tpub%! 56 =old_pos%
12304   ENDIF
12305   tpub%! 96 =local_style_bits%
12306   tprv%! 4 =0
12307 ENDPROC
12308 DEF PROCps_4
12309   REM post line processing
12310   LOCAL ps_i%,ps_b$
12311   VDU: PROCftracef("PROCps_4")
12312   REM if we've output something and we aren't formatting, end the string
12313   IF xbuff%!8<>0 AND tpub%! 8 =0 ps_b$=") SS"
12314   REM if we've reached the end or we're ending the page ...
12315   IF EOF#queu%! 12  OR(tpub%! 24 >1)THEN
12316     REM move on to the next column
12317     tprv%! 4 +=1
12318     REM if we've reached the end or we've run out of columns ...
12319     IF EOF#queu%! 12  OR tprv%! 4 >=tprv%! 8  THEN
12320       REM set the stage to deal with the footer
12321       tpub%! 92 =3
12322     ENDIF
12323   ENDIF
12324   xbuff%?8=LEN ps_b$
12325   $(xbuff%+9)=ps_b$
12326 ENDPROC
12327 DEF PROCps_6
12328   REMM Do control code processing
12329   LOCAL ps_s$
12330   VDU: PROCftracef("PROCps_6")
12331   ps_s$=FNps_display(xbuff%!8)
12332   xbuff%?8=LEN ps_s$
12333   $(xbuff%+9)=ps_s$
12334 ENDPROC
12335 DEF PROCps_7
12336   REM handle a backspace
12337   REM simple! just move back to where the last character is!
12338   LOCAL ps_b$
12339   VDU: PROCftracef("PROCps_7")
12340   PROCps_8: REM stores its value in xbuff%+9
12341   ps_b$=") SS "+$(xbuff%+9)
12342   xbuff%?8=LEN ps_b$
12343   $(xbuff%+9)=ps_b$
12344 ENDPROC
12345 DEF PROCps_8
12346   REM handle line splitting
12347   LOCAL ps_b$,ps_i
12348   VDU: PROCftracef("PROCps_8")
12349   ps_i=tprv%! 40 
12350   ps_i+=tprv%! 4 *(tprv%! 12 +1)
12351   ps_i+=(tpub%! 56 -tprv%! 40 )*(FNps_fontsize(0)/FNps_fontsize(tpub%! 64 ))
12352   ps_b$=STR$ tpub%! 80 +" "+STR$ ps_i+" MT "+STR$(tpub%! 96  AND &7F)+" ("
12353   xbuff%?8=LEN ps_b$
12354   $(xbuff%+9)=ps_b$
12355 ENDPROC
12356 DEF PROCps_9
12357   REM handle style changes
12358   LOCAL ps_b$
12359   VDU: PROCftracef("PROCps_9")
12360   ps_b$=") SS "+STR$(xbuff%!8 AND &7F)+" ("
12361   xbuff%?8=LEN ps_b$
12362   $(xbuff%+9)=ps_b$
12363 ENDPROC
12364 DEF PROCps_10
12365   REM start a new line
12366   LOCAL ps_b$,line_num$,wrap%,ps_i
12367   VDU: PROCftracef("PROCps_10")
12368   tpub%! 80 +=1
12369   tpub%! 72 +=1
12370   ps_i=tprv%! 44 +tprv%! 4 *(tprv%! 12 +1)
12371   ps_b$=STR$ tpub%! 80 +" "+STR$ ps_i+" MT "
12372   wrap%=(tpub%! 56 >=tpub%! 100 )
12373   IF tpub%! 48  THEN
12374     IF tpub%! 64  ps_b$+=STR$ FNps_fontsize(0)+" FS "
12375     ps_b$+="0 ("
12376     REM print line number, unless wrapped line
12377     IF wrap% THEN
12378       tpub%! 72 -=1
12379       ps_b$+=STRING$(6," ")
12380     ELSE
12381       line_num$=STR$ tpub%! 72 
12382       ps_b$+=STRING$(5-LEN line_num$," ")+line_num$+" "
12383     ENDIF
12384     tpub%! 56 =6
12385     ps_b$+=") SS "
12386     IF tpub%! 64  ps_b$+=STR$(FNps_fontsize(tpub%! 64 ))+" FS "
12387   ELSE
12388     tpub%! 56 =0
12389   ENDIF
12390   IF tprv%! 48 >0 ps_b$+="0 ("+STRING$(tprv%! 48 ," ")+") SS "
12391   IF wrap% THEN
12392     tpub%! 56 +=1
12393     ps_b$+="1 (|) SS ": REM print wrap bar in bold
12394   ENDIF
12395   ps_b$+=STR$(tpub%! 96  AND &7F)+" ("
12396   tpub%! 56 +=tprv%! 44 +tprv%! 48 
12397   xbuff%?8=LEN ps_b$
12398   $(xbuff%+9)=ps_b$
12399 ENDPROC
12400 DEF PROCps_11
12401   REM print footnote number
12402   LOCAL ps_b$,ps_i%
12403   VDU: PROCftracef("PROCps_11")
12404   PROCps_10: REM stores its value in xbuff%+9
12405   ps_b$=$(xbuff%+9)+") SS "
12406   PROCps_10: ps_b$+=$(xbuff%+9)+") SS "+STR$((tpub%! 96  OR 1<<4)AND &7F)+" ("
12407   REM                                                        turn on superscript ^
12408   ps_b$+=FNps_trans(RIGHT$("  "+STR$ tpub%! 60 ,3))
12409   tpub%! 56 -=3
12410   ps_b$+=") SS "
12411   PROCps_8: REM stores its value in xbuff%+9
12412   ps_b$+=$(xbuff%+9)+CHR$92                    
12413   xbuff%?8=LEN ps_b$
12414   $(xbuff%+9)=ps_b$
12415 ENDPROC
12416 DEF PROCps_12
12417   REM string translation
12418   LOCAL ps_b$
12419   VDU: PROCftracef("PROCps_12")
12420   ps_b$=FNps_trans($(xbuff%+8))
12421   xbuff%?8=LEN ps_b$
12422   $(xbuff%+9)=ps_b$
12423 ENDPROC
12424 DEF PROCps_13
12425   REM handle font change
12426   LOCAL font_new%,ps_b$,ps_i%
12427   VDU: PROCftracef("PROCps_13")
12428   font_new%=xbuff%!8
12429   ps_i%=tprv%! 40 
12430   ps_i%+=INT((tprv%! 12 -tprv%! 40 -tprv%! 52 )*FNps_fontsize(font_new%)/FNps_fontsize(0))
12431   tpub%! 100 =ps_i%
12432   tpub%! 64 =font_new%
12433   IF tpub%! 68 <tpub%! 100 -tprv%! 40  THEN
12434    tprv%! 48 =tpub%! 68 
12435   ELSE
12436    tprv%! 48 =0
12437   ENDIF
12438   IF tpub%! 88 <tpub%! 100 -tprv%! 40  AND tpub%! 88 >tprv%! 48  THEN
12439    tpub%! 100 =tprv%! 40 +tpub%! 88 
12440   ENDIF
12441   ps_b$=STR$ FNps_fontsize(font_new%)+" FS"
12442   xbuff%?8=LEN ps_b$
12443   $(xbuff%+9)=ps_b$
12444 ENDPROC
12445 DEF PROCps_14
12446   REM finish page
12447   VDU: PROCftracef("PROCps_14")
12448   BPUT#xbuff%!8,"EndPage"
12449 ENDPROC
12450 DEF PROCps_15
12451   REM finish job
12452   LOCAL ps_c%,cnct%,ps_ptr%,ps_ext%,ps_data%,ps_p%,B%,C%
12453   VDU: PROCftracef("PROCps_15")
12454   ps_c%=xbuff%!8
12455   IF queu%! 36 <>&FF5 THEN
12456    REM get the list of fonts ...
12457    REM (needs to be done before we end the job)
12458    SYS"PDriver_SelectJob",ps_c% TO ps_ext%
12459    SYS"PDriver_MiscOp",2,0,0,0,0 TO ,,C%
12460    IF C%<>0 THEN
12461     B%= &58585858 : ps_data%=USR(code_entry%+ 12 )
12462     IFps_data%=0 ERROR  253 , FNmsg_0(FNps_host_desc,"FA5")
12463     SYS"PDriver_MiscOp",2,ps_data%,C%,0,0
12464    ENDIF
12465    SYS"PDriver_SelectJob",ps_ext%
12466    ps_ptr%=PTR#ps_c%: ps_ext%=EXT#ps_c%
12467    SYS"PDriver_EndJob",ps_c%
12468    EXT#ps_c%=ps_ext%: PTR#ps_c%=ps_ptr%
12469    BPUT#ps_c%,"%%Trailer"
12470    BPUT#ps_c%,"end"
12471    BPUT#ps_c%,"%%Pages: "+STR$ tpub%! 84 
12472    BPUT#ps_c%,"%%BoundingBox: "+FNprinter_read_string(tprv%! 0 )
12473    IF C%<>0 THEN
12474     ps_ptr%=PTR#ps_c%: ps_ext%=EXT#ps_c%: BPUT#ps_c%,"%%DocumentFonts: ";
12475     ps_p%=ps_data%
12476     REPEAT
12477      IF ps_p%!8=40 OR ps_p%!8=41 THEN
12478       B%=!ps_p%
12479       WHILE ?B%: BPUT#ps_c%,?B%: B%+=1: ENDWHILE: BPUT#ps_c%,10
12480       ps_ptr%=PTR#ps_c%: ps_ext%=EXT#ps_c%: BPUT#ps_c%,"%%+ ";
12481      ENDIF
12482      ps_p%+=12
12483     UNTIL(ps_p%-ps_data%)>=C%
12484     EXT#ps_c%=ps_ext%: PTR#ps_c%=ps_ptr%
12485     ps_ptr%=PTR#ps_c%: ps_ext%=EXT#ps_c%: BPUT#ps_c%,"%%DocumentSuppliedFonts: ";
12486     ps_p%=ps_data%
12487     REPEAT
12488       IF ps_p%!8=41 THEN
12489         B%=!ps_p%
12490         WHILE ?B%: BPUT#ps_c%,?B%: B%+=1: ENDWHILE: BPUT#ps_c%,10
12491         ps_ptr%=PTR#ps_c%: ps_ext%=EXT#ps_c%: BPUT#ps_c%,"%%+ ";
12492       ENDIF
12493       ps_p%+=12
12494     UNTIL ps_p%-ps_data%>=C%
12495     EXT#ps_c%=ps_ext%: PTR#ps_c%=ps_ptr%
12496     B%= &58585858 : C%=ps_data%: CALL code_entry%+ 16 
12497    ENDIF
12498   ENDIF
12499   cnct%=prnt%! 12 
12500   IF cnct%! 0 =1 OR cnct%! 0 =2 BPUT#ps_c%,4
12501 ENDPROC
12502 DEF PROCps_16
12503   REM process a tab character
12504   LOCAL ps_b$
12505   VDU: PROCftracef("PROCps_16")
12506   ps_b$=STRING$(8-((tpub%! 56 -tprv%! 44 -tprv%! 48 +1-6*tpub%! 48 )MOD8)," ")
12507   tpub%! 56 +=LEN ps_b$
12508   xbuff%?8=LEN ps_b$
12509   $(xbuff%+9)=ps_b$
12510 ENDPROC
12511 DEF PROCps_17
12512   REM no formfeed text ...
12513   VDU: PROCftracef("PROCps_17")
12514   xbuff%?8=0
12515 ENDPROC
12516 DEF PROCps_18
12517   REM change layout
12518   LOCAL layout_height%,layout_top%,layout_bottom%
12519   VDU: PROCftracef("PROCps_18")
12520   layout_height%=xbuff%!8
12521   layout_top%=xbuff%!12
12522   layout_bottom%=xbuff%!16
12523   IF layout_height%-layout_top%-layout_bottom%>3 AND layout_height%<=tprv%! 28  THEN
12524    tpub%! 76 =layout_height%-layout_bottom%
12525    tprv%! 24 =layout_top%
12526   ENDIF
12527   xbuff%?8=0
12528 ENDPROC
12529 DEF PROCps_19
12530   REM start new page
12531   VDU: PROCftracef("PROCps_19")
12532   tpub%! 80 =tprv%! 24 
12533   xbuff%?8=0
12534 ENDPROC
12535 DEF PROCps_20
12536   REM prepend any code for a native (ie PostScript) file
12537   LOCAL ps_c%, ps_d%, ps_i%, ps_p%, ps_q%
12538   VDU: PROCftracef("PROCps_20")
12539   ps_c%=xbuff%!8
12540   ps_d%=xbuff%!12
12541   IF cnfg%! 8  <>0 THEN
12542     ps_i%=OPENIN(FNprinter_read_string(cnfg%! 8 ))
12543     IFps_i%<>0 THEN
12544       REM copy %!PS-Adobe line
12545       PROCps_copy_line(ps_d%, ps_c%)
12546       REM now copy all of the %% lines
12547       REPEAT
12548         ps_p%=BGET#ps_d%:ps_q%=BGET#ps_d%:PTR#ps_d%=PTR#ps_d%-2
12549         IFps_p%=ASC"%" AND ps_q%=ASC"%" PROCps_copy_line(ps_d%, ps_c%)
12550       UNTIL ps_p%<>ASC"%" OR ps_q%<>ASC"%"
12551       REM now copy the feed code
12552       WHILE NOT EOF#ps_i%:BPUT#ps_c%,BGET#ps_i%:ENDWHILE
12553       CLOSE#ps_i%
12554     ENDIF
12555   ENDIF
12556 ENDPROC
12557 DEF PROCps_copy_line(from%, to%)
12558   LOCAL ps_c%
12559   REPEAT
12560     ps_c%=BGET#from%
12561     BPUT#to%, ps_c%
12562   UNTIL ps_c%=10 OR ps_c%=13
12563   REPEAT
12564     ps_c%=BGET#from%
12565     IFps_c%=10 OR ps_c%=13 BPUT#to%,ps_c% ELSE PTR#from%=PTR#from%-1
12566   UNTIL ps_c%<>10 AND ps_c%<>13
12567 ENDPROC
12568 DEF FNps_fontsize(num%)
12569   REM provide notional cpi sizes
12570   VDU: PROCftracef("FNps_fontsize")
12571   CASE num% OF
12572   WHEN 0: =10: REM pica
12573   WHEN 1: =12: REM elite
12574   WHEN 2: =17: REM condensed
12575   WHEN 3: = 6: REM expanded
12576   ENDCASE
12577 =0
12578 DEF FNps_trans(ps_s$)
12579   LOCAL ps_i%,byte%,out$,str$
12580   VDU: PROCftracef("FNps_trans")
12581   IF ps_s$="" THEN =""
12582   FOR ps_i%=1 TO LEN ps_s$
12583     byte%=ASC MID$(ps_s$,ps_i%,1)
12584     str$=""
12585     CASE  -1  OF
12586       WHEN byte%<32 OR byte%=127
12587         IF tpub%! 44 =1 THEN str$=FNps_display(byte%)
12588       WHEN byte%>127 AND tpub%! 44 <>0
12589         IF tpub%! 44 =1 THEN str$=FNps_display(byte%)
12590       WHEN tpub%! 44 <>0
12591         str$=CHR$ byte%
12592         tpub%! 56 +=1
12593       OTHERWISE
12594         tpub%! 56 +=1
12595         IF byte%>127 THEN
12596           str$=FNps_oct(byte%)
12597         ELSE
12598           CASE byte% OF
12599             WHEN ASC"(": str$="\("
12600             WHEN ASC")": str$="\)"
12601             WHEN     92: str$="\\"                 
12602             OTHERWISE: str$=CHR$ byte%
12603           ENDCASE
12604         ENDIF
12605     ENDCASE
12606     out$+=str$
12607   NEXT
12608 =out$
12609 DEF FNps_display(byte%)
12610   LOCAL buf$
12611   VDU: PROCftracef("FNps_display")
12612   tpub%! 56 +=4
12613   buf$=") SS "+STR$((tpub%! 96  AND &7F)OR 1)+" ("
12614   REM                                          bold_bit ^
12615   buf$+="["+RIGHT$("0"+STR$~byte%,2)+"]"
12616   buf$+=") SS "+STR$(tpub%! 96  AND &7F)+" ("
12617 =buf$
12618 DEF FNps_oct(byte%)
12619   VDU: PROCftracef("FNps_oct")
12620 =CHR$92+CHR$((byte%>>6 AND 7)+48)+CHR$((byte%>>3 AND 7)+48)+CHR$((byte% AND 7)+48)  
12621 DEF PROCps_ensure_dir
12622   LOCAL f%
12623   SYS "XOS_File", 8, "PrinterChoices:ps" TO ; f%
12624   SYS "XOS_File", 8, "PrinterChoices:ps.Printers" TO ; f%
12625 ENDPROC
12626 DEF FNps_host_desc
12627 LOCAL a%
12628 a%=buff%!24
12629 =a%! 12 
